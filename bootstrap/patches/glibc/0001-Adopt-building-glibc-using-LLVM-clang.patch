From 0bcc3a20ff630d7cb628919c132e145e3af81ea0 Mon Sep 17 00:00:00 2001
From: Taylor Berlioz <nagakamira@gmail.com>
Date: Thu, 30 Jun 2022 14:03:20 -0700
Subject: [PATCH 1/2] Adopt building glibc using LLVM/clang

Huge cherry pick from azanella/clang branch, many rejections have been fixed
Many warnings have been fixed as well

Following commits have been backported from glibc-2.36:
f39ff483f320878b2a2950353d05747eae623216
a4ea49f85ea421979e8b269e286e450daac57454
657472b2a50f67b12e5bbe5827582c9c2bb82dc3
c7f05bd5342517f3f751e6ea8dec1916b80bee8a
33f4d09bdc3d7730ae2fb3e9b67819d32a6b9ae6
41397b9337da4f9c4bba4b6786c9edf961469ace
0374b487a71ad07005a816191dca829a7e6cdcae
2a16484a750361974ffb7a4faa22bec7afda2f46
06e91f1a2ebfb2d8a4ffa7285079c77ece20b6aa

Signed-off-by: Taylor Berlioz <nagakamira@gmail.com>
---
 Makeconfig                                    |   23 +-
 Makefile                                      |    2 +
 Makerules                                     |   10 +-
 Rules                                         |    2 +
 aclocal.m4                                    |    6 -
 argp/Makefile                                 |    9 +-
 argp/argp-fmtstream.c                         |    1 +
 argp/argp-help.c                              |    3 +-
 argp/argp-parse.c                             |    6 +-
 argp/argp.h                                   |   24 +-
 argp/bits/argp-ldbl.h                         |   24 -
 benchtests/Makefile                           |    6 +-
 benchtests/bench-malloc-thread.c              |    6 +
 benchtests/bench-memset-large.c               |    1 +
 benchtests/bench-memset-walk.c                |    1 +
 benchtests/bench-memset.c                     |    1 +
 benchtests/bench-pthread-locks.c              |   14 +-
 benchtests/bench-strchr.c                     |    2 +
 benchtests/ilogbf128-inputs                   |    4 +-
 catgets/config.h                              |   14 -
 catgets/gencat.c                              |    9 +-
 config.make.in                                |    2 +-
 configure                                     |  426 +++-
 configure.ac                                  |  184 +-
 conform/conformtest.py                        |   31 +-
 conform/data/stdint.h-data                    |    4 +-
 csu/libc-tls.c                                |    8 +-
 ctype/ctype.c                                 |   10 +-
 debug/backtracesyms.c                         |   18 +-
 debug/confstr_chk.c                           |    2 +-
 debug/tst-backtrace.h                         |    2 +-
 debug/tst-ssp-1.c                             |    2 +-
 dirent/Makefile                               |    1 +
 elf/Makefile                                  |   60 +-
 elf/dl-debug.c                                |    2 +-
 elf/dl-load.c                                 |    2 +-
 elf/dl-lookup.c                               |    4 +-
 elf/dl-printf.c                               |    2 +-
 elf/dl-profile.c                              |   10 +-
 elf/dl-support.c                              |    1 +
 .../monetary-ldbl.h => elf/dl-symbol-hacks.h  |   18 +-
 elf/dl-tls.c                                  |    2 +
 elf/dl-tunables.c                             |    2 +-
 elf/rtld.c                                    |   27 +-
 elf/sprof.c                                   |   12 +-
 elf/tst-audit25.h                             |   66 +
 elf/tst-audit25a.c                            |   46 +-
 elf/tst-audit25b.c                            |   48 +-
 elf/tst-dlmodcount.c                          |    2 +-
 elf/tst-p_alignmod-base.c                     |    2 +-
 elf/tst-ptrguard1.c                           |    2 +
 elf/tst-stackguard1.c                         |    2 +
 elf/tst-tls-dlinfo.c                          |    2 +-
 elf/tst-unique3.cc                            |   11 +-
 elf/tst-unique4.cc                            |    6 +
 elf/tst-unique4lib.cc                         |    2 +-
 elf/unload4.c                                 |    6 +-
 gmon/tst-gmon.c                               |    8 +-
 gmon/tst-sprofil.c                            |    2 +-
 grp/putgrent.c                                |    8 +-
 gshadow/putsgent.c                            |   10 +-
 hurd/hurdsig.c                                |    2 +-
 iconv/gconv_conf.c                            |    2 +-
 iconv/gconv_parseconfdir.h                    |    2 +-
 iconv/iconv_charmap.c                         |    2 +-
 iconvdata/gbk.c                               |    5 +
 iconvdata/ibm1008.h                           |   20 +-
 iconvdata/ibm1025.h                           |   10 +-
 iconvdata/ibm1097.h                           |   32 +-
 iconvdata/ibm1112.h                           |   22 +-
 iconvdata/ibm1122.h                           |   10 +-
 iconvdata/ibm1123.h                           |   12 +-
 iconvdata/ibm1130.h                           |   20 +-
 iconvdata/ibm1137.h                           |   10 +-
 iconvdata/ibm1140.h                           |    8 +-
 iconvdata/ibm1141.h                           |    8 +-
 iconvdata/ibm1142.h                           |    8 +-
 iconvdata/ibm1143.h                           |    8 +-
 iconvdata/ibm1144.h                           |    8 +-
 iconvdata/ibm1145.h                           |   10 +-
 iconvdata/ibm1146.h                           |   10 +-
 iconvdata/ibm1147.h                           |   10 +-
 iconvdata/ibm1148.h                           |   10 +-
 iconvdata/ibm1149.h                           |   10 +-
 iconvdata/ibm1153.h                           |   26 +-
 iconvdata/ibm1154.h                           |   14 +-
 iconvdata/ibm1155.h                           |   14 +-
 iconvdata/ibm1156.h                           |   26 +-
 iconvdata/ibm1157.h                           |   14 +-
 iconvdata/ibm1158.h                           |   16 +-
 iconvdata/ibm1166.h                           |   28 +-
 iconvdata/ibm1167.h                           |   46 +-
 iconvdata/ibm12712.h                          |   24 +-
 iconvdata/ibm16804.h                          |   24 +-
 iconvdata/ibm4517.h                           |   28 +-
 iconvdata/ibm4899.h                           |   18 +-
 iconvdata/ibm4909.h                           |   14 +-
 iconvdata/ibm4971.h                           |   14 +-
 iconvdata/ibm5347.h                           |   26 +-
 iconvdata/ibm803.h                            |   12 +-
 iconvdata/ibm901.h                            |   68 +-
 iconvdata/ibm902.h                            |   60 +-
 iconvdata/ibm9030.h                           |    8 +-
 iconvdata/ibm9066.h                           |   10 +-
 iconvdata/ibm921.h                            |   24 +-
 iconvdata/ibm9448.h                           |   64 +-
 iconvdata/iso-2022-cn-ext.c                   |   16 +-
 iconvdata/iso-2022-cn.c                       |    5 +
 include/alloc_buffer.h                        |   33 +-
 include/allocate_once.h                       |   17 +-
 include/bits/argp-ldbl.h                      |    1 -
 include/bits/err-ldbl.h                       |    1 -
 include/bits/error-ldbl.h                     |    1 -
 include/bits/monetary-ldbl.h                  |    1 -
 include/bits/printf-ldbl.h                    |    1 -
 include/bits/stdio-ldbl.h                     |    1 -
 include/bits/stdlib-ldbl.h                    |    1 -
 include/bits/syslog-ldbl.h                    |    1 -
 include/bits/wchar-ldbl.h                     |    1 -
 include/ctype.h                               |   15 +-
 include/err.h                                 |   28 +-
 include/features.h                            |    2 +-
 include/gmp.h                                 |   12 -
 include/libc-diag.h                           |   21 +
 include/libc-symbols.h                        |   33 +-
 include/math.h                                |    4 +-
 include/stdio.h                               |   74 +-
 include/stdlib.h                              |   34 +-
 include/string.h                              |   12 +-
 include/sys/cdefs.h                           |   20 -
 include/sys/socket.h                          |    6 +-
 include/sys/syslog.h                          |   18 +-
 include/sys/sysmacros.h                       |   16 +-
 include/unistd.h                              |    1 -
 include/wchar.h                               |   24 +-
 inet/Makefile                                 |    3 +
 inet/ether_ntoa_r.c                           |    8 +-
 inet/net-internal.h                           |    2 +-
 inet/rexec.c                                  |    4 +-
 inet/ruserpass.c                              |   24 +-
 intl/Makefile                                 |    3 +-
 intl/l10nflist.c                              |    2 +-
 intl/plural-exp.c                             |    2 +-
 io/Makefile                                   |    9 +-
 libio/Makefile                                |   20 +-
 libio/__fpurge.c                              |    2 +-
 libio/bits/stdio-ldbl.h                       |  108 -
 libio/bits/stdio2.h                           |  115 +-
 libio/feof_u.c                                |    5 +-
 libio/ferror_u.c                              |    3 +-
 libio/fileops.c                               |    4 +-
 libio/fputc_u.c                               |    1 -
 libio/genops.c                                |   17 +-
 libio/getc_u.c                                |    7 +-
 libio/iogetdelim.c                            |    9 +-
 libio/iogetline.c                             |    2 +-
 libio/ioseekoff.c                             |    2 +-
 libio/ioseekpos.c                             |    2 +-
 libio/libio.h                                 |   45 +-
 libio/oldfileops.c                            |    2 +-
 libio/putc.c                                  |    1 -
 libio/putc_u.c                                |    5 +-
 libio/stdio.h                                 |  286 ++-
 libio/tst-bz24051.c                           |    6 +-
 libio/tst-bz24153.c                           |    6 +-
 libio/tst-ext.c                               |    8 +-
 libio/tst-sprintf-ub.c                        |   14 +
 libio/tst-widetext.c                          |   10 +-
 libio/tst_swprintf.c                          |   10 +-
 libio/tst_swscanf.c                           |    4 +-
 libio/wfileops.c                              |    4 +-
 libio/wgenops.c                               |   11 +-
 locale/programs/ld-collate.c                  |   10 +-
 locale/programs/ld-ctype.c                    |   31 +-
 localedata/bug-iconv-trans.c                  |    6 +-
 localedata/tests-mbwc/dat_mbrtowc.c           |   12 +-
 localedata/tests-mbwc/dat_mbsrtowcs.c         |   12 +-
 localedata/tests-mbwc/dat_strcoll.c           |   13 +-
 localedata/tests-mbwc/dat_swscanf.c           |    2 +-
 localedata/tests-mbwc/dat_wcrtomb.c           |    4 +-
 localedata/tests-mbwc/dat_wcsrtombs.c         |   10 +-
 localedata/tests-mbwc/dat_wcstombs.c          |   10 +-
 localedata/tests-mbwc/dat_wctomb.c            |    4 +-
 localedata/tst-iconv-math-trans.c             |    4 +-
 localedata/tst-trans.c                        |    8 +-
 localedata/tst-xlocale1.c                     |    4 +-
 localedata/tst-xlocale2.c                     |    2 +-
 login/Makefile                                |    1 +
 malloc/Makefile                               |   11 +
 malloc/malloc-check.c                         |    3 +-
 malloc/malloc.c                               |   35 +-
 malloc/memusage.c                             |  132 +-
 malloc/tst-dynarray.c                         |    4 +-
 malloc/tst-malloc-thread-exit.c               |    2 +-
 malloc/tst-malloc-thread-fail.c               |    2 +-
 malloc/tst-malloc.c                           |    1 +
 malloc/tst-mallocstate.c                      |    2 +-
 malloc/tst-memalign.c                         |    7 +-
 malloc/tst-tcfree3.c                          |    6 +-
 math/Makefile                                 |   41 +-
 math/bug-tgmath1.c                            |    5 +
 math/complex.h                                |    2 +-
 math/gen-tgmath-tests.py                      |   38 +-
 math/libm-test-fpclassify.inc                 |    2 +
 math/libm-test-isfinite.inc                   |    2 +
 math/libm-test-isinf.inc                      |    2 +
 math/libm-test-isnan.inc                      |    2 +
 math/libm-test-isnormal.inc                   |    2 +
 math/libm-test-issubnormal.inc                |    2 +
 math/libm-test-iszero.inc                     |    2 +
 math/math-underflow.h                         |    9 +-
 math/math.h                                   |   17 +-
 math/test-snan.c                              |   10 +-
 math/test-tgmath-ret.c                        |    7 +
 misc/Makefile                                 |    7 +-
 misc/bits/err-ldbl.h                          |   30 -
 misc/bits/error-ldbl.h                        |   24 -
 misc/bits/syslog-ldbl.h                       |   35 -
 misc/bits/syslog.h                            |   15 +-
 misc/efgcvt-template.c                        |    2 +-
 misc/err.c                                    |   36 +-
 misc/err.h                                    |   31 +-
 misc/error.h                                  |   18 +-
 misc/makedev.c                                |    6 +-
 misc/mntent_r.c                               |    2 +-
 misc/sys/cdefs.h                              |  137 +-
 misc/sys/syslog.h                             |   15 +-
 misc/syslog.c                                 |    5 +-
 misc/tst-atomic.c                             |    6 +
 misc/tst-syscalls.c                           |   14 +-
 nis/nis_print.c                               |   59 +-
 nis/nis_subr.c                                |    8 +-
 nis/nis_table.c                               |    2 +-
 nptl/Makefile                                 |    6 +-
 nptl/pthread_create.c                         |    3 +-
 nptl/pthread_getattr_np.c                     |    2 +-
 nptl/pthread_getcpuclockid.c                  |    2 +-
 nptl/pthread_getname.c                        |    2 +-
 nptl/pthread_join_common.c                    |    2 +-
 nptl/pthread_setname.c                        |    2 +-
 nptl/tst-minstack-throw.cc                    |    8 +-
 nptl/tst-rwlock6.c                            |   12 +-
 nptl/tst-rwlock7.c                            |   16 +-
 nptl/tst-stackguard1.c                        |    2 +
 nptl/tst-thread-exit-clobber.cc               |   12 +-
 nptl/tst-thread-setspecific.c                 |    2 +
 nptl/tst-thread_local1.cc                     |   12 +-
 nscd/mem.c                                    |    6 +-
 nss/nss_files/files-parse.c                   |    4 +
 nss/nss_module.c                              |    7 +
 posix/Makefile                                |    6 +-
 posix/bug-regex24.c                           |    7 +
 posix/confstr.c                               |    1 -
 posix/runptests.c                             |    2 +-
 posix/wordexp-test.c                          |    4 +-
 posix/wordexp.c                               |    4 +-
 pwd/getpw.c                                   |    6 +-
 pwd/putpwent.c                                |    4 +-
 resolv/Makefile                               |    1 +
 resolv/inet_addr.c                            |    2 +-
 resolv/inet_ntop.c                            |    4 +-
 resolv/nss_dns/dns-host.c                     |    4 +-
 resolv/nss_dns/dns-network.c                  |   12 +-
 resolv/res_init.c                             |    6 +-
 resolv/res_send.c                             |   10 +-
 resource/Makefile                             |    2 +
 rt/tst-aio.c                                  |    2 +-
 rt/tst-aio64.c                                |    2 +-
 scripts/check-installed-headers.sh            |   12 +-
 shadow/putspent.c                             |   30 +-
 socket/Makefile                               |    8 +-
 stdio-common/Makefile                         |    2 +-
 stdio-common/bits/printf-ldbl.h               |   23 -
 stdio-common/bug1.c                           |    4 +-
 stdio-common/bug23-3.c                        |    5 +
 stdio-common/bug5.c                           |    2 +-
 stdio-common/dprintf.c                        |    1 -
 stdio-common/fprintf.c                        |    2 +-
 stdio-common/getline.c                        |    2 +-
 stdio-common/printf.h                         |   13 +-
 stdio-common/psiginfo.c                       |   32 +-
 stdio-common/scanf13.c                        |   15 +
 stdio-common/sprintf.c                        |    2 +-
 stdio-common/test_rdwr.c                      |   10 +-
 stdio-common/tst-fphex.c                      |    4 +-
 stdio-common/tst-printf-bz18872.sh            |    8 +-
 stdio-common/tst-sprintf-errno.c              |    2 +-
 stdio-common/tst-unlockedio.c                 |    4 +
 stdio-common/tst-vfprintf-user-type.c         |    2 +-
 stdio-common/tstgetln.c                       |    2 +-
 stdio-common/vfprintf-internal.c              |    2 +-
 stdio-common/vfprintf.c                       |    2 +-
 stdio-common/vfscanf-internal.c               |    2 +-
 stdlib/Makefile                               |   12 +-
 stdlib/atof.c                                 |    2 +-
 stdlib/atoi.c                                 |    3 +-
 stdlib/atol.c                                 |    2 +-
 stdlib/atoll.c                                |    2 +-
 stdlib/bits/stdlib-ldbl.h                     |   63 -
 stdlib/bsearch.c                              |    6 +-
 stdlib/bug-getcontext.c                       |    2 +-
 stdlib/fmtmsg.c                               |   24 +-
 stdlib/fpioconst.h                            |    9 +-
 stdlib/gmp.h                                  |   72 +-
 stdlib/longlong.h                             |  186 +-
 stdlib/monetary.h                             |   25 +-
 stdlib/setenv.c                               |    7 -
 stdlib/stdlib.h                               |   73 +-
 stdlib/strtod.c                               |    7 +-
 stdlib/strtol.c                               |    2 +-
 stdlib/strtold.c                              |   18 +-
 stdlib/tst-makecontext-align.c                |   20 +-
 stdlib/tst-quick_exit.cc                      |    2 +-
 stdlib/tst-setcontext5.c                      |    4 +-
 stdlib/tst-setcontext8.c                      |    2 +-
 stdlib/tst-setcontext9.c                      |    2 +-
 stdlib/tst-strtod5i.c                         |    1 +
 stdlib/tst-swapcontext1.c                     |    8 +-
 stdlib/tst-thread-quick_exit.cc               |    2 +-
 string/Makefile                               |    9 +
 string/memset.c                               |    1 +
 string/tester.c                               |   30 +-
 string/tst-xbzero-opt.c                       |    3 +-
 sunrpc/clnt_udp.c                             |    2 +-
 sunrpc/key_call.c                             |    2 +-
 sunrpc/netname.c                              |    4 +-
 sunrpc/svc_unix.c                             |    7 +
 support/Makefile                              |    4 +-
 support/support_format_dns_packet.c           |   11 -
 support/support_process_state.c               |    7 +-
 support/tst-timespec.c                        |    7 +
 sysdeps/aarch64/Makefile                      |    1 +
 sysdeps/aarch64/fpu/fpu_control.h             |   36 +-
 sysdeps/aarch64/fpu/fraiseexcpt.c             |    2 +-
 sysdeps/aarch64/nptl/tls.h                    |    2 +-
 sysdeps/aarch64/sfp-machine.h                 |    2 +-
 sysdeps/aarch64/tlsdesc.sym                   |    2 +-
 sysdeps/aarch64/tst-vpcs-mod.S                |    2 +-
 sysdeps/alpha/memset.S                        |    1 +
 sysdeps/alpha/nptl/tls.h                      |    2 +-
 sysdeps/arc/dl-tls.h                          |    2 +-
 sysdeps/arc/nptl/tls.h                        |    3 +-
 sysdeps/arm/memset.S                          |    1 +
 sysdeps/csky/abiv2/memset.S                   |    1 +
 sysdeps/csky/nptl/tls.h                       |    3 +-
 sysdeps/generic/dl-dtv.h                      |    2 +-
 sysdeps/generic/ldsodefs.h                    |   13 +-
 sysdeps/generic/math-type-macros.h            |    2 +-
 sysdeps/generic/symbol-hacks.h                |    7 +
 sysdeps/generic/tst-stack-align.h             |    2 +-
 sysdeps/hppa/nptl/tls.h                       |    2 +-
 sysdeps/i386/fpu/e_atanh.S                    |    3 +-
 sysdeps/i386/fpu/e_atanhf.S                   |    3 +-
 sysdeps/i386/fpu/e_atanhl.S                   |    3 +-
 sysdeps/i386/fpu/s_asinhl.S                   |    3 +-
 sysdeps/i386/fpu/s_cbrtl.S                    |   44 +-
 sysdeps/i386/fpu/s_expm1.S                    |    3 +-
 sysdeps/i386/fpu/s_expm1f.S                   |    3 +-
 sysdeps/i386/fpu/s_log1pl.S                   |    3 +-
 sysdeps/i386/nptl/tls.h                       |    4 +-
 sysdeps/ia64/memset.S                         |    1 +
 sysdeps/ia64/nptl/tls.h                       |    2 +-
 sysdeps/ieee754/dbl-64/e_lgamma_r.c           |    4 +-
 sysdeps/ieee754/dbl-64/k_rem_pio2.c           |    2 +-
 sysdeps/ieee754/float128/float128_private.h   |    4 +-
 sysdeps/ieee754/float128/s_isnanf128.c        |    4 +
 sysdeps/ieee754/flt-32/e_lgammaf_r.c          |    2 +-
 sysdeps/ieee754/ldbl-128/k_tanl.c             |    2 +-
 .../ldbl-128ibm-compat/ieee128-asprintf.c     |    7 +-
 .../ldbl-128ibm-compat/ieee128-dprintf.c      |    7 +-
 .../ieee754/ldbl-128ibm-compat/ieee128-err.c  |   47 +-
 .../ldbl-128ibm-compat/ieee128-fprintf.c      |    7 +-
 .../ldbl-128ibm-compat/ieee128-qefgcvt.c      |    4 +-
 .../ldbl-128ibm-compat/ieee128-qefgcvt_r.c    |    4 +-
 .../ldbl-128ibm-compat/ieee128-snprintf.c     |    6 +-
 .../ldbl-128ibm-compat/ieee128-sprintf.c      |    7 +-
 .../ldbl-128ibm-compat/ieee128-syslog.c       |    5 +-
 .../ldbl-128ibm-compat/ieee128-vfprintf.c     |    7 +-
 sysdeps/ieee754/ldbl-128ibm/k_tanl.c          |    2 +-
 sysdeps/ieee754/ldbl-96/e_lgammal_r.c         |    2 +-
 sysdeps/ieee754/ldbl-96/k_tanl.c              |    2 +-
 .../ldbl-96/test-totalorderl-ldbl-96.c        |    4 +-
 sysdeps/ieee754/soft-fp/s_ddivl.c             |    2 +-
 sysdeps/ieee754/soft-fp/s_dfmal.c             |    2 +-
 sysdeps/ieee754/soft-fp/s_dsqrtl.c            |    2 +-
 sysdeps/ieee754/soft-fp/s_fdiv.c              |    2 +-
 sysdeps/ieee754/soft-fp/s_fdivl.c             |    1 -
 sysdeps/ieee754/soft-fp/s_ffma.c              |    2 +-
 sysdeps/ieee754/soft-fp/s_ffmal.c             |    4 +-
 sysdeps/ieee754/soft-fp/s_fma.c               |    4 +-
 sysdeps/ieee754/soft-fp/s_fmaf.c              |    4 +-
 sysdeps/ieee754/soft-fp/s_fmal.c              |    4 +-
 sysdeps/m68k/nptl/tls.h                       |    2 +-
 sysdeps/mach/hurd/i386/tls.h                  |   10 +-
 sysdeps/microblaze/nptl/tls.h                 |    2 +-
 sysdeps/mips/memset.S                         |    1 +
 sysdeps/mips/nptl/tls.h                       |    3 +-
 sysdeps/nios2/nptl/tls.h                      |    2 +-
 sysdeps/nptl/dl-tls_init_tp.c                 |    4 +-
 sysdeps/nptl/gai_misc.h                       |    2 +-
 sysdeps/nptl/lowlevellock.h                   |    4 +-
 sysdeps/or1k/nptl/tls.h                       |    2 +-
 sysdeps/posix/Makefile                        |    2 +
 sysdeps/posix/fpathconf.c                     |    2 +-
 sysdeps/posix/getaddrinfo.c                   | 2172 +++++++++--------
 sysdeps/posix/pathconf.c                      |    2 +-
 sysdeps/posix/sprofil.c                       |   12 -
 sysdeps/posix/sysconf.c                       |   10 +-
 sysdeps/posix/tempname.c                      |    2 +-
 sysdeps/powerpc/nofpu/Makefile                |   24 +-
 sysdeps/powerpc/nptl/tls.h                    |    2 +-
 sysdeps/powerpc/powerpc32/memset.S            |    1 +
 .../powerpc32/power4/fpu/multiarch/Makefile   |    4 +-
 sysdeps/powerpc/powerpc32/power4/memset.S     |    1 +
 .../powerpc32/power4/multiarch/memset-ppc32.S |    1 +
 sysdeps/powerpc/powerpc32/power6/memset.S     |    1 +
 sysdeps/powerpc/powerpc32/power7/memset.S     |    1 +
 .../powerpc64/be/fpu/multiarch/Makefile       |    4 +-
 .../powerpc64/le/fpu/multiarch/Makefile       |    4 +-
 .../powerpc64/multiarch/memset-ppc64.S        |    1 +
 sysdeps/powerpc/powerpc64/power4/memset.S     |    1 +
 sysdeps/powerpc/powerpc64/power6/memset.S     |    1 +
 sysdeps/powerpc/powerpc64/power7/memset.S     |    1 +
 sysdeps/powerpc/powerpc64/power8/memset.S     |    1 +
 sysdeps/riscv/dl-tls.h                        |    2 +-
 sysdeps/riscv/nptl/tls.h                      |    2 +-
 sysdeps/riscv/start.S                         |    1 +
 sysdeps/s390/nptl/tls.h                       |    2 +-
 sysdeps/sh/memset.S                           |    1 +
 sysdeps/sh/nptl/tls.h                         |    2 +-
 sysdeps/sparc/nptl/tls.h                      |    2 +-
 sysdeps/sparc/sparc32/memset.S                |    1 +
 .../sparc32/sparcv9/multiarch/memset-ultra1.S |    1 +
 sysdeps/sparc/sparc64/memset.S                |    1 +
 .../sparc/sparc64/multiarch/memset-ultra1.S   |    1 +
 .../unix/sysv/linux/aarch64/cpu-features.c    |    2 +-
 sysdeps/unix/sysv/linux/aarch64/sysconf.c     |    2 +-
 sysdeps/unix/sysv/linux/arc/mmap_internal.h   |    2 +-
 sysdeps/unix/sysv/linux/arm/tls.h             |    3 +-
 sysdeps/unix/sysv/linux/clock_getcpuclockid.c |    2 +-
 sysdeps/unix/sysv/linux/clock_nanosleep.c     |    2 +-
 sysdeps/unix/sysv/linux/cmsg_nxthdr.c         |    5 +-
 sysdeps/unix/sysv/linux/fstatat64.c           |   10 +-
 sysdeps/unix/sysv/linux/getlogin_r.c          |    2 +-
 sysdeps/unix/sysv/linux/getsysstats.c         |    4 +-
 sysdeps/unix/sysv/linux/ia64/makecontext.c    |    2 +-
 sysdeps/unix/sysv/linux/ia64/mmap_internal.h  |    2 +-
 .../unix/sysv/linux/kernel-posix-cpu-timers.h |   30 +-
 sysdeps/unix/sysv/linux/m68k/mmap_internal.h  |    2 +-
 sysdeps/unix/sysv/linux/mmap_internal.h       |    2 +-
 sysdeps/unix/sysv/linux/not-cancel.h          |   57 +-
 sysdeps/unix/sysv/linux/powerpc/configure     |   59 +-
 sysdeps/unix/sysv/linux/powerpc/configure.ac  |   42 +-
 sysdeps/unix/sysv/linux/readonly-area.c       |    6 +-
 sysdeps/unix/sysv/linux/riscv/Makefile        |    2 +
 .../sysv/linux/sparc/sparc32/localplt.data    |    3 +
 .../sysv/linux/sparc/sparc64/localplt.data    |    3 +
 sysdeps/unix/sysv/linux/sysconf.c             |    2 +-
 sysdeps/unix/sysv/linux/timer_create.c        |    4 +-
 sysdeps/unix/sysv/linux/tst-clone3-internal.c |    8 +-
 sysdeps/unix/sysv/linux/tst-clone3.c          |    8 +-
 sysdeps/unix/sysv/linux/tst-getdents64.c      |   16 +-
 sysdeps/wordsize-64/Makefile                  |    5 +
 sysdeps/wordsize-64/strtol.c                  |    3 +-
 sysdeps/x86/bits/floatn.h                     |   15 +-
 sysdeps/x86/configure                         |  231 +-
 sysdeps/x86/configure.ac                      |   22 +-
 sysdeps/x86/fpu/Makefile                      |    9 +-
 sysdeps/x86/fpu/sfp-machine.h                 |   15 +-
 sysdeps/x86/nptl/pthreaddef.h                 |    8 +-
 sysdeps/x86/sys/platform/x86.h                |    4 +-
 sysdeps/x86/tst-ldbl-nonnormal-printf.c       |    2 +-
 sysdeps/x86/tst-memchr-rtm.c                  |    4 +-
 sysdeps/x86/tst-memcmp-rtm.c                  |    4 +-
 sysdeps/x86/tst-memmove-rtm.c                 |    4 +-
 sysdeps/x86/tst-memrchr-rtm.c                 |    4 +-
 sysdeps/x86/tst-memset-rtm.c                  |    4 +-
 sysdeps/x86/tst-strchr-rtm.c                  |    4 +-
 sysdeps/x86/tst-strcpy-rtm.c                  |    4 +-
 sysdeps/x86/tst-strlen-rtm.c                  |    4 +-
 sysdeps/x86/tst-strncmp-rtm.c                 |    4 +-
 sysdeps/x86/tst-strrchr-rtm.c                 |    4 +-
 sysdeps/x86_64/configure                      |   22 +
 sysdeps/x86_64/configure.ac                   |    9 +
 sysdeps/x86_64/fpu/Makeconfig                 |    2 +
 sysdeps/x86_64/fpu/configure                  |   61 +
 sysdeps/x86_64/fpu/configure.ac               |   30 +
 sysdeps/x86_64/fpu/multiarch/Makefile         |   15 +-
 sysdeps/x86_64/fpu/s_log1pl.S                 |    3 +-
 sysdeps/x86_64/fpu/test-double-vlen4.h        |    2 +-
 sysdeps/x86_64/fpu/test-double-vlen8.h        |    2 +-
 sysdeps/x86_64/fpu/test-float-vlen16.h        |    2 +-
 sysdeps/x86_64/fpu/test-float-vlen8.h         |    2 +-
 .../multiarch/memmove-sse2-unaligned-erms.S   |    5 +
 .../multiarch/memset-sse2-unaligned-erms.S    |    1 +
 sysdeps/x86_64/multiarch/strstr.c             |    1 -
 sysdeps/x86_64/nptl/tls.h                     |    4 +-
 sysdeps/x86_64/tst-rsi-strlen.c               |    2 +-
 termios/Makefile                              |    1 +
 time/Makefile                                 |    1 +
 time/tst-strftime.c                           |    6 +-
 time/tzset.c                                  |    2 +-
 timezone/Makefile                             |    2 +-
 timezone/zdump.c                              |    2 +-
 wcsmbs/Makefile                               |   24 +-
 wcsmbs/bits/wchar-ldbl.h                      |   91 -
 wcsmbs/bits/wchar2.h                          |   64 +-
 wcsmbs/wchar.h                                |  229 +-
 wcsmbs/wcsmbs-tst1.c                          |    2 +-
 wctype/Makefile                               |    2 +
 510 files changed, 5045 insertions(+), 3946 deletions(-)
 delete mode 100644 argp/bits/argp-ldbl.h
 delete mode 100644 catgets/config.h
 rename stdlib/bits/monetary-ldbl.h => elf/dl-symbol-hacks.h (64%)
 create mode 100644 elf/tst-audit25.h
 delete mode 100644 include/bits/argp-ldbl.h
 delete mode 100644 include/bits/err-ldbl.h
 delete mode 100644 include/bits/error-ldbl.h
 delete mode 100644 include/bits/monetary-ldbl.h
 delete mode 100644 include/bits/printf-ldbl.h
 delete mode 100644 include/bits/stdio-ldbl.h
 delete mode 100644 include/bits/stdlib-ldbl.h
 delete mode 100644 include/bits/syslog-ldbl.h
 delete mode 100644 include/bits/wchar-ldbl.h
 delete mode 100644 libio/bits/stdio-ldbl.h
 delete mode 100644 misc/bits/err-ldbl.h
 delete mode 100644 misc/bits/error-ldbl.h
 delete mode 100644 misc/bits/syslog-ldbl.h
 delete mode 100644 stdio-common/bits/printf-ldbl.h
 delete mode 100644 stdlib/bits/stdlib-ldbl.h
 create mode 100644 sysdeps/x86_64/fpu/configure
 create mode 100644 sysdeps/x86_64/fpu/configure.ac
 delete mode 100644 wcsmbs/bits/wchar-ldbl.h

diff --git a/Makeconfig b/Makeconfig
index 47db08d6..3d8e9f53 100644
--- a/Makeconfig
+++ b/Makeconfig
@@ -669,22 +669,23 @@ else
 endif
 libgcc_eh := -Wl,--as-needed -lgcc_s $(libunwind) -Wl,--no-as-needed
 gnulib-arch =
-gnulib = -lgcc $(gnulib-arch)
-gnulib-tests := -lgcc $(libgcc_eh)
+gnulib = `$(CC) $(sysdep-LDFLAGS) --print-libgcc-file-name` $(gnulib-arch)
+gnulib-tests := `$(CC) $(sysdep-LDFLAGS) --print-libgcc-file-name` $(libgcc_eh)
 static-gnulib-arch =
 # By default, elf/static-stubs.o, instead of -lgcc_eh, is used to
 # statically link programs.  When --disable-shared is used, we use
 # -lgcc_eh since elf/static-stubs.o isn't sufficient.
 ifeq (yes,$(build-shared))
-static-gnulib = -lgcc $(static-gnulib-arch)
+static-gnulib = `$(CC) $(sysdep-LDFLAGS) --print-libgcc-file-name` $(static-gnulib-arch)
 else
-static-gnulib = -lgcc -lgcc_eh $(static-gnulib-arch)
+static-gnulib = `$(CC) $(sysdep-LDFLAGS) --print-libgcc-file-name` $(static-gnulib-arch)
 endif
-static-gnulib-tests := -lgcc -lgcc_eh $(libunwind)
-libc.so-gnulib := -lgcc
+static-gnulib-tests := `$(CC) $(sysdep-LDFLAGS) --print-libgcc-file-name` $(libunwind)
+libc.so-gnulib := `$(CC) $(sysdep-LDFLAGS) --print-libgcc-file-name`
 endif
 +preinit = $(addprefix $(csu-objpfx),crti.o)
 +postinit = $(addprefix $(csu-objpfx),crtn.o)
+ifeq (no,$(is-clang))
 +prector = `$(CC) $(sysdep-LDFLAGS) --print-file-name=crtbegin.o`
 +postctor = `$(CC) $(sysdep-LDFLAGS) --print-file-name=crtend.o`
 # Variants of the two previous definitions for linking PIE programs.
@@ -699,6 +700,14 @@ else
 +prectorT = `$(CC) $(sysdep-LDFLAGS) --print-file-name=crtbeginT.o`
 +postctorT = `$(CC) $(sysdep-LDFLAGS) --print-file-name=crtend.o`
 endif
+else
++prector = `$(CC) $(sysdep-LDFLAGS) --print-file-name=clang_rt.crtbegin-$(config-machine).o`
++postctor = `$(CC) $(sysdep-LDFLAGS) --print-file-name=clang_rt.crtend-$(config-machine).o`
++prectorS = `$(CC) $(sysdep-LDFLAGS) --print-file-name=clang_rt.crtbegin-$(config-machine).o`
++postctorS = `$(CC) $(sysdep-LDFLAGS) --print-file-name=clang_rt.crtend-$(config-machine).o`
++prectorT = `$(CC) $(sysdep-LDFLAGS) --print-file-name=clang_rt.crtbegin-$(config-machine).o`
++postctorT = `$(CC) $(sysdep-LDFLAGS) --print-file-name=clang_rt.crtend-$(config-machine).o`
+endif
 csu-objpfx = $(common-objpfx)csu/
 elf-objpfx = $(common-objpfx)elf/
 
@@ -861,7 +870,7 @@ endif
 # We have to assume that glibc functions are called in any rounding
 # mode and also change the rounding mode in a few functions. So,
 # disable any optimization that assume default rounding mode.
-+math-flags = -frounding-math
++math-flags = $(config-cflags-frounding-math)
 
 # Logically only "libnldbl", "nonlib" and "testsuite" should be using
 # -fno-math-errno. However due to GCC bug #88576, only "libm" can use
diff --git a/Makefile b/Makefile
index b1454882..d520abf9 100644
--- a/Makefile
+++ b/Makefile
@@ -543,6 +543,7 @@ $(objpfx)check-installed-headers-c.out: \
     scripts/check-installed-headers.sh $(headers)
 	$(SHELL) $(..)scripts/check-installed-headers.sh c \
 	  "$(CC) $(filter-out -std=%,$(CFLAGS)) -D_ISOMAC $(+includes)" \
+	  $(config-cflags-charset-ascii) \
 	  $(headers) > $@; \
 	$(evaluate-test)
 
@@ -553,6 +554,7 @@ $(objpfx)check-installed-headers-cxx.out: \
     scripts/check-installed-headers.sh $(headers)
 	$(SHELL) $(..)scripts/check-installed-headers.sh c++ \
 	  "$(CXX) $(filter-out -std=%,$(CXXFLAGS)) -D_ISOMAC $(+includes)" \
+	  $(config-cflags-charset-ascii) \
 	  $(headers) > $@; \
 	$(evaluate-test)
 endif # $(CXX)
diff --git a/Makerules b/Makerules
index 5de2cec6..e3260bc4 100644
--- a/Makerules
+++ b/Makerules
@@ -540,7 +540,8 @@ $(LINK.o) -shared -static-libgcc -Wl,-O1 $(sysdep-LDFLAGS) \
 	  $(extra-B-$(@F:lib%.so=%).so) $(load-map-file) \
 	  -Wl,-soname=lib$(libprefix)$(@F:lib%.so=%).so$($(@F)-version) \
 	  $(LDFLAGS.so) $(LDFLAGS-lib.so) $(LDFLAGS-$(@F:lib%.so=%).so) \
-	  -L$(subst :, -L,$(rpath-link)) -Wl,-rpath-link=$(rpath-link)
+	  -L$(subst :, -L,$(rpath-link)) -Wl,-rpath-link=$(rpath-link) \
+	  -Wno-unused-command-line-argument $(config-cflags-unwindlib)
 endef
 
 ifeq (yes,$(use-default-link))
@@ -598,7 +599,8 @@ $(LINK.o) -shared -static-libgcc $(sysdep-LDFLAGS) $(rtld-LDFLAGS) \
 	  -B$(csu-objpfx) $(load-map-file) \
 	  $(LDFLAGS.so) $(LDFLAGS-$(@F:%.so=%).so) \
 	  $(link-test-modules-rpath-link) \
-	  -L$(subst :, -L,$(rpath-link)) -Wl,-rpath-link=$(rpath-link)
+	  -L$(subst :, -L,$(rpath-link)) -Wl,-rpath-link=$(rpath-link) \
+	  -Wno-unused-command-line-argument $(config-cflags-unwindlib)
 endef
 
 # This macro is similar to build-shlib but it does not define a soname
@@ -645,7 +647,7 @@ LDFLAGS-c.so += -e __libc_main
 # between libc.so and ld.so, which can make it impossible to upgrade.
 $(common-objpfx)libc_pic.os: $(common-objpfx)libc_pic.a
 	$(LINK.o) -nostdlib -nostartfiles -r -o $@ \
-	$(LDFLAGS-c_pic.os) -Wl,-d $(whole-archive) $^ -o $@
+	$(LDFLAGS-c_pic.os) $(whole-archive) $^ -o $@
 
 ifeq (,$(strip $(shlib-lds-flags)))
 # Generate a list of -R options to excise .gnu.glibc-stub.* sections.
@@ -1171,8 +1173,6 @@ $(inst_includedir)/%.h: $(common-objpfx)%.h $(+force)
 	$(do-install)
 $(inst_includedir)/%.h: %.h $(+force)
 	$(do-install)
-$(inst_includedir)/%.h: $(..)include/%.h $(+force)
-	$(do-install)
 headers-nonh := $(filter-out %.h,$(headers))
 ifdef headers-nonh
 $(addprefix $(inst_includedir)/,$(headers-nonh)): $(inst_includedir)/%: \
diff --git a/Rules b/Rules
index ac9455d6..91cf297a 100644
--- a/Rules
+++ b/Rules
@@ -90,6 +90,7 @@ $(objpfx)check-installed-headers-c.out: \
     $(..)scripts/check-installed-headers.sh $(headers)
 	$(SHELL) $(..)scripts/check-installed-headers.sh c \
 	  "$(CC) $(filter-out -std=%,$(CFLAGS)) -D_ISOMAC $(+includes)" \
+	  $(config-cflags-charset-ascii) \
 	  $(headers) > $@; \
 	$(evaluate-test)
 
@@ -102,6 +103,7 @@ $(objpfx)check-installed-headers-cxx.out: \
     $(..)scripts/check-installed-headers.sh $(headers)
 	$(SHELL) $(..)scripts/check-installed-headers.sh c++ \
 	  "$(CXX) $(filter-out -std=%,$(CXXFLAGS)) -D_ISOMAC $(+includes)" \
+	  $(config-cflags-charset-ascii) \
 	  $(headers) > $@; \
 	$(evaluate-test)
 endif # $(CXX)
diff --git a/aclocal.m4 b/aclocal.m4
index 3e0bcdd1..a8df0364 100644
--- a/aclocal.m4
+++ b/aclocal.m4
@@ -118,7 +118,6 @@ case "$CC" in
     *fuse-ld=lld*) LDNAME=ld.lld;;
     *)             LDNAME=ld;;
 esac
-AS=`$CC -print-prog-name=as`
 LD=`$CC -print-prog-name=$LDNAME`
 AR=`$CC -print-prog-name=ar`
 AC_SUBST(AR)
@@ -130,11 +129,6 @@ GPROF=`$CC -print-prog-name=gprof`
 AC_SUBST(GPROF)
 
 # Determine whether we are using GNU binutils.
-AC_CACHE_CHECK(whether $AS is GNU as, libc_cv_prog_as_gnu,
-[LIBC_PROG_FOO_GNU($AS, libc_cv_prog_as_gnu=yes, libc_cv_prog_as_gnu=no)])
-rm -f a.out
-gnu_as=$libc_cv_prog_as_gnu
-
 AC_CACHE_CHECK(whether $LD is GNU ld, libc_cv_prog_ld_gnu,
 [LIBC_PROG_FOO_GNU($LD, libc_cv_prog_ld_gnu=yes, libc_cv_prog_ld_gnu=no)])
 gnu_ld=$libc_cv_prog_ld_gnu
diff --git a/argp/Makefile b/argp/Makefile
index 586136f2..fd99098c 100644
--- a/argp/Makefile
+++ b/argp/Makefile
@@ -22,16 +22,17 @@ subdir	:= argp
 
 include ../Makeconfig
 
-headers		= argp.h bits/argp-ldbl.h
+headers		= argp.h
 routines	= $(addprefix argp-, ba fmtstream fs-xinl help parse pv \
 				     pvh xinl eexst)
 
 tests		= argp-test tst-argp1 bug-argp1 tst-argp2 bug-argp2 \
 		  tst-ldbl-argp
 
-CFLAGS-argp-help.c += $(uses-callbacks) -fexceptions
-CFLAGS-argp-parse.c += $(uses-callbacks)
-CFLAGS-argp-fmtstream.c += -fexceptions
+CFLAGS-argp-help.c += $(uses-callbacks) -fexceptions $(config-cflags-wno-ignored-attributes)
+CFLAGS-argp-parse.c += $(uses-callbacks) $(config-cflags-wno-ignored-attributes)
+CFLAGS-argp-fmtstream.c += -fexceptions $(config-cflags-wno-ignored-attributes)
+CFLAGS-argp-fs-xinl.c += $(config-cflags-wno-ignored-attributes)
 
 bug-argp1-ARGS = -- --help
 bug-argp2-ARGS = -- -d 111 --dstaddr 222 -p 333 --peer 444
diff --git a/argp/argp-fmtstream.c b/argp/argp-fmtstream.c
index 2f74bde2..c220adfd 100644
--- a/argp/argp-fmtstream.c
+++ b/argp/argp-fmtstream.c
@@ -42,6 +42,7 @@
 #ifdef _LIBC
 # include <wchar.h>
 # include <libio/libioP.h>
+# define putc_unlocked(__c, __f) __putc_unlocked (__c, __f)
 #endif
 
 #define INIT_BUF_SIZE 200
diff --git a/argp/argp-help.c b/argp/argp-help.c
index 90a2795c..bfaffa21 100644
--- a/argp/argp-help.c
+++ b/argp/argp-help.c
@@ -51,6 +51,7 @@ char *alloca ();
 #ifdef _LIBC
 # include <../libio/libioP.h>
 # include <wchar.h>
+# define putc_unlocked(__c, __f) __putc_unlocked (__c, __f)
 #endif
 
 #ifndef _
@@ -210,7 +211,7 @@ fill_in_uparams (const struct argp_state *state)
 	      }
 	    else if (isdigit ((unsigned char) *arg))
 	      {
-		val = atoi (arg);
+		val = (int) __strtol (arg, NULL, 10);
 		while (isdigit ((unsigned char) *arg))
 		  arg++;
 		SKIPWS (arg);
diff --git a/argp/argp-parse.c b/argp/argp-parse.c
index 68dc4541..c26c0fc2 100644
--- a/argp/argp-parse.c
+++ b/argp/argp-parse.c
@@ -147,7 +147,7 @@ argp_default_parser (int key, char *arg, struct argp_state *state)
       break;
 
     case OPT_HANG:
-      _argp_hang = atoi (arg ? arg : "3600");
+      _argp_hang = (int) __strtol (arg ? arg : "3600", NULL, 10);
       while (_argp_hang-- > 0)
 	__sleep (1);
       break;
@@ -177,7 +177,7 @@ argp_version_parser (int key, char *arg, struct argp_state *state)
       if (argp_program_version_hook)
 	(*argp_program_version_hook) (state->out_stream, state);
       else if (argp_program_version)
-	fprintf (state->out_stream, "%s\n", argp_program_version);
+	__fprintf (state->out_stream, "%s\n", argp_program_version);
       else
 	__argp_error (state, dgettext (state->root_argp->argp_domain,
 				       "(PROGRAM ERROR) No version known!?"));
@@ -618,7 +618,7 @@ parser_finalize (struct parser *parser,
 	{
 	  if (!(parser->state.flags & ARGP_NO_ERRS)
 	      && parser->state.err_stream)
-	    fprintf (parser->state.err_stream,
+	    __fprintf (parser->state.err_stream,
 		     dgettext (parser->argp->argp_domain,
 			       "%s: Too many arguments\n"),
 		     parser->state.name);
diff --git a/argp/argp.h b/argp/argp.h
index d6a04069..9af80d77 100644
--- a/argp/argp.h
+++ b/argp/argp.h
@@ -25,6 +25,7 @@
 #include <getopt.h>
 #include <limits.h>
 #include <errno.h>
+#include <bits/floatn.h>
 
 __BEGIN_DECLS
 
@@ -464,11 +465,10 @@ extern void __argp_state_help (const struct argp_state *__restrict __state,
 extern void argp_usage (const struct argp_state *__state);
 extern void __argp_usage (const struct argp_state *__state);
 
-/* If appropriate, print the printf string FMT and following args, preceded
-   by the program name and `:', to stderr, and followed by a `Try ... --help'
-   message, then exit (1).  */
-extern void argp_error (const struct argp_state *__restrict __state,
-			const char *__restrict __fmt, ...)
+extern void __REDIRECT_LDBL (argp_error,
+			     (const struct argp_state *__restrict __state,
+			      const char *__restrict __fmt, ...),
+			     __argp_errorieee128, __nldbl_argp_error)
      __attribute__ ((__format__ (__printf__, 2, 3)));
 extern void __argp_error (const struct argp_state *__restrict __state,
 			  const char *__restrict __fmt, ...)
@@ -482,10 +482,13 @@ extern void __argp_error (const struct argp_state *__restrict __state,
    difference between this function and argp_error is that the latter is for
    *parsing errors*, and the former is for other problems that occur during
    parsing but don't reflect a (syntactic) problem with the input.  */
-extern void argp_failure (const struct argp_state *__restrict __state,
-			  int __status, int __errnum,
-			  const char *__restrict __fmt, ...)
+extern void __REDIRECT_LDBL (argp_failure,
+			     (const struct argp_state *__restrict __state,
+			      int __status, int __errnum,
+			      const char *__restrict __fmt, ...),
+			     __argp_failureieee128,__nldbl_argp_failure)
      __attribute__ ((__format__ (__printf__, 4, 5)));
+
 extern void __argp_failure (const struct argp_state *__restrict __state,
 			    int __status, int __errnum,
 			    const char *__restrict __fmt, ...)
@@ -554,11 +557,6 @@ __NTH (__option_is_end (const struct argp_option *__opt))
 # endif
 #endif /* Use extern inlines.  */
 
-#include <bits/floatn.h>
-#if defined __LDBL_COMPAT || __LDOUBLE_REDIRECTS_TO_FLOAT128_ABI == 1
-# include <bits/argp-ldbl.h>
-#endif
-
 __END_DECLS
 
 #endif /* argp.h */
diff --git a/argp/bits/argp-ldbl.h b/argp/bits/argp-ldbl.h
deleted file mode 100644
index 9dbe66bb..00000000
--- a/argp/bits/argp-ldbl.h
+++ /dev/null
@@ -1,24 +0,0 @@
-/* Redirections for argp functions for -mlong-double-64.
-   Copyright (C) 2019-2022 Free Software Foundation, Inc.
-   This file is part of the GNU C Library.
-
-   The GNU C Library is free software; you can redistribute it and/or
-   modify it under the terms of the GNU Lesser General Public
-   License as published by the Free Software Foundation; either
-   version 2.1 of the License, or (at your option) any later version.
-
-   The GNU C Library is distributed in the hope that it will be useful,
-   but WITHOUT ANY WARRANTY; without even the implied warranty of
-   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
-   Lesser General Public License for more details.
-
-   You should have received a copy of the GNU Lesser General Public
-   License along with the GNU C Library; if not, see
-   <https://www.gnu.org/licenses/>.  */
-
-#ifndef _ARGP_H
-# error "Never include <bits/argp-ldbl.h> directly; use <argp.h> instead."
-#endif
-
-__LDBL_REDIR_DECL (argp_error)
-__LDBL_REDIR_DECL (argp_failure)
diff --git a/benchtests/Makefile b/benchtests/Makefile
index 4c6af01c..5e636d50 100644
--- a/benchtests/Makefile
+++ b/benchtests/Makefile
@@ -157,9 +157,9 @@ CFLAGS-bench-trunc.c += -fno-builtin
 CFLAGS-bench-truncf.c += -fno-builtin
 CFLAGS-bench-roundeven.c += -fno-builtin
 CFLAGS-bench-roundevenf.c += -fno-builtin
-CFLAGS-bench-isnan.c += -fsignaling-nans
-CFLAGS-bench-isinf.c += -fsignaling-nans
-CFLAGS-bench-isfinite.c += -fsignaling-nans
+CFLAGS-bench-isnan.c += $(config-cflags-signaling-nans)
+CFLAGS-bench-isinf.c += $(config-cflags-signaling-nans)
+CFLAGS-bench-isfinite.c += $(config-cflags-signaling-nans)
 
 ifeq (${BENCHSET},)
 bench-malloc := malloc-thread malloc-simple
diff --git a/benchtests/bench-malloc-thread.c b/benchtests/bench-malloc-thread.c
index 81228392..04a9c631 100644
--- a/benchtests/bench-malloc-thread.c
+++ b/benchtests/bench-malloc-thread.c
@@ -26,6 +26,7 @@
 #include <sys/time.h>
 #include <sys/resource.h>
 #include <unistd.h>
+#include <libc-diag.h>
 
 #include "bench-timing.h"
 #include "json-lib.h"
@@ -63,7 +64,12 @@ get_block_size (unsigned int rand_data)
   float min_pow = powf (dist_min, exponent + 1);
   float max_pow = powf (dist_max, exponent + 1);
 
+  /* clang warns that converting from int to float (upper_bound) changes value
+     from 2147483647 to 2147483648.  It does not matter in tests below.  */
+  DIAG_PUSH_NEEDS_COMMENT_CLANG;
+  DIAG_IGNORE_NEEDS_COMMENT_CLANG (13, "-Wimplicit-const-int-float-conversion");
   float r = (float) rand_data / RAND_MAX;
+  DIAG_POP_NEEDS_COMMENT_CLANG;
 
   return (unsigned int) powf ((max_pow - min_pow) * r + min_pow,
 			      1 / (exponent + 1));
diff --git a/benchtests/bench-memset-large.c b/benchtests/bench-memset-large.c
index 0ea1e381..6605e2d4 100644
--- a/benchtests/bench-memset-large.c
+++ b/benchtests/bench-memset-large.c
@@ -118,6 +118,7 @@ test_main (void)
 #define libc_hidden_builtin_def(X)
 #define libc_hidden_def(X)
 #define libc_hidden_weak(X)
+#define strong_alias(X,Y)
 #define weak_alias(X,Y)
 #undef MEMSET
 #define MEMSET generic_memset
diff --git a/benchtests/bench-memset-walk.c b/benchtests/bench-memset-walk.c
index 466ee1b8..f7fcdf90 100644
--- a/benchtests/bench-memset-walk.c
+++ b/benchtests/bench-memset-walk.c
@@ -116,6 +116,7 @@ test_main (void)
 #define libc_hidden_builtin_def(X)
 #define libc_hidden_def(X)
 #define libc_hidden_weak(X)
+#define strong_alias(X,Y)
 #define weak_alias(X,Y)
 #undef MEMSET
 #define MEMSET generic_memset
diff --git a/benchtests/bench-memset.c b/benchtests/bench-memset.c
index beba3fbe..6b0eda89 100644
--- a/benchtests/bench-memset.c
+++ b/benchtests/bench-memset.c
@@ -147,6 +147,7 @@ test_main (void)
 #define libc_hidden_builtin_def(X)
 #define libc_hidden_def(X)
 #define libc_hidden_weak(X)
+#define strong_alias(X,Y)
 #define weak_alias(X,Y)
 #ifndef WIDE
 # undef MEMSET
diff --git a/benchtests/bench-pthread-locks.c b/benchtests/bench-pthread-locks.c
index d7419f51..e57c1221 100644
--- a/benchtests/bench-pthread-locks.c
+++ b/benchtests/bench-pthread-locks.c
@@ -61,8 +61,12 @@ typedef timing_t (*test_t)(long, int);
    total time each test iteration takes, so as to not swamp the useful
    timings.  */
 
-#pragma GCC push_options
-#pragma GCC optimize(1)
+#ifdef __clang__
+# pragma clang optimize off
+#else
+# pragma GCC push_options
+# pragma GCC optimize(1)
+#endif
 
 static int __attribute__((noinline))
 fibonacci (int i)
@@ -81,7 +85,11 @@ do_filler (void)
   memcpy (buf1, buf2, f);
 }
 
-#pragma GCC pop_options
+#ifdef __clang__
+# pragma clang optimize on
+#else
+# pragma GCC pop_options
+#endif
 
 static timing_t
 test_mutex (long iters, int filler)
diff --git a/benchtests/bench-strchr.c b/benchtests/bench-strchr.c
index 821bc615..a417ee04 100644
--- a/benchtests/bench-strchr.c
+++ b/benchtests/bench-strchr.c
@@ -16,6 +16,8 @@
    License along with the GNU C Library; if not, see
    <https://www.gnu.org/licenses/>.  */
 
+#include <libc-diag.h>
+
 #define TEST_MAIN
 #ifndef WIDE
 # ifdef USE_FOR_STRCHRNUL
diff --git a/benchtests/ilogbf128-inputs b/benchtests/ilogbf128-inputs
index bfbfc937..045b01a5 100644
--- a/benchtests/ilogbf128-inputs
+++ b/benchtests/ilogbf128-inputs
@@ -3,8 +3,8 @@
 ## includes: math.h
 
 ## name: subnormal
-6.47517511943802511092443895822764655e-4966f128
-0x1.fffffffffffffff8p-16383f128
+6.47517511943802511092443895822764655e-4966q
+0x1.fffffffffffffff8p-16383q
 
 ## name: normal
 1.0
diff --git a/catgets/config.h b/catgets/config.h
deleted file mode 100644
index ce7887b3..00000000
--- a/catgets/config.h
+++ /dev/null
@@ -1,14 +0,0 @@
-#ifndef _CG_CONFIG_H
-#define _CG_CONFIG_H
-
-/* Use the internal textdomain used for libc messages.  */
-#define PACKAGE _libc_intl_domainname
-#ifndef VERSION
-/* Get libc version number.  */
-#include "../version.h"
-#endif
-
-
-#include_next <config.h>
-
-#endif
diff --git a/catgets/gencat.c b/catgets/gencat.c
index cebf1fd4..8c284a97 100644
--- a/catgets/gencat.c
+++ b/catgets/gencat.c
@@ -14,8 +14,9 @@
    You should have received a copy of the GNU General Public License
    along with this program; if not, see <https://www.gnu.org/licenses/>.  */
 
+#define PACKAGE _libc_intl_domainname
 #ifdef HAVE_CONFIG_H
-# include "config.h"
+# include <config.h>
 #endif
 
 #include <argp.h>
@@ -1033,7 +1034,7 @@ write_out (struct catalog *catalog, const char *output_name,
 	  /* If the current message set has a symbolic name write this
 	     out first.  */
 	  if (set_run->symbol != NULL)
-	    fprintf (fp, "%s#define %sSet %#x\t/* %s:%Zu */\n",
+	    fprintf (fp, "%s#define %sSet %#x\t/* %s:%zu */\n",
 		     first ? "" : "\n", set_run->symbol, set_run->number - 1,
 		     set_run->fname, set_run->line);
 	  first = 0;
@@ -1047,12 +1048,12 @@ write_out (struct catalog *catalog, const char *output_name,
 	      if (message_run->symbol != NULL)
 		{
 		  if (set_run->symbol == NULL)
-		    fprintf (fp, "#define AutomaticSet%d%s %#x\t/* %s:%Zu */\n",
+		    fprintf (fp, "#define AutomaticSet%d%s %#x\t/* %s:%zu */\n",
 			     set_run->number, message_run->symbol,
 			     message_run->number, message_run->fname,
 			     message_run->line);
 		  else
-		    fprintf (fp, "#define %s%s %#x\t/* %s:%Zu */\n",
+		    fprintf (fp, "#define %s%s %#x\t/* %s:%zu */\n",
 			     set_run->symbol, message_run->symbol,
 			     message_run->number, message_run->fname,
 			     message_run->line);
diff --git a/config.make.in b/config.make.in
index 6d43e691..576cdea8 100644
--- a/config.make.in
+++ b/config.make.in
@@ -69,10 +69,10 @@ have-selinux = @have_selinux@
 have-libaudit = @have_libaudit@
 have-libcap = @have_libcap@
 have-cc-with-libunwind = @libc_cv_cc_with_libunwind@
-fno-unit-at-a-time = @fno_unit_at_a_time@
 bind-now = @bindnow@
 have-hash-style = @libc_cv_hashstyle@
 use-default-link = @use_default_link@
+is-clang = @libc_cv_compiler_is_clang@
 have-cxx-thread_local = @libc_cv_cxx_thread_local@
 have-loop-to-function = @libc_cv_cc_loop_to_function@
 have-textrel_ifunc = @libc_cv_textrel_ifunc@
diff --git a/configure b/configure
index 00dc6383..00dbeb9c 100755
--- a/configure
+++ b/configure
@@ -620,7 +620,6 @@ libc_cv_cc_loop_to_function
 libc_cv_cc_submachine
 libc_cv_cc_nofma
 libc_cv_mtls_dialect_gnu2
-fno_unit_at_a_time
 libc_cv_has_glob_dat
 libc_cv_hashstyle
 libc_cv_fpie
@@ -642,6 +641,7 @@ PYTHON
 PYTHON_PROG
 AUTOCONF
 NM
+libc_cv_compiler_is_clang
 BISON
 AWK
 SED
@@ -649,7 +649,6 @@ MAKEINFO
 MSGFMT
 MAKE
 LD
-AS
 GPROF
 OBJCOPY
 OBJDUMP
@@ -730,7 +729,6 @@ infodir
 docdir
 oldincludedir
 includedir
-runstatedir
 localstatedir
 sharedstatedir
 sysconfdir
@@ -845,7 +843,6 @@ datadir='${datarootdir}'
 sysconfdir='${prefix}/etc'
 sharedstatedir='${prefix}/com'
 localstatedir='${prefix}/var'
-runstatedir='${localstatedir}/run'
 includedir='${prefix}/include'
 oldincludedir='/usr/include'
 docdir='${datarootdir}/doc/${PACKAGE_TARNAME}'
@@ -1098,15 +1095,6 @@ do
   | -silent | --silent | --silen | --sile | --sil)
     silent=yes ;;
 
-  -runstatedir | --runstatedir | --runstatedi | --runstated \
-  | --runstate | --runstat | --runsta | --runst | --runs \
-  | --run | --ru | --r)
-    ac_prev=runstatedir ;;
-  -runstatedir=* | --runstatedir=* | --runstatedi=* | --runstated=* \
-  | --runstate=* | --runstat=* | --runsta=* | --runst=* | --runs=* \
-  | --run=* | --ru=* | --r=*)
-    runstatedir=$ac_optarg ;;
-
   -sbindir | --sbindir | --sbindi | --sbind | --sbin | --sbi | --sb)
     ac_prev=sbindir ;;
   -sbindir=* | --sbindir=* | --sbindi=* | --sbind=* | --sbin=* \
@@ -1244,7 +1232,7 @@ fi
 for ac_var in	exec_prefix prefix bindir sbindir libexecdir datarootdir \
 		datadir sysconfdir sharedstatedir localstatedir includedir \
 		oldincludedir docdir infodir htmldir dvidir pdfdir psdir \
-		libdir localedir mandir runstatedir
+		libdir localedir mandir
 do
   eval ac_val=\$$ac_var
   # Remove trailing slashes.
@@ -1397,7 +1385,6 @@ Fine tuning of the installation directories:
   --sysconfdir=DIR        read-only single-machine data [PREFIX/etc]
   --sharedstatedir=DIR    modifiable architecture-independent data [PREFIX/com]
   --localstatedir=DIR     modifiable single-machine data [PREFIX/var]
-  --runstatedir=DIR       modifiable per-process data [LOCALSTATEDIR/run]
   --libdir=DIR            object code libraries [EPREFIX/lib]
   --includedir=DIR        C header files [PREFIX/include]
   --oldincludedir=DIR     C header files for non-gcc [/usr/include]
@@ -3388,7 +3375,7 @@ fi
 if test "${with_default_link+set}" = set; then :
   withval=$with_default_link; use_default_link=$withval
 else
-  use_default_link=default
+  use_default_link=yes
 fi
 
 
@@ -4591,7 +4578,6 @@ case "$CC" in
     *fuse-ld=lld*) LDNAME=ld.lld;;
     *)             LDNAME=ld;;
 esac
-AS=`$CC -print-prog-name=as`
 LD=`$CC -print-prog-name=$LDNAME`
 AR=`$CC -print-prog-name=ar`
 
@@ -4603,25 +4589,6 @@ GPROF=`$CC -print-prog-name=gprof`
 
 
 # Determine whether we are using GNU binutils.
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether $AS is GNU as" >&5
-$as_echo_n "checking whether $AS is GNU as... " >&6; }
-if ${libc_cv_prog_as_gnu+:} false; then :
-  $as_echo_n "(cached) " >&6
-else
-  # Most GNU programs take a -v and spit out some text including
-# the word 'GNU'.  Some try to read stdin, so give them /dev/null.
-if $AS -o conftest -v </dev/null 2>&1 | grep GNU > /dev/null 2>&1; then
-  libc_cv_prog_as_gnu=yes
-else
-  libc_cv_prog_as_gnu=no
-fi
-rm -fr contest*
-fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $libc_cv_prog_as_gnu" >&5
-$as_echo "$libc_cv_prog_as_gnu" >&6; }
-rm -f a.out
-gnu_as=$libc_cv_prog_as_gnu
-
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking whether $LD is GNU ld" >&5
 $as_echo_n "checking whether $LD is GNU ld... " >&6; }
 if ${libc_cv_prog_ld_gnu+:} false; then :
@@ -4642,70 +4609,6 @@ gnu_ld=$libc_cv_prog_ld_gnu
 
 
 # Accept binutils 2.25 or newer.
-for ac_prog in $AS
-do
-  # Extract the first word of "$ac_prog", so it can be a program name with args.
-set dummy $ac_prog; ac_word=$2
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
-$as_echo_n "checking for $ac_word... " >&6; }
-if ${ac_cv_prog_AS+:} false; then :
-  $as_echo_n "(cached) " >&6
-else
-  if test -n "$AS"; then
-  ac_cv_prog_AS="$AS" # Let the user override the test.
-else
-as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
-for as_dir in $PATH
-do
-  IFS=$as_save_IFS
-  test -z "$as_dir" && as_dir=.
-    for ac_exec_ext in '' $ac_executable_extensions; do
-  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
-    ac_cv_prog_AS="$ac_prog"
-    $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
-    break 2
-  fi
-done
-  done
-IFS=$as_save_IFS
-
-fi
-fi
-AS=$ac_cv_prog_AS
-if test -n "$AS"; then
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $AS" >&5
-$as_echo "$AS" >&6; }
-else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
-fi
-
-
-  test -n "$AS" && break
-done
-
-if test -z "$AS"; then
-  ac_verc_fail=yes
-else
-  # Found it, now check the version.
-  { $as_echo "$as_me:${as_lineno-$LINENO}: checking version of $AS" >&5
-$as_echo_n "checking version of $AS... " >&6; }
-  ac_prog_version=`$AS --version 2>&1 | sed -n 's/^.*GNU assembler.* \([0-9]*\.[0-9.]*\).*$/\1/p'`
-  case $ac_prog_version in
-    '') ac_prog_version="v. ?.??, bad"; ac_verc_fail=yes;;
-    2.1[0-9][0-9]*|2.2[5-9]*|2.[3-9][0-9]*|[3-9].*|[1-9][0-9]*)
-       ac_prog_version="$ac_prog_version, ok"; ac_verc_fail=no;;
-    *) ac_prog_version="$ac_prog_version, bad"; ac_verc_fail=yes;;
-
-  esac
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_prog_version" >&5
-$as_echo "$ac_prog_version" >&6; }
-fi
-if test $ac_verc_fail = yes; then
-  AS=: critic_missing="$critic_missing as"
-fi
-
-
 libc_cv_with_lld=no
 case $($LD --version) in
   "GNU gold"*)
@@ -5304,7 +5207,7 @@ int
 main ()
 {
 
-#if !defined __GNUC__ || __GNUC__ < 6 || (__GNUC__ == 6 && __GNUC_MINOR__ < 2)
+#if (__GNUC__ < 6 || (__GNUC__ == 6 && __GNUC_MINOR__ < 2)) && !defined __clang__
 #error insufficient compiler
 #endif
   ;
@@ -5324,6 +5227,28 @@ if test $libc_cv_compiler_ok != yes; then :
   critic_missing="$critic_missing compiler"
 fi
 
+cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+/* end confdefs.h.  */
+
+int
+main ()
+{
+
+#ifndef __clang__
+# error not clang
+#endif
+  ;
+  return 0;
+}
+_ACEOF
+if ac_fn_c_try_cpp "$LINENO"; then :
+  libc_cv_compiler_is_clang=yes
+else
+  libc_cv_compiler_is_clang=no
+fi
+rm -f conftest.err conftest.i conftest.$ac_ext
+
+
 if test -n "$ac_tool_prefix"; then
   # Extract the first word of "${ac_tool_prefix}nm", so it can be a program name with args.
 set dummy ${ac_tool_prefix}nm; ac_word=$2
@@ -5594,8 +5519,8 @@ fi
 # copy of those headers in Makerules.
 if test -n "$CXX"; then
   find_cxx_header () {
-    echo "#include <$1>" | $CXX -M -MP -x c++ - 2>/dev/null \
-	 | sed -n "\,$1:,{s/:\$//;p}"
+    echo "#include <$1>" | $CXX -H -fsyntax-only -x c++ - 2>&1 \
+	 | sed -rn "\,^\.? .,{s/^\.*\. //p}"
   }
   CXX_CSTDLIB_HEADER="$(find_cxx_header cstdlib)"
   CXX_CMATH_HEADER="$(find_cxx_header cmath)"
@@ -6235,6 +6160,28 @@ fi
 $as_echo "$libc_cv_hashstyle" >&6; }
 
 
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking --unwindlib=none" >&5
+$as_echo_n "checking --unwindlib=none... " >&6; }
+if ${libc_cv_cc_unwindlib+:} false; then :
+  $as_echo_n "(cached) " >&6
+else
+  if { ac_try='${CC-cc} --unwindlib=none -xc /dev/null -S -o /dev/null'
+  { { eval echo "\"\$as_me\":${as_lineno-$LINENO}: \"$ac_try\""; } >&5
+  (eval $ac_try) 2>&5
+  ac_status=$?
+  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
+  test $ac_status = 0; }; }; then :
+  libc_cv_cc_unwindlib=--unwindlib=none
+else
+  libc_cv_cc_unwindlib=
+fi
+
+fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $libc_cv_cc_unwindlib" >&5
+$as_echo "$libc_cv_cc_unwindlib" >&6; }
+config_vars="$config_vars
+config-cflags-unwindlib = $libc_cv_cc_unwindlib"
+
 # The linker's default -shared behavior is good enough if it
 # does these things that our custom linker scripts ensure that
 # all allocated NOTE sections come first.
@@ -6331,68 +6278,110 @@ fi
 $as_echo "$libc_cv_has_glob_dat" >&6; }
 
 
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for -fno-toplevel-reorder -fno-section-anchors" >&5
-$as_echo_n "checking for -fno-toplevel-reorder -fno-section-anchors... " >&6; }
-if ${libc_cv_fno_toplevel_reorder+:} false; then :
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for -mtls-dialect=gnu2" >&5
+$as_echo_n "checking for -mtls-dialect=gnu2... " >&6; }
+if ${libc_cv_mtls_dialect_gnu2+:} false; then :
   $as_echo_n "(cached) " >&6
 else
   cat > conftest.c <<EOF
-int foo;
+__thread int i;
+void foo (void)
+{
+  i = 10;
+}
 EOF
-if { ac_try='${CC-cc} $CFLAGS $CPPFLAGS -S -fno-toplevel-reorder -fno-section-anchors
-			    conftest.c 1>&5'
+if { ac_try='${CC-cc} $CFLAGS $CPPFLAGS -fPIC -mtls-dialect=gnu2 -nostdlib -nostartfiles
+		   conftest.c -o conftest 1>&5'
   { { eval echo "\"\$as_me\":${as_lineno-$LINENO}: \"$ac_try\""; } >&5
   (eval $ac_try) 2>&5
   ac_status=$?
   $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
   test $ac_status = 0; }; }
 then
-  libc_cv_fno_toplevel_reorder=yes
+  libc_cv_mtls_dialect_gnu2=yes
 else
-  libc_cv_fno_toplevel_reorder=no
+  libc_cv_mtls_dialect_gnu2=no
 fi
 rm -f conftest*
 fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $libc_cv_fno_toplevel_reorder" >&5
-$as_echo "$libc_cv_fno_toplevel_reorder" >&6; }
-if test $libc_cv_fno_toplevel_reorder = yes; then
-  fno_unit_at_a_time="-fno-toplevel-reorder -fno-section-anchors"
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $libc_cv_mtls_dialect_gnu2" >&5
+$as_echo "$libc_cv_mtls_dialect_gnu2" >&6; }
+
+config_vars="$config_vars
+have-mtls-dialect-gnu2 = $libc_cv_mtls_dialect_gnu2"
+
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for -Wno-maybe-uninitialized" >&5
+$as_echo_n "checking for -Wno-maybe-uninitialized... " >&6; }
+if ${libc_cv_wno_maybe_uninitialized+:} false; then :
+  $as_echo_n "(cached) " >&6
 else
-  fno_unit_at_a_time=-fno-unit-at-a-time
+  		if { ac_try='${CC-cc} -Werror -Wno-maybe-uninitialized -xc /dev/null -S -o /dev/null'
+  { { eval echo "\"\$as_me\":${as_lineno-$LINENO}: \"$ac_try\""; } >&5
+  (eval $ac_try) 2>&5
+  ac_status=$?
+  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
+  test $ac_status = 0; }; }; then :
+  libc_cv_wno_maybe_uninitialized=-Wno-maybe-uninitialized
+else
+  libc_cv_wno_maybe_uninitialized=
 fi
 
+fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $libc_cv_wno_maybe_uninitialized" >&5
+$as_echo "$libc_cv_wno_maybe_uninitialized" >&6; }
+config_vars="$config_vars
+config-cflags-wno-maybe-uninitialized = $libc_cv_wno_maybe_uninitialized"
 
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for -mtls-dialect=gnu2" >&5
-$as_echo_n "checking for -mtls-dialect=gnu2... " >&6; }
-if ${libc_cv_mtls_dialect_gnu2+:} false; then :
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for -fexcess-precision=standard" >&5
+$as_echo_n "checking for -fexcess-precision=standard... " >&6; }
+if ${libc_cv_fexcess_precision_standard+:} false; then :
+  $as_echo_n "(cached) " >&6
+else
+  		if { ac_try='${CC-cc} -Werror -fexcess-precision=standard -xc /dev/null -S -o /dev/null'
+  { { eval echo "\"\$as_me\":${as_lineno-$LINENO}: \"$ac_try\""; } >&5
+  (eval $ac_try) 2>&5
+  ac_status=$?
+  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
+  test $ac_status = 0; }; }; then :
+  libc_cv_fexcess_precision_standard=-fexcess-precision=standard
+else
+  libc_cv_fexcess_precision_standard=
+fi
+
+fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $libc_cv_fexcess_precision_standard" >&5
+$as_echo "$libc_cv_fexcess_precision_standard" >&6; }
+config_vars="$config_vars
+config-cflags-fexcess-precision-standard = $libc_cv_fexcess_precision_standard"
+
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking if -Wno-ignored-attributes is required for aliases" >&5
+$as_echo_n "checking if -Wno-ignored-attributes is required for aliases... " >&6; }
+if ${libc_cv_wno_ignored_attributes+:} false; then :
   $as_echo_n "(cached) " >&6
 else
   cat > conftest.c <<EOF
-__thread int i;
-void foo (void)
+void __foo (void)
 {
-  i = 10;
 }
+extern __typeof (__foo) foo __attribute__ ((weak, alias ("__foo")));
+extern __typeof (__foo) bar __attribute__ ((weak, alias ("foo")));
 EOF
-if { ac_try='${CC-cc} $CFLAGS $CPPFLAGS -fPIC -mtls-dialect=gnu2 -nostdlib -nostartfiles
-		   conftest.c -o conftest 1>&5'
+libc_cv_wno_ignored_attributes=""
+if ! { ac_try='${CC-cc} $CFLAGS $CPPFLAGS -Werror -c conftest.c'
   { { eval echo "\"\$as_me\":${as_lineno-$LINENO}: \"$ac_try\""; } >&5
   (eval $ac_try) 2>&5
   ac_status=$?
   $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
   test $ac_status = 0; }; }
 then
-  libc_cv_mtls_dialect_gnu2=yes
-else
-  libc_cv_mtls_dialect_gnu2=no
+  libc_cv_wno_ignored_attributes="-Wno-ignored-attributes"
 fi
 rm -f conftest*
 fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $libc_cv_mtls_dialect_gnu2" >&5
-$as_echo "$libc_cv_mtls_dialect_gnu2" >&6; }
-
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $libc_cv_wno_ignored_attributes" >&5
+$as_echo "$libc_cv_wno_ignored_attributes" >&6; }
 config_vars="$config_vars
-have-mtls-dialect-gnu2 = $libc_cv_mtls_dialect_gnu2"
+config-cflags-wno-ignored-attributes = $libc_cv_wno_ignored_attributes"
 
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking whether cc puts quotes around section names" >&5
 $as_echo_n "checking whether cc puts quotes around section names... " >&6; }
@@ -6462,7 +6451,7 @@ else
 extern char *strstr (const char *, const char *) __asm ("my_strstr");
 char *foo (const char *a, const char *b)
 {
-  return __builtin_strstr (a, b);
+  return strstr (a, b);
 }
 EOF
 if { ac_try='${CC-cc} -O3 -S conftest.c -o - | grep -F "my_strstr" > /dev/null'
@@ -6533,6 +6522,100 @@ $as_echo "$libc_cv_cc_submachine" >&6; }
 fi
 
 
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for compiler option that -fsignaling-nans" >&5
+$as_echo_n "checking for compiler option that -fsignaling-nans... " >&6; }
+if ${libc_cv_cc_signaling_nans+:} false; then :
+  $as_echo_n "(cached) " >&6
+else
+  if { ac_try='${CC-cc} -Werror -fsignaling-nans -xc /dev/null -S -o /dev/null'
+  { { eval echo "\"\$as_me\":${as_lineno-$LINENO}: \"$ac_try\""; } >&5
+  (eval $ac_try) 2>&5
+  ac_status=$?
+  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
+  test $ac_status = 0; }; }; then :
+  libc_cv_cc_signaling_nans=-fsignaling-nans
+else
+  libc_cv_cc_signaling_nans=
+fi
+
+fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $libc_cv_cc_signaling_nans" >&5
+$as_echo "$libc_cv_cc_signaling_nans" >&6; }
+config_vars="$config_vars
+config-cflags-signaling-nans = $libc_cv_cc_signaling_nans"
+
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for compiler option -frounding-math" >&5
+$as_echo_n "checking for compiler option -frounding-math... " >&6; }
+if ${libc_cv_cc_rounding_math+:} false; then :
+  $as_echo_n "(cached) " >&6
+else
+  if { ac_try='${CC-cc} -Werror -frounding-math -xc /dev/null -S -o /dev/null'
+  { { eval echo "\"\$as_me\":${as_lineno-$LINENO}: \"$ac_try\""; } >&5
+  (eval $ac_try) 2>&5
+  ac_status=$?
+  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
+  test $ac_status = 0; }; }; then :
+  libc_cv_cc_rounding_math=-frounding-math
+else
+  libc_cv_cc_rounding_math=
+fi
+
+fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $libc_cv_cc_rounding_math" >&5
+$as_echo "$libc_cv_cc_rounding_math" >&6; }
+config_vars="$config_vars
+config-cflags-frounding-math = $libc_cv_cc_rounding_math"
+
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for compiler option that -ffloat-store" >&5
+$as_echo_n "checking for compiler option that -ffloat-store... " >&6; }
+if ${libc_cv_cc_float_store+:} false; then :
+  $as_echo_n "(cached) " >&6
+else
+  if { ac_try='${CC-cc} -Werror -ffloat-store -xc /dev/null -S -o /dev/null'
+  { { eval echo "\"\$as_me\":${as_lineno-$LINENO}: \"$ac_try\""; } >&5
+  (eval $ac_try) 2>&5
+  ac_status=$?
+  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
+  test $ac_status = 0; }; }; then :
+  libc_cv_cc_float_store=-ffloat-store
+else
+  libc_cv_cc_float_store=
+fi
+
+fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $libc_cv_cc_float_store" >&5
+$as_echo "$libc_cv_cc_float_store" >&6; }
+config_vars="$config_vars
+config-cflags-float-store = $libc_cv_cc_float_store"
+
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether compiler supports _Complex with __int128" >&5
+$as_echo_n "checking whether compiler supports _Complex with __int128... " >&6; }
+if ${libc_cv_complex_int128+:} false; then :
+  $as_echo_n "(cached) " >&6
+else
+  cat > conftest.c <<EOF
+#ifndef __SIZEOF_INT128__
+# error "__int128 not supported"
+#endif
+_Complex __int128 var;
+EOF
+libc_cv_complex_int128=no
+if { ac_try='${CC-cc} $CFLAGS $CPPFLAGS -c conftest.c 1>&5'
+  { { eval echo "\"\$as_me\":${as_lineno-$LINENO}: \"$ac_try\""; } >&5
+  (eval $ac_try) 2>&5
+  ac_status=$?
+  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
+  test $ac_status = 0; }; }
+then
+  libc_cv_complex_int128=yes
+fi
+rm -f conftest*
+fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $libc_cv_complex_int128" >&5
+$as_echo "$libc_cv_complex_int128" >&6; }
+config_vars="$config_vars
+config-complex-int128 = $libc_cv_complex_int128"
+
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking if $CC accepts -fno-tree-loop-distribute-patterns with \
 __attribute__ ((__optimize__))" >&5
 $as_echo_n "checking if $CC accepts -fno-tree-loop-distribute-patterns with \
@@ -6546,7 +6629,7 @@ __attribute__ ((__optimize__ ("-fno-tree-loop-distribute-patterns")))
 foo (void) {}
 EOF
 libc_cv_cc_loop_to_function=no
-if { ac_try='${CC-cc} $CFLAGS $CPPFLAGS -c conftest.c'
+if { ac_try='${CC-cc} $CFLAGS $CPPFLAGS -Werror -c conftest.c'
   { { eval echo "\"\$as_me\":${as_lineno-$LINENO}: \"$ac_try\""; } >&5
   (eval $ac_try) 2>&5
   ac_status=$?
@@ -6565,6 +6648,83 @@ if test $libc_cv_cc_loop_to_function = yes; then
 fi
 
 
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking if $CC has support for trampolines" >&5
+$as_echo_n "checking if $CC has support for trampolines... " >&6; }
+if ${libc_cv_cc_trampoline+:} false; then :
+  $as_echo_n "(cached) " >&6
+else
+  cat > conftest.c <<EOF
+void bar (void (*callback) (void));
+int foo (void)
+{
+  int var = 0;
+  void callback (void) { var = 1; }
+  bar (callback);
+  return var;
+}
+EOF
+libc_cv_cc_trampoline=no
+if { ac_try='${CC-cc} $CFLAGS $CPPFLAGS -Werror -c conftest.c'
+  { { eval echo "\"\$as_me\":${as_lineno-$LINENO}: \"$ac_try\""; } >&5
+  (eval $ac_try) 2>&5
+  ac_status=$?
+  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
+  test $ac_status = 0; }; }
+then
+  libc_cv_cc_trampoline=yes
+fi
+rm -f conftest*
+fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $libc_cv_cc_trampoline" >&5
+$as_echo "$libc_cv_cc_trampoline" >&6; }
+config_vars="$config_vars
+have-cc-trampoline = $libc_cv_cc_trampoline"
+
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking if $CC supports -finput-charset=ascii" >&5
+$as_echo_n "checking if $CC supports -finput-charset=ascii... " >&6; }
+if ${libc_cv_cc_charset_ascii+:} false; then :
+  $as_echo_n "(cached) " >&6
+else
+  if { ac_try='${CC-cc} -Werror -finput-charset=ascii -xc /dev/null -S -o /dev/null'
+  { { eval echo "\"\$as_me\":${as_lineno-$LINENO}: \"$ac_try\""; } >&5
+  (eval $ac_try) 2>&5
+  ac_status=$?
+  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
+  test $ac_status = 0; }; }; then :
+  libc_cv_cc_charset_ascii=yes
+else
+  libc_cv_cc_charset_ascii=no
+fi
+
+fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $libc_cv_cc_charset_ascii" >&5
+$as_echo "$libc_cv_cc_charset_ascii" >&6; }
+config_vars="$config_vars
+config-cflags-charset-ascii = $libc_cv_cc_charset_ascii"
+
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking if $CC supports gnu_unique_object" >&5
+$as_echo_n "checking if $CC supports gnu_unique_object... " >&6; }
+if ${libc_cv_cc_gnu_unique_object+:} false; then :
+  $as_echo_n "(cached) " >&6
+else
+  cat > conftest.S <<EOF
+.type foo, %gnu_unique_object;
+.globl foo;
+foo:
+EOF
+libc_cv_cc_gnu_unique_object=no
+if ${CC-cc} $CFLAGS $CPPFLAGS -c conftest.S 1>&5 2>&5;
+then
+  LC_ALL=C $READELF -s conftest.o | grep -q 'UNIQUE' && { libc_cv_cc_gnu_unique_object=yes
+  }
+fi
+rm -rf conftest*
+fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $libc_cv_cc_gnu_unique_object" >&5
+$as_echo "$libc_cv_cc_gnu_unique_object" >&6; }
+config_vars="$config_vars
+config-gnu-unique-object = $libc_cv_cc_gnu_unique_object"
+
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for libgd" >&5
 $as_echo_n "checking for libgd... " >&6; }
 if test "$with_gd" != "no"; then
diff --git a/configure.ac b/configure.ac
index 87f67d25..a5835162 100644
--- a/configure.ac
+++ b/configure.ac
@@ -153,7 +153,7 @@ AC_ARG_WITH([default-link],
 	    AS_HELP_STRING([--with-default-link],
 			   [do not use explicit linker scripts]),
 	    [use_default_link=$withval],
-	    [use_default_link=default])
+	    [use_default_link=yes])
 
 dnl Additional build flags injection.
 AC_ARG_WITH([nonshared-cflags],
@@ -1003,11 +1003,6 @@ AC_PROG_LN_S
 LIBC_PROG_BINUTILS
 
 # Accept binutils 2.25 or newer.
-AC_CHECK_PROG_VER(AS, $AS, --version,
-		  [GNU assembler.* \([0-9]*\.[0-9.]*\)],
-		  [2.1[0-9][0-9]*|2.2[5-9]*|2.[3-9][0-9]*|[3-9].*|[1-9][0-9]*],
-		  AS=: critic_missing="$critic_missing as")
-
 libc_cv_with_lld=no
 case $($LD --version) in
   "GNU gold"*)
@@ -1060,7 +1055,7 @@ AC_CHECK_PROG_VER(BISON, bison, --version,
 
 AC_CACHE_CHECK([if $CC is sufficient to build libc], libc_cv_compiler_ok, [
 AC_PREPROC_IFELSE([AC_LANG_PROGRAM([[]], [[
-#if !defined __GNUC__ || __GNUC__ < 6 || (__GNUC__ == 6 && __GNUC_MINOR__ < 2)
+#if (__GNUC__ < 6 || (__GNUC__ == 6 && __GNUC_MINOR__ < 2)) && !defined __clang__
 #error insufficient compiler
 #endif]])],
 	       [libc_cv_compiler_ok=yes],
@@ -1068,6 +1063,14 @@ AC_PREPROC_IFELSE([AC_LANG_PROGRAM([[]], [[
 AS_IF([test $libc_cv_compiler_ok != yes],
       [critic_missing="$critic_missing compiler"])
 
+AC_PREPROC_IFELSE([AC_LANG_PROGRAM([[]], [[
+#ifndef __clang__
+# error not clang
+#endif]])],
+	       [libc_cv_compiler_is_clang=yes],
+	       [libc_cv_compiler_is_clang=no])
+AC_SUBST(libc_cv_compiler_is_clang)
+
 AC_CHECK_TOOL(NM, nm, false)
 
 if test "x$maintainer" = "xyes"; then
@@ -1136,8 +1139,8 @@ AC_SUBST(CXX_SYSINCLUDES)
 # copy of those headers in Makerules.
 if test -n "$CXX"; then
   find_cxx_header () {
-    echo "#include <$1>" | $CXX -M -MP -x c++ - 2>/dev/null \
-	 | sed -n "\,$1:,{s/:\$//;p}"
+    echo "#include <$1>" | $CXX -H -fsyntax-only -x c++ - 2>&1 \
+	 | sed -rn "\,^\.? .,{s/[^\.]*\. //p}"
   }
   CXX_CSTDLIB_HEADER="$(find_cxx_header cstdlib)"
   CXX_CMATH_HEADER="$(find_cxx_header cmath)"
@@ -1402,6 +1405,15 @@ fi
 rm -f conftest*])
 AC_SUBST(libc_cv_hashstyle)
 
+dnl Check if compiler supports --unwindlib=none
+AC_CACHE_CHECK(--unwindlib=none, libc_cv_cc_unwindlib, [dnl
+LIBC_TRY_CC_OPTION([--unwindlib=none],
+		   [libc_cv_cc_unwindlib=--unwindlib=none],
+		   [libc_cv_cc_unwindlib=])
+])
+LIBC_CONFIG_VAR([config-cflags-unwindlib],
+		[$libc_cv_cc_unwindlib])
+
 # The linker's default -shared behavior is good enough if it
 # does these things that our custom linker scripts ensure that
 # all allocated NOTE sections come first.
@@ -1478,25 +1490,6 @@ fi
 rm -f conftest*])
 AC_SUBST(libc_cv_has_glob_dat)
 
-AC_CACHE_CHECK(for -fno-toplevel-reorder -fno-section-anchors, libc_cv_fno_toplevel_reorder, [dnl
-cat > conftest.c <<EOF
-int foo;
-EOF
-if AC_TRY_COMMAND([${CC-cc} $CFLAGS $CPPFLAGS -S -fno-toplevel-reorder -fno-section-anchors
-			    conftest.c 1>&AS_MESSAGE_LOG_FD])
-then
-  libc_cv_fno_toplevel_reorder=yes
-else
-  libc_cv_fno_toplevel_reorder=no
-fi
-rm -f conftest*])
-if test $libc_cv_fno_toplevel_reorder = yes; then
-  fno_unit_at_a_time="-fno-toplevel-reorder -fno-section-anchors"
-else
-  fno_unit_at_a_time=-fno-unit-at-a-time
-fi
-AC_SUBST(fno_unit_at_a_time)
-
 AC_CACHE_CHECK([for -mtls-dialect=gnu2], libc_cv_mtls_dialect_gnu2,
 [dnl
 cat > conftest.c <<EOF
@@ -1517,6 +1510,44 @@ rm -f conftest*])
 AC_SUBST(libc_cv_mtls_dialect_gnu2)
 LIBC_CONFIG_VAR([have-mtls-dialect-gnu2], [$libc_cv_mtls_dialect_gnu2])
 
+AC_CACHE_CHECK([for -Wno-maybe-uninitialized], libc_cv_wno_maybe_uninitialized, [dnl
+		LIBC_TRY_CC_OPTION([-Werror -Wno-maybe-uninitialized],
+				   [libc_cv_wno_maybe_uninitialized=-Wno-maybe-uninitialized],
+				   [libc_cv_wno_maybe_uninitialized=])
+])
+LIBC_CONFIG_VAR([config-cflags-wno-maybe-uninitialized],
+		[$libc_cv_wno_maybe_uninitialized])
+
+AC_CACHE_CHECK([for -fexcess-precision=standard], libc_cv_fexcess_precision_standard, [dnl
+		LIBC_TRY_CC_OPTION([-Werror -fexcess-precision=standard],
+				   [libc_cv_fexcess_precision_standard=-fexcess-precision=standard],
+				   [libc_cv_fexcess_precision_standard=])
+])
+LIBC_CONFIG_VAR([config-cflags-fexcess-precision-standard],
+		[$libc_cv_fexcess_precision_standard])
+
+dnl clang emits an warning when a double alias redirection is used, to warn
+dnl the the original symbol will be used even when weak definition is overridden.
+dnl This is a common pattern for weak_alias, where multiple alias are set to
+dnl same symbol.
+AC_CACHE_CHECK([if -Wno-ignored-attributes is required for aliases],
+	       libc_cv_wno_ignored_attributes, [dnl
+cat > conftest.c <<EOF
+void __foo (void)
+{
+}
+extern __typeof (__foo) foo __attribute__ ((weak, alias ("__foo")));
+extern __typeof (__foo) bar __attribute__ ((weak, alias ("foo")));
+EOF
+libc_cv_wno_ignored_attributes=""
+if ! AC_TRY_COMMAND([${CC-cc} $CFLAGS $CPPFLAGS -Werror -c conftest.c])
+then
+  libc_cv_wno_ignored_attributes="-Wno-ignored-attributes"
+fi
+rm -f conftest*])
+LIBC_CONFIG_VAR([config-cflags-wno-ignored-attributes],
+		[$libc_cv_wno_ignored_attributes])
+
 AC_CACHE_CHECK(whether cc puts quotes around section names,
 	       libc_cv_have_section_quotes,
 	       [cat > conftest.c <<EOF
@@ -1562,7 +1593,7 @@ cat > conftest.c <<\EOF
 extern char *strstr (const char *, const char *) __asm ("my_strstr");
 char *foo (const char *a, const char *b)
 {
-  return __builtin_strstr (a, b);
+  return strstr (a, b);
 }
 EOF
 dnl
@@ -1601,6 +1632,52 @@ if test -n "$submachine"; then
 fi
 AC_SUBST(libc_cv_cc_submachine)
 
+dnl Determine if compiler supports -fsignaling-nans
+AC_CACHE_CHECK([for compiler option that -fsignaling-nans],
+	       libc_cv_cc_signaling_nans, [dnl
+LIBC_TRY_CC_OPTION([-Werror -fsignaling-nans],
+		   [libc_cv_cc_signaling_nans=-fsignaling-nans],
+		   [libc_cv_cc_signaling_nans=])
+])
+LIBC_CONFIG_VAR([config-cflags-signaling-nans],
+		[$libc_cv_cc_signaling_nans])
+
+dnl Determina if compiler support -frounding-math
+AC_CACHE_CHECK([for compiler option -frounding-math], libc_cv_cc_rounding_math, [dnl
+LIBC_TRY_CC_OPTION([-Werror -frounding-math],
+		   [libc_cv_cc_rounding_math=-frounding-math],
+		   [libc_cv_cc_rounding_math=])
+])
+LIBC_CONFIG_VAR([config-cflags-frounding-math],
+	       	[$libc_cv_cc_rounding_math])
+
+dnl Determine if compiler supports -ffloat-store
+AC_CACHE_CHECK([for compiler option that -ffloat-store],
+	       libc_cv_cc_float_store, [dnl
+LIBC_TRY_CC_OPTION([-Werror -ffloat-store],
+		   [libc_cv_cc_float_store=-ffloat-store],
+		   [libc_cv_cc_float_store=])
+])
+LIBC_CONFIG_VAR([config-cflags-float-store],
+		[$libc_cv_cc_float_store])
+
+AC_CACHE_CHECK([whether compiler supports _Complex with __int128],
+	       [libc_cv_complex_int128], [dnl
+cat > conftest.c <<EOF
+#ifndef __SIZEOF_INT128__
+# error "__int128 not supported"
+#endif
+_Complex __int128 var;
+EOF
+libc_cv_complex_int128=no
+if AC_TRY_COMMAND([${CC-cc} $CFLAGS $CPPFLAGS -c conftest.c 1>&AS_MESSAGE_LOG_FD])
+then
+  libc_cv_complex_int128=yes
+fi
+rm -f conftest*])
+LIBC_CONFIG_VAR([config-complex-int128],
+	       	[$libc_cv_complex_int128])
+
 AC_CACHE_CHECK(if $CC accepts -fno-tree-loop-distribute-patterns with \
 __attribute__ ((__optimize__)), libc_cv_cc_loop_to_function, [dnl
 cat > conftest.c <<EOF
@@ -1609,7 +1686,7 @@ __attribute__ ((__optimize__ ("-fno-tree-loop-distribute-patterns")))
 foo (void) {}
 EOF
 libc_cv_cc_loop_to_function=no
-if AC_TRY_COMMAND([${CC-cc} $CFLAGS $CPPFLAGS -c conftest.c])
+if AC_TRY_COMMAND([${CC-cc} $CFLAGS $CPPFLAGS -Werror -c conftest.c])
 then
   libc_cv_cc_loop_to_function=yes
 fi
@@ -1619,6 +1696,53 @@ if test $libc_cv_cc_loop_to_function = yes; then
 fi
 AC_SUBST(libc_cv_cc_loop_to_function)
 
+AC_CACHE_CHECK(if $CC has support for trampolines, libc_cv_cc_trampoline, [dnl
+cat > conftest.c <<EOF
+void bar (void (*callback) (void));
+int foo (void)
+{
+  int var = 0;
+  void callback (void) { var = 1; }
+  bar (callback);
+  return var;
+}
+EOF
+libc_cv_cc_trampoline=no
+if AC_TRY_COMMAND([${CC-cc} $CFLAGS $CPPFLAGS -Werror -c conftest.c])
+then
+  libc_cv_cc_trampoline=yes
+fi
+rm -f conftest*])
+LIBC_CONFIG_VAR([have-cc-trampoline],
+		[$libc_cv_cc_trampoline])
+
+dnl Check if -finput-charset accepts ascii
+AC_CACHE_CHECK([if $CC supports -finput-charset=ascii],
+	       libc_cv_cc_charset_ascii, [dnl
+LIBC_TRY_CC_OPTION([-Werror -finput-charset=ascii],
+		   [libc_cv_cc_charset_ascii=yes],
+		   [libc_cv_cc_charset_ascii=no])
+])
+LIBC_CONFIG_VAR([config-cflags-charset-ascii],
+		[$libc_cv_cc_charset_ascii])
+
+dnl Check if compiler supports %gnu_unique_object
+AC_CACHE_CHECK([if $CC supports gnu_unique_object], libc_cv_cc_gnu_unique_object, [dnl
+cat > conftest.S <<EOF
+.type foo, %gnu_unique_object;
+.globl foo;
+foo:
+EOF
+libc_cv_cc_gnu_unique_object=no
+if ${CC-cc} $CFLAGS $CPPFLAGS -c conftest.S 1>&AS_MESSAGE_LOG_FD 2>&AS_MESSAGE_LOG_FD;
+then
+  LC_ALL=C $READELF -s conftest.o | grep -q 'UNIQUE' && { libc_cv_cc_gnu_unique_object=yes
+  }
+fi
+rm -rf conftest*])
+LIBC_CONFIG_VAR([config-gnu-unique-object],
+		[$libc_cv_cc_gnu_unique_object])
+
 dnl Check whether we have the gd library available.
 AC_MSG_CHECKING(for libgd)
 if test "$with_gd" != "no"; then
diff --git a/conform/conformtest.py b/conform/conformtest.py
index 94a7ee11..2e27b9b1 100644
--- a/conform/conformtest.py
+++ b/conform/conformtest.py
@@ -157,9 +157,9 @@ class ConstantTest(object):
                     '%s'
                     '# define conformtest_%d_value (%s)\n'
                     '#endif\n'
-                    '_Static_assert (((%s < 0) == conformtest_%d_negative) '
+                    'STATIC_ASSERT (((%s < 0) == conformtest_%d_negative) '
                     '&& (%s == conformtest_%d_value), '
-                    '"value match inside and outside #if");\n'
+                    'value_match_inside_and_outside_if);\n'
                     % (self.symbol, self.num, sym_bits_def_neg, self.num,
                        sym_bits_or_neg, self.num, sym_bits_def_pos, self.num,
                        sym_bits_or_pos, self.symbol, self.num, self.symbol,
@@ -172,6 +172,10 @@ class ConstantTest(object):
                 c_type = self.c_type[len('promoted:'):]
                 text = ('__typeof__ ((%s) 0 + (%s) 0) a2_%d;\n'
                         % (c_type, c_type, self.num))
+            elif self.c_type.startswith('size:'):
+                c_type = "int{}_t".format(self.c_type[len('size:'):])
+                text = ('__typeof__ ((%s) 0 + (%s) 0) a2_%d;\n'
+                        % (c_type, c_type, self.num))
             else:
                 text = '__typeof__ ((%s) 0) a2_%d;\n' % (self.c_type, self.num)
             text += 'extern __typeof__ (%s) a2_%d;\n' % (self.symbol, self.num)
@@ -179,8 +183,8 @@ class ConstantTest(object):
                 'Type of symbol %s' % self.symbol,
                 text))
         if self.op is not None:
-            text = ('_Static_assert (%(symbol)s %(op)s %(value)s, '
-                    '"value constraint");\n'
+            text = ('STATIC_ASSERT (%(symbol)s %(op)s %(value)s, '
+                    'value_constraint);\n'
                     % vars(self))
             self.subtests.append(CompileSubTest(
                 'Value of symbol %s' % self.symbol,
@@ -552,6 +556,16 @@ class HeaderTests(object):
         self.skipped += 1
         sys.stdout.flush()
 
+    def common_definitions(self):
+        """Add any required common definition for the compilation tests."""
+        text = ('#define __STR(pre,post) pre ## post\n'
+                '#define _STR(pre,post) __STR(pre, post)\n'
+                '#define STATIC_ASSERT(cond, msg) \\\n'
+                '  typedef struct {\\\n'
+                '    int _STR (static_assertion_failed_, msg) : !!(cond);\\\n'
+                '  } _STR (static_assertion_failed_, __COUNTER__)\n')
+        return text
+
     def compile_test(self, name, text):
         """Run a compilation test; return True if it passes."""
         self.total += 1
@@ -565,7 +579,8 @@ class HeaderTests(object):
         c_file = os.path.join(self.temp_dir, 'test.c')
         o_file = os.path.join(self.temp_dir, 'test.o')
         with open(c_file, 'w') as c_file_out:
-            c_file_out.write('#include <%s>\n%s' % (self.header, text))
+            c_file_out.write('#include <%s>\n%s\n%s' %
+                    (self.header, self.common_definitions(), text))
         cmd = ('%s %s -c %s -o %s' % (self.cc, self.cflags, c_file, o_file))
         try:
             subprocess.check_call(cmd, shell=True)
@@ -620,7 +635,7 @@ class HeaderTests(object):
         out_file = os.path.join(self.temp_dir, 'namespace-out')
         with open(c_file, 'w') as c_file_out:
             c_file_out.write('#include <%s>\n' % self.header)
-        cmd = ('%s %s -E %s -P -Wp,-dN > %s'
+        cmd = ('%s %s -E %s -P -Wp,-dD > %s'
                % (self.cc, self.cflags_namespace, c_file, out_file))
         subprocess.check_call(cmd, shell=True)
         bad_tokens = set()
@@ -639,11 +654,11 @@ class HeaderTests(object):
                     # macros defined by user code including the
                     # header.)
                     continue
-                match = re.match(r'#define (.*)', line)
+                match = re.match(r'#define (.*?[^\(\s]+)', line)
                 if match:
                     self.check_token(bad_tokens, match.group(1))
                     continue
-                match = re.match(r'#undef (.*)', line)
+                match = re.match(r'#undef (.*?[^\(\s]+)', line)
                 if match:
                     bad_tokens.discard(match.group(1))
                     continue
diff --git a/conform/data/stdint.h-data b/conform/data/stdint.h-data
index 4e84e17f..5d65d4ec 100644
--- a/conform/data/stdint.h-data
+++ b/conform/data/stdint.h-data
@@ -88,8 +88,8 @@ macro-int-constant UINTMAX_MAX {promoted:uintmax_t} >= 18446744073709551615ULL
 macro-int-constant PTRDIFF_MIN {promoted:__PTRDIFF_TYPE__} <= -65535
 macro-int-constant PTRDIFF_MAX {promoted:__PTRDIFF_TYPE__} >= 65535
 
-macro-int-constant SIG_ATOMIC_MIN {promoted:__SIG_ATOMIC_TYPE__}
-macro-int-constant SIG_ATOMIC_MAX {promoted:__SIG_ATOMIC_TYPE__} >= 127
+macro-int-constant SIG_ATOMIC_MIN {size:__SIG_ATOMIC_WIDTH__}
+macro-int-constant SIG_ATOMIC_MAX {size:__SIG_ATOMIC_WIDTH__} >= 127
 
 macro-int-constant SIZE_MAX {promoted:__SIZE_TYPE__} >= 65535
 
diff --git a/csu/libc-tls.c b/csu/libc-tls.c
index bef92a75..74ad3cf6 100644
--- a/csu/libc-tls.c
+++ b/csu/libc-tls.c
@@ -186,15 +186,15 @@ __libc_setup_tls (void)
 #if TLS_TCB_AT_TP
   INSTALL_DTV ((char *) tlsblock + tcb_offset, _dl_static_dtv);
 
-  const char *lossage = TLS_INIT_TP ((char *) tlsblock + tcb_offset);
+  bool tlsinit = TLS_INIT_TP ((char *) tlsblock + tcb_offset);
 #elif TLS_DTV_AT_TP
   INSTALL_DTV (tlsblock, _dl_static_dtv);
-  const char *lossage = TLS_INIT_TP (tlsblock);
+  bool tlsinit = TLS_INIT_TP (tlsblock);
 #else
 # error "Either TLS_TCB_AT_TP or TLS_DTV_AT_TP must be defined"
 #endif
-  if (__builtin_expect (lossage != NULL, 0))
-    _startup_fatal (lossage);
+  if (__glibc_unlikely (!tlsinit))
+    _startup_fatal ("cannot set base address for thread-local storage");
   __tls_init_tp ();
 
   /* Update the executable's link map with enough information to make
diff --git a/ctype/ctype.c b/ctype/ctype.c
index 423c0a51..b83e1600 100644
--- a/ctype/ctype.c
+++ b/ctype/ctype.c
@@ -41,15 +41,17 @@ func (isxdigit, _ISxdigit)
   ((int32_t *) _NL_CURRENT (LC_CTYPE, _NL_CTYPE_TOUPPER) + 128)
 
 int
-tolower (int c)
+__tolower (int c)
 {
   return c >= -128 && c < 256 ? __ctype_tolower[c] : c;
 }
-libc_hidden_def (tolower)
+libc_hidden_def (__tolower)
+weak_alias (__tolower, tolower)
 
 int
-toupper (int c)
+__toupper (int c)
 {
   return c >= -128 && c < 256 ? __ctype_toupper[c] : c;
 }
-libc_hidden_def (toupper)
+libc_hidden_def (__toupper)
+weak_alias (__toupper, toupper)
diff --git a/debug/backtracesyms.c b/debug/backtracesyms.c
index 17e0626d..adb939f8 100644
--- a/debug/backtracesyms.c
+++ b/debug/backtracesyms.c
@@ -83,10 +83,10 @@ __backtrace_symbols (void *const *array, int size)
 		info[cnt].dli_saddr = info[cnt].dli_fbase;
 
 	      if (info[cnt].dli_sname == NULL && info[cnt].dli_saddr == 0)
-		last += 1 + sprintf (last, "%s(%s) [%p]",
-				     info[cnt].dli_fname ?: "",
-				     info[cnt].dli_sname ?: "",
-				     array[cnt]);
+		last += 1 + __sprintf (last, "%s(%s) [%p]",
+				       info[cnt].dli_fname ?: "",
+				       info[cnt].dli_sname ?: "",
+				       array[cnt]);
 	      else
 		{
 		  char sign;
@@ -102,14 +102,14 @@ __backtrace_symbols (void *const *array, int size)
 		      offset = info[cnt].dli_saddr - array[cnt];
 		    }
 
-		  last += 1 + sprintf (last, "%s(%s%c%#tx) [%p]",
-				       info[cnt].dli_fname ?: "",
-				       info[cnt].dli_sname ?: "",
-				       sign, offset, array[cnt]);
+		  last += 1 + __sprintf (last, "%s(%s%c%#tx) [%p]",
+					 info[cnt].dli_fname ?: "",
+					 info[cnt].dli_sname ?: "",
+					 sign, offset, array[cnt]);
 		}
 	    }
 	  else
-	    last += 1 + sprintf (last, "[%p]", array[cnt]);
+	    last += 1 + __sprintf (last, "[%p]", array[cnt]);
 	}
       assert (last <= (char *) result + size * sizeof (char *) + total);
     }
diff --git a/debug/confstr_chk.c b/debug/confstr_chk.c
index a73bdcdd..67823d66 100644
--- a/debug/confstr_chk.c
+++ b/debug/confstr_chk.c
@@ -24,5 +24,5 @@ __confstr_chk (int name, char *buf, size_t len, size_t buflen)
   if (__glibc_unlikely (buflen < len))
     __chk_fail ();
 
-  return confstr (name, buf, len);
+  return __confstr (name, buf, len);
 }
diff --git a/debug/tst-backtrace.h b/debug/tst-backtrace.h
index f79b267f..6c86005f 100644
--- a/debug/tst-backtrace.h
+++ b/debug/tst-backtrace.h
@@ -33,7 +33,7 @@ volatile int x;
 
 /* Use this attribute to prevent inlining, so that all expected frames
    are present.  */
-#define NO_INLINE __attribute__ ((noinline, noclone, weak))
+#define NO_INLINE __attribute__ ((noinline, weak)) __attribute_noclone__
 
 /* Look for a match in SYM from backtrace_symbols to NAME, a fragment
    of a function name.  Ignore the filename before '(', but presume
diff --git a/debug/tst-ssp-1.c b/debug/tst-ssp-1.c
index c2d1baa9..74a4403f 100644
--- a/debug/tst-ssp-1.c
+++ b/debug/tst-ssp-1.c
@@ -21,7 +21,7 @@
 #include <signal.h>
 
 static void
-__attribute__ ((noinline, noclone))
+__attribute__ ((noinline)) __attribute_noclone__
 test (char *foo)
 {
   int i;
diff --git a/dirent/Makefile b/dirent/Makefile
index b80f6a73..cfa61826 100644
--- a/dirent/Makefile
+++ b/dirent/Makefile
@@ -37,6 +37,7 @@ CFLAGS-scandir.c += $(uses-callbacks)
 CFLAGS-scandir64.c += $(uses-callbacks)
 CFLAGS-scandir-tail.c += $(uses-callbacks)
 CFLAGS-scandir64-tail.c += $(uses-callbacks)
+CFLAGS-dirfd.c += $(config-cflags-wno-ignored-attributes)
 
 include ../Rules
 
diff --git a/elf/Makefile b/elf/Makefile
index 5bdf0a38..f2bb03f0 100644
--- a/elf/Makefile
+++ b/elf/Makefile
@@ -453,8 +453,6 @@ tests += \
   tst-tls-ie \
   tst-tls-ie-dlmopen \
   tst-tls-manydynamic \
-  tst-unique1 \
-  tst-unique2 \
   tst-unwind-ctor \
   tst-unwind-main \
   unload3 \
@@ -465,12 +463,22 @@ tests += \
   unload8 \
   valgrind-test \
   # tests
+ifeq (yes,$(config-gnu-unique-object))
+tests += \
+  tst-unique1 \
+  tst-unique2 \
+  # tests
+endif
 tests-cxx = \
-  tst-dlopen-nodelete-reloc \
   tst-nodelete \
   tst-unique3 \
   tst-unique4 \
   # tests-cxx
+ifeq (yes,$(config-gnu-unique-object))
+tests-cxx += \
+  tst-dlopen-nodelete-reloc \
+  # tests-cxx
+endif
 
 tests += $(if $(CXX),$(tests-cxx))
 
@@ -515,7 +523,7 @@ endif
 selinux-enabled := $(shell cat /selinux/enforce 2> /dev/null)
 
 ifneq ($(selinux-enabled),1)
-tests-execstack-yes = \
+tests-execstack-yesyes = \
   tst-execstack \
   tst-execstack-needed \
   tst-execstack-prog \
@@ -546,7 +554,7 @@ $(objpfx)tst-valgrind-smoke.out: tst-valgrind-smoke.sh $(objpfx)ld.so $(objpfx)v
 	$(SHELL) $< $(objpfx)ld.so  $(rtlddir)/$(rtld-installed-name) '$(test-wrapper-env)' \
 		'$(run-program-env)' '$(rpath-link)' $(objpfx)valgrind-test > $@; $(evaluate-test)
 
-tests += $(tests-execstack-$(have-z-execstack))
+tests += $(tests-execstack-$(have-z-execstack)$(have-cc-trampoline))
 ifeq ($(run-built-tests),yes)
 tests-special += \
   $(objpfx)noload-mem.out \
@@ -818,10 +826,6 @@ modules-names = \
   tst-tlsmod7 \
   tst-tlsmod8 \
   tst-tlsmod9 \
-  tst-unique1mod1 \
-  tst-unique1mod2 \
-  tst-unique2mod1 \
-  tst-unique2mod2 \
   tst-unwind-ctor-lib \
   unload2dep \
   unload2mod \
@@ -847,8 +851,25 @@ modules-names = \
   vismod2 \
   vismod3 \
 # modules-names
+ifeq (yes,$(config-gnu-unique-object))
+modules-names += \
+  tst-unique1mod1 \
+  tst-unique1mod2 \
+  tst-unique2mod1 \
+  tst-unique2mod2 \
+# modules-names
+endif
 
 modules-names-cxx = \
+  tst-nodelete-rtldmod \
+  tst-nodelete-uniquemod \
+  tst-nodelete-zmod \
+  tst-unique3lib \
+  tst-unique3lib2 \
+  tst-unique4lib \
+  # modules-names-cxx
+ifeq (yes,$(config-gnu-unique-object))
+modules-names-cxx += \
   tst-dlopen-nodelete-reloc-mod1 \
   tst-dlopen-nodelete-reloc-mod10 \
   tst-dlopen-nodelete-reloc-mod11 \
@@ -866,17 +887,12 @@ modules-names-cxx = \
   tst-dlopen-nodelete-reloc-mod7 \
   tst-dlopen-nodelete-reloc-mod8 \
   tst-dlopen-nodelete-reloc-mod9 \
-  tst-nodelete-rtldmod \
-  tst-nodelete-uniquemod \
-  tst-nodelete-zmod \
-  tst-unique3lib \
-  tst-unique3lib2 \
-  tst-unique4lib \
   # modules-names-cxx
+endif
 
 modules-names += \
   $(if $(CXX),$(modules-names-cxx)) \
-  $(modules-execstack-$(have-z-execstack)) \
+  $(modules-execstack-$(have-z-execstack)$(have-cc-trampoline)) \
   $(tlsmod17a-modules) \
   $(tlsmod18a-modules) \
   $(tst-tls-many-dynamic-modules) \
@@ -937,7 +953,7 @@ tests-pie += vismain
 CFLAGS-vismain.c += $(PIE-ccflag)
 endif
 endif
-modules-execstack-yes = tst-execstack-mod
+modules-execstack-yesyes = tst-execstack-mod
 extra-test-objs += $(addsuffix .os,$(strip $(modules-names)))
 
 # filtmod1.so, tst-big-note-lib.so, tst-ro-dynamic-mod.so have special
@@ -1191,7 +1207,7 @@ $(objpfx)librtld.map: $(objpfx)dl-allobjs.os $(common-objpfx)libc_pic.a
 		echo ".globl $$symbol"; \
 		echo "$$symbol:"; \
 	done | $(CC) -o $@T.o $(ASFLAGS) -c -x assembler -
-	$(reloc-link) -o $@.o $@T.o '-Wl,-(' $^ -lgcc '-Wl,-)' -Wl,-Map,$@T
+	$(reloc-link) -o $@.o $@T.o "-Wl,-(" $^ `$(reloc-link) --print-libgcc-file-name` "-Wl,-)" -Wl,-Map,$@T
 	rm -f %@T.o $@.o
 	mv -f $@T $@
 
@@ -1221,7 +1237,7 @@ $(objpfx)rtld-libc.a: $(objpfx)librtld.mk FORCE
 	$(MAKE) -f $< -f rtld-Rules
 
 $(objpfx)librtld.os: $(objpfx)dl-allobjs.os $(objpfx)rtld-libc.a
-	$(LINK.o) -nostdlib -nostartfiles -r -o $@ '-Wl,-(' $^ -lgcc '-Wl,-)' \
+	$(LINK.o) -nostdlib -nostartfiles -r -o $@ "-Wl,-(" $^ `$(reloc-link) --print-libgcc-file-name` "-Wl,-)" \
 		  -Wl,-Map,$@.map
 
 generated += librtld.map librtld.mk rtld-libc.a librtld.os.map
@@ -1702,7 +1718,7 @@ $(objpfx)unload8.out: $(objpfx)unload8mod1.so $(objpfx)unload8mod1x.so
 
 $(objpfx)tst-tls9-static.out: $(objpfx)tst-tlsmod5.so $(objpfx)tst-tlsmod6.so
 
-ifeq ($(have-z-execstack),yes)
+ifeq ($(have-z-execstack)$(have-cc-trampoline),yesyes)
 $(objpfx)tst-execstack.out: $(objpfx)tst-execstack-mod.so
 CPPFLAGS-tst-execstack.c += -DUSE_PTHREADS=0
 LDFLAGS-tst-execstack = -Wl,-z,noexecstack
@@ -2224,9 +2240,7 @@ LDFLAGS-tst-audit24d = -Wl,-z,lazy
 
 $(objpfx)tst-audit25a.out: $(objpfx)tst-auditmod25.so
 $(objpfx)tst-audit25a: $(objpfx)tst-audit25mod1.so \
-		       $(objpfx)tst-audit25mod2.so \
-		       $(objpfx)tst-audit25mod3.so \
-		       $(objpfx)tst-audit25mod4.so
+		       $(objpfx)tst-audit25mod2.so
 LDFLAGS-tst-audit25a = -Wl,-z,lazy
 $(objpfx)tst-audit25mod1.so: $(objpfx)tst-audit25mod3.so
 LDFLAGS-tst-audit25mod1.so = -Wl,-z,now
diff --git a/elf/dl-debug.c b/elf/dl-debug.c
index 538468dc..31dccb08 100644
--- a/elf/dl-debug.c
+++ b/elf/dl-debug.c
@@ -54,7 +54,7 @@ _dl_debug_update (Lmid_t ns)
 struct r_debug *
 _dl_debug_initialize (ElfW(Addr) ldbase, Lmid_t ns)
 {
-  struct r_debug_extended *r, **pp = NULL;
+  struct r_debug_extended *r = NULL, **pp = NULL;
 
   if (ns == LM_ID_BASE)
     {
diff --git a/elf/dl-load.c b/elf/dl-load.c
index 5b0ff41e..c6ea1b5f 100644
--- a/elf/dl-load.c
+++ b/elf/dl-load.c
@@ -1396,7 +1396,7 @@ cannot enable executable stack as shared object requires");
 
   if (__glibc_unlikely (GLRO(dl_debug_mask) & DL_DEBUG_FILES))
     _dl_debug_printf ("\
-  dynamic: 0x%0*lx  base: 0x%0*lx   size: 0x%0*Zx\n\
+  dynamic: 0x%0*lx  base: 0x%0*lx   size: 0x%0*zx\n\
     entry: 0x%0*lx  phdr: 0x%0*lx  phnum:   %*u\n\n",
 			   (int) sizeof (void *) * 2,
 			   (unsigned long int) l->l_ld,
diff --git a/elf/dl-lookup.c b/elf/dl-lookup.c
index cbf46fda..d9dc4f12 100644
--- a/elf/dl-lookup.c
+++ b/elf/dl-lookup.c
@@ -1062,7 +1062,7 @@ _dl_debug_bindings (const char *undef_name, struct link_map *undef_map,
 	  || GLRO(dl_trace_prelink_map) == NULL
 	  || type_class >= 4)
 	{
-	  _dl_printf ("%s 0x%0*Zx 0x%0*Zx -> 0x%0*Zx 0x%0*Zx ",
+	  _dl_printf ("%s 0x%0*zx 0x%0*zx -> 0x%0*zx 0x%0*zx ",
 		      conflict ? "conflict" : "lookup",
 		      (int) sizeof (ElfW(Addr)) * 2,
 		      (size_t) undef_map->l_map_start,
@@ -1074,7 +1074,7 @@ _dl_debug_bindings (const char *undef_name, struct link_map *undef_map,
 		      (size_t) (value->s ? value->s->st_value : 0));
 
 	  if (conflict)
-	    _dl_printf ("x 0x%0*Zx 0x%0*Zx ",
+	    _dl_printf ("x 0x%0*zx 0x%0*zx ",
 			(int) sizeof (ElfW(Addr)) * 2,
 			(size_t) (val.s ? val.m->l_map_start : 0),
 			(int) sizeof (ElfW(Addr)) * 2,
diff --git a/elf/dl-printf.c b/elf/dl-printf.c
index d3264ba9..429d2e80 100644
--- a/elf/dl-printf.c
+++ b/elf/dl-printf.c
@@ -113,7 +113,7 @@ _dl_debug_vdprintf (int fd, int tag_p, const char *fmt, va_list arg)
 	  /* Recognize the l modifier.  It is only important on some
 	     platforms where long and int have a different size.  We
 	     can use the same code for size_t.  */
-	  if (*fmt == 'l' || *fmt == 'Z')
+	  if (*fmt == 'l' || *fmt == 'z')
 	    {
 #if LONG_MAX != INT_MAX
 	      long_mod = 1;
diff --git a/elf/dl-profile.c b/elf/dl-profile.c
index 9359be7c..f3859e36 100644
--- a/elf/dl-profile.c
+++ b/elf/dl-profile.c
@@ -548,7 +548,7 @@ _dl_mcount (ElfW(Addr) frompc, ElfW(Addr) selfpc)
 	      size_t newfromidx;
 	      to_index = (data[narcs].self_pc
 			  / (HASHFRACTION * sizeof (*tos)));
-	      newfromidx = catomic_exchange_and_add (&fromidx, 1) + 1;
+	      newfromidx = atomic_fetch_and_acquire (&fromidx, 1) + 1;
 	      froms[newfromidx].here = &data[narcs];
 	      froms[newfromidx].link = tos[to_index];
 	      tos[to_index] = newfromidx;
@@ -558,14 +558,14 @@ _dl_mcount (ElfW(Addr) frompc, ElfW(Addr) selfpc)
 	  /* If we still have no entry stop searching and insert.  */
 	  if (*topcindex == 0)
 	    {
-	      uint_fast32_t newarc = catomic_exchange_and_add (narcsp, 1);
+	      uint_fast32_t newarc = atomic_exchange_and_add (narcsp, 1);
 
 	      /* In rare cases it could happen that all entries in FROMS are
 		 occupied.  So we cannot count this anymore.  */
 	      if (newarc >= fromlimit)
 		goto done;
 
-	      *topcindex = catomic_exchange_and_add (&fromidx, 1) + 1;
+	      *topcindex = atomic_exchange_and_add (&fromidx, 1) + 1;
 	      fromp = &froms[*topcindex];
 
 	      fromp->here = &data[newarc];
@@ -573,7 +573,7 @@ _dl_mcount (ElfW(Addr) frompc, ElfW(Addr) selfpc)
 	      data[newarc].self_pc = selfpc;
 	      data[newarc].count = 0;
 	      fromp->link = 0;
-	      catomic_increment (&narcs);
+	      atomic_fetch_and_acquire (&narcs, 1);
 
 	      break;
 	    }
@@ -586,7 +586,7 @@ _dl_mcount (ElfW(Addr) frompc, ElfW(Addr) selfpc)
     }
 
   /* Increment the counter.  */
-  catomic_increment (&fromp->here->count);
+  atomic_fetch_and_acquire (&fromp->here->count, 1);
 
  done:
   ;
diff --git a/elf/dl-support.c b/elf/dl-support.c
index fb647655..9a5ba870 100644
--- a/elf/dl-support.c
+++ b/elf/dl-support.c
@@ -44,6 +44,7 @@
 #include <dl-vdso-setup.h>
 #include <dl-auxv.h>
 #include <dl-find_object.h>
+#include <dl-symbol-hacks.h>
 
 extern char *__progname;
 char **_dl_argv = &__progname;	/* This is checked for some error messages.  */
diff --git a/stdlib/bits/monetary-ldbl.h b/elf/dl-symbol-hacks.h
similarity index 64%
rename from stdlib/bits/monetary-ldbl.h
rename to elf/dl-symbol-hacks.h
index fff6704c..b8caccb5 100644
--- a/stdlib/bits/monetary-ldbl.h
+++ b/elf/dl-symbol-hacks.h
@@ -1,5 +1,5 @@
-/* -mlong-double-64 compatibility mode for monetary functions.
-   Copyright (C) 2006-2022 Free Software Foundation, Inc.
+/* Symbol rediretion for loader/static initialization code.
+   Copyright (C) 2022 Free Software Foundation, Inc.
    This file is part of the GNU C Library.
 
    The GNU C Library is free software; you can redistribute it and/or
@@ -16,12 +16,14 @@
    License along with the GNU C Library; if not, see
    <https://www.gnu.org/licenses/>.  */
 
-#ifndef _MONETARY_H
-# error "Never include <bits/monetary-ldbl.h> directly; use <monetary.h> instead."
-#endif
+#ifndef _DL_SYMBOL_HACKS_H
+#define _DL_SYMBOL_HACKS_H
 
-__LDBL_REDIR_DECL (strfmon)
+/* Some compiler optimizations may transform loops into memset/memmove
+   calls and without proper redirection it might call PLT throught
+   ifunc without relocations being processed.  */
+#ifndef SHARED
+asm ("memset = __memset_generic");
+#endif
 
-#ifdef __USE_GNU
-__LDBL_REDIR_DECL (strfmon_l)
 #endif
diff --git a/elf/dl-tls.c b/elf/dl-tls.c
index 093cdddb..5c80122c 100644
--- a/elf/dl-tls.c
+++ b/elf/dl-tls.c
@@ -75,6 +75,8 @@
 /* Default for dl_tls_static_optional.  */
 #define OPTIONAL_TLS 512
 
+#define TLS_DTV_UNALLOCATED ((void *) TLS_DTV_UNALLOCATED_VALUE)
+
 /* Compute the static TLS surplus based on the namespace count and the
    TLS space that can be used for optimizations.  */
 static inline int
diff --git a/elf/dl-tunables.c b/elf/dl-tunables.c
index 8e7ee9df..a3e399fd 100644
--- a/elf/dl-tunables.c
+++ b/elf/dl-tunables.c
@@ -380,7 +380,7 @@ __tunables_print (void)
 			  (long int) cur->type.max);
 	      break;
 	    case TUNABLE_TYPE_SIZE_T:
-	      _dl_printf ("0x%Zx (min: 0x%Zx, max: 0x%Zx)\n",
+	      _dl_printf ("0x%zx (min: 0x%zx, max: 0x%zx)\n",
 			  (size_t) cur->val.numval,
 			  (size_t) cur->type.min,
 			  (size_t) cur->type.max);
diff --git a/elf/rtld.c b/elf/rtld.c
index 8dafaf61..256fe096 100644
--- a/elf/rtld.c
+++ b/elf/rtld.c
@@ -815,9 +815,8 @@ cannot allocate TLS data structures for initial thread\n");
   GL(dl_initial_dtv) = GET_DTV (tcbp);
 
   /* And finally install it for the main thread.  */
-  const char *lossage = TLS_INIT_TP (tcbp);
-  if (__glibc_unlikely (lossage != NULL))
-    _dl_fatal_printf ("cannot set up thread-local storage: %s\n", lossage);
+  if (__glibc_unlikely (!TLS_INIT_TP (tcbp)))
+    _dl_fatal_printf ("cannot set up thread-local storage\n");
   __tls_init_tp ();
   tls_init_tp_called = true;
 
@@ -2069,7 +2068,7 @@ dl_main (const ElfW(Phdr) *phdr,
 		}
 	      if (_dl_name_match_p (GLRO(dl_trace_prelink), l))
 		GLRO(dl_trace_prelink_map) = l;
-	      _dl_printf ("\t%s => %s (0x%0*Zx, 0x%0*Zx)",
+	      _dl_printf ("\t%s => %s (0x%0*zx, 0x%0*zx)",
 			  DSO_FILENAME (l->l_libname->name),
 			  DSO_FILENAME (l->l_name),
 			  (int) sizeof l->l_map_start * 2,
@@ -2078,7 +2077,7 @@ dl_main (const ElfW(Phdr) *phdr,
 			  (size_t) l->l_addr);
 
 	      if (l->l_tls_modid)
-		_dl_printf (" TLS(0x%Zx, 0x%0*Zx)\n", l->l_tls_modid,
+		_dl_printf (" TLS(0x%zx, 0x%0*zx)\n", l->l_tls_modid,
 			    (int) sizeof l->l_tls_offset * 2,
 			    (size_t) l->l_tls_offset);
 	      else
@@ -2140,11 +2139,11 @@ dl_main (const ElfW(Phdr) *phdr,
 	      /* The library was not found.  */
 	      _dl_printf ("\t%s => not found\n", l->l_libname->name);
 	    else if (strcmp (l->l_libname->name, l->l_name) == 0)
-	      _dl_printf ("\t%s (0x%0*Zx)\n", l->l_libname->name,
+	      _dl_printf ("\t%s (0x%0*zx)\n", l->l_libname->name,
 			  (int) sizeof l->l_map_start * 2,
 			  (size_t) l->l_map_start);
 	    else
-	      _dl_printf ("\t%s => %s (0x%0*Zx)\n", l->l_libname->name,
+	      _dl_printf ("\t%s => %s (0x%0*zx)\n", l->l_libname->name,
 			  l->l_name, (int) sizeof l->l_map_start * 2,
 			  (size_t) l->l_map_start);
 	}
@@ -2163,7 +2162,7 @@ dl_main (const ElfW(Phdr) *phdr,
 
 	    loadbase = LOOKUP_VALUE_ADDRESS (result, false);
 
-	    _dl_printf ("%s found at 0x%0*Zd in object at 0x%0*Zd\n",
+	    _dl_printf ("%s found at 0x%0*zd in object at 0x%0*zd\n",
 			_dl_argv[i],
 			(int) sizeof ref->st_value * 2,
 			(size_t) ref->st_value,
@@ -2468,10 +2467,8 @@ dl_main (const ElfW(Phdr) *phdr,
   /* And finally install it for the main thread.  */
   if (! tls_init_tp_called)
     {
-      const char *lossage = TLS_INIT_TP (tcbp);
-      if (__glibc_unlikely (lossage != NULL))
-	_dl_fatal_printf ("cannot set up thread-local storage: %s\n",
-			  lossage);
+      if (__glibc_unlikely (!TLS_INIT_TP (tcbp)))
+	_dl_fatal_printf ("cannot set up thread-local storage\n");
       __tls_init_tp ();
     }
 
@@ -2657,10 +2654,16 @@ warning: debug option `%s' unknown; try LD_DEBUG=help\n", copy);
       _dl_printf ("\
 Valid options for the LD_DEBUG environment variable are:\n\n");
 
+      /* clang issues an warning adding 'const unsigned char' to a string
+	 does not append to the string, however it is exactly what code
+	 means here.  */
+      DIAG_PUSH_NEEDS_COMMENT_CLANG;
+      DIAG_IGNORE_NEEDS_COMMENT_CLANG (13, "-Wstring-plus-int");
       for (cnt = 0; cnt < ndebopts; ++cnt)
 	_dl_printf ("  %.*s%s%s\n", debopts[cnt].len, debopts[cnt].name,
 		    "         " + debopts[cnt].len - 3,
 		    debopts[cnt].helptext);
+      DIAG_POP_NEEDS_COMMENT_CLANG;
 
       _dl_printf ("\n\
 To direct the debugging output into a file instead of standard output\n\
diff --git a/elf/sprof.c b/elf/sprof.c
index 405fbcbf..da7d817b 100644
--- a/elf/sprof.c
+++ b/elf/sprof.c
@@ -476,7 +476,7 @@ load_shobj (const char *name)
   result->kcountsize = textsize / HISTFRACTION;
   result->hashfraction = HASHFRACTION;
   if (do_test)
-    printf ("hashfraction = %d\ndivider = %Zu\n",
+    printf ("hashfraction = %d\ndivider = %zu\n",
 	    result->hashfraction,
 	    result->hashfraction * sizeof (struct here_fromstruct));
   result->tossize = textsize / HASHFRACTION;
@@ -495,7 +495,7 @@ load_shobj (const char *name)
 			      * sizeof (struct here_cg_arc_record)));
 
   if (do_test)
-    printf ("expected size: %Zd\n", result->expected_size);
+    printf ("expected size: %zd\n", result->expected_size);
 
 #define SCALE_1_TO_1	0x10000L
 
@@ -1357,15 +1357,15 @@ generate_call_graph (struct profdata *profdata)
 		     ? sortsym[runp->idx]->name : "<UNKNOWN>"));
 
 	    if (runp->idx != (size_t) -1l)
-	      printf (" [%Zd]", runp->idx);
+	      printf (" [%zd]", runp->idx);
 	    putchar_unlocked ('\n');
 
 	    runp = runp->next;
 	  }
 
 	/* Info about the function itself.  */
-	n = printf ("[%Zu]", cnt);
-	printf ("%*s%5.1f%8.2f%8.2f%9" PRIdMAX "         %s [%Zd]\n",
+	n = printf ("[%zu]", cnt);
+	printf ("%*s%5.1f%8.2f%8.2f%9" PRIdMAX "         %s [%zd]\n",
 		(int) (7 - n), " ",
 		total_ticks ? (100.0 * sortsym[cnt]->ticks) / total_ticks : 0,
 		sortsym[cnt]->ticks * tick_unit,
@@ -1384,7 +1384,7 @@ generate_call_graph (struct profdata *profdata)
 		    runp->count);
 
 	    if (runp->idx != (size_t) -1l)
-	      printf ("%-9" PRIdMAX "   %s [%Zd]\n",
+	      printf ("%-9" PRIdMAX "   %s [%zd]\n",
 		      sortsym[runp->idx]->calls,
 		      sortsym[runp->idx]->name,
 		      runp->idx);
diff --git a/elf/tst-audit25.h b/elf/tst-audit25.h
new file mode 100644
index 00000000..489d0de5
--- /dev/null
+++ b/elf/tst-audit25.h
@@ -0,0 +1,66 @@
+/* Check LD_AUDIT and LD_BIND_NOW.
+   Copyright (C) 2022 Free Software Foundation, Inc.
+   This file is part of the GNU C Library.
+
+   The GNU C Library is free software; you can redistribute it and/or
+   modify it under the terms of the GNU Lesser General Public
+   License as published by the Free Software Foundation; either
+   version 2.1 of the License, or (at your option) any later version.
+
+   The GNU C Library is distributed in the hope that it will be useful,
+   but WITHOUT ANY WARRANTY; without even the implied warranty of
+   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+   Lesser General Public License for more details.
+
+   You should have received a copy of the GNU Lesser General Public
+   License along with the GNU C Library; if not, see
+   <https://www.gnu.org/licenses/>.  */
+
+#ifndef _TEST_AUDIT25_H
+#define _TEST_AUDIT25_H
+
+#include <string.h>
+#include <support/check.h>
+#include <support/xstdio.h>
+
+/* Check if every line in EXPECTED is presented only once on BUFFER
+   with size of LEN.  */
+static void
+check_output (char *buffer, size_t len, const char *expected[],
+	      size_t expected_len)
+{
+  FILE *f = fmemopen (buffer, len, "r");
+  TEST_VERIFY (f != NULL);
+
+  bool found[expected_len];
+  for (size_t i = 0; i < expected_len; i++)
+    found[i] = false;
+
+  char *line = NULL;
+  size_t linelen = 0;
+  while (xgetline (&line, &linelen, f))
+    {
+      for (size_t i = 0; i < expected_len; i++)
+	if (strcmp (line, expected[i]) == 0)
+	  {
+	    if (found[i] != false)
+	      {
+		support_record_failure ();
+		printf ("error: duplicated line %s\n", expected[i]);
+	      }
+	    TEST_COMPARE (found[i], false);
+	    found[i] = true;
+	  }
+    }
+
+  for (size_t i = 0; i < expected_len; i++)
+    if (found[i] == false)
+      {
+	support_record_failure ();
+	printf ("error: %s not present in output\n", expected[i]);
+      }
+
+  xfclose (f);
+}
+
+#endif
diff --git a/elf/tst-audit25a.c b/elf/tst-audit25a.c
index 49173e86..36c6c4ee 100644
--- a/elf/tst-audit25a.c
+++ b/elf/tst-audit25a.c
@@ -17,17 +17,11 @@
    <https://www.gnu.org/licenses/>.  */
 
 #include <array_length.h>
-#include <errno.h>
 #include <getopt.h>
-#include <limits.h>
-#include <inttypes.h>
-#include <string.h>
 #include <stdlib.h>
 #include <support/capture_subprocess.h>
-#include <support/check.h>
-#include <support/xstdio.h>
 #include <support/support.h>
-#include <sys/auxv.h>
+#include <tst-audit25.h>
 
 static int restart;
 #define CMDLINE_OPTIONS \
@@ -90,13 +84,17 @@ do_test (int argc, char *argv[])
     /* tst-audit25a is build with -Wl,-z,lazy and tst-audit25mod1 with
        -Wl,-z,now; so only tst_audit25mod3_func1 should be expected to
        have LA_SYMB_NOPLTENTER | LA_SYMB_NOPLTEXIT.  */
-    TEST_COMPARE_STRING (result.err.buffer,
-			 "la_symbind: tst_audit25mod3_func1 1\n"
-			 "la_symbind: tst_audit25mod1_func1 0\n"
-			 "la_symbind: tst_audit25mod1_func2 0\n"
-			 "la_symbind: tst_audit25mod2_func1 0\n"
-			 "la_symbind: tst_audit25mod4_func1 0\n"
-			 "la_symbind: tst_audit25mod2_func2 0\n");
+    const char *expected[] = {
+      "la_symbind: tst_audit25mod3_func1 1\n",
+      "la_symbind: tst_audit25mod1_func1 0\n",
+      "la_symbind: tst_audit25mod1_func2 0\n",
+      "la_symbind: tst_audit25mod2_func1 0\n",
+      "la_symbind: tst_audit25mod4_func1 0\n",
+      "la_symbind: tst_audit25mod2_func2 0\n"
+    };
+
+    check_output (result.err.buffer, result.err.length,
+		  expected, array_length (expected));
 
     support_capture_subprocess_free (&result);
   }
@@ -109,15 +107,17 @@ do_test (int argc, char *argv[])
 				      sc_allow_stderr);
 
     /* With LD_BIND_NOW all symbols are expected to have
-       LA_SYMB_NOPLTENTER | LA_SYMB_NOPLTEXIT.  Also the resolution
-       order is done in breadth-first order.  */
-    TEST_COMPARE_STRING (result.err.buffer,
-			 "la_symbind: tst_audit25mod4_func1 1\n"
-			 "la_symbind: tst_audit25mod3_func1 1\n"
-			 "la_symbind: tst_audit25mod1_func1 1\n"
-			 "la_symbind: tst_audit25mod2_func1 1\n"
-			 "la_symbind: tst_audit25mod1_func2 1\n"
-			 "la_symbind: tst_audit25mod2_func2 1\n");
+       LA_SYMB_NOPLTENTER | LA_SYMB_NOPLTEXIT.  */
+    const char *expected[] = {
+      "la_symbind: tst_audit25mod4_func1 1\n",
+      "la_symbind: tst_audit25mod3_func1 1\n",
+      "la_symbind: tst_audit25mod1_func1 1\n",
+      "la_symbind: tst_audit25mod2_func1 1\n",
+      "la_symbind: tst_audit25mod1_func2 1\n",
+      "la_symbind: tst_audit25mod2_func2 1\n"
+    };
+    check_output (result.err.buffer, result.err.length,
+		  expected, array_length (expected));
 
     support_capture_subprocess_free (&result);
   }
diff --git a/elf/tst-audit25b.c b/elf/tst-audit25b.c
index a56638d5..b621d12c 100644
--- a/elf/tst-audit25b.c
+++ b/elf/tst-audit25b.c
@@ -16,17 +16,12 @@
    License along with the GNU C Library; if not, see
    <https://www.gnu.org/licenses/>.  */
 
-#include <errno.h>
+#include <array_length.h>
 #include <getopt.h>
-#include <limits.h>
-#include <inttypes.h>
-#include <string.h>
 #include <stdlib.h>
 #include <support/capture_subprocess.h>
-#include <support/check.h>
-#include <support/xstdio.h>
 #include <support/support.h>
-#include <sys/auxv.h>
+#include <tst-audit25.h>
 
 static int restart;
 #define CMDLINE_OPTIONS \
@@ -89,13 +84,17 @@ do_test (int argc, char *argv[])
        tst-audit25mod2 is built with -Wl,-z,lazy.  So only
        tst_audit25mod4_func1 (called by tst_audit25mod2_func1) should not
        have LA_SYMB_NOPLTENTER | LA_SYMB_NOPLTEXIT.  */
-    TEST_COMPARE_STRING (result.err.buffer,
-			 "la_symbind: tst_audit25mod3_func1 1\n"
-			 "la_symbind: tst_audit25mod1_func1 1\n"
-			 "la_symbind: tst_audit25mod2_func1 1\n"
-			 "la_symbind: tst_audit25mod1_func2 1\n"
-			 "la_symbind: tst_audit25mod2_func2 1\n"
-			 "la_symbind: tst_audit25mod4_func1 0\n");
+    const char *expected[] = {
+       "la_symbind: tst_audit25mod3_func1 1\n",
+       "la_symbind: tst_audit25mod1_func1 1\n",
+       "la_symbind: tst_audit25mod2_func1 1\n",
+       "la_symbind: tst_audit25mod1_func2 1\n",
+       "la_symbind: tst_audit25mod2_func2 1\n",
+       "la_symbind: tst_audit25mod4_func1 0\n"
+    };
+
+    check_output (result.err.buffer, result.err.length,
+		  expected, array_length (expected));
 
     support_capture_subprocess_free (&result);
   }
@@ -108,15 +107,18 @@ do_test (int argc, char *argv[])
 				      sc_allow_stderr);
 
     /* With LD_BIND_NOW all symbols are expected to have
-       LA_SYMB_NOPLTENTER | LA_SYMB_NOPLTEXIT.  Also the resolution
-       order is done in breadth-first order.  */
-    TEST_COMPARE_STRING (result.err.buffer,
-			 "la_symbind: tst_audit25mod4_func1 1\n"
-			 "la_symbind: tst_audit25mod3_func1 1\n"
-			 "la_symbind: tst_audit25mod1_func1 1\n"
-			 "la_symbind: tst_audit25mod2_func1 1\n"
-			 "la_symbind: tst_audit25mod1_func2 1\n"
-			 "la_symbind: tst_audit25mod2_func2 1\n");
+       LA_SYMB_NOPLTENTER | LA_SYMB_NOPLTEXIT.  */
+    const char *expected[] = {
+      "la_symbind: tst_audit25mod4_func1 1\n",
+      "la_symbind: tst_audit25mod3_func1 1\n",
+      "la_symbind: tst_audit25mod1_func1 1\n",
+      "la_symbind: tst_audit25mod2_func1 1\n",
+      "la_symbind: tst_audit25mod1_func2 1\n",
+      "la_symbind: tst_audit25mod2_func2 1\n"
+    };
+
+    check_output (result.err.buffer, result.err.length,
+		  expected, array_length (expected));
 
     support_capture_subprocess_free (&result);
   }
diff --git a/elf/tst-dlmodcount.c b/elf/tst-dlmodcount.c
index 8a96803d..d5f89b8f 100644
--- a/elf/tst-dlmodcount.c
+++ b/elf/tst-dlmodcount.c
@@ -32,7 +32,7 @@ callback (struct dl_phdr_info *info, size_t size, void *ptr)
   static int last_adds = 0, last_subs = 0;
   intptr_t cmd = (intptr_t) ptr;
 
-  printf ("  size = %Zu\n", size);
+  printf ("  size = %zu\n", size);
   if (size < (offsetof (struct dl_phdr_info, dlpi_subs)
 	      + sizeof (info->dlpi_subs)))
     {
diff --git a/elf/tst-p_alignmod-base.c b/elf/tst-p_alignmod-base.c
index 0fc1b755..4aae5f1e 100644
--- a/elf/tst-p_alignmod-base.c
+++ b/elf/tst-p_alignmod-base.c
@@ -26,7 +26,7 @@
 int foo __attribute__ ((aligned (ALIGN))) = 1;
 
 bool
-__attribute__ ((weak, noclone, noinline))
+__attribute__ ((weak, noinline)) __attribute_noclone__
 is_aligned_p (void *p, int align)
 {
   return (((uintptr_t) p) & (align - 1)) == 0;
diff --git a/elf/tst-ptrguard1.c b/elf/tst-ptrguard1.c
index dffcb5a8..9faceaf5 100644
--- a/elf/tst-ptrguard1.c
+++ b/elf/tst-ptrguard1.c
@@ -22,6 +22,8 @@
 #include <string.h>
 #include <sys/wait.h>
 #include <stackguard-macros.h>
+#undef attribute_relro
+#define attribute_relro
 #include <tls.h>
 #include <unistd.h>
 
diff --git a/elf/tst-stackguard1.c b/elf/tst-stackguard1.c
index 05078431..b6cc490d 100644
--- a/elf/tst-stackguard1.c
+++ b/elf/tst-stackguard1.c
@@ -23,6 +23,8 @@
 #include <string.h>
 #include <sys/wait.h>
 #include <stackguard-macros.h>
+#undef attribute_relro
+#define attribute_relro
 #include <tls.h>
 #include <unistd.h>
 
diff --git a/elf/tst-tls-dlinfo.c b/elf/tst-tls-dlinfo.c
index 7d2b42e2..6d032bdc 100644
--- a/elf/tst-tls-dlinfo.c
+++ b/elf/tst-tls-dlinfo.c
@@ -33,7 +33,7 @@ do_test (void)
       result = 1;
     }
   else
-    printf ("dlinfo says TLS module ID %Zu\n", modid);
+    printf ("dlinfo says TLS module ID %zu\n", modid);
 
   void *block;
   if (dlinfo (h, RTLD_DI_TLS_DATA, &block))
diff --git a/elf/tst-unique3.cc b/elf/tst-unique3.cc
index efdd6d78..d07601fe 100644
--- a/elf/tst-unique3.cc
+++ b/elf/tst-unique3.cc
@@ -1,9 +1,14 @@
-#include "tst-unique3.h"
-
 #include <cstdio>
-#include "../dlfcn/dlfcn.h"
+#include <dlfcn.h>
+#include <libc-diag.h>
+#include "tst-unique3.h"
 
+/* clang warns that the instatiation of the variable is required, but no
+   definition is available.  They are implemented on tst-unique3lib.so.  */
+DIAG_PUSH_NEEDS_COMMENT_CLANG;
+DIAG_IGNORE_NEEDS_COMMENT_CLANG (13, "-Wundefined-var-template");
 int t = S<char>::i;
+DIAG_POP_NEEDS_COMMENT_CLANG;
 
 int
 main (void)
diff --git a/elf/tst-unique4.cc b/elf/tst-unique4.cc
index 575c70d3..ab727b8d 100644
--- a/elf/tst-unique4.cc
+++ b/elf/tst-unique4.cc
@@ -2,7 +2,12 @@
 #include "tst-unique4.h"
 
 #include <cstdio>
+#include <libc-diag.h>
 
+/* clang warns that the instatiation of the variable is required, but no
+   definition is available.  They are implemented on tst-unique4lib.so.  */
+DIAG_PUSH_NEEDS_COMMENT_CLANG;
+DIAG_IGNORE_NEEDS_COMMENT_CLANG (13, "-Wundefined-var-template");
 static int a[24] =
   {
     S<1>::i, S<2>::i, S<3>::i, S<4>::i, S<5>::i, S<6>::i, S<7>::i, S<8>::i,
@@ -10,6 +15,7 @@ static int a[24] =
     S<16>::i, S<17>::i, S<18>::i, S<19>::i, S<20>::i, S<21>::i, S<22>::i,
     S<23>::i, S<24>::i
   };
+DIAG_POP_NEEDS_COMMENT_CLANG;
 
 int
 main (void)
diff --git a/elf/tst-unique4lib.cc b/elf/tst-unique4lib.cc
index 17a7cdf5..2829e75c 100644
--- a/elf/tst-unique4lib.cc
+++ b/elf/tst-unique4lib.cc
@@ -2,7 +2,7 @@
 #include "tst-unique4.h"
 
 template<int N>
-int S<N>::i = N;
+int S<N>::i __attribute__ ((used)) = N;
 template<int N>
 const int S<N>::j __attribute__ ((used)) = -1;
 
diff --git a/elf/unload4.c b/elf/unload4.c
index 6e171a22..8d3bb89c 100644
--- a/elf/unload4.c
+++ b/elf/unload4.c
@@ -2,8 +2,8 @@
 #include <stdio.h>
 #include <malloc.h>
 
-int
-main (void)
+static int
+do_test (void)
 {
 #ifdef M_PERTURB
   mallopt (M_PERTURB, 0xaa);
@@ -46,3 +46,5 @@ main (void)
   dlclose (h);
   return 0;
 }
+
+#include <support/test-driver.c>
diff --git a/gmon/tst-gmon.c b/gmon/tst-gmon.c
index aca59215..72a80a62 100644
--- a/gmon/tst-gmon.c
+++ b/gmon/tst-gmon.c
@@ -16,15 +16,17 @@
    License along with the GNU C Library; if not, see
    <https://www.gnu.org/licenses/>.  */
 
+#include <sys/cdefs.h>
+
 /* This program does not use the test harness because we want tight
    control over the call graph.  */
 
-__attribute__ ((noinline, noclone, weak)) void
+__attribute__ ((noinline, weak)) __attribute_noclone__ void
 f1 (void)
 {
 }
 
-__attribute__ ((noinline, noclone, weak)) void
+__attribute__ ((noinline, weak)) __attribute_noclone__ void
 f2 (void)
 {
   f1 ();
@@ -32,7 +34,7 @@ f2 (void)
   asm volatile ("");
 }
 
-__attribute__ ((noinline, noclone, weak)) void
+__attribute__ ((noinline, weak)) __attribute_noclone__ void
 f3 (int count)
 {
   for (int i = 0; i < count; ++i)
diff --git a/gmon/tst-sprofil.c b/gmon/tst-sprofil.c
index a927e737..de5a4e51 100644
--- a/gmon/tst-sprofil.c
+++ b/gmon/tst-sprofil.c
@@ -161,7 +161,7 @@ main (int argc, char **argv)
   for (i = 0; i < NELEMS (taddr); ++i)
     for (j = 0; j < 0x10000 / sizeof (int); ++j)
       if (buf[i][j] != 0)
-	printf ("%0*Zx\t%u\t(buffer %d)\n",
+	printf ("%0*zx\t%u\t(buffer %d)\n",
 		(int) (sizeof (size_t) * 2),
 		(taddr[i] + ((char *) &buf[i][j] - (char *) &buf[i][0])),
 		buf[i][j], i);
diff --git a/grp/putgrent.c b/grp/putgrent.c
index 966ba2a7..c16c08f9 100644
--- a/grp/putgrent.c
+++ b/grp/putgrent.c
@@ -45,10 +45,10 @@ putgrent (const struct group *gr, FILE *stream)
   flockfile (stream);
 
   if (gr->gr_name[0] == '+' || gr->gr_name[0] == '-')
-    retval = fprintf (stream, "%s:%s::",
+    retval = __fprintf (stream, "%s:%s::",
 		      gr->gr_name, _S (gr->gr_passwd));
   else
-    retval = fprintf (stream, "%s:%s:%lu:",
+    retval = __fprintf (stream, "%s:%s:%lu:",
 		      gr->gr_name, _S (gr->gr_passwd),
 		      (unsigned long int) gr->gr_gid);
   if (__builtin_expect (retval, 0) < 0)
@@ -60,7 +60,7 @@ putgrent (const struct group *gr, FILE *stream)
   if (gr->gr_mem != NULL)
     {
       for (size_t i = 0; gr->gr_mem[i] != NULL; i++)
-	if (fprintf (stream, i == 0 ? "%s" : ",%s", gr->gr_mem[i]) < 0)
+	if (__fprintf (stream, i == 0 ? "%s" : ",%s", gr->gr_mem[i]) < 0)
 	  {
 	    /* What else can we do?  */
 	    funlockfile (stream);
@@ -68,7 +68,7 @@ putgrent (const struct group *gr, FILE *stream)
 	  }
     }
 
-  retval = fputc_unlocked ('\n', stream);
+  retval = __fputc_unlocked ('\n', stream);
 
   funlockfile (stream);
 
diff --git a/gshadow/putsgent.c b/gshadow/putsgent.c
index 9e2dca7e..e0ae4181 100644
--- a/gshadow/putsgent.c
+++ b/gshadow/putsgent.c
@@ -42,7 +42,7 @@ putsgent (const struct sgrp *g, FILE *stream)
 
   _IO_flockfile (stream);
 
-  if (fprintf (stream, "%s:%s:", g->sg_namp, _S (g->sg_passwd)) < 0)
+  if (__fprintf (stream, "%s:%s:", g->sg_namp, _S (g->sg_passwd)) < 0)
     ++errors;
 
   bool first = true;
@@ -50,14 +50,14 @@ putsgent (const struct sgrp *g, FILE *stream)
   if (sp != NULL)
     while (*sp != NULL)
       {
-	if (fprintf (stream, "%s%s", first ? "" : ",", *sp++) < 0)
+	if (__fprintf (stream, "%s%s", first ? "" : ",", *sp++) < 0)
 	  {
 	    ++errors;
 	    break;
 	  }
 	first = false;
       }
-  if (putc_unlocked (':', stream) == EOF)
+  if (__putc_unlocked (':', stream) == EOF)
     ++errors;
 
   first = true;
@@ -65,14 +65,14 @@ putsgent (const struct sgrp *g, FILE *stream)
   if (sp != NULL)
     while (*sp != NULL)
       {
-	if (fprintf (stream, "%s%s", first ? "" : ",", *sp++) < 0)
+	if (__fprintf (stream, "%s%s", first ? "" : ",", *sp++) < 0)
 	  {
 	    ++errors;
 	    break;
 	  }
 	first = false;
       }
-  if (putc_unlocked ('\n', stream) == EOF)
+  if (__putc_unlocked ('\n', stream) == EOF)
     ++errors;
 
   _IO_funlockfile (stream);
diff --git a/hurd/hurdsig.c b/hurd/hurdsig.c
index 2c7ea61c..5f2ebd3a 100644
--- a/hurd/hurdsig.c
+++ b/hurd/hurdsig.c
@@ -374,7 +374,7 @@ interrupted_reply_port_location (thread_t thread,
   /* GCC 6 and before seem to be confused by the setjmp call inside
      _hurdsig_catch_memory_fault and think that we may be returning a second
      time to here with portloc uninitialized (but we never do). */
-  DIAG_IGNORE_NEEDS_COMMENT (6, "-Wmaybe-uninitialized");
+  DIAG_IGNORE_NEEDS_COMMENT_GCC (6, "-Wmaybe-uninitialized");
   /* Fault now if this pointer is bogus.  */
   *(volatile mach_port_t *) portloc = *portloc;
   DIAG_POP_NEEDS_COMMENT;
diff --git a/iconv/gconv_conf.c b/iconv/gconv_conf.c
index f069e283..989ccc47 100644
--- a/iconv/gconv_conf.c
+++ b/iconv/gconv_conf.c
@@ -290,7 +290,7 @@ add_module (char *rp, const char *directory, size_t dir_len, int modcounter)
       char *endp;
 
       *wp++ = '\0';
-      cost_hi = strtol (rp, &endp, 10);
+      cost_hi = __strtol (rp, &endp, 10);
       if (rp == endp || cost_hi < 1)
 	/* No useful information.  */
 	cost_hi = 1;
diff --git a/iconv/gconv_parseconfdir.h b/iconv/gconv_parseconfdir.h
index c0de5488..b8e174ed 100644
--- a/iconv/gconv_parseconfdir.h
+++ b/iconv/gconv_parseconfdir.h
@@ -23,7 +23,7 @@
 
 #if IS_IN (libc)
 # include <libio/libioP.h>
-# define __getdelim(line, len, c, fp) __getdelim (line, len, c, fp)
+# define __getdelim(line, len, c, fp) __libc_getdelim (line, len, c, fp)
 
 # undef isspace
 # define isspace(__c) __isspace_l ((__c), _nl_C_locobj_ptr)
diff --git a/iconv/iconv_charmap.c b/iconv/iconv_charmap.c
index 1992937d..98c76498 100644
--- a/iconv/iconv_charmap.c
+++ b/iconv/iconv_charmap.c
@@ -440,7 +440,7 @@ process_block (struct convtable *tbl, char *addr, size_t len, FILE *output)
 	       ignoring errors.  Otherwise punt.  */
 	    if (! omit_invalid)
 	      {
-		error (0, 0, _("illegal input sequence at position %Zd"), n);
+		error (0, 0, _("illegal input sequence at position %zd"), n);
 		return -1;
 	      }
 
diff --git a/iconvdata/gbk.c b/iconvdata/gbk.c
index 97717181..de910b3d 100644
--- a/iconvdata/gbk.c
+++ b/iconvdata/gbk.c
@@ -13212,6 +13212,10 @@ static const char __gbk_from_ucs4_tab12[][2] =
   }
 #include <iconv/loop.c>
 
+/* clang issues an warning adding 'unsigned int' to a string does not append
+   to the string, however it is exactly what code means here.  */
+DIAG_PUSH_NEEDS_COMMENT_CLANG;
+DIAG_IGNORE_NEEDS_COMMENT_CLANG (13, "-Wstring-plus-int");
 
 /* Next, define the other direction.  */
 #define MIN_NEEDED_INPUT	MIN_NEEDED_TO
@@ -13493,6 +13497,7 @@ static const char __gbk_from_ucs4_tab12[][2] =
 #define LOOP_NEED_FLAGS
 #include <iconv/loop.c>
 
+DIAG_POP_NEEDS_COMMENT_CLANG;
 
 /* Now define the toplevel functions.  */
 #include <iconv/skeleton.c>
diff --git a/iconvdata/ibm1008.h b/iconvdata/ibm1008.h
index 7976ced6..a4175be2 100644
--- a/iconvdata/ibm1008.h
+++ b/iconvdata/ibm1008.h
@@ -88,16 +88,16 @@ static const uint32_t to_ucs4[256] =
 
 static const struct gap from_idx[] =
 {
-  { start: 0x0000, end: 0x00ad, idx:     0 },
-  { start: 0x00d7, end: 0x00d7, idx:   -41 },
-  { start: 0x00f7, end: 0x00f7, idx:   -72 },
-  { start: 0x060c, end: 0x060c, idx: -1372 },
-  { start: 0x061b, end: 0x064a, idx: -1386 },
-  { start: 0x0651, end: 0x0651, idx: -1392 },
-  { start: 0x0660, end: 0x066d, idx: -1406 },
-  { start: 0xf8f4, end: 0xf8fc, idx: -63492 },
-  { start: 0xfe7c, end: 0xfefc, idx: -64899 },
-  { start: 0xffff, end: 0xffff, idx:     0 }
+  { .start = 0x0000, .end = 0x00ad, .idx =     0 },
+  { .start = 0x00d7, .end = 0x00d7, .idx =   -41 },
+  { .start = 0x00f7, .end = 0x00f7, .idx =   -72 },
+  { .start = 0x060c, .end = 0x060c, .idx = -1372 },
+  { .start = 0x061b, .end = 0x064a, .idx = -1386 },
+  { .start = 0x0651, .end = 0x0651, .idx = -1392 },
+  { .start = 0x0660, .end = 0x066d, .idx = -1406 },
+  { .start = 0xf8f4, .end = 0xf8fc, .idx = -63492 },
+  { .start = 0xfe7c, .end = 0xfefc, .idx = -64899 },
+  { .start = 0xffff, .end = 0xffff, .idx =     0 }
 };
 
 static const char from_ucs4[] =
diff --git a/iconvdata/ibm1025.h b/iconvdata/ibm1025.h
index c5d118e2..42f92a51 100644
--- a/iconvdata/ibm1025.h
+++ b/iconvdata/ibm1025.h
@@ -88,11 +88,11 @@ static const uint32_t to_ucs4[256] =
 
 static const struct gap from_idx[] =
 {
-  { start: 0x0000, end: 0x00a0, idx:     0 },
-  { start: 0x00a7, end: 0x00ad, idx:    -6 },
-  { start: 0x0401, end: 0x045f, idx:  -857 },
-  { start: 0x2116, end: 0x2116, idx: -8207 },
-  { start: 0xffff, end: 0xffff, idx:     0 }
+  { .start = 0x0000, .end = 0x00a0, .idx =     0 },
+  { .start = 0x00a7, .end = 0x00ad, .idx =    -6 },
+  { .start = 0x0401, .end = 0x045f, .idx =  -857 },
+  { .start = 0x2116, .end = 0x2116, .idx = -8207 },
+  { .start = 0xffff, .end = 0xffff, .idx =     0 }
 };
 
 static const char from_ucs4[] =
diff --git a/iconvdata/ibm1097.h b/iconvdata/ibm1097.h
index ab71809e..1b97402a 100644
--- a/iconvdata/ibm1097.h
+++ b/iconvdata/ibm1097.h
@@ -88,22 +88,22 @@ static const uint32_t to_ucs4[256] =
 
 static const struct gap from_idx[] =
 {
-  { start: 0x0000, end: 0x00a4, idx:     0 },
-  { start: 0x00ab, end: 0x00ad, idx:    -6 },
-  { start: 0x00bb, end: 0x00bb, idx:   -19 },
-  { start: 0x00d7, end: 0x00d7, idx:   -46 },
-  { start: 0x060c, end: 0x060c, idx: -1378 },
-  { start: 0x061b, end: 0x064b, idx: -1392 },
-  { start: 0x0660, end: 0x066d, idx: -1412 },
-  { start: 0x06f0, end: 0x06f9, idx: -1542 },
-  { start: 0xf8f9, end: 0xf8fb, idx: -63493 },
-  { start: 0xfb56, end: 0xfb58, idx: -64095 },
-  { start: 0xfb7a, end: 0xfb7c, idx: -64128 },
-  { start: 0xfb8a, end: 0xfb94, idx: -64141 },
-  { start: 0xfba4, end: 0xfba4, idx: -64156 },
-  { start: 0xfbfc, end: 0xfbfe, idx: -64243 },
-  { start: 0xfe80, end: 0xfeee, idx: -64884 },
-  { start: 0xffff, end: 0xffff, idx:     0 }
+  { .start = 0x0000, .end = 0x00a4, .idx =     0 },
+  { .start = 0x00ab, .end = 0x00ad, .idx =    -6 },
+  { .start = 0x00bb, .end = 0x00bb, .idx =   -19 },
+  { .start = 0x00d7, .end = 0x00d7, .idx =   -46 },
+  { .start = 0x060c, .end = 0x060c, .idx = -1378 },
+  { .start = 0x061b, .end = 0x064b, .idx = -1392 },
+  { .start = 0x0660, .end = 0x066d, .idx = -1412 },
+  { .start = 0x06f0, .end = 0x06f9, .idx = -1542 },
+  { .start = 0xf8f9, .end = 0xf8fb, .idx = -63493 },
+  { .start = 0xfb56, .end = 0xfb58, .idx = -64095 },
+  { .start = 0xfb7a, .end = 0xfb7c, .idx = -64128 },
+  { .start = 0xfb8a, .end = 0xfb94, .idx = -64141 },
+  { .start = 0xfba4, .end = 0xfba4, .idx = -64156 },
+  { .start = 0xfbfc, .end = 0xfbfe, .idx = -64243 },
+  { .start = 0xfe80, .end = 0xfeee, .idx = -64884 },
+  { .start = 0xffff, .end = 0xffff, .idx =     0 }
 };
 
 static const char from_ucs4[] =
diff --git a/iconvdata/ibm1112.h b/iconvdata/ibm1112.h
index 43441be3..b014a08b 100644
--- a/iconvdata/ibm1112.h
+++ b/iconvdata/ibm1112.h
@@ -88,17 +88,17 @@ static const uint32_t to_ucs4[256] =
 
 static const struct gap from_idx[] =
 {
-  { start: 0x0000, end: 0x00c9, idx:     0 },
-  { start: 0x00d3, end: 0x00e9, idx:    -9 },
-  { start: 0x00f3, end: 0x0119, idx:   -18 },
-  { start: 0x0122, end: 0x0123, idx:   -26 },
-  { start: 0x012a, end: 0x012f, idx:   -32 },
-  { start: 0x0136, end: 0x014d, idx:   -38 },
-  { start: 0x0156, end: 0x0161, idx:   -46 },
-  { start: 0x016a, end: 0x016b, idx:   -54 },
-  { start: 0x0172, end: 0x017e, idx:   -60 },
-  { start: 0x2019, end: 0x201e, idx: -7894 },
-  { start: 0xffff, end: 0xffff, idx:     0 }
+  { .start = 0x0000, .end = 0x00c9, .idx =     0 },
+  { .start = 0x00d3, .end = 0x00e9, .idx =    -9 },
+  { .start = 0x00f3, .end = 0x0119, .idx =   -18 },
+  { .start = 0x0122, .end = 0x0123, .idx =   -26 },
+  { .start = 0x012a, .end = 0x012f, .idx =   -32 },
+  { .start = 0x0136, .end = 0x014d, .idx =   -38 },
+  { .start = 0x0156, .end = 0x0161, .idx =   -46 },
+  { .start = 0x016a, .end = 0x016b, .idx =   -54 },
+  { .start = 0x0172, .end = 0x017e, .idx =   -60 },
+  { .start = 0x2019, .end = 0x201e, .idx = -7894 },
+  { .start = 0xffff, .end = 0xffff, .idx =     0 }
 };
 
 static const char from_ucs4[] =
diff --git a/iconvdata/ibm1122.h b/iconvdata/ibm1122.h
index c6ff0692..c5b34b83 100644
--- a/iconvdata/ibm1122.h
+++ b/iconvdata/ibm1122.h
@@ -88,11 +88,11 @@ static const uint32_t to_ucs4[256] =
 
 static const struct gap from_idx[] =
 {
-  { start: 0x0000, end: 0x00ff, idx:     0 },
-  { start: 0x0160, end: 0x0161, idx:   -96 },
-  { start: 0x017d, end: 0x017e, idx:  -123 },
-  { start: 0x203e, end: 0x203e, idx: -7994 },
-  { start: 0xffff, end: 0xffff, idx:     0 }
+  { .start = 0x0000, .end = 0x00ff, .idx =     0 },
+  { .start = 0x0160, .end = 0x0161, .idx =   -96 },
+  { .start = 0x017d, .end = 0x017e, .idx =  -123 },
+  { .start = 0x203e, .end = 0x203e, .idx = -7994 },
+  { .start = 0xffff, .end = 0xffff, .idx =     0 }
 };
 
 static const char from_ucs4[] =
diff --git a/iconvdata/ibm1123.h b/iconvdata/ibm1123.h
index 85cdf16d..10c66697 100644
--- a/iconvdata/ibm1123.h
+++ b/iconvdata/ibm1123.h
@@ -88,12 +88,12 @@ static const uint32_t to_ucs4[256] =
 
 static const struct gap from_idx[] =
 {
-  { start: 0x0000, end: 0x00a0, idx:     0 },
-  { start: 0x00a7, end: 0x00ad, idx:    -6 },
-  { start: 0x0401, end: 0x045f, idx:  -857 },
-  { start: 0x0490, end: 0x0491, idx:  -905 },
-  { start: 0x2116, end: 0x2116, idx: -8205 },
-  { start: 0xffff, end: 0xffff, idx:     0 }
+  { .start = 0x0000, .end = 0x00a0, .idx =     0 },
+  { .start = 0x00a7, .end = 0x00ad, .idx =    -6 },
+  { .start = 0x0401, .end = 0x045f, .idx =  -857 },
+  { .start = 0x0490, .end = 0x0491, .idx =  -905 },
+  { .start = 0x2116, .end = 0x2116, .idx = -8205 },
+  { .start = 0xffff, .end = 0xffff, .idx =     0 }
 };
 
 static const char from_ucs4[] =
diff --git a/iconvdata/ibm1130.h b/iconvdata/ibm1130.h
index 3f1d5970..471d853d 100644
--- a/iconvdata/ibm1130.h
+++ b/iconvdata/ibm1130.h
@@ -88,16 +88,16 @@ static const uint32_t to_ucs4[256] =
 
 static const struct gap from_idx[] =
 {
-  { start: 0x0000, end: 0x0103, idx:     0 },
-  { start: 0x0110, end: 0x0111, idx:   -12 },
-  { start: 0x0152, end: 0x0153, idx:   -76 },
-  { start: 0x0178, end: 0x0178, idx:  -112 },
-  { start: 0x01a0, end: 0x01a1, idx:  -151 },
-  { start: 0x01af, end: 0x01b0, idx:  -164 },
-  { start: 0x0300, end: 0x0309, idx:  -499 },
-  { start: 0x0323, end: 0x0323, idx:  -524 },
-  { start: 0x20ab, end: 0x20ab, idx: -8083 },
-  { start: 0xffff, end: 0xffff, idx:     0 }
+  { .start = 0x0000, .end = 0x0103, .idx =     0 },
+  { .start = 0x0110, .end = 0x0111, .idx =   -12 },
+  { .start = 0x0152, .end = 0x0153, .idx =   -76 },
+  { .start = 0x0178, .end = 0x0178, .idx =  -112 },
+  { .start = 0x01a0, .end = 0x01a1, .idx =  -151 },
+  { .start = 0x01af, .end = 0x01b0, .idx =  -164 },
+  { .start = 0x0300, .end = 0x0309, .idx =  -499 },
+  { .start = 0x0323, .end = 0x0323, .idx =  -524 },
+  { .start = 0x20ab, .end = 0x20ab, .idx = -8083 },
+  { .start = 0xffff, .end = 0xffff, .idx =     0 }
 };
 
 static const char from_ucs4[] =
diff --git a/iconvdata/ibm1137.h b/iconvdata/ibm1137.h
index 54c0105d..0ad826c3 100644
--- a/iconvdata/ibm1137.h
+++ b/iconvdata/ibm1137.h
@@ -88,11 +88,11 @@ static const uint32_t to_ucs4[256] =
 
 static const struct gap from_idx[] =
 {
-  { start: 0x0000, end: 0x00a0, idx:     0 },
-  { start: 0x0901, end: 0x0952, idx: -2144 },
-  { start: 0x0960, end: 0x0970, idx: -2157 },
-  { start: 0x200c, end: 0x200d, idx: -7944 },
-  { start: 0xffff, end: 0xffff, idx:     0 }
+  { .start = 0x0000, .end = 0x00a0, .idx =     0 },
+  { .start = 0x0901, .end = 0x0952, .idx = -2144 },
+  { .start = 0x0960, .end = 0x0970, .idx = -2157 },
+  { .start = 0x200c, .end = 0x200d, .idx = -7944 },
+  { .start = 0xffff, .end = 0xffff, .idx =     0 }
 };
 
 static const char from_ucs4[] =
diff --git a/iconvdata/ibm1140.h b/iconvdata/ibm1140.h
index cd496254..cb3ec4b1 100644
--- a/iconvdata/ibm1140.h
+++ b/iconvdata/ibm1140.h
@@ -88,10 +88,10 @@ static const uint32_t to_ucs4[256] =
 
 static const struct gap from_idx[] =
 {
-  { start: 0x0000, end: 0x00ff, idx:     0 },
-  { start: 0x203e, end: 0x203e, idx: -7998 },
-  { start: 0x20ac, end: 0x20ac, idx: -8107 },
-  { start: 0xffff, end: 0xffff, idx:     0 }
+  { .start = 0x0000, .end = 0x00ff, .idx =     0 },
+  { .start = 0x203e, .end = 0x203e, .idx = -7998 },
+  { .start = 0x20ac, .end = 0x20ac, .idx = -8107 },
+  { .start = 0xffff, .end = 0xffff, .idx =     0 }
 };
 
 static const char from_ucs4[] =
diff --git a/iconvdata/ibm1141.h b/iconvdata/ibm1141.h
index 8a95810a..5c7669fe 100644
--- a/iconvdata/ibm1141.h
+++ b/iconvdata/ibm1141.h
@@ -88,10 +88,10 @@ static const uint32_t to_ucs4[256] =
 
 static const struct gap from_idx[] =
 {
-  { start: 0x0000, end: 0x00ff, idx:     0 },
-  { start: 0x203e, end: 0x203e, idx: -7998 },
-  { start: 0x20ac, end: 0x20ac, idx: -8107 },
-  { start: 0xffff, end: 0xffff, idx:     0 }
+  { .start = 0x0000, .end = 0x00ff, .idx =     0 },
+  { .start = 0x203e, .end = 0x203e, .idx = -7998 },
+  { .start = 0x20ac, .end = 0x20ac, .idx = -8107 },
+  { .start = 0xffff, .end = 0xffff, .idx =     0 }
 };
 
 static const char from_ucs4[] =
diff --git a/iconvdata/ibm1142.h b/iconvdata/ibm1142.h
index c21e59d6..d0628bcf 100644
--- a/iconvdata/ibm1142.h
+++ b/iconvdata/ibm1142.h
@@ -88,10 +88,10 @@ static const uint32_t to_ucs4[256] =
 
 static const struct gap from_idx[] =
 {
-  { start: 0x0000, end: 0x00ff, idx:     0 },
-  { start: 0x203e, end: 0x203e, idx: -7998 },
-  { start: 0x20ac, end: 0x20ac, idx: -8107 },
-  { start: 0xffff, end: 0xffff, idx:     0 }
+  { .start = 0x0000, .end = 0x00ff, .idx =     0 },
+  { .start = 0x203e, .end = 0x203e, .idx = -7998 },
+  { .start = 0x20ac, .end = 0x20ac, .idx = -8107 },
+  { .start = 0xffff, .end = 0xffff, .idx =     0 }
 };
 
 static const char from_ucs4[] =
diff --git a/iconvdata/ibm1143.h b/iconvdata/ibm1143.h
index c9917b33..c7c8e4f6 100644
--- a/iconvdata/ibm1143.h
+++ b/iconvdata/ibm1143.h
@@ -88,10 +88,10 @@ static const uint32_t to_ucs4[256] =
 
 static const struct gap from_idx[] =
 {
-  { start: 0x0000, end: 0x00ff, idx:     0 },
-  { start: 0x203e, end: 0x203e, idx: -7998 },
-  { start: 0x20ac, end: 0x20ac, idx: -8107 },
-  { start: 0xffff, end: 0xffff, idx:     0 }
+  { .start = 0x0000, .end = 0x00ff, .idx =     0 },
+  { .start = 0x203e, .end = 0x203e, .idx = -7998 },
+  { .start = 0x20ac, .end = 0x20ac, .idx = -8107 },
+  { .start = 0xffff, .end = 0xffff, .idx =     0 }
 };
 
 static const char from_ucs4[] =
diff --git a/iconvdata/ibm1144.h b/iconvdata/ibm1144.h
index dd95f84a..a83f0e52 100644
--- a/iconvdata/ibm1144.h
+++ b/iconvdata/ibm1144.h
@@ -88,10 +88,10 @@ static const uint32_t to_ucs4[256] =
 
 static const struct gap from_idx[] =
 {
-  { start: 0x0000, end: 0x00ff, idx:     0 },
-  { start: 0x203e, end: 0x203e, idx: -7998 },
-  { start: 0x20ac, end: 0x20ac, idx: -8107 },
-  { start: 0xffff, end: 0xffff, idx:     0 }
+  { .start = 0x0000, .end = 0x00ff, .idx =     0 },
+  { .start = 0x203e, .end = 0x203e, .idx = -7998 },
+  { .start = 0x20ac, .end = 0x20ac, .idx = -8107 },
+  { .start = 0xffff, .end = 0xffff, .idx =     0 }
 };
 
 static const char from_ucs4[] =
diff --git a/iconvdata/ibm1145.h b/iconvdata/ibm1145.h
index 949085ee..cffa98e6 100644
--- a/iconvdata/ibm1145.h
+++ b/iconvdata/ibm1145.h
@@ -14,7 +14,7 @@
 
    You should have received a copy of the GNU Lesser General Public
    License along with the GNU C Library; if not, see
-   <https://www.gnu.org/licenses/>.  */
+   <https =//www.gnu.org/licenses/>.  */
 
 #include <stdint.h>
 
@@ -88,10 +88,10 @@ static const uint32_t to_ucs4[256] =
 
 static const struct gap from_idx[] =
 {
-  { start: 0x0000, end: 0x00ff, idx:     0 },
-  { start: 0x203e, end: 0x203e, idx: -7998 },
-  { start: 0x20ac, end: 0x20ac, idx: -8107 },
-  { start: 0xffff, end: 0xffff, idx:     0 }
+  { .start = 0x0000, .end = 0x00ff, .idx =     0 },
+  { .start = 0x203e, .end = 0x203e, .idx = -7998 },
+  { .start = 0x20ac, .end = 0x20ac, .idx = -8107 },
+  { .start = 0xffff, .end = 0xffff, .idx =     0 }
 };
 
 static const char from_ucs4[] =
diff --git a/iconvdata/ibm1146.h b/iconvdata/ibm1146.h
index 02b00f23..fbc739e9 100644
--- a/iconvdata/ibm1146.h
+++ b/iconvdata/ibm1146.h
@@ -14,7 +14,7 @@
 
    You should have received a copy of the GNU Lesser General Public
    License along with the GNU C Library; if not, see
-   <https://www.gnu.org/licenses/>.  */
+   <https =//www.gnu.org/licenses/>.  */
 
 #include <stdint.h>
 
@@ -88,10 +88,10 @@ static const uint32_t to_ucs4[256] =
 
 static const struct gap from_idx[] =
 {
-  { start: 0x0000, end: 0x00ff, idx:     0 },
-  { start: 0x203e, end: 0x203e, idx: -7998 },
-  { start: 0x20ac, end: 0x20ac, idx: -8107 },
-  { start: 0xffff, end: 0xffff, idx:     0 }
+  { .start = 0x0000, .end = 0x00ff, .idx =     0 },
+  { .start = 0x203e, .end = 0x203e, .idx = -7998 },
+  { .start = 0x20ac, .end = 0x20ac, .idx = -8107 },
+  { .start = 0xffff, .end = 0xffff, .idx =     0 }
 };
 
 static const char from_ucs4[] =
diff --git a/iconvdata/ibm1147.h b/iconvdata/ibm1147.h
index 188624dc..7718ec50 100644
--- a/iconvdata/ibm1147.h
+++ b/iconvdata/ibm1147.h
@@ -14,7 +14,7 @@
 
    You should have received a copy of the GNU Lesser General Public
    License along with the GNU C Library; if not, see
-   <https://www.gnu.org/licenses/>.  */
+   <https =//www.gnu.org/licenses/>.  */
 
 #include <stdint.h>
 
@@ -88,10 +88,10 @@ static const uint32_t to_ucs4[256] =
 
 static const struct gap from_idx[] =
 {
-  { start: 0x0000, end: 0x00ff, idx:     0 },
-  { start: 0x203e, end: 0x203e, idx: -7998 },
-  { start: 0x20ac, end: 0x20ac, idx: -8107 },
-  { start: 0xffff, end: 0xffff, idx:     0 }
+  { .start = 0x0000, .end = 0x00ff, .idx =     0 },
+  { .start = 0x203e, .end = 0x203e, .idx = -7998 },
+  { .start = 0x20ac, .end = 0x20ac, .idx = -8107 },
+  { .start = 0xffff, .end = 0xffff, .idx =     0 }
 };
 
 static const char from_ucs4[] =
diff --git a/iconvdata/ibm1148.h b/iconvdata/ibm1148.h
index 3982d916..d558e43f 100644
--- a/iconvdata/ibm1148.h
+++ b/iconvdata/ibm1148.h
@@ -14,7 +14,7 @@
 
    You should have received a copy of the GNU Lesser General Public
    License along with the GNU C Library; if not, see
-   <https://www.gnu.org/licenses/>.  */
+   <https =//www.gnu.org/licenses/>.  */
 
 #include <stdint.h>
 
@@ -88,10 +88,10 @@ static const uint32_t to_ucs4[256] =
 
 static const struct gap from_idx[] =
 {
-  { start: 0x0000, end: 0x00ff, idx:     0 },
-  { start: 0x203e, end: 0x203e, idx: -7998 },
-  { start: 0x20ac, end: 0x20ac, idx: -8107 },
-  { start: 0xffff, end: 0xffff, idx:     0 }
+  { .start = 0x0000, .end = 0x00ff, .idx =     0 },
+  { .start = 0x203e, .end = 0x203e, .idx = -7998 },
+  { .start = 0x20ac, .end = 0x20ac, .idx = -8107 },
+  { .start = 0xffff, .end = 0xffff, .idx =     0 }
 };
 
 static const char from_ucs4[] =
diff --git a/iconvdata/ibm1149.h b/iconvdata/ibm1149.h
index b957dc2f..c2258237 100644
--- a/iconvdata/ibm1149.h
+++ b/iconvdata/ibm1149.h
@@ -14,7 +14,7 @@
 
    You should have received a copy of the GNU Lesser General Public
    License along with the GNU C Library; if not, see
-   <https://www.gnu.org/licenses/>.  */
+   <https =//www.gnu.org/licenses/>.  */
 
 #include <stdint.h>
 
@@ -88,10 +88,10 @@ static const uint32_t to_ucs4[256] =
 
 static const struct gap from_idx[] =
 {
-  { start: 0x0000, end: 0x00ff, idx:     0 },
-  { start: 0x203e, end: 0x203e, idx: -7998 },
-  { start: 0x20ac, end: 0x20ac, idx: -8107 },
-  { start: 0xffff, end: 0xffff, idx:     0 }
+  { .start = 0x0000, .end = 0x00ff, .idx =     0 },
+  { .start = 0x203e, .end = 0x203e, .idx = -7998 },
+  { .start = 0x20ac, .end = 0x20ac, .idx = -8107 },
+  { .start = 0xffff, .end = 0xffff, .idx =     0 }
 };
 
 static const char from_ucs4[] =
diff --git a/iconvdata/ibm1153.h b/iconvdata/ibm1153.h
index e3b98f5d..1568ac84 100644
--- a/iconvdata/ibm1153.h
+++ b/iconvdata/ibm1153.h
@@ -14,7 +14,7 @@
 
    You should have received a copy of the GNU Lesser General Public
    License along with the GNU C Library; if not, see
-   <https://www.gnu.org/licenses/>.  */
+   <https =//www.gnu.org/licenses/>.  */
 
 #include <stdint.h>
 
@@ -88,18 +88,18 @@ static const uint32_t to_ucs4[256] =
 
 static const struct gap from_idx[] =
 {
-  { start: 0x0000, end: 0x00a0, idx:     0 },
-  { start: 0x00a7, end: 0x00b8, idx:    -6 },
-  { start: 0x00c1, end: 0x0111, idx:   -14 },
-  { start: 0x0118, end: 0x011b, idx:   -20 },
-  { start: 0x0139, end: 0x0148, idx:   -49 },
-  { start: 0x0150, end: 0x0165, idx:   -56 },
-  { start: 0x016e, end: 0x0171, idx:   -64 },
-  { start: 0x0179, end: 0x017e, idx:   -71 },
-  { start: 0x02c7, end: 0x02c7, idx:  -399 },
-  { start: 0x02d8, end: 0x02dd, idx:  -415 },
-  { start: 0x20ac, end: 0x20ac, idx: -8045 },
-  { start: 0xffff, end: 0xffff, idx:     0 }
+  { .start = 0x0000, .end = 0x00a0, .idx =     0 },
+  { .start = 0x00a7, .end = 0x00b8, .idx =    -6 },
+  { .start = 0x00c1, .end = 0x0111, .idx =   -14 },
+  { .start = 0x0118, .end = 0x011b, .idx =   -20 },
+  { .start = 0x0139, .end = 0x0148, .idx =   -49 },
+  { .start = 0x0150, .end = 0x0165, .idx =   -56 },
+  { .start = 0x016e, .end = 0x0171, .idx =   -64 },
+  { .start = 0x0179, .end = 0x017e, .idx =   -71 },
+  { .start = 0x02c7, .end = 0x02c7, .idx =  -399 },
+  { .start = 0x02d8, .end = 0x02dd, .idx =  -415 },
+  { .start = 0x20ac, .end = 0x20ac, .idx = -8045 },
+  { .start = 0xffff, .end = 0xffff, .idx =     0 }
 };
 
 static const char from_ucs4[] =
diff --git a/iconvdata/ibm1154.h b/iconvdata/ibm1154.h
index 9c25a668..6592fe0d 100644
--- a/iconvdata/ibm1154.h
+++ b/iconvdata/ibm1154.h
@@ -14,7 +14,7 @@
 
    You should have received a copy of the GNU Lesser General Public
    License along with the GNU C Library; if not, see
-   <https://www.gnu.org/licenses/>.  */
+   <https =//www.gnu.org/licenses/>.  */
 
 #include <stdint.h>
 
@@ -88,12 +88,12 @@ static const uint32_t to_ucs4[256] =
 
 static const struct gap from_idx[] =
 {
-  { start: 0x0000, end: 0x00a0, idx:     0 },
-  { start: 0x00ad, end: 0x00ad, idx:   -12 },
-  { start: 0x0401, end: 0x045f, idx:  -863 },
-  { start: 0x20ac, end: 0x20ac, idx: -8107 },
-  { start: 0x2116, end: 0x2116, idx: -8212 },
-  { start: 0xffff, end: 0xffff, idx:     0 }
+  { .start = 0x0000, .end = 0x00a0, .idx =     0 },
+  { .start = 0x00ad, .end = 0x00ad, .idx =   -12 },
+  { .start = 0x0401, .end = 0x045f, .idx =  -863 },
+  { .start = 0x20ac, .end = 0x20ac, .idx = -8107 },
+  { .start = 0x2116, .end = 0x2116, .idx = -8212 },
+  { .start = 0xffff, .end = 0xffff, .idx =     0 }
 };
 
 static const char from_ucs4[] =
diff --git a/iconvdata/ibm1155.h b/iconvdata/ibm1155.h
index 7e1a3b86..c9f3b23f 100644
--- a/iconvdata/ibm1155.h
+++ b/iconvdata/ibm1155.h
@@ -14,7 +14,7 @@
 
    You should have received a copy of the GNU Lesser General Public
    License along with the GNU C Library; if not, see
-   <https://www.gnu.org/licenses/>.  */
+   <https =//www.gnu.org/licenses/>.  */
 
 #include <stdint.h>
 
@@ -88,12 +88,12 @@ static const uint32_t to_ucs4[256] =
 
 static const struct gap from_idx[] =
 {
-  { start: 0x0000, end: 0x00ff, idx:     0 },
-  { start: 0x011e, end: 0x011f, idx:   -30 },
-  { start: 0x0130, end: 0x0131, idx:   -46 },
-  { start: 0x015e, end: 0x015f, idx:   -90 },
-  { start: 0x20ac, end: 0x20ac, idx: -8102 },
-  { start: 0xffff, end: 0xffff, idx:     0 }
+  { .start = 0x0000, .end = 0x00ff, .idx =     0 },
+  { .start = 0x011e, .end = 0x011f, .idx =   -30 },
+  { .start = 0x0130, .end = 0x0131, .idx =   -46 },
+  { .start = 0x015e, .end = 0x015f, .idx =   -90 },
+  { .start = 0x20ac, .end = 0x20ac, .idx = -8102 },
+  { .start = 0xffff, .end = 0xffff, .idx =     0 }
 };
 
 static const char from_ucs4[] =
diff --git a/iconvdata/ibm1156.h b/iconvdata/ibm1156.h
index 4474f3e7..c198fdbb 100644
--- a/iconvdata/ibm1156.h
+++ b/iconvdata/ibm1156.h
@@ -14,7 +14,7 @@
 
    You should have received a copy of the GNU Lesser General Public
    License along with the GNU C Library; if not, see
-   <https://www.gnu.org/licenses/>.  */
+   <https =//www.gnu.org/licenses/>.  */
 
 #include <stdint.h>
 
@@ -88,18 +88,18 @@ static const uint32_t to_ucs4[256] =
 
 static const struct gap from_idx[] =
 {
-  { start: 0x0000, end: 0x00c9, idx:     0 },
-  { start: 0x00d3, end: 0x00e9, idx:    -9 },
-  { start: 0x00f3, end: 0x0119, idx:   -18 },
-  { start: 0x0122, end: 0x0123, idx:   -26 },
-  { start: 0x012a, end: 0x012f, idx:   -32 },
-  { start: 0x0136, end: 0x014d, idx:   -38 },
-  { start: 0x0156, end: 0x0161, idx:   -46 },
-  { start: 0x016a, end: 0x016b, idx:   -54 },
-  { start: 0x0172, end: 0x017e, idx:   -60 },
-  { start: 0x2019, end: 0x201e, idx: -7894 },
-  { start: 0x20ac, end: 0x20ac, idx: -8035 },
-  { start: 0xffff, end: 0xffff, idx:     0 }
+  { .start = 0x0000, .end = 0x00c9, .idx =     0 },
+  { .start = 0x00d3, .end = 0x00e9, .idx =    -9 },
+  { .start = 0x00f3, .end = 0x0119, .idx =   -18 },
+  { .start = 0x0122, .end = 0x0123, .idx =   -26 },
+  { .start = 0x012a, .end = 0x012f, .idx =   -32 },
+  { .start = 0x0136, .end = 0x014d, .idx =   -38 },
+  { .start = 0x0156, .end = 0x0161, .idx =   -46 },
+  { .start = 0x016a, .end = 0x016b, .idx =   -54 },
+  { .start = 0x0172, .end = 0x017e, .idx =   -60 },
+  { .start = 0x2019, .end = 0x201e, .idx = -7894 },
+  { .start = 0x20ac, .end = 0x20ac, .idx = -8035 },
+  { .start = 0xffff, .end = 0xffff, .idx =     0 }
 };
 
 static const char from_ucs4[] =
diff --git a/iconvdata/ibm1157.h b/iconvdata/ibm1157.h
index 88ad7d96..95b6942a 100644
--- a/iconvdata/ibm1157.h
+++ b/iconvdata/ibm1157.h
@@ -14,7 +14,7 @@
 
    You should have received a copy of the GNU Lesser General Public
    License along with the GNU C Library; if not, see
-   <https://www.gnu.org/licenses/>.  */
+   <https =//www.gnu.org/licenses/>.  */
 
 #include <stdint.h>
 
@@ -88,12 +88,12 @@ static const uint32_t to_ucs4[256] =
 
 static const struct gap from_idx[] =
 {
-  { start: 0x0000, end: 0x00ff, idx:     0 },
-  { start: 0x0160, end: 0x0161, idx:   -96 },
-  { start: 0x017d, end: 0x017e, idx:  -123 },
-  { start: 0x203e, end: 0x203e, idx: -7994 },
-  { start: 0x20ac, end: 0x20ac, idx: -8103 },
-  { start: 0xffff, end: 0xffff, idx:     0 }
+  { .start = 0x0000, .end = 0x00ff, .idx =     0 },
+  { .start = 0x0160, .end = 0x0161, .idx =   -96 },
+  { .start = 0x017d, .end = 0x017e, .idx =  -123 },
+  { .start = 0x203e, .end = 0x203e, .idx = -7994 },
+  { .start = 0x20ac, .end = 0x20ac, .idx = -8103 },
+  { .start = 0xffff, .end = 0xffff, .idx =     0 }
 };
 
 static const char from_ucs4[] =
diff --git a/iconvdata/ibm1158.h b/iconvdata/ibm1158.h
index c2180b97..cef94bd5 100644
--- a/iconvdata/ibm1158.h
+++ b/iconvdata/ibm1158.h
@@ -14,7 +14,7 @@
 
    You should have received a copy of the GNU Lesser General Public
    License along with the GNU C Library; if not, see
-   <https://www.gnu.org/licenses/>.  */
+   <https =//www.gnu.org/licenses/>.  */
 
 #include <stdint.h>
 
@@ -88,13 +88,13 @@ static const uint32_t to_ucs4[256] =
 
 static const struct gap from_idx[] =
 {
-  { start: 0x0000, end: 0x00a0, idx:     0 },
-  { start: 0x00ad, end: 0x00ad, idx:   -12 },
-  { start: 0x0401, end: 0x045f, idx:  -863 },
-  { start: 0x0490, end: 0x0491, idx:  -911 },
-  { start: 0x20ac, end: 0x20ac, idx: -8105 },
-  { start: 0x2116, end: 0x2116, idx: -8210 },
-  { start: 0xffff, end: 0xffff, idx:     0 }
+  { .start = 0x0000, .end = 0x00a0, .idx =     0 },
+  { .start = 0x00ad, .end = 0x00ad, .idx =   -12 },
+  { .start = 0x0401, .end = 0x045f, .idx =  -863 },
+  { .start = 0x0490, .end = 0x0491, .idx =  -911 },
+  { .start = 0x20ac, .end = 0x20ac, .idx = -8105 },
+  { .start = 0x2116, .end = 0x2116, .idx = -8210 },
+  { .start = 0xffff, .end = 0xffff, .idx =     0 }
 };
 
 static const char from_ucs4[] =
diff --git a/iconvdata/ibm1166.h b/iconvdata/ibm1166.h
index b3ba6f28..e9227f43 100644
--- a/iconvdata/ibm1166.h
+++ b/iconvdata/ibm1166.h
@@ -14,7 +14,7 @@
 
    You should have received a copy of the GNU Lesser General Public
    License along with the GNU C Library; if not, see
-   <https://www.gnu.org/licenses/>.  */
+   <https =//www.gnu.org/licenses/>.  */
 
 #include <stdint.h>
 
@@ -88,19 +88,19 @@ static const uint32_t to_ucs4[256] =
 
 static const struct gap from_idx[] =
 {
-  { start: 0x0000, end: 0x00a0, idx:     0 },
-  { start: 0x00ad, end: 0x00ad, idx:   -12 },
-  { start: 0x0401, end: 0x045e, idx:  -863 },
-  { start: 0x0492, end: 0x0493, idx:  -914 },
-  { start: 0x049a, end: 0x049b, idx:  -920 },
-  { start: 0x04a2, end: 0x04a3, idx:  -926 },
-  { start: 0x04ae, end: 0x04b1, idx:  -936 },
-  { start: 0x04ba, end: 0x04bb, idx:  -944 },
-  { start: 0x04d8, end: 0x04d9, idx:  -972 },
-  { start: 0x04e8, end: 0x04e9, idx:  -986 },
-  { start: 0x20ac, end: 0x20ac, idx: -8092 },
-  { start: 0x2116, end: 0x2116, idx: -8197 },
-  { start: 0xffff, end: 0xffff, idx:     0 }
+  { .start = 0x0000, .end = 0x00a0, .idx =     0 },
+  { .start = 0x00ad, .end = 0x00ad, .idx =   -12 },
+  { .start = 0x0401, .end = 0x045e, .idx =  -863 },
+  { .start = 0x0492, .end = 0x0493, .idx =  -914 },
+  { .start = 0x049a, .end = 0x049b, .idx =  -920 },
+  { .start = 0x04a2, .end = 0x04a3, .idx =  -926 },
+  { .start = 0x04ae, .end = 0x04b1, .idx =  -936 },
+  { .start = 0x04ba, .end = 0x04bb, .idx =  -944 },
+  { .start = 0x04d8, .end = 0x04d9, .idx =  -972 },
+  { .start = 0x04e8, .end = 0x04e9, .idx =  -986 },
+  { .start = 0x20ac, .end = 0x20ac, .idx = -8092 },
+  { .start = 0x2116, .end = 0x2116, .idx = -8197 },
+  { .start = 0xffff, .end = 0xffff, .idx =     0 }
 };
 
 static const char from_ucs4[] =
diff --git a/iconvdata/ibm1167.h b/iconvdata/ibm1167.h
index c4ebb4dc..b8906c0b 100644
--- a/iconvdata/ibm1167.h
+++ b/iconvdata/ibm1167.h
@@ -14,7 +14,7 @@
 
    You should have received a copy of the GNU Lesser General Public
    License along with the GNU C Library; if not, see
-   <https://www.gnu.org/licenses/>.  */
+   <https =//www.gnu.org/licenses/>.  */
 
 #include <stdint.h>
 
@@ -88,28 +88,28 @@ static const uint32_t to_ucs4[256] =
 
 static const struct gap from_idx[] =
 {
-  { start: 0x0000, end: 0x007f, idx:     0 },
-  { start: 0x00a0, end: 0x00ae, idx:   -32 },
-  { start: 0x00b7, end: 0x00bb, idx:   -40 },
-  { start: 0x0401, end: 0x0407, idx:  -877 },
-  { start: 0x040e, end: 0x0457, idx:  -883 },
-  { start: 0x045e, end: 0x045e, idx:  -889 },
-  { start: 0x0490, end: 0x0491, idx:  -938 },
-  { start: 0x2014, end: 0x2014, idx: -7980 },
-  { start: 0x201c, end: 0x201d, idx: -7987 },
-  { start: 0x2116, end: 0x2116, idx: -8235 },
-  { start: 0x2122, end: 0x2122, idx: -8246 },
-  { start: 0x2219, end: 0x2219, idx: -8492 },
-  { start: 0x2500, end: 0x2502, idx: -9234 },
-  { start: 0x250c, end: 0x251c, idx: -9243 },
-  { start: 0x2524, end: 0x2524, idx: -9250 },
-  { start: 0x252c, end: 0x252c, idx: -9257 },
-  { start: 0x2534, end: 0x2534, idx: -9264 },
-  { start: 0x253c, end: 0x253c, idx: -9271 },
-  { start: 0x2550, end: 0x256a, idx: -9290 },
-  { start: 0x2580, end: 0x2593, idx: -9311 },
-  { start: 0x25a0, end: 0x25a0, idx: -9323 },
-  { start: 0xffff, end: 0xffff, idx:     0 }
+  { .start = 0x0000, .end = 0x007f, .idx =     0 },
+  { .start = 0x00a0, .end = 0x00ae, .idx =   -32 },
+  { .start = 0x00b7, .end = 0x00bb, .idx =   -40 },
+  { .start = 0x0401, .end = 0x0407, .idx =  -877 },
+  { .start = 0x040e, .end = 0x0457, .idx =  -883 },
+  { .start = 0x045e, .end = 0x045e, .idx =  -889 },
+  { .start = 0x0490, .end = 0x0491, .idx =  -938 },
+  { .start = 0x2014, .end = 0x2014, .idx = -7980 },
+  { .start = 0x201c, .end = 0x201d, .idx = -7987 },
+  { .start = 0x2116, .end = 0x2116, .idx = -8235 },
+  { .start = 0x2122, .end = 0x2122, .idx = -8246 },
+  { .start = 0x2219, .end = 0x2219, .idx = -8492 },
+  { .start = 0x2500, .end = 0x2502, .idx = -9234 },
+  { .start = 0x250c, .end = 0x251c, .idx = -9243 },
+  { .start = 0x2524, .end = 0x2524, .idx = -9250 },
+  { .start = 0x252c, .end = 0x252c, .idx = -9257 },
+  { .start = 0x2534, .end = 0x2534, .idx = -9264 },
+  { .start = 0x253c, .end = 0x253c, .idx = -9271 },
+  { .start = 0x2550, .end = 0x256a, .idx = -9290 },
+  { .start = 0x2580, .end = 0x2593, .idx = -9311 },
+  { .start = 0x25a0, .end = 0x25a0, .idx = -9323 },
+  { .start = 0xffff, .end = 0xffff, .idx =     0 }
 };
 
 static const char from_ucs4[] =
diff --git a/iconvdata/ibm12712.h b/iconvdata/ibm12712.h
index 83a4fb51..fe85bceb 100644
--- a/iconvdata/ibm12712.h
+++ b/iconvdata/ibm12712.h
@@ -14,7 +14,7 @@
 
    You should have received a copy of the GNU Lesser General Public
    License along with the GNU C Library; if not, see
-   <https://www.gnu.org/licenses/>.  */
+   <https =//www.gnu.org/licenses/>.  */
 
 #include <stdint.h>
 
@@ -81,17 +81,17 @@ static const uint32_t to_ucs4[256] =
 
 static const struct gap from_idx[] =
 {
-  { start: 0x0000, end: 0x00be, idx:     0 },
-  { start: 0x00d7, end: 0x00d7, idx:   -24 },
-  { start: 0x00f7, end: 0x00f7, idx:   -55 },
-  { start: 0x05d0, end: 0x05ea, idx: -1295 },
-  { start: 0x200e, end: 0x200f, idx: -7986 },
-  { start: 0x2017, end: 0x2017, idx: -7993 },
-  { start: 0x2022, end: 0x2022, idx: -8003 },
-  { start: 0x202a, end: 0x202e, idx: -8010 },
-  { start: 0x203e, end: 0x203e, idx: -8025 },
-  { start: 0x20aa, end: 0x20ac, idx: -8132 },
-  { start: 0xffff, end: 0xffff, idx:     0 }
+  { .start = 0x0000, .end = 0x00be, .idx =     0 },
+  { .start = 0x00d7, .end = 0x00d7, .idx =   -24 },
+  { .start = 0x00f7, .end = 0x00f7, .idx =   -55 },
+  { .start = 0x05d0, .end = 0x05ea, .idx = -1295 },
+  { .start = 0x200e, .end = 0x200f, .idx = -7986 },
+  { .start = 0x2017, .end = 0x2017, .idx = -7993 },
+  { .start = 0x2022, .end = 0x2022, .idx = -8003 },
+  { .start = 0x202a, .end = 0x202e, .idx = -8010 },
+  { .start = 0x203e, .end = 0x203e, .idx = -8025 },
+  { .start = 0x20aa, .end = 0x20ac, .idx = -8132 },
+  { .start = 0xffff, .end = 0xffff, .idx =     0 }
 };
 
 static const char from_ucs4[] =
diff --git a/iconvdata/ibm16804.h b/iconvdata/ibm16804.h
index cb3a44db..684deb4b 100644
--- a/iconvdata/ibm16804.h
+++ b/iconvdata/ibm16804.h
@@ -14,7 +14,7 @@
 
    You should have received a copy of the GNU Lesser General Public
    License along with the GNU C Library; if not, see
-   <https://www.gnu.org/licenses/>.  */
+   <https =//www.gnu.org/licenses/>.  */
 
 #include <stdint.h>
 
@@ -87,17 +87,17 @@ static const uint32_t to_ucs4[256] =
 
 static const struct gap from_idx[] =
 {
-  { start: 0x0000, end: 0x00ad, idx:     0 },
-  { start: 0x00d7, end: 0x00d7, idx:   -41 },
-  { start: 0x00f7, end: 0x00f7, idx:   -72 },
-  { start: 0x060c, end: 0x060c, idx: -1372 },
-  { start: 0x061b, end: 0x064a, idx: -1386 },
-  { start: 0x0651, end: 0x0651, idx: -1392 },
-  { start: 0x0660, end: 0x066d, idx: -1406 },
-  { start: 0x2007, end: 0x200b, idx: -7959 },
-  { start: 0x20ac, end: 0x20ac, idx: -8119 },
-  { start: 0xfe7c, end: 0xfefc, idx: -64902 },
-  { start: 0xffff, end: 0xffff, idx:     0 }
+  { .start = 0x0000, .end = 0x00ad, .idx =     0 },
+  { .start = 0x00d7, .end = 0x00d7, .idx =   -41 },
+  { .start = 0x00f7, .end = 0x00f7, .idx =   -72 },
+  { .start = 0x060c, .end = 0x060c, .idx = -1372 },
+  { .start = 0x061b, .end = 0x064a, .idx = -1386 },
+  { .start = 0x0651, .end = 0x0651, .idx = -1392 },
+  { .start = 0x0660, .end = 0x066d, .idx = -1406 },
+  { .start = 0x2007, .end = 0x200b, .idx = -7959 },
+  { .start = 0x20ac, .end = 0x20ac, .idx = -8119 },
+  { .start = 0xfe7c, .end = 0xfefc, .idx = -64902 },
+  { .start = 0xffff, .end = 0xffff, .idx =     0 }
 };
 
 static const char from_ucs4[] =
diff --git a/iconvdata/ibm4517.h b/iconvdata/ibm4517.h
index e582a05a..286f2c43 100644
--- a/iconvdata/ibm4517.h
+++ b/iconvdata/ibm4517.h
@@ -14,7 +14,7 @@
 
    You should have received a copy of the GNU Lesser General Public
    License along with the GNU C Library; if not, see
-   <https://www.gnu.org/licenses/>.  */
+   <https =//www.gnu.org/licenses/>.  */
 
 #include <stdint.h>
 
@@ -83,20 +83,20 @@ static const uint32_t to_ucs4[256] =
   [0xf8] = 0x0038, [0xf9] = 0x0039, [0xff] = 0x009f
 };
 
-static const struct gap from_idx[] =
+  static const struct gap from_idx[] =
 {
-  { start: 0x0000, end: 0x00b5, idx:     0 },
-  { start: 0x00d7, end: 0x00d7, idx:   -33 },
-  { start: 0x00e1, end: 0x00e9, idx:   -42 },
-  { start: 0x00f7, end: 0x00fa, idx:   -55 },
-  { start: 0x060c, end: 0x060c, idx: -1352 },
-  { start: 0x061b, end: 0x064a, idx: -1366 },
-  { start: 0x0651, end: 0x0651, idx: -1372 },
-  { start: 0x0660, end: 0x066d, idx: -1386 },
-  { start: 0x2007, end: 0x200b, idx: -7939 },
-  { start: 0xf8f4, end: 0xf8f7, idx: -63467 },
-  { start: 0xfe70, end: 0xfefc, idx: -64867 },
-  { start: 0xffff, end: 0xffff, idx:     0 }
+  { .start = 0x0000, .end = 0x00b5, .idx =     0 },
+  { .start = 0x00d7, .end = 0x00d7, .idx =   -33 },
+  { .start = 0x00e1, .end = 0x00e9, .idx =   -42 },
+  { .start = 0x00f7, .end = 0x00fa, .idx =   -55 },
+  { .start = 0x060c, .end = 0x060c, .idx = -1352 },
+  { .start = 0x061b, .end = 0x064a, .idx = -1366 },
+  { .start = 0x0651, .end = 0x0651, .idx = -1372 },
+  { .start = 0x0660, .end = 0x066d, .idx = -1386 },
+  { .start = 0x2007, .end = 0x200b, .idx = -7939 },
+  { .start = 0xf8f4, .end = 0xf8f7, .idx = -63467 },
+  { .start = 0xfe70, .end = 0xfefc, .idx = -64867 },
+  { .start = 0xffff, .end = 0xffff, .idx =     0 }
 };
 
 static const char from_ucs4[] =
diff --git a/iconvdata/ibm4899.h b/iconvdata/ibm4899.h
index bcd62e96..58aac69f 100644
--- a/iconvdata/ibm4899.h
+++ b/iconvdata/ibm4899.h
@@ -14,7 +14,7 @@
 
    You should have received a copy of the GNU Lesser General Public
    License along with the GNU C Library; if not, see
-   <https://www.gnu.org/licenses/>.  */
+   <https =//www.gnu.org/licenses/>.  */
 
 #include <stdint.h>
 
@@ -65,14 +65,14 @@ static const uint32_t to_ucs4[256] =
 
 static const struct gap from_idx[] =
 {
-  { start: 0x0000, end: 0x005f, idx:     0 },
-  { start: 0x007c, end: 0x00a2, idx:   -28 },
-  { start: 0x00ac, end: 0x00ac, idx:   -37 },
-  { start: 0x05d0, end: 0x05ea, idx: -1352 },
-  { start: 0x200e, end: 0x200f, idx: -8043 },
-  { start: 0x202a, end: 0x202e, idx: -8069 },
-  { start: 0x20aa, end: 0x20ac, idx: -8192 },
-  { start: 0xffff, end: 0xffff, idx:     0 }
+  { .start = 0x0000, .end = 0x005f, .idx =     0 },
+  { .start = 0x007c, .end = 0x00a2, .idx =   -28 },
+  { .start = 0x00ac, .end = 0x00ac, .idx =   -37 },
+  { .start = 0x05d0, .end = 0x05ea, .idx = -1352 },
+  { .start = 0x200e, .end = 0x200f, .idx = -8043 },
+  { .start = 0x202a, .end = 0x202e, .idx = -8069 },
+  { .start = 0x20aa, .end = 0x20ac, .idx = -8192 },
+  { .start = 0xffff, .end = 0xffff, .idx =     0 }
 };
 
 static const char from_ucs4[] =
diff --git a/iconvdata/ibm4909.h b/iconvdata/ibm4909.h
index 379d14a2..d3713108 100644
--- a/iconvdata/ibm4909.h
+++ b/iconvdata/ibm4909.h
@@ -14,7 +14,7 @@
 
    You should have received a copy of the GNU Lesser General Public
    License along with the GNU C Library; if not, see
-   <https://www.gnu.org/licenses/>.  */
+   <https =//www.gnu.org/licenses/>.  */
 
 #include <stdint.h>
 
@@ -87,12 +87,12 @@ static const uint32_t to_ucs4[256] =
 
 static const struct gap from_idx[] =
 {
-  { start: 0x0000, end: 0x00bd, idx:     0 },
-  { start: 0x0385, end: 0x03ce, idx:  -711 },
-  { start: 0x03d5, end: 0x03d5, idx:  -717 },
-  { start: 0x2015, end: 0x2019, idx: -7948 },
-  { start: 0x20ac, end: 0x20ac, idx: -8094 },
-  { start: 0xffff, end: 0xffff, idx:     0 }
+  { .start = 0x0000, .end = 0x00bd, .idx =     0 },
+  { .start = 0x0385, .end = 0x03ce, .idx =  -711 },
+  { .start = 0x03d5, .end = 0x03d5, .idx =  -717 },
+  { .start = 0x2015, .end = 0x2019, .idx = -7948 },
+  { .start = 0x20ac, .end = 0x20ac, .idx = -8094 },
+  { .start = 0xffff, .end = 0xffff, .idx =     0 }
 };
 
 static const char from_ucs4[] =
diff --git a/iconvdata/ibm4971.h b/iconvdata/ibm4971.h
index f7a186d5..89c0fc50 100644
--- a/iconvdata/ibm4971.h
+++ b/iconvdata/ibm4971.h
@@ -14,7 +14,7 @@
 
    You should have received a copy of the GNU Lesser General Public
    License along with the GNU C Library; if not, see
-   <https://www.gnu.org/licenses/>.  */
+   <https =//www.gnu.org/licenses/>.  */
 
 #include <stdint.h>
 
@@ -87,12 +87,12 @@ static const uint32_t to_ucs4[256] =
 
 static const struct gap from_idx[] =
 {
-  { start: 0x0000, end: 0x00bd, idx:     0 },
-  { start: 0x0385, end: 0x03ce, idx:  -711 },
-  { start: 0x03d5, end: 0x03d5, idx:  -717 },
-  { start: 0x2015, end: 0x2019, idx: -7948 },
-  { start: 0x20ac, end: 0x20ac, idx: -8094 },
-  { start: 0xffff, end: 0xffff, idx:     0 }
+  { .start = 0x0000, .end = 0x00bd, .idx =     0 },
+  { .start = 0x0385, .end = 0x03ce, .idx =  -711 },
+  { .start = 0x03d5, .end = 0x03d5, .idx =  -717 },
+  { .start = 0x2015, .end = 0x2019, .idx = -7948 },
+  { .start = 0x20ac, .end = 0x20ac, .idx = -8094 },
+  { .start = 0xffff, .end = 0xffff, .idx =     0 }
 };
 
 static const char from_ucs4[] =
diff --git a/iconvdata/ibm5347.h b/iconvdata/ibm5347.h
index 9efc6f5f..b7e52d1c 100644
--- a/iconvdata/ibm5347.h
+++ b/iconvdata/ibm5347.h
@@ -14,7 +14,7 @@
 
    You should have received a copy of the GNU Lesser General Public
    License along with the GNU C Library; if not, see
-   <https://www.gnu.org/licenses/>.  */
+   <https =//www.gnu.org/licenses/>.  */
 
 #include <stdint.h>
 
@@ -88,18 +88,18 @@ static const uint32_t to_ucs4[256] =
 
 static const struct gap from_idx[] =
 {
-  { start: 0x0000, end: 0x007f, idx:     0 },
-  { start: 0x0098, end: 0x0098, idx:   -24 },
-  { start: 0x00a0, end: 0x00bb, idx:   -31 },
-  { start: 0x0401, end: 0x045f, idx:  -868 },
-  { start: 0x0490, end: 0x0491, idx:  -916 },
-  { start: 0x2013, end: 0x2026, idx: -7957 },
-  { start: 0x2030, end: 0x2030, idx: -7966 },
-  { start: 0x2039, end: 0x203a, idx: -7974 },
-  { start: 0x20ac, end: 0x20ac, idx: -8087 },
-  { start: 0x2116, end: 0x2116, idx: -8192 },
-  { start: 0x2122, end: 0x2122, idx: -8203 },
-  { start: 0xffff, end: 0xffff, idx:     0 }
+  { .start = 0x0000, .end = 0x007f, .idx =     0 },
+  { .start = 0x0098, .end = 0x0098, .idx =   -24 },
+  { .start = 0x00a0, .end = 0x00bb, .idx =   -31 },
+  { .start = 0x0401, .end = 0x045f, .idx =  -868 },
+  { .start = 0x0490, .end = 0x0491, .idx =  -916 },
+  { .start = 0x2013, .end = 0x2026, .idx = -7957 },
+  { .start = 0x2030, .end = 0x2030, .idx = -7966 },
+  { .start = 0x2039, .end = 0x203a, .idx = -7974 },
+  { .start = 0x20ac, .end = 0x20ac, .idx = -8087 },
+  { .start = 0x2116, .end = 0x2116, .idx = -8192 },
+  { .start = 0x2122, .end = 0x2122, .idx = -8203 },
+  { .start = 0xffff, .end = 0xffff, .idx =     0 }
 };
 
 static const char from_ucs4[] =
diff --git a/iconvdata/ibm803.h b/iconvdata/ibm803.h
index 30e9236c..a38bfc6c 100644
--- a/iconvdata/ibm803.h
+++ b/iconvdata/ibm803.h
@@ -14,7 +14,7 @@
 
    You should have received a copy of the GNU Lesser General Public
    License along with the GNU C Library; if not, see
-   <https://www.gnu.org/licenses/>.  */
+   <https =//www.gnu.org/licenses/>.  */
 
 #include <stdint.h>
 
@@ -63,11 +63,11 @@ static const uint32_t to_ucs4[256] =
 
 static const struct gap from_idx[] =
 {
-  { start: 0x0000, end: 0x005f, idx:     0 },
-  { start: 0x007c, end: 0x00a2, idx:   -28 },
-  { start: 0x00ac, end: 0x00ac, idx:   -37 },
-  { start: 0x05d0, end: 0x05ea, idx: -1352 },
-  { start: 0xffff, end: 0xffff, idx:     0 }
+  { .start = 0x0000, .end = 0x005f, .idx =     0 },
+  { .start = 0x007c, .end = 0x00a2, .idx =   -28 },
+  { .start = 0x00ac, .end = 0x00ac, .idx =   -37 },
+  { .start = 0x05d0, .end = 0x05ea, .idx = -1352 },
+  { .start = 0xffff, .end = 0xffff, .idx =     0 }
 };
 
 static const char from_ucs4[] =
diff --git a/iconvdata/ibm901.h b/iconvdata/ibm901.h
index e22401e6..23b02da2 100644
--- a/iconvdata/ibm901.h
+++ b/iconvdata/ibm901.h
@@ -14,7 +14,7 @@
 
    You should have received a copy of the GNU Lesser General Public
    License along with the GNU C Library; if not, see
-   <https://www.gnu.org/licenses/>.  */
+   <https =//www.gnu.org/licenses/>.  */
 
 #include <stdint.h>
 
@@ -88,39 +88,39 @@ static const uint32_t to_ucs4[256] =
 
 static const struct gap from_idx[] =
 {
-  { start: 0x0000, end: 0x00c9, idx:     0 },
-  { start: 0x00d3, end: 0x00e9, idx:    -9 },
-  { start: 0x00f3, end: 0x0119, idx:   -18 },
-  { start: 0x0122, end: 0x0123, idx:   -26 },
-  { start: 0x012a, end: 0x012f, idx:   -32 },
-  { start: 0x0136, end: 0x014d, idx:   -38 },
-  { start: 0x0156, end: 0x0161, idx:   -46 },
-  { start: 0x016a, end: 0x016b, idx:   -54 },
-  { start: 0x0172, end: 0x017e, idx:   -60 },
-  { start: 0x2017, end: 0x2022, idx: -7892 },
-  { start: 0x203c, end: 0x203e, idx: -7917 },
-  { start: 0x20ac, end: 0x20ac, idx: -8026 },
-  { start: 0x2190, end: 0x2195, idx: -8253 },
-  { start: 0x21a8, end: 0x21a8, idx: -8271 },
-  { start: 0x221f, end: 0x221f, idx: -8389 },
-  { start: 0x2500, end: 0x2502, idx: -9125 },
-  { start: 0x250c, end: 0x251c, idx: -9134 },
-  { start: 0x2524, end: 0x2524, idx: -9141 },
-  { start: 0x252c, end: 0x252c, idx: -9148 },
-  { start: 0x2534, end: 0x2534, idx: -9155 },
-  { start: 0x253c, end: 0x253c, idx: -9162 },
-  { start: 0x2550, end: 0x256c, idx: -9181 },
-  { start: 0x2580, end: 0x2588, idx: -9200 },
-  { start: 0x2591, end: 0x2593, idx: -9208 },
-  { start: 0x25a0, end: 0x25a0, idx: -9220 },
-  { start: 0x25ac, end: 0x25b2, idx: -9231 },
-  { start: 0x25ba, end: 0x25bc, idx: -9238 },
-  { start: 0x25c4, end: 0x25c4, idx: -9245 },
-  { start: 0x25cb, end: 0x25cb, idx: -9251 },
-  { start: 0x25d8, end: 0x25d9, idx: -9263 },
-  { start: 0x263a, end: 0x2642, idx: -9359 },
-  { start: 0x2660, end: 0x266c, idx: -9388 },
-  { start: 0xffff, end: 0xffff, idx:     0 }
+  { .start = 0x0000, .end = 0x00c9, .idx =     0 },
+  { .start = 0x00d3, .end = 0x00e9, .idx =    -9 },
+  { .start = 0x00f3, .end = 0x0119, .idx =   -18 },
+  { .start = 0x0122, .end = 0x0123, .idx =   -26 },
+  { .start = 0x012a, .end = 0x012f, .idx =   -32 },
+  { .start = 0x0136, .end = 0x014d, .idx =   -38 },
+  { .start = 0x0156, .end = 0x0161, .idx =   -46 },
+  { .start = 0x016a, .end = 0x016b, .idx =   -54 },
+  { .start = 0x0172, .end = 0x017e, .idx =   -60 },
+  { .start = 0x2017, .end = 0x2022, .idx = -7892 },
+  { .start = 0x203c, .end = 0x203e, .idx = -7917 },
+  { .start = 0x20ac, .end = 0x20ac, .idx = -8026 },
+  { .start = 0x2190, .end = 0x2195, .idx = -8253 },
+  { .start = 0x21a8, .end = 0x21a8, .idx = -8271 },
+  { .start = 0x221f, .end = 0x221f, .idx = -8389 },
+  { .start = 0x2500, .end = 0x2502, .idx = -9125 },
+  { .start = 0x250c, .end = 0x251c, .idx = -9134 },
+  { .start = 0x2524, .end = 0x2524, .idx = -9141 },
+  { .start = 0x252c, .end = 0x252c, .idx = -9148 },
+  { .start = 0x2534, .end = 0x2534, .idx = -9155 },
+  { .start = 0x253c, .end = 0x253c, .idx = -9162 },
+  { .start = 0x2550, .end = 0x256c, .idx = -9181 },
+  { .start = 0x2580, .end = 0x2588, .idx = -9200 },
+  { .start = 0x2591, .end = 0x2593, .idx = -9208 },
+  { .start = 0x25a0, .end = 0x25a0, .idx = -9220 },
+  { .start = 0x25ac, .end = 0x25b2, .idx = -9231 },
+  { .start = 0x25ba, .end = 0x25bc, .idx = -9238 },
+  { .start = 0x25c4, .end = 0x25c4, .idx = -9245 },
+  { .start = 0x25cb, .end = 0x25cb, .idx = -9251 },
+  { .start = 0x25d8, .end = 0x25d9, .idx = -9263 },
+  { .start = 0x263a, .end = 0x2642, .idx = -9359 },
+  { .start = 0x2660, .end = 0x266c, .idx = -9388 },
+  { .start = 0xffff, .end = 0xffff, .idx =     0 }
 };
 
 static const char from_ucs4[] =
diff --git a/iconvdata/ibm902.h b/iconvdata/ibm902.h
index 74de50e0..e7d033e8 100644
--- a/iconvdata/ibm902.h
+++ b/iconvdata/ibm902.h
@@ -14,7 +14,7 @@
 
    You should have received a copy of the GNU Lesser General Public
    License along with the GNU C Library; if not, see
-   <https://www.gnu.org/licenses/>.  */
+   <https =//www.gnu.org/licenses/>.  */
 
 #include <stdint.h>
 
@@ -88,35 +88,35 @@ static const uint32_t to_ucs4[256] =
 
 static const struct gap from_idx[] =
 {
-  { start: 0x0000, end: 0x00ff, idx:     0 },
-  { start: 0x0160, end: 0x0161, idx:   -96 },
-  { start: 0x017d, end: 0x017e, idx:  -123 },
-  { start: 0x2017, end: 0x2017, idx: -7955 },
-  { start: 0x2022, end: 0x2022, idx: -7965 },
-  { start: 0x203c, end: 0x203e, idx: -7990 },
-  { start: 0x20ac, end: 0x20ac, idx: -8099 },
-  { start: 0x2190, end: 0x2195, idx: -8326 },
-  { start: 0x21a8, end: 0x21a8, idx: -8344 },
-  { start: 0x221f, end: 0x221f, idx: -8462 },
-  { start: 0x2264, end: 0x2265, idx: -8530 },
-  { start: 0x2500, end: 0x2502, idx: -9196 },
-  { start: 0x250c, end: 0x251c, idx: -9205 },
-  { start: 0x2524, end: 0x2524, idx: -9212 },
-  { start: 0x252c, end: 0x252c, idx: -9219 },
-  { start: 0x2534, end: 0x2534, idx: -9226 },
-  { start: 0x253c, end: 0x253c, idx: -9233 },
-  { start: 0x2550, end: 0x256c, idx: -9252 },
-  { start: 0x2580, end: 0x2588, idx: -9271 },
-  { start: 0x2591, end: 0x2593, idx: -9279 },
-  { start: 0x25a0, end: 0x25a0, idx: -9291 },
-  { start: 0x25ac, end: 0x25b2, idx: -9302 },
-  { start: 0x25ba, end: 0x25bc, idx: -9309 },
-  { start: 0x25c4, end: 0x25c4, idx: -9316 },
-  { start: 0x25cb, end: 0x25cb, idx: -9322 },
-  { start: 0x25d8, end: 0x25d9, idx: -9334 },
-  { start: 0x263a, end: 0x2642, idx: -9430 },
-  { start: 0x2660, end: 0x266c, idx: -9459 },
-  { start: 0xffff, end: 0xffff, idx:     0 }
+  { .start = 0x0000, .end = 0x00ff, .idx =     0 },
+  { .start = 0x0160, .end = 0x0161, .idx =   -96 },
+  { .start = 0x017d, .end = 0x017e, .idx =  -123 },
+  { .start = 0x2017, .end = 0x2017, .idx = -7955 },
+  { .start = 0x2022, .end = 0x2022, .idx = -7965 },
+  { .start = 0x203c, .end = 0x203e, .idx = -7990 },
+  { .start = 0x20ac, .end = 0x20ac, .idx = -8099 },
+  { .start = 0x2190, .end = 0x2195, .idx = -8326 },
+  { .start = 0x21a8, .end = 0x21a8, .idx = -8344 },
+  { .start = 0x221f, .end = 0x221f, .idx = -8462 },
+  { .start = 0x2264, .end = 0x2265, .idx = -8530 },
+  { .start = 0x2500, .end = 0x2502, .idx = -9196 },
+  { .start = 0x250c, .end = 0x251c, .idx = -9205 },
+  { .start = 0x2524, .end = 0x2524, .idx = -9212 },
+  { .start = 0x252c, .end = 0x252c, .idx = -9219 },
+  { .start = 0x2534, .end = 0x2534, .idx = -9226 },
+  { .start = 0x253c, .end = 0x253c, .idx = -9233 },
+  { .start = 0x2550, .end = 0x256c, .idx = -9252 },
+  { .start = 0x2580, .end = 0x2588, .idx = -9271 },
+  { .start = 0x2591, .end = 0x2593, .idx = -9279 },
+  { .start = 0x25a0, .end = 0x25a0, .idx = -9291 },
+  { .start = 0x25ac, .end = 0x25b2, .idx = -9302 },
+  { .start = 0x25ba, .end = 0x25bc, .idx = -9309 },
+  { .start = 0x25c4, .end = 0x25c4, .idx = -9316 },
+  { .start = 0x25cb, .end = 0x25cb, .idx = -9322 },
+  { .start = 0x25d8, .end = 0x25d9, .idx = -9334 },
+  { .start = 0x263a, .end = 0x2642, .idx = -9430 },
+  { .start = 0x2660, .end = 0x266c, .idx = -9459 },
+  { .start = 0xffff, .end = 0xffff, .idx =     0 }
 };
 
 static const char from_ucs4[] =
diff --git a/iconvdata/ibm9030.h b/iconvdata/ibm9030.h
index b0730eba..9d132202 100644
--- a/iconvdata/ibm9030.h
+++ b/iconvdata/ibm9030.h
@@ -14,7 +14,7 @@
 
    You should have received a copy of the GNU Lesser General Public
    License along with the GNU C Library; if not, see
-   <https://www.gnu.org/licenses/>.  */
+   <https =//www.gnu.org/licenses/>.  */
 
 #include <stdint.h>
 
@@ -88,9 +88,9 @@ static const uint32_t to_ucs4[256] =
 
 static const struct gap from_idx[] =
 {
-  { start: 0x0000, end: 0x00ac, idx:     0 },
-  { start: 0x0e01, end: 0x0e5b, idx: -3412 },
-  { start: 0xffff, end: 0xffff, idx:     0 }
+  { .start = 0x0000, .end = 0x00ac, .idx =     0 },
+  { .start = 0x0e01, .end = 0x0e5b, .idx = -3412 },
+  { .start = 0xffff, .end = 0xffff, .idx =     0 }
 };
 
 static const char from_ucs4[] =
diff --git a/iconvdata/ibm9066.h b/iconvdata/ibm9066.h
index 254f17b3..92dfdf1b 100644
--- a/iconvdata/ibm9066.h
+++ b/iconvdata/ibm9066.h
@@ -14,7 +14,7 @@
 
    You should have received a copy of the GNU Lesser General Public
    License along with the GNU C Library; if not, see
-   <https://www.gnu.org/licenses/>.  */
+   <https =//www.gnu.org/licenses/>.  */
 
 #include <stdint.h>
 
@@ -80,10 +80,10 @@ static const uint32_t to_ucs4[256] =
 
 static const struct gap from_idx[] =
 {
-  { start: 0x0000, end: 0x007f, idx:     0 },
-  { start: 0x00a0, end: 0x00ac, idx:   -32 },
-  { start: 0x0e01, end: 0x0e5b, idx: -3444 },
-  { start: 0xffff, end: 0xffff, idx:     0 }
+  { .start = 0x0000, .end = 0x007f, .idx =     0 },
+  { .start = 0x00a0, .end = 0x00ac, .idx =   -32 },
+  { .start = 0x0e01, .end = 0x0e5b, .idx = -3444 },
+  { .start = 0xffff, .end = 0xffff, .idx =     0 }
 };
 
 static const char from_ucs4[] =
diff --git a/iconvdata/ibm921.h b/iconvdata/ibm921.h
index 629aea61..b558ca7e 100644
--- a/iconvdata/ibm921.h
+++ b/iconvdata/ibm921.h
@@ -14,7 +14,7 @@
 
    You should have received a copy of the GNU Lesser General Public
    License along with the GNU C Library; if not, see
-   <https://www.gnu.org/licenses/>.  */
+   <https =//www.gnu.org/licenses/>.  */
 
 #include <stdint.h>
 
@@ -88,17 +88,17 @@ static const uint32_t to_ucs4[256] =
 
 static const struct gap from_idx[] =
 {
-  { start: 0x0000, end: 0x00c9, idx:     0 },
-  { start: 0x00d3, end: 0x00e9, idx:    -9 },
-  { start: 0x00f3, end: 0x0119, idx:   -18 },
-  { start: 0x0122, end: 0x0123, idx:   -26 },
-  { start: 0x012a, end: 0x012f, idx:   -32 },
-  { start: 0x0136, end: 0x014d, idx:   -38 },
-  { start: 0x0156, end: 0x0161, idx:   -46 },
-  { start: 0x016a, end: 0x016b, idx:   -54 },
-  { start: 0x0172, end: 0x017e, idx:   -60 },
-  { start: 0x2019, end: 0x201e, idx: -7894 },
-  { start: 0xffff, end: 0xffff, idx:     0 }
+  { .start = 0x0000, .end = 0x00c9, .idx =     0 },
+  { .start = 0x00d3, .end = 0x00e9, .idx =    -9 },
+  { .start = 0x00f3, .end = 0x0119, .idx =   -18 },
+  { .start = 0x0122, .end = 0x0123, .idx =   -26 },
+  { .start = 0x012a, .end = 0x012f, .idx =   -32 },
+  { .start = 0x0136, .end = 0x014d, .idx =   -38 },
+  { .start = 0x0156, .end = 0x0161, .idx =   -46 },
+  { .start = 0x016a, .end = 0x016b, .idx =   -54 },
+  { .start = 0x0172, .end = 0x017e, .idx =   -60 },
+  { .start = 0x2019, .end = 0x201e, .idx = -7894 },
+  { .start = 0xffff, .end = 0xffff, .idx =     0 }
 };
 
 static const char from_ucs4[] =
diff --git a/iconvdata/ibm9448.h b/iconvdata/ibm9448.h
index c6be3dec..bdb93416 100644
--- a/iconvdata/ibm9448.h
+++ b/iconvdata/ibm9448.h
@@ -14,7 +14,7 @@
 
    You should have received a copy of the GNU Lesser General Public
    License along with the GNU C Library; if not, see
-   <https://www.gnu.org/licenses/>.  */
+   <https =//www.gnu.org/licenses/>.  */
 
 #include <stdint.h>
 
@@ -88,37 +88,37 @@ static const uint32_t to_ucs4[256] =
 
 static const struct gap from_idx[] =
 {
-  { start: 0x0000, end: 0x007f, idx:     0 },
-  { start: 0x00a0, end: 0x00be, idx:   -32 },
-  { start: 0x00d7, end: 0x00d7, idx:   -56 },
-  { start: 0x00e0, end: 0x00fc, idx:   -64 },
-  { start: 0x0152, end: 0x0153, idx:  -149 },
-  { start: 0x0191, end: 0x0192, idx:  -210 },
-  { start: 0x02c6, end: 0x02cb, idx:  -517 },
-  { start: 0x060c, end: 0x060c, idx: -1349 },
-  { start: 0x061b, end: 0x0652, idx: -1363 },
-  { start: 0x0660, end: 0x066c, idx: -1376 },
-  { start: 0x0679, end: 0x067e, idx: -1388 },
-  { start: 0x0686, end: 0x0688, idx: -1395 },
-  { start: 0x0691, end: 0x0691, idx: -1403 },
-  { start: 0x0698, end: 0x0698, idx: -1409 },
-  { start: 0x06a9, end: 0x06af, idx: -1425 },
-  { start: 0x06ba, end: 0x06c1, idx: -1435 },
-  { start: 0x06cc, end: 0x06d2, idx: -1445 },
-  { start: 0x06f0, end: 0x06f9, idx: -1474 },
-  { start: 0x200c, end: 0x2026, idx: -7892 },
-  { start: 0x2030, end: 0x2030, idx: -7901 },
-  { start: 0x2039, end: 0x203e, idx: -7909 },
-  { start: 0x20ac, end: 0x20ac, idx: -8018 },
-  { start: 0x2122, end: 0x2122, idx: -8135 },
-  { start: 0xfb56, end: 0xfb59, idx: -63994 },
-  { start: 0xfb66, end: 0xfb69, idx: -64006 },
-  { start: 0xfb7a, end: 0xfb7d, idx: -64022 },
-  { start: 0xfb88, end: 0xfb95, idx: -64032 },
-  { start: 0xfb9e, end: 0xfb9f, idx: -64040 },
-  { start: 0xfba6, end: 0xfbaf, idx: -64046 },
-  { start: 0xfe70, end: 0xfef4, idx: -64750 },
-  { start: 0xffff, end: 0xffff, idx:     0 }
+  { .start = 0x0000, .end = 0x007f, .idx =     0 },
+  { .start = 0x00a0, .end = 0x00be, .idx =   -32 },
+  { .start = 0x00d7, .end = 0x00d7, .idx =   -56 },
+  { .start = 0x00e0, .end = 0x00fc, .idx =   -64 },
+  { .start = 0x0152, .end = 0x0153, .idx =  -149 },
+  { .start = 0x0191, .end = 0x0192, .idx =  -210 },
+  { .start = 0x02c6, .end = 0x02cb, .idx =  -517 },
+  { .start = 0x060c, .end = 0x060c, .idx = -1349 },
+  { .start = 0x061b, .end = 0x0652, .idx = -1363 },
+  { .start = 0x0660, .end = 0x066c, .idx = -1376 },
+  { .start = 0x0679, .end = 0x067e, .idx = -1388 },
+  { .start = 0x0686, .end = 0x0688, .idx = -1395 },
+  { .start = 0x0691, .end = 0x0691, .idx = -1403 },
+  { .start = 0x0698, .end = 0x0698, .idx = -1409 },
+  { .start = 0x06a9, .end = 0x06af, .idx = -1425 },
+  { .start = 0x06ba, .end = 0x06c1, .idx = -1435 },
+  { .start = 0x06cc, .end = 0x06d2, .idx = -1445 },
+  { .start = 0x06f0, .end = 0x06f9, .idx = -1474 },
+  { .start = 0x200c, .end = 0x2026, .idx = -7892 },
+  { .start = 0x2030, .end = 0x2030, .idx = -7901 },
+  { .start = 0x2039, .end = 0x203e, .idx = -7909 },
+  { .start = 0x20ac, .end = 0x20ac, .idx = -8018 },
+  { .start = 0x2122, .end = 0x2122, .idx = -8135 },
+  { .start = 0xfb56, .end = 0xfb59, .idx = -63994 },
+  { .start = 0xfb66, .end = 0xfb69, .idx = -64006 },
+  { .start = 0xfb7a, .end = 0xfb7d, .idx = -64022 },
+  { .start = 0xfb88, .end = 0xfb95, .idx = -64032 },
+  { .start = 0xfb9e, .end = 0xfb9f, .idx = -64040 },
+  { .start = 0xfba6, .end = 0xfbaf, .idx = -64046 },
+  { .start = 0xfe70, .end = 0xfef4, .idx = -64750 },
+  { .start = 0xffff, .end = 0xffff, .idx =     0 }
 };
 
 static const char from_ucs4[] =
diff --git a/iconvdata/iso-2022-cn-ext.c b/iconvdata/iso-2022-cn-ext.c
index e09f358c..7d84560b 100644
--- a/iconvdata/iso-2022-cn-ext.c
+++ b/iconvdata/iso-2022-cn-ext.c
@@ -387,6 +387,10 @@ enum
 #define LOOP_NEED_FLAGS
 #include <iconv/loop.c>
 
+/* clang issues an warning adding 'int' to a string does not append
+   to the string, however it is exactly what code means here.  */
+DIAG_PUSH_NEEDS_COMMENT_CLANG;
+DIAG_IGNORE_NEEDS_COMMENT_CLANG (13, "-Wstring-plus-int");
 
 /* Next, define the other direction.  */
 #define MIN_NEEDED_INPUT	TO_LOOP_MIN_NEEDED_FROM
@@ -394,16 +398,6 @@ enum
 #define MIN_NEEDED_OUTPUT	TO_LOOP_MIN_NEEDED_TO
 #define MAX_NEEDED_OUTPUT	TO_LOOP_MAX_NEEDED_TO
 #define LOOPFCT			TO_LOOP
-/* With GCC 5.3 when compiling with -Os the compiler emits a warning
-   that buf[0] and buf[1] may be used uninitialized.  This can only
-   happen in the case where tmpbuf[3] is used, and in that case the
-   write to the tmpbuf[1] and tmpbuf[2] was assured because
-   ucs4_to_cns11643 would have filled in those entries.  The difficulty
-   is in getting the compiler to see this logic because tmpbuf[0] is
-   involved in determining the code page and is the indicator that
-   tmpbuf[2] is initialized.  */
-DIAG_PUSH_NEEDS_COMMENT;
-DIAG_IGNORE_Os_NEEDS_COMMENT (5, "-Wmaybe-uninitialized");
 #define BODY \
   {									      \
     uint32_t ch;							      \
@@ -655,7 +649,6 @@ DIAG_IGNORE_Os_NEEDS_COMMENT (5, "-Wmaybe-uninitialized");
     /* Now that we wrote the output increment the input pointer.  */	      \
     inptr += 4;								      \
   }
-DIAG_POP_NEEDS_COMMENT;
 #define EXTRA_LOOP_DECLS	, int *setp
 #define INIT_PARAMS		int set = (*setp >> 3) & CURRENT_MASK; \
 				int ann = (*setp >> 3) & ~CURRENT_MASK
@@ -669,6 +662,7 @@ DIAG_POP_NEEDS_COMMENT;
 #define LOOP_NEED_FLAGS
 #include <iconv/loop.c>
 
+DIAG_POP_NEEDS_COMMENT_CLANG;
 
 /* Now define the toplevel functions.  */
 #include <iconv/skeleton.c>
diff --git a/iconvdata/iso-2022-cn.c b/iconvdata/iso-2022-cn.c
index 9d605fe1..0de18c57 100644
--- a/iconvdata/iso-2022-cn.c
+++ b/iconvdata/iso-2022-cn.c
@@ -227,6 +227,10 @@ enum
 #define UPDATE_PARAMS		*setp = set | ann
 #include <iconv/loop.c>
 
+/* clang issues an warning adding 'int' to a string does not append
+   to the string, however it is exactly what code means here.  */
+DIAG_PUSH_NEEDS_COMMENT_CLANG;
+DIAG_IGNORE_NEEDS_COMMENT_CLANG (13, "-Wstring-plus-int");
 
 /* Next, define the other direction.  */
 #define MIN_NEEDED_INPUT	TO_LOOP_MIN_NEEDED_FROM
@@ -401,6 +405,7 @@ enum
 #define UPDATE_PARAMS		*setp = set | ann
 #include <iconv/loop.c>
 
+DIAG_POP_NEEDS_COMMENT_CLANG;
 
 /* Now define the toplevel functions.  */
 #include <iconv/skeleton.c>
diff --git a/include/alloc_buffer.h b/include/alloc_buffer.h
index be33e8b6..5660642d 100644
--- a/include/alloc_buffer.h
+++ b/include/alloc_buffer.h
@@ -83,6 +83,10 @@
 #include <stdlib.h>
 #include <sys/param.h>
 
+#ifdef _ISOMAC
+# define libc_hidden_proto3(name, proto) name proto
+#endif
+
 /* struct alloc_buffer objects refer to a region of bytes in memory of a
    fixed size.  The functions below can be used to allocate single
    objects and arrays from this memory region, or write to its end.
@@ -113,7 +117,8 @@ enum
   };
 
 /* Internal function.  Terminate the process using __libc_fatal.  */
-void __libc_alloc_buffer_create_failure (void *start, size_t size);
+void libc_hidden_proto3 (__libc_alloc_buffer_create_failure,
+			 (void *start, size_t size));
 
 /* Create a new allocation buffer.  The byte range from START to START
    + SIZE - 1 must be valid, and the allocation buffer allocates
@@ -130,7 +135,8 @@ alloc_buffer_create (void *start, size_t size)
 }
 
 /* Internal function.  See alloc_buffer_allocate below.  */
-struct alloc_buffer __libc_alloc_buffer_allocate (size_t size, void **pptr)
+struct alloc_buffer libc_hidden_proto3 (__libc_alloc_buffer_allocate,
+					(size_t size, void **pptr))
   __attribute__ ((nonnull (2)));
 
 /* Allocate a buffer of SIZE bytes using malloc.  The returned buffer
@@ -329,9 +335,9 @@ __alloc_buffer_next (struct alloc_buffer *buf, size_t align)
    (buf, __alloc_buffer_assert_align (__alignof__ (type))))
 
 /* Internal function.  Allocate an array.  */
-void * __libc_alloc_buffer_alloc_array (struct alloc_buffer *buf,
-					size_t size, size_t align,
-					size_t count)
+void * libc_hidden_proto3 (__libc_alloc_buffer_alloc_array,
+			   (struct alloc_buffer *buf, size_t size, size_t align,
+			    size_t count))
   __attribute__ ((nonnull (1)));
 
 /* Obtain a TYPE * pointer to an array of COUNT objects in BUF of
@@ -346,8 +352,9 @@ void * __libc_alloc_buffer_alloc_array (struct alloc_buffer *buf,
     count))
 
 /* Internal function.  See alloc_buffer_copy_bytes below.  */
-struct alloc_buffer __libc_alloc_buffer_copy_bytes (struct alloc_buffer,
-						    const void *, size_t)
+struct alloc_buffer libc_hidden_proto3 (__libc_alloc_buffer_copy_bytes,
+					(struct alloc_buffer, const void *,
+					 size_t))
   __attribute__ ((nonnull (2)));
 
 /* Copy SIZE bytes starting at SRC into the buffer.  If there is not
@@ -360,8 +367,8 @@ alloc_buffer_copy_bytes (struct alloc_buffer *buf, const void *src, size_t size)
 }
 
 /* Internal function.  See alloc_buffer_copy_string below.  */
-struct alloc_buffer __libc_alloc_buffer_copy_string (struct alloc_buffer,
-						     const char *)
+struct alloc_buffer libc_hidden_proto3 (__libc_alloc_buffer_copy_string,
+					(struct alloc_buffer, const char *))
   __attribute__ ((nonnull (2)));
 
 /* Copy the string at SRC into the buffer, including its null
@@ -377,12 +384,4 @@ alloc_buffer_copy_string (struct alloc_buffer *buf, const char *src)
   return result;
 }
 
-#ifndef _ISOMAC
-libc_hidden_proto (__libc_alloc_buffer_alloc_array)
-libc_hidden_proto (__libc_alloc_buffer_allocate)
-libc_hidden_proto (__libc_alloc_buffer_copy_bytes)
-libc_hidden_proto (__libc_alloc_buffer_copy_string)
-libc_hidden_proto (__libc_alloc_buffer_create_failure)
-#endif
-
 #endif /* _ALLOC_BUFFER_H */
diff --git a/include/allocate_once.h b/include/allocate_once.h
index a487d641..3d267faf 100644
--- a/include/allocate_once.h
+++ b/include/allocate_once.h
@@ -21,12 +21,15 @@
 
 #include <atomic.h>
 
+#ifdef _ISOMAC
+# define hidden_proto3(name, proto) name proto
+#endif
+
 /* Slow path for allocate_once; see below.  */
-void *__libc_allocate_once_slow (void **__place,
-                                 void *(*__allocate) (void *__closure),
-                                 void (*__deallocate) (void *__closure,
-                                                       void *__ptr),
-                                 void *__closure);
+void * hidden_proto3 (__libc_allocate_once_slow,
+		      (void **__place, void *(*__allocate) (void *__closure),
+		       void (*__deallocate) (void *__closure, void *__ptr),
+		       void *__closure));
 
 /* Return an a pointer to an allocated and initialized data structure.
    If this function returns a non-NULL value, the caller can assume
@@ -88,8 +91,4 @@ allocate_once (void **__place, void *(*__allocate) (void *__closure),
                                       __closure);
 }
 
-#ifndef _ISOMAC
-libc_hidden_proto (__libc_allocate_once_slow)
-#endif
-
 #endif /* _ALLOCATE_ONCE_H */
diff --git a/include/bits/argp-ldbl.h b/include/bits/argp-ldbl.h
deleted file mode 100644
index 7c1a343d..00000000
--- a/include/bits/argp-ldbl.h
+++ /dev/null
@@ -1 +0,0 @@
-#include <argp/bits/argp-ldbl.h>
diff --git a/include/bits/err-ldbl.h b/include/bits/err-ldbl.h
deleted file mode 100644
index aa04305e..00000000
--- a/include/bits/err-ldbl.h
+++ /dev/null
@@ -1 +0,0 @@
-#include <misc/bits/err-ldbl.h>
diff --git a/include/bits/error-ldbl.h b/include/bits/error-ldbl.h
deleted file mode 100644
index 84b26468..00000000
--- a/include/bits/error-ldbl.h
+++ /dev/null
@@ -1 +0,0 @@
-#include <misc/bits/error-ldbl.h>
diff --git a/include/bits/monetary-ldbl.h b/include/bits/monetary-ldbl.h
deleted file mode 100644
index 6b6713ff..00000000
--- a/include/bits/monetary-ldbl.h
+++ /dev/null
@@ -1 +0,0 @@
-#include <stdlib/bits/monetary-ldbl.h>
diff --git a/include/bits/printf-ldbl.h b/include/bits/printf-ldbl.h
deleted file mode 100644
index 10d534b9..00000000
--- a/include/bits/printf-ldbl.h
+++ /dev/null
@@ -1 +0,0 @@
-#include <stdio-common/bits/printf-ldbl.h>
diff --git a/include/bits/stdio-ldbl.h b/include/bits/stdio-ldbl.h
deleted file mode 100644
index 1f7d3ce1..00000000
--- a/include/bits/stdio-ldbl.h
+++ /dev/null
@@ -1 +0,0 @@
-#include <libio/bits/stdio-ldbl.h>
diff --git a/include/bits/stdlib-ldbl.h b/include/bits/stdlib-ldbl.h
deleted file mode 100644
index 62509494..00000000
--- a/include/bits/stdlib-ldbl.h
+++ /dev/null
@@ -1 +0,0 @@
-#include <stdlib/bits/stdlib-ldbl.h>
diff --git a/include/bits/syslog-ldbl.h b/include/bits/syslog-ldbl.h
deleted file mode 100644
index e8681563..00000000
--- a/include/bits/syslog-ldbl.h
+++ /dev/null
@@ -1 +0,0 @@
-#include <misc/bits/syslog-ldbl.h>
diff --git a/include/bits/wchar-ldbl.h b/include/bits/wchar-ldbl.h
deleted file mode 100644
index 29baa2f4..00000000
--- a/include/bits/wchar-ldbl.h
+++ /dev/null
@@ -1 +0,0 @@
-#include <wcsmbs/bits/wchar-ldbl.h>
diff --git a/include/ctype.h b/include/ctype.h
index 493a6f80..27a76632 100644
--- a/include/ctype.h
+++ b/include/ctype.h
@@ -11,9 +11,6 @@ libc_hidden_proto (__ctype_init)
    So defeat macro expansion with parens for this declaration.  */
 extern int (__isctype) (int __c, int __mask);
 
-libc_hidden_proto (tolower)
-libc_hidden_proto (toupper)
-
 # if IS_IN (libc)
 
 /* These accessors are used by the optimized macros to find the
@@ -53,6 +50,11 @@ __ctype_tolower_loc (void)
   return __libc_tsd_address (const int32_t *, CTYPE_TOLOWER);
 }
 
+__typeof (tolower) __tolower;
+libc_hidden_proto (__tolower)
+__typeof (tolower) __toupper;
+libc_hidden_proto (__toupper)
+
 #  ifndef __NO_CTYPE
 /* The spec says that isdigit must only match the decimal digits.  We
    can check this without a memory access.  */
@@ -64,6 +66,13 @@ __ctype_tolower_loc (void)
 #   define __isdigit_l(c, l) ({ int __c = (c); __c >= '0' && __c <= '9'; })
 #  endif  /* Not __NO_CTYPE.  */
 
+# ifndef __USE_EXTERN_INLINES
+#  undef tolower
+#  define tolower(c) __tolower (c)
+#  undef toupper
+#  define toupper(c) __toupper (c)
+# endif
+
 # endif	/* IS_IN (libc).  */
 #endif  /* Not _ISOMAC.  */
 
diff --git a/include/err.h b/include/err.h
index b9b75162..afbd55d3 100644
--- a/include/err.h
+++ b/include/err.h
@@ -12,12 +12,28 @@ __vwarn_internal (const char *format, __gnuc_va_list ap,
 
 # ifndef _ISOMAC
 
-libc_hidden_ldbl_proto (warn)
-libc_hidden_ldbl_proto (warnx)
-libc_hidden_ldbl_proto (vwarn)
-libc_hidden_ldbl_proto (vwarnx)
-libc_hidden_ldbl_proto (verr)
-libc_hidden_ldbl_proto (verrx)
+/*  Some libc_hidden_ldbl_proto's do not map to a unique symbol when
+    redirecting ldouble to _Float128 variants.  We can therefore safely
+    directly alias them to their internal name.  */
+# if __LDOUBLE_REDIRECTS_TO_FLOAT128_ABI == 1 && IS_IN (libc) && defined SHARED
+#  define __err_hidden_ldbl_proto(name, alias) \
+  extern __typeof (name) __##name __asm__ (__hidden_asmname (#alias));
+#  define err_hidden_ldbl_proto(name) \
+  extern typeof (name) __##name##ieee128; \
+  libc_hidden_proto (__##name##ieee128); \
+  __err_hidden_ldbl_proto (name, __GI___##name##ieee128)
+# else
+#  define err_hidden_ldbl_proto(name) \
+  extern __typeof (name) __##name __attribute_copy__ (name); \
+  libc_hidden_proto (__##name)
+# endif
+
+err_hidden_ldbl_proto (warn);
+err_hidden_ldbl_proto (warnx);
+err_hidden_ldbl_proto (vwarn);
+err_hidden_ldbl_proto (vwarnx);
+err_hidden_ldbl_proto (verr);
+err_hidden_ldbl_proto (verrx);
 
 # endif /* !_ISOMAC */
 #endif /* err.h */
diff --git a/include/features.h b/include/features.h
index 76b8b973..70f70ff1 100644
--- a/include/features.h
+++ b/include/features.h
@@ -502,7 +502,7 @@
 /* Decide whether we can define 'extern inline' functions in headers.  */
 #if __GNUC_PREREQ (2, 7) && defined __OPTIMIZE__ \
     && !defined __OPTIMIZE_SIZE__ && !defined __NO_INLINE__ \
-    && defined __extern_inline
+    && defined __extern_inline && !defined __clang__
 # define __USE_EXTERN_INLINES	1
 #endif
 
diff --git a/include/gmp.h b/include/gmp.h
index 657c7a01..791900b2 100644
--- a/include/gmp.h
+++ b/include/gmp.h
@@ -41,18 +41,6 @@ extern _Float128 __mpn_construct_float128 (mp_srcptr frac_ptr, int expt,
 					   int sign) attribute_hidden;
 #endif
 
-extern __typeof (mpn_add_1) mpn_add_1 attribute_hidden;
-extern __typeof (mpn_addmul_1) mpn_addmul_1 attribute_hidden;
-extern __typeof (mpn_add_n) mpn_add_n attribute_hidden;
-extern __typeof (mpn_cmp) mpn_cmp attribute_hidden;
-extern __typeof (mpn_divrem) mpn_divrem attribute_hidden;
-extern __typeof (mpn_lshift) mpn_lshift attribute_hidden;
-extern __typeof (mpn_mul) mpn_mul attribute_hidden;
-extern __typeof (mpn_mul_1) mpn_mul_1 attribute_hidden;
-extern __typeof (mpn_rshift) mpn_rshift attribute_hidden;
-extern __typeof (mpn_sub_1) mpn_sub_1 attribute_hidden;
-extern __typeof (mpn_submul_1) mpn_submul_1 attribute_hidden;
-extern __typeof (mpn_sub_n) mpn_sub_n attribute_hidden;
 #endif
 
 #endif
diff --git a/include/libc-diag.h b/include/libc-diag.h
index 271c5b88..61e33d6c 100644
--- a/include/libc-diag.h
+++ b/include/libc-diag.h
@@ -71,4 +71,25 @@
 # define DIAG_IGNORE_Os_NEEDS_COMMENT(version, option)
 #endif
 
+/* Same as before, but only enables the warning suppression for clang.
+   It is for clang-only issues and options that only clang emits.  */
+#ifdef __clang__
+# define DIAG_PUSH_NEEDS_COMMENT_CLANG _Pragma ("clang diagnostic push")
+# define DIAG_POP_NEEDS_COMMENT_CLANG _Pragma ("clang diagnostic pop")
+# define DIAG_IGNORE_NEEDS_COMMENT_CLANG(version, option) \
+  _Pragma (_DIAG_STR (clang diagnostic ignored option))
+#else
+# define DIAG_PUSH_NEEDS_COMMENT_CLANG
+# define DIAG_POP_NEEDS_COMMENT_CLANG
+# define DIAG_IGNORE_NEEDS_COMMENT_CLANG(version, option)
+#endif
+
+/* Some warnings are not support for all compilers.  */
+#ifndef __clang__
+# define DIAG_IGNORE_NEEDS_COMMENT_GCC(VERSION, WARNING) \
+    DIAG_IGNORE_NEEDS_COMMENT (VERSION, WARNING)
+#else
+# define DIAG_IGNORE_NEEDS_COMMENT_GCC(VERSION, WARNING)
+#endif
+
 #endif /* libc-diag.h */
diff --git a/include/libc-symbols.h b/include/libc-symbols.h
index 662bd118..eafc9e60 100644
--- a/include/libc-symbols.h
+++ b/include/libc-symbols.h
@@ -87,6 +87,13 @@
 /* Obtain the definition of symbol_version_reference.  */
 #include <libc-symver.h>
 
+#if defined(__clang__)
+#pragma GCC diagnostic ignored "-Wshift-count-negative"
+#pragma GCC diagnostic ignored "-Wshift-count-overflow"
+#pragma GCC diagnostic ignored "-Wsometimes-uninitialized"
+#pragma GCC diagnostic ignored "-Wunused-function"
+#endif
+
 /* When PIC is defined and SHARED isn't defined, we are building PIE
    by default.  */
 #if defined PIC && !defined SHARED
@@ -446,8 +453,13 @@ for linking")
 /* Used to disable stack protection in sensitive places, like ifunc
    resolvers and early static TLS init.  */
 #ifdef HAVE_CC_NO_STACK_PROTECTOR
-# define inhibit_stack_protector \
+# ifdef __clang__
+#  define inhibit_stack_protector \
+     __attribute__((no_stack_protector))
+# else
+#  define inhibit_stack_protector \
     __attribute__ ((__optimize__ ("-fno-stack-protector")))
+# endif
 #else
 # define inhibit_stack_protector
 #endif
@@ -532,11 +544,21 @@ for linking")
   __attribute__ ((visibility ("hidden"), ##attrs))
 #  define hidden_proto(name, attrs...) \
   __hidden_proto (name, , __GI_##name, ##attrs)
+#  define hidden_proto2(type, name, attrs...) \
+  __hidden_proto2 (type, name, , __GI_##name, ##attrs)
+#  define __hidden_proto_alias(internal) \
+    __asm__(__hidden_asmname (#internal))
+#  define hidden_proto3(name, proto, attrs...) \
+  name proto __hidden_proto_alias (__GI_##name) \
+   __hidden_proto_hiddenattr (##attrs)
 #  define hidden_tls_proto(name, attrs...) \
   __hidden_proto (name, __thread, __GI_##name, ##attrs)
 #  define __hidden_proto(name, thread, internal, attrs...)	     \
   extern thread __typeof (name) name __asm__ (__hidden_asmname (#internal)) \
   __hidden_proto_hiddenattr (attrs);
+#  define __hidden_proto2(type, name, thread, internal, attrs...)	     \
+  extern thread __typeof (type) name __asm__ (__hidden_asmname (#internal)) \
+  __hidden_proto_hiddenattr (attrs);
 #  define __hidden_asmname(name) \
   __hidden_asmname1 (__USER_LABEL_PREFIX__, name)
 #  define __hidden_asmname1(prefix, name) __hidden_asmname2(prefix, name)
@@ -600,10 +622,17 @@ for linking")
   __hidden_proto (name, __thread, name, ##attrs)
 #  define __hidden_proto(name, thread, internal, attrs...)	     \
   extern thread __typeof (name) name __hidden_proto_hiddenattr (attrs);
+#  define hidden_proto3(name, proto, attrs...) \
+     name proto __hidden_proto_hiddenattr (##attrs)
 # else
 #   define hidden_proto(name, attrs...)
+#   define hidden_proto3(name, proto, attrs...) name proto
 #   define hidden_tls_proto(name, attrs...)
 # endif
+# define __hidden_proto2(type, name, thread, attrs...)     \
+  extern thread __typeof (type) name __attribute__ ((visibility ("hidden"), ##attrs));
+# define hidden_proto2(type, name, attrs...) \
+   __hidden_proto2(type, name, , attrs)
 # else
 #  define HIDDEN_JUMPTARGET(name) JUMPTARGET(name)
 # endif /* Not  __ASSEMBLER__ */
@@ -619,6 +648,7 @@ for linking")
 
 #if IS_IN (libc)
 # define libc_hidden_proto(name, attrs...) hidden_proto (name, ##attrs)
+# define libc_hidden_proto3(name, proto, attrs...) hidden_proto3 (name, proto, ##attrs)
 # define libc_hidden_tls_proto(name, attrs...) hidden_tls_proto (name, ##attrs)
 # define libc_hidden_def(name) hidden_def (name)
 # define libc_hidden_weak(name) hidden_weak (name)
@@ -630,6 +660,7 @@ for linking")
 # define libc_hidden_data_ver(local, name) hidden_data_ver (local, name)
 #else
 # define libc_hidden_proto(name, attrs...)
+# define libc_hidden_proto3(name, proto, attrs...) name proto
 # define libc_hidden_tls_proto(name, attrs...)
 # define libc_hidden_def(name)
 # define libc_hidden_weak(name)
diff --git a/include/math.h b/include/math.h
index fa11a710..6a9d1a67 100644
--- a/include/math.h
+++ b/include/math.h
@@ -123,11 +123,13 @@ __isinff128 (_Float128 x)
 }
 #  endif
 
+#  ifdef __USE_EXTERN_INLINES
 extern inline _Float128
-fabsf128 (_Float128 x)
+__fabsf128 (_Float128 x)
 {
   return __builtin_fabsf128 (x);
 }
+#  endif
 # endif
 
 # if !(defined __FINITE_MATH_ONLY__ && __FINITE_MATH_ONLY__ > 0)
diff --git a/include/stdio.h b/include/stdio.h
index 23b7fd28..1128c101 100644
--- a/include/stdio.h
+++ b/include/stdio.h
@@ -22,13 +22,17 @@
 /*  Some libc_hidden_ldbl_proto's do not map to a unique symbol when
     redirecting ldouble to _Float128 variants.  We can therefore safely
     directly alias them to their internal name.  */
-# if __LDOUBLE_REDIRECTS_TO_FLOAT128_ABI == 1 && IS_IN (libc)
-#  define stdio_hidden_ldbl_proto(p, f) \
-  extern __typeof (p ## f) p ## f __asm (__ASMNAME ("___ieee128_" #f));
-# elif __LDOUBLE_REDIRECTS_TO_FLOAT128_ABI == 1
-#  define stdio_hidden_ldbl_proto(p,f) __LDBL_REDIR1_DECL (p ## f, p ## f ## ieee128)
+# if __LDOUBLE_REDIRECTS_TO_FLOAT128_ABI == 1 && IS_IN (libc) && defined SHARED
+#  define __stdio_hidden_ldbl_proto(name, alias) \
+  extern __typeof (name) __##name __asm__ (__hidden_asmname (#alias));
+#  define stdio_hidden_ldbl_proto(name) \
+  extern typeof (name) __##name##ieee128; \
+  libc_hidden_proto (__##name##ieee128); \
+  __stdio_hidden_ldbl_proto (name, __GI___##name##ieee128)
 # else
-#  define stdio_hidden_ldbl_proto(p,f) libc_hidden_proto (p ## f)
+#  define stdio_hidden_ldbl_proto(name) \
+  extern __typeof (name) __##name; \
+  libc_hidden_proto (__##name)
 # endif
 
 /* Set the error indicator on FP.  */
@@ -39,10 +43,7 @@ fseterr_unlocked (FILE *fp)
 }
 
 extern int __fcloseall (void) attribute_hidden;
-extern int __snprintf (char *__restrict __s, size_t __maxlen,
-		       const char *__restrict __format, ...)
-     __attribute__ ((__format__ (__printf__, 3, 4)));
-stdio_hidden_ldbl_proto (__, snprintf)
+stdio_hidden_ldbl_proto (snprintf);
 
 extern int __vfscanf (FILE *__restrict __s,
 		      const char *__restrict __format,
@@ -168,7 +169,6 @@ extern void __funlockfile (FILE *__stream) attribute_hidden;
    possible.  */
 extern int __ftrylockfile (FILE *__stream);
 
-extern int __getc_unlocked (FILE *__fp) attribute_hidden;
 extern wint_t __getwc_unlocked (FILE *__fp);
 
 extern int __fxprintf (FILE *__fp, const char *__fmt, ...)
@@ -183,7 +183,7 @@ extern const char *const _sys_errlist_internal[] attribute_hidden;
 extern const char *__get_errlist (int) attribute_hidden;
 extern const char *__get_errname (int) attribute_hidden;
 
-libc_hidden_ldbl_proto (__asprintf)
+stdio_hidden_ldbl_proto (asprintf);
 
 #  if IS_IN (libc)
 extern FILE *_IO_new_fopen (const char*, const char*);
@@ -205,15 +205,13 @@ extern int _IO_new_fgetpos (FILE *, __fpos_t *);
 #   define fgetpos(fp, posp) _IO_new_fgetpos (fp, posp)
 #  endif
 
-extern __typeof (dprintf) __dprintf
-     __attribute__ ((__format__ (__printf__, 2, 3)));
-stdio_hidden_ldbl_proto (__, dprintf)
-libc_hidden_ldbl_proto (dprintf)
-libc_hidden_ldbl_proto (fprintf)
-libc_hidden_ldbl_proto (vfprintf)
-libc_hidden_ldbl_proto (sprintf)
+stdio_hidden_ldbl_proto (dprintf);
+stdio_hidden_ldbl_proto (fprintf);
+stdio_hidden_ldbl_proto (vfprintf);
+stdio_hidden_ldbl_proto (sprintf);
 libc_hidden_proto (ungetc)
-libc_hidden_proto (__getdelim)
+__typeof (getdelim) __libc_getdelim;
+hidden_proto2 (getdelim, __libc_getdelim);
 libc_hidden_proto (fwrite)
 libc_hidden_proto (perror)
 libc_hidden_proto (remove)
@@ -242,14 +240,10 @@ libc_hidden_proto (__fgets_unlocked)
 libc_hidden_proto (fputs_unlocked)
 extern __typeof (fputs_unlocked) __fputs_unlocked;
 libc_hidden_proto (__fputs_unlocked)
-libc_hidden_proto (feof_unlocked)
-extern __typeof (feof_unlocked) __feof_unlocked attribute_hidden;
-libc_hidden_proto (ferror_unlocked)
-extern __typeof (ferror_unlocked) __ferror_unlocked attribute_hidden;
-libc_hidden_proto (getc_unlocked)
-libc_hidden_proto (fputc_unlocked)
-libc_hidden_proto (putc_unlocked)
-extern __typeof (putc_unlocked) __putc_unlocked attribute_hidden;
+extern __typeof (feof_unlocked) __libc_feof_unlocked;
+extern __typeof (ferror_unlocked) __libc_ferror_unlocked;
+extern __typeof (getc_unlocked) __libc_getc_unlocked;
+extern __typeof (putc_unlocked) __libc_putc_unlocked;
 libc_hidden_proto (fmemopen)
 /* The prototype needs repeating instead of using __typeof to use
    __THROW in C++ tests.  */
@@ -265,31 +259,35 @@ libc_hidden_proto (__fmemopen)
 extern int __gen_tempfd (int flags);
 libc_hidden_proto (__gen_tempfd)
 
-#  ifdef __USE_EXTERN_INLINES
-__extern_inline int
-__NTH (__feof_unlocked (FILE *__stream))
+static inline int
+__feof_unlocked (FILE *__stream)
 {
   return __feof_unlocked_body (__stream);
 }
 
-__extern_inline int
-__NTH (__ferror_unlocked (FILE *__stream))
+static inline int
+__ferror_unlocked (FILE *__stream)
 {
   return __ferror_unlocked_body (__stream);
 }
 
-__extern_inline int
+static inline int
 __getc_unlocked (FILE *__fp)
 {
-  return __getc_unlocked_body (__fp);
+  return _IO_getc_unlocked (__fp);
 }
 
-__extern_inline int
+static inline int
 __putc_unlocked (int __c, FILE *__stream)
 {
-  return __putc_unlocked_body (__c, __stream);
+  return _IO_putc_unlocked (__c, __stream);
+}
+
+static inline int
+__fputc_unlocked (int __c, FILE *__stream)
+{
+  return _IO_putc_unlocked (__c, __stream);
 }
-#  endif
 
 extern __typeof (renameat) __renameat;
 libc_hidden_proto (__renameat)
diff --git a/include/stdlib.h b/include/stdlib.h
index 1c6f70b0..754c8e45 100644
--- a/include/stdlib.h
+++ b/include/stdlib.h
@@ -40,7 +40,6 @@ libc_hidden_proto (abort)
 libc_hidden_proto (getenv)
 extern __typeof (secure_getenv) __libc_secure_getenv;
 libc_hidden_proto (__libc_secure_getenv)
-libc_hidden_proto (bsearch)
 libc_hidden_proto (qsort)
 extern __typeof (qsort_r) __qsort_r;
 libc_hidden_proto (__qsort_r)
@@ -144,6 +143,12 @@ libc_hidden_proto (__ptsname_r)
 libc_hidden_proto (grantpt)
 libc_hidden_proto (unlockpt)
 
+__typeof (bsearch) __bsearch;
+libc_hidden_proto (__bsearch)
+#if !defined __USE_EXTERN_INLINES && IS_IN(libc)
+# define bsearch __bsearch
+#endif
+
 extern double __strtod_internal (const char *__restrict __nptr,
 				 char **__restrict __endptr, int __group)
      __THROW __nonnull ((1)) __wur;
@@ -221,17 +226,22 @@ libc_hidden_proto (____strtoul_l_internal)
 libc_hidden_proto (____strtoull_l_internal)
 
 #include <bits/floatn.h>
-libc_hidden_proto (strtof)
-libc_hidden_proto (strtod)
+extern __typeof (strtof) __strtof;
+libc_hidden_proto (__strtof)
+extern __typeof (strtod) __strtod;
+libc_hidden_proto (__strtod)
 #if __LDOUBLE_REDIRECTS_TO_FLOAT128_ABI == 0
-libc_hidden_proto (strtold)
+extern __typeof (strtold) __strtold;
+libc_hidden_proto (__strtold)
 #endif
-libc_hidden_proto (strtol)
-libc_hidden_proto (strtoll)
-libc_hidden_proto (strtoul)
-libc_hidden_proto (strtoull)
-
-libc_hidden_proto (atoi)
+extern __typeof (strtol) __strtol;
+libc_hidden_proto (__strtol)
+extern __typeof (strtoll) __strtoll;
+libc_hidden_proto (__strtoll)
+extern __typeof (strtoul) __strtoul;
+libc_hidden_proto (__strtoul)
+extern __typeof (strtoull) __strtoull;
+libc_hidden_proto (__strtoull)
 
 extern float __strtof_nan (const char *, char **, char);
 extern double __strtod_nan (const char *, char **, char);
@@ -251,10 +261,10 @@ libc_hidden_proto (__wcstold_nan)
 #include <bits/floatn.h>
 
 #if __HAVE_DISTINCT_FLOAT128
+extern __typeof (strtof128) __strtof128;
+libc_hidden_proto (__strtof128)
 extern __typeof (strtof128_l) __strtof128_l;
-
 libc_hidden_proto (__strtof128_l)
-libc_hidden_proto (strtof128)
 
 extern _Float128 __strtof128_nan (const char *, char **, char);
 extern _Float128 __wcstof128_nan (const wchar_t *, wchar_t **, wchar_t);
diff --git a/include/string.h b/include/string.h
index 21f641a4..987afbd3 100644
--- a/include/string.h
+++ b/include/string.h
@@ -172,12 +172,16 @@ extern __typeof (strnlen) strnlen attribute_hidden;
 extern __typeof (strsep) strsep attribute_hidden;
 #endif
 
-#if (!IS_IN (libc) || !defined SHARED) \
-  && !defined NO_MEMPCPY_STPCPY_REDIRECT
+#if IS_IN (libc) && !defined NO_MEMPCPY_STPCPY_REDIRECT
 /* Redirect calls to __builtin_mempcpy and __builtin_stpcpy to call
    __mempcpy and __stpcpy if not inlined.  */
-extern __typeof (mempcpy) mempcpy __asm__ ("__mempcpy");
-extern __typeof (stpcpy) stpcpy __asm__ ("__stpcpy");
+# ifdef SHARED
+__asm__ ("mempcpy = __GI_mempcpy");
+__asm__ ("stpcpy = __GI_stpcpy");
+# else
+__asm__ ("mempcpy = __mempcpy");
+__asm__ ("stpcpy = __stpcpy");
+#endif
 #endif
 
 extern void *__memcpy_chk (void *__restrict __dest,
diff --git a/include/sys/cdefs.h b/include/sys/cdefs.h
index 56adb231..7f7aa967 100644
--- a/include/sys/cdefs.h
+++ b/include/sys/cdefs.h
@@ -20,26 +20,6 @@ extern void __chk_fail (void) __attribute__ ((__noreturn__));
 libc_hidden_proto (__chk_fail)
 rtld_hidden_proto (__chk_fail)
 
-/* If we are using redirects internally to support long double,
-   we need to tweak some macros to ensure the PLT bypass tricks
-   continue to work in libc. */
-#if __LDOUBLE_REDIRECTS_TO_FLOAT128_ABI == 1 && IS_IN (libc) && defined SHARED
-
-# undef __LDBL_REDIR_DECL
-# define __LDBL_REDIR_DECL(func) \
-   extern __typeof(func) func __asm (__ASMNAME ("__GI____ieee128_" #func));
-
-# undef libc_hidden_ldbl_proto
-# define libc_hidden_ldbl_proto(func, attrs...) \
-   extern __typeof(func) ___ieee128_ ## func; \
-   libc_hidden_proto (___ieee128_ ## func, ##attrs);
-
-# undef __LDBL_REDIR2_DECL
-# define __LDBL_REDIR2_DECL(func) \
-   extern __typeof(__ ## func) __ ## func __asm (__ASMNAME ("__GI____ieee128___" #func));
-
-#endif
-
 #endif /* !defined _ISOMAC */
 
 #endif
diff --git a/include/sys/socket.h b/include/sys/socket.h
index 6e4cf507..e3d855fa 100644
--- a/include/sys/socket.h
+++ b/include/sys/socket.h
@@ -169,12 +169,14 @@ libc_hidden_proto (__libc_sa_len)
 # define SA_LEN(_x)      __libc_sa_len((_x)->sa_family)
 #endif
 
-libc_hidden_proto (__cmsg_nxthdr)
-
 #ifndef __ASSUME_TIME64_SYSCALLS
 extern void __convert_scm_timestamps (struct msghdr *msg, socklen_t msgsize)
      attribute_hidden;
 #endif
 
+#undef CMSG_NXTHDR
+#define CMSG_NXTHDR(mhdr, cmsg) __libc_cmsg_nxthdr (mhdr, cmsg)
+hidden_proto2 (__cmsg_nxthdr, __libc_cmsg_nxthdr)
+
 #endif
 #endif
diff --git a/include/sys/syslog.h b/include/sys/syslog.h
index 44422eab..32165546 100644
--- a/include/sys/syslog.h
+++ b/include/sys/syslog.h
@@ -3,7 +3,23 @@
 #include <misc/sys/syslog.h>
 #ifndef _ISOMAC
 
-libc_hidden_ldbl_proto (syslog)
+/*  Some libc_hidden_ldbl_proto's do not map to a unique symbol when
+    redirecting ldouble to _Float128 variants.  We can therefore safely
+    directly alias them to their internal name.  */
+# if __LDOUBLE_REDIRECTS_TO_FLOAT128_ABI == 1 && IS_IN (libc) && defined SHARED
+#  define __syslog_hidden_ldbl_proto(name, alias) \
+  extern __typeof (name) __##name __asm__ (__hidden_asmname (#alias));
+#  define syslog_hidden_ldbl_proto(name) \
+  extern typeof (name) __##name##ieee128; \
+  libc_hidden_proto (__##name##ieee128); \
+  __syslog_hidden_ldbl_proto (name, __GI___##name##ieee128)
+# else
+#  define syslog_hidden_ldbl_proto(name) \
+  extern __typeof (name) __##name; \
+  libc_hidden_proto (__##name)
+# endif
+
+syslog_hidden_ldbl_proto (syslog);
 
 /* __vsyslog_internal uses the same mode_flags bits as
    __v*printf_internal; see libio/libioP.h.  */
diff --git a/include/sys/sysmacros.h b/include/sys/sysmacros.h
index ae8d8f00..d7d3f5d9 100644
--- a/include/sys/sysmacros.h
+++ b/include/sys/sysmacros.h
@@ -25,9 +25,12 @@
 #if !defined _SYS_SYSMACROS_H_WRAPPER && !defined _ISOMAC
 # define _SYS_SYSMACROS_H_WRAPPER 1
 
-libc_hidden_proto (gnu_dev_major)
-libc_hidden_proto (gnu_dev_minor)
-libc_hidden_proto (gnu_dev_makedev)
+__typeof (gnu_dev_major) __gnu_dev_major;
+libc_hidden_proto (__gnu_dev_major)
+__typeof (gnu_dev_minor) __gnu_dev_minor;
+libc_hidden_proto (__gnu_dev_minor)
+__typeof (gnu_dev_makedev) __gnu_dev_makedev;
+libc_hidden_proto (__gnu_dev_makedev)
 
 # undef __SYSMACROS_DECL_TEMPL
 # define __SYSMACROS_DECL_TEMPL(rtype, name, proto)	\
@@ -47,6 +50,13 @@ __SYSMACROS_DECLARE_MAKEDEV (__SYSMACROS_DECL_TEMPL)
 __SYSMACROS_DEFINE_MAJOR (__SYSMACROS_IMPL_TEMPL)
 __SYSMACROS_DEFINE_MINOR (__SYSMACROS_IMPL_TEMPL)
 __SYSMACROS_DEFINE_MAKEDEV (__SYSMACROS_IMPL_TEMPL)
+# elif IS_IN (libc)
+#  undef major
+#  define major(dev) __gnu_dev_major (dev)
+#  undef minor
+#  define minor(dev) __gnu_dev_minor (dev)
+#  undef makedev
+#  define makedev(maj, min) __gnu_dev_makedev (maj, min)
 # endif
 
 #endif
diff --git a/include/unistd.h b/include/unistd.h
index 70901696..9f09c355 100644
--- a/include/unistd.h
+++ b/include/unistd.h
@@ -13,7 +13,6 @@ rtld_hidden_proto (_exit, __noreturn__)
 libc_hidden_proto (alarm)
 extern size_t __confstr (int name, char *buf, size_t len);
 libc_hidden_proto (__confstr)
-libc_hidden_proto (confstr)
 libc_hidden_proto (execl)
 libc_hidden_proto (execle)
 libc_hidden_proto (execlp)
diff --git a/include/wchar.h b/include/wchar.h
index 42679856..781ad7c2 100644
--- a/include/wchar.h
+++ b/include/wchar.h
@@ -71,13 +71,20 @@ libc_hidden_proto (__wcstol_internal)
 libc_hidden_proto (__wcstoll_internal)
 libc_hidden_proto (__wcstoul_internal)
 libc_hidden_proto (__wcstoull_internal)
-libc_hidden_proto (wcstof)
-libc_hidden_proto (wcstod)
-libc_hidden_ldbl_proto (wcstold)
-libc_hidden_proto (wcstol)
-libc_hidden_proto (wcstoll)
-libc_hidden_proto (wcstoul)
-libc_hidden_proto (wcstoull)
+extern __typeof (wcstof) __wcstof;
+libc_hidden_proto (__wcstof)
+extern __typeof (wcstod) __wcstod;
+libc_hidden_proto (__wcstod)
+extern __typeof (wcstold) __wcstold;
+libc_hidden_ldbl_proto (__wcstold)
+extern __typeof (wcstol) __wcstol;
+libc_hidden_proto (__wcstol)
+extern __typeof (wcstoll) __wcstoll;
+libc_hidden_proto (__wcstoll)
+extern __typeof (wcstoul) __wcstoul;
+libc_hidden_proto (__wcstoul)
+extern __typeof (wcstoull) __wcstoull;
+libc_hidden_proto (__wcstoull)
 
 extern float ____wcstof_l_internal (const wchar_t *, wchar_t **, int,
 				    locale_t) attribute_hidden;
@@ -100,6 +107,8 @@ extern unsigned long long int ____wcstoull_l_internal (const wchar_t *,
      attribute_hidden;
 
 #if __HAVE_DISTINCT_FLOAT128
+extern __typeof (wcstof128) __wcstof128;
+libc_hidden_proto (__wcstof128)
 extern __typeof (wcstof128_l) __wcstof128_l;
 libc_hidden_proto (__wcstof128_l)
 extern _Float128 __wcstof128_internal (const wchar_t *__restrict __nptr,
@@ -110,7 +119,6 @@ extern _Float128 ____wcstof128_l_internal (const wchar_t *, wchar_t **, int,
 					   locale_t) attribute_hidden;
 
 libc_hidden_proto (__wcstof128_internal)
-libc_hidden_proto (wcstof128)
 #endif
 
 libc_hidden_proto (__wcscasecmp_l)
diff --git a/inet/Makefile b/inet/Makefile
index 9b96e57c..a5ef1ec0 100644
--- a/inet/Makefile
+++ b/inet/Makefile
@@ -106,6 +106,9 @@ CFLAGS-either_ntoh.c += -fexceptions
 CFLAGS-either_hton.c += -fexceptions
 CFLAGS-getnetgrent.c += -fexceptions
 CFLAGS-getnetgrent_r.c += -fexceptions
+CFLAGS-in6_addr.c += $(config-cflags-wno-ignored-attributes)
+CFLAGS-if_index.c += $(config-cflags-wno-ignored-attributes)
+CFLAGS-ifaddrs.c += $(config-cflags-wno-ignored-attributes)
 
 CFLAGS-tst-checks-posix.c += -std=c99
 CFLAGS-tst-sockaddr.c += -fno-strict-aliasing
diff --git a/inet/ether_ntoa_r.c b/inet/ether_ntoa_r.c
index 03011ffe..f111e523 100644
--- a/inet/ether_ntoa_r.c
+++ b/inet/ether_ntoa_r.c
@@ -23,10 +23,10 @@
 char *
 ether_ntoa_r (const struct ether_addr *addr, char *buf)
 {
-  sprintf (buf, "%x:%x:%x:%x:%x:%x",
-	   addr->ether_addr_octet[0], addr->ether_addr_octet[1],
-	   addr->ether_addr_octet[2], addr->ether_addr_octet[3],
-	   addr->ether_addr_octet[4], addr->ether_addr_octet[5]);
+  __sprintf (buf, "%x:%x:%x:%x:%x:%x",
+	     addr->ether_addr_octet[0], addr->ether_addr_octet[1],
+	     addr->ether_addr_octet[2], addr->ether_addr_octet[3],
+	     addr->ether_addr_octet[4], addr->ether_addr_octet[5]);
   return buf;
 }
 libc_hidden_def (ether_ntoa_r)
diff --git a/inet/net-internal.h b/inet/net-internal.h
index cdccdd39..ff450644 100644
--- a/inet/net-internal.h
+++ b/inet/net-internal.h
@@ -106,7 +106,7 @@ __deadline_is_infinite (struct deadline deadline)
  *    https://gcc.gnu.org/bugzilla/show_bug.cgi?id=91691
  */
 DIAG_PUSH_NEEDS_COMMENT;
-DIAG_IGNORE_NEEDS_COMMENT (9, "-Wmaybe-uninitialized");
+DIAG_IGNORE_NEEDS_COMMENT_GCC (9, "-Wmaybe-uninitialized");
 
 /* Return true if the current time is at the deadline or past it.  */
 static inline bool
diff --git a/inet/rexec.c b/inet/rexec.c
index 064e979d..809475d9 100644
--- a/inet/rexec.c
+++ b/inet/rexec.c
@@ -134,8 +134,8 @@ retry:
 		if (!getnameinfo(&sa2.sa, sa2len,
 				 NULL, 0, servbuff, sizeof(servbuff),
 				 NI_NUMERICSERV))
-			port = atoi(servbuff);
-		(void) sprintf(num, "%u", port);
+			port = (int) __strtol (servbuff, NULL, 10);
+		(void) __sprintf(num, "%u", port);
 		(void) __write(s, num, strlen(num)+1);
 		{ socklen_t len = sizeof (from);
 		  s3 = TEMP_FAILURE_RETRY (accept(s2, (struct sockaddr *)&from,
diff --git a/inet/ruserpass.c b/inet/ruserpass.c
index d61a7287..3e46f9bb 100644
--- a/inet/ruserpass.c
+++ b/inet/ruserpass.c
@@ -112,7 +112,7 @@ ruserpass (const char *host, const char **aname, const char **apass)
 	cfile = fopen(buf, "rce");
 	if (cfile == NULL) {
 		if (errno != ENOENT)
-			warn("%s", buf);
+			__warn("%s", buf);
 		return (0);
 	}
 	/* No threads use this stream.  */
@@ -162,7 +162,7 @@ next:
 				  newp = malloc((unsigned) strlen(tokval) + 1);
 				  if (newp == NULL)
 				    {
-				      warnx(_("out of memory"));
+				      __warnx(_("out of memory"));
 				      goto bad;
 				    }
 				  *aname = strcpy(newp, tokval);
@@ -176,8 +176,8 @@ next:
 			if (strcmp(*aname, "anonymous") &&
 			    __fstat64(fileno(cfile), &stb) >= 0 &&
 			    (stb.st_mode & 077) != 0) {
-	warnx(_("Error: .netrc file is readable by others."));
-	warnx(_("Remove 'password' line or make file unreadable by others."));
+	__warnx(_("Error: .netrc file is readable by others."));
+	__warnx(_("Remove 'password' line or make file unreadable by others."));
 				goto bad;
 			}
 			if (token() && *apass == 0) {
@@ -185,7 +185,7 @@ next:
 				newp = malloc((unsigned) strlen(tokval) + 1);
 				if (newp == NULL)
 				  {
-				    warnx(_("out of memory"));
+				    __warnx(_("out of memory"));
 				    goto bad;
 				  }
 				*apass = strcpy(newp, tokval);
@@ -196,7 +196,7 @@ next:
 		case MACDEF:
 			break;
 		default:
-			warnx(_("Unknown .netrc keyword %s"), tokval);
+			__warnx(_("Unknown .netrc keyword %s"), tokval);
 			break;
 		}
 		goto done;
@@ -217,26 +217,26 @@ token (void)
 	int c;
 	int i;
 
-	if (feof_unlocked(cfile) || ferror_unlocked(cfile))
+	if (__feof_unlocked(cfile) || __ferror_unlocked(cfile))
 		return (0);
-	while ((c = getc_unlocked(cfile)) != EOF &&
+	while ((c = __getc_unlocked(cfile)) != EOF &&
 	    (c == '\n' || c == '\t' || c == ' ' || c == ','))
 		continue;
 	if (c == EOF)
 		return (0);
 	cp = tokval;
 	if (c == '"') {
-		while ((c = getc_unlocked(cfile)) != EOF && c != '"') {
+		while ((c = __getc_unlocked(cfile)) != EOF && c != '"') {
 			if (c == '\\')
-				c = getc_unlocked(cfile);
+				c = __getc_unlocked(cfile);
 			*cp++ = c;
 		}
 	} else {
 		*cp++ = c;
-		while ((c = getc_unlocked(cfile)) != EOF
+		while ((c = __getc_unlocked(cfile)) != EOF
 		    && c != '\n' && c != '\t' && c != ' ' && c != ',') {
 			if (c == '\\')
-				c = getc_unlocked(cfile);
+				c = __getc_unlocked(cfile);
 			*cp++ = c;
 		}
 	}
diff --git a/intl/Makefile b/intl/Makefile
index 315c75a1..1c3b2a22 100644
--- a/intl/Makefile
+++ b/intl/Makefile
@@ -154,7 +154,8 @@ $(objpfx)tst-gettext5.out: $(objpfx)tst-gettext.out
 $(objpfx)tst-gettext6.out: $(objpfx)tst-gettext.out
 
 CPPFLAGS += -D'LOCALEDIR="$(localedir)"' \
-	    -D'LOCALE_ALIAS_PATH="$(localedir)"'
+	    -D'LOCALE_ALIAS_PATH="$(localedir)"' \
+	    -Wno-unused-but-set-variable
 BISONFLAGS = --yacc --no-lines --name-prefix=__gettext --output
 
 $(inst_localedir)/locale.alias: locale.alias $(+force)
diff --git a/intl/l10nflist.c b/intl/l10nflist.c
index 078a450d..1945d3f8 100644
--- a/intl/l10nflist.c
+++ b/intl/l10nflist.c
@@ -210,7 +210,7 @@ _nl_make_l10nflist (struct loaded_l10nfile **l10nfile_list,
     }
 
   *cp++ = '/';
-  stpcpy (cp, filename);
+  strcpy (cp, filename);
 
   /* Look in list of already loaded domains whether it is already
      available.  */
diff --git a/intl/plural-exp.c b/intl/plural-exp.c
index d5aec23b..80b0a5af 100644
--- a/intl/plural-exp.c
+++ b/intl/plural-exp.c
@@ -120,7 +120,7 @@ EXTRACT_PLURAL_EXPRESSION (const char *nullentry,
 	  if (!(*nplurals >= '0' && *nplurals <= '9'))
 	    goto no_plural;
 #if defined HAVE_STRTOUL || defined _LIBC
-	  n = strtoul (nplurals, &endp, 10);
+	  n = __strtoul (nplurals, &endp, 10);
 #else
 	  for (endp = nplurals, n = 0; *endp >= '0' && *endp <= '9'; endp++)
 	    n = n * 10 + (*endp - '0');
diff --git a/io/Makefile b/io/Makefile
index cf265dc9..abcdb88d 100644
--- a/io/Makefile
+++ b/io/Makefile
@@ -111,11 +111,11 @@ CFLAGS-open64.c += -fexceptions -fasynchronous-unwind-tables
 CFLAGS-creat.c += -fexceptions -fasynchronous-unwind-tables
 CFLAGS-creat64.c += -fexceptions -fasynchronous-unwind-tables
 CFLAGS-fcntl.c += -fexceptions -fasynchronous-unwind-tables
-CFLAGS-fcntl64.c += -fexceptions -fasynchronous-unwind-tables
+CFLAGS-fcntl64.c += -fexceptions -fasynchronous-unwind-tables $(config-cflags-wno-ignored-attributes)
 CFLAGS-poll.c += -fexceptions -fasynchronous-unwind-tables
 CFLAGS-ppoll.c += -fexceptions -fasynchronous-unwind-tables
 CFLAGS-lockf.c += -fexceptions -fasynchronous-unwind-tables
-CFLAGS-lockf64.c += -fexceptions -fasynchronous-unwind-tables
+CFLAGS-lockf64.c += -fexceptions -fasynchronous-unwind-tables $(config-cflags-wno-ignored-attributes)
 CFLAGS-statfs.c += -fexceptions
 CFLAGS-fstatfs.c += -fexceptions
 CFLAGS-statvfs.c += -fexceptions
@@ -130,9 +130,10 @@ CFLAGS-posix_fallocate.c += -fexceptions
 CFLAGS-posix_fallocate64.c += -fexceptions
 CFLAGS-fallocate.c += -fexceptions
 CFLAGS-fallocate64.c += -fexceptions
-CFLAGS-read.c += -fexceptions -fasynchronous-unwind-tables
-CFLAGS-write.c += -fexceptions -fasynchronous-unwind-tables
+CFLAGS-read.c += -fexceptions -fasynchronous-unwind-tables $(config-cflags-wno-ignored-attributes)
+CFLAGS-write.c += -fexceptions -fasynchronous-unwind-tables $(config-cflags-wno-ignored-attributes)
 CFLAGS-close.c += -fexceptions -fasynchronous-unwind-tables
+CFLAGS-lseek64.c += $(config-cflags-wno-ignored-attributes)
 
 CFLAGS-test-stat.c += -D_FILE_OFFSET_BITS=64 -D_LARGEFILE64_SOURCE
 CFLAGS-test-lfs.c += -D_LARGEFILE64_SOURCE
diff --git a/libio/Makefile b/libio/Makefile
index 0e5f348b..cdfbcae8 100644
--- a/libio/Makefile
+++ b/libio/Makefile
@@ -23,7 +23,7 @@ subdir	:= libio
 include ../Makeconfig
 
 headers	:= stdio.h \
-	   bits/stdio.h bits/stdio2.h bits/stdio-ldbl.h \
+	   bits/stdio.h bits/stdio2.h \
 	   bits/types/FILE.h bits/types/__FILE.h bits/types/struct_FILE.h \
 	   bits/types/__fpos_t.h bits/types/__fpos64_t.h \
 	   bits/types/cookie_io_functions_t.h
@@ -112,18 +112,18 @@ CFLAGS-getchar.c += -fexceptions
 CFLAGS-getwc.c += -fexceptions
 CFLAGS-getwchar.c += -fexceptions
 CFLAGS-iofclose.c += -fexceptions
-CFLAGS-iofflush.c += -fexceptions
+CFLAGS-iofflush.c += -fexceptions $(config-cflags-wno-ignored-attributes)
 CFLAGS-iofgetpos64.c += -fexceptions
 CFLAGS-iofgetpos.c += -fexceptions
 CFLAGS-iofgets.c += -fexceptions
 CFLAGS-iofgetws.c += -fexceptions
-CFLAGS-iofputs.c += -fexceptions
+CFLAGS-iofputs.c += -fexceptions $(config-cflags-wno-ignored-attributes)
 CFLAGS-iofputws.c += -fexceptions
 CFLAGS-iofread.c += -fexceptions
 CFLAGS-iofsetpos64.c += -fexceptions
 CFLAGS-iofsetpos.c += -fexceptions
 CFLAGS-ioftell.c += -fexceptions
-CFLAGS-iofwrite.c += -fexceptions
+CFLAGS-iofwrite.c += -fexceptions $(config-cflags-wno-ignored-attributes)
 CFLAGS-iogetdelim.c += -fexceptions
 CFLAGS-iogetline.c += -fexceptions
 CFLAGS-iogets.c += -fexceptions
@@ -153,14 +153,18 @@ CFLAGS-oldiofopen.c += -fexceptions
 CFLAGS-iofopen.c += -fexceptions
 CFLAGS-iofopen64.c += -fexceptions
 CFLAGS-oldtmpfile.c += -fexceptions
+CFLAGS-fileno.c += $(config-cflags-wno-ignored-attributes)
+CFLAGS-feof_u.c += $(config-cflags-wno-ignored-attributes)
+CFLAGS-ferror_u.c += $(config-cflags-wno-ignored-attributes)
+CFLAGS-getc_u.c += $(config-cflags-wno-ignored-attributes)
+CFLAGS-iofflush_u.c += $(config-cflags-wno-ignored-attributes)
+CFLAGS-putc_u.c += $(config-cflags-wno-ignored-attributes)
+CFLAGS-iofgets_u.c += $(config-cflags-wno-ignored-attributes)
+CFLAGS-iofputs_u.c += $(config-cflags-wno-ignored-attributes)
 # XXX Do we need filedoalloc and wfiledoalloc?  Others?
 
 CFLAGS-tst_putwc.c += -DOBJPFX=\"$(objpfx)\"
 
-# These test cases intentionally use overlapping arguments
-CFLAGS-tst-sprintf-ub.c += -Wno-restrict
-CFLAGS-tst-sprintf-chk-ub.c += -Wno-restrict
-
 LDFLAGS-tst-bz24228 = -Wl,--version-script=tst-bz24228.map
 
 tst_wprintf2-ARGS = "Some Text"
diff --git a/libio/__fpurge.c b/libio/__fpurge.c
index aa73ef2f..d012feeb 100644
--- a/libio/__fpurge.c
+++ b/libio/__fpurge.c
@@ -25,7 +25,7 @@ __fpurge (FILE *fp)
     {
       /* Wide-char stream.  */
       if (_IO_in_backup (fp))
-	_IO_free_wbackup_area (fp);
+	__libc_IO_free_wbackup_area (fp);
 
       fp->_wide_data->_IO_read_end = fp->_wide_data->_IO_read_ptr;
       fp->_wide_data->_IO_write_ptr = fp->_wide_data->_IO_write_base;
diff --git a/libio/bits/stdio-ldbl.h b/libio/bits/stdio-ldbl.h
deleted file mode 100644
index 6b63394b..00000000
--- a/libio/bits/stdio-ldbl.h
+++ /dev/null
@@ -1,108 +0,0 @@
-/* -mlong-double-64 compatibility mode for stdio functions.
-   Copyright (C) 2006-2022 Free Software Foundation, Inc.
-   This file is part of the GNU C Library.
-
-   The GNU C Library is free software; you can redistribute it and/or
-   modify it under the terms of the GNU Lesser General Public
-   License as published by the Free Software Foundation; either
-   version 2.1 of the License, or (at your option) any later version.
-
-   The GNU C Library is distributed in the hope that it will be useful,
-   but WITHOUT ANY WARRANTY; without even the implied warranty of
-   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
-   Lesser General Public License for more details.
-
-   You should have received a copy of the GNU Lesser General Public
-   License along with the GNU C Library; if not, see
-   <https://www.gnu.org/licenses/>.  */
-
-#ifndef _STDIO_H
-# error "Never include <bits/stdio-ldbl.h> directly; use <stdio.h> instead."
-#endif
-
-__LDBL_REDIR_DECL (fprintf)
-__LDBL_REDIR_DECL (printf)
-__LDBL_REDIR_DECL (sprintf)
-__LDBL_REDIR_DECL (vfprintf)
-__LDBL_REDIR_DECL (vprintf)
-__LDBL_REDIR_DECL (vsprintf)
-#if !__GLIBC_USE (DEPRECATED_SCANF)
-# if defined __LDBL_COMPAT
-__LDBL_REDIR1_DECL (fscanf, __nldbl___isoc99_fscanf)
-__LDBL_REDIR1_DECL (scanf, __nldbl___isoc99_scanf)
-__LDBL_REDIR1_DECL (sscanf, __nldbl___isoc99_sscanf)
-# elif __LDOUBLE_REDIRECTS_TO_FLOAT128_ABI == 1
-__LDBL_REDIR1_DECL (fscanf, __isoc99_fscanfieee128)
-__LDBL_REDIR1_DECL (scanf, __isoc99_scanfieee128)
-__LDBL_REDIR1_DECL (sscanf, __isoc99_sscanfieee128)
-# else
-#  error bits/stdlib-ldbl.h included when no ldbl redirections are required.
-# endif
-#else
-__LDBL_REDIR_DECL (fscanf)
-__LDBL_REDIR_DECL (scanf)
-__LDBL_REDIR_DECL (sscanf)
-#endif
-
-#if defined __USE_ISOC99 || defined __USE_UNIX98
-__LDBL_REDIR_DECL (snprintf)
-__LDBL_REDIR_DECL (vsnprintf)
-#endif
-
-#ifdef	__USE_ISOC99
-# if !__GLIBC_USE (DEPRECATED_SCANF)
-#  if defined __LDBL_COMPAT
-__LDBL_REDIR1_DECL (vfscanf, __nldbl___isoc99_vfscanf)
-__LDBL_REDIR1_DECL (vscanf, __nldbl___isoc99_vscanf)
-__LDBL_REDIR1_DECL (vsscanf, __nldbl___isoc99_vsscanf)
-#  elif __LDOUBLE_REDIRECTS_TO_FLOAT128_ABI == 1
-__LDBL_REDIR1_DECL (vfscanf, __isoc99_vfscanfieee128)
-__LDBL_REDIR1_DECL (vscanf, __isoc99_vscanfieee128)
-__LDBL_REDIR1_DECL (vsscanf, __isoc99_vsscanfieee128)
-#  else
-#   error bits/stdlib-ldbl.h included when no ldbl redirections are required.
-#  endif
-# else
-__LDBL_REDIR_DECL (vfscanf)
-__LDBL_REDIR_DECL (vsscanf)
-__LDBL_REDIR_DECL (vscanf)
-# endif
-#endif
-
-#ifdef __USE_XOPEN2K8
-__LDBL_REDIR_DECL (vdprintf)
-__LDBL_REDIR_DECL (dprintf)
-#endif
-
-#ifdef __USE_GNU
-__LDBL_REDIR_DECL (vasprintf)
-__LDBL_REDIR2_DECL (asprintf)
-__LDBL_REDIR_DECL (asprintf)
-__LDBL_REDIR_DECL (obstack_printf)
-__LDBL_REDIR_DECL (obstack_vprintf)
-#endif
-
-#if __USE_FORTIFY_LEVEL > 0 && defined __fortify_function
-__LDBL_REDIR2_DECL (sprintf_chk)
-__LDBL_REDIR2_DECL (vsprintf_chk)
-# if defined __USE_ISOC99 || defined __USE_UNIX98
-__LDBL_REDIR2_DECL (snprintf_chk)
-__LDBL_REDIR2_DECL (vsnprintf_chk)
-# endif
-# if __USE_FORTIFY_LEVEL > 1
-__LDBL_REDIR2_DECL (fprintf_chk)
-__LDBL_REDIR2_DECL (printf_chk)
-__LDBL_REDIR2_DECL (vfprintf_chk)
-__LDBL_REDIR2_DECL (vprintf_chk)
-#  ifdef __USE_XOPEN2K8
-__LDBL_REDIR2_DECL (dprintf_chk)
-__LDBL_REDIR2_DECL (vdprintf_chk)
-#  endif
-#  ifdef __USE_GNU
-__LDBL_REDIR2_DECL (asprintf_chk)
-__LDBL_REDIR2_DECL (vasprintf_chk)
-__LDBL_REDIR2_DECL (obstack_printf_chk)
-__LDBL_REDIR2_DECL (obstack_vprintf_chk)
-#  endif
-# endif
-#endif
diff --git a/libio/bits/stdio2.h b/libio/bits/stdio2.h
index b0b655ee..de7f1f04 100644
--- a/libio/bits/stdio2.h
+++ b/libio/bits/stdio2.h
@@ -23,12 +23,17 @@
 # error "Never include <bits/stdio2.h> directly; use <stdio.h> instead."
 #endif
 
-extern int __sprintf_chk (char *__restrict __s, int __flag, size_t __slen,
-			  const char *__restrict __format, ...) __THROW
+extern int __REDIRECT_LDBL_NTHNL (__sprintf_chk, (char *__restrict __s,
+						  int __flag, size_t __slen,
+						  const char *__restrict __format,
+						  ...),
+				  __sprintf_chkieee128, __nldbl___sprintf_chk)
     __attr_access ((__write_only__, 1, 3));
-extern int __vsprintf_chk (char *__restrict __s, int __flag, size_t __slen,
-			   const char *__restrict __format,
-			   __gnuc_va_list __ap) __THROW
+extern int __REDIRECT_LDBL_NTHNL (__vsprintf_chk, (char *__restrict __s,
+						   int __flag, size_t __slen,
+						   const char *__restrict __format,
+						   __gnuc_va_list __ap),
+				  __vsprintf_chkieee128, __nldbl___vsprintf_chk)
     __attr_access ((__write_only__, 1, 3));
 
 #ifdef __va_arg_pack
@@ -54,14 +59,19 @@ __NTH (vsprintf (char *__restrict __s, const char *__restrict __fmt,
 }
 
 #if defined __USE_ISOC99 || defined __USE_UNIX98
-
-extern int __snprintf_chk (char *__restrict __s, size_t __n, int __flag,
-			   size_t __slen, const char *__restrict __format,
-			   ...) __THROW
+extern int __REDIRECT_LDBL_NTHNL (__snprintf_chk, (char *__restrict __s,
+						   size_t __n, int __flag,
+						   size_t __slen,
+						   const char *__restrict __format,
+						   ...),
+				  __snprintf_chkieee128, __nldbl___snprintf_chk)
     __attr_access ((__write_only__, 1, 2));
-extern int __vsnprintf_chk (char *__restrict __s, size_t __n, int __flag,
-			    size_t __slen, const char *__restrict __format,
-			    __gnuc_va_list __ap) __THROW;
+extern int __REDIRECT_LDBL_NTHNL (__vsnprintf_chk, (char *__restrict __s,
+						    size_t __n, int __flag,
+						    size_t __slen,
+						    const char *__restrict __format,
+						    __gnuc_va_list __ap),
+				  __vsnprintf_chkieee128, __nldbl___vsnprintf_chk);
 
 # ifdef __va_arg_pack
 __fortify_function int
@@ -89,14 +99,24 @@ __NTH (vsnprintf (char *__restrict __s, size_t __n,
 #endif
 
 #if __USE_FORTIFY_LEVEL > 1
-
-extern int __fprintf_chk (FILE *__restrict __stream, int __flag,
-			  const char *__restrict __format, ...);
-extern int __printf_chk (int __flag, const char *__restrict __format, ...);
-extern int __vfprintf_chk (FILE *__restrict __stream, int __flag,
-			   const char *__restrict __format, __gnuc_va_list __ap);
-extern int __vprintf_chk (int __flag, const char *__restrict __format,
-			  __gnuc_va_list __ap);
+extern int __REDIRECT_LDBL (__fprintf_chk, (FILE *__restrict __stream,
+					    int __flag,
+					    const char *__restrict __format,
+					    ...),
+			    __fprintf_chkieee128, __nldbl___fprintf_chk);
+extern int __REDIRECT_LDBL (__printf_chk, (int __flag,
+					   const char *__restrict __format,
+					   ...),
+			    __printf_chkieee128, __nldbl___printf_chk);
+extern int __REDIRECT_LDBL (__vfprintf_chk, (FILE *__restrict __stream,
+					     int __flag,
+					     const char *__restrict __format,
+					     __gnuc_va_list __ap),
+			    __vfprintf_chkieee128, __nldbl___vfprintf_chk);
+extern int __REDIRECT_LDBL (__vprintf_chk, (int __flag,
+					    const char *__restrict __format,
+					    __gnuc_va_list __ap),
+			    __vprintf_chkieee128, __nldbl___vprintf_chk);
 
 # ifdef __va_arg_pack
 __fortify_function int
@@ -136,10 +156,15 @@ vfprintf (FILE *__restrict __stream,
 }
 
 # ifdef __USE_XOPEN2K8
-extern int __dprintf_chk (int __fd, int __flag, const char *__restrict __fmt,
-			  ...) __attribute__ ((__format__ (__printf__, 3, 4)));
-extern int __vdprintf_chk (int __fd, int __flag,
-			   const char *__restrict __fmt, __gnuc_va_list __arg)
+extern int __REDIRECT_LDBL (__dprintf_chk, (int __fd, int __flag,
+					    const char *__restrict __fmt,
+					    ...),
+			    __dprintf_chkieee128, __nldbl___dprintf_chk)
+     __attribute__ ((__format__ (__printf__, 3, 4)));
+extern int __REDIRECT_LDBL (__vdprintf_chk, (int __fd, int __flag,
+					     const char *__restrict __fmt,
+					     __gnuc_va_list __arg),
+			    __vdprintf_chkieee128, __nldbl___vdprintf_chk)
      __attribute__ ((__format__ (__printf__, 3, 0)));
 
 #  ifdef __va_arg_pack
@@ -162,22 +187,32 @@ vdprintf (int __fd, const char *__restrict __fmt, __gnuc_va_list __ap)
 # endif
 
 # ifdef __USE_GNU
-
-extern int __asprintf_chk (char **__restrict __ptr, int __flag,
-			   const char *__restrict __fmt, ...)
-     __THROW __attribute__ ((__format__ (__printf__, 3, 4))) __wur;
-extern int __vasprintf_chk (char **__restrict __ptr, int __flag,
-			    const char *__restrict __fmt, __gnuc_va_list __arg)
-     __THROW __attribute__ ((__format__ (__printf__, 3, 0))) __wur;
-extern int __obstack_printf_chk (struct obstack *__restrict __obstack,
-				 int __flag, const char *__restrict __format,
-				 ...)
-     __THROW __attribute__ ((__format__ (__printf__, 3, 4)));
-extern int __obstack_vprintf_chk (struct obstack *__restrict __obstack,
-				  int __flag,
-				  const char *__restrict __format,
-				  __gnuc_va_list __args)
-     __THROW __attribute__ ((__format__ (__printf__, 3, 0)));
+extern int __REDIRECT_LDBL_NTHNL (__asprintf_chk, (char **__restrict __ptr,
+						   int __flag,
+						   const char *__restrict __fmt,
+						   ...),
+				  __asprintf_chkieee128, __nldbl___asprintf_chk)
+     __attribute__ ((__format__ (__printf__, 3, 4))) __wur;
+extern int __REDIRECT_LDBL_NTHNL (__vasprintf_chk, (char **__restrict __ptr,
+						    int __flag,
+						    const char *__restrict __fmt,
+						    __gnuc_va_list __arg),
+				  __vasprintf_chkieee128, __nldbl___vasnprintf_chk)
+     __attribute__ ((__format__ (__printf__, 3, 0))) __wur;
+extern int __REDIRECT_LDBL_NTHNL (__obstack_printf_chk, (struct obstack *__restrict __obstack,
+							 int __flag,
+							 const char *__restrict __format,
+							 ...),
+				  __obstack_printf_chkieee128,
+				  __nldbl___obstack_printf_chk)
+     __attribute__ ((__format__ (__printf__, 3, 4)));
+extern int __REDIRECT_LDBL_NTHNL (__obstack_vprintf_chk, (struct obstack *__restrict __obstack,
+							  int __flag,
+							  const char *__restrict __format,
+							  __gnuc_va_list __args),
+				  __obstack_vprintf_chkieee128,
+				  __nldbl___obstack_vprintf_chk)
+     __attribute__ ((__format__ (__printf__, 3, 0)));
 
 #  ifdef __va_arg_pack
 __fortify_function int
diff --git a/libio/feof_u.c b/libio/feof_u.c
index 5b7477ef..3db56109 100644
--- a/libio/feof_u.c
+++ b/libio/feof_u.c
@@ -30,10 +30,9 @@
 #undef feof_unlocked
 
 int
-__feof_unlocked (FILE *fp)
+__libc_feof_unlocked (FILE *fp)
 {
   CHECK_FILE (fp, EOF);
   return _IO_feof_unlocked (fp);
 }
-weak_alias (__feof_unlocked, feof_unlocked)
-libc_hidden_weak (feof_unlocked)
+weak_alias (__libc_feof_unlocked, feof_unlocked)
diff --git a/libio/ferror_u.c b/libio/ferror_u.c
index edba404d..ea2a97db 100644
--- a/libio/ferror_u.c
+++ b/libio/ferror_u.c
@@ -30,10 +30,9 @@
 #undef ferror_unlocked
 
 int
-__ferror_unlocked (FILE *fp)
+__libc_ferror_unlocked (FILE *fp)
 {
   CHECK_FILE (fp, EOF);
   return _IO_ferror_unlocked (fp);
 }
 weak_alias (__ferror_unlocked, ferror_unlocked)
-libc_hidden_weak (ferror_unlocked)
diff --git a/libio/fileops.c b/libio/fileops.c
index 41c18be7..289a5511 100644
--- a/libio/fileops.c
+++ b/libio/fileops.c
@@ -145,7 +145,7 @@ _IO_new_file_close_it (FILE *fp)
   if (fp->_mode > 0)
     {
       if (_IO_have_wbackup (fp))
-	_IO_free_wbackup_area (fp);
+	__libc_IO_free_wbackup_area (fp);
       _IO_wsetb (fp, NULL, NULL, 0);
       _IO_wsetg (fp, NULL, NULL, NULL);
       _IO_wsetp (fp, NULL, NULL);
@@ -1318,7 +1318,7 @@ _IO_file_xsgetn (FILE *fp, void *data, size_t n)
 	  if (fp->_IO_buf_base
 	      && want < (size_t) (fp->_IO_buf_end - fp->_IO_buf_base))
 	    {
-	      if (__underflow (fp) == EOF)
+	      if (__libc_underflow (fp) == EOF)
 		break;
 
 	      continue;
diff --git a/libio/fputc_u.c b/libio/fputc_u.c
index a479c8bf..0d5998a7 100644
--- a/libio/fputc_u.c
+++ b/libio/fputc_u.c
@@ -35,4 +35,3 @@ fputc_unlocked (int c, FILE *fp)
   CHECK_FILE (fp, EOF);
   return _IO_putc_unlocked (c, fp);
 }
-libc_hidden_def (fputc_unlocked)
diff --git a/libio/genops.c b/libio/genops.c
index 1b629eb6..48c202d0 100644
--- a/libio/genops.c
+++ b/libio/genops.c
@@ -195,14 +195,15 @@ _IO_free_backup_area (FILE *fp)
 libc_hidden_def (_IO_free_backup_area)
 
 int
-__overflow (FILE *f, int ch)
+__libc_overflow (FILE *f, int ch)
 {
   /* This is a single-byte stream.  */
   if (f->_mode == 0)
     _IO_fwide (f, -1);
   return _IO_OVERFLOW (f, ch);
 }
-libc_hidden_def (__overflow)
+libc_hidden_def (__libc_overflow)
+strong_alias (__libc_overflow, __overflow)
 
 static int
 save_for_backup (FILE *fp, char *end_p)
@@ -265,7 +266,7 @@ save_for_backup (FILE *fp, char *end_p)
 }
 
 int
-__underflow (FILE *fp)
+__libc_underflow (FILE *fp)
 {
   if (_IO_vtable_offset (fp) == 0 && _IO_fwide (fp, -1) != -1)
     return EOF;
@@ -292,10 +293,11 @@ __underflow (FILE *fp)
     _IO_free_backup_area (fp);
   return _IO_UNDERFLOW (fp);
 }
-libc_hidden_def (__underflow)
+libc_hidden_def (__libc_underflow)
+strong_alias (__libc_underflow, __underflow)
 
 int
-__uflow (FILE *fp)
+__libc_uflow (FILE *fp)
 {
   if (_IO_vtable_offset (fp) == 0 && _IO_fwide (fp, -1) != -1)
     return EOF;
@@ -322,7 +324,8 @@ __uflow (FILE *fp)
     _IO_free_backup_area (fp);
   return _IO_UFLOW (fp);
 }
-libc_hidden_def (__uflow)
+libc_hidden_def (__libc_uflow)
+strong_alias (__libc_uflow, __uflow)
 
 void
 _IO_setb (FILE *f, char *b, char *eb, int a)
@@ -440,7 +443,7 @@ _IO_default_xsgetn (FILE *fp, void *data, size_t n)
 	    }
 	    more -= count;
 	}
-      if (more == 0 || __underflow (fp) == EOF)
+      if (more == 0 || __libc_underflow (fp) == EOF)
 	break;
     }
   return n - more;
diff --git a/libio/getc_u.c b/libio/getc_u.c
index 6757a179..e53ef667 100644
--- a/libio/getc_u.c
+++ b/libio/getc_u.c
@@ -30,12 +30,11 @@
 #undef getc_unlocked
 
 int
-__getc_unlocked (FILE *fp)
+__libc_getc_unlocked (FILE *fp)
 {
   CHECK_FILE (fp, EOF);
   return _IO_getc_unlocked (fp);
 }
 
-weak_alias (__getc_unlocked, getc_unlocked)
-libc_hidden_weak (getc_unlocked)
-weak_alias (__getc_unlocked, fgetc_unlocked)
+weak_alias (__libc_getc_unlocked, getc_unlocked)
+weak_alias (__libc_getc_unlocked, fgetc_unlocked)
diff --git a/libio/iogetdelim.c b/libio/iogetdelim.c
index b6c4c07b..44a0b753 100644
--- a/libio/iogetdelim.c
+++ b/libio/iogetdelim.c
@@ -37,7 +37,7 @@
    null terminator), or -1 on error or EOF.  */
 
 ssize_t
-__getdelim (char **lineptr, size_t *n, int delimiter, FILE *fp)
+__libc_getdelim (char **lineptr, size_t *n, int delimiter, FILE *fp)
 {
   ssize_t result;
   ssize_t cur_len = 0;
@@ -70,7 +70,7 @@ __getdelim (char **lineptr, size_t *n, int delimiter, FILE *fp)
   len = fp->_IO_read_end - fp->_IO_read_ptr;
   if (len <= 0)
     {
-      if (__underflow (fp) == EOF)
+      if (__libc_underflow (fp) == EOF)
 	{
 	  result = -1;
 	  goto unlock_return;
@@ -111,7 +111,7 @@ __getdelim (char **lineptr, size_t *n, int delimiter, FILE *fp)
       memcpy (*lineptr + cur_len, (void *) fp->_IO_read_ptr, len);
       fp->_IO_read_ptr += len;
       cur_len += len;
-      if (t != NULL || __underflow (fp) == EOF)
+      if (t != NULL || __libc_underflow (fp) == EOF)
 	break;
       len = fp->_IO_read_end - fp->_IO_read_ptr;
     }
@@ -122,5 +122,6 @@ unlock_return:
   _IO_release_lock (fp);
   return result;
 }
-libc_hidden_def (__getdelim)
+libc_hidden_def (__libc_getdelim)
+strong_alias (__libc_getdelim, __getdelim)
 weak_alias (__getdelim, getdelim)
diff --git a/libio/iogetline.c b/libio/iogetline.c
index f5c3ec38..f937773e 100644
--- a/libio/iogetline.c
+++ b/libio/iogetline.c
@@ -57,7 +57,7 @@ _IO_getline_info (FILE *fp, char *buf, size_t n, int delim,
       ssize_t len = fp->_IO_read_end - fp->_IO_read_ptr;
       if (len <= 0)
 	{
-	  int c = __uflow (fp);
+	  int c = __libc_uflow (fp);
 	  if (c == EOF)
 	    {
 	      if (eof)
diff --git a/libio/ioseekoff.c b/libio/ioseekoff.c
index 6c077cdf..94673229 100644
--- a/libio/ioseekoff.c
+++ b/libio/ioseekoff.c
@@ -53,7 +53,7 @@ _IO_seekoff_unlocked (FILE *fp, off64_t offset, int dir, int mode)
       if (_IO_fwide (fp, 0) < 0)
 	_IO_free_backup_area (fp);
       else
-	_IO_free_wbackup_area (fp);
+	__libc_IO_free_wbackup_area (fp);
     }
 
   return _IO_SEEKOFF (fp, offset, dir, mode);
diff --git a/libio/ioseekpos.c b/libio/ioseekpos.c
index 31d70fc2..5e241157 100644
--- a/libio/ioseekpos.c
+++ b/libio/ioseekpos.c
@@ -40,7 +40,7 @@ _IO_seekpos_unlocked (FILE *fp, off64_t pos, int mode)
   else
     {
       if (_IO_have_wbackup (fp))
-	_IO_free_wbackup_area (fp);
+	__libc_IO_free_wbackup_area (fp);
     }
 
   return _IO_SEEKOFF (fp, pos, 0, mode);
diff --git a/libio/libio.h b/libio/libio.h
index d0184df8..cb3754fa 100644
--- a/libio/libio.h
+++ b/libio/libio.h
@@ -156,17 +156,27 @@ extern void _IO_cookie_init (struct _IO_cookie_file *__cfile, int __read_write,
 			     void *__cookie, cookie_io_functions_t __fns);
 
 extern int __underflow (FILE *);
-extern wint_t __wunderflow (FILE *);
-extern wint_t __wuflow (FILE *);
-extern wint_t __woverflow (FILE *, wint_t);
+hidden_proto2 (__underflow, __libc_underflow)
+extern wint_t hidden_proto3 (__wunderflow, (FILE *));
+extern wint_t hidden_proto3 (__wuflow, (FILE *));
+extern wint_t hidden_proto3 (__woverflow, (FILE *, wint_t));
+
+hidden_proto2 (__overflow, __libc_overflow)
+hidden_proto2 (__uflow, __libc_uflow)
+
+#define _IO_getc_unlocked(_fp)						\
+  (__glibc_unlikely ((_fp)->_IO_read_ptr >= (_fp)->_IO_read_end)        \
+   ? __libc_uflow (_fp) : *(unsigned char *) (_fp)->_IO_read_ptr++)
 
-#define _IO_getc_unlocked(_fp) __getc_unlocked_body (_fp)
 #define _IO_peekc_unlocked(_fp)						\
   (__glibc_unlikely ((_fp)->_IO_read_ptr >= (_fp)->_IO_read_end)	\
-   && __underflow (_fp) == EOF						\
+   && __libc_underflow (_fp) == EOF						\
    ? EOF								\
    : *(unsigned char *) (_fp)->_IO_read_ptr)
-#define _IO_putc_unlocked(_ch, _fp) __putc_unlocked_body (_ch, _fp)
+#define _IO_putc_unlocked(_ch, _fp)					\
+  (__glibc_unlikely ((_fp)->_IO_write_ptr >= (_fp)->_IO_write_end)	\
+      ? __libc_overflow (_fp, (unsigned char) (_ch))			\
+         : (unsigned char) (*(_fp)->_IO_write_ptr++ = (_ch)))
 
 # define _IO_getwc_unlocked(_fp)					\
   (__glibc_unlikely ((_fp)->_wide_data == NULL				\
@@ -214,13 +224,13 @@ extern int _IO_ftrylockfile (FILE *) __THROW;
 
 extern int _IO_vfscanf (FILE * __restrict, const char * __restrict,
 			__gnuc_va_list, int *__restrict);
-extern __ssize_t _IO_padn (FILE *, int, __ssize_t);
-extern size_t _IO_sgetn (FILE *, void *, size_t);
+extern __ssize_t hidden_proto3 (_IO_padn, (FILE *, int, __ssize_t));
+extern size_t hidden_proto3 (_IO_sgetn, (FILE *, void *, size_t));
 
 extern off64_t _IO_seekoff (FILE *, off64_t, int, int);
 extern off64_t _IO_seekpos (FILE *, off64_t, int);
 
-extern void _IO_free_backup_area (FILE *) __THROW;
+extern void hidden_proto3 (_IO_free_backup_area, (FILE *)) __THROW;
 
 
 extern wint_t _IO_getwc (FILE *__fp);
@@ -255,23 +265,14 @@ weak_extern (_IO_stdin_used);
 
 extern __ssize_t _IO_wpadn (FILE *, wint_t, __ssize_t);
 extern void _IO_free_wbackup_area (FILE *) __THROW;
+hidden_proto2 (_IO_free_wbackup_area, __libc_IO_free_wbackup_area)
 
 #ifdef __LDBL_COMPAT
-__LDBL_REDIR_DECL (_IO_vfscanf)
+extern int __REDIRECT_LDBL_COMPAT (_IO_vfscanf, (FILE * __restrict,
+						 const char * __restrict,
+						 __gnuc_va_list, int *__restrict));
 #endif
 
-libc_hidden_proto (__overflow)
-libc_hidden_proto (__underflow)
-libc_hidden_proto (__uflow)
-libc_hidden_proto (__woverflow)
-libc_hidden_proto (__wunderflow)
-libc_hidden_proto (__wuflow)
-libc_hidden_proto (_IO_free_backup_area)
-libc_hidden_proto (_IO_free_wbackup_area)
-libc_hidden_proto (_IO_padn)
-libc_hidden_proto (_IO_putc)
-libc_hidden_proto (_IO_sgetn)
-
 #ifdef _IO_MTSAFE_IO
 # undef _IO_peekc
 # undef _IO_flockfile
diff --git a/libio/oldfileops.c b/libio/oldfileops.c
index ea3b8644..ceb5ea31 100644
--- a/libio/oldfileops.c
+++ b/libio/oldfileops.c
@@ -691,7 +691,7 @@ _IO_old_file_xsputn (FILE *f, const void *data, size_t n)
     {
       size_t block_size, do_write;
       /* Next flush the (full) buffer. */
-      if (__overflow (f, EOF) == EOF)
+      if (__libc_overflow (f, EOF) == EOF)
 	return to_do == 0 ? EOF : n - to_do;
 
       /* Try to maintain alignment: write a whole number of blocks.
diff --git a/libio/putc.c b/libio/putc.c
index 7036c5b6..075e9d05 100644
--- a/libio/putc.c
+++ b/libio/putc.c
@@ -32,7 +32,6 @@ _IO_putc (int c, FILE *fp)
   _IO_release_lock (fp);
   return result;
 }
-libc_hidden_def (_IO_putc)
 
 #undef putc
 
diff --git a/libio/putc_u.c b/libio/putc_u.c
index e518685c..c6936b57 100644
--- a/libio/putc_u.c
+++ b/libio/putc_u.c
@@ -21,10 +21,9 @@
 #undef putc_unlocked
 
 int
-__putc_unlocked (int c, FILE *fp)
+__libc_putc_unlocked (int c, FILE *fp)
 {
   CHECK_FILE (fp, EOF);
   return _IO_putc_unlocked (c, fp);
 }
-weak_alias (__putc_unlocked, putc_unlocked)
-libc_hidden_weak (putc_unlocked)
+weak_alias (__libc_putc_unlocked, putc_unlocked)
diff --git a/libio/stdio.h b/libio/stdio.h
index e6425341..54c9796a 100644
--- a/libio/stdio.h
+++ b/libio/stdio.h
@@ -41,6 +41,7 @@ __BEGIN_DECLS
 #include <bits/types/__FILE.h>
 #include <bits/types/FILE.h>
 #include <bits/types/struct_FILE.h>
+#include <bits/floatn.h>
 
 #ifdef __USE_GNU
 # include <bits/types/cookie_io_functions_t.h>
@@ -342,78 +343,143 @@ extern void setbuffer (FILE *__restrict __stream, char *__restrict __buf,
 extern void setlinebuf (FILE *__stream) __THROW;
 #endif
 
-
 /* Write formatted output to STREAM.
 
    This function is a possible cancellation point and therefore not
    marked with __THROW.  */
-extern int fprintf (FILE *__restrict __stream,
-		    const char *__restrict __format, ...);
+extern int __REDIRECT_LDBL (fprintf, (FILE *__restrict __stream,
+				      const char *__restrict __format, ...),
+			    __fprintfieee128, __nldbl_fprintf);
 /* Write formatted output to stdout.
 
    This function is a possible cancellation point and therefore not
    marked with __THROW.  */
-extern int printf (const char *__restrict __format, ...);
+extern int __REDIRECT_LDBL (printf, (const char *__restrict __format, ...),
+			    __printfieee128, __nldbl_printf);
 /* Write formatted output to S.  */
-extern int sprintf (char *__restrict __s,
-		    const char *__restrict __format, ...) __THROWNL;
+extern int __REDIRECT_LDBL_NTHNL (sprintf, (char *__restrict __s,
+					    const char *__restrict __format,
+					    ...),
+				  __sprintfieee128, __nldbl_sprintf);
 
 /* Write formatted output to S from argument list ARG.
 
    This function is a possible cancellation point and therefore not
    marked with __THROW.  */
-extern int vfprintf (FILE *__restrict __s, const char *__restrict __format,
-		     __gnuc_va_list __arg);
+extern int __REDIRECT_LDBL (vfprintf, (FILE *__restrict __s,
+				       const char *__restrict __format,
+				       __gnuc_va_list __arg),
+			    __vfprintfieee128, __nldbl_vfprintf);
 /* Write formatted output to stdout from argument list ARG.
 
    This function is a possible cancellation point and therefore not
    marked with __THROW.  */
-extern int vprintf (const char *__restrict __format, __gnuc_va_list __arg);
+extern int __REDIRECT_LDBL (vprintf, (const char *__restrict __format,
+				      __gnuc_va_list __arg),
+			    __vprintfieee128, __nldbl_vprintf);
 /* Write formatted output to S from argument list ARG.  */
-extern int vsprintf (char *__restrict __s, const char *__restrict __format,
-		     __gnuc_va_list __arg) __THROWNL;
+extern int __REDIRECT_LDBL_NTHNL (vsprintf, (char *__restrict __s,
+					     const char *__restrict __format,
+					     __gnuc_va_list __arg),
+				  __vsprintfieee128, __nldbl_vsprintf);
 
 #if defined __USE_ISOC99 || defined __USE_UNIX98
 /* Maximum chars of output to write in MAXLEN.  */
-extern int snprintf (char *__restrict __s, size_t __maxlen,
-		     const char *__restrict __format, ...)
-     __THROWNL __attribute__ ((__format__ (__printf__, 3, 4)));
-
-extern int vsnprintf (char *__restrict __s, size_t __maxlen,
-		      const char *__restrict __format, __gnuc_va_list __arg)
-     __THROWNL __attribute__ ((__format__ (__printf__, 3, 0)));
+extern int __REDIRECT_LDBL_NTHNL (snprintf, (char *__restrict __s,
+					     size_t __maxlen,
+					     const char *__restrict __format,
+					     ...),
+				  __snprintfieee128, __nldbl_snprintf)
+     __attribute__ ((__format__ (__printf__, 3, 4)));
+extern int __REDIRECT_LDBL_NTHNL (vsnprintf, (char *__restrict __s,
+					      size_t __maxlen,
+					      const char *__restrict __format,
+					      __gnuc_va_list __arg),
+				  __vsnprintfieee128, __nldbl_vsnprintf)
+     __attribute__ ((__format__ (__printf__, 3, 0)));
 #endif
 
 #if __GLIBC_USE (LIB_EXT2)
 /* Write formatted output to a string dynamically allocated with `malloc'.
    Store the address of the string in *PTR.  */
-extern int vasprintf (char **__restrict __ptr, const char *__restrict __f,
-		      __gnuc_va_list __arg)
-     __THROWNL __attribute__ ((__format__ (__printf__, 2, 0))) __wur;
-extern int __asprintf (char **__restrict __ptr,
-		       const char *__restrict __fmt, ...)
-     __THROWNL __attribute__ ((__format__ (__printf__, 2, 3))) __wur;
-extern int asprintf (char **__restrict __ptr,
-		     const char *__restrict __fmt, ...)
-     __THROWNL __attribute__ ((__format__ (__printf__, 2, 3))) __wur;
+extern int __REDIRECT_LDBL_NTHNL (vasprintf, (char **__restrict __ptr,
+					      const char *__restrict __f,
+					      __gnuc_va_list __arg),
+				  __vasprintfieee128, __nldbl_vasprintf)
+     __attribute__ ((__format__ (__printf__, 2, 0))) __wur;
+extern int __REDIRECT_LDBL_NTHNL (asprintf, (char **__restrict __ptr,
+					     const char *__restrict __fmt,
+					     ...),
+				  __asprintfieee128, __nldbl_asprintf)
+     __attribute__ ((__format__ (__printf__, 2, 3))) __wur;
 #endif
 
 #ifdef __USE_XOPEN2K8
 /* Write formatted output to a file descriptor.  */
-extern int vdprintf (int __fd, const char *__restrict __fmt,
-		     __gnuc_va_list __arg)
+extern int __REDIRECT_LDBL (vdprintf, (int __fd, const char *__restrict __fmt,
+				       __gnuc_va_list __arg),
+			    __vdprintfieee128, __nldbl_vdprintf)
      __attribute__ ((__format__ (__printf__, 2, 0)));
-extern int dprintf (int __fd, const char *__restrict __fmt, ...)
+extern int __REDIRECT_LDBL (dprintf, (int __fd, const char *__restrict __fmt,
+				      ...),
+			    __dprintfieee128, __nldbl_dprintf)
      __attribute__ ((__format__ (__printf__, 2, 3)));
 #endif
 
-
+#if !__GLIBC_USE (DEPRECATED_SCANF)
+# if __LDOUBLE_REDIRECTS_TO_FLOAT128_ABI == 1 || defined __LDBL_COMPAT
+extern int __REDIRECT_LDBL (fscanf, (FILE *__restrict __stream,
+				     const char *__restrict __format,
+				     ...),
+			    __isoc99_fscanfieee128, __nldbl___isoc99_fscanf) __wur;
+extern int __REDIRECT_LDBL (scanf, (const char *__restrict __format,
+				    ...),
+			    __isoc99_scanfieee128, __nldbl___isoc99_scanf) __wur;
+extern int __REDIRECT_LDBL_NTH (sscanf, (const char *__restrict __s,
+					 const char *__restrict __format,
+					 ...),
+			    __isoc99_sscanfieee128, __nldbl___isoc99_sscanf);
+# else
+#  ifdef __REDIRECT
+extern int __REDIRECT (fscanf, (FILE *__restrict __stream,
+                                const char *__restrict __format, ...),
+                       __isoc99_fscanf) __wur;
+extern int __REDIRECT (scanf, (const char *__restrict __format, ...),
+                       __isoc99_scanf) __wur;
+extern int __REDIRECT_NTH (sscanf, (const char *__restrict __s,
+                                    const char *__restrict __format, ...),
+                           __isoc99_sscanf);
+#  else
+extern int __isoc99_fscanf (FILE *__restrict __stream,
+                            const char *__restrict __format, ...) __wur;
+extern int __isoc99_scanf (const char *__restrict __format, ...) __wur;
+extern int __isoc99_sscanf (const char *__restrict __s,
+                            const char *__restrict __format, ...) __THROW;
+#   define fscanf __isoc99_fscanf
+#   define scanf __isoc99_scanf
+#   define sscanf __isoc99_sscanf
+#  endif /* __REDIRECT */
+# endif
+#else
+# if __LDOUBLE_REDIRECTS_TO_FLOAT128_ABI == 1 || defined __LDBL_COMPAT
+extern int __REDIRECT_LDBL (fscanf, (FILE *__restrict __stream,
+				     const char *__restrict __format,
+				     ...),
+			    __fscanfieee128, __nldbl_fscanf) __wur;
+extern int __REDIRECT_LDBL (scanf, (const char *__restrict __format,
+				    ...),
+			    __scanfieee128, __nldbl_scanf) __wur;
+extern int __REDIRECT_LDBL_NTH (sscanf, (const char *__restrict __s,
+					 const char *__restrict __format,
+					 ...),
+				__sscanfieee128, __nldbl_sscanf) __wur;
+# else
 /* Read formatted input from STREAM.
 
    This function is a possible cancellation point and therefore not
    marked with __THROW.  */
 extern int fscanf (FILE *__restrict __stream,
-		   const char *__restrict __format, ...) __wur;
+                   const char *__restrict __format, ...) __wur;
 /* Read formatted input from stdin.
 
    This function is a possible cancellation point and therefore not
@@ -421,43 +487,81 @@ extern int fscanf (FILE *__restrict __stream,
 extern int scanf (const char *__restrict __format, ...) __wur;
 /* Read formatted input from S.  */
 extern int sscanf (const char *__restrict __s,
-		   const char *__restrict __format, ...) __THROW;
-
-/* For historical reasons, the C99-compliant versions of the scanf
-   functions are at alternative names.  When __LDBL_COMPAT or
-   __LDOUBLE_REDIRECTS_TO_FLOAT128_ABI are in effect, this is handled in
-   bits/stdio-ldbl.h.  */
-#include <bits/floatn.h>
-#if !__GLIBC_USE (DEPRECATED_SCANF) && !defined __LDBL_COMPAT \
-    && __LDOUBLE_REDIRECTS_TO_FLOAT128_ABI == 0
-# ifdef __REDIRECT
-extern int __REDIRECT (fscanf, (FILE *__restrict __stream,
-				const char *__restrict __format, ...),
-		       __isoc99_fscanf) __wur;
-extern int __REDIRECT (scanf, (const char *__restrict __format, ...),
-		       __isoc99_scanf) __wur;
-extern int __REDIRECT_NTH (sscanf, (const char *__restrict __s,
-				    const char *__restrict __format, ...),
-			   __isoc99_sscanf);
-# else
-extern int __isoc99_fscanf (FILE *__restrict __stream,
-			    const char *__restrict __format, ...) __wur;
-extern int __isoc99_scanf (const char *__restrict __format, ...) __wur;
-extern int __isoc99_sscanf (const char *__restrict __s,
-			    const char *__restrict __format, ...) __THROW;
-#  define fscanf __isoc99_fscanf
-#  define scanf __isoc99_scanf
-#  define sscanf __isoc99_sscanf
+                   const char *__restrict __format, ...) __THROW;
 # endif
-#endif
+#endif /* DEPRECATED_SCANF */
 
-#ifdef	__USE_ISOC99
+#ifdef __USE_ISOC99
+# if !__GLIBC_USE (DEPRECATED_SCANF)
+#  if __LDOUBLE_REDIRECTS_TO_FLOAT128_ABI == 1 || defined __LDBL_COMPAT
+extern int __REDIRECT_LDBL (vfscanf, (FILE *__restrict __stream,
+				      const char *__restrict __format,
+				      __gnuc_va_list __arg),
+			    __isoc99_vfscanfieee128, __nldbl___isoc99_vfscanf)
+     __attribute__ ((__format__ (__scanf__, 2, 0))) __wur;
+extern int __REDIRECT_LDBL (vscanf, (const char *__restrict __format,
+				     __gnuc_va_list __arg),
+			    __isoc99_vscanfieee128, __nldbl___isoc99_vscanf)
+     __attribute__ ((__format__ (__scanf__, 1, 0))) __wur;
+extern int __REDIRECT_LDBL_NTH (vsscanf, (const char *__restrict __s,
+					  const char *__restrict __format,
+					  __gnuc_va_list __arg),
+				__isoc99_vsscanfieee128, __nldbl___isoc99_vsscanf)
+     __attribute__ ((__format__ (__scanf__, 2, 0)));
+#  else
+#   ifdef __REDIRECT
+extern int __REDIRECT (vfscanf,
+                       (FILE *__restrict __s,
+                        const char *__restrict __format, __gnuc_va_list __arg),
+                       __isoc99_vfscanf)
+     __attribute__ ((__format__ (__scanf__, 2, 0))) __wur;
+extern int __REDIRECT (vscanf, (const char *__restrict __format,
+                                __gnuc_va_list __arg),
+		       __isoc99_vscanf)
+     __attribute__ ((__format__ (__scanf__, 1, 0))) __wur;
+extern int __REDIRECT_NTH (vsscanf,
+                           (const char *__restrict __s,
+                            const char *__restrict __format,
+                            __gnuc_va_list __arg),
+			   __isoc99_vsscanf)
+     __attribute__ ((__format__ (__scanf__, 2, 0)));
+#   else
+extern int __isoc99_vfscanf (FILE *__restrict __s,
+                             const char *__restrict __format,
+                             __gnuc_va_list __arg) __wur;
+extern int __isoc99_vscanf (const char *__restrict __format,
+                            __gnuc_va_list __arg) __wur;
+extern int __isoc99_vsscanf (const char *__restrict __s,
+                             const char *__restrict __format,
+                             __gnuc_va_list __arg) __THROW;
+#    define vfscanf __isoc99_vfscanf
+#    define vscanf __isoc99_vscanf
+#    define vsscanf __isoc99_vsscanf
+#   endif /* __REDIRECT */
+#  endif
+# else /* DEPRECATED_SCANF */
+#  if __LDOUBLE_REDIRECTS_TO_FLOAT128_ABI == 1 || defined __LDBL_COMPAT
+extern int __REDIRECT_LDBL (vfscanf, (FILE *__restrict __stream,
+				      const char *__restrict __format,
+				      __gnuc_va_list __arg),
+			    __vfscanfieee128, __nldbl_vfscanf)
+     __attribute__ ((__format__ (__scanf__, 2, 0))) __wur;
+extern int __REDIRECT_LDBL (vscanf, (const char *__restrict __format,
+				     __gnuc_va_list __arg),
+			    __vscanfieee128, __nldbl_vscanf)
+     __attribute__ ((__format__ (__scanf__, 1, 0))) __wur;
+extern int __REDIRECT_LDBL_NTH (vsscanf, (const char *__restrict __s,
+					  const char *__restrict __format,
+					  __gnuc_va_list __arg),
+				__vsscanfieee128, __nldbl_vsscanf)
+     __attribute__ ((__format__ (__scanf__, 2, 0)));
+#  else
 /* Read formatted input from S into argument list ARG.
 
    This function is a possible cancellation point and therefore not
    marked with __THROW.  */
 extern int vfscanf (FILE *__restrict __s, const char *__restrict __format,
-		    __gnuc_va_list __arg)
+                    __gnuc_va_list __arg)
      __attribute__ ((__format__ (__scanf__, 2, 0))) __wur;
 
 /* Read formatted input from stdin into argument list ARG.
@@ -469,42 +573,11 @@ extern int vscanf (const char *__restrict __format, __gnuc_va_list __arg)
 
 /* Read formatted input from S into argument list ARG.  */
 extern int vsscanf (const char *__restrict __s,
-		    const char *__restrict __format, __gnuc_va_list __arg)
+                    const char *__restrict __format, __gnuc_va_list __arg)
      __THROW __attribute__ ((__format__ (__scanf__, 2, 0)));
-
-/* Same redirection as above for the v*scanf family.  */
-# if !__GLIBC_USE (DEPRECATED_SCANF)
-#  if defined __REDIRECT && !defined __LDBL_COMPAT \
-      && __LDOUBLE_REDIRECTS_TO_FLOAT128_ABI == 0
-extern int __REDIRECT (vfscanf,
-		       (FILE *__restrict __s,
-			const char *__restrict __format, __gnuc_va_list __arg),
-		       __isoc99_vfscanf)
-     __attribute__ ((__format__ (__scanf__, 2, 0))) __wur;
-extern int __REDIRECT (vscanf, (const char *__restrict __format,
-				__gnuc_va_list __arg), __isoc99_vscanf)
-     __attribute__ ((__format__ (__scanf__, 1, 0))) __wur;
-extern int __REDIRECT_NTH (vsscanf,
-			   (const char *__restrict __s,
-			    const char *__restrict __format,
-			    __gnuc_va_list __arg), __isoc99_vsscanf)
-     __attribute__ ((__format__ (__scanf__, 2, 0)));
-#  elif !defined __REDIRECT
-extern int __isoc99_vfscanf (FILE *__restrict __s,
-			     const char *__restrict __format,
-			     __gnuc_va_list __arg) __wur;
-extern int __isoc99_vscanf (const char *__restrict __format,
-			    __gnuc_va_list __arg) __wur;
-extern int __isoc99_vsscanf (const char *__restrict __s,
-			     const char *__restrict __format,
-			     __gnuc_va_list __arg) __THROW;
-#   define vfscanf __isoc99_vfscanf
-#   define vscanf __isoc99_vscanf
-#   define vsscanf __isoc99_vsscanf
 #  endif
 # endif
-#endif /* Use ISO C9x.  */
-
+#endif /* __USE_ISOC99 */
 
 /* Read a character from STREAM.
 
@@ -850,13 +923,17 @@ extern char *cuserid (char *__s)
 struct obstack;			/* See <obstack.h>.  */
 
 /* Write formatted output to an obstack.  */
-extern int obstack_printf (struct obstack *__restrict __obstack,
-			   const char *__restrict __format, ...)
-     __THROWNL __attribute__ ((__format__ (__printf__, 2, 3)));
-extern int obstack_vprintf (struct obstack *__restrict __obstack,
-			    const char *__restrict __format,
-			    __gnuc_va_list __args)
-     __THROWNL __attribute__ ((__format__ (__printf__, 2, 0)));
+extern int __REDIRECT_LDBL_NTHNL (obstack_printf,
+				  (struct obstack *__restrict __obstack,
+				   const char *__restrict __format, ...),
+				  __obstack_printfieee128, __nldbl_obstack_printf)
+     __attribute__ ((__format__ (__printf__, 2, 3)));
+extern int __REDIRECT_LDBL_NTHNL (obstack_vprintf,
+				  (struct obstack *__restrict __obstack,
+				   const char *__restrict __format,
+				   __gnuc_va_list __args),
+				  __obstack_vprintfieee128, __nldbl_obstack_vprintf)
+     __attribute__ ((__format__ (__printf__, 2, 0)));
 #endif /* Use GNU.  */
 
 
@@ -894,11 +971,6 @@ extern int __overflow (FILE *, int);
 # include <bits/stdio2.h>
 #endif
 
-#include <bits/floatn.h>
-#if defined __LDBL_COMPAT || __LDOUBLE_REDIRECTS_TO_FLOAT128_ABI == 1
-# include <bits/stdio-ldbl.h>
-#endif
-
 __END_DECLS
 
 #endif /* <stdio.h> included.  */
diff --git a/libio/tst-bz24051.c b/libio/tst-bz24051.c
index f3155250..3649dbbd 100644
--- a/libio/tst-bz24051.c
+++ b/libio/tst-bz24051.c
@@ -19,7 +19,11 @@
 
 /* Prevent putchar -> _IO_putc inline expansion.  */
 #define __NO_INLINE__
-#pragma GCC optimize("O0")
+#ifdef __clang__
+# pragma clang optimize off
+#else
+# pragma GCC optimize("O0")
+#endif
 
 #include <stdio.h>
 #include <string.h>
diff --git a/libio/tst-bz24153.c b/libio/tst-bz24153.c
index a069bf06..9cfaa3b8 100644
--- a/libio/tst-bz24153.c
+++ b/libio/tst-bz24153.c
@@ -18,7 +18,11 @@
 
 /* Prevent getchar -> getc inline expansion.  */
 #define __NO_INLINE__
-#pragma GCC optimize ("O0")
+#ifdef __clang__
+# pragma clang optimize off
+#else
+# pragma GCC optimize("O0")
+#endif
 
 #include <stdarg.h>
 #include <stdio.h>
diff --git a/libio/tst-ext.c b/libio/tst-ext.c
index f69fbe6f..c987b1ba 100644
--- a/libio/tst-ext.c
+++ b/libio/tst-ext.c
@@ -25,8 +25,8 @@ main (void)
   /* Get the buffer size.  */
   if (__fbufsize (fp) != sizeof buf)
     {
-      printf ("__fbusize() reported a buffer size of %Zd bytes;"
-	      " we installed a buffer with %Zd bytes\n",
+      printf ("__fbusize() reported a buffer size of %zd bytes;"
+	      " we installed a buffer with %zd bytes\n",
 	      __fbufsize (fp), sizeof buf);
       result = 1;
     }
@@ -91,7 +91,7 @@ main (void)
   /* The string we wrote above should still be in the buffer.  */
   if (__fpending (fp) != strlen (teststring))
     {
-      printf ("__fpending() returned %Zd; expected %Zd\n",
+      printf ("__fpending() returned %zd; expected %zd\n",
 	      __fpending (fp), strlen (teststring));
       result = 1;
     }
@@ -100,7 +100,7 @@ main (void)
   /* And check again.  */
   if (__fpending (fp) != 0)
     {
-      printf ("__fpending() returned %Zd; expected 0\n",
+      printf ("__fpending() returned %zd; expected 0\n",
 	      __fpending (fp));
       result = 1;
     }
diff --git a/libio/tst-sprintf-ub.c b/libio/tst-sprintf-ub.c
index 55f341ea..e6baa4fe 100644
--- a/libio/tst-sprintf-ub.c
+++ b/libio/tst-sprintf-ub.c
@@ -16,8 +16,14 @@
    License along with the GNU C Library; if not, see
    <https://www.gnu.org/licenses/>.  */
 
+#include <libc-diag.h>
 #include <stdarg.h>
+/* This is required to disable the overlap warnings for the fortify
+   test.  */
+DIAG_PUSH_NEEDS_COMMENT;
+DIAG_IGNORE_NEEDS_COMMENT_GCC (5, "-Wrestrict");
 #include <stdio.h>
+DIAG_POP_NEEDS_COMMENT;
 #include <string.h>
 
 #include <support/check.h>
@@ -54,7 +60,11 @@ do_one_test (int function, char *buf, ...)
       /* The regular sprintf and vsprintf functions do not override the
          destination buffer, even if source and destination overlap.  */
       case FUNCTION_SPRINTF:
+	/* This intentionally use overlapping arguments.  */
+	DIAG_PUSH_NEEDS_COMMENT;
+	DIAG_IGNORE_NEEDS_COMMENT_GCC (5, "-Wrestrict");
         sprintf (buf, "%sCD", buf);
+	DIAG_POP_NEEDS_COMMENT;
         TEST_COMPARE_STRING (buf, expected);
         break;
       case FUNCTION_VSPRINTF:
@@ -66,7 +76,11 @@ do_one_test (int function, char *buf, ...)
       /* On the other hand, snprint and vsnprint override overlapping
          source and destination buffers.  */
       case FUNCTION_SNPRINF:
+	/* This intentionally use overlapping arguments.  */
+	DIAG_PUSH_NEEDS_COMMENT;
+	DIAG_IGNORE_NEEDS_COMMENT_GCC (5, "-Wrestrict");
         snprintf (buf, 3, "%sCD", buf);
+	DIAG_POP_NEEDS_COMMENT;
         TEST_COMPARE_STRING (buf, "CD");
         break;
       case FUNCTION_VSNPRINTF:
diff --git a/libio/tst-widetext.c b/libio/tst-widetext.c
index f1616bfb..df9e9650 100644
--- a/libio/tst-widetext.c
+++ b/libio/tst-widetext.c
@@ -59,7 +59,7 @@ do_test (void)
       exit (1);
     }
 
-   printf ("INFO: input file has %Zd bytes\n", mbsize);
+   printf ("INFO: input file has %zd bytes\n", mbsize);
 
   /* First convert the text to wide characters.  We use iconv here.  */
   {
@@ -82,7 +82,7 @@ do_test (void)
     nonr = iconv (cd, &inbuf, &inleft, &outbuf, &outleft);
     if (nonr != 0 && nonr != (size_t) -1)
       {
-	printf ("%u: iconv performed %Zd nonreversible conversions\n",
+	printf ("%u: iconv performed %zd nonreversible conversions\n",
 		__LINE__, nonr);
 	exit (1);
       }
@@ -90,7 +90,7 @@ do_test (void)
     if  (nonr == (size_t) -1)
       {
 	printf ("\
-%u: iconv returned with %Zd and errno = %m (inleft: %Zd, outleft: %Zd)\n",
+%u: iconv returned with %zd and errno = %m (inleft: %zd, outleft: %zd)\n",
 		__LINE__, nonr, inleft, outleft);
 	exit (1);
       }
@@ -163,7 +163,7 @@ do_test (void)
       wint_t wch = fgetwc (fp);
       if (wch == WEOF)
 	{
-	  printf ("%u: fgetwc failed (idx %Zd): %m\n", __LINE__, n);
+	  printf ("%u: fgetwc failed (idx %zd): %m\n", __LINE__, n);
 	  exit (1);
 	}
       wc2buf[n] = wch;
@@ -290,7 +290,7 @@ do_test (void)
     {
       if (fgetws (wcp, &wc2buf[wcsize] - wcp + 1, fp) == NULL)
 	{
-	  printf ("%u: short read using fgetws (only %td of %Zd)\n",
+	  printf ("%u: short read using fgetws (only %td of %zd)\n",
 		  __LINE__, wcp - wc2buf, wcsize);
 	  status = 1;
 	  break;
diff --git a/libio/tst_swprintf.c b/libio/tst_swprintf.c
index e4bd7f02..9452df79 100644
--- a/libio/tst_swprintf.c
+++ b/libio/tst_swprintf.c
@@ -57,25 +57,25 @@ main (int argc, char *argv[])
 
       if (tests[n].exp < 0 && res >= 0)
 	{
-	  printf ("swprintf (buf, %Zu, L\"%%s\", \"%s\") expected to fail\n",
+	  printf ("swprintf (buf, %zu, L\"%%s\", \"%s\") expected to fail\n",
 		  tests[n].n, tests[n].str);
 	  result = 1;
 	}
       else if (tests[n].exp >= 0 && tests[n].exp != res)
 	{
-	  printf ("swprintf (buf, %Zu, L\"%%s\", \"%s\") expected to return %Zd, but got %Zd\n",
+	  printf ("swprintf (buf, %zu, L\"%%s\", \"%s\") expected to return %zd, but got %zd\n",
 		  tests[n].n, tests[n].str, tests[n].exp, res);
 	  result = 1;
 	}
       else
-	printf ("swprintf (buf, %Zu, L\"%%s\", \"%s\") OK\n",
+	printf ("swprintf (buf, %zu, L\"%%s\", \"%s\") OK\n",
 		tests[n].n, tests[n].str);
     }
 
   if (swprintf (buf, nbuf, L"%.0s", "foo") != 0
       || wcslen (buf) != 0)
     {
-      printf ("swprintf (buf, %Zu, L\"%%.0s\", \"foo\") create some output\n",
+      printf ("swprintf (buf, %zu, L\"%%.0s\", \"foo\") create some output\n",
 	      nbuf);
       result = 1;
     }
@@ -83,7 +83,7 @@ main (int argc, char *argv[])
   if (swprintf (buf, nbuf, L"%.0ls", L"foo") != 0
       || wcslen (buf) != 0)
     {
-      printf ("swprintf (buf, %Zu, L\"%%.0ls\", L\"foo\") create some output\n",
+      printf ("swprintf (buf, %zu, L\"%%.0ls\", L\"foo\") create some output\n",
 	      nbuf);
       result = 1;
     }
diff --git a/libio/tst_swscanf.c b/libio/tst_swscanf.c
index 372f0fc7..5d3582ef 100644
--- a/libio/tst_swscanf.c
+++ b/libio/tst_swscanf.c
@@ -20,7 +20,7 @@ main (int argc, char *argv[])
   n = swscanf (in, L"%d + %d is %d", &a, &b, &c);
   if (n != 3 || a + b != c || c != 42)
     {
-      printf ("*** FAILED, n = %Zu, a = %d, b = %d, c = %d\n", n, a, b, c);
+      printf ("*** FAILED, n = %zu, a = %d, b = %d, c = %d\n", n, a, b, c);
       result = 1;
     }
 
@@ -30,7 +30,7 @@ main (int argc, char *argv[])
   if (n != 5 || strcmp (buf1, "one") != 0 || wcscmp (wbuf2, L"two") != 0
       || strcmp (buf3, "three") != 0 || c4 != '!' || wc5 != L'!')
     {
-      printf ("*** FAILED, n = %Zu, buf1 = \"%s\", wbuf2 = L\"%S\", buf3 = \"%s\", c4 = '%c', wc5 = L'%C'\n",
+      printf ("*** FAILED, n = %zu, buf1 = \"%s\", wbuf2 = L\"%S\", buf3 = \"%s\", c4 = '%c', wc5 = L'%C'\n",
 	      n, buf1, wbuf2, buf3, c4, (wint_t) wc5);
       result = 1;
     }
diff --git a/libio/wfileops.c b/libio/wfileops.c
index fb9d45b6..14325a01 100644
--- a/libio/wfileops.c
+++ b/libio/wfileops.c
@@ -418,7 +418,7 @@ _IO_wfile_overflow (FILE *f, wint_t wch)
       if (f->_wide_data->_IO_write_base == 0)
 	{
 	  _IO_wdoallocbuf (f);
-	  _IO_free_wbackup_area (f);
+	  __libc_IO_free_wbackup_area (f);
 	  _IO_wsetg (f, f->_wide_data->_IO_buf_base,
 		     f->_wide_data->_IO_buf_base, f->_wide_data->_IO_buf_base);
 
@@ -849,7 +849,7 @@ _IO_wfile_seekoff (FILE *fp, off64_t offset, int dir, int mode)
       }
     }
 
-  _IO_free_wbackup_area (fp);
+  __libc_IO_free_wbackup_area (fp);
 
   /* At this point, dir==_IO_seek_set. */
 
diff --git a/libio/wgenops.c b/libio/wgenops.c
index e7ea75ae..f4b80d1c 100644
--- a/libio/wgenops.c
+++ b/libio/wgenops.c
@@ -242,7 +242,7 @@ __wuflow (FILE *fp)
 	return WEOF;
     }
   else if (_IO_have_wbackup (fp))
-    _IO_free_wbackup_area (fp);
+    __libc_IO_free_wbackup_area (fp);
   return _IO_UFLOW (fp);
 }
 libc_hidden_def (__wuflow)
@@ -272,7 +272,7 @@ __wunderflow (FILE *fp)
 	return WEOF;
     }
   else if (_IO_have_backup (fp))
-    _IO_free_wbackup_area (fp);
+    __libc_IO_free_wbackup_area (fp);
   return _IO_UNDERFLOW (fp);
 }
 libc_hidden_def (__wunderflow)
@@ -412,7 +412,7 @@ _IO_switch_to_wget_mode (FILE *fp)
 libc_hidden_def (_IO_switch_to_wget_mode)
 
 void
-_IO_free_wbackup_area (FILE *fp)
+__libc_IO_free_wbackup_area (FILE *fp)
 {
   if (_IO_in_backup (fp))
     _IO_switch_to_main_wget_area (fp);  /* Just in case. */
@@ -421,7 +421,8 @@ _IO_free_wbackup_area (FILE *fp)
   fp->_wide_data->_IO_save_end = NULL;
   fp->_wide_data->_IO_backup_base = NULL;
 }
-libc_hidden_def (_IO_free_wbackup_area)
+libc_hidden_def (__libc_IO_free_wbackup_area)
+strong_alias (__libc_IO_free_wbackup_area, _IO_free_wbackup_area)
 
 static int
 save_for_wbackup (FILE *fp, wchar_t *end_p)
@@ -605,5 +606,5 @@ _IO_unsave_wmarkers (FILE *fp)
     }
 
   if (_IO_have_backup (fp))
-    _IO_free_wbackup_area (fp);
+    __libc_IO_free_wbackup_area (fp);
 }
diff --git a/locale/programs/ld-collate.c b/locale/programs/ld-collate.c
index 7b0d1bf7..66e2e01f 100644
--- a/locale/programs/ld-collate.c
+++ b/locale/programs/ld-collate.c
@@ -1059,7 +1059,7 @@ insert_value (struct linereader *ldfile, const char *symstr, size_t symlen,
   /* Test whether this element is not already in the list.  */
   if (elem->next != NULL || elem == collate->cursor)
     {
-      lr_error (ldfile, _("order for `%.*s' already defined at %s:%Zu"),
+      lr_error (ldfile, _("order for `%.*s' already defined at %s:%zu"),
 		(int) symlen, symstr, elem->file, elem->line);
       lr_ignore_rest (ldfile, 0);
       return 1;
@@ -1235,7 +1235,7 @@ range is not lower than that of the last character"), "LC_COLLATE");
 					     && elem->next == collate->cursor))
 		    {
 		      lr_error (ldfile, _("\
-order for `%.*s' already defined at %s:%Zu"),
+order for `%.*s' already defined at %s:%zu"),
 				(int) namelen, seq->name,
 				elem->file, elem->line);
 		      goto increment;
@@ -1378,7 +1378,7 @@ order for `%.*s' already defined at %s:%Zu"),
 					     && elem->next == collate->cursor))
 		    {
 		      lr_error (ldfile, _("\
-%s: order for `%.*s' already defined at %s:%Zu"),
+%s: order for `%.*s' already defined at %s:%zu"),
 				"LC_COLLATE", (int) lenfrom, buf,
 				elem->file, elem->line);
 		      continue;
@@ -1828,7 +1828,7 @@ symbol `%s' has the same encoding as"), (*eptr)->name);
 
   /* Now determine whether the UNDEFINED entry is needed and if yes,
      whether it was defined.  */
-  collate->undefined.used_in_level = need_undefined ? ~0ul : 0;
+  collate->undefined.used_in_level = need_undefined ? ~0u : 0;
   if (collate->undefined.file == NULL)
     {
       if (need_undefined)
@@ -3735,7 +3735,7 @@ error while adding equivalent collating symbol"));
 	      || &collate->undefined == collate->cursor)
 	    {
 	      lr_error (ldfile,
-			_("%s: order for `%.*s' already defined at %s:%Zu"),
+			_("%s: order for `%.*s' already defined at %s:%zu"),
 			"LC_COLLATE", 9, "UNDEFINED",
 			collate->undefined.file,
 			collate->undefined.line);
diff --git a/locale/programs/ld-ctype.c b/locale/programs/ld-ctype.c
index 5169d629..e85820d3 100644
--- a/locale/programs/ld-ctype.c
+++ b/locale/programs/ld-ctype.c
@@ -526,7 +526,7 @@ internal error in %s, line %u"), __FUNCTION__, __LINE__);
 			  {
 			    char buf[17];
 
-			    snprintf (buf, sizeof buf, "\\%Zo", cnt);
+			    snprintf (buf, sizeof buf, "\\%zo", cnt);
 
 			    record_error (0, 0, _("\
 character '%s' in class `%s' must be in class `%s'"),
@@ -541,7 +541,7 @@ character '%s' in class `%s' must be in class `%s'"),
 			  {
 			    char buf[17];
 
-			    snprintf (buf, sizeof buf, "\\%Zo", cnt);
+			    snprintf (buf, sizeof buf, "\\%zo", cnt);
 
 			    record_error (0, 0, _("\
 character '%s' in class `%s' must not be in class `%s'"),
@@ -3354,33 +3354,6 @@ wctype_table_init (struct wctype_table *t)
   t->level3_alloc = t->level3_size = 0;
 }
 
-/* Retrieve an entry.  */
-static inline int
-wctype_table_get (struct wctype_table *t, uint32_t wc)
-{
-  uint32_t index1 = wc >> (t->q + t->p + 5);
-  if (index1 < t->level1_size)
-    {
-      uint32_t lookup1 = t->level1[index1];
-      if (lookup1 != EMPTY)
-	{
-	  uint32_t index2 = ((wc >> (t->p + 5)) & ((1 << t->q) - 1))
-			    + (lookup1 << t->q);
-	  uint32_t lookup2 = t->level2[index2];
-	  if (lookup2 != EMPTY)
-	    {
-	      uint32_t index3 = ((wc >> 5) & ((1 << t->p) - 1))
-				+ (lookup2 << t->p);
-	      uint32_t lookup3 = t->level3[index3];
-	      uint32_t index4 = wc & 0x1f;
-
-	      return (lookup3 >> index4) & 1;
-	    }
-	}
-    }
-  return 0;
-}
-
 /* Add one entry.  */
 static void
 wctype_table_add (struct wctype_table *t, uint32_t wc)
diff --git a/localedata/bug-iconv-trans.c b/localedata/bug-iconv-trans.c
index 3886247c..c4c0ab74 100644
--- a/localedata/bug-iconv-trans.c
+++ b/localedata/bug-iconv-trans.c
@@ -7,7 +7,7 @@ int
 main (void)
 {
   iconv_t cd;
-  const char str[] = "";
+  const char str[] = "\xc4\xe4\xd6\xf6\xdc\xfc\xdf";
   const char expected[] = "AEaeOEoeUEuess";
   char *inptr = (char *) str;
   size_t inlen = strlen (str) + 1;
@@ -36,7 +36,7 @@ main (void)
       if (n == (size_t) -1)
 	printf ("iconv() returned error: %m\n");
       else
-	printf ("iconv() returned %Zd, expected 7\n", n);
+	printf ("iconv() returned %zd, expected 7\n", n);
       result = 1;
     }
   if (inlen != 0)
@@ -57,7 +57,7 @@ main (void)
     }
   else if (outlen != sizeof (outbuf) - sizeof (expected))
     {
-      printf ("outlen wrong: %Zd, expected %Zd\n", outlen,
+      printf ("outlen wrong: %zd, expected %zd\n", outlen,
 	      sizeof (outbuf) - 15);
       result = 1;
     }
diff --git a/localedata/tests-mbwc/dat_mbrtowc.c b/localedata/tests-mbwc/dat_mbrtowc.c
index b8eb3dd2..0387045b 100644
--- a/localedata/tests-mbwc/dat_mbrtowc.c
+++ b/localedata/tests-mbwc/dat_mbrtowc.c
@@ -23,9 +23,9 @@ TST_MBRTOWC tst_mbrtowc_loc [] = {
       { /*----------------- #01 -----------------*/
 	{
 	  {
-	    { 1, 1, "",	   1,		 0, 0 },
-	    { 1, 1, "",	   2,		 0, 0 },
-	    { 1, 1, "",	   USE_MBCURMAX, 0, 0 },
+	    { 1, 1, "\xc4\xd6\xdc",	   1,		 0, 0 },
+	    { 1, 1, "\xc4\xd6\xdc",	   2,		 0, 0 },
+	    { 1, 1, "\xc4\xd6\xdc",	   USE_MBCURMAX, 0, 0 },
 	  }
 	},
 	{
@@ -39,9 +39,9 @@ TST_MBRTOWC tst_mbrtowc_loc [] = {
       { /*----------------- #02 -----------------*/
 	{
 	  {
-	    { 1, 1, "",	    1,		  0, 0 },
-	    { 1, 1, "",	    2,		  0, 0 },
-	    { 1, 1, "",	    USE_MBCURMAX, 0, 0 },
+	    { 1, 1, "\xc4\xd6\xdc",	    1,		  0, 0 },
+	    { 1, 1, "\xc4\xd6\xdc",	    2,		  0, 0 },
+	    { 1, 1, "\xc4\xd6\xdc",	    USE_MBCURMAX, 0, 0 },
 	  }
 	},
 	{
diff --git a/localedata/tests-mbwc/dat_mbsrtowcs.c b/localedata/tests-mbwc/dat_mbsrtowcs.c
index e1ee1819..3604accc 100644
--- a/localedata/tests-mbwc/dat_mbsrtowcs.c
+++ b/localedata/tests-mbwc/dat_mbsrtowcs.c
@@ -15,9 +15,9 @@ TST_MBSRTOWCS tst_mbsrtowcs_loc [] = {
       { /*----------------- #01 -----------------*/
 	{
 	  {
-	    { 1,  "",	    4,			 0,0 },
-	    { 1,  "",	    3,			 0,0 },
-	    { 1,  "",	    2,			 0,0 },
+	    { 1,  "\xfc\xe4\xf6",	    4,			 0,0 },
+	    { 1,  "\xfc\xe4\xf6",	    3,			 0,0 },
+	    { 1,  "\xfc\xe4\xf6",	    2,			 0,0 },
 	  }
 	},
 	{
@@ -31,9 +31,9 @@ TST_MBSRTOWCS tst_mbsrtowcs_loc [] = {
       { /*----------------- #02 -----------------*/
 	{
 	  {
-	    { 1,  "",	    4,			 0,0 },
-	    { 1,  "",		    1,			 0,0 },
-	    { 0,  "",	    4,			 0,0 },
+	    { 1,  "\xfc\xe4\xf6",	    4,			 0,0 },
+	    { 1,  "",			    1,			 0,0 },
+	    { 0,  "\xfc\xe4\xf6",	    4,			 0,0 },
 	  }
 	},
 	{
diff --git a/localedata/tests-mbwc/dat_strcoll.c b/localedata/tests-mbwc/dat_strcoll.c
index b729ae9e..fd14090e 100644
--- a/localedata/tests-mbwc/dat_strcoll.c
+++ b/localedata/tests-mbwc/dat_strcoll.c
@@ -27,13 +27,16 @@ TST_STRCOLL tst_strcoll_loc [] = {
   {
     { Tstrcoll, TST_LOC_de },
     {
-      { /*input.*/ { "BCDEFG", "BCDEFG"	      },  /* #1 */
+      { /*input.*/ { "\xc4\x42\x43\x44\x45\x46\x47",
+		     "\xc4\x42\x43\x44\x45\x46\x47"   },  /* #1 */
 	/*expect*/ { 0,1,0,			      },
       },
-      { /*input.*/ { "XX  XX", "XX B XX"	      },  /* #2 */
+      { /*input.*/ { "\x58\x58\x20\xc4\x20\x58\x58",
+		     "XX B XX"			      },  /* #2 */
 	/*expect*/ { 0,0,-1,			      },
       },
-      { /*input.*/ { "XX B XX", "XX  XX"	      },  /* #3 */
+      { /*input.*/ { "XX B XX",
+		     "\x58\x58\x20\xc4\x20\x58\x58"   },  /* #3 */
 	/*expect*/ { 0,0,+1,			      },
       },
       { /*input.*/ { "B",	"a"		      },  /* #4 */
@@ -48,10 +51,10 @@ TST_STRCOLL tst_strcoll_loc [] = {
       { /*input.*/ { "A",	"b"		      },  /* #7 */
 	/*expect*/ { 0,0,-1,			      },
       },
-      { /*input.*/ { "",	"B"		      },  /* #8 */
+      { /*input.*/ { "\xe4",	"B"		      },  /* #8 */
 	/*expect*/ { 0,0,-1,			      },
       },
-      { /*input.*/ { "B",	""		      },  /* #9 */
+      { /*input.*/ { "B",	"\xe4"		      },  /* #9 */
 	/*expect*/ { 0,0,+1,			      },
       },
       { .is_last = 1 } /* Last element.  */
diff --git a/localedata/tests-mbwc/dat_swscanf.c b/localedata/tests-mbwc/dat_swscanf.c
index 7f658322..eb813f22 100644
--- a/localedata/tests-mbwc/dat_swscanf.c
+++ b/localedata/tests-mbwc/dat_swscanf.c
@@ -31,7 +31,7 @@ TST_SWSCANF tst_swscanf_loc [] =
 	{ /* The fields are: err_val, ret_flag, ret_val,
 	     val_int, val_uns, val_flt, val_c, val_s, val_S.  */
 	  0,1,5,
-	  -1, 2, 3.3, '', "", { 0x0000, },
+	  -1, 2, 3.3, '\xe4', "\xc4\xdc", { 0x0000, },
 	},
       },
       /*------------------------ 02 -----------------------*/
diff --git a/localedata/tests-mbwc/dat_wcrtomb.c b/localedata/tests-mbwc/dat_wcrtomb.c
index 8500f684..826e373e 100644
--- a/localedata/tests-mbwc/dat_wcrtomb.c
+++ b/localedata/tests-mbwc/dat_wcrtomb.c
@@ -13,11 +13,11 @@ TST_WCRTOMB tst_wcrtomb_loc [] = {
     {
       /* #01 : normal case			       */
       { /*input.*/ { 1,		 0x00FC,   0,0 },
-	/*expect*/ { 0,	   1,1,	 ""	       },
+	/*expect*/ { 0,	   1,1,	 "\xfc"	       },
       },
       /* #02 : normal case			       */
       { /*input.*/ { 1,		 0x00D6,   0,0 },
-	/*expect*/ { 0,	   1,1,	 ""	       },
+	/*expect*/ { 0,	   1,1,	 "\xd6"	       },
       },
       /* #03 : error case			       */
       { /*input.*/ { 1,		 0xFFA1,   0,0 },
diff --git a/localedata/tests-mbwc/dat_wcsrtombs.c b/localedata/tests-mbwc/dat_wcsrtombs.c
index d3148b2a..e98a5334 100644
--- a/localedata/tests-mbwc/dat_wcsrtombs.c
+++ b/localedata/tests-mbwc/dat_wcsrtombs.c
@@ -26,26 +26,26 @@ TST_WCSRTOMBS tst_wcsrtombs_loc [] = {
       },
       /* #02 : Only one chars should be stored in s. No null termination.  */
       { /*input.*/ { 1,1,	{ 0x00C4,0x00D6,0x00DC,0x0000 }, 1, 0, 0 },
-	/*expect*/ { 0,1,1,	 ""					 },
+	/*expect*/ { 0,1,1,	 "\xc4"					 },
       },
       /* #03 : Only two chars should be stored in s. No null termination.  */
       { /*input.*/ { 1,1,	{ 0x00C4,0x00D6,0x00DC,0x0000 }, 2, 0, 0 },
-	/*expect*/ { 0,1,2,	 ""					 },
+	/*expect*/ { 0,1,2,	 "\xc4\xd6"				 },
       },
       /* #04 : Only three chars should be stored in s. No null
 	       termination.  */
       { /*input.*/ { 1,1,	{ 0x00C4,0x00D6,0x00DC,0x0000 }, 3, 0, 0 },
-	/*expect*/ { 0,1,3,	 ""					 },
+	/*expect*/ { 0,1,3,	 "\xc4\xd6\xdc"				 },
       },
       /* #05 : Only three chars should be stored in s with a null
 	       termination. */
       { /*input.*/ { 1,1,	{ 0x00C4,0x00D6,0x00DC,0x0000 }, 4, 0, 0 },
-	/*expect*/ { 0,1,3,	 ""					 },
+	/*expect*/ { 0,1,3,	 "\xc4\xd6\xdc"				 },
       },
       /* #06 : Only three chars should be stored in s with a null
 	       termination. */
       { /*input.*/ { 1,1,	{ 0x00C4,0x00D6,0x00DC,0x0000 }, 5, 0, 0 },
-	/*expect*/ { 0,1,3,	 ""					 },
+	/*expect*/ { 0,1,3,	 "\xc4\xd6\xdc"				 },
       },
       /* #07 : Invalid mb sequence. No chars should be stored in s.  */
       { /*input.*/ { 1,1,	{ 0x0201,0x0221,0x0000,0x0000 }, 2, 0, 0 },
diff --git a/localedata/tests-mbwc/dat_wcstombs.c b/localedata/tests-mbwc/dat_wcstombs.c
index a6dd0ec6..ad9f44fe 100644
--- a/localedata/tests-mbwc/dat_wcstombs.c
+++ b/localedata/tests-mbwc/dat_wcstombs.c
@@ -25,26 +25,26 @@ TST_WCSTOMBS tst_wcstombs_loc [] = {
       },
       /* #02 : Only one chars should be stored in s. No null termination.  */
       { /*input.*/ { 1,1,	       { 0x00C4,0x00D6,0x00DC,0x0000 },	1 },
-	/*expect*/ { 0,1,1,	 ""					  },
+	/*expect*/ { 0,1,1,	 "\xc4"					  },
       },
       /* #03 : Only two chars should be stored in s. No null termination.  */
       { /*input.*/ { 1,1,	       { 0x00C4,0x00D6,0x00DC,0x0000 },	2 },
-	/*expect*/ { 0,1,2,	 ""					  },
+	/*expect*/ { 0,1,2,	 "\xc4\xd6"				  },
       },
       /* #04 : Only three chars should be stored in s. No null
 	       termination.  */
       { /*input.*/ { 1,1,	       { 0x00C4,0x00D6,0x00DC,0x0000 },	3 },
-	/*expect*/ { 0,1,3,	 ""					  },
+	/*expect*/ { 0,1,3,	 "\xc4\xd6\xdc"				  },
       },
       /* #05 : Only three chars should be stored in s with a null
 	       termination.  */
       { /*input.*/ { 1,1,	       { 0x00C4,0x00D6,0x00DC,0x0000 },	4 },
-	/*expect*/ { 0,1,3,	 ""					  },
+	/*expect*/ { 0,1,3,	 "\xc4\xd6\xdc"				  },
       },
       /* #06 : Only three chars should be stored in s with a null
 	       termination.  */
       { /*input.*/ { 1,1,	       { 0x00C4,0x00D6,0x00DC,0x0000 },	5 },
-	/*expect*/ { 0,1,3,	 ""					  },
+	/*expect*/ { 0,1,3,	 "\xc4\xd6\xdc"				  },
       },
       /* #07 : Invalid mb sequence. No chars should be stored in s. */
       { /*input.*/ { 1,1,	       { 0x0201,0x0221,0x0000,0x0000 },	2 },
diff --git a/localedata/tests-mbwc/dat_wctomb.c b/localedata/tests-mbwc/dat_wctomb.c
index 7394ca53..1b8227e6 100644
--- a/localedata/tests-mbwc/dat_wctomb.c
+++ b/localedata/tests-mbwc/dat_wctomb.c
@@ -59,11 +59,11 @@ TST_WCTOMB tst_wctomb_loc [] = {
     {
       /* #01 : normal case		   */
       { /*input.*/ { 1,	   0x00C4  },
-	/*expect*/ { 0,1,1,  ""	   },
+	/*expect*/ { 0,1,1,  "\xc4"	   },
       },
       /* #02 : normal case		   */
       { /*input.*/ { 1,	   0x00DC  },
-	/*expect*/ { 0,1,1,  ""	   },
+	/*expect*/ { 0,1,1,  "\xdc"	   },
       },
       /* #03 : normal case		   */
       { /*input.*/ { 1,	   0x0092  },
diff --git a/localedata/tst-iconv-math-trans.c b/localedata/tst-iconv-math-trans.c
index a2d01a7e..34c62eb7 100644
--- a/localedata/tst-iconv-math-trans.c
+++ b/localedata/tst-iconv-math-trans.c
@@ -70,7 +70,7 @@ do_test (void)
       if (n == (size_t) -1)
         printf ("iconv() returned error: %m\n");
       else
-        printf ("iconv() returned %Zd, expected 24\n", n);
+        printf ("iconv() returned %zd, expected 24\n", n);
       result = 1;
     }
   if (inlen != 0)
@@ -91,7 +91,7 @@ do_test (void)
     }
   else if (outlen != sizeof (outbuf) - sizeof (expected))
     {
-      printf ("outlen wrong: %Zd, expected %Zd\n", outlen,
+      printf ("outlen wrong: %zd, expected %zd\n", outlen,
               sizeof (outbuf) - 15);
       result = 1;
     }
diff --git a/localedata/tst-trans.c b/localedata/tst-trans.c
index c97c44aa..99b63016 100644
--- a/localedata/tst-trans.c
+++ b/localedata/tst-trans.c
@@ -22,6 +22,7 @@
 #include <string.h>
 #include <wchar.h>
 #include <wctype.h>
+#include <libc-diag.h>
 
 static int
 do_test (void)
@@ -59,7 +60,12 @@ do_test (void)
   errors |= len != 10;
   printf ("len = %d, wbuf = L\"%ls\"\n", len, wbuf);
 
-  snprintf (buf, sizeof buf, "%Id", 0x499602D2);
+  /* clang does not support 'I' specifier and handles it as a 'length
+   * modifier'.  */
+  DIAG_PUSH_NEEDS_COMMENT_CLANG;
+  DIAG_IGNORE_NEEDS_COMMENT_CLANG (13, "-Wformat");
+  snprintf (buf, sizeof buf, "%Id", 0x499602D2U);
+  DIAG_POP_NEEDS_COMMENT_CLANG;
   errors |= strcmp (buf, "bcdefghija") != 0;
   len = strlen (buf);
   errors |= len != 10;
diff --git a/localedata/tst-xlocale1.c b/localedata/tst-xlocale1.c
index 9f545a02..e6c59707 100644
--- a/localedata/tst-xlocale1.c
+++ b/localedata/tst-xlocale1.c
@@ -13,9 +13,9 @@ static struct
   {
     { "C", "TRANSLIT", "translit", 0 },
     { "de_DE.ISO-8859-1", "TRANSLIT", "translit", 0 },
-    { "de_DE.ISO-8859-1", "TRANSLIT", "trnslit", -1 },
+    { "de_DE.ISO-8859-1", "TRANSLIT", "tr\xc4nslit", -1 },
     { "de_DE.UTF-8", "TRANSLIT", "translit", 0 },
-    { "de_DE.ISO-8859-1", "", "", 1 }
+    { "de_DE.ISO-8859-1", "\xe4", "\xc4", 1 }
   };
 #define ntests (sizeof (tests) / sizeof (tests[0]))
 
diff --git a/localedata/tst-xlocale2.c b/localedata/tst-xlocale2.c
index 7f990501..3387d7f4 100644
--- a/localedata/tst-xlocale2.c
+++ b/localedata/tst-xlocale2.c
@@ -36,7 +36,7 @@ main (void)
 }
 
 
-static const char str[] = "0123456789abcdef ABCDEF ghijklmnopqrstuvwxyz";
+static const char str[] = "0123456789abcdef ABCDEF ghijklmnopqrstuvwxyz\xe4\xc4\xf6\xd6\xfc\xdc";
 static const char exd[] = "11111111110000000000000000000000000000000000000000";
 static const char exa[] = "00000000001111110111111011111111111111111111111111";
 static const char exx[] = "11111111111111110111111000000000000000000000000000";
diff --git a/login/Makefile b/login/Makefile
index 62440499..a0a96f3b 100644
--- a/login/Makefile
+++ b/login/Makefile
@@ -64,6 +64,7 @@ endif # $(have-GLIBC_2.33)
 include ../Rules
 
 CFLAGS-getpt.c += -fexceptions
+CFLAGS-getlogin_r.c += $(config-cflags-wno-ignored-attributes)
 
 ifeq (yesyes,$(have-fpie)$(build-shared))
 pt_chown-cflags += $(pie-ccflag)
diff --git a/malloc/Makefile b/malloc/Makefile
index 2329cf71..f9d62f14 100644
--- a/malloc/Makefile
+++ b/malloc/Makefile
@@ -367,3 +367,14 @@ tst-mallocstate-malloc-check-ENV = LD_PRELOAD=$(objpfx)libc_malloc_debug.so
 # libc_malloc_debug.so.
 $(objpfx)tst-mallocstate: $(objpfx)libc_malloc_debug.so
 $(objpfx)tst-mallocstate-malloc-check: $(objpfx)libc_malloc_debug.so
+
+CFLAGS-tst-memalign.c += -fno-builtin
+CFLAGS-tst-malloc.c += -fno-builtin
+CFLAGS-tst-malloc-backtrace.c += -fno-builtin
+CFLAGS-tst-malloc-check.c += -fno-builtin
+CFLAGS-tst-malloc-too-large.c += -fno-builtin
+CFLAGS-tst-realloc.c += -fno-builtin
+CFLAGS-tst-valloc.c += -fno-builtin
+CFLAGS-tst-compathooks-off.c += -fno-builtin
+CFLAGS-tst-compathooks-on.c += -fno-builtin
+CFLAGS-tst-mallinfo2.c += -fno-builtin
diff --git a/malloc/malloc-check.c b/malloc/malloc-check.c
index 0299fe99..cc99b712 100644
--- a/malloc/malloc-check.c
+++ b/malloc/malloc-check.c
@@ -17,6 +17,7 @@
    not, see <https://www.gnu.org/licenses/>.  */
 
 #define __mremap mremap
+#define __fprintf fprintf
 #include "malloc.c"
 
 /* When memory is tagged, the checking data is stored in the user part
@@ -318,7 +319,7 @@ realloc_check (void *oldmem, size_t bytes)
 #if __GNUC_PREREQ (7, 0)
   /* GCC 7 warns about magic_p may be used uninitialized.  But we never
      reach here if magic_p is uninitialized.  */
-  DIAG_IGNORE_NEEDS_COMMENT (7, "-Wmaybe-uninitialized");
+  DIAG_IGNORE_NEEDS_COMMENT_GCC (7, "-Wmaybe-uninitialized");
 #endif
   /* mem2chunk_check changed the magic byte in the old chunk.
      If newmem is NULL, then the old chunk will still be used though,
diff --git a/malloc/malloc.c b/malloc/malloc.c
index 1a1ac1d8..aa35846e 100644
--- a/malloc/malloc.c
+++ b/malloc/malloc.c
@@ -5279,9 +5279,9 @@ __malloc_stats (void)
       memset (&mi, 0, sizeof (mi));
       __libc_lock_lock (ar_ptr->mutex);
       int_mallinfo (ar_ptr, &mi);
-      fprintf (stderr, "Arena %d:\n", i);
-      fprintf (stderr, "system bytes     = %10u\n", (unsigned int) mi.arena);
-      fprintf (stderr, "in use bytes     = %10u\n", (unsigned int) mi.uordblks);
+      __fprintf (stderr, "Arena %d:\n", i);
+      __fprintf (stderr, "system bytes     = %10u\n", (unsigned int) mi.arena);
+      __fprintf (stderr, "in use bytes     = %10u\n", (unsigned int) mi.uordblks);
 #if MALLOC_DEBUG > 1
       if (i > 0)
         dump_heap (heap_for_ptr (top (ar_ptr)));
@@ -5293,12 +5293,12 @@ __malloc_stats (void)
       if (ar_ptr == &main_arena)
         break;
     }
-  fprintf (stderr, "Total (incl. mmap):\n");
-  fprintf (stderr, "system bytes     = %10u\n", system_b);
-  fprintf (stderr, "in use bytes     = %10u\n", in_use_b);
-  fprintf (stderr, "max mmap regions = %10u\n", (unsigned int) mp_.max_n_mmaps);
-  fprintf (stderr, "max mmap bytes   = %10lu\n",
-           (unsigned long) mp_.max_mmapped_mem);
+  __fprintf (stderr, "Total (incl. mmap):\n");
+  __fprintf (stderr, "system bytes     = %10u\n", system_b);
+  __fprintf (stderr, "in use bytes     = %10u\n", in_use_b);
+  __fprintf (stderr, "max mmap regions = %10u\n", (unsigned int) mp_.max_n_mmaps);
+  __fprintf (stderr, "max mmap bytes   = %10lu\n",
+	     (unsigned long) mp_.max_mmapped_mem);
   stderr->_flags2 = old_flags2;
   _IO_funlockfile (stderr);
 }
@@ -5412,8 +5412,7 @@ do_set_tcache_unsorted_limit (size_t value)
 }
 #endif
 
-static inline int
-__always_inline
+static __always_inline int
 do_set_mxfast (size_t value)
 {
   if (value <= MAX_FAST_SIZE)
@@ -5729,7 +5728,7 @@ __malloc_info (int options, FILE *fp)
   mstate ar_ptr = &main_arena;
   do
     {
-      fprintf (fp, "<heap nr=\"%d\">\n<sizes>\n", n++);
+      __fprintf (fp, "<heap nr=\"%d\">\n<sizes>\n", n++);
 
       size_t nblocks = 0;
       size_t nfastblocks = 0;
@@ -5840,12 +5839,12 @@ __malloc_info (int options, FILE *fp)
 
       for (size_t i = 0; i < nsizes; ++i)
 	if (sizes[i].count != 0 && i != NFASTBINS)
-	  fprintf (fp, "\
+	  __fprintf (fp, "\
   <size from=\"%zu\" to=\"%zu\" total=\"%zu\" count=\"%zu\"/>\n",
 		   sizes[i].from, sizes[i].to, sizes[i].total, sizes[i].count);
 
       if (sizes[NFASTBINS].count != 0)
-	fprintf (fp, "\
+	__fprintf (fp, "\
   <unsorted from=\"%zu\" to=\"%zu\" total=\"%zu\" count=\"%zu\"/>\n",
 		 sizes[NFASTBINS].from, sizes[NFASTBINS].to,
 		 sizes[NFASTBINS].total, sizes[NFASTBINS].count);
@@ -5853,7 +5852,7 @@ __malloc_info (int options, FILE *fp)
       total_system += ar_ptr->system_mem;
       total_max_system += ar_ptr->max_system_mem;
 
-      fprintf (fp,
+      __fprintf (fp,
 	       "</sizes>\n<total type=\"fast\" count=\"%zu\" size=\"%zu\"/>\n"
 	       "<total type=\"rest\" count=\"%zu\" size=\"%zu\"/>\n"
 	       "<system type=\"current\" size=\"%zu\"/>\n"
@@ -5863,7 +5862,7 @@ __malloc_info (int options, FILE *fp)
 
       if (ar_ptr != &main_arena)
 	{
-	  fprintf (fp,
+	  __fprintf (fp,
 		   "<aspace type=\"total\" size=\"%zu\"/>\n"
 		   "<aspace type=\"mprotect\" size=\"%zu\"/>\n"
 		   "<aspace type=\"subheaps\" size=\"%zu\"/>\n",
@@ -5873,7 +5872,7 @@ __malloc_info (int options, FILE *fp)
 	}
       else
 	{
-	  fprintf (fp,
+	  __fprintf (fp,
 		   "<aspace type=\"total\" size=\"%zu\"/>\n"
 		   "<aspace type=\"mprotect\" size=\"%zu\"/>\n",
 		   ar_ptr->system_mem, ar_ptr->system_mem);
@@ -5886,7 +5885,7 @@ __malloc_info (int options, FILE *fp)
     }
   while (ar_ptr != &main_arena);
 
-  fprintf (fp,
+  __fprintf (fp,
 	   "<total type=\"fast\" count=\"%zu\" size=\"%zu\"/>\n"
 	   "<total type=\"rest\" count=\"%zu\" size=\"%zu\"/>\n"
 	   "<total type=\"mmap\" count=\"%d\" size=\"%zu\"/>\n"
diff --git a/malloc/memusage.c b/malloc/memusage.c
index f30906df..ddc48742 100644
--- a/malloc/memusage.c
+++ b/malloc/memusage.c
@@ -134,6 +134,19 @@ gettime (struct entry *e)
 #endif
 }
 
+static inline void
+peak_atomic_max (size_t *peak, size_t val)
+{
+  size_t v;
+  do
+    {
+      v = atomic_load_relaxed (peak);
+      if (v >= val)
+	break;
+    }
+  while (! atomic_compare_exchange_weak_acquire (peak, &v, val));
+}
+
 /* Update the global data after a successful function call.  */
 static void
 update_data (struct header *result, size_t len, size_t old_len)
@@ -148,8 +161,8 @@ update_data (struct header *result, size_t len, size_t old_len)
 
   /* Compute current heap usage and compare it with the maximum value.  */
   size_t heap
-    = catomic_exchange_and_add (&current_heap, len - old_len) + len - old_len;
-  catomic_max (&peak_heap, heap);
+    = atomic_fetch_add_acquire (&current_heap, len - old_len) + len - old_len;
+  peak_atomic_max (&peak_heap, heap);
 
   /* Compute current stack usage and compare it with the maximum
      value.  The base stack pointer might not be set if this is not
@@ -172,15 +185,15 @@ update_data (struct header *result, size_t len, size_t old_len)
     start_sp = sp;
   size_t current_stack = start_sp - sp;
 #endif
-  catomic_max (&peak_stack, current_stack);
+  peak_atomic_max (&peak_stack, current_stack);
 
   /* Add up heap and stack usage and compare it with the maximum value.  */
-  catomic_max (&peak_total, heap + current_stack);
+  peak_atomic_max (&peak_total, heap + current_stack);
 
   /* Store the value only if we are writing to a file.  */
   if (fd != -1)
     {
-      uint32_t idx = catomic_exchange_and_add (&buffer_cnt, 1);
+      uint32_t idx = atomic_fetch_add_acquire (&buffer_cnt, 1);
       if (idx + 1 >= 2 * buffer_size)
         {
           /* We try to reset the counter to the correct range.  If
@@ -188,7 +201,8 @@ update_data (struct header *result, size_t len, size_t old_len)
              counter it does not matter since that thread will take
              care of the correction.  */
           uint32_t reset = (idx + 1) % (2 * buffer_size);
-          catomic_compare_and_exchange_val_acq (&buffer_cnt, reset, idx + 1);
+	  uint32_t expected = idx + 1;
+	  atomic_compare_exchange_weak_acquire (&buffer_cnt, &expected, reset);
           if (idx >= 2 * buffer_size)
             idx = reset - 1;
         }
@@ -362,24 +376,24 @@ malloc (size_t len)
     return (*mallocp)(len);
 
   /* Keep track of number of calls.  */
-  catomic_increment (&calls[idx_malloc]);
+  atomic_fetch_add_acquire (&calls[idx_malloc], 1);
   /* Keep track of total memory consumption for `malloc'.  */
-  catomic_add (&total[idx_malloc], len);
+  atomic_fetch_add_acquire (&total[idx_malloc], len);
   /* Keep track of total memory requirement.  */
-  catomic_add (&grand_total, len);
+  atomic_fetch_add_acquire (&grand_total, len);
   /* Remember the size of the request.  */
   if (len < 65536)
-    catomic_increment (&histogram[len / 16]);
+    atomic_fetch_add_acquire (&histogram[len / 16], 1);
   else
-    catomic_increment (&large);
+    atomic_fetch_add_acquire (&large, 1);
   /* Total number of calls of any of the functions.  */
-  catomic_increment (&calls_total);
+  atomic_fetch_add_acquire (&calls_total, 1);
 
   /* Do the real work.  */
   result = (struct header *) (*mallocp)(len + sizeof (struct header));
   if (result == NULL)
     {
-      catomic_increment (&failed[idx_malloc]);
+      atomic_fetch_add_acquire (&failed[idx_malloc], 1);
       return NULL;
     }
 
@@ -430,21 +444,21 @@ realloc (void *old, size_t len)
     }
 
   /* Keep track of number of calls.  */
-  catomic_increment (&calls[idx_realloc]);
+  atomic_fetch_add_acquire (&calls[idx_realloc], 1);
   if (len > old_len)
     {
       /* Keep track of total memory consumption for `realloc'.  */
-      catomic_add (&total[idx_realloc], len - old_len);
+      atomic_fetch_add_acquire (&total[idx_realloc], len - old_len);
       /* Keep track of total memory requirement.  */
-      catomic_add (&grand_total, len - old_len);
+      atomic_fetch_add_acquire (&grand_total, len - old_len);
     }
 
   if (len == 0 && old != NULL)
     {
       /* Special case.  */
-      catomic_increment (&realloc_free);
+      atomic_fetch_add_acquire (&realloc_free, 1);
       /* Keep track of total memory freed using `free'.  */
-      catomic_add (&total[idx_free], real->length);
+      atomic_fetch_add_acquire (&total[idx_free], real->length);
 
       /* Update the allocation data and write out the records if necessary.  */
       update_data (NULL, 0, old_len);
@@ -457,26 +471,26 @@ realloc (void *old, size_t len)
 
   /* Remember the size of the request.  */
   if (len < 65536)
-    catomic_increment (&histogram[len / 16]);
+    atomic_fetch_add_acquire (&histogram[len / 16], 1);
   else
-    catomic_increment (&large);
+    atomic_fetch_add_acquire (&large, 1);
   /* Total number of calls of any of the functions.  */
-  catomic_increment (&calls_total);
+  atomic_fetch_add_acquire (&calls_total, 1);
 
   /* Do the real work.  */
   result = (struct header *) (*reallocp)(real, len + sizeof (struct header));
   if (result == NULL)
     {
-      catomic_increment (&failed[idx_realloc]);
+      atomic_fetch_add_acquire (&failed[idx_realloc], 1);
       return NULL;
     }
 
   /* Record whether the reduction/increase happened in place.  */
   if (real == result)
-    catomic_increment (&inplace);
+    atomic_fetch_add_acquire (&inplace, 1);
   /* Was the buffer increased?  */
   if (old_len > len)
-    catomic_increment (&decreasing);
+    atomic_fetch_add_acquire (&decreasing, 1);
 
   /* Update the allocation data and write out the records if necessary.  */
   update_data (result, len, old_len);
@@ -508,16 +522,16 @@ calloc (size_t n, size_t len)
     return (*callocp)(n, len);
 
   /* Keep track of number of calls.  */
-  catomic_increment (&calls[idx_calloc]);
+  atomic_fetch_add_acquire (&calls[idx_calloc], 1);
   /* Keep track of total memory consumption for `calloc'.  */
-  catomic_add (&total[idx_calloc], size);
+  atomic_fetch_add_acquire (&total[idx_calloc], size);
   /* Keep track of total memory requirement.  */
-  catomic_add (&grand_total, size);
+  atomic_fetch_add_acquire (&grand_total, size);
   /* Remember the size of the request.  */
   if (size < 65536)
-    catomic_increment (&histogram[size / 16]);
+    atomic_fetch_add_acquire (&histogram[size / 16], 1);
   else
-    catomic_increment (&large);
+    atomic_fetch_add_acquire (&large, 1);
   /* Total number of calls of any of the functions.  */
   ++calls_total;
 
@@ -525,7 +539,7 @@ calloc (size_t n, size_t len)
   result = (struct header *) (*mallocp)(size + sizeof (struct header));
   if (result == NULL)
     {
-      catomic_increment (&failed[idx_calloc]);
+      atomic_fetch_add_acquire (&failed[idx_calloc], 1);
       return NULL;
     }
 
@@ -563,7 +577,7 @@ free (void *ptr)
   /* `free (NULL)' has no effect.  */
   if (ptr == NULL)
     {
-      catomic_increment (&calls[idx_free]);
+      atomic_fetch_add_acquire (&calls[idx_free], 1);
       return;
     }
 
@@ -577,9 +591,9 @@ free (void *ptr)
     }
 
   /* Keep track of number of calls.  */
-  catomic_increment (&calls[idx_free]);
+  atomic_fetch_add_acquire (&calls[idx_free], 1);
   /* Keep track of total memory freed using `free'.  */
-  catomic_add (&total[idx_free], real->length);
+  atomic_fetch_add_acquire (&total[idx_free], real->length);
 
   /* Update the allocation data and write out the records if necessary.  */
   update_data (NULL, 0, real->length);
@@ -614,22 +628,22 @@ mmap (void *start, size_t len, int prot, int flags, int fd, off_t offset)
                  ? idx_mmap_a : prot & PROT_WRITE ? idx_mmap_w : idx_mmap_r);
 
       /* Keep track of number of calls.  */
-      catomic_increment (&calls[idx]);
+      atomic_fetch_add_acquire (&calls[idx], 1);
       /* Keep track of total memory consumption for `malloc'.  */
-      catomic_add (&total[idx], len);
+      atomic_fetch_add_acquire (&total[idx], len);
       /* Keep track of total memory requirement.  */
-      catomic_add (&grand_total, len);
+      atomic_fetch_add_acquire (&grand_total, len);
       /* Remember the size of the request.  */
       if (len < 65536)
-        catomic_increment (&histogram[len / 16]);
+        atomic_fetch_add_acquire (&histogram[len / 16], 1);
       else
-        catomic_increment (&large);
+        atomic_fetch_add_acquire (&large, 1);
       /* Total number of calls of any of the functions.  */
-      catomic_increment (&calls_total);
+      atomic_fetch_add_acquire (&calls_total, 1);
 
       /* Check for failures.  */
       if (result == NULL)
-        catomic_increment (&failed[idx]);
+        atomic_fetch_add_acquire (&failed[idx], 1);
       else if (idx == idx_mmap_w)
         /* Update the allocation data and write out the records if
            necessary.  Note the first parameter is NULL which means
@@ -667,22 +681,22 @@ mmap64 (void *start, size_t len, int prot, int flags, int fd, off64_t offset)
                  ? idx_mmap_a : prot & PROT_WRITE ? idx_mmap_w : idx_mmap_r);
 
       /* Keep track of number of calls.  */
-      catomic_increment (&calls[idx]);
+      atomic_fetch_add_acquire (&calls[idx], 1);
       /* Keep track of total memory consumption for `malloc'.  */
-      catomic_add (&total[idx], len);
+      atomic_fetch_add_acquire (&total[idx], len);
       /* Keep track of total memory requirement.  */
-      catomic_add (&grand_total, len);
+      atomic_fetch_add_acquire (&grand_total, len);
       /* Remember the size of the request.  */
       if (len < 65536)
-        catomic_increment (&histogram[len / 16]);
+        atomic_fetch_add_acquire (&histogram[len / 16], 1);
       else
-        catomic_increment (&large);
+        atomic_fetch_add_acquire (&large, 1);
       /* Total number of calls of any of the functions.  */
-      catomic_increment (&calls_total);
+      atomic_fetch_add_acquire (&calls_total, 1);
 
       /* Check for failures.  */
       if (result == NULL)
-        catomic_increment (&failed[idx]);
+        atomic_fetch_add_acquire (&failed[idx], 1);
       else if (idx == idx_mmap_w)
         /* Update the allocation data and write out the records if
            necessary.  Note the first parameter is NULL which means
@@ -722,33 +736,33 @@ mremap (void *start, size_t old_len, size_t len, int flags, ...)
   if (!not_me && trace_mmap)
     {
       /* Keep track of number of calls.  */
-      catomic_increment (&calls[idx_mremap]);
+      atomic_fetch_add_acquire (&calls[idx_mremap], 1);
       if (len > old_len)
         {
           /* Keep track of total memory consumption for `malloc'.  */
-          catomic_add (&total[idx_mremap], len - old_len);
+          atomic_fetch_add_acquire (&total[idx_mremap], len - old_len);
           /* Keep track of total memory requirement.  */
-          catomic_add (&grand_total, len - old_len);
+          atomic_fetch_add_acquire (&grand_total, len - old_len);
         }
       /* Remember the size of the request.  */
       if (len < 65536)
-        catomic_increment (&histogram[len / 16]);
+        atomic_fetch_add_acquire (&histogram[len / 16], 1);
       else
-        catomic_increment (&large);
+        atomic_fetch_add_acquire (&large, 1);
       /* Total number of calls of any of the functions.  */
-      catomic_increment (&calls_total);
+      atomic_fetch_add_acquire (&calls_total, 1);
 
       /* Check for failures.  */
       if (result == NULL)
-        catomic_increment (&failed[idx_mremap]);
+        atomic_fetch_add_acquire (&failed[idx_mremap], 1);
       else
         {
           /* Record whether the reduction/increase happened in place.  */
           if (start == result)
-            catomic_increment (&inplace_mremap);
+            atomic_fetch_add_acquire (&inplace_mremap, 1);
           /* Was the buffer increased?  */
           if (old_len > len)
-            catomic_increment (&decreasing_mremap);
+            atomic_fetch_add_acquire (&decreasing_mremap, 1);
 
           /* Update the allocation data and write out the records if
              necessary.  Note the first parameter is NULL which means
@@ -783,19 +797,19 @@ munmap (void *start, size_t len)
   if (!not_me && trace_mmap)
     {
       /* Keep track of number of calls.  */
-      catomic_increment (&calls[idx_munmap]);
+      atomic_fetch_add_acquire (&calls[idx_munmap], 1);
 
       if (__glibc_likely (result == 0))
         {
           /* Keep track of total memory freed using `free'.  */
-          catomic_add (&total[idx_munmap], len);
+          atomic_fetch_add_acquire (&total[idx_munmap], len);
 
           /* Update the allocation data and write out the records if
              necessary.  */
           update_data (NULL, 0, len);
         }
       else
-        catomic_increment (&failed[idx_munmap]);
+        atomic_fetch_add_acquire (&failed[idx_munmap], 1);
     }
 
   return result;
diff --git a/malloc/tst-dynarray.c b/malloc/tst-dynarray.c
index 51b99e2a..c3a0e925 100644
--- a/malloc/tst-dynarray.c
+++ b/malloc/tst-dynarray.c
@@ -482,7 +482,7 @@ test_long_overflow (void)
        iteration would invoke undefined behavior.  That loop iteration
        can never be executed because an allocation of this size must
        fail.  */
-    DIAG_IGNORE_NEEDS_COMMENT (12, "-Waggressive-loop-optimizations");
+    DIAG_IGNORE_NEEDS_COMMENT_GCC (12, "-Waggressive-loop-optimizations");
     TEST_VERIFY (!dynarray_long_resize
                  (&dyn, (SIZE_MAX / sizeof (long)) + 1));
     DIAG_POP_NEEDS_COMMENT;
@@ -499,7 +499,7 @@ test_long_overflow (void)
        iteration would invoke undefined behavior.  That loop iteration
        can never be executed because an allocation of this size must
        fail.  */
-    DIAG_IGNORE_NEEDS_COMMENT (12, "-Waggressive-loop-optimizations");
+    DIAG_IGNORE_NEEDS_COMMENT_GCC (12, "-Waggressive-loop-optimizations");
     TEST_VERIFY (!dynarray_long_noscratch_resize
                  (&dyn, (SIZE_MAX / sizeof (long)) + 1));
     DIAG_POP_NEEDS_COMMENT;
diff --git a/malloc/tst-malloc-thread-exit.c b/malloc/tst-malloc-thread-exit.c
index 492d9696..41d73d66 100644
--- a/malloc/tst-malloc-thread-exit.c
+++ b/malloc/tst-malloc-thread-exit.c
@@ -42,7 +42,7 @@ static int inner_thread_count = 4;
 static size_t malloc_size = 32;
 
 static void
-__attribute__ ((noinline, noclone))
+__attribute__ ((noinline)) __attribute_noclone__
 unoptimized_free (void *ptr)
 {
   free (ptr);
diff --git a/malloc/tst-malloc-thread-fail.c b/malloc/tst-malloc-thread-fail.c
index 65cf9321..074ac533 100644
--- a/malloc/tst-malloc-thread-fail.c
+++ b/malloc/tst-malloc-thread-fail.c
@@ -33,7 +33,7 @@
 
 /* Wrapper for calloc with an optimization barrier.  */
 static void *
-__attribute__ ((noinline, noclone))
+__attribute__ ((noinline)) __attribute_noclone__
 allocate_zeroed (size_t a, size_t b)
 {
   return calloc (a, b);
diff --git a/malloc/tst-malloc.c b/malloc/tst-malloc.c
index 62e3b9b9..e3855035 100644
--- a/malloc/tst-malloc.c
+++ b/malloc/tst-malloc.c
@@ -46,6 +46,7 @@ do_test (void)
   p = malloc (-1);
   DIAG_POP_NEEDS_COMMENT;
   save = errno;
+  asm volatile("" ::: "memory");
 
   if (p != NULL)
     merror ("malloc (-1) succeeded.");
diff --git a/malloc/tst-mallocstate.c b/malloc/tst-mallocstate.c
index c2011a44..9d658fd8 100644
--- a/malloc/tst-mallocstate.c
+++ b/malloc/tst-mallocstate.c
@@ -366,7 +366,7 @@ full_heap_check (void)
 }
 
 /* Used as an optimization barrier to force a heap allocation.  */
-__attribute__ ((noinline, noclone))
+__attribute__ ((noinline)) __attribute_noclone__
 static void
 my_free (void *ptr)
 {
diff --git a/malloc/tst-memalign.c b/malloc/tst-memalign.c
index 0cef7f71..5da00954 100644
--- a/malloc/tst-memalign.c
+++ b/malloc/tst-memalign.c
@@ -83,7 +83,11 @@ do_test (void)
   errno = 0;
 
   /* Test to expose integer overflow in malloc internals from BZ #16038.  */
+  DIAG_PUSH_NEEDS_COMMENT_CLANG;
+  DIAG_IGNORE_NEEDS_COMMENT_CLANG (13, "-Wnon-power-of-two-alignment");
+  DIAG_IGNORE_NEEDS_COMMENT_CLANG (13, "-Wbuiltin-assume-aligned-alignment");
   p = memalign (-1, pagesize);
+  DIAG_POP_NEEDS_COMMENT_CLANG;
 
   save = errno;
 
@@ -120,5 +124,4 @@ do_test (void)
   return errors != 0;
 }
 
-#define TEST_FUNCTION do_test ()
-#include "../test-skeleton.c"
+#include <support/test-driver.c>
diff --git a/malloc/tst-tcfree3.c b/malloc/tst-tcfree3.c
index 3a3149b3..215134a9 100644
--- a/malloc/tst-tcfree3.c
+++ b/malloc/tst-tcfree3.c
@@ -20,7 +20,11 @@
 #include <string.h>
 
 /* Prevent GCC from optimizing away any malloc/free pairs.  */
-#pragma GCC optimize ("O0")
+#ifdef __clang__
+# pragma clang optimize off
+#else
+# pragma GCC optimize("O0")
+#endif
 
 static int
 do_test (void)
diff --git a/math/Makefile b/math/Makefile
index 7dae2313..01ec3610 100644
--- a/math/Makefile
+++ b/math/Makefile
@@ -248,8 +248,11 @@ tests = test-matherr-3 test-fenv basic-test \
 	test-femode-traps test-iszero-excess-precision \
 	test-iseqsig-excess-precision test-flt-eval-method \
 	test-fp-ilogb-constants test-fp-llogb-constants \
-	test-fe-snans-always-signal test-narrow-macros \
+	test-narrow-macros \
 	test-nan-const $(tests-static)
+ifneq ($(config-cflags-signaling-nans),)
+tests += test-fe-snans-always-signal
+endif
 tests-static = test-fpucw-static test-fpucw-ieee-static \
 	       test-signgam-uchar-static test-signgam-uchar-init-static \
 	       test-signgam-uint-static test-signgam-uint-init-static \
@@ -393,7 +396,7 @@ $(tgmath3-macro-tests:%=$(objpfx)%.o): CFLAGS += -fno-builtin
 $(foreach m,$(tgmath3-macros),\
 	    $(objpfx)test-tgmath3-$(m).c): $(objpfx)test-tgmath3-%.c: \
 					   gen-tgmath-tests.py
-	$(PYTHON) gen-tgmath-tests.py $* > $@
+	$(PYTHON) gen-tgmath-tests.py --complex-int128 $(config-complex-int128) $* > $@
 
 # Verify that the list of supported macros is in sync between the
 # Makefile and gen-tgmath-tests.py.
@@ -404,7 +407,7 @@ $(objpfx)test-tgmath3-macro-list.out: gen-tgmath-tests.py
 
 libm-test-fast-math-cflags = -fno-builtin -D__FAST_MATH__ -DTEST_FAST_MATH
 libm-test-vec-cflags = $(libm-test-fast-math-cflags) -fno-inline \
-		       -ffloat-store -D_OPENMP=201307 -Wno-unknown-pragmas
+		       $(libc_cv_cc_float_store) -D_OPENMP=201307 -Wno-unknown-pragmas
 
 CFLAGS-test-double-vlen4-wrappers.c += $(double-vlen4-arch-ext-cflags)
 
@@ -420,8 +423,8 @@ CFLAGS-test-float-vlen16-wrappers.c += $(float-vlen16-arch-ext-cflags)
 # raise spurious exceptions for sNaNs, but also do not test for
 # exceptions.  Thus both versions of the classification macros are
 # validated.
-libm-test-no-inline-cflags = -fno-inline -ffloat-store -fno-builtin \
-			     -fsignaling-nans
+libm-test-no-inline-cflags = -fno-inline $(libc_cv_cc_float_store) -fno-builtin \
+			     $(config-cflags-signaling-nans)
 CFLAGS-test-tgmath.c += -fno-builtin
 # The following testcase uses very long lines (>3 million), so it may take a
 # while to compile it. See: http://llvm.org/bugs/show_bug.cgi?id=14106 and
@@ -430,7 +433,7 @@ CFLAGS-test-tgmath2.c += -fno-builtin
 CFLAGS-test-tgmath-ret.c += -fno-builtin
 CFLAGS-test-powl.c += -fno-builtin
 
-CFLAGS-test-snan.c += -fsignaling-nans
+CFLAGS-test-snan.c += $(config-cflags-signaling-nans)
 
 CFLAGS-test-signgam-uchar.c += -std=c99
 CFLAGS-test-signgam-uchar-init.c += -std=c99
@@ -452,11 +455,11 @@ CFLAGS-test-math-iszero.cc += -std=gnu++11
 CFLAGS-test-math-issignaling.cc += -std=gnu++11
 CFLAGS-test-math-iscanonical.cc += -std=gnu++11
 
-CFLAGS-test-iszero-excess-precision.c += -fexcess-precision=standard
-CFLAGS-test-iseqsig-excess-precision.c += -fexcess-precision=standard
-CFLAGS-test-flt-eval-method.c += -fexcess-precision=standard
+CFLAGS-test-iszero-excess-precision.c += $(config-cflags-fexcess-precision-standard)
+CFLAGS-test-iseqsig-excess-precision.c += $(config-cflags-fexcess-precision-standard)
+CFLAGS-test-flt-eval-method.c += $(config-cflags-fexcess-precision-standard)
 
-CFLAGS-test-fe-snans-always-signal.c += -fsignaling-nans
+CFLAGS-test-fe-snans-always-signal.c += $(config-cflags-signaling-nans)
 
 CFLAGS-test-nan-const.c += -fno-builtin
 
@@ -768,10 +771,20 @@ endif
 
 # These files quiet sNaNs in a way that is optimized away without
 # -fsignaling-nans.
-CFLAGS-s_modf.c += -fsignaling-nans
-CFLAGS-s_modff.c += -fsignaling-nans
-CFLAGS-s_modfl.c += -fsignaling-nans
-CFLAGS-s_modff128.c += -fsignaling-nans
+CFLAGS-s_modf.c += $(config-cflags-signaling-nans)
+CFLAGS-s_modff.c += $(config-cflags-signaling-nans)
+CFLAGS-s_modfl.c += $(config-cflags-signaling-nans)
+CFLAGS-s_modff128.c += $(config-cflags-signaling-nans)
+
+CFLAGS-s_llround.c += -Wno-incompatible-library-redeclaration
+CFLAGS-s_fabsl.c += -Wno-ignored-attributes
+CFLAGS-s_fabsf128.c += -Wno-ignored-attributes
+CFLAGS-fraiseexcpt.c += -Wno-ignored-attributes
+CFLAGS-fegetround.c += -Wno-ignored-attributes
+CFLAGS-fesetround.c += -Wno-ignored-attributes
+CFLAGS-fegetenv.c += -Wno-ignored-attributes
+CFLAGS-fesetenv.c += -Wno-ignored-attributes
+CFLAGS-feholdexcpt.c += -Wno-ignored-attributes
 
 $(addprefix $(objpfx),\
 	    $(filter-out $(tests-static) $(libm-tests-vector),\
diff --git a/math/bug-tgmath1.c b/math/bug-tgmath1.c
index 16db9d17..ca819671 100644
--- a/math/bug-tgmath1.c
+++ b/math/bug-tgmath1.c
@@ -1,5 +1,6 @@
 #include <stdio.h>
 #include <tgmath.h>
+#include <libc-diag.h>
 
 
 int
@@ -29,12 +30,16 @@ main (void)
   TEST (cimag (1.0f), sizeof (float));
   TEST (cimag (1.0f + 1.0fi), sizeof (float));
 
+  /* TODO: add why clang requires this.  */
+  DIAG_PUSH_NEEDS_COMMENT_CLANG;
+  DIAG_IGNORE_NEEDS_COMMENT_CLANG (13, "-Wabsolute-value");
   TEST (fabs (1.0), sizeof (double));
   TEST (fabs (1.0 + 1.0i), sizeof (double));
   TEST (fabs (1.0l), sizeof (long double));
   TEST (fabs (1.0l + 1.0li), sizeof (long double));
   TEST (fabs (1.0f), sizeof (float));
   TEST (fabs (1.0f + 1.0fi), sizeof (float));
+  DIAG_POP_NEEDS_COMMENT_CLANG;
 
   TEST (carg (1.0), sizeof (double));
   TEST (carg (1.0 + 1.0i), sizeof (double));
diff --git a/math/complex.h b/math/complex.h
index 5948fa84..7bbef4b6 100644
--- a/math/complex.h
+++ b/math/complex.h
@@ -52,7 +52,7 @@ __BEGIN_DECLS
 #undef I
 #define I _Complex_I
 
-#if defined __USE_ISOC11 && __GNUC_PREREQ (4, 7)
+#if defined __USE_ISOC11 && (__GNUC_PREREQ (4, 7) || defined __clang__)
 /* Macros to expand into expression of specified complex type.  */
 # define CMPLX(x, y) __builtin_complex ((double) (x), (double) (y))
 # define CMPLXF(x, y) __builtin_complex ((float) (x), (float) (y))
diff --git a/math/gen-tgmath-tests.py b/math/gen-tgmath-tests.py
index c841db60..703491e1 100755
--- a/math/gen-tgmath-tests.py
+++ b/math/gen-tgmath-tests.py
@@ -54,6 +54,7 @@
 # supported on any given configuration of glibc, the MANT_DIG value
 # uniquely determines the format.
 
+import argparse
 import string
 import sys
 
@@ -183,7 +184,7 @@ class Type(object):
         return self.name
 
     @staticmethod
-    def init_types():
+    def init_types(complex_int128):
         """Initialize all the known types."""
         Type.create_type('_Float16', 'f16', 'FLT16_MANT_DIG',
                          complex_name='__CFLOAT16',
@@ -218,9 +219,11 @@ class Type(object):
         Type.create_type('long long int', integer=True)
         Type.create_type('unsigned long long int', integer=True)
         Type.create_type('__int128', integer=True,
-                         condition='defined __SIZEOF_INT128__')
+                         condition='defined __SIZEOF_INT128__',
+                         complex_ok=complex_int128)
         Type.create_type('unsigned __int128', integer=True,
-                         condition='defined __SIZEOF_INT128__')
+                         condition='defined __SIZEOF_INT128__',
+                         complex_ok=complex_int128)
         Type.create_type('enum e', integer=True, complex_ok=False)
         Type.create_type('_Bool', integer=True, complex_ok=False)
         Type.create_type('bit_field', integer=True, complex_ok=False)
@@ -785,15 +788,32 @@ class Tests(object):
             print('error: macro list mismatch')
             sys.exit(1)
 
-def main():
+def get_parser():
+    def strbool(string):
+        return True if string.lower() == 'yes' else False
+
+    parser = argparse.ArgumentParser(description=__doc__)
+    parser.add_argument('--complex-int128', dest='complex_int128',
+                        help='Generate tests for _Complex __int128',
+                        type=strbool)
+    parser.add_argument('--check-list', action='store_true',
+                        help='Verify that the list of supported macros')
+    parser.add_argument('macro',
+                        help='macro to test',
+                        nargs='*')
+    return parser
+
+def main(argv):
     """The main entry point."""
-    Type.init_types()
+    parser = get_parser()
+    opts = parser.parse_args(argv)
+    Type.init_types(True if opts.complex_int128 == 'yes' else False)
     t = Tests()
-    if sys.argv[1] == 'check-list':
+    if opts.check_list:
         macro = None
-        macro_list = sys.argv[2:]
+        macro_list = opts.macro
     else:
-        macro = sys.argv[1]
+        macro = opts.macro
         macro_list = []
     t.add_all_tests(macro)
     if macro:
@@ -802,4 +822,4 @@ def main():
         t.check_macro_list(macro_list)
 
 if __name__ == '__main__':
-    main()
+    main(sys.argv[1:])
diff --git a/math/libm-test-fpclassify.inc b/math/libm-test-fpclassify.inc
index f805ad5e..dafb1fc6 100644
--- a/math/libm-test-fpclassify.inc
+++ b/math/libm-test-fpclassify.inc
@@ -22,8 +22,10 @@ static const struct test_f_i_data fpclassify_test_data[] =
   {
     TEST_f_i (fpclassify, qnan_value, FP_NAN, NO_INEXACT_EXCEPTION|ERRNO_UNCHANGED),
     TEST_f_i (fpclassify, -qnan_value, FP_NAN, NO_INEXACT_EXCEPTION|ERRNO_UNCHANGED),
+#ifdef __SUPPORT_SNAN__
     TEST_f_i (fpclassify, snan_value, FP_NAN, NO_INEXACT_EXCEPTION|ERRNO_UNCHANGED),
     TEST_f_i (fpclassify, -snan_value, FP_NAN, NO_INEXACT_EXCEPTION|ERRNO_UNCHANGED),
+#endif
     TEST_f_i (fpclassify, plus_infty, FP_INFINITE, NO_INEXACT_EXCEPTION|ERRNO_UNCHANGED),
     TEST_f_i (fpclassify, minus_infty, FP_INFINITE, NO_INEXACT_EXCEPTION|ERRNO_UNCHANGED),
     TEST_f_i (fpclassify, plus_zero, FP_ZERO, NO_INEXACT_EXCEPTION|ERRNO_UNCHANGED),
diff --git a/math/libm-test-isfinite.inc b/math/libm-test-isfinite.inc
index 37a4ca42..5b22dbce 100644
--- a/math/libm-test-isfinite.inc
+++ b/math/libm-test-isfinite.inc
@@ -33,8 +33,10 @@ static const struct test_f_i_data isfinite_test_data[] =
     TEST_f_b (isfinite, minus_infty, 0, NO_INEXACT_EXCEPTION|ERRNO_UNCHANGED),
     TEST_f_b (isfinite, qnan_value, 0, NO_INEXACT_EXCEPTION|ERRNO_UNCHANGED),
     TEST_f_b (isfinite, -qnan_value, 0, NO_INEXACT_EXCEPTION|ERRNO_UNCHANGED),
+#ifdef __SUPPORT_SNAN__
     TEST_f_b (isfinite, snan_value, 0, NO_INEXACT_EXCEPTION|ERRNO_UNCHANGED),
     TEST_f_b (isfinite, -snan_value, 0, NO_INEXACT_EXCEPTION|ERRNO_UNCHANGED),
+#endif
   };
 
 static void
diff --git a/math/libm-test-isinf.inc b/math/libm-test-isinf.inc
index 26548729..990babf0 100644
--- a/math/libm-test-isinf.inc
+++ b/math/libm-test-isinf.inc
@@ -33,8 +33,10 @@ static const struct test_f_i_data isinf_test_data[] =
     TEST_f_b (isinf, minus_infty, 1, NO_INEXACT_EXCEPTION|ERRNO_UNCHANGED),
     TEST_f_b (isinf, qnan_value, 0, NO_INEXACT_EXCEPTION|ERRNO_UNCHANGED),
     TEST_f_b (isinf, -qnan_value, 0, NO_INEXACT_EXCEPTION|ERRNO_UNCHANGED),
+#ifdef __SUPPORT_SNAN__
     TEST_f_b (isinf, snan_value, 0, NO_INEXACT_EXCEPTION|ERRNO_UNCHANGED),
     TEST_f_b (isinf, -snan_value, 0, NO_INEXACT_EXCEPTION|ERRNO_UNCHANGED),
+#endif
   };
 
 #if TEST_COND_intel96
diff --git a/math/libm-test-isnan.inc b/math/libm-test-isnan.inc
index 026b61c2..2edfd7c6 100644
--- a/math/libm-test-isnan.inc
+++ b/math/libm-test-isnan.inc
@@ -33,8 +33,10 @@ static const struct test_f_i_data isnan_test_data[] =
     TEST_f_b (isnan, minus_infty, 0, NO_INEXACT_EXCEPTION|ERRNO_UNCHANGED),
     TEST_f_b (isnan, qnan_value, 1, NO_INEXACT_EXCEPTION|ERRNO_UNCHANGED),
     TEST_f_b (isnan, -qnan_value, 1, NO_INEXACT_EXCEPTION|ERRNO_UNCHANGED),
+#ifdef __SUPPORT_SNAN__
     TEST_f_b (isnan, snan_value, 1, NO_INEXACT_EXCEPTION|ERRNO_UNCHANGED),
     TEST_f_b (isnan, -snan_value, 1, NO_INEXACT_EXCEPTION|ERRNO_UNCHANGED),
+#endif
   };
 
 #if TEST_COND_intel96
diff --git a/math/libm-test-isnormal.inc b/math/libm-test-isnormal.inc
index e1e8a3b2..e4f6a8f7 100644
--- a/math/libm-test-isnormal.inc
+++ b/math/libm-test-isnormal.inc
@@ -33,8 +33,10 @@ static const struct test_f_i_data isnormal_test_data[] =
     TEST_f_b (isnormal, minus_infty, 0, NO_INEXACT_EXCEPTION|ERRNO_UNCHANGED),
     TEST_f_b (isnormal, qnan_value, 0, NO_INEXACT_EXCEPTION|ERRNO_UNCHANGED),
     TEST_f_b (isnormal, -qnan_value, 0, NO_INEXACT_EXCEPTION|ERRNO_UNCHANGED),
+#ifdef __SUPPORT_SNAN__
     TEST_f_b (isnormal, snan_value, 0, NO_INEXACT_EXCEPTION|ERRNO_UNCHANGED),
     TEST_f_b (isnormal, -snan_value, 0, NO_INEXACT_EXCEPTION|ERRNO_UNCHANGED),
+#endif
   };
 
 static void
diff --git a/math/libm-test-issubnormal.inc b/math/libm-test-issubnormal.inc
index 38564f2b..cc045435 100644
--- a/math/libm-test-issubnormal.inc
+++ b/math/libm-test-issubnormal.inc
@@ -33,8 +33,10 @@ static const struct test_f_i_data issubnormal_test_data[] =
     TEST_f_b (issubnormal, minus_infty, 0, NO_INEXACT_EXCEPTION|ERRNO_UNCHANGED),
     TEST_f_b (issubnormal, qnan_value, 0, NO_INEXACT_EXCEPTION|ERRNO_UNCHANGED),
     TEST_f_b (issubnormal, -qnan_value, 0, NO_INEXACT_EXCEPTION|ERRNO_UNCHANGED),
+#ifdef __SUPPORT_SNAN__
     TEST_f_b (issubnormal, snan_value, 0, NO_INEXACT_EXCEPTION|ERRNO_UNCHANGED),
     TEST_f_b (issubnormal, -snan_value, 0, NO_INEXACT_EXCEPTION|ERRNO_UNCHANGED),
+#endif
   };
 
 static void
diff --git a/math/libm-test-iszero.inc b/math/libm-test-iszero.inc
index cfd3d1fe..e56eac4e 100644
--- a/math/libm-test-iszero.inc
+++ b/math/libm-test-iszero.inc
@@ -33,8 +33,10 @@ static const struct test_f_i_data iszero_test_data[] =
     TEST_f_b (iszero, minus_infty, 0, NO_INEXACT_EXCEPTION|ERRNO_UNCHANGED),
     TEST_f_b (iszero, qnan_value, 0, NO_INEXACT_EXCEPTION|ERRNO_UNCHANGED),
     TEST_f_b (iszero, -qnan_value, 0, NO_INEXACT_EXCEPTION|ERRNO_UNCHANGED),
+#ifdef __SUPPORT_SNAN__
     TEST_f_b (iszero, snan_value, 0, NO_INEXACT_EXCEPTION|ERRNO_UNCHANGED),
     TEST_f_b (iszero, -snan_value, 0, NO_INEXACT_EXCEPTION|ERRNO_UNCHANGED),
+#endif
   };
 
 static void
diff --git a/math/math-underflow.h b/math/math-underflow.h
index c9d363dd..4bec3d34 100644
--- a/math/math-underflow.h
+++ b/math/math-underflow.h
@@ -23,6 +23,7 @@
 #include <math.h>
 
 #include <math-barriers.h>
+#include <libc-diag.h>
 
 #define fabs_tg(x) __MATH_TG ((x), (__typeof (x)) __builtin_fabs, (x))
 
@@ -37,10 +38,15 @@
 #define min_of_type(x) __MATH_TG ((x), (__typeof (x)) min_of_type_, ())
 
 /* If X (which is not a NaN) is subnormal, force an underflow
-   exception.  */
+   exception.
+
+   clang issues a warning where _Generic is using a non expected
+   builtin which may cause truncation of value.  */
 #define math_check_force_underflow(x)				\
   do								\
     {								\
+      DIAG_PUSH_NEEDS_COMMENT_CLANG;				\
+      DIAG_IGNORE_NEEDS_COMMENT_CLANG (13, "-Wabsolute-value"); \
       __typeof (x) force_underflow_tmp = (x);			\
       if (fabs_tg (force_underflow_tmp)				\
 	  < min_of_type (force_underflow_tmp))			\
@@ -49,6 +55,7 @@
 	    = force_underflow_tmp * force_underflow_tmp;	\
 	  math_force_eval (force_underflow_tmp2);		\
 	}							\
+      DIAG_POP_NEEDS_COMMENT_CLANG;				\
     }								\
   while (0)
 /* Likewise, but X is also known to be nonnegative.  */
diff --git a/math/math.h b/math/math.h
index 27963ef6..1cac405f 100644
--- a/math/math.h
+++ b/math/math.h
@@ -955,8 +955,7 @@ enum
    the __SUPPORT_SNAN__ check may be skipped for those versions.  */
 
 /* Return number of classification appropriate for X.  */
-# if ((__GNUC_PREREQ (4,4) && !defined __SUPPORT_SNAN__)		      \
-      || __glibc_clang_prereq (2,8))					      \
+# if ((__GNUC_PREREQ (4,4) && !defined __SUPPORT_SNAN__))		      \
      && (!defined __OPTIMIZE_SIZE__ || defined __cplusplus)
      /* The check for __cplusplus allows the use of the builtin, even
 	when optimization for size is on.  This is provided for
@@ -997,8 +996,7 @@ enum
 # endif
 
 /* Return nonzero value if X is neither zero, subnormal, Inf, nor NaN.  */
-# if (__GNUC_PREREQ (4,4) && !defined __SUPPORT_SNAN__) \
-     || __glibc_clang_prereq (2,8)
+# if (__GNUC_PREREQ (4,4) && !defined __SUPPORT_SNAN__)
 #  define isnormal(x) __builtin_isnormal (x)
 # else
 #  define isnormal(x) (fpclassify (x) == FP_NORMAL)
@@ -1006,8 +1004,7 @@ enum
 
 /* Return nonzero value if X is a NaN.  We could use `fpclassify' but
    we already have this functions `__isnan' and it is faster.  */
-# if (__GNUC_PREREQ (4,4) && !defined __SUPPORT_SNAN__) \
-     || __glibc_clang_prereq (2,8)
+# if (__GNUC_PREREQ (4,4) && !defined __SUPPORT_SNAN__)
 #  define isnan(x) __builtin_isnan (x)
 # else
 #  define isnan(x) __MATH_TG ((x), __isnan, (x))
@@ -1015,7 +1012,8 @@ enum
 
 /* Return nonzero value if X is positive or negative infinity.  */
 # if __HAVE_DISTINCT_FLOAT128 && !__GNUC_PREREQ (7,0) \
-     && !defined __SUPPORT_SNAN__ && !defined __cplusplus
+     && !defined __SUPPORT_SNAN__ && !defined __cplusplus \
+     && !defined __clang__
    /* Since __builtin_isinf_sign is broken for float128 before GCC 7.0,
       use the helper function, __isinff128, with older compilers.  This is
       only provided for C mode, because in C++ mode, GCC has no support
@@ -1024,8 +1022,7 @@ enum
 #  define isinf(x) \
     (__builtin_types_compatible_p (__typeof (x), _Float128) \
      ? __isinff128 (x) : __builtin_isinf_sign (x))
-# elif (__GNUC_PREREQ (4,4) && !defined __SUPPORT_SNAN__) \
-       || __glibc_clang_prereq (3,7)
+# elif (__GNUC_PREREQ (4,4) && !defined __SUPPORT_SNAN__)
 #  define isinf(x) __builtin_isinf_sign (x)
 # else
 #  define isinf(x) __MATH_TG ((x), __isinf, (x))
@@ -1295,7 +1292,7 @@ iszero (__T __val)
 #endif
 
 #ifdef __USE_ISOC99
-# if __GNUC_PREREQ (3, 1)
+# if __GNUC_PREREQ (3, 1) && !defined __clang__
 /* ISO C99 defines some macros to compare number while taking care for
    unordered numbers.  Many FPUs provide special instructions to support
    these operations.  Generic support in GCC for these as builtins went
diff --git a/math/test-snan.c b/math/test-snan.c
index 4d7bd54a..fadde897 100644
--- a/math/test-snan.c
+++ b/math/test-snan.c
@@ -25,8 +25,10 @@
 #include <setjmp.h>
 
 #include <math-tests.h>
+#include <support/check.h>
 
 
+#ifdef __SUPPORT_SNAN__
 static sigjmp_buf sigfpe_buf;
 
 static void
@@ -123,10 +125,12 @@ NAME (void)								      \
 TEST_FUNC (float_test, float, f)
 TEST_FUNC (double_test, double, )
 TEST_FUNC (ldouble_test, long double, l)
+#endif
 
 static int
 do_test (void)
 {
+#ifdef __SUPPORT_SNAN__
   signal (SIGFPE, &myFPsighandler);
 
   float_test ();
@@ -134,7 +138,9 @@ do_test (void)
   ldouble_test ();
 
   return errors != 0;
+#else
+  FAIL_UNSUPPORTED ("compiler does not support -fsignaling-nans");
+#endif
 }
 
-#define TEST_FUNCTION do_test ()
-#include "../test-skeleton.c"
+#include <support/test-driver.c>
diff --git a/math/test-tgmath-ret.c b/math/test-tgmath-ret.c
index 8c1cce37..acfb6e66 100644
--- a/math/test-tgmath-ret.c
+++ b/math/test-tgmath-ret.c
@@ -21,13 +21,20 @@
 #include <tgmath.h>
 #include <stdint.h>
 #include <stdio.h>
+#include <libc-diag.h>
 
+/* clang warns that since the global variables are only used to function
+   calls (without being actually used), there are not needed and will not
+   be emitted.  */
+DIAG_PUSH_NEEDS_COMMENT_CLANG;
+DIAG_IGNORE_NEEDS_COMMENT_CLANG (13, "-Wunneeded-internal-declaration");
 static float fx;
 static double dx;
 static long double lx;
 static int rm = FP_INT_UPWARD;
 static unsigned int width = 64;
 static int errors = 0;
+DIAG_POP_NEEDS_COMMENT_CLANG;
 
 static void
 our_error (const char *c)
diff --git a/misc/Makefile b/misc/Makefile
index 3d8a569d..86236b65 100644
--- a/misc/Makefile
+++ b/misc/Makefile
@@ -34,10 +34,9 @@ headers	:= sys/uio.h bits/uio-ext.h bits/uio_lim.h \
 	   sys/select.h sys/sysinfo.h \
 	   regexp.h bits/select.h bits/mman.h sys/xattr.h \
 	   syslog.h sys/syslog.h \
-	   bits/syslog.h bits/syslog-ldbl.h bits/syslog-path.h bits/error.h \
+	   bits/syslog.h bits/syslog-path.h bits/error.h \
 	   bits/select2.h bits/hwcap.h sys/auxv.h \
 	   sys/sysmacros.h bits/sysmacros.h bits/types/struct_iovec.h \
-	   bits/err-ldbl.h bits/error-ldbl.h \
 	   sys/single_threaded.h
 
 routines := brk sbrk sstk ioctl \
@@ -130,7 +129,7 @@ CFLAGS-preadv64v2.c += -fexceptions -fasynchronous-unwind-tables
 CFLAGS-pwritev2.c += -fexceptions -fasynchronous-unwind-tables
 CFLAGS-pwritev64v2.c += -fexceptions -fasynchronous-unwind-tables
 CFLAGS-usleep.c += -fexceptions
-CFLAGS-syslog.c += -fexceptions
+CFLAGS-syslog.c += -fexceptions -Wstring-plus-int
 CFLAGS-error.c += -fexceptions
 CFLAGS-getpass.c += -fexceptions
 CFLAGS-mkstemp.c += -fexceptions
@@ -142,6 +141,8 @@ CFLAGS-tst-tsearch.c += $(stack-align-test-flags)
 CFLAGS-msync.c += -fexceptions -fasynchronous-unwind-tables
 CFLAGS-fdatasync.c += -fexceptions -fasynchronous-unwind-tables
 CFLAGS-fsync.c += -fexceptions -fasynchronous-unwind-tables
+CFLAGS-makedev.c += $(config-cflags-wno-ignored-attributes)
+CFLAGS-mmap64.c += $(config-cflags-wno-ignored-attributes)
 
 # Called during static library initialization, so turn stack-protection
 # off for non-shared builds.
diff --git a/misc/bits/err-ldbl.h b/misc/bits/err-ldbl.h
deleted file mode 100644
index 7b1153da..00000000
--- a/misc/bits/err-ldbl.h
+++ /dev/null
@@ -1,30 +0,0 @@
-/* Redirections for err.h functions for -mlong-double-64.
-   Copyright (C) 2019-2022 Free Software Foundation, Inc.
-   This file is part of the GNU C Library.
-
-   The GNU C Library is free software; you can redistribute it and/or
-   modify it under the terms of the GNU Lesser General Public
-   License as published by the Free Software Foundation; either
-   version 2.1 of the License, or (at your option) any later version.
-
-   The GNU C Library is distributed in the hope that it will be useful,
-   but WITHOUT ANY WARRANTY; without even the implied warranty of
-   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
-   Lesser General Public License for more details.
-
-   You should have received a copy of the GNU Lesser General Public
-   License along with the GNU C Library; if not, see
-   <https://www.gnu.org/licenses/>.  */
-
-#ifndef _ERR_H
-# error "Never include <bits/err-ldbl.h> directly; use <err.h> instead."
-#endif
-
-__LDBL_REDIR_DECL (warn)
-__LDBL_REDIR_DECL (vwarn)
-__LDBL_REDIR_DECL (warnx)
-__LDBL_REDIR_DECL (vwarnx)
-__LDBL_REDIR_DECL (err)
-__LDBL_REDIR_DECL (verr)
-__LDBL_REDIR_DECL (errx)
-__LDBL_REDIR_DECL (verrx)
diff --git a/misc/bits/error-ldbl.h b/misc/bits/error-ldbl.h
deleted file mode 100644
index 942b05aa..00000000
--- a/misc/bits/error-ldbl.h
+++ /dev/null
@@ -1,24 +0,0 @@
-/* Redirections for error.h functions for -mlong-double-64.
-   Copyright (C) 2019-2022 Free Software Foundation, Inc.
-   This file is part of the GNU C Library.
-
-   The GNU C Library is free software; you can redistribute it and/or
-   modify it under the terms of the GNU Lesser General Public
-   License as published by the Free Software Foundation; either
-   version 2.1 of the License, or (at your option) any later version.
-
-   The GNU C Library is distributed in the hope that it will be useful,
-   but WITHOUT ANY WARRANTY; without even the implied warranty of
-   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
-   Lesser General Public License for more details.
-
-   You should have received a copy of the GNU Lesser General Public
-   License along with the GNU C Library; if not, see
-   <https://www.gnu.org/licenses/>.  */
-
-#ifndef _ERROR_H
-# error "Never include <bits/error-ldbl.h> directly; use <error.h> instead."
-#endif
-
-__LDBL_REDIR_DECL (error)
-__LDBL_REDIR_DECL (error_at_line)
diff --git a/misc/bits/syslog-ldbl.h b/misc/bits/syslog-ldbl.h
deleted file mode 100644
index 78ca8884..00000000
--- a/misc/bits/syslog-ldbl.h
+++ /dev/null
@@ -1,35 +0,0 @@
-/* -mlong-double-64 compatibility mode for syslog functions.
-   Copyright (C) 2006-2022 Free Software Foundation, Inc.
-   This file is part of the GNU C Library.
-
-   The GNU C Library is free software; you can redistribute it and/or
-   modify it under the terms of the GNU Lesser General Public
-   License as published by the Free Software Foundation; either
-   version 2.1 of the License, or (at your option) any later version.
-
-   The GNU C Library is distributed in the hope that it will be useful,
-   but WITHOUT ANY WARRANTY; without even the implied warranty of
-   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
-   Lesser General Public License for more details.
-
-   You should have received a copy of the GNU Lesser General Public
-   License along with the GNU C Library; if not, see
-   <https://www.gnu.org/licenses/>.  */
-
-#ifndef _SYS_SYSLOG_H
-# error "Never include <bits/syslog-ldbl.h> directly; use <sys/syslog.h> instead."
-#endif
-
-__LDBL_REDIR_DECL (syslog)
-
-#ifdef __USE_MISC
-__LDBL_REDIR_DECL (vsyslog)
-#endif
-
-#if __USE_FORTIFY_LEVEL > 0 && defined __fortify_function
-__LDBL_REDIR2_DECL (syslog_chk)
-
-# ifdef __USE_MISC
-__LDBL_REDIR2_DECL (vsyslog_chk)
-# endif
-#endif
diff --git a/misc/bits/syslog.h b/misc/bits/syslog.h
index fd30dd31..e3b37623 100644
--- a/misc/bits/syslog.h
+++ b/misc/bits/syslog.h
@@ -21,8 +21,17 @@
 #endif
 
 
-extern void __syslog_chk (int __pri, int __flag, const char *__fmt, ...)
+extern void __REDIRECT_LDBL (__syslog_chk, (int __pri, int __flag,
+					    const char *__fmt, ...),
+			     __syslog_chkieee128, __nldbl___syslog_chk)
      __attribute__ ((__format__ (__printf__, 3, 4)));
+#ifdef __USE_MISC
+extern void __REDIRECT_LDBL (__vsyslog_chk, (int __pri, int __flag,
+					     const char *__fmt,
+					     __gnuc_va_list __ap),
+			     __vsyslog_chkieee128, __nldbl___vsyslog_chk)
+     __attribute__ ((__format__ (__printf__, 3, 0)));
+#endif
 
 #ifdef __va_arg_pack
 __fortify_function void
@@ -37,10 +46,6 @@ syslog (int __pri, const char *__fmt, ...)
 
 
 #ifdef __USE_MISC
-extern void __vsyslog_chk (int __pri, int __flag, const char *__fmt,
-			   __gnuc_va_list __ap)
-     __attribute__ ((__format__ (__printf__, 3, 0)));
-
 __fortify_function void
 vsyslog (int __pri, const char *__fmt, __gnuc_va_list __ap)
 {
diff --git a/misc/efgcvt-template.c b/misc/efgcvt-template.c
index 87a90e78..f1630fd7 100644
--- a/misc/efgcvt-template.c
+++ b/misc/efgcvt-template.c
@@ -24,7 +24,7 @@
 #include <math_ldbl_opt.h>
 
 #ifndef SPRINTF
-# define SPRINTF sprintf
+# define SPRINTF __sprintf
 #endif
 
 #define APPEND(a, b) APPEND2 (a, b)
diff --git a/misc/err.c b/misc/err.c
index e8d98840..0a6eb72f 100644
--- a/misc/err.c
+++ b/misc/err.c
@@ -33,7 +33,7 @@ extern char *__progname;
 {									      \
   va_list ap;								      \
   va_start (ap, format);						      \
-  call;									      \
+  __##call;								      \
   va_end (ap);								      \
 }
 
@@ -72,48 +72,54 @@ __vwarn_internal (const char *format, __gnuc_va_list ap,
 }
 
 void
-vwarn (const char *format, __gnuc_va_list ap)
+__vwarn (const char *format, __gnuc_va_list ap)
 {
   __vwarn_internal (format, ap, 0);
 }
-libc_hidden_def (vwarn)
+libc_hidden_def (__vwarn)
+weak_alias (__vwarn, vwarn)
 
 void
-vwarnx (const char *format, __gnuc_va_list ap)
+__vwarnx (const char *format, __gnuc_va_list ap)
 {
   __vwarnx_internal (format, ap, 0);
 }
-libc_hidden_def (vwarnx)
+libc_hidden_def (__vwarnx)
+weak_alias (__vwarnx, vwarnx)
 
 void
-warn (const char *format, ...)
+__warn (const char *format, ...)
 {
   VA (vwarn (format, ap))
 }
-libc_hidden_def (warn)
+libc_hidden_def (__warn)
+weak_alias (__warn, warn)
 
 void
-warnx (const char *format, ...)
+__warnx (const char *format, ...)
 {
   VA (vwarnx (format, ap))
 }
-libc_hidden_def (warnx)
+libc_hidden_def (__warnx)
+weak_alias (__warnx, warnx)
 
 void
-verr (int status, const char *format, __gnuc_va_list ap)
+__verr (int status, const char *format, __gnuc_va_list ap)
 {
-  vwarn (format, ap);
+  __vwarn (format, ap);
   exit (status);
 }
-libc_hidden_def (verr)
+libc_hidden_def (__verr)
+weak_alias (__verr, verr)
 
 void
-verrx (int status, const char *format, __gnuc_va_list ap)
+__verrx (int status, const char *format, __gnuc_va_list ap)
 {
-  vwarnx (format, ap);
+  __vwarnx (format, ap);
   exit (status);
 }
-libc_hidden_def (verrx)
+libc_hidden_def (__verrx)
+weak_alias (__verrx, verrx)
 
 void
 err (int status, const char *format, ...)
diff --git a/misc/err.h b/misc/err.h
index 3b417736..b2164980 100644
--- a/misc/err.h
+++ b/misc/err.h
@@ -31,32 +31,37 @@ __BEGIN_DECLS
 
 /* Print "program: ", FORMAT, ": ", the standard error string for errno,
    and a newline, on stderr.  */
-extern void warn (const char *__format, ...)
+extern void __REDIRECT_LDBL (warn, (const char *__format, ...),
+			     __warnieee128, __nldbl_warn)
      __attribute__ ((__format__ (__printf__, 1, 2)));
-extern void vwarn (const char *__format, __gnuc_va_list)
+extern void __REDIRECT_LDBL (vwarn, (const char *__format, __gnuc_va_list),
+			     __vwarnieee128, __nldbl_vwarn)
      __attribute__ ((__format__ (__printf__, 1, 0)));
 
 /* Likewise, but without ": " and the standard error string.  */
-extern void warnx (const char *__format, ...)
+extern void __REDIRECT_LDBL (warnx, (const char *__format, ...),
+			     __warnxieee128, __nldbl_warnx)
      __attribute__ ((__format__ (__printf__, 1, 2)));
-extern void vwarnx (const char *__format, __gnuc_va_list)
+extern void __REDIRECT_LDBL (vwarnx, (const char *__format, __gnuc_va_list),
+			     __vwarnxieee128, __nldbl_vwarnx)
      __attribute__ ((__format__ (__printf__, 1, 0)));
 
 /* Likewise, and then exit with STATUS.  */
-extern void err (int __status, const char *__format, ...)
+extern void __REDIRECT_LDBL (err, (int __status, const char *__format, ...),
+			     __errieee128, __nldbl_err)
      __attribute__ ((__noreturn__, __format__ (__printf__, 2, 3)));
-extern void verr (int __status, const char *__format, __gnuc_va_list)
+extern void __REDIRECT_LDBL (verr, (int __status, const char *__format,
+				    __gnuc_va_list),
+			     __verrieee128, __nldbl_verr)
      __attribute__ ((__noreturn__, __format__ (__printf__, 2, 0)));
-extern void errx (int __status, const char *__format, ...)
+extern void __REDIRECT_LDBL (errx, (int __status, const char *__format, ...),
+			     __errxieee128, __nldbl_errx)
      __attribute__ ((__noreturn__, __format__ (__printf__, 2, 3)));
-extern void verrx (int __status, const char *, __gnuc_va_list)
+extern void __REDIRECT_LDBL (verrx, (int __status, const char *__format,
+				     __gnuc_va_list),
+			     __verrxieee128, __nldbl_verrx)
      __attribute__ ((__noreturn__, __format__ (__printf__, 2, 0)));
 
-#include <bits/floatn.h>
-#if defined __LDBL_COMPAT || __LDOUBLE_REDIRECTS_TO_FLOAT128_ABI == 1
-# include <bits/err-ldbl.h>
-#endif
-
 __END_DECLS
 
 #endif	/* err.h */
diff --git a/misc/error.h b/misc/error.h
index 05d68271..16fe9df9 100644
--- a/misc/error.h
+++ b/misc/error.h
@@ -20,6 +20,7 @@
 #define _ERROR_H 1
 
 #include <features.h>
+#include <bits/floatn.h>
 
 
 __BEGIN_DECLS
@@ -28,11 +29,15 @@ __BEGIN_DECLS
    if ERRNUM is nonzero, follow it with ": " and strerror (ERRNUM).
    If STATUS is nonzero, terminate the program with `exit (STATUS)'.  */
 
-extern void error (int __status, int __errnum, const char *__format, ...)
+extern void __REDIRECT_LDBL (error, (int __status, int __errnum,
+				     const char *__format, ...),
+			     __errorieee128, __nldbl_error)
      __attribute__ ((__format__ (__printf__, 3, 4)));
-
-extern void error_at_line (int __status, int __errnum, const char *__fname,
-			   unsigned int __lineno, const char *__format, ...)
+extern void __REDIRECT_LDBL (error_at_line, (int __status, int __errnum,
+					     const char *__fname,
+					     unsigned int __lineno,
+					     const char *__format, ...),
+			     __error_at_lineieee128, __nldbl_error_at_line)
      __attribute__ ((__format__ (__printf__, 5, 6)));
 
 /* If NULL, error will flush stdout, then print on stderr the program
@@ -47,14 +52,11 @@ extern unsigned int error_message_count;
    variable controls whether this mode is selected or not.  */
 extern int error_one_per_line;
 
-#include <bits/floatn.h>
-#if defined __LDBL_COMPAT || __LDOUBLE_REDIRECTS_TO_FLOAT128_ABI == 1
-# include <bits/error-ldbl.h>
-#else
 /* Do not inline error and error_at_line when long double has the same
    size of double, nor when long double reuses the float128
    implementation, because that would invalidate the redirections to the
    compatibility functions.  */
+#if !defined __LDBL_COMPAT && __LDOUBLE_REDIRECTS_TO_FLOAT128_ABI == 0
 # if defined __extern_always_inline && defined __va_arg_pack
 #  include <bits/error.h>
 # endif
diff --git a/misc/makedev.c b/misc/makedev.c
index 1629b80a..c39c3062 100644
--- a/misc/makedev.c
+++ b/misc/makedev.c
@@ -27,10 +27,10 @@
 
 __SYSMACROS_DEFINE_MAJOR(OUT_OF_LINE_IMPL_TEMPL)
 weak_alias (__gnu_dev_major, gnu_dev_major)
-libc_hidden_weak (gnu_dev_major)
+libc_hidden_weak (__gnu_dev_major)
 __SYSMACROS_DEFINE_MINOR(OUT_OF_LINE_IMPL_TEMPL)
 weak_alias (__gnu_dev_minor, gnu_dev_minor)
-libc_hidden_weak (gnu_dev_minor)
+libc_hidden_weak (__gnu_dev_minor)
 __SYSMACROS_DEFINE_MAKEDEV(OUT_OF_LINE_IMPL_TEMPL)
 weak_alias (__gnu_dev_makedev, gnu_dev_makedev)
-libc_hidden_weak (gnu_dev_makedev)
+libc_hidden_weak (__gnu_dev_makedev)
diff --git a/misc/mntent_r.c b/misc/mntent_r.c
index 3311ba0b..65f29b97 100644
--- a/misc/mntent_r.c
+++ b/misc/mntent_r.c
@@ -251,7 +251,7 @@ __addmntent (FILE *stream, const struct mntent *mnt)
   write_string (stream, mnt->mnt_dir);
   write_string (stream, mnt->mnt_type);
   write_string (stream, mnt->mnt_opts);
-  fprintf (stream, "%d %d\n", mnt->mnt_freq, mnt->mnt_passno);
+  __fprintf (stream, "%d %d\n", mnt->mnt_freq, mnt->mnt_passno);
 
   ret = __ferror_unlocked (stream) != 0 || fflush (stream) != 0;
 
diff --git a/misc/sys/cdefs.h b/misc/sys/cdefs.h
index 44d3826b..cc4b991e 100644
--- a/misc/sys/cdefs.h
+++ b/misc/sys/cdefs.h
@@ -560,70 +560,71 @@
 # include <bits/long-double.h>
 #endif
 
-#if __LDOUBLE_REDIRECTS_TO_FLOAT128_ABI == 1
-# ifdef __REDIRECT
-
-/* Alias name defined automatically.  */
-#  define __LDBL_REDIR(name, proto) ... unused__ldbl_redir
-#  define __LDBL_REDIR_DECL(name) \
-  extern __typeof (name) name __asm (__ASMNAME ("__" #name "ieee128"));
-
-/* Alias name defined automatically, with leading underscores.  */
-#  define __LDBL_REDIR2_DECL(name) \
-  extern __typeof (__##name) __##name \
-    __asm (__ASMNAME ("__" #name "ieee128"));
-
-/* Alias name defined manually.  */
-#  define __LDBL_REDIR1(name, proto, alias) ... unused__ldbl_redir1
-#  define __LDBL_REDIR1_DECL(name, alias) \
-  extern __typeof (name) name __asm (__ASMNAME (#alias));
-
-#  define __LDBL_REDIR1_NTH(name, proto, alias) \
-  __REDIRECT_NTH (name, proto, alias)
-#  define __REDIRECT_NTH_LDBL(name, proto, alias) \
-  __LDBL_REDIR1_NTH (name, proto, __##alias##ieee128)
-
-/* Unused.  */
-#  define __REDIRECT_LDBL(name, proto, alias) ... unused__redirect_ldbl
-#  define __LDBL_REDIR_NTH(name, proto) ... unused__ldbl_redir_nth
-
-# else
+#if (defined __GNUC__ && __GNUC__ >= 2) || (__clang_major__ >= 4)
+# define __REDIRECT_LDBL1(name, prenth, posnth, proto, alias) \
+    name proto prenth __asm__ (__ASMNAME (__ASMNAME (#alias))) posnth
+# if __LDOUBLE_REDIRECTS_TO_FLOAT128_ABI == 1
+#  ifdef __REDIRECT
+#   define __REDIRECT_LDBL(name, proto, ieee128, compat) \
+      __REDIRECT_LDBL1 (name, , , proto, ieee128)
+#   define __REDIRECT_LDBL128(name, proto) \
+      __REDIRECT_LDBL1 (name, , , proto, __##name##ieee128)
+#   ifdef __cplusplus
+#    define __REDIRECT_LDBL_NTH(name, proto, ieee128, compat) \
+      __REDIRECT_LDBL1 (name, __THROW, , proto, ieee128)
+#    define __REDIRECT_LDBL128_NTH(name, proto) \
+      __REDIRECT_LDBL1 (name, __THROW, , proto, __##name##ieee128)
+#    define __REDIRECT_LDBL_NTHNL(name, proto, ieee128, compat) \
+      __REDIRECT_LDBL1 (name, __THROWNL, , proto, ieee128)
+#    define __REDIRECT_LDBL128_NTHNL(name, proto) \
+      __REDIRECT_LDBL1 (name, __THROWNL, , proto, __##name##ieee128)
+#   else
+#    define __REDIRECT_LDBL_NTH(name, proto, ieee128, compat) \
+      __REDIRECT_LDBL1 (name, , __THROW, proto, ieee128)
+#    define __REDIRECT_LDBL128_NTH(name, proto) \
+      __REDIRECT_LDBL1 (name, , __THROW, proto, __##name##ieee128)
+#    define __REDIRECT_LDBL_NTHNL(name, proto, ieee128, compat) \
+      __REDIRECT_LDBL1 (name, , __THROWNL, proto, ieee128)
+#    define __REDIRECT_LDBL128_NTHNL(name, proto) \
+      __REDIRECT_LDBL1 (name, , __THROWNL, proto, __##name##ieee128)
+#   endif /* __cplusplus */
+#  else
 _Static_assert (0, "IEEE 128-bits long double requires redirection on this platform");
-# endif
-#elif defined __LONG_DOUBLE_MATH_OPTIONAL && defined __NO_LONG_DOUBLE_MATH
-# define __LDBL_COMPAT 1
-# ifdef __REDIRECT
-#  define __LDBL_REDIR1(name, proto, alias) __REDIRECT (name, proto, alias)
-#  define __LDBL_REDIR(name, proto) \
-  __LDBL_REDIR1 (name, proto, __nldbl_##name)
-#  define __LDBL_REDIR1_NTH(name, proto, alias) __REDIRECT_NTH (name, proto, alias)
-#  define __LDBL_REDIR_NTH(name, proto) \
-  __LDBL_REDIR1_NTH (name, proto, __nldbl_##name)
-#  define __LDBL_REDIR2_DECL(name) \
-  extern __typeof (__##name) __##name __asm (__ASMNAME ("__nldbl___" #name));
-#  define __LDBL_REDIR1_DECL(name, alias) \
-  extern __typeof (name) name __asm (__ASMNAME (#alias));
-#  define __LDBL_REDIR_DECL(name) \
-  extern __typeof (name) name __asm (__ASMNAME ("__nldbl_" #name));
-#  define __REDIRECT_LDBL(name, proto, alias) \
-  __LDBL_REDIR1 (name, proto, __nldbl_##alias)
-#  define __REDIRECT_NTH_LDBL(name, proto, alias) \
-  __LDBL_REDIR1_NTH (name, proto, __nldbl_##alias)
+#  endif /* __REDIRECT */
+# elif defined __LONG_DOUBLE_MATH_OPTIONAL && defined __NO_LONG_DOUBLE_MATH
+#  define __LDBL_COMPAT 1
+#  ifdef __REDIRECT
+#   define __REDIRECT_LDBL(name, proto, ieee128, compat) \
+      __REDIRECT_LDBL1 (name, , , proto, compat)
+#   define __REDIRECT_LDBL_COMPAT(name, proto) \
+      __REDIRECT_LDBL1 (name, , , proto, __nldbl_##name)
+#   ifdef __cplusplus
+#    define __REDIRECT_LDBL_NTH(name, proto, ieee128, compat) \
+      __REDIRECT_LDBL1 (name, __THROW, , proto, compat)
+#    define __REDIRECT_LDBL_NTHNL(name, proto, ieee128, compat) \
+      __REDIRECT_LDBL1 (name, __THROWNL, , proto, compat)
+#   else
+#    define __REDIRECT_LDBL_NTH(name, proto, ieee128, compat) \
+      __REDIRECT_LDBL1 (name, , __THROW, proto, compat)
+#    define __REDIRECT_LDBL_NTHNL(name, proto, ieee128, compat) \
+      __REDIRECT_LDBL1 (name, , __THROWNL, proto, compat)
+#   endif /* __cplusplus */
+#  else
+_Static_assert (0, "Compat long double requires redirection on this platform");
+#  endif /* __REDIRECT */
 # endif
 #endif
-#if (!defined __LDBL_COMPAT && __LDOUBLE_REDIRECTS_TO_FLOAT128_ABI == 0) \
-    || !defined __REDIRECT
-# define __LDBL_REDIR1(name, proto, alias) name proto
-# define __LDBL_REDIR(name, proto) name proto
-# define __LDBL_REDIR1_NTH(name, proto, alias) name proto __THROW
-# define __LDBL_REDIR_NTH(name, proto) name proto __THROW
-# define __LDBL_REDIR2_DECL(name)
-# define __LDBL_REDIR_DECL(name)
-# ifdef __REDIRECT
-#  define __REDIRECT_LDBL(name, proto, alias) __REDIRECT (name, proto, alias)
-#  define __REDIRECT_NTH_LDBL(name, proto, alias) \
-  __REDIRECT_NTH (name, proto, alias)
-# endif
+
+#ifndef __REDIRECT_LDBL
+# define __REDIRECT_LDBL(name, proto, ieee128, compat) name proto
+# define __REDIRECT_LDBL_NTH(name, proto, ieee128, compat) name proto __THROW
+# define __REDIRECT_LDBL_NTHNL(name, proto, ieee128, compat) name proto __THROWNL
+# define __REDIRECT_LDBL128(name, proto) name proto
+# define __REDIRECT_LDBL128_NTH(name, proto) name proto __THROW
+# define __REDIRECT_LDBL128_NTHNL(name, proto) name proto __THROWNL
+#endif
+#ifndef __REDIRECT_LDBL_COMPAT
+# define __REDIRECT_LDBL_COMPAT(name, proto)
 #endif
 
 /* __glibc_macro_warning (MESSAGE) issues warning MESSAGE.  This is
@@ -702,4 +703,18 @@ _Static_assert (0, "IEEE 128-bits long double requires redirection on this platf
 # define __attribute_returns_twice__ /* Ignore.  */
 #endif
 
+/*  Prevents a function from being considered for cloning.  */
+#if __GNUC_PREREQ (4, 5) || __glibc_has_attribute (__noclone__)
+# define __attribute_noclone__ __attribute__ ((__noclone__))
+#else
+# define __attribute_noclone__ /* Ignore.  */
+#endif
+
+/* Not all compiles support _Bool type in C++.  */
+#ifdef	__cplusplus
+# define __BOOLEAN bool
+#else
+# define __BOOLEAN _Bool
+#endif
+
 #endif	 /* sys/cdefs.h */
diff --git a/misc/sys/syslog.h b/misc/sys/syslog.h
index dc3b0e7e..4cab0907 100644
--- a/misc/sys/syslog.h
+++ b/misc/sys/syslog.h
@@ -38,6 +38,7 @@
 
 /* This file defines _PATH_LOG.  */
 #include <bits/syslog-path.h>
+#include <bits/floatn.h>
 
 /*
  * priorities/facilities are encoded into a single 32-bit quantity, where the
@@ -187,9 +188,9 @@ extern int setlogmask (int __mask) __THROW;
 
    This function is a possible cancellation point and therefore not
    marked with __THROW.  */
-extern void syslog (int __pri, const char *__fmt, ...)
+extern void __REDIRECT_LDBL (syslog, (int __pri, const char *__fmt, ...),
+			     __syslogieee128, __nldbl_syslog)
      __attribute__ ((__format__ (__printf__, 2, 3)));
-
 #ifdef __USE_MISC
 /* Generate a log message using FMT and using arguments pointed to by AP.
 
@@ -197,21 +198,17 @@ extern void syslog (int __pri, const char *__fmt, ...)
    cancellation point.  But due to similarity with an POSIX interface
    or due to the implementation it is a cancellation point and
    therefore not marked with __THROW.  */
-extern void vsyslog (int __pri, const char *__fmt, __gnuc_va_list __ap)
+extern void __REDIRECT_LDBL (vsyslog, (int __pri, const char *__fmt,
+				       __gnuc_va_list __ap),
+			     __vsyslogieee128, __nldbl_vsyslog)
      __attribute__ ((__format__ (__printf__, 2, 0)));
 #endif
 
-
 /* Define some macros helping to catch buffer overflows.  */
 #if __USE_FORTIFY_LEVEL > 0 && defined __fortify_function
 # include <bits/syslog.h>
 #endif
 
-#include <bits/floatn.h>
-#if defined __LDBL_COMPAT || __LDOUBLE_REDIRECTS_TO_FLOAT128_ABI == 1
-# include <bits/syslog-ldbl.h>
-#endif
-
 __END_DECLS
 
 #endif /* sys/syslog.h */
diff --git a/misc/syslog.c b/misc/syslog.c
index ee83b1bb..58a29214 100644
--- a/misc/syslog.c
+++ b/misc/syslog.c
@@ -53,6 +53,7 @@ static char sccsid[] = "@(#)syslog.c	8.4 (Berkeley) 3/18/94";
 
 #include <stdarg.h>
 
+#include <libc-diag.h>
 #include <libio/libioP.h>
 #include <math_ldbl_opt.h>
 
@@ -109,7 +110,7 @@ __syslog(int pri, const char *fmt, ...)
 	__vsyslog_internal(pri, fmt, ap, 0);
 	va_end(ap);
 }
-ldbl_hidden_def (__syslog, syslog)
+libc_hidden_def (__syslog)
 ldbl_strong_alias (__syslog, syslog)
 
 void
@@ -152,7 +153,7 @@ __vsyslog_internal(int pri, const char *fmt, va_list ap,
 #define	INTERNALLOG	LOG_ERR|LOG_CONS|LOG_PERROR|LOG_PID
 	/* Check for invalid bits. */
 	if (pri & ~(LOG_PRIMASK|LOG_FACMASK)) {
-		syslog(INTERNALLOG,
+		__syslog(INTERNALLOG,
 		    "syslog: unknown facility/priority: %x", pri);
 		pri &= LOG_PRIMASK|LOG_FACMASK;
 	}
diff --git a/misc/tst-atomic.c b/misc/tst-atomic.c
index 6d681a7b..2212ef66 100644
--- a/misc/tst-atomic.c
+++ b/misc/tst-atomic.c
@@ -459,6 +459,7 @@ do_test (void)
       ret = 1;
     }
 
+#ifndef __clang__
   mem = 2;
   if (catomic_exchange_and_add (&mem, 11) != 2
       || mem != 13)
@@ -466,6 +467,7 @@ do_test (void)
       puts ("catomic_exchange_and_add test failed");
       ret = 1;
     }
+#endif
 
   mem = -21;
   catomic_add (&mem, 22);
@@ -483,12 +485,14 @@ do_test (void)
       ret = 1;
     }
 
+#ifndef __clang__
   mem = 2;
   if (catomic_increment_val (&mem) != 3)
     {
       puts ("catomic_increment_val test failed");
       ret = 1;
     }
+#endif
 
   mem = 17;
   catomic_decrement (&mem);
@@ -498,11 +502,13 @@ do_test (void)
       ret = 1;
     }
 
+#ifndef __clang__
   if (catomic_decrement_val (&mem) != 15)
     {
       puts ("catomic_decrement_val test failed");
       ret = 1;
     }
+#endif
 
   /* Tests for C11-like atomics.  */
   mem = 11;
diff --git a/misc/tst-syscalls.c b/misc/tst-syscalls.c
index 09b5128e..08b0cd2e 100644
--- a/misc/tst-syscalls.c
+++ b/misc/tst-syscalls.c
@@ -37,7 +37,7 @@ struct Array
 
 static int error_count;
 
-__attribute__ ((noclone, noinline))
+__attribute__ ((noinline)) __attribute_noclone__
 struct Array
 allocate (size_t bytes)
 {
@@ -52,7 +52,7 @@ allocate (size_t bytes)
   return __extension__ (struct Array) {bytes, p};
 }
 
-__attribute__ ((noclone, noinline))
+__attribute__ ((noinline)) __attribute_noclone__
 void
 deallocate (struct Array b)
 {
@@ -66,7 +66,7 @@ deallocate (struct Array b)
     }
 }
 
-__attribute__ ((noclone, noinline))
+__attribute__ ((noinline)) __attribute_noclone__
 void *
 do_mmap (void *addr, size_t length)
 {
@@ -74,7 +74,7 @@ do_mmap (void *addr, size_t length)
 	       MAP_PRIVATE | MAP_ANON, -1, 0);
 }
 
-__attribute__ ((noclone, noinline))
+__attribute__ ((noinline)) __attribute_noclone__
 void *
 reallocate (struct Array b)
 {
@@ -86,7 +86,7 @@ reallocate (struct Array b)
   return NULL;
 }
 
-__attribute__ ((noclone, noinline))
+__attribute__ ((noinline)) __attribute_noclone__
 void
 protect (struct Array b)
 {
@@ -104,7 +104,7 @@ protect (struct Array b)
     }
 }
 
-__attribute__ ((noclone, noinline))
+__attribute__ ((noinline)) __attribute_noclone__
 ssize_t
 do_read (int fd, void *ptr, struct Array b)
 {
@@ -116,7 +116,7 @@ do_read (int fd, void *ptr, struct Array b)
   return 0;
 }
 
-__attribute__ ((noclone, noinline))
+__attribute__ ((noinline)) __attribute_noclone__
 ssize_t
 do_write (int fd, void *ptr, struct Array b)
 {
diff --git a/nis/nis_print.c b/nis/nis_print.c
index d0efd98e..2708c29e 100644
--- a/nis/nis_print.c
+++ b/nis/nis_print.c
@@ -52,6 +52,32 @@ nis_nstype2str (const nstype type)
     }
 }
 
+static const char *
+nis_objtype (const zotypes type)
+{
+  switch (type)
+    {
+    case NIS_BOGUS_OBJ:
+      return _("BOGUS OBJECT");
+    case NIS_NO_OBJ:
+      return _("NO OBJECT");
+    case NIS_DIRECTORY_OBJ:
+      return _("DIRECTORY");
+    case NIS_GROUP_OBJ:
+      return _("GROUP");
+    case NIS_TABLE_OBJ:
+      return _("TABLE");
+    case NIS_ENTRY_OBJ:
+      return _("ENTRY");
+    case NIS_LINK_OBJ:
+      return _("LINK");
+    case NIS_PRIVATE_OBJ:
+      return _("PRIVATE\n");
+    default:
+      return _("(Unknown object");
+    }
+}
+
 static void
 print_ttl (const uint32_t ttl)
 {
@@ -103,36 +129,7 @@ print_flags (const unsigned int flags)
 static void
 nis_print_objtype (enum zotypes type)
 {
-  switch (type)
-    {
-    case NIS_BOGUS_OBJ:
-      fputs (_("BOGUS OBJECT\n"), stdout);
-      break;
-    case NIS_NO_OBJ:
-      fputs (_("NO OBJECT\n"), stdout);
-      break;
-    case NIS_DIRECTORY_OBJ:
-      fputs (_("DIRECTORY\n"), stdout);
-      break;
-    case NIS_GROUP_OBJ:
-      fputs (_("GROUP\n"), stdout);
-      break;
-    case NIS_TABLE_OBJ:
-      fputs (_("TABLE\n"), stdout);
-      break;
-    case NIS_ENTRY_OBJ:
-      fputs (_("ENTRY\n"), stdout);
-      break;
-    case NIS_LINK_OBJ:
-      fputs (_("LINK\n"), stdout);
-      break;
-    case NIS_PRIVATE_OBJ:
-      fputs (_("PRIVATE\n"), stdout);
-      break;
-    default:
-      fputs (_("(Unknown object)\n"), stdout);
-      break;
-    }
+  printf ("%s\n", nis_objtype (type));
 }
 
 void
@@ -236,7 +233,7 @@ nis_print_directory (const directory_obj *dir)
       for (i = 0; i < dir->do_armask.do_armask_len; i++)
 	{
 	  nis_print_rights (ptr->oa_rights);
-	  printf (_("\tType         : %s\n"), nis_nstype2str (ptr->oa_otype));
+	  printf (_("\tType         : %s\n"), nis_objtype (ptr->oa_otype));
 	  fputs (_("\tAccess rights: "), stdout);
 	  nis_print_rights (ptr->oa_rights);
 	  fputs ("\n", stdout);
diff --git a/nis/nis_subr.c b/nis/nis_subr.c
index 385f2210..0e02cd19 100644
--- a/nis/nis_subr.c
+++ b/nis/nis_subr.c
@@ -280,10 +280,10 @@ nis_getnames (const_nis_name name)
     }
 
   if (pos == 0
-      && __asprintf (&getnames[pos++], "%s%s%s%s",
-		     name, name[name_len - 1] == '.' ? "" : ".",
-		     local_domain,
-		     local_domain[local_domain_len - 1] == '.' ? "" : ".") < 0)
+      && asprintf (&getnames[pos++], "%s%s%s%s",
+		   name, name[name_len - 1] == '.' ? "" : ".",
+		   local_domain,
+		   local_domain[local_domain_len - 1] == '.' ? "" : ".") < 0)
     goto free_null;
 
   getnames[pos] = NULL;
diff --git a/nis/nis_table.c b/nis/nis_table.c
index 31e76313..0effc51d 100644
--- a/nis/nis_table.c
+++ b/nis/nis_table.c
@@ -180,7 +180,7 @@ __follow_path (char **tablepath, char **tableptr, struct ib_request *ibreq,
   /* Since tableptr is only set here, and it's set when tablepath is NULL,
      which it is initially defined as, we know it will always be set here.  */
   DIAG_PUSH_NEEDS_COMMENT;
-  DIAG_IGNORE_NEEDS_COMMENT (4.7, "-Wmaybe-uninitialized");
+  DIAG_IGNORE_NEEDS_COMMENT_GCC (4.7, "-Wmaybe-uninitialized");
 
   if (*tableptr == NULL)
     return NIS_NOTFOUND;
diff --git a/nptl/Makefile b/nptl/Makefile
index b5856639..dbbe0ae7 100644
--- a/nptl/Makefile
+++ b/nptl/Makefile
@@ -387,7 +387,7 @@ tests += tst-cancelx7 tst-cancelx17
 ifeq ($(build-shared),yes)
 tests += tst-compat-forwarder tst-audit-threads
 tests-internal += tst-tls3 tst-tls3-malloc tst-tls5 tst-stackguard1
-ifeq ($(have-z-execstack),yes)
+ifeq ($(have-z-execstack)$(have-cc-trampoline),yesyes)
 tests += tst-execstack
 endif
 endif
@@ -395,9 +395,11 @@ endif
 modules-names = tst-tls3mod \
 		tst-tls5mod tst-tls5moda tst-tls5modb tst-tls5modc \
 		tst-tls5modd tst-tls5mode tst-tls5modf tst-stack4mod \
-		tst-execstack-mod \
 		tst-compat-forwarder-mod tst-audit-threads-mod1 \
 		tst-audit-threads-mod2
+ifeq ($(have-z-execstack)$(have-cc-trampoline),yesyes)
+modules-names += tst-execstack-mod
+endif
 extra-test-objs += $(addsuffix .os,$(strip $(modules-names))) \
 		   tst-cleanup4aux.o tst-cleanupx4aux.o
 test-extras += tst-cleanup4aux tst-cleanupx4aux
diff --git a/nptl/pthread_create.c b/nptl/pthread_create.c
index e7a099ac..b6613d0d 100644
--- a/nptl/pthread_create.c
+++ b/nptl/pthread_create.c
@@ -45,8 +45,7 @@
 
 
 /* Globally enabled events.  */
-td_thr_events_t __nptl_threads_events;
-libc_hidden_proto (__nptl_threads_events)
+td_thr_events_t hidden_proto3 (__nptl_threads_events, );
 libc_hidden_data_def (__nptl_threads_events)
 
 /* Pointer to descriptor with the last event.  */
diff --git a/nptl/pthread_getattr_np.c b/nptl/pthread_getattr_np.c
index 9c5b73b4..6fd2d1be 100644
--- a/nptl/pthread_getattr_np.c
+++ b/nptl/pthread_getattr_np.c
@@ -117,7 +117,7 @@ __pthread_getattr_np (pthread_t thread_id, pthread_attr_t *attr)
 	      uintptr_t last_to = 0;
 #endif
 
-	      while (! feof_unlocked (fp))
+	      while (! __feof_unlocked (fp))
 		{
 		  if (__getline (&line, &linelen, fp) <= 0)
 		    break;
diff --git a/nptl/pthread_getcpuclockid.c b/nptl/pthread_getcpuclockid.c
index 344bd656..b8bf09f5 100644
--- a/nptl/pthread_getcpuclockid.c
+++ b/nptl/pthread_getcpuclockid.c
@@ -35,7 +35,7 @@ __pthread_getcpuclockid (pthread_t threadid, clockid_t *clockid)
 
   /* The clockid_t value is a simple computation from the TID.  */
 
-  const clockid_t tidclock = MAKE_THREAD_CPUCLOCK (pd->tid, CPUCLOCK_SCHED);
+  const clockid_t tidclock = make_thread_cpuclock (pd->tid, CPUCLOCK_SCHED);
 
   *clockid = tidclock;
   return 0;
diff --git a/nptl/pthread_getname.c b/nptl/pthread_getname.c
index ebec06e2..a424b3e4 100644
--- a/nptl/pthread_getname.c
+++ b/nptl/pthread_getname.c
@@ -42,7 +42,7 @@ __pthread_getname_np (pthread_t th, char *buf, size_t len)
 
 #define FMT "/proc/self/task/%u/comm"
   char fname[sizeof (FMT) + 8];
-  sprintf (fname, FMT, (unsigned int) pd->tid);
+  __sprintf (fname, FMT, (unsigned int) pd->tid);
 
   int fd = __open64_nocancel (fname, O_RDONLY);
   if (fd == -1)
diff --git a/nptl/pthread_join_common.c b/nptl/pthread_join_common.c
index a8e884f3..e6bc4b73 100644
--- a/nptl/pthread_join_common.c
+++ b/nptl/pthread_join_common.c
@@ -29,7 +29,7 @@ cleanup (void *arg)
      fail for any reason but the thread not having done that yet so
      there is no reason for a loop.  */
   struct pthread *self = THREAD_SELF;
-  atomic_compare_exchange_weak_acquire (&arg, &self, NULL);
+  atomic_compare_exchange_weak_acquire (&arg, (void **) &self, NULL);
 }
 
 int
diff --git a/nptl/pthread_setname.c b/nptl/pthread_setname.c
index f24560db..8520bac4 100644
--- a/nptl/pthread_setname.c
+++ b/nptl/pthread_setname.c
@@ -44,7 +44,7 @@ __pthread_setname_np (pthread_t th, const char *name)
 
 #define FMT "/proc/self/task/%u/comm"
   char fname[sizeof (FMT) + 8];
-  sprintf (fname, FMT, (unsigned int) pd->tid);
+  __sprintf (fname, FMT, (unsigned int) pd->tid);
 
   int fd = __open64_nocancel (fname, O_RDWR);
   if (fd == -1)
diff --git a/nptl/tst-minstack-throw.cc b/nptl/tst-minstack-throw.cc
index d2f020a9..4c69289c 100644
--- a/nptl/tst-minstack-throw.cc
+++ b/nptl/tst-minstack-throw.cc
@@ -24,7 +24,7 @@
 #include <support/xthread.h>
 
 /* Throw a std::runtime_exception.  */
-__attribute__ ((noinline, noclone, weak))
+__attribute__ ((noinline, weak)) __attribute_noclone__
 void
 do_throw_exception ()
 {
@@ -38,17 +38,17 @@ struct class_with_destructor
   ~class_with_destructor ();
 };
 
-__attribute__ ((noinline, noclone, weak))
+__attribute__ ((noinline, weak)) __attribute_noclone__
 class_with_destructor::class_with_destructor ()
 {
 }
 
-__attribute__ ((noinline, noclone, weak))
+__attribute__ ((noinline, weak)) __attribute_noclone__
 class_with_destructor::~class_with_destructor ()
 {
 }
 
-__attribute__ ((noinline, noclone, weak))
+__attribute__ ((noinline, weak)) __attribute_noclone__
 void
 function_with_destructed_object ()
 {
diff --git a/nptl/tst-rwlock6.c b/nptl/tst-rwlock6.c
index 8294868f..acf36098 100644
--- a/nptl/tst-rwlock6.c
+++ b/nptl/tst-rwlock6.c
@@ -104,16 +104,16 @@ do_test_clock (clockid_t clockid, const char *fnname)
       pthread_rwlockattr_t a;
 
       if (pthread_rwlockattr_init (&a) != 0)
-        FAIL_EXIT1 ("round %Zu: rwlockattr_t failed\n", cnt);
+        FAIL_EXIT1 ("round %zu: rwlockattr_t failed\n", cnt);
 
       if (pthread_rwlockattr_setkind_np (&a, kind[cnt]) != 0)
-        FAIL_EXIT1 ("round %Zu: rwlockattr_setkind failed\n", cnt);
+        FAIL_EXIT1 ("round %zu: rwlockattr_setkind failed\n", cnt);
 
       if (pthread_rwlock_init (&r, &a) != 0)
-        FAIL_EXIT1 ("round %Zu: rwlock_init failed\n", cnt);
+        FAIL_EXIT1 ("round %zu: rwlock_init failed\n", cnt);
 
       if (pthread_rwlockattr_destroy (&a) != 0)
-        FAIL_EXIT1 ("round %Zu: rwlockattr_destroy failed\n", cnt);
+        FAIL_EXIT1 ("round %zu: rwlockattr_destroy failed\n", cnt);
 
       struct timespec ts;
       xclock_gettime (clockid_for_get, &ts);
@@ -124,7 +124,7 @@ do_test_clock (clockid_t clockid, const char *fnname)
 	? pthread_rwlock_timedwrlock (&r, &ts)
 	: pthread_rwlock_clockwrlock (&r, clockid, &ts);
       if (e != 0)
-        FAIL_EXIT1 ("round %Zu: %swrlock failed (%d)\n",
+        FAIL_EXIT1 ("round %zu: %swrlock failed (%d)\n",
                     cnt, fnname, e);
 
       verbose_printf ("1st %swrlock done\n", fnname);
@@ -160,7 +160,7 @@ do_test_clock (clockid_t clockid, const char *fnname)
       puts ("joined thread");
 
       if (pthread_rwlock_destroy (&r) != 0)
-        FAIL_EXIT1 ("round %Zu: rwlock_destroy failed\n", cnt);
+        FAIL_EXIT1 ("round %zu: rwlock_destroy failed\n", cnt);
     }
 
   return 0;
diff --git a/nptl/tst-rwlock7.c b/nptl/tst-rwlock7.c
index a228009a..7427bf8e 100644
--- a/nptl/tst-rwlock7.c
+++ b/nptl/tst-rwlock7.c
@@ -100,16 +100,16 @@ do_test_clock (clockid_t clockid, const char *fnname)
       pthread_rwlockattr_t a;
 
       if (pthread_rwlockattr_init (&a) != 0)
-        FAIL_EXIT1 ("round %Zu: rwlockattr_t failed\n", cnt);
+        FAIL_EXIT1 ("round %zu: rwlockattr_t failed\n", cnt);
 
       if (pthread_rwlockattr_setkind_np (&a, kind[cnt]) != 0)
-        FAIL_EXIT1 ("round %Zu: rwlockattr_setkind failed\n", cnt);
+        FAIL_EXIT1 ("round %zu: rwlockattr_setkind failed\n", cnt);
 
       if (pthread_rwlock_init (&r, &a) != 0)
-        FAIL_EXIT1 ("round %Zu: rwlock_init failed\n", cnt);
+        FAIL_EXIT1 ("round %zu: rwlock_init failed\n", cnt);
 
       if (pthread_rwlockattr_destroy (&a) != 0)
-        FAIL_EXIT1 ("round %Zu: rwlockattr_destroy failed\n", cnt);
+        FAIL_EXIT1 ("round %zu: rwlockattr_destroy failed\n", cnt);
 
       struct timespec ts;
       xclock_gettime (clockid_for_get, &ts);
@@ -119,10 +119,10 @@ do_test_clock (clockid_t clockid, const char *fnname)
       /* Get a read lock.  */
       if (clockid == CLOCK_USE_TIMEDLOCK) {
         if (pthread_rwlock_timedrdlock (&r, &ts) != 0)
-          FAIL_EXIT1 ("round %Zu: rwlock_timedrdlock failed\n", cnt);
+          FAIL_EXIT1 ("round %zu: rwlock_timedrdlock failed\n", cnt);
       } else {
         if (pthread_rwlock_clockrdlock (&r, clockid, &ts) != 0)
-          FAIL_EXIT1 ("round %Zu: rwlock_%srdlock failed\n", cnt, fnname);
+          FAIL_EXIT1 ("round %zu: rwlock_%srdlock failed\n", cnt, fnname);
       }
 
       printf ("%zu: got %srdlock\n", cnt, fnname);
@@ -134,10 +134,10 @@ do_test_clock (clockid_t clockid, const char *fnname)
       pthread_t th = xpthread_create (NULL, tf, &args);
       void *status = xpthread_join (th);
       if (status != NULL)
-        FAIL_EXIT1 ("failure in round %Zu\n", cnt);
+        FAIL_EXIT1 ("failure in round %zu\n", cnt);
 
       if (pthread_rwlock_destroy (&r) != 0)
-        FAIL_EXIT1 ("round %Zu: rwlock_destroy failed\n", cnt);
+        FAIL_EXIT1 ("round %zu: rwlock_destroy failed\n", cnt);
     }
 
   return 0;
diff --git a/nptl/tst-stackguard1.c b/nptl/tst-stackguard1.c
index 3460c018..060c2fb2 100644
--- a/nptl/tst-stackguard1.c
+++ b/nptl/tst-stackguard1.c
@@ -24,6 +24,8 @@
 #include <string.h>
 #include <sys/wait.h>
 #include <stackguard-macros.h>
+#undef attribute_relro
+#define attribute_relro
 #include <tls.h>
 #include <unistd.h>
 
diff --git a/nptl/tst-thread-exit-clobber.cc b/nptl/tst-thread-exit-clobber.cc
index f9f4e1fc..88f2451f 100644
--- a/nptl/tst-thread-exit-clobber.cc
+++ b/nptl/tst-thread-exit-clobber.cc
@@ -73,7 +73,7 @@ enum { no_check = -1 };
 
 /* Check that VALUE is the magic value for INDEX, behind a compiler
    barrier.  */
-__attribute__ ((noinline, noclone, weak))
+__attribute__ ((noinline, weak)) __attribute_noclone__
 void
 check_magic (int index, unsigned int value)
 {
@@ -103,7 +103,7 @@ check_magic (int index, unsigned int value)
 
 /* Check that VALUE is the magic value for INDEX, behind a compiler
    barrier.  Double variant.  */
-__attribute__ ((noinline, noclone, weak))
+__attribute__ ((noinline, weak)) __attribute_noclone__
 void
 check_magic (int index, double value)
 {
@@ -153,7 +153,7 @@ struct checker
    call_pthread_exit are used to call pthread_exit indirectly, with
    the intent of clobbering the register values.  */
 
-__attribute__ ((noinline, noclone, weak))
+__attribute__ ((noinline, weak)) __attribute_noclone__
 void
 call_pthread_exit_0 (const values<unsigned int> *pvalues)
 {
@@ -166,7 +166,7 @@ call_pthread_exit_0 (const values<unsigned int> *pvalues)
   pthread_exit (NULL);
 }
 
-__attribute__ ((noinline, noclone, weak))
+__attribute__ ((noinline, weak)) __attribute_noclone__
 void
 call_pthread_exit_1 (const values<double> *pvalues)
 {
@@ -180,7 +180,7 @@ call_pthread_exit_1 (const values<double> *pvalues)
   call_pthread_exit_0 (&other_values);
 }
 
-__attribute__ ((noinline, noclone, weak))
+__attribute__ ((noinline, weak)) __attribute_noclone__
 void
 call_pthread_exit ()
 {
@@ -192,7 +192,7 @@ call_pthread_exit ()
    pthread_exit.  If Nested is true, call pthread_exit indirectly via
    call_pthread_exit.  */
 template <class T, bool Nested>
-__attribute__ ((noinline, noclone, weak))
+__attribute__ ((noinline, weak)) __attribute_noclone__
 void *
 threadfunc (void *closure)
 {
diff --git a/nptl/tst-thread-setspecific.c b/nptl/tst-thread-setspecific.c
index 8f25c6f7..db26f7a0 100644
--- a/nptl/tst-thread-setspecific.c
+++ b/nptl/tst-thread-setspecific.c
@@ -24,7 +24,9 @@
    See BZ #27714.  */
 
 #pragma GCC diagnostic push
+#if !defined(__clang__)
 #pragma GCC diagnostic error "-Wmaybe-uninitialized"
+#endif
 #pragma GCC diagnostic error "-Wuninitialized"
 
 int do_test (void)
diff --git a/nptl/tst-thread_local1.cc b/nptl/tst-thread_local1.cc
index 67e696b5..07538591 100644
--- a/nptl/tst-thread_local1.cc
+++ b/nptl/tst-thread_local1.cc
@@ -53,27 +53,27 @@ to_string (const counter &c)
 template <counter *Counter>
 struct counting
 {
-  counting () __attribute__ ((noinline, noclone));
-  ~counting () __attribute__ ((noinline, noclone));
-  void operation () __attribute__ ((noinline, noclone));
+  counting () __attribute__ ((noinline)) __attribute_noclone__;
+  ~counting () __attribute__ ((noinline)) __attribute_noclone__;
+  void operation () __attribute__ ((noinline)) __attribute_noclone__;
 };
 
 template<counter *Counter>
-__attribute__ ((noinline, noclone))
+__attribute__ ((noinline)) __attribute_noclone__
 counting<Counter>::counting ()
 {
   ++Counter->constructed;
 }
 
 template<counter *Counter>
-__attribute__ ((noinline, noclone))
+__attribute__ ((noinline)) __attribute_noclone__
 counting<Counter>::~counting ()
 {
   ++Counter->destructed;
 }
 
 template<counter *Counter>
-void __attribute__ ((noinline, noclone))
+void __attribute__ ((noinline)) __attribute_noclone__
 counting<Counter>::operation ()
 {
   // Optimization barrier.
diff --git a/nscd/mem.c b/nscd/mem.c
index 4523f822..66aa53ea 100644
--- a/nscd/mem.c
+++ b/nscd/mem.c
@@ -218,12 +218,8 @@ gc (struct database_dyn *db)
 
   /* Determine the highest offset.  */
   BITMAP_T mask = HIGHBIT;
-  ref_t highref = (high * BITS - 1) * BLOCK_ALIGN;
   while ((mark[high - 1] & mask) == 0)
-    {
-      mask >>= 1;
-      highref -= BLOCK_ALIGN;
-    }
+    mask >>= 1;
 
   /* Now we can iterate over the MARK array and find bits which are not
      set.  These represent memory which can be recovered.  */
diff --git a/nss/nss_files/files-parse.c b/nss/nss_files/files-parse.c
index c90e2938..bd326670 100644
--- a/nss/nss_files/files-parse.c
+++ b/nss/nss_files/files-parse.c
@@ -53,6 +53,10 @@
 # define STRUCTURE ENTNAME
 #endif
 
+#if IS_IN(libc)
+# define strtoul __strtoul
+#endif
+
 
 struct parser_data
   {
diff --git a/nss/nss_module.c b/nss/nss_module.c
index f9a1263e..d2e5b7b8 100644
--- a/nss/nss_module.c
+++ b/nss/nss_module.c
@@ -33,6 +33,7 @@
 #include <stdlib.h>
 #include <string.h>
 #include <sysdep.h>
+#include <libc-diag.h>
 
 /* Suffix after .so of NSS service modules.  This is a bit of magic,
    but we assume LIBNSS_FILES_SO looks like "libnss_files.so.2" and we
@@ -40,8 +41,14 @@
    except through the auto-generated lib-names.h and some static
    pointer manipulation.  The "-1" accounts for the trailing NUL
    included in the sizeof.  */
+
+/* clang issues an warning adding 'unsigned long' to a string does not append
+   to the string, however it is exactly what code means here.  */
+DIAG_PUSH_NEEDS_COMMENT_CLANG;
+DIAG_IGNORE_NEEDS_COMMENT_CLANG (13, "-Wstring-plus-int");
 static const char *const __nss_shlib_revision
 	= LIBNSS_FILES_SO + sizeof("libnss_files.so") - 1;
+DIAG_POP_NEEDS_COMMENT_CLANG;
 
 /* A single-linked list used to implement a mapping from service names
    to NSS modules.  (Most systems only use five or so modules, so a
diff --git a/posix/Makefile b/posix/Makefile
index 9b30b53a..695e8a0a 100644
--- a/posix/Makefile
+++ b/posix/Makefile
@@ -248,9 +248,9 @@ $(objpfx)config-name.h: $(..)scripts/config-uname.sh $(common-objpfx)config.make
 CFLAGS-getaddrinfo.c += -DRESOLVER -fexceptions
 CFLAGS-pause.c += -fexceptions -fasynchronous-unwind-tables
 CFLAGS-pread.c += -fexceptions -fasynchronous-unwind-tables
-CFLAGS-pread64.c += -fexceptions -fasynchronous-unwind-tables
+CFLAGS-pread64.c += -fexceptions -fasynchronous-unwind-tables $(config-cflags-wno-ignored-attributes)
 CFLAGS-pwrite.c += -fexceptions -fasynchronous-unwind-tables
-CFLAGS-pwrite64.c += -fexceptions -fasynchronous-unwind-tables
+CFLAGS-pwrite64.c += -fexceptions -fasynchronous-unwind-tables $(config-cflags-wno-ignored-attributes)
 CFLAGS-sleep.c += -fexceptions
 CFLAGS-wait.c += -fexceptions -fasynchronous-unwind-tables
 CFLAGS-waitid.c += -fexceptions -fasynchronous-unwind-tables
@@ -279,7 +279,7 @@ CFLAGS-execl.os = -fomit-frame-pointer
 CFLAGS-execvp.os = -fomit-frame-pointer
 CFLAGS-execlp.os = -fomit-frame-pointer
 CFLAGS-nanosleep.c += -fexceptions -fasynchronous-unwind-tables
-CFLAGS-fork.c = $(libio-mtsafe)
+CFLAGS-fork.c = $(libio-mtsafe) $(config-cflags-wno-ignored-attributes)
 
 tstgetopt-ARGS = -a -b -cfoobar --required foobar --optional=bazbug \
 		--none random --col --color --colour
diff --git a/posix/bug-regex24.c b/posix/bug-regex24.c
index 97c5c350..7a655cbc 100644
--- a/posix/bug-regex24.c
+++ b/posix/bug-regex24.c
@@ -1,6 +1,7 @@
 #include <regex.h>
 #include <stdio.h>
 #include <string.h>
+#include <libc-diag.h>
 
 #define str "civic"
 
@@ -45,11 +46,17 @@ do_test (void)
       {
 	int len = m[i].rm_eo - m[i].rm_so;
 
+	/* clang complains that adding a 'regoff_t' to a string does not
+	   append to it, and the printf idea below is to make rm_so as
+	   an offset to str.  */
+	DIAG_PUSH_NEEDS_COMMENT_CLANG;
+	DIAG_IGNORE_NEEDS_COMMENT_CLANG (13, "-Wstring-plus-int");
 	printf ("m[%d] = \"%.*s\"\n", i, len, str + m[i].rm_so);
 
 	if (strlen (expected[i]) != len
 	    || memcmp (expected[i], str + m[i].rm_so, len) != 0)
 	  result = 1;
+	DIAG_POP_NEEDS_COMMENT_CLANG;
       }
 
   return result;
diff --git a/posix/confstr.c b/posix/confstr.c
index 6e3c2644..cfaab1cf 100644
--- a/posix/confstr.c
+++ b/posix/confstr.c
@@ -290,5 +290,4 @@ __confstr (int name, char *buf, size_t len)
   return string_len;
 }
 libc_hidden_def (__confstr)
-libc_hidden_def (confstr)
 weak_alias (__confstr, confstr)
diff --git a/posix/runptests.c b/posix/runptests.c
index ded47324..6dfd3a4a 100644
--- a/posix/runptests.c
+++ b/posix/runptests.c
@@ -115,7 +115,7 @@ main (int argc, char *argv[])
 	regfree (&re);
       }
 
-  printf ("\n%Zu tests, %d errors\n", cnt, errors);
+  printf ("\n%zu tests, %d errors\n", cnt, errors);
 
   return errors != 0;
 }
diff --git a/posix/wordexp-test.c b/posix/wordexp-test.c
index 0a36e0a7..e330a0c3 100644
--- a/posix/wordexp-test.c
+++ b/posix/wordexp-test.c
@@ -413,11 +413,11 @@ testit (struct test_case_struct *tc)
   if (bzzzt)
     {
       printf ("FAILED\n");
-      printf ("info: Test words: <%s>, need retval %d, wordc %Zd\n",
+      printf ("info: Test words: <%s>, need retval %d, wordc %zd\n",
 	      tc->words, tc->retval, tc->wordc);
       if (start_offs != 0)
 	printf ("(preceded by %d NULLs)\n", start_offs);
-      printf ("Got retval %d, wordc %Zd: ", retval, we.we_wordc);
+      printf ("Got retval %d, wordc %zd: ", retval, we.we_wordc);
       if (retval == 0 || retval == WRDE_NOSPACE)
 	{
 	  for (i = 0; i < we.we_wordc + start_offs; ++i)
diff --git a/posix/wordexp.c b/posix/wordexp.c
index d4cb9c73..7bec5a73 100644
--- a/posix/wordexp.c
+++ b/posix/wordexp.c
@@ -564,7 +564,7 @@ eval_expr_val (char **expr, long int *result)
 
   /* POSIX requires that decimal, octal, and hexadecimal constants are
      recognized.  Therefore we pass 0 as the third parameter to strtol.  */
-  *result = strtol (digit, expr, 0);
+  *result = __strtol (digit, expr, 0);
   if (digit == *expr)
     return WRDE_SYNTAX;
 
@@ -1398,7 +1398,7 @@ envsubst:
   /* Is it a numeric parameter? */
   else if (isdigit (env[0]))
     {
-      unsigned long n = strtoul (env, NULL, 10);
+      unsigned long n = __strtoul (env, NULL, 10);
 
       if (n >= __libc_argc)
 	/* Substitute NULL. */
diff --git a/pwd/getpw.c b/pwd/getpw.c
index 547489a8..4784eaf0 100644
--- a/pwd/getpw.c
+++ b/pwd/getpw.c
@@ -50,9 +50,9 @@ __getpw (__uid_t uid, char *buf)
   if (p == NULL)
     return -1;
 
-  if (sprintf (buf, "%s:%s:%lu:%lu:%s:%s:%s", p->pw_name, p->pw_passwd,
-	       (unsigned long int) p->pw_uid, (unsigned long int) p->pw_gid,
-	       p->pw_gecos, p->pw_dir, p->pw_shell) < 0)
+  if (__sprintf (buf, "%s:%s:%lu:%lu:%s:%s:%s", p->pw_name, p->pw_passwd,
+		 (unsigned long int) p->pw_uid, (unsigned long int) p->pw_gid,
+		 p->pw_gecos, p->pw_dir, p->pw_shell) < 0)
     return -1;
 
   return 0;
diff --git a/pwd/putpwent.c b/pwd/putpwent.c
index e3f2f4e0..480dd598 100644
--- a/pwd/putpwent.c
+++ b/pwd/putpwent.c
@@ -48,11 +48,11 @@ putpwent (const struct passwd *p, FILE *stream)
     return -1;
 
   if (p->pw_name[0] == '+' || p->pw_name[0] == '-')
-      ret = fprintf (stream, "%s:%s:::%s:%s:%s\n",
+      ret = __fprintf (stream, "%s:%s:::%s:%s:%s\n",
 		     p->pw_name, _S (p->pw_passwd),
 		     gecos, _S (p->pw_dir), _S (p->pw_shell));
   else
-      ret = fprintf (stream, "%s:%s:%lu:%lu:%s:%s:%s\n",
+      ret = __fprintf (stream, "%s:%s:%lu:%lu:%s:%s:%s\n",
 		     p->pw_name, _S (p->pw_passwd),
 		     (unsigned long int) p->pw_uid,
 		     (unsigned long int) p->pw_gid,
diff --git a/resolv/Makefile b/resolv/Makefile
index c465479e..09178874 100644
--- a/resolv/Makefile
+++ b/resolv/Makefile
@@ -213,6 +213,7 @@ LOCALES := en_US.UTF-8 en_US.ISO-8859-1
 include ../gen-locales.mk
 
 CFLAGS-res_hconf.c += -fexceptions
+CFLAGS-inet_pton.c += $(config-cflags-wno-ignored-attributes)
 
 # The DNS NSS modules needs the resolver.
 $(objpfx)libnss_dns.so: $(objpfx)libresolv.so
diff --git a/resolv/inet_addr.c b/resolv/inet_addr.c
index 8059a23e..45153189 100644
--- a/resolv/inet_addr.c
+++ b/resolv/inet_addr.c
@@ -130,7 +130,7 @@ inet_aton_end (const char *cp, struct in_addr *addr, const char **endp)
 	goto ret_0;
       {
 	char *endp;
-	unsigned long ul = strtoul (cp, &endp, 0);
+	unsigned long ul = __strtoul (cp, &endp, 0);
 	if (ul == ULONG_MAX && errno == ERANGE)
 	  goto ret_0;
 	if (ul > 0xfffffffful)
diff --git a/resolv/inet_ntop.c b/resolv/inet_ntop.c
index c4d38c0f..53725d80 100644
--- a/resolv/inet_ntop.c
+++ b/resolv/inet_ntop.c
@@ -28,9 +28,9 @@
 #include <string.h>
 
 #ifdef SPRINTF_CHAR
-# define SPRINTF(x) strlen(sprintf/**/x)
+# define SPRINTF(x) strlen(__sprintf/**/x)
 #else
-# define SPRINTF(x) ((size_t)sprintf x)
+# define SPRINTF(x) ((size_t)__sprintf x)
 #endif
 
 /*
diff --git a/resolv/nss_dns/dns-host.c b/resolv/nss_dns/dns-host.c
index 913a5cb8..06a91b23 100644
--- a/resolv/nss_dns/dns-host.c
+++ b/resolv/nss_dns/dns-host.c
@@ -507,8 +507,8 @@ _nss_dns_gethostbyaddr2_r (const void *addr, socklen_t len, int af,
   switch (af)
     {
     case AF_INET:
-      sprintf (qbuf, "%u.%u.%u.%u.in-addr.arpa", (uaddr[3] & 0xff),
-	       (uaddr[2] & 0xff), (uaddr[1] & 0xff), (uaddr[0] & 0xff));
+      __sprintf (qbuf, "%u.%u.%u.%u.in-addr.arpa", (uaddr[3] & 0xff),
+		 (uaddr[2] & 0xff), (uaddr[1] & 0xff), (uaddr[0] & 0xff));
       break;
     case AF_INET6:
       qp = qbuf;
diff --git a/resolv/nss_dns/dns-network.c b/resolv/nss_dns/dns-network.c
index 09cd9174..304ae35b 100644
--- a/resolv/nss_dns/dns-network.c
+++ b/resolv/nss_dns/dns-network.c
@@ -191,21 +191,21 @@ _nss_dns_getnetbyaddr_r (uint32_t net, int type, struct netent *result,
     {
     case 3:
       /* Class A network.  */
-      sprintf (qbuf, "0.0.0.%u.in-addr.arpa", net_bytes[3]);
+      __sprintf (qbuf, "0.0.0.%u.in-addr.arpa", net_bytes[3]);
       break;
     case 2:
       /* Class B network.  */
-      sprintf (qbuf, "0.0.%u.%u.in-addr.arpa", net_bytes[3], net_bytes[2]);
+      __sprintf (qbuf, "0.0.%u.%u.in-addr.arpa", net_bytes[3], net_bytes[2]);
       break;
     case 1:
       /* Class C network.  */
-      sprintf (qbuf, "0.%u.%u.%u.in-addr.arpa", net_bytes[3], net_bytes[2],
-	       net_bytes[1]);
+      __sprintf (qbuf, "0.%u.%u.%u.in-addr.arpa", net_bytes[3], net_bytes[2],
+		 net_bytes[1]);
       break;
     case 0:
       /* Class D - E network.  */
-      sprintf (qbuf, "%u.%u.%u.%u.in-addr.arpa", net_bytes[3], net_bytes[2],
-	       net_bytes[1], net_bytes[0]);
+      __sprintf (qbuf, "%u.%u.%u.%u.in-addr.arpa", net_bytes[3], net_bytes[2],
+		 net_bytes[1], net_bytes[0]);
       break;
     }
 
diff --git a/resolv/res_init.c b/resolv/res_init.c
index cbc16ba0..a6d53648 100644
--- a/resolv/res_init.c
+++ b/resolv/res_init.c
@@ -654,7 +654,7 @@ res_setoptions (struct resolv_conf_parser *parser, const char *options)
       /* Search for and process individual options.  */
       if (!strncmp (cp, "ndots:", sizeof ("ndots:") - 1))
         {
-          int i = atoi (cp + sizeof ("ndots:") - 1);
+	  int i = (int) __strtol (cp + sizeof ("ndots:") - 1, NULL, 10);
           if (i <= RES_MAXNDOTS)
             parser->template.ndots = i;
           else
@@ -662,7 +662,7 @@ res_setoptions (struct resolv_conf_parser *parser, const char *options)
         }
       else if (!strncmp (cp, "timeout:", sizeof ("timeout:") - 1))
         {
-          int i = atoi (cp + sizeof ("timeout:") - 1);
+	  int i = (int) __strtol (cp + sizeof ("timeout:") - 1, NULL, 10);
           if (i <= RES_MAXRETRANS)
             parser->template.retrans = i;
           else
@@ -670,7 +670,7 @@ res_setoptions (struct resolv_conf_parser *parser, const char *options)
         }
       else if (!strncmp (cp, "attempts:", sizeof ("attempts:") - 1))
         {
-          int i = atoi (cp + sizeof ("attempts:") - 1);
+	  int i = (int) __strtol (cp + sizeof ("attempts:") - 1, NULL, 10);
           if (i <= RES_MAXRETRY)
             parser->template.retry = i;
           else
diff --git a/resolv/res_send.c b/resolv/res_send.c
index 5d6be4b8..ae8ca3bb 100644
--- a/resolv/res_send.c
+++ b/resolv/res_send.c
@@ -266,7 +266,7 @@ __res_context_send (struct resolv_context *ctx,
 	   Here the variable n is set to the return value of send_vc.
 	   See below.  */
 	DIAG_PUSH_NEEDS_COMMENT;
-	DIAG_IGNORE_NEEDS_COMMENT (9, "-Wmaybe-uninitialized");
+	DIAG_IGNORE_NEEDS_COMMENT_GCC (9, "-Wmaybe-uninitialized");
 	int n;
 	DIAG_POP_NEEDS_COMMENT;
 
@@ -364,7 +364,7 @@ __res_context_send (struct resolv_context *ctx,
 				return (-1);
 			/* See comment at the declaration of n.  */
 			DIAG_PUSH_NEEDS_COMMENT;
-			DIAG_IGNORE_NEEDS_COMMENT (9, "-Wmaybe-uninitialized");
+			DIAG_IGNORE_NEEDS_COMMENT_GCC (9, "-Wmaybe-uninitialized");
 			if (n == 0 && (buf2 == NULL || *resplen2 == 0))
 				goto next_ns;
 			DIAG_POP_NEEDS_COMMENT;
@@ -388,7 +388,7 @@ __res_context_send (struct resolv_context *ctx,
 
 		/* See comment at the declaration of n.  Note: resplen = n;  */
 		DIAG_PUSH_NEEDS_COMMENT;
-		DIAG_IGNORE_NEEDS_COMMENT (9, "-Wmaybe-uninitialized");
+		DIAG_IGNORE_NEEDS_COMMENT_GCC (9, "-Wmaybe-uninitialized");
 		/* Mask the AD bit in both responses unless it is
 		   marked trusted.  */
 		if (resplen > HFIXEDSZ)
@@ -575,7 +575,7 @@ send_vc(res_state statp,
 	   a false-positive.
 	 */
 	DIAG_PUSH_NEEDS_COMMENT;
-	DIAG_IGNORE_NEEDS_COMMENT (5, "-Wmaybe-uninitialized");
+	DIAG_IGNORE_NEEDS_COMMENT_GCC (5, "-Wmaybe-uninitialized");
 	int resplen;
 	DIAG_POP_NEEDS_COMMENT;
 	struct iovec iov[4];
@@ -847,7 +847,7 @@ reopen (res_state statp, int *terrno, int ns)
 		   the function return -1 before control flow reaches
 		   the call to connect with slen.  */
 		DIAG_PUSH_NEEDS_COMMENT;
-		DIAG_IGNORE_Os_NEEDS_COMMENT (5, "-Wmaybe-uninitialized");
+		DIAG_IGNORE_NEEDS_COMMENT_GCC (5, "-Wmaybe-uninitialized");
 		if (__connect (EXT (statp).nssocks[ns], nsap, slen) < 0) {
 		DIAG_POP_NEEDS_COMMENT;
 			__res_iclose(statp, false);
diff --git a/resource/Makefile b/resource/Makefile
index d3d230a5..29056a84 100644
--- a/resource/Makefile
+++ b/resource/Makefile
@@ -28,3 +28,5 @@ routines := getrlimit setrlimit getrlimit64 setrlimit64 getrusage ulimit      \
 tests = tst-getrlimit bug-ulimit1
 
 include ../Rules
+
+CFLAGS-getrlimit64.c += $(config-cflags-wno-ignored-attributes)
diff --git a/rt/tst-aio.c b/rt/tst-aio.c
index 62a1dee7..c7e9cd55 100644
--- a/rt/tst-aio.c
+++ b/rt/tst-aio.c
@@ -274,7 +274,7 @@ do_test (int argc, char *argv[])
   for (cnt = 10; cnt > 0; )
     if (aio_cancel (fd, cbp[--cnt]) == -1)
       /* This is not an error.  The request can simply be finished.  */
-      printf ("aio_cancel (fd, cbp[%Zd]) cannot be canceled\n", cnt);
+      printf ("aio_cancel (fd, cbp[%zd]) cannot be canceled\n", cnt);
   puts ("finished2");
 
   result |= do_wait (cbp, 10, ECANCELED);
diff --git a/rt/tst-aio64.c b/rt/tst-aio64.c
index 89129160..f598ac09 100644
--- a/rt/tst-aio64.c
+++ b/rt/tst-aio64.c
@@ -275,7 +275,7 @@ do_test (int argc, char *argv[])
   for (cnt = 10; cnt > 0; )
     if (aio_cancel64 (fd, cbp[--cnt]) == -1)
       /* This is not an error.  The request can simply be finished.  */
-      printf ("aio_cancel64 (fd, cbp[%Zd]) cannot be canceled\n", cnt);
+      printf ("aio_cancel64 (fd, cbp[%zd]) cannot be canceled\n", cnt);
   puts ("finished2");
 
   result |= do_wait (cbp, 10, ECANCELED);
diff --git a/scripts/check-installed-headers.sh b/scripts/check-installed-headers.sh
index 0876d264..457902d3 100644
--- a/scripts/check-installed-headers.sh
+++ b/scripts/check-installed-headers.sh
@@ -29,8 +29,8 @@ cxx_modes="-std=c++98 -std=gnu++98 -std=c++11 -std=gnu++11"
 # These are probably the most commonly used three.
 lib_modes="-D_DEFAULT_SOURCE=1 -D_GNU_SOURCE=1 -D_XOPEN_SOURCE=700"
 
-if [ $# -lt 3 ]; then
-    echo "usage: $0 c|c++ \"compile command\" header header header..." >&2
+if [ $# -lt 4 ]; then
+    echo "usage: $0 c|c++ \"compile command\" \"yes|no\" header header header..." >&2
     exit 2
 fi
 case "$1" in
@@ -49,6 +49,12 @@ esac
 shift
 cc_cmd="$1"
 shift
+if [ "$1" = "yes" ]; then
+     finputcharset="-finput-charset=ascii"
+else
+     finputcharset=""
+fi
+shift
 trap "rm -f '$cih_test_c'" 0
 
 failed=0
@@ -118,7 +124,7 @@ $expanded_lib_mode
 #include <$header>
 int avoid_empty_translation_unit;
 EOF
-            if $cc_cmd -finput-charset=ascii -fsyntax-only $lang_mode \
+            if $cc_cmd $finputcharset -fsyntax-only $lang_mode \
 		       "$cih_test_c" 2>&1
             then :
             else failed=1
diff --git a/shadow/putspent.c b/shadow/putspent.c
index cbbb840d..f58b9589 100644
--- a/shadow/putspent.c
+++ b/shadow/putspent.c
@@ -42,50 +42,50 @@ putspent (const struct spwd *p, FILE *stream)
 
   flockfile (stream);
 
-  if (fprintf (stream, "%s:%s:", p->sp_namp, _S (p->sp_pwdp)) < 0)
+  if (__fprintf (stream, "%s:%s:", p->sp_namp, _S (p->sp_pwdp)) < 0)
     ++errors;
 
   if ((p->sp_lstchg != (long int) -1
-       && fprintf (stream, "%ld:", p->sp_lstchg) < 0)
+       && __fprintf (stream, "%ld:", p->sp_lstchg) < 0)
       || (p->sp_lstchg == (long int) -1
-	  && putc_unlocked (':', stream) == EOF))
+	  && __putc_unlocked (':', stream) == EOF))
     ++errors;
 
   if ((p->sp_min != (long int) -1
-       && fprintf (stream, "%ld:", p->sp_min) < 0)
+       && __fprintf (stream, "%ld:", p->sp_min) < 0)
       || (p->sp_min == (long int) -1
-	  && putc_unlocked (':', stream) == EOF))
+	  && __putc_unlocked (':', stream) == EOF))
     ++errors;
 
   if ((p->sp_max != (long int) -1
-       && fprintf (stream, "%ld:", p->sp_max) < 0)
+       && __fprintf (stream, "%ld:", p->sp_max) < 0)
       || (p->sp_max == (long int) -1
-	  && putc_unlocked (':', stream) == EOF))
+	  && __putc_unlocked (':', stream) == EOF))
     ++errors;
 
   if ((p->sp_warn != (long int) -1
-       && fprintf (stream, "%ld:", p->sp_warn) < 0)
+       && __fprintf (stream, "%ld:", p->sp_warn) < 0)
       || (p->sp_warn == (long int) -1
-	  && putc_unlocked (':', stream) == EOF))
+	  && __putc_unlocked (':', stream) == EOF))
     ++errors;
 
   if ((p->sp_inact != (long int) -1
-       && fprintf (stream, "%ld:", p->sp_inact) < 0)
+       && __fprintf (stream, "%ld:", p->sp_inact) < 0)
       || (p->sp_inact == (long int) -1
-	  && putc_unlocked (':', stream) == EOF))
+	  && __putc_unlocked (':', stream) == EOF))
     ++errors;
 
   if ((p->sp_expire != (long int) -1
-       && fprintf (stream, "%ld:", p->sp_expire) < 0)
+       && __fprintf (stream, "%ld:", p->sp_expire) < 0)
       || (p->sp_expire == (long int) -1
-	  && putc_unlocked (':', stream) == EOF))
+	  && __putc_unlocked (':', stream) == EOF))
     ++errors;
 
   if (p->sp_flag != ~0ul
-      && fprintf (stream, "%ld", p->sp_flag) < 0)
+      && __fprintf (stream, "%ld", p->sp_flag) < 0)
     ++errors;
 
-  if (putc_unlocked ('\n', stream) == EOF)
+  if (__putc_unlocked ('\n', stream) == EOF)
     ++errors;
 
   funlockfile (stream);
diff --git a/socket/Makefile b/socket/Makefile
index 156eec6c..c6abc24b 100644
--- a/socket/Makefile
+++ b/socket/Makefile
@@ -48,11 +48,11 @@ aux	 := sa_len
 
 include ../Rules
 
-CFLAGS-recv.c += -fexceptions -fasynchronous-unwind-tables
+CFLAGS-recv.c += -fexceptions -fasynchronous-unwind-tables $(config-cflags-wno-ignored-attributes)
 CFLAGS-recvfrom.c += -fexceptions -fasynchronous-unwind-tables
 CFLAGS-sendto.c += -fexceptions -fasynchronous-unwind-tables
 CFLAGS-recvmsg.c += -fexceptions -fasynchronous-unwind-tables
 CFLAGS-sendmsg.c += -fexceptions -fasynchronous-unwind-tables
-CFLAGS-send.c += -fexceptions -fasynchronous-unwind-tables
-CFLAGS-connect.c += -fexceptions -fasynchronous-unwind-tables
-CFLAGS-accept.c += -fexceptions -fasynchronous-unwind-tables
+CFLAGS-send.c += -fexceptions -fasynchronous-unwind-tables $(config-cflags-wno-ignored-attributes)
+CFLAGS-connect.c += -fexceptions -fasynchronous-unwind-tables $(config-cflags-wno-ignored-attributes)
+CFLAGS-accept.c += -fexceptions -fasynchronous-unwind-tables $(config-cflags-wno-ignored-attributes)
diff --git a/stdio-common/Makefile b/stdio-common/Makefile
index d8498bbd..acb9822c 100644
--- a/stdio-common/Makefile
+++ b/stdio-common/Makefile
@@ -22,7 +22,7 @@ subdir	:= stdio-common
 
 include ../Makeconfig
 
-headers	:= stdio_ext.h printf.h bits/printf-ldbl.h bits/stdio_lim.h
+headers	:= stdio_ext.h printf.h bits/stdio_lim.h
 
 routines	:=							      \
 	ctermid cuserid							      \
diff --git a/stdio-common/bits/printf-ldbl.h b/stdio-common/bits/printf-ldbl.h
deleted file mode 100644
index d3300ff5..00000000
--- a/stdio-common/bits/printf-ldbl.h
+++ /dev/null
@@ -1,23 +0,0 @@
-/* -mlong-double-64 compatibility mode for <printf.h> functions.
-   Copyright (C) 2006-2022 Free Software Foundation, Inc.
-   This file is part of the GNU C Library.
-
-   The GNU C Library is free software; you can redistribute it and/or
-   modify it under the terms of the GNU Lesser General Public
-   License as published by the Free Software Foundation; either
-   version 2.1 of the License, or (at your option) any later version.
-
-   The GNU C Library is distributed in the hope that it will be useful,
-   but WITHOUT ANY WARRANTY; without even the implied warranty of
-   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
-   Lesser General Public License for more details.
-
-   You should have received a copy of the GNU Lesser General Public
-   License along with the GNU C Library; if not, see
-   <https://www.gnu.org/licenses/>.  */
-
-#ifndef _PRINTF_H
-# error "Never include <bits/printf-ldbl.h> directly; use <printf.h> instead."
-#endif
-
-__LDBL_REDIR_DECL (printf_size)
diff --git a/stdio-common/bug1.c b/stdio-common/bug1.c
index 18e7d4c2..1035409d 100644
--- a/stdio-common/bug1.c
+++ b/stdio-common/bug1.c
@@ -13,12 +13,12 @@ main (void)
   stream = open_memstream (&bp, &size);
   fprintf (stream, "hello");
   fflush (stream);
-  printf ("buf = %s, size = %Zu\n", bp, size);
+  printf ("buf = %s, size = %zu\n", bp, size);
   lose |= size != 5;
   lose |= strncmp (bp, "hello", size);
   fprintf (stream, ", world");
   fclose (stream);
-  printf ("buf = %s, size = %Zu\n", bp, size);
+  printf ("buf = %s, size = %zu\n", bp, size);
   lose |= size != 12;
   lose |= strncmp (bp, "hello, world", 12);
 
diff --git a/stdio-common/bug23-3.c b/stdio-common/bug23-3.c
index 57c8cef1..a7162996 100644
--- a/stdio-common/bug23-3.c
+++ b/stdio-common/bug23-3.c
@@ -5,6 +5,10 @@
 int
 do_test (void)
 {
+#ifdef __clang__
+  /* It triggers an infinite loop on clang.  */
+  return 77;
+#else
   size_t instances = 16384;
 #define X0 "\n%1$s\n" "%1$s" "%2$s" "%2$s" "%3$s" "%4$s" "%5$d" "%5$d"
   const char *item = "\na\nabbcd55";
@@ -45,6 +49,7 @@ do_test (void)
     }
   free (buf);
   return 0;
+#endif
 }
 #define TEST_FUNCTION do_test ()
 #include "../test-skeleton.c"
diff --git a/stdio-common/bug5.c b/stdio-common/bug5.c
index 7bfe9b2b..f30f8d45 100644
--- a/stdio-common/bug5.c
+++ b/stdio-common/bug5.c
@@ -28,7 +28,7 @@ main (void)
       return 1;
     }
   for (i = 0; i < 1000; ++i)
-    fprintf (in, "%Zu\n", i);
+    fprintf (in, "%zu\n", i);
 
   out = fopen (outname, "w");
   if (out == NULL)
diff --git a/stdio-common/dprintf.c b/stdio-common/dprintf.c
index 2e26d597..6fbe5d48 100644
--- a/stdio-common/dprintf.c
+++ b/stdio-common/dprintf.c
@@ -33,5 +33,4 @@ __dprintf (int d, const char *format, ...)
   return done;
 }
 libc_hidden_def (__dprintf)
-ldbl_hidden_def (__dprintf, dprintf)
 ldbl_weak_alias (__dprintf, dprintf)
diff --git a/stdio-common/fprintf.c b/stdio-common/fprintf.c
index 8d2cd374..af7190c5 100644
--- a/stdio-common/fprintf.c
+++ b/stdio-common/fprintf.c
@@ -34,7 +34,7 @@ __fprintf (FILE *stream, const char *format, ...)
 
   return done;
 }
-ldbl_hidden_def (__fprintf, fprintf)
+libc_hidden_def (__fprintf)
 ldbl_strong_alias (__fprintf, fprintf)
 
 /* We define the function with the real name here.  But deep down in
diff --git a/stdio-common/getline.c b/stdio-common/getline.c
index 18a489ca..329b1c7d 100644
--- a/stdio-common/getline.c
+++ b/stdio-common/getline.c
@@ -25,7 +25,7 @@
 ssize_t
 __getline (char **lineptr, size_t *n, FILE *stream)
 {
-  return __getdelim (lineptr, n, '\n', stream);
+  return __libc_getdelim (lineptr, n, '\n', stream);
 }
 
 weak_alias (__getline, getline)
diff --git a/stdio-common/printf.h b/stdio-common/printf.h
index 46993e03..57e50fe7 100644
--- a/stdio-common/printf.h
+++ b/stdio-common/printf.h
@@ -29,6 +29,7 @@ __BEGIN_DECLS
 #include <stddef.h>
 
 #include <stdarg.h>
+#include <bits/floatn.h>
 
 
 struct printf_info
@@ -173,20 +174,16 @@ enum
    of magnitude used for numbers ('k' for kilo, 'm' for mega etc).  If
    the format specifier is a uppercase character powers of 1000 are
    used.  Otherwise powers of 1024.  */
-extern int printf_size (FILE *__restrict __fp,
-			const struct printf_info *__info,
-			const void *const *__restrict __args) __THROW;
+extern int __REDIRECT_LDBL_NTH (printf_size, (FILE *__restrict __fp,
+					      const struct printf_info *__info,
+					      const void *const *__restrict __args),
+				__printf_sizeieee128, __nldbl_printf_size);
 
 /* This is the appropriate argument information function for `printf_size'.  */
 extern int printf_size_info (const struct printf_info *__restrict
 			     __info, size_t __n, int *__restrict __argtypes)
      __THROW;
 
-#include <bits/floatn.h>
-#if defined __LDBL_COMPAT || __LDOUBLE_REDIRECTS_TO_FLOAT128_ABI == 1
-# include <bits/printf-ldbl.h>
-#endif
-
 __END_DECLS
 
 #endif /* printf.h  */
diff --git a/stdio-common/psiginfo.c b/stdio-common/psiginfo.c
index adf3b71b..f99c51da 100644
--- a/stdio-common/psiginfo.c
+++ b/stdio-common/psiginfo.c
@@ -76,7 +76,7 @@ psiginfo (const siginfo_t *pinfo, const char *s)
     }
 
   if (s != NULL && *s != '\0')
-    fprintf (fp, "%s: ", s);
+    __fprintf (fp, "%s: ", s);
 
   const char *desc;
   if (pinfo->si_signo >= 0 && pinfo->si_signo < NSIG
@@ -92,21 +92,21 @@ psiginfo (const siginfo_t *pinfo, const char *s)
 	  if (pinfo->si_signo - SIGRTMIN < SIGRTMAX - pinfo->si_signo)
 	    {
 	      if (pinfo->si_signo == SIGRTMIN)
-		fprintf (fp, "SIGRTMIN (");
+		__fprintf (fp, "SIGRTMIN (");
 	      else
-		fprintf (fp, "SIGRTMIN+%d (", pinfo->si_signo - SIGRTMIN);
+		__fprintf (fp, "SIGRTMIN+%d (", pinfo->si_signo - SIGRTMIN);
 	    }
 	  else
 	    {
 	      if (pinfo->si_signo == SIGRTMAX)
-		fprintf (fp, "SIGRTMAX (");
+		__fprintf (fp, "SIGRTMAX (");
 	      else
-		fprintf (fp, "SIGRTMAX-%d (", SIGRTMAX - pinfo->si_signo);
+		__fprintf (fp, "SIGRTMAX-%d (", SIGRTMAX - pinfo->si_signo);
 	    }
 	}
       else
 #endif
-	fprintf (fp, "%s (", _(desc));
+	__fprintf (fp, "%s (", _(desc));
 
       const char *base = NULL;
       const uint8_t *offarr = NULL;
@@ -178,25 +178,25 @@ Signal generated by the completion of an I/O request");
 	  }
 
       if (str != NULL)
-	fprintf (fp, "%s ", _(str));
+	__fprintf (fp, "%s ", _(str));
       else
-	fprintf (fp, "%d ", pinfo->si_code);
+	__fprintf (fp, "%d ", pinfo->si_code);
 
       if (pinfo->si_signo == SIGILL || pinfo->si_signo == SIGFPE
 	  || pinfo->si_signo == SIGSEGV || pinfo->si_signo == SIGBUS)
-	fprintf (fp, "[%p])\n", pinfo->si_addr);
+	__fprintf (fp, "[%p])\n", pinfo->si_addr);
       else if (pinfo->si_signo == SIGCHLD)
-	fprintf (fp, "%ld %d %ld)\n",
-		 (long int) pinfo->si_pid, pinfo->si_status,
-		 (long int) pinfo->si_uid);
+	__fprintf (fp, "%ld %d %ld)\n",
+		   (long int) pinfo->si_pid, pinfo->si_status,
+		   (long int) pinfo->si_uid);
       else if (pinfo->si_signo == SIGPOLL)
-	fprintf (fp, "%ld)\n", (long int) pinfo->si_band);
+	__fprintf (fp, "%ld)\n", (long int) pinfo->si_band);
       else
-	fprintf (fp, "%ld %ld)\n",
-		 (long int) pinfo->si_pid, (long int) pinfo->si_uid);
+	__fprintf (fp, "%ld %ld)\n",
+		   (long int) pinfo->si_pid, (long int) pinfo->si_uid);
     }
   else
-    fprintf (fp, _("Unknown signal %d\n"),  pinfo->si_signo);
+    __fprintf (fp, _("Unknown signal %d\n"),  pinfo->si_signo);
 
   fclose (fp);
 
diff --git a/stdio-common/scanf13.c b/stdio-common/scanf13.c
index 720224aa..02d258ae 100644
--- a/stdio-common/scanf13.c
+++ b/stdio-common/scanf13.c
@@ -3,6 +3,7 @@
 #include <stdlib.h>
 #include <string.h>
 #include <wchar.h>
+#include <libc-diag.h>
 
 int
 main (void)
@@ -20,6 +21,11 @@ main (void)
   } while (0)
 
   setlocale (LC_ALL, "de_DE.UTF-8");
+  /* TODO: explain why clang need these.  */
+  DIAG_PUSH_NEEDS_COMMENT_CLANG;
+  DIAG_IGNORE_NEEDS_COMMENT_CLANG (13, "-Wformat-invalid-specifier");
+  DIAG_IGNORE_NEEDS_COMMENT_CLANG (13, "-Wformat-extra-args");
+  DIAG_IGNORE_NEEDS_COMMENT_CLANG (13, "-Wfortify-source");
   if (sscanf ("A  \xc3\x84-\t\t\xc3\x84-abcdefbcd\t\xc3\x84-B",
 	      "A%ms%10ms%4m[bcd]%4mcB", &sp1, &sp2, &sp3, &sp4) != 4)
     FAIL ();
@@ -57,6 +63,7 @@ main (void)
 	FAIL ();
       free (lsp4);
     }
+  DIAG_POP_NEEDS_COMMENT_CLANG;
 
   memset (buf, '/', sizeof (buf));
   buf[0] = '\t';
@@ -85,6 +92,9 @@ main (void)
 	FAIL ();
       free (sp2);
     }
+  /* TODO: explain why clang need these.  */
+  DIAG_PUSH_NEEDS_COMMENT_CLANG;
+  DIAG_IGNORE_NEEDS_COMMENT_CLANG (13, "-Wfortify-source");
   if (sscanf (buf, "%2048ms%mc", &sp3, &sp4) != 2)
     FAIL ();
   else
@@ -125,6 +135,7 @@ main (void)
 	FAIL ();
       free (sp4);
     }
+  DIAG_POP_NEEDS_COMMENT_CLANG;
   if (sscanf (buf, "%mS%mC", &lsp1, &lsp2) != 2)
     FAIL ();
   else
@@ -141,6 +152,9 @@ main (void)
 	FAIL ();
       free (lsp2);
     }
+  DIAG_PUSH_NEEDS_COMMENT_CLANG;
+  DIAG_IGNORE_NEEDS_COMMENT_CLANG (13, "-Wformat-invalid-specifier");
+  DIAG_IGNORE_NEEDS_COMMENT_CLANG (13, "-Wformat-extra-args");
   if (sscanf (buf, "%2048mls%mlc", &lsp3, &lsp4) != 2)
     FAIL ();
   else
@@ -181,6 +195,7 @@ main (void)
 	FAIL ();
       free (lsp4);
     }
+  DIAG_POP_NEEDS_COMMENT_CLANG;
 
   return result;
 }
diff --git a/stdio-common/sprintf.c b/stdio-common/sprintf.c
index a9665f75..f1f43a49 100644
--- a/stdio-common/sprintf.c
+++ b/stdio-common/sprintf.c
@@ -32,6 +32,6 @@ __sprintf (char *s, const char *format, ...)
 
   return done;
 }
-ldbl_hidden_def (__sprintf, sprintf)
+libc_hidden_def (__sprintf)
 ldbl_strong_alias (__sprintf, sprintf)
 ldbl_strong_alias (__sprintf, _IO_sprintf)
diff --git a/stdio-common/test_rdwr.c b/stdio-common/test_rdwr.c
index bab062d9..0ec091b8 100644
--- a/stdio-common/test_rdwr.c
+++ b/stdio-common/test_rdwr.c
@@ -60,13 +60,13 @@ main (int argc, char **argv)
 	int c = getc (f);
 	if (c == EOF)
 	  {
-	    printf ("EOF at %Zu.\n", i);
+	    printf ("EOF at %zu.\n", i);
 	    lose = 1;
 	    break;
 	  }
 	else if (c != hello[i])
 	  {
-	    printf ("Got '%c' instead of '%c' at %Zu.\n",
+	    printf ("Got '%c' instead of '%c' at %zu.\n",
 		    (unsigned char) c, hello[i], i);
 	    lose = 1;
 	    break;
@@ -82,7 +82,7 @@ main (int argc, char **argv)
 	for (i = replace_from; i < replace_to; ++i)
 	  if (putc(replace[i], f) == EOF)
 	    {
-	      printf ("putc('%c') got %s at %Zu.\n",
+	      printf ("putc('%c') got %s at %zu.\n",
 		      replace[i], strerror (errno), i);
 	      lose = 1;
 	      break;
@@ -90,13 +90,13 @@ main (int argc, char **argv)
       }
     else if (where == -1L)
       {
-	printf ("ftell got %s (should be at %Zu).\n",
+	printf ("ftell got %s (should be at %zu).\n",
 		strerror (errno), replace_from);
 	lose = 1;
       }
     else
       {
-	printf ("ftell returns %lu; should be %Zu.\n", where, replace_from);
+	printf ("ftell returns %lu; should be %zu.\n", where, replace_from);
 	lose = 1;
       }
   }
diff --git a/stdio-common/tst-fphex.c b/stdio-common/tst-fphex.c
index efba4825..13008af7 100644
--- a/stdio-common/tst-fphex.c
+++ b/stdio-common/tst-fphex.c
@@ -56,8 +56,8 @@ do_test (void)
       int n = SPRINT (buf, array_length (buf), t->fmt, t->value);
       if (n != STR_LEN (t->expect) || STR_CMP (buf, t->expect) != 0)
 	{
-	  PRINT (L_("" S "\tExpected \"" S "\" (%Zu)\n\tGot      \""
-		    S "\" (%d, %Zu)\n"),
+	  PRINT (L_("" S "\tExpected \"" S "\" (%zu)\n\tGot      \""
+		    S "\" (%d, %zu)\n"),
 		 t->fmt, t->expect, STR_LEN (t->expect),
 		 buf, n, STR_LEN (buf));
 	  result = 1;
diff --git a/stdio-common/tst-printf-bz18872.sh b/stdio-common/tst-printf-bz18872.sh
index 8cf3dc67..37e4d7b6 100644
--- a/stdio-common/tst-printf-bz18872.sh
+++ b/stdio-common/tst-printf-bz18872.sh
@@ -31,7 +31,13 @@ cat <<'EOF'
   Compile do_test without optimization: GCC 4.9/5.0/6.0 takes a long time
   to build this source. https://gcc.gnu.org/bugzilla/show_bug.cgi?id=67396  */
 
-__attribute__ ((optimize ("-O0")))
+#if __GNUC_PREREQ (4, 4) || __glibc_has_attribute (__optimize__)
+# define attribute_optimize(level) __attribute__ ((optimize (level)))
+#else
+# define attribute_optimize(level)
+#endif
+
+attribute_optimize ("-O0")
 int do_test (void)
 {
     mtrace ();
diff --git a/stdio-common/tst-sprintf-errno.c b/stdio-common/tst-sprintf-errno.c
index ca1214cd..bfba9907 100644
--- a/stdio-common/tst-sprintf-errno.c
+++ b/stdio-common/tst-sprintf-errno.c
@@ -24,7 +24,7 @@
 
 /* GCC does not yet know about the %#m specifier.  */
 DIAG_PUSH_NEEDS_COMMENT;
-DIAG_IGNORE_NEEDS_COMMENT (11, "-Wformat=");
+DIAG_IGNORE_NEEDS_COMMENT_GCC (11, "-Wformat=");
 
 static int
 do_test (void)
diff --git a/stdio-common/tst-unlockedio.c b/stdio-common/tst-unlockedio.c
index 83b3e559..6f109ba3 100644
--- a/stdio-common/tst-unlockedio.c
+++ b/stdio-common/tst-unlockedio.c
@@ -51,6 +51,9 @@ do_test (void)
      fread_unlocked below as well.  */
   DIAG_PUSH_NEEDS_COMMENT;
   DIAG_IGNORE_NEEDS_COMMENT (4.9, "-Wdiv-by-zero");
+  /* clang warns about the implicit conversion from double to size_t,
+     which is required by this tests.  */
+  DIAG_IGNORE_NEEDS_COMMENT_CLANG (13, "-Wliteral-conversion");
   if (ftello (fp) != 0
       || fwrite_unlocked (blah, blah - blah, strlen (blah), f++) != 0
       || f != fp + 1
@@ -104,6 +107,7 @@ do_test (void)
   /* See explanation above.  */
   DIAG_PUSH_NEEDS_COMMENT;
   DIAG_IGNORE_NEEDS_COMMENT (4.9, "-Wdiv-by-zero");
+  DIAG_IGNORE_NEEDS_COMMENT_CLANG (13, "-Wliteral-conversion");
   if (ftello (fp) != 0
       || fread_unlocked (buf, buf - buf, strlen (blah), f++) != 0
       || f != fp + 1
diff --git a/stdio-common/tst-vfprintf-user-type.c b/stdio-common/tst-vfprintf-user-type.c
index f2650ac0..0ebdae61 100644
--- a/stdio-common/tst-vfprintf-user-type.c
+++ b/stdio-common/tst-vfprintf-user-type.c
@@ -152,7 +152,7 @@ do_test (void)
 #else
   extern int asprintf_alias (char **, const char *, ...) __asm__ ("asprintf");
 #endif
-  TEST_VERIFY (asprintf_alias == asprintf);
+  TEST_VERIFY ((uintptr_t) asprintf_alias == (uintptr_t) asprintf);
   char *str = NULL;
   TEST_VERIFY (asprintf_alias (&str, "[[%P]]", 123L, 456.0) >= 0);
   if (test_verbose > 0)
diff --git a/stdio-common/tstgetln.c b/stdio-common/tstgetln.c
index 8d7f2375..4895f141 100644
--- a/stdio-common/tstgetln.c
+++ b/stdio-common/tstgetln.c
@@ -26,7 +26,7 @@ main (int argc, char *argv[])
 
   while ((len = getline (&buf, &size, stdin)) != -1)
     {
-      printf ("bufsize %Zu; read %Zd: ", size, len);
+      printf ("bufsize %zu; read %zd: ", size, len);
       if (fwrite (buf, len, 1, stdout) != 1)
 	{
 	  perror ("fwrite");
diff --git a/stdio-common/vfprintf-internal.c b/stdio-common/vfprintf-internal.c
index 59bd76c8..76b89d5d 100644
--- a/stdio-common/vfprintf-internal.c
+++ b/stdio-common/vfprintf-internal.c
@@ -1878,7 +1878,7 @@ printf_positional (FILE *s, const CHAR_T *format, int readonly_format,
 	  extern printf_function **__printf_function_table;
 	  int function_done;
 
-	  if (spec <= UCHAR_MAX
+	  if ((int) spec <= UCHAR_MAX
 	      && __printf_function_table != NULL
 	      && __printf_function_table[(size_t) spec] != NULL)
 	    {
diff --git a/stdio-common/vfprintf.c b/stdio-common/vfprintf.c
index 7559fd23..c5912788 100644
--- a/stdio-common/vfprintf.c
+++ b/stdio-common/vfprintf.c
@@ -24,4 +24,4 @@ __vfprintf (FILE *fp, const char *format, va_list ap)
 }
 ldbl_strong_alias (__vfprintf, _IO_vfprintf);
 ldbl_strong_alias (__vfprintf, vfprintf);
-ldbl_hidden_def (__vfprintf, vfprintf)
+libc_hidden_def (__vfprintf)
diff --git a/stdio-common/vfscanf-internal.c b/stdio-common/vfscanf-internal.c
index 2ad34050..5247a067 100644
--- a/stdio-common/vfscanf-internal.c
+++ b/stdio-common/vfscanf-internal.c
@@ -1535,7 +1535,7 @@ __vfscanf_internal (FILE *s, const char *format, va_list argptr,
 			 above, but the test for "map != NULL" is done
 			 inside the loop here and outside the loop there.  */
 		      DIAG_PUSH_NEEDS_COMMENT;
-		      DIAG_IGNORE_NEEDS_COMMENT (4.7, "-Wmaybe-uninitialized");
+		      DIAG_IGNORE_NEEDS_COMMENT_GCC (4.7, "-Wmaybe-uninitialized");
 
 		      if (__glibc_unlikely (map != NULL))
 			wcdigits[n] = wcdigits_extended[n];
diff --git a/stdlib/Makefile b/stdlib/Makefile
index 82367419..c137d8b4 100644
--- a/stdlib/Makefile
+++ b/stdlib/Makefile
@@ -22,8 +22,8 @@ subdir	:= stdlib
 
 include ../Makeconfig
 
-headers	:= stdlib.h bits/stdlib.h bits/stdlib-ldbl.h bits/stdlib-float.h      \
-	   monetary.h bits/monetary-ldbl.h				      \
+headers	:= stdlib.h bits/stdlib.h bits/stdlib-float.h                         \
+	   monetary.h							      \
 	   inttypes.h stdint.h bits/wordsize.h bits/timesize.h		      \
 	   errno.h sys/errno.h bits/errno.h bits/types/error_t.h	      \
 	   ucontext.h sys/ucontext.h bits/indirect-return.h		      \
@@ -212,6 +212,14 @@ CFLAGS-strfromd.c += $(libio-mtsafe)
 CFLAGS-strfromf.c += $(libio-mtsafe)
 CFLAGS-strfroml.c += $(libio-mtsafe)
 
+CFLAGS-strtof.c += $(config-cflags-wno-ignored-attributes)
+CFLAGS-strtof_l.c += $(config-cflags-wno-ignored-attributes)
+CFLAGS-strtod.c += $(config-cflags-wno-ignored-attributes)
+CFLAGS-strtod_l.c += $(config-cflags-wno-ignored-attributes)
+CFLAGS-strtold.c += $(config-cflags-wno-ignored-attributes)
+CFLAGS-strtold_l.c += $(config-cflags-wno-ignored-attributes)
+CFLAGS-secure-getenv.c += $(config-cflags-wno-ignored-attributes)
+
 CFLAGS-tst-bsearch.c += $(stack-align-test-flags)
 CFLAGS-tst-qsort.c += $(stack-align-test-flags)
 CFLAGS-tst-makecontext.c += -funwind-tables
diff --git a/stdlib/atof.c b/stdlib/atof.c
index 782c6053..d208c6d3 100644
--- a/stdlib/atof.c
+++ b/stdlib/atof.c
@@ -24,5 +24,5 @@
 double
 atof (const char *nptr)
 {
-  return strtod (nptr, (char **) NULL);
+  return __strtod (nptr, (char **) NULL);
 }
diff --git a/stdlib/atoi.c b/stdlib/atoi.c
index c977506b..61d78631 100644
--- a/stdlib/atoi.c
+++ b/stdlib/atoi.c
@@ -24,6 +24,5 @@
 int
 atoi (const char *nptr)
 {
-  return (int) strtol (nptr, (char **) NULL, 10);
+  return (int) __strtol (nptr, (char **) NULL, 10);
 }
-libc_hidden_def (atoi)
diff --git a/stdlib/atol.c b/stdlib/atol.c
index 5706d6e1..77183bd0 100644
--- a/stdlib/atol.c
+++ b/stdlib/atol.c
@@ -24,5 +24,5 @@
 long int
 atol (const char *nptr)
 {
-  return strtol (nptr, (char **) NULL, 10);
+  return __strtol (nptr, (char **) NULL, 10);
 }
diff --git a/stdlib/atoll.c b/stdlib/atoll.c
index 05ad7c14..5be05716 100644
--- a/stdlib/atoll.c
+++ b/stdlib/atoll.c
@@ -24,5 +24,5 @@
 long long int
 atoll (const char *nptr)
 {
-  return strtoll (nptr, (char **) NULL, 10);
+  return __strtoll (nptr, (char **) NULL, 10);
 }
diff --git a/stdlib/bits/stdlib-ldbl.h b/stdlib/bits/stdlib-ldbl.h
deleted file mode 100644
index bf2c0b55..00000000
--- a/stdlib/bits/stdlib-ldbl.h
+++ /dev/null
@@ -1,63 +0,0 @@
-/* -mlong-double-64 compatibility mode for <stdlib.h> functions.
-   Copyright (C) 2006-2022 Free Software Foundation, Inc.
-   This file is part of the GNU C Library.
-
-   The GNU C Library is free software; you can redistribute it and/or
-   modify it under the terms of the GNU Lesser General Public
-   License as published by the Free Software Foundation; either
-   version 2.1 of the License, or (at your option) any later version.
-
-   The GNU C Library is distributed in the hope that it will be useful,
-   but WITHOUT ANY WARRANTY; without even the implied warranty of
-   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
-   Lesser General Public License for more details.
-
-   You should have received a copy of the GNU Lesser General Public
-   License along with the GNU C Library; if not, see
-   <https://www.gnu.org/licenses/>.  */
-
-#ifndef _STDLIB_H
-# error "Never include <bits/stdlib-ldbl.h> directly; use <stdlib.h> instead."
-#endif
-
-#ifdef	__USE_ISOC99
-# ifdef __LDBL_COMPAT
-__LDBL_REDIR1_DECL (strtold, strtod)
-# else
-__LDBL_REDIR1_DECL (strtold, __strtoieee128)
-# endif
-#endif
-
-#ifdef __USE_GNU
-# ifdef __LDBL_COMPAT
-__LDBL_REDIR1_DECL (strtold_l, strtod_l)
-# else
-__LDBL_REDIR1_DECL (strtold_l, __strtoieee128_l)
-# endif
-#endif
-
-#if __GLIBC_USE (IEC_60559_BFP_EXT_C2X)
-# ifdef __LDBL_COMPAT
-__LDBL_REDIR1_DECL (strfroml, strfromd)
-# else
-__LDBL_REDIR1_DECL (strfroml, __strfromieee128)
-# endif
-#endif
-
-#ifdef __USE_MISC
-# if defined __LDBL_COMPAT
-__LDBL_REDIR1_DECL (qecvt, ecvt)
-__LDBL_REDIR1_DECL (qfcvt, fcvt)
-__LDBL_REDIR1_DECL (qgcvt, gcvt)
-__LDBL_REDIR1_DECL (qecvt_r, ecvt_r)
-__LDBL_REDIR1_DECL (qfcvt_r, fcvt_r)
-# elif __LDOUBLE_REDIRECTS_TO_FLOAT128_ABI == 1
-__LDBL_REDIR1_DECL (qecvt, __qecvtieee128)
-__LDBL_REDIR1_DECL (qfcvt, __qfcvtieee128)
-__LDBL_REDIR1_DECL (qgcvt, __qgcvtieee128)
-__LDBL_REDIR1_DECL (qecvt_r, __qecvtieee128_r)
-__LDBL_REDIR1_DECL (qfcvt_r, __qfcvtieee128_r)
-# else
-#  error bits/stdlib-ldbl.h included when no ldbl redirections are required.
-# endif
-#endif
diff --git a/stdlib/bsearch.c b/stdlib/bsearch.c
index a6d7e8ae..3311f763 100644
--- a/stdlib/bsearch.c
+++ b/stdlib/bsearch.c
@@ -19,5 +19,9 @@
 
 #undef  __extern_inline
 #define __extern_inline /* Empty, so we get a normal definition.  */
+#undef bsearch
+#define bsearch __bsearch
 #include <bits/stdlib-bsearch.h>
-libc_hidden_def (bsearch)
+#undef bsearch
+libc_hidden_def (__bsearch)
+weak_alias (__bsearch, bsearch)
diff --git a/stdlib/bug-getcontext.c b/stdlib/bug-getcontext.c
index 55c681c4..9e5e6c7e 100644
--- a/stdlib/bug-getcontext.c
+++ b/stdlib/bug-getcontext.c
@@ -56,7 +56,7 @@ do_test (void)
      in local variables being clobbered on the second return from
      getcontext), in fact an uninitialized use is not possible.  */
   DIAG_PUSH_NEEDS_COMMENT;
-  DIAG_IGNORE_NEEDS_COMMENT (5, "-Wmaybe-uninitialized");
+  DIAG_IGNORE_NEEDS_COMMENT_GCC (5, "-Wmaybe-uninitialized");
   int mask = fegetexcept ();
   if (mask != except_mask)
     {
diff --git a/stdlib/fmtmsg.c b/stdlib/fmtmsg.c
index 787a263d..59384b64 100644
--- a/stdlib/fmtmsg.c
+++ b/stdlib/fmtmsg.c
@@ -177,17 +177,17 @@ fmtmsg (long int classification, const char *label, int severity,
 	  int need_colon = (do_label
 			    && (do_severity | do_text | do_action | do_tag));
 
-	  syslog (LOG_ERR, "%s%s%s%s%s%s%s%s%s%s\n",
-		  do_label ? label : "",
-		  need_colon ? ": " : "",
-		  do_severity ? severity_rec->string : "",
-		  do_severity && (do_text | do_action | do_tag) ? ": " : "",
-		  do_text ? text : "",
-		  do_text && (do_action | do_tag) ? "\n" : "",
-		  do_action ? "TO FIX: " : "",
-		  do_action ? action : "",
-		  do_action && do_tag ? "  " : "",
-		  do_tag ? tag : "");
+	  __syslog (LOG_ERR, "%s%s%s%s%s%s%s%s%s%s\n",
+		    do_label ? label : "",
+		    need_colon ? ": " : "",
+		    do_severity ? severity_rec->string : "",
+		    do_severity && (do_text | do_action | do_tag) ? ": " : "",
+		    do_text ? text : "",
+		    do_text && (do_action | do_tag) ? "\n" : "",
+		    do_action ? "TO FIX: " : "",
+		    do_action ? action : "",
+		    do_action && do_tag ? "  " : "",
+		    do_tag ? tag : "");
 	}
     }
 
@@ -263,7 +263,7 @@ init (void)
 	      /* Second field: severity level, a number.  */
 	      char *cp;
 
-	      level = strtol (sevlevel_var, &cp, 0);
+	      level = __strtol (sevlevel_var, &cp, 0);
 	      if (cp != sevlevel_var && cp < end && *cp++ == ','
 		  && level > MM_INFO)
 		{
diff --git a/stdlib/fpioconst.h b/stdlib/fpioconst.h
index 1e019999..3e185f57 100644
--- a/stdlib/fpioconst.h
+++ b/stdlib/fpioconst.h
@@ -52,9 +52,12 @@
    - LDBL_MIN_EXP + 2)).  When _Float128 is enabled in libm and it is
    ABI-distinct from long double (e.g. on powerpc64le), we also need powers
    of 10 up to floor (log_2 (FLT128_MANT_DIG - FLT128_MIN_EXP + 2)).  */
-#define FPIOCONST_HAVE_EXTENDED_RANGE \
-  ((!defined __NO_LONG_DOUBLE_MATH && __LDBL_MAX_EXP__ > 1024) \
-   || __HAVE_DISTINCT_FLOAT128)
+#if (!defined __NO_LONG_DOUBLE_MATH && __LDBL_MAX_EXP__ > 1024) \
+    || __HAVE_DISTINCT_FLOAT128
+# define FPIOCONST_HAVE_EXTENDED_RANGE 1
+#else
+# define FPIOCONST_HAVE_EXTENDED_RANGE 0
+#endif
 
 #if FPIOCONST_HAVE_EXTENDED_RANGE
 # define FPIOCONST_POW10_ARRAY_SIZE	15
diff --git a/stdlib/gmp.h b/stdlib/gmp.h
index a206e36c..ca9ebd2b 100644
--- a/stdlib/gmp.h
+++ b/stdlib/gmp.h
@@ -48,6 +48,12 @@ along with the GNU MP Library; see the file COPYING.LIB.  If not, see
 #endif
 #endif
 
+#ifdef _LIBC
+#define _ATTRIBUTE_HIDDEN attribute_hidden
+#else
+#define _ATTRIBUTE_HIDDEN
+#endif
+
 #ifdef _SHORT_LIMB
 typedef unsigned int		mp_limb_t;
 typedef int			mp_limb_signed_t;
@@ -389,39 +395,39 @@ void mpf_ui_sub _PROTO ((mpf_ptr, unsigned long int, mpf_srcptr));
 #if defined (__cplusplus)
 extern "C" {
 #endif
-mp_limb_t mpn_add _PROTO ((mp_ptr, mp_srcptr, mp_size_t, mp_srcptr,mp_size_t));
-mp_limb_t mpn_add_1 _PROTO ((mp_ptr, mp_srcptr, mp_size_t, mp_limb_t));
-mp_limb_t mpn_add_n _PROTO ((mp_ptr, mp_srcptr, mp_srcptr, mp_size_t));
-mp_limb_t mpn_addmul_1 _PROTO ((mp_ptr, mp_srcptr, mp_size_t, mp_limb_t));
-mp_limb_t mpn_bdivmod _PROTO ((mp_ptr, mp_ptr, mp_size_t, mp_srcptr, mp_size_t, unsigned long int));
-int mpn_cmp _PROTO ((mp_srcptr, mp_srcptr, mp_size_t));
-mp_limb_t mpn_divmod_1 _PROTO ((mp_ptr, mp_srcptr, mp_size_t, mp_limb_t));
-mp_limb_t mpn_divrem _PROTO ((mp_ptr, mp_size_t, mp_ptr, mp_size_t, mp_srcptr, mp_size_t));
-mp_limb_t mpn_divrem_1 _PROTO ((mp_ptr, mp_size_t, mp_srcptr, mp_size_t, mp_limb_t));
-void mpn_dump _PROTO ((mp_srcptr, mp_size_t));
-mp_size_t mpn_gcd _PROTO ((mp_ptr, mp_ptr, mp_size_t, mp_ptr, mp_size_t));
-mp_limb_t mpn_gcd_1 _PROTO ((mp_srcptr, mp_size_t, mp_limb_t));
-mp_size_t mpn_gcdext _PROTO ((mp_ptr, mp_ptr, mp_ptr, mp_size_t, mp_ptr, mp_size_t));
-size_t mpn_get_str _PROTO ((unsigned char *, int, mp_ptr, mp_size_t));
-unsigned long int mpn_hamdist _PROTO ((mp_srcptr, mp_srcptr, mp_size_t));
-mp_limb_t mpn_lshift _PROTO ((mp_ptr, mp_srcptr, mp_size_t, unsigned int));
-mp_limb_t mpn_mod_1 _PROTO ((mp_srcptr, mp_size_t, mp_limb_t));
-mp_limb_t mpn_mul _PROTO ((mp_ptr, mp_srcptr, mp_size_t, mp_srcptr, mp_size_t));
-mp_limb_t mpn_mul_1 _PROTO ((mp_ptr, mp_srcptr, mp_size_t, mp_limb_t));
-void mpn_mul_n _PROTO ((mp_ptr, mp_srcptr, mp_srcptr, mp_size_t));
-int mpn_perfect_square_p _PROTO ((mp_srcptr, mp_size_t));
-unsigned long int mpn_popcount _PROTO ((mp_srcptr, mp_size_t));
-mp_limb_t mpn_preinv_mod_1 _PROTO ((mp_srcptr, mp_size_t, mp_limb_t, mp_limb_t));
-void mpn_random2 _PROTO ((mp_ptr, mp_size_t));
-mp_limb_t mpn_rshift _PROTO ((mp_ptr, mp_srcptr, mp_size_t, unsigned int));
-unsigned long int mpn_scan0 _PROTO ((mp_srcptr, unsigned long int));
-unsigned long int mpn_scan1 _PROTO ((mp_srcptr, unsigned long int));
-mp_size_t mpn_set_str _PROTO ((mp_ptr, const unsigned char *, size_t, int));
-mp_size_t mpn_sqrtrem _PROTO ((mp_ptr, mp_ptr, mp_srcptr, mp_size_t));
-mp_limb_t mpn_sub _PROTO ((mp_ptr, mp_srcptr, mp_size_t, mp_srcptr,mp_size_t));
-mp_limb_t mpn_sub_1 _PROTO ((mp_ptr, mp_srcptr, mp_size_t, mp_limb_t));
-mp_limb_t mpn_sub_n _PROTO ((mp_ptr, mp_srcptr, mp_srcptr, mp_size_t));
-mp_limb_t mpn_submul_1 _PROTO ((mp_ptr, mp_srcptr, mp_size_t, mp_limb_t));
+mp_limb_t mpn_add _PROTO ((mp_ptr, mp_srcptr, mp_size_t, mp_srcptr,mp_size_t)) _ATTRIBUTE_HIDDEN;
+mp_limb_t mpn_add_1 _PROTO ((mp_ptr, mp_srcptr, mp_size_t, mp_limb_t)) _ATTRIBUTE_HIDDEN;
+mp_limb_t mpn_add_n _PROTO ((mp_ptr, mp_srcptr, mp_srcptr, mp_size_t)) _ATTRIBUTE_HIDDEN;
+mp_limb_t mpn_addmul_1 _PROTO ((mp_ptr, mp_srcptr, mp_size_t, mp_limb_t)) _ATTRIBUTE_HIDDEN;
+mp_limb_t mpn_bdivmod _PROTO ((mp_ptr, mp_ptr, mp_size_t, mp_srcptr, mp_size_t, unsigned long int)) _ATTRIBUTE_HIDDEN;
+int mpn_cmp _PROTO ((mp_srcptr, mp_srcptr, mp_size_t)) _ATTRIBUTE_HIDDEN;
+mp_limb_t mpn_divmod_1 _PROTO ((mp_ptr, mp_srcptr, mp_size_t, mp_limb_t)) _ATTRIBUTE_HIDDEN;
+mp_limb_t mpn_divrem _PROTO ((mp_ptr, mp_size_t, mp_ptr, mp_size_t, mp_srcptr, mp_size_t)) _ATTRIBUTE_HIDDEN; 
+mp_limb_t mpn_divrem_1 _PROTO ((mp_ptr, mp_size_t, mp_srcptr, mp_size_t, mp_limb_t)) _ATTRIBUTE_HIDDEN;
+void mpn_dump _PROTO ((mp_srcptr, mp_size_t)) _ATTRIBUTE_HIDDEN;
+mp_size_t mpn_gcd _PROTO ((mp_ptr, mp_ptr, mp_size_t, mp_ptr, mp_size_t)) _ATTRIBUTE_HIDDEN;
+mp_limb_t mpn_gcd_1 _PROTO ((mp_srcptr, mp_size_t, mp_limb_t)) _ATTRIBUTE_HIDDEN;
+mp_size_t mpn_gcdext _PROTO ((mp_ptr, mp_ptr, mp_ptr, mp_size_t, mp_ptr, mp_size_t)) _ATTRIBUTE_HIDDEN;
+size_t mpn_get_str _PROTO ((unsigned char *, int, mp_ptr, mp_size_t)) _ATTRIBUTE_HIDDEN;
+unsigned long int mpn_hamdist _PROTO ((mp_srcptr, mp_srcptr, mp_size_t)) _ATTRIBUTE_HIDDEN;
+mp_limb_t mpn_lshift _PROTO ((mp_ptr, mp_srcptr, mp_size_t, unsigned int)) _ATTRIBUTE_HIDDEN;
+mp_limb_t mpn_mod_1 _PROTO ((mp_srcptr, mp_size_t, mp_limb_t)) _ATTRIBUTE_HIDDEN;
+mp_limb_t mpn_mul _PROTO ((mp_ptr, mp_srcptr, mp_size_t, mp_srcptr, mp_size_t)) _ATTRIBUTE_HIDDEN;
+mp_limb_t mpn_mul_1 _PROTO ((mp_ptr, mp_srcptr, mp_size_t, mp_limb_t)) _ATTRIBUTE_HIDDEN;
+void mpn_mul_n _PROTO ((mp_ptr, mp_srcptr, mp_srcptr, mp_size_t)) _ATTRIBUTE_HIDDEN;
+int mpn_perfect_square_p _PROTO ((mp_srcptr, mp_size_t)) _ATTRIBUTE_HIDDEN;
+unsigned long int mpn_popcount _PROTO ((mp_srcptr, mp_size_t)) _ATTRIBUTE_HIDDEN;
+mp_limb_t mpn_preinv_mod_1 _PROTO ((mp_srcptr, mp_size_t, mp_limb_t, mp_limb_t)) _ATTRIBUTE_HIDDEN;
+void mpn_random2 _PROTO ((mp_ptr, mp_size_t)) _ATTRIBUTE_HIDDEN;
+mp_limb_t mpn_rshift _PROTO ((mp_ptr, mp_srcptr, mp_size_t, unsigned int)) _ATTRIBUTE_HIDDEN;
+unsigned long int mpn_scan0 _PROTO ((mp_srcptr, unsigned long int)) _ATTRIBUTE_HIDDEN;
+unsigned long int mpn_scan1 _PROTO ((mp_srcptr, unsigned long int)) _ATTRIBUTE_HIDDEN;
+mp_size_t mpn_set_str _PROTO ((mp_ptr, const unsigned char *, size_t, int)) _ATTRIBUTE_HIDDEN;
+mp_size_t mpn_sqrtrem _PROTO ((mp_ptr, mp_ptr, mp_srcptr, mp_size_t)) _ATTRIBUTE_HIDDEN;
+mp_limb_t mpn_sub _PROTO ((mp_ptr, mp_srcptr, mp_size_t, mp_srcptr,mp_size_t)) _ATTRIBUTE_HIDDEN;
+mp_limb_t mpn_sub_1 _PROTO ((mp_ptr, mp_srcptr, mp_size_t, mp_limb_t)) _ATTRIBUTE_HIDDEN;
+mp_limb_t mpn_sub_n _PROTO ((mp_ptr, mp_srcptr, mp_srcptr, mp_size_t)) _ATTRIBUTE_HIDDEN;
+mp_limb_t mpn_submul_1 _PROTO ((mp_ptr, mp_srcptr, mp_size_t, mp_limb_t)) _ATTRIBUTE_HIDDEN;
 #if defined (__cplusplus)
 }
 #endif
diff --git a/stdlib/longlong.h b/stdlib/longlong.h
index 9b89469a..8d6681d5 100644
--- a/stdlib/longlong.h
+++ b/stdlib/longlong.h
@@ -194,8 +194,8 @@ extern UDItype __udiv_qrnnd (UDItype *, UDItype, UDItype, UDItype);
 #if defined (__arc__) && W_TYPE_SIZE == 32
 #define add_ssaaaa(sh, sl, ah, al, bh, bl) \
   __asm__ ("add.f	%1, %4, %5\n\tadc	%0, %2, %3"		\
-	   : "=r" ((USItype) (sh)),					\
-	     "=&r" ((USItype) (sl))					\
+	   : "=r" (sh),							\
+	     "=&r" (sl)							\
 	   : "%r" ((USItype) (ah)),					\
 	     "rICal" ((USItype) (bh)),					\
 	     "%r" ((USItype) (al)),					\
@@ -203,8 +203,8 @@ extern UDItype __udiv_qrnnd (UDItype *, UDItype, UDItype, UDItype);
 	   : "cc")
 #define sub_ddmmss(sh, sl, ah, al, bh, bl) \
   __asm__ ("sub.f	%1, %4, %5\n\tsbc	%0, %2, %3"		\
-	   : "=r" ((USItype) (sh)),					\
-	     "=&r" ((USItype) (sl))					\
+	   : "=r" (sh),							\
+	     "=&r" (sl)							\
 	   : "r" ((USItype) (ah)),					\
 	     "rICal" ((USItype) (bh)),					\
 	     "r" ((USItype) (al)),					\
@@ -230,16 +230,16 @@ extern UDItype __udiv_qrnnd (UDItype *, UDItype, UDItype, UDItype);
  && W_TYPE_SIZE == 32
 #define add_ssaaaa(sh, sl, ah, al, bh, bl) \
   __asm__ ("adds	%1, %4, %5\n\tadc	%0, %2, %3"		\
-	   : "=r" ((USItype) (sh)),					\
-	     "=&r" ((USItype) (sl))					\
+	   : "=r" (sh),							\
+	     "=&r" (sl)							\
 	   : "%r" ((USItype) (ah)),					\
 	     "rI" ((USItype) (bh)),					\
 	     "%r" ((USItype) (al)),					\
 	     "rI" ((USItype) (bl)) __CLOBBER_CC)
 #define sub_ddmmss(sh, sl, ah, al, bh, bl) \
   __asm__ ("subs	%1, %4, %5\n\tsbc	%0, %2, %3"		\
-	   : "=r" ((USItype) (sh)),					\
-	     "=&r" ((USItype) (sl))					\
+	   : "=r" (sh),							\
+	     "=&r" (sl)							\
 	   : "r" ((USItype) (ah)),					\
 	     "rI" ((USItype) (bh)),					\
 	     "r" ((USItype) (al)),					\
@@ -262,8 +262,8 @@ extern UDItype __udiv_qrnnd (UDItype *, UDItype, UDItype, UDItype);
 	   "	addcs	%0, %0, #65536\n"				\
 	   "	adds	%1, %1, %3, lsl #16\n"				\
 	   "	adc	%0, %0, %3, lsr #16"				\
-	   : "=&r" ((USItype) (xh)),					\
-	     "=r" ((USItype) (xl)),					\
+	   : "=&r" (xh),						\
+	     "=r" (xl),							\
 	     "=&r" (__t0), "=&r" (__t1), "=r" (__t2)			\
 	   : "r" ((USItype) (a)),					\
 	     "r" ((USItype) (b)) __CLOBBER_CC );			\
@@ -348,16 +348,16 @@ extern UDItype __umulsidi3 (USItype, USItype);
 #if defined (__hppa) && W_TYPE_SIZE == 32
 #define add_ssaaaa(sh, sl, ah, al, bh, bl) \
   __asm__ ("add %4,%5,%1\n\taddc %2,%3,%0"				\
-	   : "=r" ((USItype) (sh)),					\
-	     "=&r" ((USItype) (sl))					\
+	   : "=r" (sh),							\
+	     "=&r" (sl)							\
 	   : "%rM" ((USItype) (ah)),					\
 	     "rM" ((USItype) (bh)),					\
 	     "%rM" ((USItype) (al)),					\
 	     "rM" ((USItype) (bl)))
 #define sub_ddmmss(sh, sl, ah, al, bh, bl) \
   __asm__ ("sub %4,%5,%1\n\tsubb %2,%3,%0"				\
-	   : "=r" ((USItype) (sh)),					\
-	     "=&r" ((USItype) (sl))					\
+	   : "=r" (sh),							\
+	     "=&r" (sl)							\
 	   : "rM" ((USItype) (ah)),					\
 	     "rM" ((USItype) (bh)),					\
 	     "rM" ((USItype) (al)),					\
@@ -456,30 +456,30 @@ extern UDItype __umulsidi3 (USItype, USItype);
 #if (defined (__i386__) || defined (__i486__)) && W_TYPE_SIZE == 32
 #define add_ssaaaa(sh, sl, ah, al, bh, bl) \
   __asm__ ("add{l} {%5,%1|%1,%5}\n\tadc{l} {%3,%0|%0,%3}"		\
-	   : "=r" ((USItype) (sh)),					\
-	     "=&r" ((USItype) (sl))					\
+	   : "=r" (sh),							\
+	     "=&r" (sl)							\
 	   : "%0" ((USItype) (ah)),					\
 	     "g" ((USItype) (bh)),					\
 	     "%1" ((USItype) (al)),					\
 	     "g" ((USItype) (bl)))
 #define sub_ddmmss(sh, sl, ah, al, bh, bl) \
   __asm__ ("sub{l} {%5,%1|%1,%5}\n\tsbb{l} {%3,%0|%0,%3}"		\
-	   : "=r" ((USItype) (sh)),					\
-	     "=&r" ((USItype) (sl))					\
+	   : "=r" (sh),							\
+	     "=&r" (sl)							\
 	   : "0" ((USItype) (ah)),					\
 	     "g" ((USItype) (bh)),					\
 	     "1" ((USItype) (al)),					\
 	     "g" ((USItype) (bl)))
 #define umul_ppmm(w1, w0, u, v) \
   __asm__ ("mul{l} %3"							\
-	   : "=a" ((USItype) (w0)),					\
-	     "=d" ((USItype) (w1))					\
+	   : "=a" (w0),							\
+	     "=d" (w1)							\
 	   : "%0" ((USItype) (u)),					\
 	     "rm" ((USItype) (v)))
 #define udiv_qrnnd(q, r, n1, n0, dv) \
   __asm__ ("div{l} %4"							\
-	   : "=a" ((USItype) (q)),					\
-	     "=d" ((USItype) (r))					\
+	   : "=a" (q),							\
+	     "=d" (r)							\
 	   : "0" ((USItype) (n0)),					\
 	     "1" ((USItype) (n1)),					\
 	     "rm" ((USItype) (dv)))
@@ -492,30 +492,30 @@ extern UDItype __umulsidi3 (USItype, USItype);
 #if defined (__x86_64__) && W_TYPE_SIZE == 64
 #define add_ssaaaa(sh, sl, ah, al, bh, bl) \
   __asm__ ("add{q} {%5,%1|%1,%5}\n\tadc{q} {%3,%0|%0,%3}"		\
-	   : "=r" ((UDItype) (sh)),					\
-	     "=&r" ((UDItype) (sl))					\
+	   : "=r" (sh),							\
+	     "=&r" (sl)							\
 	   : "%0" ((UDItype) (ah)),					\
 	     "rme" ((UDItype) (bh)),					\
 	     "%1" ((UDItype) (al)),					\
 	     "rme" ((UDItype) (bl)))
 #define sub_ddmmss(sh, sl, ah, al, bh, bl) \
   __asm__ ("sub{q} {%5,%1|%1,%5}\n\tsbb{q} {%3,%0|%0,%3}"		\
-	   : "=r" ((UDItype) (sh)),					\
-	     "=&r" ((UDItype) (sl))					\
+	   : "=r" (sh),							\
+	     "=&r" (sl)							\
 	   : "0" ((UDItype) (ah)),					\
 	     "rme" ((UDItype) (bh)),					\
 	     "1" ((UDItype) (al)),					\
 	     "rme" ((UDItype) (bl)))
 #define umul_ppmm(w1, w0, u, v) \
   __asm__ ("mul{q} %3"							\
-	   : "=a" ((UDItype) (w0)),					\
-	     "=d" ((UDItype) (w1))					\
+	   : "=a" (w0),							\
+	     "=d" (w1)							\
 	   : "%0" ((UDItype) (u)),					\
 	     "rm" ((UDItype) (v)))
 #define udiv_qrnnd(q, r, n1, n0, dv) \
   __asm__ ("div{q} %4"							\
-	   : "=a" ((UDItype) (q)),					\
-	     "=d" ((UDItype) (r))					\
+	   : "=a" (q),							\
+	     "=d" (r)							\
 	   : "0" ((UDItype) (n0)),					\
 	     "1" ((UDItype) (n1)),					\
 	     "rm" ((UDItype) (dv)))
@@ -597,8 +597,8 @@ extern UDItype __umulsidi3 (USItype, USItype);
 #define add_ssaaaa(sh, sl, ah, al, bh, bl) \
   /* The cmp clears the condition bit.  */ \
   __asm__ ("cmp %0,%0\n\taddx %1,%5\n\taddx %0,%3"			\
-	   : "=r" ((USItype) (sh)),					\
-	     "=&r" ((USItype) (sl))					\
+	   : "=r" (sh),							\
+	     "=&r" (sl)							\
 	   : "0" ((USItype) (ah)),					\
 	     "r" ((USItype) (bh)),					\
 	     "1" ((USItype) (al)),					\
@@ -607,8 +607,8 @@ extern UDItype __umulsidi3 (USItype, USItype);
 #define sub_ddmmss(sh, sl, ah, al, bh, bl) \
   /* The cmp clears the condition bit.  */ \
   __asm__ ("cmp %0,%0\n\tsubx %1,%5\n\tsubx %0,%3"			\
-	   : "=r" ((USItype) (sh)),					\
-	     "=&r" ((USItype) (sl))					\
+	   : "=r" (sh),							\
+	     "=&r" (sl)							\
 	   : "0" ((USItype) (ah)),					\
 	     "r" ((USItype) (bh)),					\
 	     "1" ((USItype) (al)),					\
@@ -619,16 +619,16 @@ extern UDItype __umulsidi3 (USItype, USItype);
 #if defined (__mc68000__) && W_TYPE_SIZE == 32
 #define add_ssaaaa(sh, sl, ah, al, bh, bl) \
   __asm__ ("add%.l %5,%1\n\taddx%.l %3,%0"				\
-	   : "=d" ((USItype) (sh)),					\
-	     "=&d" ((USItype) (sl))					\
+	   : "=d" (sh),							\
+	     "=&d" (sl)							\
 	   : "%0" ((USItype) (ah)),					\
 	     "d" ((USItype) (bh)),					\
 	     "%1" ((USItype) (al)),					\
 	     "g" ((USItype) (bl)))
 #define sub_ddmmss(sh, sl, ah, al, bh, bl) \
   __asm__ ("sub%.l %5,%1\n\tsubx%.l %3,%0"				\
-	   : "=d" ((USItype) (sh)),					\
-	     "=&d" ((USItype) (sl))					\
+	   : "=d" (sh),							\
+	     "=&d" (sl)							\
 	   : "0" ((USItype) (ah)),					\
 	     "d" ((USItype) (bh)),					\
 	     "1" ((USItype) (al)),					\
@@ -638,23 +638,23 @@ extern UDItype __umulsidi3 (USItype, USItype);
 #if (defined (__mc68020__) && !defined (__mc68060__))
 #define umul_ppmm(w1, w0, u, v) \
   __asm__ ("mulu%.l %3,%1:%0"						\
-	   : "=d" ((USItype) (w0)),					\
-	     "=d" ((USItype) (w1))					\
+	   : "=d" (w0),							\
+	     "=d" (w1)							\
 	   : "%0" ((USItype) (u)),					\
 	     "dmi" ((USItype) (v)))
 #define UMUL_TIME 45
 #define udiv_qrnnd(q, r, n1, n0, d) \
   __asm__ ("divu%.l %4,%1:%0"						\
-	   : "=d" ((USItype) (q)),					\
-	     "=d" ((USItype) (r))					\
+	   : "=d" (q),							\
+	     "=d" (r)							\
 	   : "0" ((USItype) (n0)),					\
 	     "1" ((USItype) (n1)),					\
 	     "dmi" ((USItype) (d)))
 #define UDIV_TIME 90
 #define sdiv_qrnnd(q, r, n1, n0, d) \
   __asm__ ("divs%.l %4,%1:%0"						\
-	   : "=d" ((USItype) (q)),					\
-	     "=d" ((USItype) (r))					\
+	   : "=d" (q),							\
+	     "=d" (r)							\
 	   : "0" ((USItype) (n0)),					\
 	     "1" ((USItype) (n1)),					\
 	     "dmi" ((USItype) (d)))
@@ -688,8 +688,8 @@ extern UDItype __umulsidi3 (USItype, USItype);
 	   "	move%.l	%/d2,%1\n"					\
 	   "	add%.l	%/d1,%/d0\n"					\
 	   "	move%.l	%/d0,%0"					\
-	   : "=g" ((USItype) (xh)),					\
-	     "=g" ((USItype) (xl))					\
+	   : "=g" (xh),							\
+	     "=g" (xl)							\
 	   : "g" ((USItype) (a)),					\
 	     "g" ((USItype) (b))					\
 	   : "d0", "d1", "d2", "d3", "d4")
@@ -724,8 +724,8 @@ extern UDItype __umulsidi3 (USItype, USItype);
 	   "	move%.l	%/d2,%1\n"					\
 	   "	add%.l	%/d1,%/d0\n"					\
 	   "	move%.l	%/d0,%0"					\
-	   : "=g" ((USItype) (xh)),					\
-	     "=g" ((USItype) (xl))					\
+	   : "=g" (xh)),						\
+	     "=g" (xl)							\
 	   : "g" ((USItype) (a)),					\
 	     "g" ((USItype) (b))					\
 	   : "d0", "d1", "d2", "d3", "d4")
@@ -739,7 +739,7 @@ extern UDItype __umulsidi3 (USItype, USItype);
 #if defined (__mc68020__) && !defined (__mcpu32__)
 #define count_leading_zeros(count, x) \
   __asm__ ("bfffo %1{%b2:%b2},%0"					\
-	   : "=d" ((USItype) (count))					\
+	   : "=d" (count)						\
 	   : "od" ((USItype) (x)), "n" (0))
 /* Some ColdFire architectures have a ff1 instruction supported via
    __builtin_clz. */
@@ -752,16 +752,16 @@ extern UDItype __umulsidi3 (USItype, USItype);
 #if defined (__m88000__) && W_TYPE_SIZE == 32
 #define add_ssaaaa(sh, sl, ah, al, bh, bl) \
   __asm__ ("addu.co %1,%r4,%r5\n\taddu.ci %0,%r2,%r3"			\
-	   : "=r" ((USItype) (sh)),					\
-	     "=&r" ((USItype) (sl))					\
+	   : "=r" (sh),							\
+	     "=&r" (sl)							\
 	   : "%rJ" ((USItype) (ah)),					\
 	     "rJ" ((USItype) (bh)),					\
 	     "%rJ" ((USItype) (al)),					\
 	     "rJ" ((USItype) (bl)))
 #define sub_ddmmss(sh, sl, ah, al, bh, bl) \
   __asm__ ("subu.co %1,%r4,%r5\n\tsubu.ci %0,%r2,%r3"			\
-	   : "=r" ((USItype) (sh)),					\
-	     "=&r" ((USItype) (sl))					\
+	   : "=r" (sh),							\
+	     "=&r" (sl)							\
 	   : "rJ" ((USItype) (ah)),					\
 	     "rJ" ((USItype) (bh)),					\
 	     "rJ" ((USItype) (al)),					\
@@ -988,16 +988,16 @@ extern UDItype __umulsidi3 (USItype, USItype);
 #if defined (__ibm032__) /* RT/ROMP */ && W_TYPE_SIZE == 32
 #define add_ssaaaa(sh, sl, ah, al, bh, bl) \
   __asm__ ("a %1,%5\n\tae %0,%3"					\
-	   : "=r" ((USItype) (sh)),					\
-	     "=&r" ((USItype) (sl))					\
+	   : "=r" (sh),							\
+	     "=&r" (sl)							\
 	   : "%0" ((USItype) (ah)),					\
 	     "r" ((USItype) (bh)),					\
 	     "%1" ((USItype) (al)),					\
 	     "r" ((USItype) (bl)))
 #define sub_ddmmss(sh, sl, ah, al, bh, bl) \
   __asm__ ("s %1,%5\n\tse %0,%3"					\
-	   : "=r" ((USItype) (sh)),					\
-	     "=&r" ((USItype) (sl))					\
+	   : "=r" (sh),							\
+	     "=&r" (sl)							\
 	   : "0" ((USItype) (ah)),					\
 	     "r" ((USItype) (bh)),					\
 	     "1" ((USItype) (al)),					\
@@ -1026,8 +1026,8 @@ extern UDItype __umulsidi3 (USItype, USItype);
 "	m	r2,%3\n"						\
 "	cas	%0,r2,r0\n"						\
 "	mfs	r10,%1"							\
-	     : "=r" ((USItype) (ph)),					\
-	       "=r" ((USItype) (pl))					\
+	     : "=r" (ph),						\
+	       "=r" (pl)						\
 	     : "%r" (__m0),						\
 		"r" (__m1)						\
 	     : "r2");							\
@@ -1040,12 +1040,12 @@ extern UDItype __umulsidi3 (USItype, USItype);
   do {									\
     if ((x) >= 0x10000)							\
       __asm__ ("clz	%0,%1"						\
-	       : "=r" ((USItype) (count))				\
+	       : "=r" (count)						\
 	       : "r" ((USItype) (x) >> 16));				\
     else								\
       {									\
 	__asm__ ("clz	%0,%1"						\
-		 : "=r" ((USItype) (count))				\
+		 : "=r" (count)						\
 		 : "r" ((USItype) (x)));					\
 	(count) += 16;							\
       }									\
@@ -1107,8 +1107,8 @@ extern UDItype __umulsidi3 (USItype, USItype);
 #define umul_ppmm(w1, w0, u, v) \
   __asm__ (								\
        "dmulu.l	%2,%3\n\tsts%M1	macl,%1\n\tsts%M0	mach,%0"	\
-	   : "=r<" ((USItype)(w1)),					\
-	     "=r<" ((USItype)(w0))					\
+	   : "=r<" (w1),						\
+	     "=r<" (w0)							\
 	   : "r" ((USItype)(u)),					\
 	     "r" ((USItype)(v))						\
 	   : "macl", "mach")
@@ -1179,8 +1179,8 @@ extern UDItype __umulsidi3 (USItype, USItype);
     && W_TYPE_SIZE == 32
 #define add_ssaaaa(sh, sl, ah, al, bh, bl) \
   __asm__ ("addcc %r4,%5,%1\n\taddx %r2,%3,%0"				\
-	   : "=r" ((USItype) (sh)),					\
-	     "=&r" ((USItype) (sl))					\
+	   : "=r" (sh),							\
+	     "=&r" (sl)							\
 	   : "%rJ" ((USItype) (ah)),					\
 	     "rI" ((USItype) (bh)),					\
 	     "%rJ" ((USItype) (al)),					\
@@ -1188,8 +1188,8 @@ extern UDItype __umulsidi3 (USItype, USItype);
 	   __CLOBBER_CC)
 #define sub_ddmmss(sh, sl, ah, al, bh, bl) \
   __asm__ ("subcc %r4,%5,%1\n\tsubx %r2,%3,%0"				\
-	   : "=r" ((USItype) (sh)),					\
-	     "=&r" ((USItype) (sl))					\
+	   : "=r" (sh),							\
+	     "=&r" (sl)							\
 	   : "rJ" ((USItype) (ah)),					\
 	     "rI" ((USItype) (bh)),					\
 	     "rJ" ((USItype) (al)),					\
@@ -1201,7 +1201,7 @@ extern UDItype __umulsidi3 (USItype, USItype);
     register USItype __g1 asm ("g1");					\
     __asm__ ("umul\t%2,%3,%1\n\t"					\
 	     "srlx\t%1, 32, %0"						\
-	     : "=r" ((USItype) (w1)),					\
+	     : "=r" (w1),						\
 	       "=r" (__g1)						\
 	     : "r" ((USItype) (u)),					\
 	       "r" ((USItype) (v)));					\
@@ -1212,8 +1212,8 @@ extern UDItype __umulsidi3 (USItype, USItype);
 	   "udiv\t%3,%4,%0\n\t"						\
 	   "umul\t%0,%4,%1\n\t"						\
 	   "sub\t%3,%1,%1"						\
-	   : "=&r" ((USItype) (__q)),					\
-	     "=&r" ((USItype) (__r))					\
+	   : "=&r" (__q),						\
+	     "=&r" (__r)						\
 	   : "r" ((USItype) (__n1)),					\
 	     "r" ((USItype) (__n0)),					\
 	     "r" ((USItype) (__d)))
@@ -1221,14 +1221,14 @@ extern UDItype __umulsidi3 (USItype, USItype);
 #if defined (__sparc_v8__)
 #define umul_ppmm(w1, w0, u, v) \
   __asm__ ("umul %2,%3,%1;rd %%y,%0"					\
-	   : "=r" ((USItype) (w1)),					\
-	     "=r" ((USItype) (w0))					\
+	   : "=r" (w1),							\
+	     "=r" (w0)							\
 	   : "r" ((USItype) (u)),					\
 	     "r" ((USItype) (v)))
 #define udiv_qrnnd(__q, __r, __n1, __n0, __d) \
   __asm__ ("mov %2,%%y;nop;nop;nop;udiv %3,%4,%0;umul %0,%4,%1;sub %3,%1,%1"\
-	   : "=&r" ((USItype) (__q)),					\
-	     "=&r" ((USItype) (__r))					\
+	   : "=&r" (__q),						\
+	     "=&r" (__r)						\
 	   : "r" ((USItype) (__n1)),					\
 	     "r" ((USItype) (__n0)),					\
 	     "r" ((USItype) (__d)))
@@ -1238,8 +1238,8 @@ extern UDItype __umulsidi3 (USItype, USItype);
    instructions scan (ffs from high bit) and divscc.  */
 #define umul_ppmm(w1, w0, u, v) \
   __asm__ ("umul %2,%3,%1;rd %%y,%0"					\
-	   : "=r" ((USItype) (w1)),					\
-	     "=r" ((USItype) (w0))					\
+	   : "=r" (w1),							\
+	     "=r" (w0)							\
 	   : "r" ((USItype) (u)),					\
 	     "r" ((USItype) (v)))
 #define udiv_qrnnd(q, r, n1, n0, d) \
@@ -1282,8 +1282,8 @@ extern UDItype __umulsidi3 (USItype, USItype);
 "	bl,a 1f\n"							\
 "	add	%1,%4,%1\n"						\
 "1:	! End of inline udiv_qrnnd"					\
-	   : "=r" ((USItype) (q)),					\
-	     "=r" ((USItype) (r))					\
+	   : "=r" (q),							\
+	     "=r" (r)							\
 	   : "r" ((USItype) (n1)),					\
 	     "r" ((USItype) (n0)),					\
 	     "rI" ((USItype) (d))					\
@@ -1292,7 +1292,7 @@ extern UDItype __umulsidi3 (USItype, USItype);
 #define count_leading_zeros(count, x) \
   do {                                                                  \
   __asm__ ("scan %1,1,%0"                                               \
-	   : "=r" ((USItype) (count))                                   \
+	   : "=r" (count)                                   		\
 	   : "r" ((USItype) (x)));					\
   } while (0)
 /* Early sparclites return 63 for an argument of 0, but they warn that future
@@ -1342,8 +1342,8 @@ extern UDItype __umulsidi3 (USItype, USItype);
 "	mulscc	%%g1,0,%%g1\n"						\
 "	add	%%g1,%%o5,%0\n"						\
 "	rd	%%y,%1"							\
-	   : "=r" ((USItype) (w1)),					\
-	     "=r" ((USItype) (w0))					\
+	   : "=r" (w1),							\
+	     "=r" (w0)							\
 	   : "%rI" ((USItype) (u)),					\
 	     "r" ((USItype) (v))						\
 	   : "g1", "o5" __AND_CLOBBER_CC)
@@ -1375,8 +1375,8 @@ extern UDItype __umulsidi3 (USItype, USItype);
 "	sub	%1,%2,%1\n"						\
 "3:	xnor	%0,0,%0\n"						\
 "	! End of inline udiv_qrnnd"					\
-	   : "=&r" ((USItype) (__q)),					\
-	     "=&r" ((USItype) (__r))					\
+	   : "=&r" (__q),						\
+	     "=&r" (__r)						\
 	   : "r" ((USItype) (__d)),					\
 	     "1" ((USItype) (__n1)),					\
 	     "0" ((USItype) (__n0)) : "g1" __AND_CLOBBER_CC)
@@ -1395,8 +1395,8 @@ extern UDItype __umulsidi3 (USItype, USItype);
 	     "add\t%r3,%4,%0\n\t"					\
 	     "movcs\t%%xcc, 1, %2\n\t"					\
 	     "add\t%0, %2, %0"						\
-	     : "=r" ((UDItype)(sh)),				      	\
-	       "=&r" ((UDItype)(sl)),				      	\
+	     : "=r" (sh),				      		\
+	       "=&r" (sl),				      		\
 	       "+r" (__carry)				      		\
 	     : "%rJ" ((UDItype)(ah)),				     	\
 	       "rI" ((UDItype)(bh)),				      	\
@@ -1412,8 +1412,8 @@ extern UDItype __umulsidi3 (USItype, USItype);
 	     "sub\t%r3,%4,%0\n\t"					\
 	     "movcs\t%%xcc, 1, %2\n\t"					\
 	     "sub\t%0, %2, %0"						\
-	     : "=r" ((UDItype)(sh)),				      	\
-	       "=&r" ((UDItype)(sl)),				      	\
+	     : "=r" (sh),				      		\
+	       "=&r" (sl),				      		\
 	       "+r" (__carry)				      		\
 	     : "%rJ" ((UDItype)(ah)),				     	\
 	       "rI" ((UDItype)(bh)),				      	\
@@ -1447,8 +1447,8 @@ extern UDItype __umulsidi3 (USItype, USItype);
 		   "sllx %3,32,%3\n\t"					\
 		   "add %1,%3,%1\n\t"					\
 		   "add %5,%2,%0"					\
-	   : "=r" ((UDItype)(wh)),					\
-	     "=&r" ((UDItype)(wl)),					\
+	   : "=r" (wh),							\
+	     "=&r" (wl),						\
 	     "=&r" (tmp1), "=&r" (tmp2), "=&r" (tmp3), "=&r" (tmp4)	\
 	   : "r" ((UDItype)(u)),					\
 	     "r" ((UDItype)(v))						\
@@ -1461,16 +1461,16 @@ extern UDItype __umulsidi3 (USItype, USItype);
 #if defined (__vax__) && W_TYPE_SIZE == 32
 #define add_ssaaaa(sh, sl, ah, al, bh, bl) \
   __asm__ ("addl2 %5,%1\n\tadwc %3,%0"					\
-	   : "=g" ((USItype) (sh)),					\
-	     "=&g" ((USItype) (sl))					\
+	   : "=g" (sh)),						\
+	     "=&g" (sl)							\
 	   : "%0" ((USItype) (ah)),					\
 	     "g" ((USItype) (bh)),					\
 	     "%1" ((USItype) (al)),					\
 	     "g" ((USItype) (bl)))
 #define sub_ddmmss(sh, sl, ah, al, bh, bl) \
   __asm__ ("subl2 %5,%1\n\tsbwc %3,%0"					\
-	   : "=g" ((USItype) (sh)),					\
-	     "=&g" ((USItype) (sl))					\
+	   : "=g" (sh)),						\
+	     "=&g" (sl)							\
 	   : "0" ((USItype) (ah)),					\
 	     "g" ((USItype) (bh)),					\
 	     "1" ((USItype) (al)),					\
diff --git a/stdlib/monetary.h b/stdlib/monetary.h
index 0a908144..15066292 100644
--- a/stdlib/monetary.h
+++ b/stdlib/monetary.h
@@ -25,6 +25,7 @@
 #define __need_size_t
 #include <stddef.h>
 #include <bits/types.h>
+#include <bits/floatn.h>
 
 #ifndef	__ssize_t_defined
 typedef __ssize_t ssize_t;
@@ -35,28 +36,26 @@ typedef __ssize_t ssize_t;
 __BEGIN_DECLS
 
 /* Formatting a monetary value according to the current locale.  */
-extern ssize_t strfmon (char *__restrict __s, size_t __maxsize,
-			const char *__restrict __format, ...)
-     __THROW __attribute_format_strfmon__ (3, 4)
+extern ssize_t __REDIRECT_LDBL_NTH (strfmon, (char *__restrict __s, size_t __maxsize,
+					      const char *__restrict __format, ...),
+				    __strfmonieee128, __nldbl_strfmon)
+     __attribute_format_strfmon__ (3, 4)
      __attr_access ((__write_only__, 1, 2));
 
 #ifdef __USE_XOPEN2K8
 /* POSIX.1-2008 extended locale interface (see locale.h).  */
 # include <bits/types/locale_t.h>
 
-/* Formatting a monetary value according to the given locale.  */
-extern ssize_t strfmon_l (char *__restrict __s, size_t __maxsize,
-			  locale_t __loc,
-			  const char *__restrict __format, ...)
-     __THROW __attribute_format_strfmon__ (4, 5)
+extern ssize_t __REDIRECT_LDBL_NTH (strfmon_l, (char *__restrict __s,
+					       	size_t __maxsize,
+     						locale_t __loc,
+						const char *__restrict __format,
+					       	...),
+			       __strfmon_lieee128, __nldbl_strfmon_l)
+     __attribute_format_strfmon__ (4, 5)
      __attr_access ((__write_only__, 1, 2));
 #endif
 
-#include <bits/floatn.h>
-#if defined __LDBL_COMPAT || __LDOUBLE_REDIRECTS_TO_FLOAT128_ABI == 1
-# include <bits/monetary-ldbl.h>
-#endif
-
 __END_DECLS
 
 #endif	/* monetary.h */
diff --git a/stdlib/setenv.c b/stdlib/setenv.c
index 2176cbac..f7138e32 100644
--- a/stdlib/setenv.c
+++ b/stdlib/setenv.c
@@ -19,13 +19,6 @@
 # include <config.h>
 #endif
 
-/* Pacify GCC; see the commentary about VALLEN below.  This is needed
-   at least through GCC 4.9.2.  Pacify GCC for the entire file, as
-   there seems to be no way to pacify GCC selectively, only for the
-   place where it's needed.  Do not use DIAG_IGNORE_NEEDS_COMMENT
-   here, as it's not defined yet.  */
-#pragma GCC diagnostic ignored "-Wmaybe-uninitialized"
-
 #include <errno.h>
 #if !_LIBC
 # if !defined errno && !defined HAVE_ERRNO_DECL
diff --git a/stdlib/stdlib.h b/stdlib/stdlib.h
index bf7cd438..122cf95c 100644
--- a/stdlib/stdlib.h
+++ b/stdlib/stdlib.h
@@ -124,9 +124,10 @@ extern double strtod (const char *__restrict __nptr,
 extern float strtof (const char *__restrict __nptr,
 		     char **__restrict __endptr) __THROW __nonnull ((1));
 
-extern long double strtold (const char *__restrict __nptr,
-			    char **__restrict __endptr)
-     __THROW __nonnull ((1));
+extern long double __REDIRECT_LDBL_NTH (strtold, (const char *__restrict __nptr,
+						  char **__restrict __endptr),
+					__strtoieee128, strtod)
+     __nonnull ((1));
 #endif
 
 /* Likewise for '_FloatN' and '_FloatNx'.  */
@@ -218,9 +219,11 @@ extern int strfromf (char *__dest, size_t __size, const char *__format,
 		     float __f)
      __THROW __nonnull ((3));
 
-extern int strfroml (char *__dest, size_t __size, const char *__format,
-		     long double __f)
-     __THROW __nonnull ((3));
+extern int __REDIRECT_LDBL_NTH (strfroml, (char *__dest, size_t __size,
+					   const char *__format,
+					   long double __f),
+				__strfromieee128, strfromd)
+     __nonnull ((3));
 #endif
 
 #if __HAVE_FLOAT16 && __GLIBC_USE (IEC_60559_TYPES_EXT)
@@ -301,10 +304,11 @@ extern float strtof_l (const char *__restrict __nptr,
 		       char **__restrict __endptr, locale_t __loc)
      __THROW __nonnull ((1, 3));
 
-extern long double strtold_l (const char *__restrict __nptr,
-			      char **__restrict __endptr,
-			      locale_t __loc)
-     __THROW __nonnull ((1, 3));
+extern long double __REDIRECT_LDBL_NTH (strtold_l, (const char *__restrict __nptr,
+						    char **__restrict __endptr,
+						    locale_t __loc),
+					__strtoieee128_l, strtod_l)
+     __nonnull ((1, 3));
 
 # if __HAVE_FLOAT16
 extern _Float16 strtof16_l (const char *__restrict __nptr,
@@ -895,14 +899,20 @@ extern char *gcvt (double __value, int __ndigit, char *__buf)
 
 #ifdef __USE_MISC
 /* Long double versions of above functions.  */
-extern char *qecvt (long double __value, int __ndigit,
-		    int *__restrict __decpt, int *__restrict __sign)
-     __THROW __nonnull ((3, 4)) __wur;
-extern char *qfcvt (long double __value, int __ndigit,
-		    int *__restrict __decpt, int *__restrict __sign)
-     __THROW __nonnull ((3, 4)) __wur;
-extern char *qgcvt (long double __value, int __ndigit, char *__buf)
-     __THROW __nonnull ((3)) __wur;
+extern char * __REDIRECT_LDBL_NTH (qecvt, (long double __value, int __ndigit,
+					   int *__restrict __decpt,
+					   int *__restrict __sign),
+				   __qecvtieee128, ecvt)
+     __nonnull ((3, 4)) __wur;
+extern char * __REDIRECT_LDBL_NTH (qfcvt, (long double __value, int __ndigit,
+					   int *__restrict __decpt,
+					   int *__restrict __sign),
+				   __qfcvtieee128, fcvt)
+     __nonnull ((3, 4)) __wur;
+extern char * __REDIRECT_LDBL_NTH (qgcvt, (long double __value, int __ndigit,
+					   char *__buf),
+				   __qgcvtieee128, gcvt)
+     __nonnull ((3)) __wur;
 
 
 /* Reentrant version of the functions above which provide their own
@@ -914,14 +924,20 @@ extern int fcvt_r (double __value, int __ndigit, int *__restrict __decpt,
 		   int *__restrict __sign, char *__restrict __buf,
 		   size_t __len) __THROW __nonnull ((3, 4, 5));
 
-extern int qecvt_r (long double __value, int __ndigit,
-		    int *__restrict __decpt, int *__restrict __sign,
-		    char *__restrict __buf, size_t __len)
-     __THROW __nonnull ((3, 4, 5));
-extern int qfcvt_r (long double __value, int __ndigit,
-		    int *__restrict __decpt, int *__restrict __sign,
-		    char *__restrict __buf, size_t __len)
-     __THROW __nonnull ((3, 4, 5));
+extern int __REDIRECT_LDBL_NTH (qecvt_r, (long double __value, int __ndigit,
+					  int *__restrict __decpt,
+					  int *__restrict __sign,
+					  char *__restrict __buf,
+					  size_t __len),
+				__qecvtieee128_r, ecvt_r)
+     __nonnull ((3, 4, 5));
+extern int __REDIRECT_LDBL_NTH (qfcvt_r, (long double __value, int __ndigit,
+					  int *__restrict __decpt,
+					  int *__restrict __sign,
+					  char *__restrict __buf,
+					  size_t __len),
+				__qfcvtieee128_r, fcvt_r)
+     __nonnull ((3, 4, 5));
 #endif	/* misc */
 
 
@@ -1027,11 +1043,6 @@ extern int ttyslot (void) __THROW;
 # include <bits/stdlib.h>
 #endif
 
-#include <bits/floatn.h>
-#if defined __LDBL_COMPAT || __LDOUBLE_REDIRECTS_TO_FLOAT128_ABI == 1
-# include <bits/stdlib-ldbl.h>
-#endif
-
 __END_DECLS
 
 #endif /* stdlib.h  */
diff --git a/stdlib/strtod.c b/stdlib/strtod.c
index 98794f22..ce54584d 100644
--- a/stdlib/strtod.c
+++ b/stdlib/strtod.c
@@ -61,6 +61,8 @@
 
 #define INTERNAL(x) INTERNAL1(x)
 #define INTERNAL1(x) __##x##_internal
+#define DOUBLEUNDESCORE(x) DOUBLEUNDESCORE1(x)
+#define DOUBLEUNDESCORE1(x) __##x
 
 
 FLOAT
@@ -77,12 +79,13 @@ FLOAT
 #ifdef weak_function
 weak_function
 #endif
-STRTOF (const STRING_TYPE *nptr, STRING_TYPE **endptr)
+DOUBLEUNDESCORE (STRTOF) (const STRING_TYPE *nptr, STRING_TYPE **endptr)
 {
   return INTERNAL(STRTOF_L) (nptr, endptr, 0, _NL_CURRENT_LOCALE);
 }
 #if defined _LIBC
-libc_hidden_def (STRTOF)
+weak_alias (DOUBLEUNDESCORE (STRTOF), STRTOF)
+libc_hidden_def (DOUBLEUNDESCORE (STRTOF))
 #endif
 
 #ifdef LONG_DOUBLE_COMPAT
diff --git a/stdlib/strtol.c b/stdlib/strtol.c
index be7719f4..7e9611fb 100644
--- a/stdlib/strtol.c
+++ b/stdlib/strtol.c
@@ -106,4 +106,4 @@ __strtol (const STRING_TYPE *nptr, STRING_TYPE **endptr, int base)
   return INTERNAL (__strtol_l) (nptr, endptr, base, 0, _NL_CURRENT_LOCALE);
 }
 weak_alias (__strtol, strtol)
-libc_hidden_weak (strtol)
+libc_hidden_weak (__strtol)
diff --git a/stdlib/strtold.c b/stdlib/strtold.c
index a03620e3..34ed8da0 100644
--- a/stdlib/strtold.c
+++ b/stdlib/strtold.c
@@ -34,13 +34,13 @@
 #ifdef __LONG_DOUBLE_MATH_OPTIONAL
 # include <wchar.h>
 # define NEW(x) NEW1(x)
-# define NEW1(x) __new_##x
-long double ____new_strtold_internal (const char *, char **, int);
+# define NEW1(x) new_##x
+long double __new_strtold_internal (const char *, char **, int);
 long double __new_strtold (const char *, char **);
-long double ____new_wcstold_internal (const wchar_t *, wchar_t **, int);
+long double __new_wcstold_internal (const wchar_t *, wchar_t **, int);
 long double __new_wcstold (const wchar_t *, wchar_t **);
-libc_hidden_proto (____new_strtold_internal)
-libc_hidden_proto (____new_wcstold_internal)
+libc_hidden_proto (__new_strtold_internal)
+libc_hidden_proto (__new_wcstold_internal)
 libc_hidden_proto (__new_strtold)
 libc_hidden_proto (__new_wcstold)
 #else
@@ -63,12 +63,12 @@ libc_hidden_proto (__new_wcstold)
 # include <math_ldbl_opt.h>
 # ifdef USE_WIDE_CHAR
 long_double_symbol (libc, __new_wcstold, wcstold);
-long_double_symbol (libc, ____new_wcstold_internal, __wcstold_internal);
-libc_hidden_ver (____new_wcstold_internal, __wcstold_internal)
+long_double_symbol (libc, __new_wcstold_internal, __wcstold_internal);
+libc_hidden_ver (__new_wcstold_internal, __wcstold_internal)
 # else
 long_double_symbol (libc, __new_strtold, strtold);
-long_double_symbol (libc, ____new_strtold_internal, __strtold_internal);
-libc_hidden_ver (____new_strtold_internal, __strtold_internal)
+long_double_symbol (libc, __new_strtold_internal, __strtold_internal);
+libc_hidden_ver (__new_strtold_internal, __strtold_internal)
 # endif
 #endif
 
diff --git a/stdlib/tst-makecontext-align.c b/stdlib/tst-makecontext-align.c
index bb3fec15..1ec4594a 100644
--- a/stdlib/tst-makecontext-align.c
+++ b/stdlib/tst-makecontext-align.c
@@ -30,7 +30,7 @@ static const char *context;
 
 /* Check that ADDRESS is aligned to ALIGNMENT bytes, behind a compiler
    barrier.  */
-__attribute__ ((noinline, noclone, weak))
+__attribute__ ((noinline, weak)) __attribute_noclone__
 void
 check_align (void *address, size_t alignment)
 {
@@ -45,7 +45,7 @@ check_align (void *address, size_t alignment)
 
 /* Various alignment checking functions.  */
 
-__attribute__ ((noinline, noclone, weak))
+__attribute__ ((noinline, weak)) __attribute_noclone__
 void
 check_align_int (void)
 {
@@ -53,7 +53,7 @@ check_align_int (void)
   check_align (&a, __alignof__ (a));
 }
 
-__attribute__ ((noinline, noclone, weak))
+__attribute__ ((noinline, weak)) __attribute_noclone__
 void
 check_align_long (void)
 {
@@ -61,7 +61,7 @@ check_align_long (void)
   check_align (&a, __alignof__ (a));
 }
 
-__attribute__ ((noinline, noclone, weak))
+__attribute__ ((noinline, weak)) __attribute_noclone__
 void
 check_align_long_long (void)
 {
@@ -69,7 +69,7 @@ check_align_long_long (void)
   check_align (&a, __alignof__ (a));
 }
 
-__attribute__ ((noinline, noclone, weak))
+__attribute__ ((noinline, weak)) __attribute_noclone__
 void
 check_align_double (void)
 {
@@ -77,7 +77,7 @@ check_align_double (void)
   check_align (&a, __alignof__ (a));
 }
 
-__attribute__ ((noinline, noclone, weak))
+__attribute__ ((noinline, weak)) __attribute_noclone__
 void
 check_align_4 (void)
 {
@@ -85,7 +85,7 @@ check_align_4 (void)
   check_align (&a, 4);
 }
 
-__attribute__ ((noinline, noclone, weak))
+__attribute__ ((noinline, weak)) __attribute_noclone__
 void
 check_align_8 (void)
 {
@@ -93,7 +93,7 @@ check_align_8 (void)
   check_align (&a, 8);
 }
 
-__attribute__ ((noinline, noclone, weak))
+__attribute__ ((noinline, weak)) __attribute_noclone__
 void
 check_align_16 (void)
 {
@@ -105,7 +105,7 @@ check_align_16 (void)
   check_align (&a, 16);
 }
 
-__attribute__ ((noinline, noclone, weak))
+__attribute__ ((noinline, weak)) __attribute_noclone__
 void
 check_align_32 (void)
 {
@@ -120,7 +120,7 @@ check_align_32 (void)
 }
 
 /* Call all the alignment checking functions.  */
-__attribute__ ((noinline, noclone, weak))
+__attribute__ ((noinline, weak)) __attribute_noclone__
 void
 check_alignments (void)
 {
diff --git a/stdlib/tst-quick_exit.cc b/stdlib/tst-quick_exit.cc
index d59b6825..acc9dfd7 100644
--- a/stdlib/tst-quick_exit.cc
+++ b/stdlib/tst-quick_exit.cc
@@ -26,7 +26,7 @@ struct A
 thread_local A a;
 
 void
-__attribute__ ((noinline, noclone))
+__attribute__ ((noinline)) __attribute_noclone__
 optimization_barrier (A &)
 {
 }
diff --git a/stdlib/tst-setcontext5.c b/stdlib/tst-setcontext5.c
index 64f81a30..0a59df71 100644
--- a/stdlib/tst-setcontext5.c
+++ b/stdlib/tst-setcontext5.c
@@ -27,7 +27,7 @@ static volatile int done;
 static void f2 (void);
 
 static void
-__attribute__ ((noinline, noclone))
+__attribute__ ((noinline)) __attribute_noclone__
 f1 (void)
 {
   printf ("start f1\n");
@@ -35,7 +35,7 @@ f1 (void)
 }
 
 static void
-__attribute__ ((noinline, noclone))
+__attribute__ ((noinline)) __attribute_noclone__
 f2 (void)
 {
   printf ("start f2\n");
diff --git a/stdlib/tst-setcontext8.c b/stdlib/tst-setcontext8.c
index 82d5e89e..9046737d 100644
--- a/stdlib/tst-setcontext8.c
+++ b/stdlib/tst-setcontext8.c
@@ -26,7 +26,7 @@ static ucontext_t ctx[3];
 static atomic_int done;
 
 static void
-__attribute__((noinline, noclone))
+__attribute__((noinline)) __attribute_noclone__
 f2 (void)
 {
   printf ("start f2\n");
diff --git a/stdlib/tst-setcontext9.c b/stdlib/tst-setcontext9.c
index 23cf09d1..a05f0ffd 100644
--- a/stdlib/tst-setcontext9.c
+++ b/stdlib/tst-setcontext9.c
@@ -26,7 +26,7 @@ static ucontext_t ctx[5];
 static atomic_int done;
 
 static void
-__attribute__((noinline, noclone))
+__attribute__((noinline)) __attribute_noclone__
 f2 (void)
 {
   done++;
diff --git a/stdlib/tst-strtod5i.c b/stdlib/tst-strtod5i.c
index 6949e58f..6288f4db 100644
--- a/stdlib/tst-strtod5i.c
+++ b/stdlib/tst-strtod5i.c
@@ -16,6 +16,7 @@
    License along with the GNU C Library; if not, see
    <https://www.gnu.org/licenses/>.  */
 
+#define NO_MATH_REDIRECT
 #include <locale.h>
 #include <stdio.h>
 #include <stdlib.h>
diff --git a/stdlib/tst-swapcontext1.c b/stdlib/tst-swapcontext1.c
index 8850279e..a4170ae1 100644
--- a/stdlib/tst-swapcontext1.c
+++ b/stdlib/tst-swapcontext1.c
@@ -29,7 +29,7 @@ const char *fmt2 = "\e[34m";
 #define handle_error(msg) \
   do { perror(msg); exit(EXIT_FAILURE); } while (0)
 
-__attribute__((noinline, noclone))
+__attribute__((noinline)) __attribute_noclone__
 static void
 func4(ucontext_t *uocp, ucontext_t *ucp, const char *str, const char *fmt)
 {
@@ -39,7 +39,7 @@ func4(ucontext_t *uocp, ucontext_t *ucp, const char *str, const char *fmt)
   printf("      %sfunc4: returning\e[0m\n", fmt);
 }
 
-__attribute__((noinline, noclone))
+__attribute__((noinline)) __attribute_noclone__
 static void
 func3(ucontext_t *uocp, ucontext_t *ucp, const char *str, const char *fmt)
 {
@@ -48,7 +48,7 @@ func3(ucontext_t *uocp, ucontext_t *ucp, const char *str, const char *fmt)
   printf("    %sfunc3: returning\e[0m\n", fmt);
 }
 
-__attribute__((noinline, noclone))
+__attribute__((noinline)) __attribute_noclone__
 static void
 func1(void)
 {
@@ -59,7 +59,7 @@ func1(void)
     }
 }
 
-__attribute__((noinline, noclone))
+__attribute__((noinline)) __attribute_noclone__
 static void
 func2(void)
 {
diff --git a/stdlib/tst-thread-quick_exit.cc b/stdlib/tst-thread-quick_exit.cc
index 706d7b23..9e4ba0e2 100644
--- a/stdlib/tst-thread-quick_exit.cc
+++ b/stdlib/tst-thread-quick_exit.cc
@@ -30,7 +30,7 @@ thread_local A a1;
 thread_local A a2;
 
 void
-__attribute__ ((noinline, noclone))
+__attribute__ ((noinline)) __attribute_noclone__
 optimization_barrier (A &)
 {
 }
diff --git a/string/Makefile b/string/Makefile
index b65f6027..468d01c4 100644
--- a/string/Makefile
+++ b/string/Makefile
@@ -109,6 +109,15 @@ LDFLAGS-tst-xbzero-opt = -z now
 CFLAGS-memcpy.c += $(no-stack-protector)
 CFLAGS-wordcopy.c += $(no-stack-protector)
 
+CFLAGS-argz-next.c += $(config-cflags-wno-ignored-attributes)
+CFLAGS-basename.c += $(config-cflags-wno-ignored-attributes)
+CFLAGS-ffs.c += $(config-cflags-wno-ignored-attributes)
+CFLAGS-memchr.c += $(config-cflags-wno-ignored-attributes)
+CFLAGS-memmem.c += $(config-cflags-wno-ignored-attributes)
+CFLAGS-mempcpy.c += $(config-cflags-wno-ignored-attributes)
+CFLAGS-stpcpy.c += $(config-cflags-wno-ignored-attributes)
+CFLAGS-strnlen.c += $(config-cflags-wno-ignored-attributes)
+
 ifeq ($(run-built-tests),yes)
 $(objpfx)tst-svc-cmp.out: tst-svc.expect $(objpfx)tst-svc.out
 	cmp $^ > $@; \
diff --git a/string/memset.c b/string/memset.c
index 1303dd7a..b98bad70 100644
--- a/string/memset.c
+++ b/string/memset.c
@@ -88,3 +88,4 @@ MEMSET (void *dstpp, int c, size_t len)
   return dstpp;
 }
 libc_hidden_builtin_def (MEMSET)
+strong_alias (MEMSET, __memset_generic)
diff --git a/string/tester.c b/string/tester.c
index 5a397055..46a24e74 100644
--- a/string/tester.c
+++ b/string/tester.c
@@ -370,28 +370,48 @@ test_strncat (void)
      mechanism.  */
   it = "strncat";
   (void) strcpy (one, "ijk");
+  /* clang complains that size argument is too large for the destination
+     buffer.  */
+  DIAG_PUSH_NEEDS_COMMENT_CLANG;
+  DIAG_IGNORE_NEEDS_COMMENT_CLANG (13, "-Wfortify-source");
   check (strncat (one, "lmn", 99) == one, 1);	/* Returned value. */
+  DIAG_POP_NEEDS_COMMENT_CLANG;
   equal (one, "ijklmn", 2);		/* Basic test. */
 
   (void) strcpy (one, "x");
+  DIAG_PUSH_NEEDS_COMMENT_CLANG;
+  DIAG_IGNORE_NEEDS_COMMENT_CLANG (13, "-Wfortify-source");
   (void) strncat (one, "yz", 99);
+  DIAG_POP_NEEDS_COMMENT_CLANG;
   equal (one, "xyz", 3);		/* Writeover. */
   equal (one+4, "mn", 4);		/* Wrote too much? */
 
   (void) strcpy (one, "gh");
   (void) strcpy (two, "ef");
+  DIAG_PUSH_NEEDS_COMMENT_CLANG;
+  DIAG_IGNORE_NEEDS_COMMENT_CLANG (13, "-Wfortify-source");
   (void) strncat (one, two, 99);
+  DIAG_POP_NEEDS_COMMENT_CLANG;
   equal (one, "ghef", 5);			/* Basic test encore. */
   equal (two, "ef", 6);			/* Stomped on source? */
 
   (void) strcpy (one, "");
+  DIAG_PUSH_NEEDS_COMMENT_CLANG;
+  DIAG_IGNORE_NEEDS_COMMENT_CLANG (13, "-Wfortify-source");
   (void) strncat (one, "", 99);
+  DIAG_POP_NEEDS_COMMENT_CLANG;
   equal (one, "", 7);			/* Boundary conditions. */
   (void) strcpy (one, "ab");
+  DIAG_PUSH_NEEDS_COMMENT_CLANG;
+  DIAG_IGNORE_NEEDS_COMMENT_CLANG (13, "-Wfortify-source");
   (void) strncat (one, "", 99);
+  DIAG_POP_NEEDS_COMMENT_CLANG;
   equal (one, "ab", 8);
   (void) strcpy (one, "");
+  DIAG_PUSH_NEEDS_COMMENT_CLANG;
+  DIAG_IGNORE_NEEDS_COMMENT_CLANG (13, "-Wfortify-source");
   (void) strncat (one, "cd", 99);
+  DIAG_POP_NEEDS_COMMENT_CLANG;
   equal (one, "cd", 9);
 
   (void) strcpy (one, "ab");
@@ -404,7 +424,10 @@ test_strncat (void)
   (void) strncat (one, "gh", 2);
   equal (one, "abcdgh", 12);		/* Count and length equal. */
 
+  DIAG_PUSH_NEEDS_COMMENT_CLANG;
+  DIAG_IGNORE_NEEDS_COMMENT_CLANG (13, "-Wfortify-source");
   (void) strncat (one, "ij", (size_t)-1);	/* set sign bit in count */
+  DIAG_POP_NEEDS_COMMENT_CLANG;
   equal (one, "abcdghij", 13);
 
   int ntest = 14;
@@ -1408,7 +1431,12 @@ test_bzero (void)
   equal(one+4, "ef", 3);
 
   (void) strcpy(one, "abcdef");
+
+  DIAG_PUSH_NEEDS_COMMENT_CLANG;
+  /* clang complains about the 0 size argument for bzero.  */
+  DIAG_IGNORE_NEEDS_COMMENT_CLANG (13, "-Wsuspicious-bzero");
   bzero(one+2, 0);
+  DIAG_POP_NEEDS_COMMENT_CLANG
   equal(one, "abcdef", 4);		/* Zero-length copy. */
 }
 
@@ -1647,7 +1675,7 @@ main (void)
   else
     {
       status = EXIT_FAILURE;
-      printf("%Zd errors.\n", errors);
+      printf("%zd errors.\n", errors);
     }
 
   return status;
diff --git a/string/tst-xbzero-opt.c b/string/tst-xbzero-opt.c
index 64993d7a..c6fefd3a 100644
--- a/string/tst-xbzero-opt.c
+++ b/string/tst-xbzero-opt.c
@@ -97,7 +97,8 @@ static const unsigned char test_pattern[16] =
 
 static ucontext_t uc_main, uc_co;
 
-static __attribute__ ((noinline, noclone)) int
+static __attribute__ ((noinline)) __attribute_noclone__
+int
 use_test_buffer (unsigned char *buf)
 {
   unsigned int sum = 0;
diff --git a/sunrpc/clnt_udp.c b/sunrpc/clnt_udp.c
index ee79b09b..4353e5da 100644
--- a/sunrpc/clnt_udp.c
+++ b/sunrpc/clnt_udp.c
@@ -299,7 +299,7 @@ clntudp_call (/* client handle */
      inet/net-internal.h because in some other configurations GCC
      gives the warning in an inline function.  */
   DIAG_PUSH_NEEDS_COMMENT;
-  DIAG_IGNORE_NEEDS_COMMENT (10, "-Wmaybe-uninitialized");
+  DIAG_IGNORE_NEEDS_COMMENT_GCC (10, "-Wmaybe-uninitialized");
   struct deadline total_deadline; /* Determined once by overall timeout.  */
   DIAG_POP_NEEDS_COMMENT;
   struct deadline response_deadline; /* Determined anew for each query.  */
diff --git a/sunrpc/key_call.c b/sunrpc/key_call.c
index 8ea4303d..584e27fd 100644
--- a/sunrpc/key_call.c
+++ b/sunrpc/key_call.c
@@ -456,7 +456,7 @@ getkeyserv_handle (int vers)
       return kcp->client;
     }
 
-  if ((kcp->client == (CLIENT *) NULL))
+  if (kcp->client == (CLIENT *) NULL)
     /* Use the AF_UNIX transport */
     kcp->client = clnt_create ("/var/run/keyservsock", KEY_PROG, vers, "unix");
 
diff --git a/sunrpc/netname.c b/sunrpc/netname.c
index bf7f0b81..97a881c3 100644
--- a/sunrpc/netname.c
+++ b/sunrpc/netname.c
@@ -48,7 +48,7 @@ user2netname (char netname[MAXNETNAMELEN + 1], const uid_t uid,
   if ((strlen (dfltdom) + OPSYS_LEN + 3 + MAXIPRINT) > (size_t) MAXNETNAMELEN)
     return 0;
 
-  sprintf (netname, "%s.%d@%s", OPSYS, uid, dfltdom);
+  __sprintf (netname, "%s.%d@%s", OPSYS, uid, dfltdom);
   i = strlen (netname);
   if (netname[i - 1] == '.')
     netname[i - 1] = '\0';
@@ -112,7 +112,7 @@ host2netname (char netname[MAXNETNAMELEN + 1], const char *host,
       > MAXNETNAMELEN)
     return 0;
 
-  sprintf (netname, "%s.%s@%s", OPSYS, hostname, domainname);
+  __sprintf (netname, "%s.%s@%s", OPSYS, hostname, domainname);
   return 1;
 }
 #ifdef EXPORT_RPC_SYMBOLS
diff --git a/sunrpc/svc_unix.c b/sunrpc/svc_unix.c
index 67177a2e..8b136f48 100644
--- a/sunrpc/svc_unix.c
+++ b/sunrpc/svc_unix.c
@@ -65,6 +65,7 @@
 #include <libintl.h>
 #include <wchar.h>
 #include <shlib-compat.h>
+#include <libc-diag.h>
 
 /*
  * Ops vector for AF_UNIX based rpc service handle
@@ -308,12 +309,18 @@ svcunix_destroy (SVCXPRT *xprt)
 }
 
 #ifdef SCM_CREDENTIALS
+/* clang complains if a flexible array member (struct cmsghdr) is not a the
+   end of the struct (since it is a GNU extension).  The __msgread explicit
+   expects that 'struct ucred' is after the 'cmsg', so disable the warning.  */
+DIAG_PUSH_NEEDS_COMMENT_CLANG;
+DIAG_IGNORE_NEEDS_COMMENT_CLANG (13, "-Wgnu-variable-sized-type-not-at-end");
 struct cmessage {
   struct cmsghdr cmsg;
   struct ucred cmcred;
   /* hack to make sure we have enough memory */
   char dummy[(CMSG_ALIGN (sizeof (struct ucred)) - sizeof (struct ucred) + sizeof (long))];
 };
+DIAG_POP_NEEDS_COMMENT_CLANG;
 
 /* XXX This is not thread safe, but since the main functions in svc.c
    and the rpcgen generated *_svc functions for the daemon are also not
diff --git a/support/Makefile b/support/Makefile
index 5ddcb8d1..1a157eea 100644
--- a/support/Makefile
+++ b/support/Makefile
@@ -232,8 +232,8 @@ CFLAGS-support_paths.c = \
 # being withing the observed range.  The code uses double internally
 # in support_timespec_check_in_range and for that computation we use
 # -fexcess-precision=standard.
-CFLAGS-timespec.c += -fexcess-precision=standard
-CFLAGS-timespec-time64.c += -fexcess-precision=standard
+CFLAGS-timespec.c += $(config-cflags-fexcess-precision-standard)
+CFLAGS-timespec-time64.c += $(config-cflags-fexcess-precision-standard)
 
 ifeq (,$(CXX))
 LINKS_DSO_PROGRAM = links-dso-program-c
diff --git a/support/support_format_dns_packet.c b/support/support_format_dns_packet.c
index 8ed23460..e8b3c125 100644
--- a/support/support_format_dns_packet.c
+++ b/support/support_format_dns_packet.c
@@ -31,17 +31,6 @@ struct in_buffer
   size_t size;
 };
 
-static inline bool
-extract_8 (struct in_buffer *in, unsigned char *value)
-{
-  if (in->size == 0)
-    return false;
-  *value = in->data[0];
-  ++in->data;
-  --in->size;
-  return true;
-}
-
 static inline bool
 extract_16 (struct in_buffer *in, unsigned short *value)
 {
diff --git a/support/support_process_state.c b/support/support_process_state.c
index 0dc608b4..ab02ce9e 100644
--- a/support/support_process_state.c
+++ b/support/support_process_state.c
@@ -21,6 +21,7 @@
 #include <string.h>
 
 #include <array_length.h>
+#include <intprops.h>
 
 #include <support/process_state.h>
 #include <support/xstdio.h>
@@ -49,7 +50,7 @@ support_process_state_wait (pid_t pid, enum support_process_state state)
     { support_process_state_parked,       'P' },
   };
 
-  char spath[sizeof ("/proc/" + 3) * sizeof (pid_t) + sizeof ("/status") + 1];
+  char spath[sizeof ("/proc/") + INT_STRLEN_BOUND (pid_t) + sizeof ("/status") + 1];
   snprintf (spath, sizeof (spath), "/proc/%i/status", pid);
 
   FILE *fstatus = xfopen (spath, "r");
@@ -58,7 +59,7 @@ support_process_state_wait (pid_t pid, enum support_process_state state)
 
   for (;;)
     {
-      char cur_state = -1;
+      char cur_state = CHAR_MAX;
       while (xgetline (&line, &linesiz, fstatus) > 0)
 	if (strncmp (line, "State:", strlen ("State:")) == 0)
 	  {
@@ -66,7 +67,7 @@ support_process_state_wait (pid_t pid, enum support_process_state state)
 	    break;
 	  }
       /* Fallback to nanosleep for invalid state.  */
-      if (cur_state == -1)
+      if (cur_state == CHAR_MAX)
 	break;
 
       for (size_t i = 0; i < array_length (process_states); ++i)
diff --git a/support/tst-timespec.c b/support/tst-timespec.c
index 648a990e..b3cbb866 100644
--- a/support/tst-timespec.c
+++ b/support/tst-timespec.c
@@ -20,6 +20,7 @@
 #include <support/check.h>
 #include <limits.h>
 #include <intprops.h>
+#include <libc-diag.h>
 
 #define TIMESPEC_HZ 1000000000
 
@@ -179,6 +180,11 @@ struct timespec_norm_test_case norm_cases[] = {
   }
 };
 
+/* clang warns that converting from TIME_T_MAX to double (upper_bound)
+   loses precision (from 9223372036854775807 to 9223372036854775808).
+   It does not matter in tests below.  */
+DIAG_PUSH_NEEDS_COMMENT_CLANG;
+DIAG_IGNORE_NEEDS_COMMENT_CLANG (13, "-Wimplicit-const-int-float-conversion");
 /* Test cases for timespec_check_in_range  */
 struct timespec_test_case check_cases[] = {
   /* 0 - In range  */
@@ -290,6 +296,7 @@ struct timespec_test_case check_cases[] = {
    .upper_bound = TIME_T_MAX, .lower_bound = 1, .result = 1,
   },
 };
+DIAG_POP_NEEDS_COMMENT_CLANG;
 
 static int
 do_test (void)
diff --git a/sysdeps/aarch64/Makefile b/sysdeps/aarch64/Makefile
index 7183895d..f5367e01 100644
--- a/sysdeps/aarch64/Makefile
+++ b/sysdeps/aarch64/Makefile
@@ -56,6 +56,7 @@ endif
 
 ifeq ($(subdir),math)
 CPPFLAGS += -I../soft-fp
+CFLAGS-feupdateenv.c += $(config-cflags-wno-ignored-attributes)
 endif
 
 ifeq ($(subdir),misc)
diff --git a/sysdeps/aarch64/fpu/fpu_control.h b/sysdeps/aarch64/fpu/fpu_control.h
index 764ed5cd..8c1746ba 100644
--- a/sysdeps/aarch64/fpu/fpu_control.h
+++ b/sysdeps/aarch64/fpu/fpu_control.h
@@ -29,17 +29,31 @@
 # define _FPU_GETFPSR(fpsr) (fpsr = __builtin_aarch64_get_fpsr ())
 # define _FPU_SETFPSR(fpsr) __builtin_aarch64_set_fpsr (fpsr)
 #else
-# define _FPU_GETCW(fpcr) \
-  __asm__ __volatile__ ("mrs	%0, fpcr" : "=r" (fpcr))
-
-# define _FPU_SETCW(fpcr) \
-  __asm__ __volatile__ ("msr	fpcr, %0" : : "r" (fpcr))
-
-# define _FPU_GETFPSR(fpsr) \
-  __asm__ __volatile__ ("mrs	%0, fpsr" : "=r" (fpsr))
-
-# define _FPU_SETFPSR(fpsr) \
-  __asm__ __volatile__ ("msr	fpsr, %0" : : "r" (fpsr))
+# define _FPU_GETCW(fpcr)					\
+  ({ 								\
+   unsigned long int __fpcr;					\
+   __asm__ __volatile__ ("mrs	%0, fpcr" : "=r" (__fpcr));	\
+   fpcr = __fpcr;						\
+  })
+
+# define _FPU_SETCW(fpcr)					\
+  ({								\
+   unsigned long int __fpcr = fpcr;				\
+   __asm__ __volatile__ ("msr	fpcr, %0" : : "r" (__fpcr));    \
+  })
+
+# define _FPU_GETFPSR(fpsr)					\
+  ({								\
+   unsigned long int __fpsr;					\
+   __asm__ __volatile__ ("mrs	%0, fpsr" : "=r" (__fpsr));	\
+   fpsr = __fpsr;						\
+  })
+
+# define _FPU_SETFPSR(fpsr)					\
+  ({								\
+   unsigned long int __fpsr = fpsr;				\
+   __asm__ __volatile__ ("msr	fpsr, %0" : : "r" (__fpsr));    \
+  })
 #endif
 
 /* Reserved bits should be preserved when modifying register
diff --git a/sysdeps/aarch64/fpu/fraiseexcpt.c b/sysdeps/aarch64/fpu/fraiseexcpt.c
index bda61444..2a983076 100644
--- a/sysdeps/aarch64/fpu/fraiseexcpt.c
+++ b/sysdeps/aarch64/fpu/fraiseexcpt.c
@@ -23,7 +23,7 @@
 int
 __feraiseexcept (int excepts)
 {
-  int fpsr;
+  unsigned long int fpsr;
   const float fp_zero = 0.0;
   const float fp_one = 1.0;
   const float fp_max = FLT_MAX;
diff --git a/sysdeps/aarch64/nptl/tls.h b/sysdeps/aarch64/nptl/tls.h
index 8d62b31e..3e91f5df 100644
--- a/sysdeps/aarch64/nptl/tls.h
+++ b/sysdeps/aarch64/nptl/tls.h
@@ -72,7 +72,7 @@ typedef struct
    special attention since 'errno' is not yet available and if the
    operation can cause a failure 'errno' must not be touched.  */
 # define TLS_INIT_TP(tcbp) \
-  ({ __asm __volatile ("msr tpidr_el0, %0" : : "r" (tcbp)); NULL; })
+  ({ __asm __volatile ("msr tpidr_el0, %0" : : "r" (tcbp)); true; })
 
 /* Value passed to 'clone' for initialization of the thread register.  */
 # define TLS_DEFINE_INIT_TP(tp, pd) void *tp = (pd) + 1
diff --git a/sysdeps/aarch64/sfp-machine.h b/sysdeps/aarch64/sfp-machine.h
index a9ecdbf9..b4b34e98 100644
--- a/sysdeps/aarch64/sfp-machine.h
+++ b/sysdeps/aarch64/sfp-machine.h
@@ -74,7 +74,7 @@ do {						\
     const float fp_1e32 = 1.0e32f;					\
     const float fp_zero = 0.0;						\
     const float fp_one = 1.0;						\
-    unsigned fpsr;							\
+    unsigned long int fpsr;						\
     if (_fex & FP_EX_INVALID)						\
       {									\
         __asm__ __volatile__ ("fdiv\ts0, %s0, %s0"			\
diff --git a/sysdeps/aarch64/tlsdesc.sym b/sysdeps/aarch64/tlsdesc.sym
index a06a7197..477585bd 100644
--- a/sysdeps/aarch64/tlsdesc.sym
+++ b/sysdeps/aarch64/tlsdesc.sym
@@ -15,4 +15,4 @@ TLSDESC_MODID		offsetof(struct tlsdesc_dynamic_arg, tlsinfo.ti_module)
 TLSDESC_MODOFF		offsetof(struct tlsdesc_dynamic_arg, tlsinfo.ti_offset)
 TCBHEAD_DTV		offsetof(tcbhead_t, dtv)
 DTV_COUNTER		offsetof(dtv_t, counter)
-TLS_DTV_UNALLOCATED	TLS_DTV_UNALLOCATED
+TLS_DTV_UNALLOCATED	TLS_DTV_UNALLOCATED_VALUE
diff --git a/sysdeps/aarch64/tst-vpcs-mod.S b/sysdeps/aarch64/tst-vpcs-mod.S
index eac0074e..bb4a4651 100644
--- a/sysdeps/aarch64/tst-vpcs-mod.S
+++ b/sysdeps/aarch64/tst-vpcs-mod.S
@@ -17,9 +17,9 @@
    License along with the GNU C Library.  If not, see
    <https://www.gnu.org/licenses/>.  */
 
-	.variant_pcs	vpcs_call
 	.global	vpcs_call
 	.type	vpcs_call, %function
+	.variant_pcs	vpcs_call
 vpcs_call:
 	.cfi_startproc
 	hint	34 /* bti c.  */
diff --git a/sysdeps/alpha/memset.S b/sysdeps/alpha/memset.S
index 9249663d..c5adae75 100644
--- a/sysdeps/alpha/memset.S
+++ b/sysdeps/alpha/memset.S
@@ -124,3 +124,4 @@ $done:	ret
 
 	cfi_endproc
 libc_hidden_builtin_def (memset)
+strong_alias (memset, __memset_generic)
diff --git a/sysdeps/alpha/nptl/tls.h b/sysdeps/alpha/nptl/tls.h
index ddf7de07..b3d5699d 100644
--- a/sysdeps/alpha/nptl/tls.h
+++ b/sysdeps/alpha/nptl/tls.h
@@ -69,7 +69,7 @@ typedef struct
    special attention since 'errno' is not yet available and if the
    operation can cause a failure 'errno' must not be touched.  */
 # define TLS_INIT_TP(tcbp) \
-  (__builtin_set_thread_pointer ((void *)(tcbp)), NULL)
+  ({ __builtin_set_thread_pointer ((void *)(tcbp)), true; })
 
 /* Value passed to 'clone' for initialization of the thread register.  */
 # define TLS_DEFINE_INIT_TP(tp, pd) void *tp = (pd) + 1
diff --git a/sysdeps/arc/dl-tls.h b/sysdeps/arc/dl-tls.h
index 56ed58fd..a6d652df 100644
--- a/sysdeps/arc/dl-tls.h
+++ b/sysdeps/arc/dl-tls.h
@@ -27,4 +27,4 @@ typedef struct
 extern void *__tls_get_addr (tls_index *ti);
 
 /* Value used for dtv entries for which the allocation is delayed.  */
-#define TLS_DTV_UNALLOCATED	((void *) -1l)
+#define TLS_DTV_UNALLOCATED_VALE -1l
diff --git a/sysdeps/arc/nptl/tls.h b/sysdeps/arc/nptl/tls.h
index 15adfc94..31c83494 100644
--- a/sysdeps/arc/nptl/tls.h
+++ b/sysdeps/arc/nptl/tls.h
@@ -75,8 +75,7 @@ typedef struct
 	long result_var;					\
 	__builtin_set_thread_pointer (tcbp);     		\
 	result_var = INTERNAL_SYSCALL_CALL (arc_settls, (tcbp));\
-	INTERNAL_SYSCALL_ERROR_P (result_var)			\
-	  ? "settls syscall error" : NULL;			\
+	INTERNAL_SYSCALL_ERROR_P (result_var);			\
    })
 
 /* Value passed to 'clone' for initialization of the thread register.  */
diff --git a/sysdeps/arm/memset.S b/sysdeps/arm/memset.S
index 9c056698..9b9a3cb2 100644
--- a/sysdeps/arm/memset.S
+++ b/sysdeps/arm/memset.S
@@ -66,3 +66,4 @@ ENTRY(memset)
 	DO_RET(lr)
 END(memset)
 libc_hidden_builtin_def (memset)
+strong_alias (memset, __memset_generic)
diff --git a/sysdeps/csky/abiv2/memset.S b/sysdeps/csky/abiv2/memset.S
index 41df8e2b..7e23edc7 100644
--- a/sysdeps/csky/abiv2/memset.S
+++ b/sysdeps/csky/abiv2/memset.S
@@ -96,3 +96,4 @@ END (memset)
 
 libc_hidden_builtin_def (memset)
 .weak memset
+strong_alias (memset, __memset_generic)
diff --git a/sysdeps/csky/nptl/tls.h b/sysdeps/csky/nptl/tls.h
index cd135d54..4e1f50a6 100644
--- a/sysdeps/csky/nptl/tls.h
+++ b/sysdeps/csky/nptl/tls.h
@@ -92,8 +92,7 @@ typedef struct
   ({ long int result_var;						\
      result_var = INTERNAL_SYSCALL_CALL (set_thread_area, 		\
                     (char *) (tcbp) + TLS_TCB_OFFSET);			\
-     INTERNAL_SYSCALL_ERROR_P (result_var)				\
-       ? "unknown error" : NULL; })
+     INTERNAL_SYSCALL_ERROR_P (result_var); })
 
 /* Return the address of the dtv for the current thread.  */
 # define THREAD_DTV() \
diff --git a/sysdeps/generic/dl-dtv.h b/sysdeps/generic/dl-dtv.h
index 3fa85bad..82aa3caf 100644
--- a/sysdeps/generic/dl-dtv.h
+++ b/sysdeps/generic/dl-dtv.h
@@ -33,6 +33,6 @@ typedef union dtv
 } dtv_t;
 
 /* Value used for dtv entries for which the allocation is delayed.  */
-#define TLS_DTV_UNALLOCATED ((void *) -1l)
+#define TLS_DTV_UNALLOCATED_VALUE -1l
 
 #endif /* _DLT_DTV_H */
diff --git a/sysdeps/generic/ldsodefs.h b/sysdeps/generic/ldsodefs.h
index 2ebe7901..be1c5348 100644
--- a/sysdeps/generic/ldsodefs.h
+++ b/sysdeps/generic/ldsodefs.h
@@ -27,6 +27,7 @@
 #include <stddef.h>
 #include <string.h>
 #include <stdint.h>
+#include <stdarg.h>
 
 #include <elf.h>
 #include <dlfcn.h>
@@ -835,9 +836,15 @@ __attribute__ ((always_inline, __format__ (__printf__, 2, 3)))
 static inline void
 _dl_dprintf (int fd, const char *fmt, ...)
 {
-  /* Use local declaration to avoid includign <stdio.h>.  */
-  extern int __dprintf(int fd, const char *format, ...) attribute_hidden;
-  __dprintf (fd, fmt, __builtin_va_arg_pack ());
+  /* In the absence of __builtin_va_arg_pack, use varargs macros to construct a
+     direct call to the stdio function that __dprintf eventually gets to.  This
+     is not a robust hack, will break if stdio changes much.  */
+  extern int _IO_vdprintf (int d, const char *format, va_list arg);
+  va_list arg;
+
+  va_start (arg, fmt);
+  _IO_vdprintf (fd, fmt, arg);
+  va_end (arg);
 }
 #endif
 
diff --git a/sysdeps/generic/math-type-macros.h b/sysdeps/generic/math-type-macros.h
index df585252..98cbb681 100644
--- a/sysdeps/generic/math-type-macros.h
+++ b/sysdeps/generic/math-type-macros.h
@@ -109,7 +109,7 @@
 
 /* Helper macros for commonly used functions.  */
 #define M_COPYSIGN M_SUF (copysign)
-#define M_FABS M_SUF (fabs)
+#define M_FABS M_SUF (__fabs)
 #define M_SINCOS M_SUF (__sincos)
 #define M_SCALBN M_SUF (__scalbn)
 #define M_LOG1P M_SUF (__log1p)
diff --git a/sysdeps/generic/symbol-hacks.h b/sysdeps/generic/symbol-hacks.h
index 1115e4c0..560116d5 100644
--- a/sysdeps/generic/symbol-hacks.h
+++ b/sysdeps/generic/symbol-hacks.h
@@ -6,6 +6,13 @@ asm ("memmove = __GI_memmove");
 asm ("memset = __GI_memset");
 asm ("memcpy = __GI_memcpy");
 
+/* clang might generate an abort call when cleanup functions (set by
+   __attribute__ ((cleanup)) calls functions not marked as nothrow.
+   We can mitigate by marking some internal functions as __THROW,
+   but it is not possible for functions that issue used-provided
+   callbacks (for instance pthread_once).  */
+asm ("abort = __GI_abort");
+
 /* Some targets do not use __stack_chk_fail_local.  In libc.so,
    redirect __stack_chk_fail to a hidden reference
    __stack_chk_fail_local, to avoid the PLT reference.
diff --git a/sysdeps/generic/tst-stack-align.h b/sysdeps/generic/tst-stack-align.h
index 91a5cd72..96f309ee 100644
--- a/sysdeps/generic/tst-stack-align.h
+++ b/sysdeps/generic/tst-stack-align.h
@@ -20,7 +20,7 @@
 #include <stdint.h>
 
 int
-__attribute__ ((weak, noclone, noinline))
+__attribute__ ((weak, noinline)) __attribute_noclone__
 is_aligned (void *p, int align)
 {
   return (((uintptr_t) p) & (align - 1)) != 0;
diff --git a/sysdeps/hppa/nptl/tls.h b/sysdeps/hppa/nptl/tls.h
index 204960d5..2a270146 100644
--- a/sysdeps/hppa/nptl/tls.h
+++ b/sysdeps/hppa/nptl/tls.h
@@ -74,7 +74,7 @@ typedef struct
    special attention since 'errno' is not yet available and if the
    operation can cause a failure 'errno' must not be touched.  */
 # define TLS_INIT_TP(tcbp) \
-  ({ __set_cr27(tcbp); NULL; })
+  ({ __set_cr27(tcbp); true; })
 
 /* Value passed to 'clone' for initialization of the thread register.  */
 # define TLS_DEFINE_INIT_TP(tp, pd) void *tp = (pd) + 1
diff --git a/sysdeps/i386/fpu/e_atanh.S b/sysdeps/i386/fpu/e_atanh.S
index 6e4fef06..a7fd9a60 100644
--- a/sysdeps/i386/fpu/e_atanh.S
+++ b/sysdeps/i386/fpu/e_atanh.S
@@ -33,7 +33,8 @@ one:	.double 1.0
 limit:	.double 0.29
 	ASM_SIZE_DIRECTIVE(limit)
 	.type ln2_2,@object
-ln2_2:	.tfloat 0.3465735902799726547086160
+ln2_2:	.quad  0xb17217f7d1cf79ac /* 0.3465735902799726547086160L */
+	.short 0x3ffd
 	ASM_SIZE_DIRECTIVE(ln2_2)
 
 DEFINE_DBL_MIN
diff --git a/sysdeps/i386/fpu/e_atanhf.S b/sysdeps/i386/fpu/e_atanhf.S
index 146196ec..4ab1fa31 100644
--- a/sysdeps/i386/fpu/e_atanhf.S
+++ b/sysdeps/i386/fpu/e_atanhf.S
@@ -34,7 +34,8 @@ limit:	.double 0.29
 	ASM_SIZE_DIRECTIVE(limit)
 	.align ALIGNARG(4)
 	.type ln2_2,@object
-ln2_2:	.tfloat 0.3465735902799726547086160
+ln2_2:	.quad   0xb17217f7d1cf79ac  /* 0.3465735902799726547086160L  */
+	.short  0x3ffd
 	ASM_SIZE_DIRECTIVE(ln2_2)
 
 DEFINE_FLT_MIN
diff --git a/sysdeps/i386/fpu/e_atanhl.S b/sysdeps/i386/fpu/e_atanhl.S
index 1f6eb7ce..df3f1b8f 100644
--- a/sysdeps/i386/fpu/e_atanhl.S
+++ b/sysdeps/i386/fpu/e_atanhl.S
@@ -39,7 +39,8 @@ limit:	.double 0.29
 	ASM_SIZE_DIRECTIVE(limit)
 	.align ALIGNARG(4)
 	.type ln2_2,@object
-ln2_2:	.tfloat 0.3465735902799726547086160
+ln2_2:	.quad   0xb17217f7d1cf79ac  /* 0.3465735902799726547086160  */
+	.short  0x3ffd
 	ASM_SIZE_DIRECTIVE(ln2_2)
 
 #ifdef PIC
diff --git a/sysdeps/i386/fpu/s_asinhl.S b/sysdeps/i386/fpu/s_asinhl.S
index bd442c6a..f4f420d0 100644
--- a/sysdeps/i386/fpu/s_asinhl.S
+++ b/sysdeps/i386/fpu/s_asinhl.S
@@ -23,7 +23,8 @@
 
 	.align ALIGNARG(4)
 	.type huge,@object
-huge:	.tfloat 1e+4930
+huge:	.quad   0x89b634e7456ffa1d  /* 1e+4930  */
+	.short  0x7ff8
 	ASM_SIZE_DIRECTIVE(huge)
 	.align ALIGNARG(4)
 	/* Please note that we use double value for 1.0.  This number
diff --git a/sysdeps/i386/fpu/s_cbrtl.S b/sysdeps/i386/fpu/s_cbrtl.S
index 88021647..935ac205 100644
--- a/sysdeps/i386/fpu/s_cbrtl.S
+++ b/sysdeps/i386/fpu/s_cbrtl.S
@@ -23,55 +23,63 @@
 
         .align ALIGNARG(4)
         .type f8,@object
-f8:	.tfloat 0.161617097923756032
+f8:	.quad   0xa57ef3d83a542839  /* 0.161617097923756032  */
+	.short  0x3ffc
 	ASM_SIZE_DIRECTIVE(f8)
         .align ALIGNARG(4)
         .type f7,@object
-f7:	.tfloat -0.988553671195413709
+f7:	.quad   0xfd11da7820029014  /* -0.988553671195413709  */
+	.short  0xbffe
 	ASM_SIZE_DIRECTIVE(f7)
         .align ALIGNARG(4)
         .type f6,@object
-f6:	.tfloat 2.65298938441952296
+f6:	.quad   0xa9ca93fcade3b4ad  /* 2.65298938441952296  */
+	.short  0x4000
 	ASM_SIZE_DIRECTIVE(f6)
         .align ALIGNARG(4)
         .type f5,@object
-f5:	.tfloat -4.11151425200350531
+f5:	.quad   0x839186562c931c34  /* -4.11151425200350531  */
+	.short  0xc001
 	ASM_SIZE_DIRECTIVE(f5)
         .align ALIGNARG(4)
         .type f4,@object
-f4:	.tfloat 4.09559907378707839
+f4:	.quad   0x830f25c9ee304594  /* 4.09559907378707839  */
+	.short  0x4001
 	ASM_SIZE_DIRECTIVE(f4)
         .align ALIGNARG(4)
         .type f3,@object
-f3:	.tfloat -2.82414939754975962
+f3:	.quad   0xb4bedd1d5fa2f0c6  /* -2.82414939754975962  */
+	.short  0xc000
 	ASM_SIZE_DIRECTIVE(f3)
         .align ALIGNARG(4)
         .type f2,@object
-f2:	.tfloat 1.67595307700780102
+f2:	.quad   0xd685a163b08586e3  /* 1.67595307700780102  */
+	.short  0x3fff
 	ASM_SIZE_DIRECTIVE(f2)
         .align ALIGNARG(4)
         .type f1,@object
-f1:	.tfloat 0.338058687610520237
+f1:	.quad   0xad16073ed4ec3b45  /* 0.338058687610520237  */
+	.short  0x3ffd
 	ASM_SIZE_DIRECTIVE(f1)
 
-#define CBRT2		1.2599210498948731648
-#define ONE_CBRT2	0.793700525984099737355196796584
-#define SQR_CBRT2	1.5874010519681994748
-#define ONE_SQR_CBRT2	0.629960524947436582364439673883
-
 	/* We make the entries in the following table all 16 bytes
 	   wide to avoid having to implement a multiplication by 10.  */
 	.type factor,@object
         .align ALIGNARG(4)
-factor:	.tfloat ONE_SQR_CBRT2
+factor:	.quad 0xa14517cc6b945711 /* 0.629960524947436582364439673883L */
+	.short 0x3ffe
 	.byte 0, 0, 0, 0, 0, 0
-	.tfloat ONE_CBRT2
+	.quad 0xcb2ff529eb71e415 /* 1.5874010519681994748L */
+	.short 0x3ffe
 	.byte 0, 0, 0, 0, 0, 0
-	.tfloat 1.0
+	.quad 0x8000000000000000 /* 1.0L */
+	.short 0x3fff
 	.byte 0, 0, 0, 0, 0, 0
-	.tfloat CBRT2
+	.quad 0xa14517cc6b945711 /* 1.2599210498948731648L */
+	.short 0x3fff
 	.byte 0, 0, 0, 0, 0, 0
-	.tfloat SQR_CBRT2
+	.quad 0xcb2ff529eb71e416 /* 1.5874010519681994748L */
+	.short 0x3fff
 	ASM_SIZE_DIRECTIVE(factor)
 
         .type two64,@object
diff --git a/sysdeps/i386/fpu/s_expm1.S b/sysdeps/i386/fpu/s_expm1.S
index 7199d681..038ff72f 100644
--- a/sysdeps/i386/fpu/s_expm1.S
+++ b/sysdeps/i386/fpu/s_expm1.S
@@ -33,7 +33,8 @@ minus1:	.double -1.0
 one:	.double 1.0
 	ASM_SIZE_DIRECTIVE(one)
 	.type l2e,@object
-l2e:	.tfloat 1.442695040888963407359924681002
+l2e:	.quad   0xb8aa3b295c17f0bc  /* 1.442695040888963407359924681002 */
+	.short  0x3fff
 	ASM_SIZE_DIRECTIVE(l2e)
 
 DEFINE_DBL_MIN
diff --git a/sysdeps/i386/fpu/s_expm1f.S b/sysdeps/i386/fpu/s_expm1f.S
index 04c37bda..b0406a45 100644
--- a/sysdeps/i386/fpu/s_expm1f.S
+++ b/sysdeps/i386/fpu/s_expm1f.S
@@ -33,7 +33,8 @@ minus1:	.double -1.0
 one:	.double 1.0
 	ASM_SIZE_DIRECTIVE(one)
 	.type l2e,@object
-l2e:	.tfloat 1.442695040888963407359924681002
+l2e:	.quad  0xb8aa3b295c17f0bc  /* 1.442695040888963407359924681002 */
+	.short 0x3fff
 	ASM_SIZE_DIRECTIVE(l2e)
 
 DEFINE_FLT_MIN
diff --git a/sysdeps/i386/fpu/s_log1pl.S b/sysdeps/i386/fpu/s_log1pl.S
index f28349f7..202995d3 100644
--- a/sysdeps/i386/fpu/s_log1pl.S
+++ b/sysdeps/i386/fpu/s_log1pl.S
@@ -14,7 +14,8 @@ RCSID("$NetBSD: s_log1p.S,v 1.7 1995/05/09 00:10:58 jtc Exp $")
 		-1 + sqrt(2) / 2 <= x <= 1 - sqrt(2) / 2
 	   0.29 is a safe value.
 	*/
-limit:	.tfloat 0.29
+limit:	.quad   0x947ae147ae147ae1 /* 0.29 */
+	.short  0x3ffd
 	/* Please note:	 we use a double value here.  Since 1.0 has
 	   an exact representation this does not effect the accuracy
 	   but it helps to optimize the code.  */
diff --git a/sysdeps/i386/nptl/tls.h b/sysdeps/i386/nptl/tls.h
index 91090bf2..c1c6f081 100644
--- a/sysdeps/i386/nptl/tls.h
+++ b/sysdeps/i386/nptl/tls.h
@@ -203,8 +203,8 @@ tls_fill_user_desc (union user_desc_init *desc,
 	  which is necessary since we have changed it.   */		      \
        TLS_SET_GS (_segdescr.desc.entry_number * 8 + 3);		      \
 									      \
-     _result == 0 ? NULL						      \
-     : "set_thread_area failed when setting up thread-local storage\n"; })
+      _result == 0 ? true : false;					      \
+   })
 
 # define TLS_DEFINE_INIT_TP(tp, pd)					      \
   union user_desc_init _segdescr;					      \
diff --git a/sysdeps/ia64/memset.S b/sysdeps/ia64/memset.S
index d52f23dd..70ad1140 100644
--- a/sysdeps/ia64/memset.S
+++ b/sysdeps/ia64/memset.S
@@ -395,3 +395,4 @@ store_words:
 ;; }
 END(memset)
 libc_hidden_builtin_def (memset)
+strong_alias (memset, __memset_generic)
diff --git a/sysdeps/ia64/nptl/tls.h b/sysdeps/ia64/nptl/tls.h
index 8ccedb73..5a8aea15 100644
--- a/sysdeps/ia64/nptl/tls.h
+++ b/sysdeps/ia64/nptl/tls.h
@@ -105,7 +105,7 @@ register struct pthread *__thread_self __asm__("r13");
    special attention since 'errno' is not yet available and if the
    operation can cause a failure 'errno' must not be touched.  */
 # define TLS_INIT_TP(thrdescr) \
-  (__thread_self = (thrdescr), INIT_SYSINFO, NULL)
+  ({ __thread_self = (thrdescr), INIT_SYSINFO, true; })
 
 /* Value passed to 'clone2' for initialization of the thread register.  */
 # define TLS_DEFINE_INIT_TP(tp, pd) \
diff --git a/sysdeps/ieee754/dbl-64/e_lgamma_r.c b/sysdeps/ieee754/dbl-64/e_lgamma_r.c
index 5ef289e8..8b9b9c6a 100644
--- a/sysdeps/ieee754/dbl-64/e_lgamma_r.c
+++ b/sysdeps/ieee754/dbl-64/e_lgamma_r.c
@@ -231,7 +231,7 @@ __ieee754_lgamma_r(double x, int *signgamp)
 	    if (x < -2.0 && x > -28.0)
 		return __lgamma_neg (x, signgamp);
 	    t = sin_pi(x);
-	    if(t==zero) return one/fabsf(t); /* -integer */
+	    if(t==zero) return one/fabs(t); /* -integer */
 	    nadj = __ieee754_log(pi/fabs(t*x));
 	    if(t<zero) *signgamp = -1;
 	    x = -x;
@@ -304,7 +304,7 @@ __ieee754_lgamma_r(double x, int *signgamp)
 	   although in the cases where it is used it has always been
 	   set.  */
 	DIAG_PUSH_NEEDS_COMMENT;
-	DIAG_IGNORE_NEEDS_COMMENT (4.9, "-Wmaybe-uninitialized");
+	DIAG_IGNORE_NEEDS_COMMENT_GCC (4.9, "-Wmaybe-uninitialized");
 	if(hx<0) r = nadj - r;
 	DIAG_POP_NEEDS_COMMENT;
 	return r;
diff --git a/sysdeps/ieee754/dbl-64/k_rem_pio2.c b/sysdeps/ieee754/dbl-64/k_rem_pio2.c
index 6e2ef5d0..78d1ea09 100644
--- a/sysdeps/ieee754/dbl-64/k_rem_pio2.c
+++ b/sysdeps/ieee754/dbl-64/k_rem_pio2.c
@@ -337,7 +337,7 @@ recompute:
 	 to full precision (this function is not called for zero
 	 arguments).  */
       DIAG_PUSH_NEEDS_COMMENT;
-      DIAG_IGNORE_NEEDS_COMMENT (9, "-Wmaybe-uninitialized");
+      DIAG_IGNORE_NEEDS_COMMENT_GCC (9, "-Wmaybe-uninitialized");
       fv = math_narrow_eval (fq[0] - fv);
       DIAG_POP_NEEDS_COMMENT;
       for (i = 1; i <= jz; i++)
diff --git a/sysdeps/ieee754/float128/float128_private.h b/sysdeps/ieee754/float128/float128_private.h
index f9655df0..895890e2 100644
--- a/sysdeps/ieee754/float128/float128_private.h
+++ b/sysdeps/ieee754/float128/float128_private.h
@@ -336,7 +336,7 @@
 #define erfl erff128
 #define expl expf128
 #define expm1l expm1f128
-#define fabsl fabsf128
+#define fabsl __fabsf128
 #define fdiml fdimf128
 #define finitel finitef128_do_not_use
 #define floorl floorf128
@@ -346,7 +346,7 @@
 #define frexpl frexpf128
 #define getpayloadl getpayloadf128
 #define isinfl isinff128_do_not_use
-#define isnanl isnanf128_do_not_use
+#define isnanl isnanf128
 #define ldexpl ldexpf128
 #define llrintl llrintf128
 #define llroundl llroundf128
diff --git a/sysdeps/ieee754/float128/s_isnanf128.c b/sysdeps/ieee754/float128/s_isnanf128.c
index 59f71533..b73a4e80 100644
--- a/sysdeps/ieee754/float128/s_isnanf128.c
+++ b/sysdeps/ieee754/float128/s_isnanf128.c
@@ -11,7 +11,11 @@
 #include "../ldbl-128/s_isnanl.c"
 #if !IS_IN (libm)
 #include <float128-abi.h>
+#ifdef SHARED
 hidden_ver (__isnanf128_impl, __isnanf128)
+#else
+strong_alias (__isnanf128_impl, __isnanf128)
+#endif
 _weak_alias (__isnanf128_impl, isnanl)
 versioned_symbol (libc, __isnanf128_impl, __isnanf128, GLIBC_2_34);
 #if (SHLIB_COMPAT (libc, FLOAT128_VERSION_M, GLIBC_2_34))
diff --git a/sysdeps/ieee754/flt-32/e_lgammaf_r.c b/sysdeps/ieee754/flt-32/e_lgammaf_r.c
index a1a3a604..77dc54ea 100644
--- a/sysdeps/ieee754/flt-32/e_lgammaf_r.c
+++ b/sysdeps/ieee754/flt-32/e_lgammaf_r.c
@@ -239,7 +239,7 @@ __ieee754_lgammaf_r(float x, int *signgamp)
 	   although in the cases where it is used it has always been
 	   set.  */
 	DIAG_PUSH_NEEDS_COMMENT;
-	DIAG_IGNORE_NEEDS_COMMENT (4.9, "-Wmaybe-uninitialized");
+	DIAG_IGNORE_NEEDS_COMMENT_GCC (4.9, "-Wmaybe-uninitialized");
 	if(hx<0) r = nadj - r;
 	DIAG_POP_NEEDS_COMMENT;
 	return r;
diff --git a/sysdeps/ieee754/ldbl-128/k_tanl.c b/sysdeps/ieee754/ldbl-128/k_tanl.c
index 8e93626a..af10fbc6 100644
--- a/sysdeps/ieee754/ldbl-128/k_tanl.c
+++ b/sysdeps/ieee754/ldbl-128/k_tanl.c
@@ -143,7 +143,7 @@ __kernel_tanl (_Float128 x, _Float128 y, int iy)
 	 uninitialized although in the cases where it is used it has
 	 always been set.  */
       DIAG_PUSH_NEEDS_COMMENT;
-      DIAG_IGNORE_NEEDS_COMMENT (5, "-Wmaybe-uninitialized");
+      DIAG_IGNORE_NEEDS_COMMENT_GCC (5, "-Wmaybe-uninitialized");
       if (sign < 0)
 	w = -w;
       DIAG_POP_NEEDS_COMMENT;
diff --git a/sysdeps/ieee754/ldbl-128ibm-compat/ieee128-asprintf.c b/sysdeps/ieee754/ldbl-128ibm-compat/ieee128-asprintf.c
index f6838366..59f6e31d 100644
--- a/sysdeps/ieee754/ldbl-128ibm-compat/ieee128-asprintf.c
+++ b/sysdeps/ieee754/ldbl-128ibm-compat/ieee128-asprintf.c
@@ -19,8 +19,8 @@
 #include <stdarg.h>
 #include <libio/libioP.h>
 
-extern int
-___ieee128___asprintf (char **string_ptr, const char *format, ...)
+int
+__asprintfieee128 (char **string_ptr, const char *format, ...)
 {
   va_list ap;
   int done;
@@ -32,5 +32,4 @@ ___ieee128___asprintf (char **string_ptr, const char *format, ...)
 
   return done;
 }
-hidden_def (___ieee128___asprintf)
-strong_alias (___ieee128___asprintf, __asprintfieee128)
+libc_hidden_def (__asprintfieee128)
diff --git a/sysdeps/ieee754/ldbl-128ibm-compat/ieee128-dprintf.c b/sysdeps/ieee754/ldbl-128ibm-compat/ieee128-dprintf.c
index cf3b46c3..ceba219d 100644
--- a/sysdeps/ieee754/ldbl-128ibm-compat/ieee128-dprintf.c
+++ b/sysdeps/ieee754/ldbl-128ibm-compat/ieee128-dprintf.c
@@ -19,8 +19,8 @@
 #include <stdarg.h>
 #include <libio/libioP.h>
 
-extern int
-___ieee128_dprintf (int d, const char *format, ...)
+int
+__dprintfieee128 (int d, const char *format, ...)
 {
   va_list ap;
   int done;
@@ -31,5 +31,4 @@ ___ieee128_dprintf (int d, const char *format, ...)
 
   return done;
 }
-strong_alias (___ieee128_dprintf, __dprintfieee128)
-hidden_def (___ieee128_dprintf);
+libc_hidden_def (__dprintfieee128);
diff --git a/sysdeps/ieee754/ldbl-128ibm-compat/ieee128-err.c b/sysdeps/ieee754/ldbl-128ibm-compat/ieee128-err.c
index ad52efa8..41ac47c7 100644
--- a/sysdeps/ieee754/ldbl-128ibm-compat/ieee128-err.c
+++ b/sysdeps/ieee754/ldbl-128ibm-compat/ieee128-err.c
@@ -20,81 +20,72 @@
 #include <stdarg.h>
 #include <libio/libioP.h>
 
-#define VA(call)							\
+#define IEEE128_NAME(name) __ ## name ## ieee128
+
+#define VA(name, ...)							\
 {									\
   va_list ap;								\
   va_start (ap, format);						\
-  IEEE128_CALL (call);							\
+  IEEE128_NAME (name) (__VA_ARGS__);					\
   va_end (ap);								\
 }
 
 #define IEEE128_ALIAS(name) \
-  strong_alias (___ieee128_##name, __##name##ieee128)
+  libc_hidden_def (IEEE128_NAME(name))
 
-#define IEEE128_DECL(name) ___ieee128_##name
-#define IEEE128_CALL(name) ___ieee128_##name
 
 void
-IEEE128_DECL (vwarn) (const char *format, __gnuc_va_list ap)
+IEEE128_NAME (vwarn) (const char *format, __gnuc_va_list ap)
 {
   __vwarn_internal (format, ap, PRINTF_LDBL_USES_FLOAT128);
 }
 IEEE128_ALIAS (vwarn)
 
 void
-IEEE128_DECL (vwarnx) (const char *format, __gnuc_va_list ap)
+IEEE128_NAME (vwarnx) (const char *format, __gnuc_va_list ap)
 {
   __vwarnx_internal (format, ap, PRINTF_LDBL_USES_FLOAT128);
 }
 IEEE128_ALIAS (vwarnx)
 
 void
-IEEE128_DECL (warn) (const char *format, ...)
+IEEE128_NAME (warn) (const char *format, ...)
 {
-  VA (vwarn (format, ap))
+  VA (vwarn, format, ap)
 }
 IEEE128_ALIAS (warn)
 
 void
-IEEE128_DECL (warnx) (const char *format, ...)
+IEEE128_NAME (warnx) (const char *format, ...)
 {
-  VA (vwarnx (format, ap))
+  VA (vwarnx, format, ap)
 }
 IEEE128_ALIAS (warnx)
 
 void
-IEEE128_DECL (verr) (int status, const char *format, __gnuc_va_list ap)
+IEEE128_NAME (verr) (int status, const char *format, __gnuc_va_list ap)
 {
-  IEEE128_CALL (vwarn) (format, ap);
+  IEEE128_NAME (vwarn) (format, ap);
   exit (status);
 }
 IEEE128_ALIAS (verr)
 
 void
-IEEE128_DECL (verrx) (int status, const char *format, __gnuc_va_list ap)
+IEEE128_NAME (verrx) (int status, const char *format, __gnuc_va_list ap)
 {
-  IEEE128_CALL (vwarnx) (format, ap);
+  IEEE128_NAME (vwarnx) (format, ap);
   exit (status);
 }
 IEEE128_ALIAS (verrx)
 
 void
-IEEE128_DECL (err) (int status, const char *format, ...)
+IEEE128_NAME (err) (int status, const char *format, ...)
 {
-  VA (verr (status, format, ap))
+  VA (verr, status, format, ap)
 }
-IEEE128_ALIAS (err)
 
 void
-IEEE128_DECL (errx) (int status, const char *format, ...)
+IEEE128_NAME (errx) (int status, const char *format, ...)
 {
-  VA (verrx (status, format, ap))
+  VA (verrx, status, format, ap)
 }
-IEEE128_ALIAS (errx)
-
-hidden_def (___ieee128_warn)
-hidden_def (___ieee128_warnx)
-hidden_def (___ieee128_vwarn)
-hidden_def (___ieee128_vwarnx)
-hidden_def (___ieee128_verr)
-hidden_def (___ieee128_verrx)
diff --git a/sysdeps/ieee754/ldbl-128ibm-compat/ieee128-fprintf.c b/sysdeps/ieee754/ldbl-128ibm-compat/ieee128-fprintf.c
index 44625886..b58f27af 100644
--- a/sysdeps/ieee754/ldbl-128ibm-compat/ieee128-fprintf.c
+++ b/sysdeps/ieee754/ldbl-128ibm-compat/ieee128-fprintf.c
@@ -19,8 +19,8 @@
 #include <stdarg.h>
 #include <libio/libioP.h>
 
-extern int
-___ieee128_fprintf (FILE *fp, const char *format, ...)
+int
+__fprintfieee128 (FILE *fp, const char *format, ...)
 {
   va_list ap;
   int done;
@@ -31,5 +31,4 @@ ___ieee128_fprintf (FILE *fp, const char *format, ...)
 
   return done;
 }
-strong_alias (___ieee128_fprintf, __fprintfieee128)
-hidden_def (___ieee128_fprintf)
+libc_hidden_def (__fprintfieee128)
diff --git a/sysdeps/ieee754/ldbl-128ibm-compat/ieee128-qefgcvt.c b/sysdeps/ieee754/ldbl-128ibm-compat/ieee128-qefgcvt.c
index 9703069b..243eb656 100644
--- a/sysdeps/ieee754/ldbl-128ibm-compat/ieee128-qefgcvt.c
+++ b/sysdeps/ieee754/ldbl-128ibm-compat/ieee128-qefgcvt.c
@@ -18,8 +18,8 @@
 
 /* When in IEEE long double mode, call ___ieee128_sprintf.  */
 #include <stdio.h>
-typeof (sprintf) ___ieee128_sprintf attribute_hidden;
-#define SPRINTF ___ieee128_sprintf
+typeof (sprintf) __sprintfieee128 attribute_hidden;
+#define SPRINTF __sprintfieee128
 
 /* Declare internal functions: ___qecvtieee128_r and ___qfcvtieee128_r,
    built from a different compiling unit, and called from here.  */
diff --git a/sysdeps/ieee754/ldbl-128ibm-compat/ieee128-qefgcvt_r.c b/sysdeps/ieee754/ldbl-128ibm-compat/ieee128-qefgcvt_r.c
index 0be5bb28..8046f5fd 100644
--- a/sysdeps/ieee754/ldbl-128ibm-compat/ieee128-qefgcvt_r.c
+++ b/sysdeps/ieee754/ldbl-128ibm-compat/ieee128-qefgcvt_r.c
@@ -18,8 +18,8 @@
 
 /* When in IEEE long double mode, call ___ieee128_snprintf.  */
 #include <stdio.h>
-typeof (snprintf) ___ieee128_snprintf attribute_hidden;
-#define SNPRINTF ___ieee128_snprintf
+typeof (snprintf) __snprintfieee128 attribute_hidden;
+#define SNPRINTF __snprintfieee128
 
 #define ECVT_R __qecvtieee128_r
 #define FCVT_R __qfcvtieee128_r
diff --git a/sysdeps/ieee754/ldbl-128ibm-compat/ieee128-snprintf.c b/sysdeps/ieee754/ldbl-128ibm-compat/ieee128-snprintf.c
index 5f51b3ec..da3d9441 100644
--- a/sysdeps/ieee754/ldbl-128ibm-compat/ieee128-snprintf.c
+++ b/sysdeps/ieee754/ldbl-128ibm-compat/ieee128-snprintf.c
@@ -19,8 +19,8 @@
 #include <stdarg.h>
 #include <libio/libioP.h>
 
-extern int
-___ieee128_snprintf (char *s, size_t maxlen, const char *format, ...)
+int
+__snprintfieee128 (char *s, size_t maxlen, const char *format, ...)
 {
   va_list ap;
   int done;
@@ -32,4 +32,4 @@ ___ieee128_snprintf (char *s, size_t maxlen, const char *format, ...)
 
   return done;
 }
-strong_alias (___ieee128_snprintf, __snprintfieee128)
+libc_hidden_def (__snprintfieee128)
diff --git a/sysdeps/ieee754/ldbl-128ibm-compat/ieee128-sprintf.c b/sysdeps/ieee754/ldbl-128ibm-compat/ieee128-sprintf.c
index 0cad1307..007a7165 100644
--- a/sysdeps/ieee754/ldbl-128ibm-compat/ieee128-sprintf.c
+++ b/sysdeps/ieee754/ldbl-128ibm-compat/ieee128-sprintf.c
@@ -19,8 +19,8 @@
 #include <stdarg.h>
 #include <libio/libioP.h>
 
-extern int
-___ieee128_sprintf (char *s, const char *format, ...)
+int
+__sprintfieee128 (char *s, const char *format, ...)
 {
   va_list ap;
   int done;
@@ -32,5 +32,4 @@ ___ieee128_sprintf (char *s, const char *format, ...)
 
   return done;
 }
-strong_alias (___ieee128_sprintf, __sprintfieee128)
-hidden_def (___ieee128_sprintf)
+libc_hidden_def (__sprintfieee128)
diff --git a/sysdeps/ieee754/ldbl-128ibm-compat/ieee128-syslog.c b/sysdeps/ieee754/ldbl-128ibm-compat/ieee128-syslog.c
index e7bc822b..467c14b6 100644
--- a/sysdeps/ieee754/ldbl-128ibm-compat/ieee128-syslog.c
+++ b/sysdeps/ieee754/ldbl-128ibm-compat/ieee128-syslog.c
@@ -21,7 +21,7 @@
 #include <syslog.h>
 
 void
-___ieee128_syslog (int pri, const char *fmt, ...)
+__syslogieee128 (int pri, const char *fmt, ...)
 {
   va_list ap;
 
@@ -29,8 +29,7 @@ ___ieee128_syslog (int pri, const char *fmt, ...)
   __vsyslog_internal (pri, fmt, ap, PRINTF_LDBL_USES_FLOAT128);
   va_end (ap);
 }
-strong_alias (___ieee128_syslog, __syslogieee128)
-hidden_def (___ieee128_syslog)
+hidden_def (__syslogieee128)
 
 void
 ___ieee128_vsyslog (int pri, const char *fmt, va_list ap)
diff --git a/sysdeps/ieee754/ldbl-128ibm-compat/ieee128-vfprintf.c b/sysdeps/ieee754/ldbl-128ibm-compat/ieee128-vfprintf.c
index e340c9b4..4df1e485 100644
--- a/sysdeps/ieee754/ldbl-128ibm-compat/ieee128-vfprintf.c
+++ b/sysdeps/ieee754/ldbl-128ibm-compat/ieee128-vfprintf.c
@@ -18,10 +18,9 @@
 
 #include <libio/libioP.h>
 
-extern int
-___ieee128_vfprintf (FILE *fp, const char *format, va_list ap)
+int
+__vfprintfieee128 (FILE *fp, const char *format, va_list ap)
 {
   return __vfprintf_internal (fp, format, ap, PRINTF_LDBL_USES_FLOAT128);
 }
-strong_alias (___ieee128_vfprintf, __vfprintfieee128)
-hidden_def (___ieee128_vfprintf)
+libc_hidden_def (__vfprintfieee128)
diff --git a/sysdeps/ieee754/ldbl-128ibm/k_tanl.c b/sysdeps/ieee754/ldbl-128ibm/k_tanl.c
index cd95e460..7a42a18e 100644
--- a/sysdeps/ieee754/ldbl-128ibm/k_tanl.c
+++ b/sysdeps/ieee754/ldbl-128ibm/k_tanl.c
@@ -143,7 +143,7 @@ __kernel_tanl (long double x, long double y, int iy)
 	 uninitialized although in the cases where it is used it has
 	 always been set.  */
       DIAG_PUSH_NEEDS_COMMENT;
-      DIAG_IGNORE_NEEDS_COMMENT (5, "-Wmaybe-uninitialized");
+      DIAG_IGNORE_NEEDS_COMMENT_GCC (5, "-Wmaybe-uninitialized");
       if (sign < 0)
 	w = -w;
       DIAG_POP_NEEDS_COMMENT;
diff --git a/sysdeps/ieee754/ldbl-96/e_lgammal_r.c b/sysdeps/ieee754/ldbl-96/e_lgammal_r.c
index c6f0e770..f4d6e1f8 100644
--- a/sysdeps/ieee754/ldbl-96/e_lgammal_r.c
+++ b/sysdeps/ieee754/ldbl-96/e_lgammal_r.c
@@ -431,7 +431,7 @@ __ieee754_lgammal_r (long double x, int *signgamp)
      in warnings that it may be used uninitialized although in the
      cases where it is used it has always been set.  */
   DIAG_PUSH_NEEDS_COMMENT;
-  DIAG_IGNORE_NEEDS_COMMENT (4.9, "-Wmaybe-uninitialized");
+  DIAG_IGNORE_NEEDS_COMMENT_GCC (4.9, "-Wmaybe-uninitialized");
   if (se & 0x8000)
     r = nadj - r;
   DIAG_POP_NEEDS_COMMENT;
diff --git a/sysdeps/ieee754/ldbl-96/k_tanl.c b/sysdeps/ieee754/ldbl-96/k_tanl.c
index 43a5aa44..46279557 100644
--- a/sysdeps/ieee754/ldbl-96/k_tanl.c
+++ b/sysdeps/ieee754/ldbl-96/k_tanl.c
@@ -140,7 +140,7 @@ __kernel_tanl (long double x, long double y, int iy)
         uninitialized although in the cases where it is used it has
         always been set.  */
       DIAG_PUSH_NEEDS_COMMENT;
-      DIAG_IGNORE_NEEDS_COMMENT (4.8, "-Wmaybe-uninitialized");
+      DIAG_IGNORE_NEEDS_COMMENT_GCC (4.8, "-Wmaybe-uninitialized");
       if (sign < 0)
 	w = -w;
       DIAG_POP_NEEDS_COMMENT;
diff --git a/sysdeps/ieee754/ldbl-96/test-totalorderl-ldbl-96.c b/sysdeps/ieee754/ldbl-96/test-totalorderl-ldbl-96.c
index 1928db67..86f45d82 100644
--- a/sysdeps/ieee754/ldbl-96/test-totalorderl-ldbl-96.c
+++ b/sysdeps/ieee754/ldbl-96/test-totalorderl-ldbl-96.c
@@ -46,9 +46,9 @@ do_test (void)
 	SET_LDOUBLE_WORDS (ldy, 0x7fff,
 			   (tests[i] >> 32) | 0x80000000,
 			   tests[i] & 0xffffffffULL);
-	SET_LDOUBLE_WORDS (ldnx, 0xffff,
+	SET_LDOUBLE_WORDS (ldnx, -1,
 			   tests[i] >> 32, tests[i] & 0xffffffffULL);
-	SET_LDOUBLE_WORDS (ldny, 0xffff,
+	SET_LDOUBLE_WORDS (ldny, -1,
 			   (tests[i] >> 32) | 0x80000000,
 			   tests[i] & 0xffffffffULL);
 	bool to1 = totalorderl (&ldx, &ldy);
diff --git a/sysdeps/ieee754/soft-fp/s_ddivl.c b/sysdeps/ieee754/soft-fp/s_ddivl.c
index 2f80cca0..8ff222e2 100644
--- a/sysdeps/ieee754/soft-fp/s_ddivl.c
+++ b/sysdeps/ieee754/soft-fp/s_ddivl.c
@@ -37,7 +37,7 @@
    versions of GCC, it may be where R is defined using a macro or it
    may be where the macro is defined.  This happens only with -O1.  */
 DIAG_PUSH_NEEDS_COMMENT;
-DIAG_IGNORE_NEEDS_COMMENT (8, "-Wmaybe-uninitialized");
+DIAG_IGNORE_NEEDS_COMMENT_GCC (8, "-Wmaybe-uninitialized");
 #include <soft-fp.h>
 #include <double.h>
 #include <quad.h>
diff --git a/sysdeps/ieee754/soft-fp/s_dfmal.c b/sysdeps/ieee754/soft-fp/s_dfmal.c
index 208ad445..906c6654 100644
--- a/sysdeps/ieee754/soft-fp/s_dfmal.c
+++ b/sysdeps/ieee754/soft-fp/s_dfmal.c
@@ -37,7 +37,7 @@
    it may be where R is defined using a macro or it may be where the
    macro is defined.  */
 DIAG_PUSH_NEEDS_COMMENT;
-DIAG_IGNORE_NEEDS_COMMENT (4.9, "-Wmaybe-uninitialized");
+DIAG_IGNORE_NEEDS_COMMENT_GCC (4.9, "-Wmaybe-uninitialized");
 
 #include <soft-fp.h>
 #include <double.h>
diff --git a/sysdeps/ieee754/soft-fp/s_dsqrtl.c b/sysdeps/ieee754/soft-fp/s_dsqrtl.c
index 22c0d0cc..8848e307 100644
--- a/sysdeps/ieee754/soft-fp/s_dsqrtl.c
+++ b/sysdeps/ieee754/soft-fp/s_dsqrtl.c
@@ -35,7 +35,7 @@
    does not see that they are set in all cases where they are used,
    resulting in warnings that they may be used uninitialized.  */
 DIAG_PUSH_NEEDS_COMMENT;
-DIAG_IGNORE_NEEDS_COMMENT (7, "-Wmaybe-uninitialized");
+DIAG_IGNORE_NEEDS_COMMENT_GCC (7, "-Wmaybe-uninitialized");
 #include <soft-fp.h>
 #include <double.h>
 #include <quad.h>
diff --git a/sysdeps/ieee754/soft-fp/s_fdiv.c b/sysdeps/ieee754/soft-fp/s_fdiv.c
index 4c4eb7ca..1d2c9cd0 100644
--- a/sysdeps/ieee754/soft-fp/s_fdiv.c
+++ b/sysdeps/ieee754/soft-fp/s_fdiv.c
@@ -34,7 +34,7 @@
    versions of GCC, it may be where R is defined using a macro or it
    may be where the macro is defined.  This happens only with -O1.  */
 DIAG_PUSH_NEEDS_COMMENT;
-DIAG_IGNORE_NEEDS_COMMENT (8, "-Wmaybe-uninitialized");
+DIAG_IGNORE_NEEDS_COMMENT_GCC (8, "-Wmaybe-uninitialized");
 #include <soft-fp.h>
 #include <single.h>
 #include <double.h>
diff --git a/sysdeps/ieee754/soft-fp/s_fdivl.c b/sysdeps/ieee754/soft-fp/s_fdivl.c
index 07196ee7..a7c5536c 100644
--- a/sysdeps/ieee754/soft-fp/s_fdivl.c
+++ b/sysdeps/ieee754/soft-fp/s_fdivl.c
@@ -33,7 +33,6 @@
    versions of GCC, it may be where R is defined using a macro or it
    may be where the macro is defined.  This happens only with -O1.  */
 DIAG_PUSH_NEEDS_COMMENT;
-DIAG_IGNORE_NEEDS_COMMENT (8, "-Wmaybe-uninitialized");
 #include <soft-fp.h>
 #include <single.h>
 #include <quad.h>
diff --git a/sysdeps/ieee754/soft-fp/s_ffma.c b/sysdeps/ieee754/soft-fp/s_ffma.c
index 3f750be2..8517d539 100644
--- a/sysdeps/ieee754/soft-fp/s_ffma.c
+++ b/sysdeps/ieee754/soft-fp/s_ffma.c
@@ -35,7 +35,7 @@
    it may be where R is defined using a macro or it may be where the
    macro is defined.  */
 DIAG_PUSH_NEEDS_COMMENT;
-DIAG_IGNORE_NEEDS_COMMENT (4.9, "-Wmaybe-uninitialized");
+DIAG_IGNORE_NEEDS_COMMENT_GCC (4.9, "-Wmaybe-uninitialized");
 
 #include <soft-fp.h>
 #include <single.h>
diff --git a/sysdeps/ieee754/soft-fp/s_ffmal.c b/sysdeps/ieee754/soft-fp/s_ffmal.c
index 97f4e687..6820242d 100644
--- a/sysdeps/ieee754/soft-fp/s_ffmal.c
+++ b/sysdeps/ieee754/soft-fp/s_ffmal.c
@@ -23,6 +23,8 @@
 #undef f32fmaf64x
 #undef f32fmaf128
 
+#include <stdlib.h>
+
 #include <math-narrow.h>
 #include <libc-diag.h>
 
@@ -33,7 +35,7 @@
    it may be where R is defined using a macro or it may be where the
    macro is defined.  */
 DIAG_PUSH_NEEDS_COMMENT;
-DIAG_IGNORE_NEEDS_COMMENT (4.9, "-Wmaybe-uninitialized");
+DIAG_IGNORE_NEEDS_COMMENT_GCC (4.9, "-Wmaybe-uninitialized");
 
 #include <soft-fp.h>
 #include <single.h>
diff --git a/sysdeps/ieee754/soft-fp/s_fma.c b/sysdeps/ieee754/soft-fp/s_fma.c
index dde16148..18a52861 100644
--- a/sysdeps/ieee754/soft-fp/s_fma.c
+++ b/sysdeps/ieee754/soft-fp/s_fma.c
@@ -42,7 +42,9 @@
    it may be where R is defined using a macro or it may be where the
    macro is defined.  */
 DIAG_PUSH_NEEDS_COMMENT;
-DIAG_IGNORE_NEEDS_COMMENT (4.9, "-Wmaybe-uninitialized");
+DIAG_IGNORE_NEEDS_COMMENT_GCC (4.9, "-Wmaybe-uninitialized");
+
+#include <stdlib.h>
 
 #include "soft-fp.h"
 #include "double.h"
diff --git a/sysdeps/ieee754/soft-fp/s_fmaf.c b/sysdeps/ieee754/soft-fp/s_fmaf.c
index 5617cec0..d3275972 100644
--- a/sysdeps/ieee754/soft-fp/s_fmaf.c
+++ b/sysdeps/ieee754/soft-fp/s_fmaf.c
@@ -37,7 +37,9 @@
    it may be where R is defined using a macro or it may be where the
    macro is defined.  */
 DIAG_PUSH_NEEDS_COMMENT;
-DIAG_IGNORE_NEEDS_COMMENT (4.9, "-Wmaybe-uninitialized");
+DIAG_IGNORE_NEEDS_COMMENT_GCC (4.9, "-Wmaybe-uninitialized");
+
+#include <stdlib.h>
 
 #include "soft-fp.h"
 #include "single.h"
diff --git a/sysdeps/ieee754/soft-fp/s_fmal.c b/sysdeps/ieee754/soft-fp/s_fmal.c
index 3ca60a8d..0b631620 100644
--- a/sysdeps/ieee754/soft-fp/s_fmal.c
+++ b/sysdeps/ieee754/soft-fp/s_fmal.c
@@ -40,7 +40,9 @@
    it may be where R is defined using a macro or it may be where the
    macro is defined.  */
 DIAG_PUSH_NEEDS_COMMENT;
-DIAG_IGNORE_NEEDS_COMMENT (4.9, "-Wmaybe-uninitialized");
+DIAG_IGNORE_NEEDS_COMMENT_GCC (4.9, "-Wmaybe-uninitialized");
+
+#include <stdlib.h>
 
 #include "soft-fp.h"
 #include "quad.h"
diff --git a/sysdeps/m68k/nptl/tls.h b/sysdeps/m68k/nptl/tls.h
index 30d58e36..675cb397 100644
--- a/sysdeps/m68k/nptl/tls.h
+++ b/sysdeps/m68k/nptl/tls.h
@@ -90,7 +90,7 @@ typedef struct
 									\
     _sys_result = INTERNAL_SYSCALL_CALL (set_thread_area, 		\
 				    ((void *) (tcbp)) + TLS_TCB_OFFSET); \
-    INTERNAL_SYSCALL_ERROR_P (_sys_result) ? "unknown error" : NULL; })
+    INTERNAL_SYSCALL_ERROR_P (_sys_result); })
 
 # define TLS_DEFINE_INIT_TP(tp, pd) \
   void *tp = (void *) (pd) + TLS_TCB_OFFSET + TLS_PRE_TCB_SIZE
diff --git a/sysdeps/mach/hurd/i386/tls.h b/sysdeps/mach/hurd/i386/tls.h
index 264ed9a9..547ab849 100644
--- a/sysdeps/mach/hurd/i386/tls.h
+++ b/sysdeps/mach/hurd/i386/tls.h
@@ -107,12 +107,12 @@ typedef struct
 
 # define HURD_SEL_LDT(sel) (__builtin_expect ((sel) & 4, 0))
 
-static inline const char * __attribute__ ((unused))
+static inline bool __attribute__ ((unused))
 _hurd_tls_init (tcbhead_t *tcb)
 {
   HURD_TLS_DESC_DECL (desc, tcb);
   thread_t self = __mach_thread_self ();
-  const char *msg = NULL;
+  bool ret = true;
 
   /* This field is used by TLS accesses to get our "thread pointer"
      from the TLS point of view.  */
@@ -131,14 +131,14 @@ _hurd_tls_init (tcbhead_t *tcb)
       assert_perror (err);
       if (err)
       {
-	msg = "i386_set_ldt failed";
+	ret = false;
 	goto out;
       }
     }
   else if (err)
     {
       assert_perror (err); /* Separate from above with different line #. */
-      msg = "i386_set_gdt failed";
+      ret = false;
       goto out;
     }
 
@@ -147,7 +147,7 @@ _hurd_tls_init (tcbhead_t *tcb)
 
 out:
   __mach_port_deallocate (__mach_task_self (), self);
-  return msg;
+  return ret;
 }
 
 /* Code to initially initialize the thread pointer.  This might need
diff --git a/sysdeps/microblaze/nptl/tls.h b/sysdeps/microblaze/nptl/tls.h
index 40a6acd7..a46d5835 100644
--- a/sysdeps/microblaze/nptl/tls.h
+++ b/sysdeps/microblaze/nptl/tls.h
@@ -75,7 +75,7 @@ typedef struct
 /* Code to initially initialize the thread pointer.
    r21 is reserved for thread pointer.  */
 # define TLS_INIT_TP(tcbp) \
-  ({ __asm __volatile ("or r21,r0,%0" : : "r" ((void *)tcbp)); NULL; })
+  ({ __asm __volatile ("or r21,r0,%0" : : "r" ((void *)tcbp)); true; })
 
 # define TLS_DEFINE_INIT_TP(tp, pd) void *tp = (pd) + 1
 
diff --git a/sysdeps/mips/memset.S b/sysdeps/mips/memset.S
index c5ffab1d..cb5c9a14 100644
--- a/sysdeps/mips/memset.S
+++ b/sysdeps/mips/memset.S
@@ -424,3 +424,4 @@ END(MEMSET_NAME)
 libc_hidden_builtin_def (MEMSET_NAME)
 # endif
 #endif
+strong_alias(MEMSET_NAME, __memset_generic)
diff --git a/sysdeps/mips/nptl/tls.h b/sysdeps/mips/nptl/tls.h
index 03a5b24a..ddd6ab89 100644
--- a/sysdeps/mips/nptl/tls.h
+++ b/sysdeps/mips/nptl/tls.h
@@ -116,8 +116,7 @@ typedef struct
   ({ long int result_var;						\
      result_var = INTERNAL_SYSCALL_CALL (set_thread_area, 		\
 				    (char *) (tcbp) + TLS_TCB_OFFSET);	\
-     INTERNAL_SYSCALL_ERROR_P (result_var)				\
-       ? "unknown error" : NULL; })
+     INTERNAL_SYSCALL_ERROR_P (result_var); })
 
 /* Value passed to 'clone' for initialization of the thread register.  */
 # define TLS_DEFINE_INIT_TP(tp, pd) \
diff --git a/sysdeps/nios2/nptl/tls.h b/sysdeps/nios2/nptl/tls.h
index 18080275..128d9451 100644
--- a/sysdeps/nios2/nptl/tls.h
+++ b/sysdeps/nios2/nptl/tls.h
@@ -88,7 +88,7 @@ register struct pthread *__thread_self __asm__("r23");
 
 /* Code to initially initialize the thread pointer.  */
 # define TLS_INIT_TP(tcbp) \
-  (__thread_self = (struct pthread *) ((char *) tcbp + TLS_TCB_OFFSET), NULL)
+  ({ __thread_self = (struct pthread *) ((char *) tcbp + TLS_TCB_OFFSET), true; })
 
 /* Value passed to 'clone' for initialization of the thread register.  */
 # define TLS_DEFINE_INIT_TP(tp, pd) \
diff --git a/sysdeps/nptl/dl-tls_init_tp.c b/sysdeps/nptl/dl-tls_init_tp.c
index 1294c918..f30e1399 100644
--- a/sysdeps/nptl/dl-tls_init_tp.c
+++ b/sysdeps/nptl/dl-tls_init_tp.c
@@ -109,7 +109,7 @@ __tls_init_tp (void)
       {
         /* We need a writable view of the variables.  They are in
            .data.relro and are not yet write-protected.  */
-        extern unsigned int size __asm__ ("__rseq_size");
+        extern volatile unsigned int size __asm__ ("__rseq_size");
         size = sizeof (pd->rseq_area);
       }
 
@@ -119,7 +119,7 @@ __tls_init_tp (void)
        all targets support __thread_pointer, so set __rseq_offset only
        if thre rseq registration may have happened because RSEQ_SIG is
        defined.  */
-    extern ptrdiff_t offset __asm__ ("__rseq_offset");
+    extern volatile ptrdiff_t offset __asm__ ("__rseq_offset");
     offset = (char *) &pd->rseq_area - (char *) __thread_pointer ();
 #endif
   }
diff --git a/sysdeps/nptl/gai_misc.h b/sysdeps/nptl/gai_misc.h
index c09350c2..1274d105 100644
--- a/sysdeps/nptl/gai_misc.h
+++ b/sysdeps/nptl/gai_misc.h
@@ -86,7 +86,7 @@ __gai_start_notify_thread (void)
   assert_perror (sigerr);
 }
 
-extern inline int
+static inline int
 __gai_create_helper_thread (pthread_t *threadp, void *(*tf) (void *),
 			    void *arg)
 {
diff --git a/sysdeps/nptl/lowlevellock.h b/sysdeps/nptl/lowlevellock.h
index b429d9aa..0ef4367f 100644
--- a/sysdeps/nptl/lowlevellock.h
+++ b/sysdeps/nptl/lowlevellock.h
@@ -125,9 +125,9 @@ libc_hidden_proto (__lll_lock_wait)
 #define lll_cond_lock(futex, private) __lll_cond_lock (&(futex), private)
 
 
-extern void __lll_lock_wake_private (int *futex);
+extern void __lll_lock_wake_private (int *futex) __THROW;
 libc_hidden_proto (__lll_lock_wake_private)
-extern void __lll_lock_wake (int *futex, int private);
+extern void __lll_lock_wake (int *futex, int private) __THROW;
 libc_hidden_proto (__lll_lock_wake)
 
 /* This is an expression rather than a statement even though its value is
diff --git a/sysdeps/or1k/nptl/tls.h b/sysdeps/or1k/nptl/tls.h
index c6ffe62c..0e2cce7f 100644
--- a/sysdeps/or1k/nptl/tls.h
+++ b/sysdeps/or1k/nptl/tls.h
@@ -112,7 +112,7 @@ register tcbhead_t *__thread_self __asm__("r10");
    It's hard to fail this, so return NULL always.  */
 
 # define TLS_INIT_TP(tcbp) \
-  ({__thread_self = ((tcbhead_t *)tcbp + 1); NULL;})
+  ({__thread_self = ((tcbhead_t *)tcbp + 1); true; })
 
 /* Value passed to 'clone' for initialization of the thread register.  */
 # define TLS_DEFINE_INIT_TP(tp, pd) \
diff --git a/sysdeps/posix/Makefile b/sysdeps/posix/Makefile
index b58aa6aa..c931384e 100644
--- a/sysdeps/posix/Makefile
+++ b/sysdeps/posix/Makefile
@@ -3,3 +3,5 @@ L_tmpnam  = 20
 TMP_MAX   = 238328
 L_ctermid = 9
 L_cuserid = 9
+
+CFLAGS-getaddrinfo.c += -Wno-sometimes-uninitialized
diff --git a/sysdeps/posix/fpathconf.c b/sysdeps/posix/fpathconf.c
index 216f2a9c..69a5cd14 100644
--- a/sysdeps/posix/fpathconf.c
+++ b/sysdeps/posix/fpathconf.c
@@ -115,7 +115,7 @@ __fpathconf (int fd, int name)
       return _POSIX_NO_TRUNC;
 
     case _PC_VDISABLE:
-#if _POSIX_VDISABLE == -1
+#if _POSIX_VDISABLE == -1U
 # error "Invalid value for _POSIX_VDISABLE"
 #endif
       return _POSIX_VDISABLE;
diff --git a/sysdeps/posix/getaddrinfo.c b/sysdeps/posix/getaddrinfo.c
index 18dccd59..bcff909b 100644
--- a/sysdeps/posix/getaddrinfo.c
+++ b/sysdeps/posix/getaddrinfo.c
@@ -100,14 +100,12 @@ struct gaih_service
 
 struct gaih_servtuple
   {
-    struct gaih_servtuple *next;
     int socktype;
     int protocol;
     int port;
+    bool set;
   };
 
-static const struct gaih_servtuple nullserv;
-
 
 struct gaih_typeproto
   {
@@ -118,6 +116,14 @@ struct gaih_typeproto
     char name[8];
   };
 
+struct gaih_result
+{
+  struct gaih_addrtuple *at;
+  char *canon;
+  bool free_at;
+  bool got_ipv6;
+};
+
 /* Values for `protoflag'.  */
 #define GAI_PROTO_NOSERVICE	1
 #define GAI_PROTO_PROTOANY	2
@@ -153,6 +159,14 @@ static const struct addrinfo default_hints =
     .ai_next = NULL
   };
 
+static void
+gaih_result_reset (struct gaih_result *res)
+{
+  if (res->free_at)
+    free (res->at);
+  free (res->canon);
+  memset (res, 0, sizeof (*res));
+}
 
 static int
 gaih_inet_serv (const char *servicename, const struct gaih_typeproto *tp,
@@ -180,28 +194,22 @@ gaih_inet_serv (const char *servicename, const struct gaih_typeproto *tp,
     }
   while (r);
 
-  st->next = NULL;
   st->socktype = tp->socktype;
   st->protocol = ((tp->protoflag & GAI_PROTO_PROTOANY)
 		  ? req->ai_protocol : tp->protocol);
   st->port = s->s_port;
+  st->set = true;
 
   return 0;
 }
 
-/* Convert struct hostent to a list of struct gaih_addrtuple objects.
-   h_name is not copied, and the struct hostent object must not be
-   deallocated prematurely.  *RESULT must be NULL or a pointer to a
-   linked-list.  The new addresses are appended at the end.  */
+/* Convert struct hostent to a list of struct gaih_addrtuple objects.  h_name
+   is not copied, and the struct hostent object must not be deallocated
+   prematurely.  The new addresses are appended to the tuple array in RES.  */
 static bool
-convert_hostent_to_gaih_addrtuple (const struct addrinfo *req,
-				   int family,
-				   struct hostent *h,
-				   struct gaih_addrtuple **result)
+convert_hostent_to_gaih_addrtuple (const struct addrinfo *req, int family,
+				   struct hostent *h, struct gaih_result *res)
 {
-  while (*result)
-    result = &(*result)->next;
-
   /* Count the number of addresses in h->h_addr_list.  */
   size_t count = 0;
   for (char **p = h->h_addr_list; *p != NULL; ++p)
@@ -212,10 +220,32 @@ convert_hostent_to_gaih_addrtuple (const struct addrinfo *req,
   if (count == 0 || h->h_length > sizeof (((struct gaih_addrtuple) {}).addr))
     return true;
 
-  struct gaih_addrtuple *array = calloc (count, sizeof (*array));
+  struct gaih_addrtuple *array = res->at;
+  size_t old = 0;
+
+  while (array != NULL)
+    {
+      old++;
+      array = array->next;
+    }
+
+  array = realloc (res->at, (old + count) * sizeof (*array));
+
   if (array == NULL)
     return false;
 
+  res->got_ipv6 = family == AF_INET6;
+  res->at = array;
+  res->free_at = true;
+
+  /* Update the next pointers on reallocation.  */
+  for (size_t i = 0; i < old; i++)
+    array[i].next = array + i + 1;
+
+  array += old;
+
+  memset (array, 0, count * sizeof (*array));
+
   for (size_t i = 0; i < count; ++i)
     {
       if (family == AF_INET && req->ai_family == AF_INET6)
@@ -235,70 +265,57 @@ convert_hostent_to_gaih_addrtuple (const struct addrinfo *req,
   array[0].name = h->h_name;
   array[count - 1].next = NULL;
 
-  *result = array;
   return true;
 }
 
-#define gethosts(_family) \
- {									      \
-  struct hostent th;							      \
-  char *localcanon = NULL;						      \
-  no_data = 0;								      \
-  while (1)								      \
-    {									      \
-      status = DL_CALL_FCT (fct, (name, _family, &th,			      \
-				  tmpbuf->data, tmpbuf->length,		      \
-				  &errno, &h_errno, NULL, &localcanon));      \
-      if (status != NSS_STATUS_TRYAGAIN || h_errno != NETDB_INTERNAL	      \
-	  || errno != ERANGE)						      \
-	break;								      \
-      if (!scratch_buffer_grow (tmpbuf))				      \
-	{								      \
-	  __resolv_context_put (res_ctx);				      \
-	  result = -EAI_MEMORY;						      \
-	  goto free_and_return;						      \
-	}								      \
-    }									      \
-  if (status == NSS_STATUS_NOTFOUND					      \
-      || status == NSS_STATUS_TRYAGAIN || status == NSS_STATUS_UNAVAIL)	      \
-    {									      \
-      if (h_errno == NETDB_INTERNAL)					      \
-	{								      \
-	  __resolv_context_put (res_ctx);				      \
-	  result = -EAI_SYSTEM;						      \
-	  goto free_and_return;						      \
-	}								      \
-      if (h_errno == TRY_AGAIN)						      \
-	no_data = EAI_AGAIN;						      \
-      else								      \
-	no_data = h_errno == NO_DATA;					      \
-    }									      \
-  else if (status == NSS_STATUS_SUCCESS)				      \
-    {									      \
-      if (!convert_hostent_to_gaih_addrtuple (req, _family, &th, &addrmem))   \
-	{								      \
-	  __resolv_context_put (res_ctx);				      \
-	  result = -EAI_SYSTEM;						      \
-	  goto free_and_return;						      \
-	}								      \
-      *pat = addrmem;							      \
-									      \
-      if (localcanon != NULL && canon == NULL)				      \
-	{								      \
-	  canonbuf = __strdup (localcanon);				      \
-	  if (canonbuf == NULL)						      \
-	    {								      \
-	      __resolv_context_put (res_ctx);				      \
-	      result = -EAI_SYSTEM;					      \
-	      goto free_and_return;					      \
-	    }								      \
-	  canon = canonbuf;						      \
-	}								      \
-      if (_family == AF_INET6 && *pat != NULL)				      \
-	got_ipv6 = true;						      \
-    }									      \
- }
+static int
+gethosts (nss_gethostbyname3_r fct, int family, const char *name,
+	  const struct addrinfo *req, struct scratch_buffer *tmpbuf,
+	  struct gaih_result *res, enum nss_status *statusp, int *no_datap)
+{
+  struct hostent th;
+  char *localcanon = NULL;
+  enum nss_status status;
 
+  *no_datap = 0;
+  while (1)
+    {
+      *statusp = status = DL_CALL_FCT (fct, (name, family, &th,
+					     tmpbuf->data, tmpbuf->length,
+					     &errno, &h_errno, NULL,
+					     &localcanon));
+      if (status != NSS_STATUS_TRYAGAIN || h_errno != NETDB_INTERNAL
+	  || errno != ERANGE)
+	break;
+      if (!scratch_buffer_grow (tmpbuf))
+	return -EAI_MEMORY;
+    }
+  if (status == NSS_STATUS_NOTFOUND
+      || status == NSS_STATUS_TRYAGAIN || status == NSS_STATUS_UNAVAIL)
+    {
+      if (h_errno == NETDB_INTERNAL)
+	return -EAI_SYSTEM;
+      if (h_errno == TRY_AGAIN)
+	*no_datap = EAI_AGAIN;
+      else
+	*no_datap = h_errno == NO_DATA;
+    }
+  else if (status == NSS_STATUS_SUCCESS)
+    {
+      if (!convert_hostent_to_gaih_addrtuple (req, family, &th, res))
+	return -EAI_MEMORY;
+
+      if (localcanon != NULL && res->canon == NULL)
+	{
+	  char *canonbuf = __strdup (localcanon);
+	  if (canonbuf == NULL)
+	    return  -EAI_MEMORY;
+	  res->canon = canonbuf;
+	}
+    }
+
+  return 0;
+}
 
 /* This function is called if a canonical name is requested, but if
    the service function did not provide it.  It tries to obtain the
@@ -323,21 +340,47 @@ getcanonname (nss_action_list nip, struct gaih_addrtuple *at, const char *name)
   return __strdup (name);
 }
 
+/* Process looked up canonical name and if necessary, decode to IDNA.  Result
+   is a new string written to CANONP and the earlier string is freed.  */
+
 static int
-gaih_inet (const char *name, const struct gaih_service *service,
-	   const struct addrinfo *req, struct addrinfo **pai,
-	   unsigned int *naddrs, struct scratch_buffer *tmpbuf)
+process_canonname (const struct addrinfo *req, const char *orig_name,
+		   struct gaih_result *res)
 {
-  const struct gaih_typeproto *tp = gaih_inet_typeproto;
-  struct gaih_servtuple *st = (struct gaih_servtuple *) &nullserv;
-  struct gaih_addrtuple *at = NULL;
-  bool got_ipv6 = false;
-  const char *canon = NULL;
-  const char *orig_name = name;
+  char *canon = res->canon;
 
-  /* Reserve stack memory for the scratch buffer in the getaddrinfo
-     function.  */
-  size_t alloca_used = sizeof (struct scratch_buffer);
+  if ((req->ai_flags & AI_CANONNAME) != 0)
+    {
+      bool do_idn = req->ai_flags & AI_CANONIDN;
+      if (do_idn)
+	{
+	  char *out;
+	  int rc = __idna_from_dns_encoding (canon ?: orig_name, &out);
+	  if (rc == 0)
+	    {
+	      free (canon);
+	      canon = out;
+	    }
+	  else if (rc == EAI_IDN_ENCODE)
+	    /* Use the punycode name as a fallback.  */
+	    do_idn = false;
+	  else
+	    return -rc;
+	}
+      if (!do_idn && canon == NULL && (canon = __strdup (orig_name)) == NULL)
+	return -EAI_MEMORY;
+    }
+
+  res->canon = canon;
+  return 0;
+}
+
+static int
+get_servtuples (const struct gaih_service *service, const struct addrinfo *req,
+		struct gaih_servtuple *st, struct scratch_buffer *tmpbuf)
+{
+  int i;
+  const struct gaih_typeproto *tp = gaih_inet_typeproto;
 
   if (req->ai_protocol || req->ai_socktype)
     {
@@ -359,747 +402,794 @@ gaih_inet (const char *name, const struct gaih_service *service,
 	}
     }
 
-  int port = 0;
-  if (service != NULL)
+  if (service != NULL && (tp->protoflag & GAI_PROTO_NOSERVICE) != 0)
+    return -EAI_SERVICE;
+
+  if (service == NULL || service->num >= 0)
     {
-      if ((tp->protoflag & GAI_PROTO_NOSERVICE) != 0)
-	return -EAI_SERVICE;
+      int port = service != NULL ? htons (service->num) : 0;
 
-      if (service->num < 0)
+      if (req->ai_socktype || req->ai_protocol)
 	{
-	  if (tp->name[0])
-	    {
-	      st = (struct gaih_servtuple *)
-		alloca_account (sizeof (struct gaih_servtuple), alloca_used);
+	  st[0].socktype = tp->socktype;
+	  st[0].protocol = ((tp->protoflag & GAI_PROTO_PROTOANY)
+			  ? req->ai_protocol : tp->protocol);
+	  st[0].port = port;
+	  st[0].set = true;
 
-	      int rc = gaih_inet_serv (service->name, tp, req, st, tmpbuf);
-	      if (__glibc_unlikely (rc != 0))
-		return rc;
-	    }
-	  else
-	    {
-	      struct gaih_servtuple **pst = &st;
-	      for (tp++; tp->name[0]; tp++)
-		{
-		  struct gaih_servtuple *newp;
+	  return 0;
+	}
 
-		  if ((tp->protoflag & GAI_PROTO_NOSERVICE) != 0)
-		    continue;
+      /* Neither socket type nor protocol is set.  Return all socket types
+	 we know about.  */
+      for (i = 0, ++tp; tp->name[0]; ++tp)
+	if (tp->defaultflag)
+	  {
+	    st[i].socktype = tp->socktype;
+	    st[i].protocol = tp->protocol;
+	    st[i].port = port;
+	    st[i++].set = true;
+	  }
 
-		  if (req->ai_socktype != 0
-		      && req->ai_socktype != tp->socktype)
-		    continue;
-		  if (req->ai_protocol != 0
-		      && !(tp->protoflag & GAI_PROTO_PROTOANY)
-		      && req->ai_protocol != tp->protocol)
-		    continue;
+      return 0;
+    }
 
-		  newp = (struct gaih_servtuple *)
-		    alloca_account (sizeof (struct gaih_servtuple),
-				    alloca_used);
+  if (tp->name[0])
+    return gaih_inet_serv (service->name, tp, req, st, tmpbuf);
 
-		  if (gaih_inet_serv (service->name,
-				      tp, req, newp, tmpbuf) != 0)
-		    continue;
+  for (i = 0, tp++; tp->name[0]; tp++)
+    {
+      if ((tp->protoflag & GAI_PROTO_NOSERVICE) != 0)
+	continue;
 
-		  *pst = newp;
-		  pst = &(newp->next);
-		}
-	      if (st == (struct gaih_servtuple *) &nullserv)
-		return -EAI_SERVICE;
-	    }
-	}
-      else
+      if (req->ai_socktype != 0
+	  && req->ai_socktype != tp->socktype)
+	continue;
+      if (req->ai_protocol != 0
+	  && !(tp->protoflag & GAI_PROTO_PROTOANY)
+	  && req->ai_protocol != tp->protocol)
+	continue;
+
+      if (gaih_inet_serv (service->name,
+			  tp, req, &st[i], tmpbuf) != 0)
+	continue;
+
+      i++;
+    }
+
+  if (!st[0].set)
+    return -EAI_SERVICE;
+
+  return 0;
+}
+
+#ifdef USE_NSCD
+/* Query addresses from nscd cache, returning a non-zero value on error.
+   RES members have the lookup result; RES->AT is NULL if there were no errors
+   but also no results.  */
+
+static int
+get_nscd_addresses (const char *name, const struct addrinfo *req,
+		    struct gaih_result *res)
+{
+  if (__nss_not_use_nscd_hosts > 0
+      && ++__nss_not_use_nscd_hosts > NSS_NSCD_RETRY)
+    __nss_not_use_nscd_hosts = 0;
+
+  res->at = NULL;
+
+  if (__nss_not_use_nscd_hosts || __nss_database_custom[NSS_DBSIDX_hosts])
+    return 0;
+
+  /* Try to use nscd.  */
+  struct nscd_ai_result *air = NULL;
+  int err = __nscd_getai (name, &air, &h_errno);
+
+  if (__glibc_unlikely (air == NULL))
+    {
+      /* The database contains a negative entry.  */
+      if (err == 0)
+	return -EAI_NONAME;
+      if (__nss_not_use_nscd_hosts == 0)
 	{
-	  port = htons (service->num);
-	  goto got_port;
+	  if (h_errno == NETDB_INTERNAL && errno == ENOMEM)
+	    return -EAI_MEMORY;
+	  if (h_errno == TRY_AGAIN)
+	    return -EAI_AGAIN;
+	  return -EAI_SYSTEM;
 	}
+      return 0;
     }
-  else
+
+  /* Transform into gaih_addrtuple list.  */
+  int result = 0;
+  char *addrs = air->addrs;
+
+  struct gaih_addrtuple *addrfree = calloc (air->naddrs, sizeof (*addrfree));
+  struct gaih_addrtuple *at = calloc (air->naddrs, sizeof (*at));
+  if (at == NULL)
     {
-    got_port:
+      result = -EAI_MEMORY;
+      goto out;
+    }
 
-      if (req->ai_socktype || req->ai_protocol)
+  res->free_at = true;
+
+  int count = 0;
+  for (int i = 0; i < air->naddrs; ++i)
+    {
+      socklen_t size = (air->family[i] == AF_INET
+			? INADDRSZ : IN6ADDRSZ);
+
+      if (!((air->family[i] == AF_INET
+	     && req->ai_family == AF_INET6
+	     && (req->ai_flags & AI_V4MAPPED) != 0)
+	    || req->ai_family == AF_UNSPEC
+	    || air->family[i] == req->ai_family))
 	{
-	  st = alloca_account (sizeof (struct gaih_servtuple), alloca_used);
-	  st->next = NULL;
-	  st->socktype = tp->socktype;
-	  st->protocol = ((tp->protoflag & GAI_PROTO_PROTOANY)
-			  ? req->ai_protocol : tp->protocol);
-	  st->port = port;
+	  /* Skip over non-matching result.  */
+	  addrs += size;
+	  continue;
 	}
-      else
+
+      if (air->family[i] == AF_INET && req->ai_family == AF_INET6
+	  && (req->ai_flags & AI_V4MAPPED))
+	{
+	  at[count].family = AF_INET6;
+	  at[count].addr[3] = *(uint32_t *) addrs;
+	  at[count].addr[2] = htonl (0xffff);
+	}
+      else if (req->ai_family == AF_UNSPEC
+	       || air->family[count] == req->ai_family)
 	{
-	  /* Neither socket type nor protocol is set.  Return all socket types
-	     we know about.  */
-	  struct gaih_servtuple **lastp = &st;
-	  for (++tp; tp->name[0]; ++tp)
-	    if (tp->defaultflag)
-	      {
-		struct gaih_servtuple *newp;
-
-		newp = alloca_account (sizeof (struct gaih_servtuple),
-				       alloca_used);
-		newp->next = NULL;
-		newp->socktype = tp->socktype;
-		newp->protocol = tp->protocol;
-		newp->port = port;
-
-		*lastp = newp;
-		lastp = &newp->next;
-	      }
+	  at[count].family = air->family[count];
+	  memcpy (at[count].addr, addrs, size);
+	  if (air->family[count] == AF_INET6)
+	    res->got_ipv6 = true;
 	}
+      at[count].next = at + count + 1;
+      count++;
+      addrs += size;
     }
 
-  bool malloc_name = false;
-  struct gaih_addrtuple *addrmem = NULL;
-  char *canonbuf = NULL;
+  if ((req->ai_flags & AI_CANONNAME) && air->canon != NULL)
+    {
+      char *canonbuf = __strdup (air->canon);
+      if (canonbuf == NULL)
+	{
+	  result = -EAI_MEMORY;
+	  goto out;
+	}
+      res->canon = canonbuf;
+    }
+
+  if (count == 0)
+    {
+      result = -EAI_NONAME;
+      goto out;
+    }
+
+  at[count - 1].next = NULL;
+
+  res->at = at;
+
+out:
+  free (air);
+  if (result != 0)
+    {
+      free (at);
+      res->free_at = false;
+    }
+
+  return result;
+}
+#endif
+
+static int
+get_nss_addresses (const char *name, const struct addrinfo *req,
+		   struct scratch_buffer *tmpbuf, struct gaih_result *res)
+{
+  int no_data = 0;
+  int no_inet6_data = 0;
+  nss_action_list nip;
+  enum nss_status inet6_status = NSS_STATUS_UNAVAIL;
+  enum nss_status status = NSS_STATUS_UNAVAIL;
+  int no_more;
+  struct resolv_context *res_ctx = NULL;
+  bool do_merge = false;
   int result = 0;
 
-  if (name != NULL)
+  no_more = !__nss_database_get (nss_database_hosts, &nip);
+
+  /* If we are looking for both IPv4 and IPv6 address we don't
+     want the lookup functions to automatically promote IPv4
+     addresses to IPv6 addresses, so we use the no_inet6
+     function variant.  */
+  res_ctx = __resolv_context_get ();
+  if (res_ctx == NULL)
+    no_more = 1;
+
+  while (!no_more)
     {
-      at = alloca_account (sizeof (struct gaih_addrtuple), alloca_used);
-      at->family = AF_UNSPEC;
-      at->scopeid = 0;
-      at->next = NULL;
+      /* Always start afresh; continue should discard previous results
+	 and the hosts database does not support merge.  */
+      gaih_result_reset (res);
 
-      if (req->ai_flags & AI_IDN)
+      if (do_merge)
 	{
-	  char *out;
-	  result = __idna_to_dns_encoding (name, &out);
-	  if (result != 0)
-	    return -result;
-	  name = out;
-	  malloc_name = true;
+	  __set_h_errno (NETDB_INTERNAL);
+	  __set_errno (EBUSY);
+	  break;
 	}
 
-      if (__inet_aton_exact (name, (struct in_addr *) at->addr) != 0)
-	{
-	  if (req->ai_family == AF_UNSPEC || req->ai_family == AF_INET)
-	    at->family = AF_INET;
-	  else if (req->ai_family == AF_INET6 && (req->ai_flags & AI_V4MAPPED))
-	    {
-	      at->addr[3] = at->addr[0];
-	      at->addr[2] = htonl (0xffff);
-	      at->addr[1] = 0;
-	      at->addr[0] = 0;
-	      at->family = AF_INET6;
-	    }
-	  else
-	    {
-	      result = -EAI_ADDRFAMILY;
-	      goto free_and_return;
-	    }
+      no_data = 0;
+      nss_gethostbyname4_r *fct4 = NULL;
 
-	  if (req->ai_flags & AI_CANONNAME)
-	    canon = name;
-	}
-      else if (at->family == AF_UNSPEC)
+      /* gethostbyname4_r sends out parallel A and AAAA queries and
+	 is thus only suitable for PF_UNSPEC.  */
+      if (req->ai_family == PF_UNSPEC)
+	fct4 = __nss_lookup_function (nip, "gethostbyname4_r");
+
+      if (fct4 != NULL)
 	{
-	  char *scope_delim = strchr (name, SCOPE_DELIMITER);
-	  int e;
-	  if (scope_delim == NULL)
-	    e = inet_pton (AF_INET6, name, at->addr);
-	  else
-	    e = __inet_pton_length (AF_INET6, name, scope_delim - name,
-				    at->addr);
-	  if (e > 0)
+	  while (1)
 	    {
-	      if (req->ai_family == AF_UNSPEC || req->ai_family == AF_INET6)
-		at->family = AF_INET6;
-	      else if (req->ai_family == AF_INET
-		       && IN6_IS_ADDR_V4MAPPED (at->addr))
-		{
-		  at->addr[0] = at->addr[3];
-		  at->family = AF_INET;
-		}
-	      else
+	      status = DL_CALL_FCT (fct4, (name, &res->at,
+					   tmpbuf->data, tmpbuf->length,
+					   &errno, &h_errno,
+					   NULL));
+	      if (status == NSS_STATUS_SUCCESS)
+		break;
+	      /* gethostbyname4_r may write into AT, so reset it.  */
+	      res->at = NULL;
+	      if (status != NSS_STATUS_TRYAGAIN
+		  || errno != ERANGE || h_errno != NETDB_INTERNAL)
 		{
-		  result = -EAI_ADDRFAMILY;
-		  goto free_and_return;
+		  if (h_errno == TRY_AGAIN)
+		    no_data = EAI_AGAIN;
+		  else
+		    no_data = h_errno == NO_DATA;
+		  break;
 		}
 
-	      if (scope_delim != NULL
-		  && __inet6_scopeid_pton ((struct in6_addr *) at->addr,
-					   scope_delim + 1,
-					   &at->scopeid) != 0)
+	      if (!scratch_buffer_grow (tmpbuf))
 		{
-		  result = -EAI_NONAME;
-		  goto free_and_return;
+		  __resolv_context_put (res_ctx);
+		  result = -EAI_MEMORY;
+		  goto out;
 		}
-
-	      if (req->ai_flags & AI_CANONNAME)
-		canon = name;
 	    }
-	}
 
-      if (at->family == AF_UNSPEC && (req->ai_flags & AI_NUMERICHOST) == 0)
-	{
-	  struct gaih_addrtuple **pat = &at;
-	  int no_data = 0;
-	  int no_inet6_data = 0;
-	  nss_action_list nip;
-	  enum nss_status inet6_status = NSS_STATUS_UNAVAIL;
-	  enum nss_status status = NSS_STATUS_UNAVAIL;
-	  int no_more;
-	  struct resolv_context *res_ctx = NULL;
-
-	  /* If we do not have to look for IPv6 addresses or the canonical
-	     name, use the simple, old functions, which do not support
-	     IPv6 scope ids, nor retrieving the canonical name.  */
-	  if (req->ai_family == AF_INET
-	      && (req->ai_flags & AI_CANONNAME) == 0)
+	  if (status == NSS_STATUS_SUCCESS)
 	    {
-	      int rc;
-	      struct hostent th;
-	      struct hostent *h;
+	      assert (!no_data);
+	      no_data = 1;
 
-	      while (1)
+	      if ((req->ai_flags & AI_CANONNAME) != 0 && res->canon == NULL)
 		{
-		  rc = __gethostbyname2_r (name, AF_INET, &th,
-					   tmpbuf->data, tmpbuf->length,
-					   &h, &h_errno);
-		  if (rc != ERANGE || h_errno != NETDB_INTERNAL)
-		    break;
-		  if (!scratch_buffer_grow (tmpbuf))
+		  char *canonbuf = __strdup (res->at->name);
+		  if (canonbuf == NULL)
 		    {
+		      __resolv_context_put (res_ctx);
 		      result = -EAI_MEMORY;
-		      goto free_and_return;
+		      goto out;
 		    }
+		  res->canon = canonbuf;
 		}
 
-	      if (rc == 0)
+	      struct gaih_addrtuple **pat = &res->at;
+
+	      while (*pat != NULL)
 		{
-		  if (h != NULL)
+		  if ((*pat)->family == AF_INET
+		      && req->ai_family == AF_INET6
+		      && (req->ai_flags & AI_V4MAPPED) != 0)
 		    {
-		      /* We found data, convert it.  */
-		      if (!convert_hostent_to_gaih_addrtuple
-			  (req, AF_INET, h, &addrmem))
-			{
-			  result = -EAI_MEMORY;
-			  goto free_and_return;
-			}
-		      *pat = addrmem;
+		      uint32_t *pataddr = (*pat)->addr;
+		      (*pat)->family = AF_INET6;
+		      pataddr[3] = pataddr[0];
+		      pataddr[2] = htonl (0xffff);
+		      pataddr[1] = 0;
+		      pataddr[0] = 0;
+		      pat = &((*pat)->next);
+		      no_data = 0;
 		    }
-		  else
+		  else if (req->ai_family == AF_UNSPEC
+			   || (*pat)->family == req->ai_family)
 		    {
-		      if (h_errno == NO_DATA)
-			result = -EAI_NODATA;
-		      else
-			result = -EAI_NONAME;
-		      goto free_and_return;
+		      pat = &((*pat)->next);
+
+		      no_data = 0;
+		      if (req->ai_family == AF_INET6)
+			res->got_ipv6 = true;
 		    }
-		}
-	      else
-		{
-		  if (h_errno == NETDB_INTERNAL)
-		    result = -EAI_SYSTEM;
-		  else if (h_errno == TRY_AGAIN)
-		    result = -EAI_AGAIN;
 		  else
-		    /* We made requests but they turned out no data.
-		       The name is known, though.  */
-		    result = -EAI_NODATA;
-
-		  goto free_and_return;
+		    *pat = ((*pat)->next);
 		}
-
-	      goto process_list;
 	    }
 
-#ifdef USE_NSCD
-	  if (__nss_not_use_nscd_hosts > 0
-	      && ++__nss_not_use_nscd_hosts > NSS_NSCD_RETRY)
-	    __nss_not_use_nscd_hosts = 0;
-
-	  if (!__nss_not_use_nscd_hosts
-	      && !__nss_database_custom[NSS_DBSIDX_hosts])
+	  no_inet6_data = no_data;
+	}
+      else
+	{
+	  nss_gethostbyname3_r *fct = NULL;
+	  if (req->ai_flags & AI_CANONNAME)
+	    /* No need to use this function if we do not look for
+	       the canonical name.  The function does not exist in
+	       all NSS modules and therefore the lookup would
+	       often fail.  */
+	    fct = __nss_lookup_function (nip, "gethostbyname3_r");
+	  if (fct == NULL)
+	    /* We are cheating here.  The gethostbyname2_r
+	       function does not have the same interface as
+	       gethostbyname3_r but the extra arguments the
+	       latter takes are added at the end.  So the
+	       gethostbyname2_r code will just ignore them.  */
+	    fct = __nss_lookup_function (nip, "gethostbyname2_r");
+
+	  if (fct != NULL)
 	    {
-	      /* Try to use nscd.  */
-	      struct nscd_ai_result *air = NULL;
-	      int err = __nscd_getai (name, &air, &h_errno);
-	      if (air != NULL)
+	      if (req->ai_family == AF_INET6
+		  || req->ai_family == AF_UNSPEC)
 		{
-		  /* Transform into gaih_addrtuple list.  */
-		  bool added_canon = (req->ai_flags & AI_CANONNAME) == 0;
-		  char *addrs = air->addrs;
-
-		  addrmem = calloc (air->naddrs, sizeof (*addrmem));
-		  if (addrmem == NULL)
+		  if ((result = gethosts (fct, AF_INET6, name, req, tmpbuf,
+					  res, &status, &no_data)) != 0)
 		    {
-		      result = -EAI_MEMORY;
-		      goto free_and_return;
+		      __resolv_context_put (res_ctx);
+		      goto out;
 		    }
-
-		  struct gaih_addrtuple *addrfree = addrmem;
-		  for (int i = 0; i < air->naddrs; ++i)
+		  no_inet6_data = no_data;
+		  inet6_status = status;
+		}
+	      if (req->ai_family == AF_INET
+		  || req->ai_family == AF_UNSPEC
+		  || (req->ai_family == AF_INET6
+		      && (req->ai_flags & AI_V4MAPPED)
+		      /* Avoid generating the mapped addresses if we
+			 know we are not going to need them.  */
+		      && ((req->ai_flags & AI_ALL) || !res->got_ipv6)))
+		{
+		  if ((result = gethosts (fct, AF_INET, name, req, tmpbuf,
+					  res, &status, &no_data)) != 0)
 		    {
-		      socklen_t size = (air->family[i] == AF_INET
-					? INADDRSZ : IN6ADDRSZ);
-
-		      if (!((air->family[i] == AF_INET
-			     && req->ai_family == AF_INET6
-			     && (req->ai_flags & AI_V4MAPPED) != 0)
-			    || req->ai_family == AF_UNSPEC
-			    || air->family[i] == req->ai_family))
-			{
-			  /* Skip over non-matching result.  */
-			  addrs += size;
-			  continue;
-			}
-
-		      if (*pat == NULL)
-			{
-			  *pat = addrfree++;
-			  (*pat)->scopeid = 0;
-			}
-		      uint32_t *pataddr = (*pat)->addr;
-		      (*pat)->next = NULL;
-		      if (added_canon || air->canon == NULL)
-			(*pat)->name = NULL;
-		      else if (canonbuf == NULL)
-			{
-			  canonbuf = __strdup (air->canon);
-			  if (canonbuf == NULL)
-			    {
-			      result = -EAI_MEMORY;
-			      goto free_and_return;
-			    }
-			  canon = (*pat)->name = canonbuf;
-			}
-
-		      if (air->family[i] == AF_INET
-			  && req->ai_family == AF_INET6
-			  && (req->ai_flags & AI_V4MAPPED))
-			{
-			  (*pat)->family = AF_INET6;
-			  pataddr[3] = *(uint32_t *) addrs;
-			  pataddr[2] = htonl (0xffff);
-			  pataddr[1] = 0;
-			  pataddr[0] = 0;
-			  pat = &((*pat)->next);
-			  added_canon = true;
-			}
-		      else if (req->ai_family == AF_UNSPEC
-			       || air->family[i] == req->ai_family)
-			{
-			  (*pat)->family = air->family[i];
-			  memcpy (pataddr, addrs, size);
-			  pat = &((*pat)->next);
-			  added_canon = true;
-			  if (air->family[i] == AF_INET6)
-			    got_ipv6 = true;
-			}
-		      addrs += size;
+		      __resolv_context_put (res_ctx);
+		      goto out;
 		    }
 
-		  free (air);
-
-		  if (at->family == AF_UNSPEC)
+		  if (req->ai_family == AF_INET)
 		    {
-		      result = -EAI_NONAME;
-		      goto free_and_return;
+		      no_inet6_data = no_data;
+		      inet6_status = status;
 		    }
-
-		  goto process_list;
-		}
-	      else if (err == 0)
-		/* The database contains a negative entry.  */
-		goto free_and_return;
-	      else if (__nss_not_use_nscd_hosts == 0)
-		{
-		  if (h_errno == NETDB_INTERNAL && errno == ENOMEM)
-		    result = -EAI_MEMORY;
-		  else if (h_errno == TRY_AGAIN)
-		    result = -EAI_AGAIN;
-		  else
-		    result = -EAI_SYSTEM;
-
-		  goto free_and_return;
 		}
-	    }
-#endif
-
-	  no_more = !__nss_database_get (nss_database_hosts, &nip);
-
-	  /* If we are looking for both IPv4 and IPv6 address we don't
-	     want the lookup functions to automatically promote IPv4
-	     addresses to IPv6 addresses, so we use the no_inet6
-	     function variant.  */
-	  res_ctx = __resolv_context_get ();
-	  if (res_ctx == NULL)
-	    no_more = 1;
 
-	  while (!no_more)
-	    {
-	      no_data = 0;
-	      nss_gethostbyname4_r *fct4 = NULL;
-
-	      /* gethostbyname4_r sends out parallel A and AAAA queries and
-		 is thus only suitable for PF_UNSPEC.  */
-	      if (req->ai_family == PF_UNSPEC)
-		fct4 = __nss_lookup_function (nip, "gethostbyname4_r");
-
-	      if (fct4 != NULL)
+	      /* If we found one address for AF_INET or AF_INET6,
+		 don't continue the search.  */
+	      if (inet6_status == NSS_STATUS_SUCCESS
+		  || status == NSS_STATUS_SUCCESS)
 		{
-		  while (1)
+		  if ((req->ai_flags & AI_CANONNAME) != 0
+		      && res->canon == NULL)
 		    {
-		      status = DL_CALL_FCT (fct4, (name, pat,
-						   tmpbuf->data, tmpbuf->length,
-						   &errno, &h_errno,
-						   NULL));
-		      if (status == NSS_STATUS_SUCCESS)
-			break;
-		      if (status != NSS_STATUS_TRYAGAIN
-			  || errno != ERANGE || h_errno != NETDB_INTERNAL)
-			{
-			  if (h_errno == TRY_AGAIN)
-			    no_data = EAI_AGAIN;
-			  else
-			    no_data = h_errno == NO_DATA;
-			  break;
-			}
-
-		      if (!scratch_buffer_grow (tmpbuf))
+		      char *canonbuf = getcanonname (nip, res->at, name);
+		      if (canonbuf == NULL)
 			{
 			  __resolv_context_put (res_ctx);
 			  result = -EAI_MEMORY;
-			  goto free_and_return;
+			  goto out;
 			}
+		      res->canon = canonbuf;
 		    }
+		  status = NSS_STATUS_SUCCESS;
+		}
+	      else
+		{
+		  /* We can have different states for AF_INET and
+		     AF_INET6.  Try to find a useful one for both.  */
+		  if (inet6_status == NSS_STATUS_TRYAGAIN)
+		    status = NSS_STATUS_TRYAGAIN;
+		  else if (status == NSS_STATUS_UNAVAIL
+			   && inet6_status != NSS_STATUS_UNAVAIL)
+		    status = inet6_status;
+		}
+	    }
+	  else
+	    {
+	      /* Could not locate any of the lookup functions.
+		 The NSS lookup code does not consistently set
+		 errno, so we need to supply our own error
+		 code here.  The root cause could either be a
+		 resource allocation failure, or a missing
+		 service function in the DSO (so it should not
+		 be listed in /etc/nsswitch.conf).  Assume the
+		 former, and return EBUSY.  */
+	      status = NSS_STATUS_UNAVAIL;
+	      __set_h_errno (NETDB_INTERNAL);
+	      __set_errno (EBUSY);
+	    }
+	}
 
-		  if (status == NSS_STATUS_SUCCESS)
-		    {
-		      assert (!no_data);
-		      no_data = 1;
+      if (nss_next_action (nip, status) == NSS_ACTION_RETURN)
+	break;
 
-		      if ((req->ai_flags & AI_CANONNAME) != 0 && canon == NULL)
-			canon = (*pat)->name;
+      /* The hosts database does not support MERGE.  */
+      if (nss_next_action (nip, status) == NSS_ACTION_MERGE)
+	do_merge = true;
 
-		      while (*pat != NULL)
-			{
-			  if ((*pat)->family == AF_INET
-			      && req->ai_family == AF_INET6
-			      && (req->ai_flags & AI_V4MAPPED) != 0)
-			    {
-			      uint32_t *pataddr = (*pat)->addr;
-			      (*pat)->family = AF_INET6;
-			      pataddr[3] = pataddr[0];
-			      pataddr[2] = htonl (0xffff);
-			      pataddr[1] = 0;
-			      pataddr[0] = 0;
-			      pat = &((*pat)->next);
-			      no_data = 0;
-			    }
-			  else if (req->ai_family == AF_UNSPEC
-				   || (*pat)->family == req->ai_family)
-			    {
-			      pat = &((*pat)->next);
-
-			      no_data = 0;
-			      if (req->ai_family == AF_INET6)
-				got_ipv6 = true;
-			    }
-			  else
-			    *pat = ((*pat)->next);
-			}
-		    }
+      nip++;
+      if (nip->module == NULL)
+	no_more = -1;
+    }
 
-		  no_inet6_data = no_data;
-		}
-	      else
-		{
-		  nss_gethostbyname3_r *fct = NULL;
-		  if (req->ai_flags & AI_CANONNAME)
-		    /* No need to use this function if we do not look for
-		       the canonical name.  The function does not exist in
-		       all NSS modules and therefore the lookup would
-		       often fail.  */
-		    fct = __nss_lookup_function (nip, "gethostbyname3_r");
-		  if (fct == NULL)
-		    /* We are cheating here.  The gethostbyname2_r
-		       function does not have the same interface as
-		       gethostbyname3_r but the extra arguments the
-		       latter takes are added at the end.  So the
-		       gethostbyname2_r code will just ignore them.  */
-		    fct = __nss_lookup_function (nip, "gethostbyname2_r");
-
-		  if (fct != NULL)
-		    {
-		      if (req->ai_family == AF_INET6
-			  || req->ai_family == AF_UNSPEC)
-			{
-			  gethosts (AF_INET6);
-			  no_inet6_data = no_data;
-			  inet6_status = status;
-			}
-		      if (req->ai_family == AF_INET
-			  || req->ai_family == AF_UNSPEC
-			  || (req->ai_family == AF_INET6
-			      && (req->ai_flags & AI_V4MAPPED)
-			      /* Avoid generating the mapped addresses if we
-				 know we are not going to need them.  */
-			      && ((req->ai_flags & AI_ALL) || !got_ipv6)))
-			{
-			  gethosts (AF_INET);
+  __resolv_context_put (res_ctx);
 
-			  if (req->ai_family == AF_INET)
-			    {
-			      no_inet6_data = no_data;
-			      inet6_status = status;
-			    }
-			}
+  /* If we have a failure which sets errno, report it using
+     EAI_SYSTEM.  */
+  if ((status == NSS_STATUS_TRYAGAIN || status == NSS_STATUS_UNAVAIL)
+      && h_errno == NETDB_INTERNAL)
+    {
+      result = -EAI_SYSTEM;
+      goto out;
+    }
 
-		      /* If we found one address for AF_INET or AF_INET6,
-			 don't continue the search.  */
-		      if (inet6_status == NSS_STATUS_SUCCESS
-			  || status == NSS_STATUS_SUCCESS)
-			{
-			  if ((req->ai_flags & AI_CANONNAME) != 0
-			      && canon == NULL)
-			    {
-			      canonbuf = getcanonname (nip, at, name);
-			      if (canonbuf == NULL)
-				{
-				  __resolv_context_put (res_ctx);
-				  result = -EAI_MEMORY;
-				  goto free_and_return;
-				}
-			      canon = canonbuf;
-			    }
-			  status = NSS_STATUS_SUCCESS;
-			}
-		      else
-			{
-			  /* We can have different states for AF_INET and
-			     AF_INET6.  Try to find a useful one for both.  */
-			  if (inet6_status == NSS_STATUS_TRYAGAIN)
-			    status = NSS_STATUS_TRYAGAIN;
-			  else if (status == NSS_STATUS_UNAVAIL
-				   && inet6_status != NSS_STATUS_UNAVAIL)
-			    status = inet6_status;
-			}
-		    }
-		  else
-		    {
-		      /* Could not locate any of the lookup functions.
-			 The NSS lookup code does not consistently set
-			 errno, so we need to supply our own error
-			 code here.  The root cause could either be a
-			 resource allocation failure, or a missing
-			 service function in the DSO (so it should not
-			 be listed in /etc/nsswitch.conf).  Assume the
-			 former, and return EBUSY.  */
-		      status = NSS_STATUS_UNAVAIL;
-		     __set_h_errno (NETDB_INTERNAL);
-		     __set_errno (EBUSY);
-		    }
-		}
+  if (no_data != 0 && no_inet6_data != 0)
+    {
+      /* If both requests timed out report this.  */
+      if (no_data == EAI_AGAIN && no_inet6_data == EAI_AGAIN)
+	result = -EAI_AGAIN;
+      else
+	/* We made requests but they turned out no data.  The name
+	   is known, though.  */
+	result = -EAI_NODATA;
+    }
 
-	      if (nss_next_action (nip, status) == NSS_ACTION_RETURN)
-		break;
+out:
+  if (result != 0)
+    gaih_result_reset (res);
+  return result;
+}
 
-	      nip++;
-	      if (nip->module == NULL)
-		no_more = -1;
-	    }
+/* Convert numeric addresses to binary into RES.  On failure, RES->AT is set to
+   NULL and an error code is returned.  If AI_NUMERIC_HOST is not requested and
+   the function cannot determine a result, RES->AT is set to NULL and 0
+   returned.  */
 
-	  __resolv_context_put (res_ctx);
+static int
+text_to_binary_address (const char *name, const struct addrinfo *req,
+			struct gaih_result *res)
+{
+  struct gaih_addrtuple *at = res->at;
+  int result = 0;
+
+  assert (at != NULL);
+
+  memset (at->addr, 0, sizeof (at->addr));
+  if (__inet_aton_exact (name, (struct in_addr *) at->addr) != 0)
+    {
+      if (req->ai_family == AF_UNSPEC || req->ai_family == AF_INET)
+	at->family = AF_INET;
+      else if (req->ai_family == AF_INET6 && (req->ai_flags & AI_V4MAPPED))
+	{
+	  at->addr[3] = at->addr[0];
+	  at->addr[2] = htonl (0xffff);
+	  at->addr[1] = 0;
+	  at->addr[0] = 0;
+	  at->family = AF_INET6;
+	}
+      else
+	{
+	  result = -EAI_ADDRFAMILY;
+	  goto out;
+	}
 
-	  /* If we have a failure which sets errno, report it using
-	     EAI_SYSTEM.  */
-	  if ((status == NSS_STATUS_TRYAGAIN || status == NSS_STATUS_UNAVAIL)
-	      && h_errno == NETDB_INTERNAL)
+      if (req->ai_flags & AI_CANONNAME)
+	{
+	  char *canonbuf = __strdup (name);
+	  if (canonbuf == NULL)
 	    {
-	      result = -EAI_SYSTEM;
-	      goto free_and_return;
+	      result = -EAI_MEMORY;
+	      goto out;
 	    }
+	  res->canon = canonbuf;
+	}
+      return 0;
+    }
 
-	  if (no_data != 0 && no_inet6_data != 0)
-	    {
-	      /* If both requests timed out report this.  */
-	      if (no_data == EAI_AGAIN && no_inet6_data == EAI_AGAIN)
-		result = -EAI_AGAIN;
-	      else
-		/* We made requests but they turned out no data.  The name
-		   is known, though.  */
-		result = -EAI_NODATA;
+  char *scope_delim = strchr (name, SCOPE_DELIMITER);
+  int e;
 
-	      goto free_and_return;
-	    }
+  if (scope_delim == NULL)
+    e = inet_pton (AF_INET6, name, at->addr);
+  else
+    e = __inet_pton_length (AF_INET6, name, scope_delim - name, at->addr);
+
+  if (e > 0)
+    {
+      if (req->ai_family == AF_UNSPEC || req->ai_family == AF_INET6)
+	at->family = AF_INET6;
+      else if (req->ai_family == AF_INET
+	       && IN6_IS_ADDR_V4MAPPED (at->addr))
+	{
+	  at->addr[0] = at->addr[3];
+	  at->family = AF_INET;
+	}
+      else
+	{
+	  result = -EAI_ADDRFAMILY;
+	  goto out;
 	}
 
-    process_list:
-      if (at->family == AF_UNSPEC)
+      if (scope_delim != NULL
+	  && __inet6_scopeid_pton ((struct in6_addr *) at->addr,
+				   scope_delim + 1, &at->scopeid) != 0)
 	{
 	  result = -EAI_NONAME;
-	  goto free_and_return;
+	  goto out;
+	}
+
+      if (req->ai_flags & AI_CANONNAME)
+	{
+	  char *canonbuf = __strdup (name);
+	  if (canonbuf == NULL)
+	    {
+	      result = -EAI_MEMORY;
+	      goto out;
+	    }
+	  res->canon = canonbuf;
 	}
+      return 0;
     }
-  else
+
+  if ((req->ai_flags & AI_NUMERICHOST))
+    result = -EAI_NONAME;
+
+out:
+  res->at = NULL;
+  return result;
+}
+
+/* If possible, call the simple, old functions, which do not support IPv6 scope
+   ids, nor retrieving the canonical name.  */
+
+static int
+try_simple_gethostbyname (const char *name, const struct addrinfo *req,
+			  struct scratch_buffer *tmpbuf,
+			  struct gaih_result *res)
+{
+  res->at = NULL;
+
+  if (req->ai_family != AF_INET || (req->ai_flags & AI_CANONNAME) != 0)
+    return 0;
+
+  int rc;
+  struct hostent th;
+  struct hostent *h;
+
+  while (1)
     {
-      struct gaih_addrtuple *atr;
-      atr = at = alloca_account (sizeof (struct gaih_addrtuple), alloca_used);
-      memset (at, '\0', sizeof (struct gaih_addrtuple));
+      rc = __gethostbyname2_r (name, AF_INET, &th, tmpbuf->data,
+			       tmpbuf->length, &h, &h_errno);
+      if (rc != ERANGE || h_errno != NETDB_INTERNAL)
+	break;
+      if (!scratch_buffer_grow (tmpbuf))
+	return -EAI_MEMORY;
+    }
 
-      if (req->ai_family == AF_UNSPEC)
+  if (rc == 0)
+    {
+      if (h != NULL)
 	{
-	  at->next = __alloca (sizeof (struct gaih_addrtuple));
-	  memset (at->next, '\0', sizeof (struct gaih_addrtuple));
+	  /* We found data, convert it.  RES->AT from the conversion will
+	     either be an allocated block or NULL, both of which are safe to
+	     pass to free ().  */
+	  if (!convert_hostent_to_gaih_addrtuple (req, AF_INET, h, res))
+	    return -EAI_MEMORY;
+
+	  res->free_at = true;
+	  return 0;
 	}
+      if (h_errno == NO_DATA)
+	return -EAI_NODATA;
 
-      if (req->ai_family == AF_UNSPEC || req->ai_family == AF_INET6)
+      return -EAI_NONAME;
+    }
+
+  if (h_errno == NETDB_INTERNAL)
+    return -EAI_SYSTEM;
+  if (h_errno == TRY_AGAIN)
+    return -EAI_AGAIN;
+
+  /* We made requests but they turned out no data.
+     The name is known, though.  */
+  return -EAI_NODATA;
+}
+
+/* Add local address information into RES.  RES->AT is assumed to have enough
+   space for two tuples and is zeroed out.  */
+
+static void
+get_local_addresses (const struct addrinfo *req, struct gaih_result *res)
+{
+  struct gaih_addrtuple *atr = res->at;
+  if (req->ai_family == AF_UNSPEC)
+    res->at->next = res->at + 1;
+
+  if (req->ai_family == AF_UNSPEC || req->ai_family == AF_INET6)
+    {
+      res->at->family = AF_INET6;
+      if ((req->ai_flags & AI_PASSIVE) == 0)
+	memcpy (res->at->addr, &in6addr_loopback, sizeof (struct in6_addr));
+      atr = res->at->next;
+    }
+
+  if (req->ai_family == AF_UNSPEC || req->ai_family == AF_INET)
+    {
+      atr->family = AF_INET;
+      if ((req->ai_flags & AI_PASSIVE) == 0)
+	atr->addr[0] = htonl (INADDR_LOOPBACK);
+    }
+}
+
+/* Generate results in PAI and its count in NADDRS.  Return 0 on success or an
+   error code on failure.  */
+
+static int
+generate_addrinfo (const struct addrinfo *req, struct gaih_result *res,
+		   const struct gaih_servtuple *st, struct addrinfo **pai,
+		   unsigned int *naddrs)
+{
+  size_t socklen;
+  sa_family_t family;
+
+  /* Buffer is the size of an unformatted IPv6 address in printable format.  */
+  for (struct gaih_addrtuple *at = res->at; at != NULL; at = at->next)
+    {
+      family = at->family;
+      if (family == AF_INET6)
 	{
-	  at->family = AF_INET6;
-	  if ((req->ai_flags & AI_PASSIVE) == 0)
-	    memcpy (at->addr, &in6addr_loopback, sizeof (struct in6_addr));
-	  atr = at->next;
+	  socklen = sizeof (struct sockaddr_in6);
+
+	  /* If we looked up IPv4 mapped address discard them here if
+	     the caller isn't interested in all address and we have
+	     found at least one IPv6 address.  */
+	  if (res->got_ipv6
+	      && (req->ai_flags & (AI_V4MAPPED|AI_ALL)) == AI_V4MAPPED
+	      && IN6_IS_ADDR_V4MAPPED (at->addr))
+	    continue;
 	}
+      else
+	socklen = sizeof (struct sockaddr_in);
 
-      if (req->ai_family == AF_UNSPEC || req->ai_family == AF_INET)
+      for (int i = 0; st[i].set; i++)
 	{
-	  atr->family = AF_INET;
-	  if ((req->ai_flags & AI_PASSIVE) == 0)
-	    atr->addr[0] = htonl (INADDR_LOOPBACK);
+	  struct addrinfo *ai;
+	  ai = *pai = malloc (sizeof (struct addrinfo) + socklen);
+	  if (ai == NULL)
+	    return -EAI_MEMORY;
+
+	  ai->ai_flags = req->ai_flags;
+	  ai->ai_family = family;
+	  ai->ai_socktype = st[i].socktype;
+	  ai->ai_protocol = st[i].protocol;
+	  ai->ai_addrlen = socklen;
+	  ai->ai_addr = (void *) (ai + 1);
+
+	  /* We only add the canonical name once.  */
+	  ai->ai_canonname = res->canon;
+	  res->canon = NULL;
+
+#ifdef _HAVE_SA_LEN
+	  ai->ai_addr->sa_len = socklen;
+#endif /* _HAVE_SA_LEN */
+	  ai->ai_addr->sa_family = family;
+
+	  /* In case of an allocation error the list must be NULL
+	     terminated.  */
+	  ai->ai_next = NULL;
+
+	  if (family == AF_INET6)
+	    {
+	      struct sockaddr_in6 *sin6p = (struct sockaddr_in6 *) ai->ai_addr;
+	      sin6p->sin6_port = st[i].port;
+	      sin6p->sin6_flowinfo = 0;
+	      memcpy (&sin6p->sin6_addr, at->addr, sizeof (struct in6_addr));
+	      sin6p->sin6_scope_id = at->scopeid;
+	    }
+	  else
+	    {
+	      struct sockaddr_in *sinp = (struct sockaddr_in *) ai->ai_addr;
+	      sinp->sin_port = st[i].port;
+	      memcpy (&sinp->sin_addr, at->addr, sizeof (struct in_addr));
+	      memset (sinp->sin_zero, '\0', sizeof (sinp->sin_zero));
+	    }
+
+	  pai = &(ai->ai_next);
 	}
+
+      ++*naddrs;
     }
+  return 0;
+}
 
-  {
-    struct gaih_servtuple *st2;
-    struct gaih_addrtuple *at2 = at;
-    size_t socklen;
-    sa_family_t family;
-
-    /*
-      buffer is the size of an unformatted IPv6 address in printable format.
-     */
-    while (at2 != NULL)
-      {
-	/* Only the first entry gets the canonical name.  */
-	if (at2 == at && (req->ai_flags & AI_CANONNAME) != 0)
-	  {
-	    if (canon == NULL)
-	      /* If the canonical name cannot be determined, use
-		 the passed in string.  */
-	      canon = orig_name;
-
-	    bool do_idn = req->ai_flags & AI_CANONIDN;
-	    if (do_idn)
-	      {
-		char *out;
-		int rc = __idna_from_dns_encoding (canon, &out);
-		if (rc == 0)
-		  canon = out;
-		else if (rc == EAI_IDN_ENCODE)
-		  /* Use the punycode name as a fallback.  */
-		  do_idn = false;
-		else
-		  {
-		    result = -rc;
-		    goto free_and_return;
-		  }
-	      }
-	    if (!do_idn)
-	      {
-		if (canonbuf != NULL)
-		  /* We already allocated the string using malloc, but
-		     the buffer is now owned by canon.  */
-		  canonbuf = NULL;
-		else
-		  {
-		    canon = __strdup (canon);
-		    if (canon == NULL)
-		      {
-			result = -EAI_MEMORY;
-			goto free_and_return;
-		      }
-		  }
-	      }
-	  }
+static int
+gaih_inet (const char *name, const struct gaih_service *service,
+	   const struct addrinfo *req, struct addrinfo **pai,
+	   unsigned int *naddrs, struct scratch_buffer *tmpbuf)
+{
+  struct gaih_servtuple st[sizeof (gaih_inet_typeproto)
+			   / sizeof (struct gaih_typeproto)] = {0};
 
-	family = at2->family;
-	if (family == AF_INET6)
-	  {
-	    socklen = sizeof (struct sockaddr_in6);
-
-	    /* If we looked up IPv4 mapped address discard them here if
-	       the caller isn't interested in all address and we have
-	       found at least one IPv6 address.  */
-	    if (got_ipv6
-		&& (req->ai_flags & (AI_V4MAPPED|AI_ALL)) == AI_V4MAPPED
-		&& IN6_IS_ADDR_V4MAPPED (at2->addr))
-	      goto ignore;
-	  }
-	else
-	  socklen = sizeof (struct sockaddr_in);
+  const char *orig_name = name;
 
-	for (st2 = st; st2 != NULL; st2 = st2->next)
-	  {
-	    struct addrinfo *ai;
-	    ai = *pai = malloc (sizeof (struct addrinfo) + socklen);
-	    if (ai == NULL)
-	      {
-		free ((char *) canon);
-		result = -EAI_MEMORY;
-		goto free_and_return;
-	      }
-
-	    ai->ai_flags = req->ai_flags;
-	    ai->ai_family = family;
-	    ai->ai_socktype = st2->socktype;
-	    ai->ai_protocol = st2->protocol;
-	    ai->ai_addrlen = socklen;
-	    ai->ai_addr = (void *) (ai + 1);
-
-	    /* We only add the canonical name once.  */
-	    ai->ai_canonname = (char *) canon;
-	    canon = NULL;
+  int rc;
+  if ((rc = get_servtuples (service, req, st, tmpbuf)) != 0)
+    return rc;
 
-#ifdef _HAVE_SA_LEN
-	    ai->ai_addr->sa_len = socklen;
-#endif /* _HAVE_SA_LEN */
-	    ai->ai_addr->sa_family = family;
-
-	    /* In case of an allocation error the list must be NULL
-	       terminated.  */
-	    ai->ai_next = NULL;
-
-	    if (family == AF_INET6)
-	      {
-		struct sockaddr_in6 *sin6p =
-		  (struct sockaddr_in6 *) ai->ai_addr;
-
-		sin6p->sin6_port = st2->port;
-		sin6p->sin6_flowinfo = 0;
-		memcpy (&sin6p->sin6_addr,
-			at2->addr, sizeof (struct in6_addr));
-		sin6p->sin6_scope_id = at2->scopeid;
-	      }
-	    else
-	      {
-		struct sockaddr_in *sinp =
-		  (struct sockaddr_in *) ai->ai_addr;
-		sinp->sin_port = st2->port;
-		memcpy (&sinp->sin_addr,
-			at2->addr, sizeof (struct in_addr));
-		memset (sinp->sin_zero, '\0', sizeof (sinp->sin_zero));
-	      }
-
-	    pai = &(ai->ai_next);
-	  }
+  bool malloc_name = false;
+  struct gaih_addrtuple *addrmem = NULL;
+  int result = 0;
+
+  struct gaih_result res = {0};
+  struct gaih_addrtuple local_at[2] = {0};
+
+  res.at = local_at;
+
+  if (__glibc_unlikely (name == NULL))
+    {
+      get_local_addresses (req, &res);
+      goto process_list;
+    }
+
+  if (req->ai_flags & AI_IDN)
+    {
+      char *out;
+      result = __idna_to_dns_encoding (name, &out);
+      if (result != 0)
+	return -result;
+      name = out;
+      malloc_name = true;
+    }
+
+  if ((result = text_to_binary_address (name, req, &res)) != 0)
+    goto free_and_return;
+  else if (res.at != NULL)
+    goto process_list;
+
+  if ((result = try_simple_gethostbyname (name, req, tmpbuf, &res)) != 0)
+    goto free_and_return;
+  else if (res.at != NULL)
+    goto process_list;
+
+#ifdef USE_NSCD
+  if ((result = get_nscd_addresses (name, req, &res)) != 0)
+    goto free_and_return;
+  else if (res.at != NULL)
+    goto process_list;
+#endif
 
-	++*naddrs;
+  if ((result = get_nss_addresses (name, req, tmpbuf, &res)) != 0)
+    goto free_and_return;
+  else if (res.at != NULL)
+    goto process_list;
 
-      ignore:
-	at2 = at2->next;
-      }
-  }
+  /* None of the lookups worked, so name not found.  */
+  result = -EAI_NONAME;
+  goto free_and_return;
 
- free_and_return:
+process_list:
+  /* Set up the canonical name if we need it.  */
+  if ((result = process_canonname (req, orig_name, &res)) != 0)
+    goto free_and_return;
+
+  result = generate_addrinfo (req, &res, st, pai, naddrs);
+
+free_and_return:
   if (malloc_name)
     free ((char *) name);
   free (addrmem);
-  free (canonbuf);
+  if (res.free_at)
+    free (res.at);
+  free (res.canon);
 
   return result;
 }
@@ -1761,6 +1851,66 @@ scopecmp (const void *p1, const void *p2)
   return 1;
 }
 
+static bool
+add_prefixlist (struct prefixlist **listp, size_t *lenp, bool *nullbitsp,
+		char *val1, char *val2, char **pos)
+{
+  struct in6_addr prefix;
+  unsigned long int bits;
+  unsigned long int val;
+  char *endp;
+
+  bits = 128;
+  __set_errno (0);
+  char *cp = strchr (val1, '/');
+  if (cp != NULL)
+    *cp++ = '\0';
+  *pos = cp;
+  if (inet_pton (AF_INET6, val1, &prefix)
+      && (cp == NULL
+	  || (bits = strtoul (cp, &endp, 10)) != ULONG_MAX
+	  || errno != ERANGE)
+      && *endp == '\0'
+      && bits <= 128
+      && ((val = strtoul (val2, &endp, 10)) != ULONG_MAX
+	  || errno != ERANGE)
+      && *endp == '\0'
+      && val <= INT_MAX)
+    {
+      struct prefixlist *newp = malloc (sizeof (*newp));
+      if (newp == NULL)
+	return false;
+
+      memcpy (&newp->entry.prefix, &prefix, sizeof (prefix));
+      newp->entry.bits = bits;
+      newp->entry.val = val;
+      newp->next = *listp;
+      *listp = newp;
+      ++*lenp;
+      *nullbitsp |= bits == 0;
+    }
+  return true;
+}
+
+static bool
+add_scopelist (struct scopelist **listp, size_t *lenp, bool *nullbitsp,
+	       const struct in6_addr *prefixp, unsigned long int bits,
+	       unsigned long int val)
+{
+  struct scopelist *newp = malloc (sizeof (*newp));
+  if (newp == NULL)
+    return false;
+
+  newp->entry.netmask = htonl (bits != 96 ? (0xffffffff << (128 - bits)) : 0);
+  newp->entry.addr32 = (prefixp->s6_addr32[3] & newp->entry.netmask);
+  newp->entry.scope = val;
+  newp->next = *listp;
+  *listp = newp;
+  ++*lenp;
+  *nullbitsp |= bits == 96;
+
+  return true;
+}
 
 static void
 gaiconf_init (void)
@@ -1776,357 +1926,314 @@ gaiconf_init (void)
   bool scopelist_nullbits = false;
 
   FILE *fp = fopen (GAICONF_FNAME, "rce");
-  if (fp != NULL)
+  if (fp == NULL)
+    goto no_file;
+
+  struct __stat64_t64 st;
+  if (__fstat64_time64 (fileno (fp), &st) != 0)
     {
-      struct __stat64_t64 st;
-      if (__fstat64_time64 (fileno (fp), &st) != 0)
-	{
-	  fclose (fp);
-	  goto no_file;
-	}
+      fclose (fp);
+      goto no_file;
+    }
 
-      char *line = NULL;
-      size_t linelen = 0;
+  char *line = NULL;
+  size_t linelen = 0;
 
-      __fsetlocking (fp, FSETLOCKING_BYCALLER);
+  __fsetlocking (fp, FSETLOCKING_BYCALLER);
 
-      while (!feof_unlocked (fp))
+  while (!feof_unlocked (fp))
+    {
+      ssize_t n = __getline (&line, &linelen, fp);
+      if (n <= 0)
+	break;
+
+      /* Handle comments.  No escaping possible so this is easy.  */
+      char *cp = strchr (line, '#');
+      if (cp != NULL)
+	*cp = '\0';
+
+      cp = line;
+      while (isspace (*cp))
+	++cp;
+
+      char *cmd = cp;
+      while (*cp != '\0' && !isspace (*cp))
+	++cp;
+      size_t cmdlen = cp - cmd;
+
+      if (*cp != '\0')
+	*cp++ = '\0';
+      while (isspace (*cp))
+	++cp;
+
+      char *val1 = cp;
+      while (*cp != '\0' && !isspace (*cp))
+	++cp;
+      size_t val1len = cp - cmd;
+
+      /* We always need at least two values.  */
+      if (val1len == 0)
+	continue;
+
+      if (*cp != '\0')
+	*cp++ = '\0';
+      while (isspace (*cp))
+	++cp;
+
+      char *val2 = cp;
+      while (*cp != '\0' && !isspace (*cp))
+	++cp;
+
+      /*  Ignore the rest of the line.  */
+      *cp = '\0';
+
+      switch (cmdlen)
 	{
-	  ssize_t n = __getline (&line, &linelen, fp);
-	  if (n <= 0)
-	    break;
-
-	  /* Handle comments.  No escaping possible so this is easy.  */
-	  char *cp = strchr (line, '#');
-	  if (cp != NULL)
-	    *cp = '\0';
-
-	  cp = line;
-	  while (isspace (*cp))
-	    ++cp;
-
-	  char *cmd = cp;
-	  while (*cp != '\0' && !isspace (*cp))
-	    ++cp;
-	  size_t cmdlen = cp - cmd;
-
-	  if (*cp != '\0')
-	    *cp++ = '\0';
-	  while (isspace (*cp))
-	    ++cp;
-
-	  char *val1 = cp;
-	  while (*cp != '\0' && !isspace (*cp))
-	    ++cp;
-	  size_t val1len = cp - cmd;
-
-	  /* We always need at least two values.  */
-	  if (val1len == 0)
-	    continue;
-
-	  if (*cp != '\0')
-	    *cp++ = '\0';
-	  while (isspace (*cp))
-	    ++cp;
-
-	  char *val2 = cp;
-	  while (*cp != '\0' && !isspace (*cp))
-	    ++cp;
-
-	  /*  Ignore the rest of the line.  */
-	  *cp = '\0';
-
-	  struct prefixlist **listp;
-	  size_t *lenp;
-	  bool *nullbitsp;
-	  switch (cmdlen)
+	case 5:
+	  if (strcmp (cmd, "label") == 0)
 	    {
-	    case 5:
-	      if (strcmp (cmd, "label") == 0)
+	      if (!add_prefixlist (&labellist, &nlabellist,
+				   &labellist_nullbits, val1, val2, &cp))
 		{
-		  struct in6_addr prefix;
-		  unsigned long int bits;
-		  unsigned long int val;
-		  char *endp;
+		  free (line);
+		  fclose (fp);
+		  goto no_file;
+		}
+	    }
+	  break;
 
-		  listp = &labellist;
-		  lenp = &nlabellist;
-		  nullbitsp = &labellist_nullbits;
+	case 6:
+	  if (strcmp (cmd, "reload") == 0)
+	    {
+	      gaiconf_reload_flag = strcmp (val1, "yes") == 0;
+	      if (gaiconf_reload_flag)
+		gaiconf_reload_flag_ever_set = 1;
+	    }
+	  break;
 
-		new_elem:
+	case 7:
+	  if (strcmp (cmd, "scopev4") == 0)
+	    {
+	      struct in6_addr prefix;
+	      unsigned long int bits;
+	      unsigned long int val;
+	      char *endp;
+
+	      bits = 32;
+	      __set_errno (0);
+	      cp = strchr (val1, '/');
+	      if (cp != NULL)
+		*cp++ = '\0';
+	      if (inet_pton (AF_INET6, val1, &prefix))
+		{
 		  bits = 128;
-		  __set_errno (0);
-		  cp = strchr (val1, '/');
-		  if (cp != NULL)
-		    *cp++ = '\0';
-		  if (inet_pton (AF_INET6, val1, &prefix)
+		  if (IN6_IS_ADDR_V4MAPPED (&prefix)
 		      && (cp == NULL
 			  || (bits = strtoul (cp, &endp, 10)) != ULONG_MAX
 			  || errno != ERANGE)
 		      && *endp == '\0'
+		      && bits >= 96
 		      && bits <= 128
 		      && ((val = strtoul (val2, &endp, 10)) != ULONG_MAX
 			  || errno != ERANGE)
 		      && *endp == '\0'
 		      && val <= INT_MAX)
 		    {
-		      struct prefixlist *newp = malloc (sizeof (*newp));
-		      if (newp == NULL)
+		      if (!add_scopelist (&scopelist, &nscopelist,
+					  &scopelist_nullbits, &prefix,
+					  bits, val))
 			{
 			  free (line);
 			  fclose (fp);
 			  goto no_file;
 			}
-
-		      memcpy (&newp->entry.prefix, &prefix, sizeof (prefix));
-		      newp->entry.bits = bits;
-		      newp->entry.val = val;
-		      newp->next = *listp;
-		      *listp = newp;
-		      ++*lenp;
-		      *nullbitsp |= bits == 0;
 		    }
 		}
-	      break;
-
-	    case 6:
-	      if (strcmp (cmd, "reload") == 0)
+	      else if (inet_pton (AF_INET, val1, &prefix.s6_addr32[3])
+		       && (cp == NULL
+			   || (bits = strtoul (cp, &endp, 10)) != ULONG_MAX
+			   || errno != ERANGE)
+		       && *endp == '\0'
+		       && bits <= 32
+		       && ((val = strtoul (val2, &endp, 10)) != ULONG_MAX
+			   || errno != ERANGE)
+		       && *endp == '\0'
+		       && val <= INT_MAX)
 		{
-		  gaiconf_reload_flag = strcmp (val1, "yes") == 0;
-		  if (gaiconf_reload_flag)
-		    gaiconf_reload_flag_ever_set = 1;
-		}
-	      break;
-
-	    case 7:
-	      if (strcmp (cmd, "scopev4") == 0)
-		{
-		  struct in6_addr prefix;
-		  unsigned long int bits;
-		  unsigned long int val;
-		  char *endp;
-
-		  bits = 32;
-		  __set_errno (0);
-		  cp = strchr (val1, '/');
-		  if (cp != NULL)
-		    *cp++ = '\0';
-		  if (inet_pton (AF_INET6, val1, &prefix))
-		    {
-		      bits = 128;
-		      if (IN6_IS_ADDR_V4MAPPED (&prefix)
-			  && (cp == NULL
-			      || (bits = strtoul (cp, &endp, 10)) != ULONG_MAX
-			      || errno != ERANGE)
-			  && *endp == '\0'
-			  && bits >= 96
-			  && bits <= 128
-			  && ((val = strtoul (val2, &endp, 10)) != ULONG_MAX
-			      || errno != ERANGE)
-			  && *endp == '\0'
-			  && val <= INT_MAX)
-			{
-			  struct scopelist *newp;
-			new_scope:
-			  newp = malloc (sizeof (*newp));
-			  if (newp == NULL)
-			    {
-			      free (line);
-			      fclose (fp);
-			      goto no_file;
-			    }
-
-			  newp->entry.netmask = htonl (bits != 96
-						       ? (0xffffffff
-							  << (128 - bits))
-						       : 0);
-			  newp->entry.addr32 = (prefix.s6_addr32[3]
-						& newp->entry.netmask);
-			  newp->entry.scope = val;
-			  newp->next = scopelist;
-			  scopelist = newp;
-			  ++nscopelist;
-			  scopelist_nullbits |= bits == 96;
-			}
-		    }
-		  else if (inet_pton (AF_INET, val1, &prefix.s6_addr32[3])
-			   && (cp == NULL
-			       || (bits = strtoul (cp, &endp, 10)) != ULONG_MAX
-			       || errno != ERANGE)
-			   && *endp == '\0'
-			   && bits <= 32
-			   && ((val = strtoul (val2, &endp, 10)) != ULONG_MAX
-			       || errno != ERANGE)
-			   && *endp == '\0'
-			   && val <= INT_MAX)
+		  if (!add_scopelist (&scopelist, &nscopelist,
+				      &scopelist_nullbits, &prefix,
+				      bits + 96, val))
 		    {
-		      bits += 96;
-		      goto new_scope;
+		      free (line);
+		      fclose (fp);
+		      goto no_file;
 		    }
 		}
-	      break;
+	    }
+	  break;
 
-	    case 10:
-	      if (strcmp (cmd, "precedence") == 0)
+	case 10:
+	  if (strcmp (cmd, "precedence") == 0)
+	    {
+	      if (!add_prefixlist (&precedencelist, &nprecedencelist,
+				   &precedencelist_nullbits, val1, val2,
+				   &cp))
 		{
-		  listp = &precedencelist;
-		  lenp = &nprecedencelist;
-		  nullbitsp = &precedencelist_nullbits;
-		  goto new_elem;
+		  free (line);
+		  fclose (fp);
+		  goto no_file;
 		}
-	      break;
 	    }
+	  break;
 	}
+    }
 
-      free (line);
+  free (line);
 
-      fclose (fp);
+  fclose (fp);
 
-      /* Create the array for the labels.  */
-      struct prefixentry *new_labels;
-      if (nlabellist > 0)
+  /* Create the array for the labels.  */
+  struct prefixentry *new_labels;
+  if (nlabellist > 0)
+    {
+      if (!labellist_nullbits)
+	++nlabellist;
+      new_labels = malloc (nlabellist * sizeof (*new_labels));
+      if (new_labels == NULL)
+	goto no_file;
+
+      int i = nlabellist;
+      if (!labellist_nullbits)
 	{
-	  if (!labellist_nullbits)
-	    ++nlabellist;
-	  new_labels = malloc (nlabellist * sizeof (*new_labels));
-	  if (new_labels == NULL)
-	    goto no_file;
-
-	  int i = nlabellist;
-	  if (!labellist_nullbits)
-	    {
-	      --i;
-	      memset (&new_labels[i].prefix, '\0', sizeof (struct in6_addr));
-	      new_labels[i].bits = 0;
-	      new_labels[i].val = 1;
-	    }
-
-	  struct prefixlist *l = labellist;
-	  while (i-- > 0)
-	    {
-	      new_labels[i] = l->entry;
-	      l = l->next;
-	    }
-	  free_prefixlist (labellist);
-	  labellist = NULL;
-
-	  /* Sort the entries so that the most specific ones are at
-	     the beginning.  */
-	  qsort (new_labels, nlabellist, sizeof (*new_labels), prefixcmp);
+	  --i;
+	  memset (&new_labels[i].prefix, '\0', sizeof (struct in6_addr));
+	  new_labels[i].bits = 0;
+	  new_labels[i].val = 1;
 	}
-      else
-	new_labels = (struct prefixentry *) default_labels;
 
-      struct prefixentry *new_precedence;
-      if (nprecedencelist > 0)
+      struct prefixlist *l = labellist;
+      while (i-- > 0)
 	{
-	  if (!precedencelist_nullbits)
-	    ++nprecedencelist;
-	  new_precedence = malloc (nprecedencelist * sizeof (*new_precedence));
-	  if (new_precedence == NULL)
-	    {
-	      if (new_labels != default_labels)
-		free (new_labels);
-	      goto no_file;
-	    }
-
-	  int i = nprecedencelist;
-	  if (!precedencelist_nullbits)
-	    {
-	      --i;
-	      memset (&new_precedence[i].prefix, '\0',
-		      sizeof (struct in6_addr));
-	      new_precedence[i].bits = 0;
-	      new_precedence[i].val = 40;
-	    }
+	  new_labels[i] = l->entry;
+	  l = l->next;
+	}
+      free_prefixlist (labellist);
+      labellist = NULL;
 
-	  struct prefixlist *l = precedencelist;
-	  while (i-- > 0)
-	    {
-	      new_precedence[i] = l->entry;
-	      l = l->next;
-	    }
-	  free_prefixlist (precedencelist);
-	  precedencelist = NULL;
+      /* Sort the entries so that the most specific ones are at
+	 the beginning.  */
+      qsort (new_labels, nlabellist, sizeof (*new_labels), prefixcmp);
+    }
+  else
+    new_labels = (struct prefixentry *) default_labels;
 
-	  /* Sort the entries so that the most specific ones are at
-	     the beginning.  */
-	  qsort (new_precedence, nprecedencelist, sizeof (*new_precedence),
-		 prefixcmp);
+  struct prefixentry *new_precedence;
+  if (nprecedencelist > 0)
+    {
+      if (!precedencelist_nullbits)
+	++nprecedencelist;
+      new_precedence = malloc (nprecedencelist * sizeof (*new_precedence));
+      if (new_precedence == NULL)
+	{
+	  if (new_labels != default_labels)
+	    free (new_labels);
+	  goto no_file;
 	}
-      else
-	new_precedence = (struct prefixentry *) default_precedence;
 
-      struct scopeentry *new_scopes;
-      if (nscopelist > 0)
+      int i = nprecedencelist;
+      if (!precedencelist_nullbits)
 	{
-	  if (!scopelist_nullbits)
-	    ++nscopelist;
-	  new_scopes = malloc (nscopelist * sizeof (*new_scopes));
-	  if (new_scopes == NULL)
-	    {
-	      if (new_labels != default_labels)
-		free (new_labels);
-	      if (new_precedence != default_precedence)
-		free (new_precedence);
-	      goto no_file;
-	    }
-
-	  int i = nscopelist;
-	  if (!scopelist_nullbits)
-	    {
-	      --i;
-	      new_scopes[i].addr32 = 0;
-	      new_scopes[i].netmask = 0;
-	      new_scopes[i].scope = 14;
-	    }
-
-	  struct scopelist *l = scopelist;
-	  while (i-- > 0)
-	    {
-	      new_scopes[i] = l->entry;
-	      l = l->next;
-	    }
-	  free_scopelist (scopelist);
-
-	  /* Sort the entries so that the most specific ones are at
-	     the beginning.  */
-	  qsort (new_scopes, nscopelist, sizeof (*new_scopes),
-		 scopecmp);
+	  --i;
+	  memset (&new_precedence[i].prefix, '\0',
+		  sizeof (struct in6_addr));
+	  new_precedence[i].bits = 0;
+	  new_precedence[i].val = 40;
 	}
-      else
-	new_scopes = (struct scopeentry *) default_scopes;
 
-      /* Now we are ready to replace the values.  */
-      const struct prefixentry *old = labels;
-      labels = new_labels;
-      if (old != default_labels)
-	free ((void *) old);
-
-      old = precedence;
-      precedence = new_precedence;
-      if (old != default_precedence)
-	free ((void *) old);
-
-      const struct scopeentry *oldscope = scopes;
-      scopes = new_scopes;
-      if (oldscope != default_scopes)
-	free ((void *) oldscope);
+      struct prefixlist *l = precedencelist;
+      while (i-- > 0)
+	{
+	  new_precedence[i] = l->entry;
+	  l = l->next;
+	}
+      free_prefixlist (precedencelist);
+      precedencelist = NULL;
 
-      save_gaiconf_mtime (&st);
+      /* Sort the entries so that the most specific ones are at
+	 the beginning.  */
+      qsort (new_precedence, nprecedencelist, sizeof (*new_precedence),
+	     prefixcmp);
     }
   else
+    new_precedence = (struct prefixentry *) default_precedence;
+
+  struct scopeentry *new_scopes;
+  if (nscopelist > 0)
     {
-    no_file:
-      free_prefixlist (labellist);
-      free_prefixlist (precedencelist);
+      if (!scopelist_nullbits)
+	++nscopelist;
+      new_scopes = malloc (nscopelist * sizeof (*new_scopes));
+      if (new_scopes == NULL)
+	{
+	  if (new_labels != default_labels)
+	    free (new_labels);
+	  if (new_precedence != default_precedence)
+	    free (new_precedence);
+	  goto no_file;
+	}
+
+      int i = nscopelist;
+      if (!scopelist_nullbits)
+	{
+	  --i;
+	  new_scopes[i].addr32 = 0;
+	  new_scopes[i].netmask = 0;
+	  new_scopes[i].scope = 14;
+	}
+
+      struct scopelist *l = scopelist;
+      while (i-- > 0)
+	{
+	  new_scopes[i] = l->entry;
+	  l = l->next;
+	}
       free_scopelist (scopelist);
 
-      /* If we previously read the file but it is gone now, free the
-	 old data and use the builtin one.  Leave the reload flag
-	 alone.  */
-      fini ();
+      /* Sort the entries so that the most specific ones are at
+	 the beginning.  */
+      qsort (new_scopes, nscopelist, sizeof (*new_scopes),
+	     scopecmp);
     }
+  else
+    new_scopes = (struct scopeentry *) default_scopes;
+
+  /* Now we are ready to replace the values.  */
+  const struct prefixentry *old = labels;
+  labels = new_labels;
+  if (old != default_labels)
+    free ((void *) old);
+
+  old = precedence;
+  precedence = new_precedence;
+  if (old != default_precedence)
+    free ((void *) old);
+
+  const struct scopeentry *oldscope = scopes;
+  scopes = new_scopes;
+  if (oldscope != default_scopes)
+    free ((void *) oldscope);
+
+  save_gaiconf_mtime (&st);
+  return;
+
+no_file:
+  free_prefixlist (labellist);
+  free_prefixlist (precedencelist);
+  free_scopelist (scopelist);
+
+  /* If we previously read the file but it is gone now, free the old data and
+     use the builtin one.  Leave the reload flag alone.  */
+  fini ();
 }
 
 
@@ -2139,6 +2246,36 @@ gaiconf_reload (void)
     gaiconf_init ();
 }
 
+static bool
+try_connect (int *fdp, int *afp, struct sockaddr_in6 *source_addrp,
+	     const struct sockaddr *addr, socklen_t addrlen, int family)
+{
+  int fd = *fdp;
+  int af = *afp;
+  socklen_t sl = sizeof (*source_addrp);
+
+  while (true)
+    {
+      if (fd != -1 && __connect (fd, addr, addrlen) == 0
+	  && __getsockname (fd, (struct sockaddr *) source_addrp, &sl) == 0)
+	return true;
+
+      if (errno == EAFNOSUPPORT && af == AF_INET6 && family == AF_INET)
+	{
+	  /* This could mean IPv6 sockets are IPv6-only.  */
+	  if (fd != -1)
+	    __close_nocancel_nostatus (fd);
+	  *afp = af = AF_INET;
+	  *fdp = fd = __socket (AF_INET, SOCK_DGRAM | SOCK_CLOEXEC,
+				IPPROTO_IP);
+	  continue;
+	}
+
+      return false;
+    }
+
+  __builtin_unreachable ();
+}
 
 int
 getaddrinfo (const char *name, const char *service,
@@ -2329,7 +2466,6 @@ getaddrinfo (const char *name, const char *service,
 	      if (fd == -1 || (af == AF_INET && q->ai_family == AF_INET6))
 		{
 		  if (fd != -1)
-		  close_retry:
 		    __close_nocancel_nostatus (fd);
 		  af = q->ai_family;
 		  fd = __socket (af, SOCK_DGRAM | SOCK_CLOEXEC, IPPROTO_IP);
@@ -2341,14 +2477,10 @@ getaddrinfo (const char *name, const char *service,
 		  __connect (fd, &sa, sizeof (sa));
 		}
 
-	      socklen_t sl = sizeof (results[i].source_addr);
-	      if (fd != -1
-		  && __connect (fd, q->ai_addr, q->ai_addrlen) == 0
-		  && __getsockname (fd,
-				    (struct sockaddr *) &results[i].source_addr,
-				    &sl) == 0)
+	      if (try_connect (&fd, &af, &results[i].source_addr, q->ai_addr,
+			       q->ai_addrlen, q->ai_family))
 		{
-		  results[i].source_addr_len = sl;
+		  results[i].source_addr_len = sizeof (results[i].source_addr);
 		  results[i].got_source_addr = true;
 
 		  if (in6ai != NULL)
@@ -2413,10 +2545,6 @@ getaddrinfo (const char *name, const char *service,
 		      results[i].source_addr_len = sizeof (struct sockaddr_in);
 		    }
 		}
-	      else if (errno == EAFNOSUPPORT && af == AF_INET6
-		       && q->ai_family == AF_INET)
-		/* This could mean IPv6 sockets are IPv6-only.  */
-		goto close_retry;
 	      else
 		/* Just make sure that if we have to process the same
 		   address again we do not copy any memory.  */
diff --git a/sysdeps/posix/pathconf.c b/sysdeps/posix/pathconf.c
index d414f7a3..54c86f0d 100644
--- a/sysdeps/posix/pathconf.c
+++ b/sysdeps/posix/pathconf.c
@@ -113,7 +113,7 @@ __pathconf (const char *path, int name)
       return _POSIX_NO_TRUNC;
 
     case _PC_VDISABLE:
-#if _POSIX_VDISABLE == -1
+#if _POSIX_VDISABLE == -1U
 # error "Invalid value for _POSIX_VDISABLE"
 #endif
       return _POSIX_VDISABLE;
diff --git a/sysdeps/posix/sprofil.c b/sysdeps/posix/sprofil.c
index 5f03bd0e..785b817f 100644
--- a/sysdeps/posix/sprofil.c
+++ b/sysdeps/posix/sprofil.c
@@ -163,18 +163,6 @@ profil_count (uintptr_t pcp, int prof_uint)
     }
 }
 
-static inline void
-profil_count_ushort (uintptr_t pcp)
-{
-  profil_count (pcp, 0);
-}
-
-static inline void
-profil_count_uint (uintptr_t pcp)
-{
-  profil_count (pcp, 1);
-}
-
 /* Get the machine-dependent definition of `__profil_counter', the signal
    handler for SIGPROF.  It calls `profil_count' (above) with the PC of the
    interrupted code.  */
diff --git a/sysdeps/posix/sysconf.c b/sysdeps/posix/sysconf.c
index f760bf4e..c29b70ad 100644
--- a/sysdeps/posix/sysconf.c
+++ b/sysdeps/posix/sysconf.c
@@ -37,13 +37,17 @@
 #define NEED_SPEC_ARRAY 0
 #include <posix-conf-vars.h>
 
-#define NEED_CHECK_SPEC \
-  (!defined _XBS5_ILP32_OFF32 || !defined _XBS5_ILP32_OFFBIG \
+#if !defined _XBS5_ILP32_OFF32 || !defined _XBS5_ILP32_OFFBIG \
    || !defined _XBS5_LP64_OFF64 || !defined _XBS5_LPBIG_OFFBIG \
    || !defined _POSIX_V6_ILP32_OFF32 || !defined _POSIX_V6_ILP32_OFFBIG \
    || !defined _POSIX_V6_LP64_OFF64 || !defined _POSIX_V6_LPBIG_OFFBIG \
    || !defined _POSIX_V7_ILP32_OFF32 || !defined _POSIX_V7_ILP32_OFFBIG \
-   || !defined _POSIX_V7_LP64_OFF64 || !defined _POSIX_V7_LPBIG_OFFBIG)
+   || !defined _POSIX_V7_LP64_OFF64 || !defined _POSIX_V7_LPBIG_OFFBIG
+# define NEED_CHECK_SPEC 1
+#else
+# define NEED_CHECK_SPEC 0
+#endif
+
 #if NEED_CHECK_SPEC
 static long int __sysconf_check_spec (const char *spec);
 #endif
diff --git a/sysdeps/posix/tempname.c b/sysdeps/posix/tempname.c
index ebd2a439..5b167d45 100644
--- a/sysdeps/posix/tempname.c
+++ b/sysdeps/posix/tempname.c
@@ -161,7 +161,7 @@ __path_search (char *tmpl, size_t tmpl_len, const char *dir, const char *pfx,
       return -1;
     }
 
-  sprintf (tmpl, "%.*s/%.*sXXXXXX", (int) dlen, dir, (int) plen, pfx);
+  __sprintf (tmpl, "%.*s/%.*sXXXXXX", (int) dlen, dir, (int) plen, pfx);
   return 0;
 }
 #endif /* _LIBC */
diff --git a/sysdeps/powerpc/nofpu/Makefile b/sysdeps/powerpc/nofpu/Makefile
index 3b51ff6d..fa462339 100644
--- a/sysdeps/powerpc/nofpu/Makefile
+++ b/sysdeps/powerpc/nofpu/Makefile
@@ -27,18 +27,18 @@ CPPFLAGS += -I../soft-fp/
 CFLAGS-e_atan2l.c += -fno-builtin-fabsl
 CFLAGS-e_hypotl.c += -fno-builtin-fabsl
 CFLAGS-e_powl.c += -fno-builtin-fabsl
-CFLAGS-s_cacosl.c += -fsignaling-nans
-CFLAGS-s_cacoshl.c += -fsignaling-nans
-CFLAGS-s_casinhl.c += -fsignaling-nans
-CFLAGS-s_catanl.c += -fsignaling-nans
-CFLAGS-s_catanhl.c += -fsignaling-nans
-CFLAGS-s_ccoshl.c += -fno-builtin-fabsl -fsignaling-nans
-CFLAGS-s_cexpl.c += -fsignaling-nans
-CFLAGS-s_csinhl.c += -fno-builtin-fabsl -fsignaling-nans
-CFLAGS-s_clogl.c += -fno-builtin-fabsl -fsignaling-nans
-CFLAGS-s_clog10l.c += -fno-builtin-fabsl -fsignaling-nans
-CFLAGS-s_csinl.c += -fno-builtin-fabsl -fsignaling-nans
-CFLAGS-s_csqrtl.c += -fno-builtin-fabsl -fsignaling-nans
+CFLAGS-s_cacosl.c += $(config-cflags-signaling-nans)
+CFLAGS-s_cacoshl.c += $(config-cflags-signaling-nans)
+CFLAGS-s_casinhl.c += $(config-cflags-signaling-nans)
+CFLAGS-s_catanl.c += $(config-cflags-signaling-nans)
+CFLAGS-s_catanhl.c += $(config-cflags-signaling-nans)
+CFLAGS-s_ccoshl.c += -fno-builtin-fabsl $(config-cflags-signaling-nans)
+CFLAGS-s_cexpl.c += $(config-cflags-signaling-nans)
+CFLAGS-s_csinhl.c += -fno-builtin-fabsl $(config-cflags-signaling-nans)
+CFLAGS-s_clogl.c += -fno-builtin-fabsl $(config-cflags-signaling-nans)
+CFLAGS-s_clog10l.c += -fno-builtin-fabsl $(config-cflags-signaling-nans)
+CFLAGS-s_csinl.c += -fno-builtin-fabsl $(config-cflags-signaling-nans)
+CFLAGS-s_csqrtl.c += -fno-builtin-fabsl $(config-cflags-signaling-nans)
 CFLAGS-w_acosl_compat.c += -fno-builtin-fabsl
 CFLAGS-w_asinl_compat.c += -fno-builtin-fabsl
 CFLAGS-w_atanhl_compat.c += -fno-builtin-fabsl
diff --git a/sysdeps/powerpc/nptl/tls.h b/sysdeps/powerpc/nptl/tls.h
index b80d39ad..dc65fe59 100644
--- a/sysdeps/powerpc/nptl/tls.h
+++ b/sysdeps/powerpc/nptl/tls.h
@@ -139,7 +139,7 @@ typedef struct
     __thread_register = (void *) (tcbp) + TLS_TCB_OFFSET;		      \
     THREAD_SET_HWCAP (__tcb_hwcap);					      \
     THREAD_SET_AT_PLATFORM (__tcb_platform);				      \
-    NULL;								      \
+    true;								      \
   })
 
 /* Value passed to 'clone' for initialization of the thread register.  */
diff --git a/sysdeps/powerpc/powerpc32/memset.S b/sysdeps/powerpc/powerpc32/memset.S
index c125934f..63ad3d2d 100644
--- a/sysdeps/powerpc/powerpc32/memset.S
+++ b/sysdeps/powerpc/powerpc32/memset.S
@@ -302,3 +302,4 @@ L(handletail32):
 
 END (memset)
 libc_hidden_builtin_def (memset)
+strong_alias (memset, __memset_generic)
diff --git a/sysdeps/powerpc/powerpc32/power4/fpu/multiarch/Makefile b/sysdeps/powerpc/powerpc32/power4/fpu/multiarch/Makefile
index 1de0f9b3..64317506 100644
--- a/sysdeps/powerpc/powerpc32/power4/fpu/multiarch/Makefile
+++ b/sysdeps/powerpc/powerpc32/power4/fpu/multiarch/Makefile
@@ -37,6 +37,6 @@ CFLAGS-s_logbf-power7.c = -mcpu=power7
 
 # These files quiet sNaNs in a way that is optimized away without
 # -fsignaling-nans.
-CFLAGS-s_modf-ppc32.c += -fsignaling-nans
-CFLAGS-s_modff-ppc32.c += -fsignaling-nans
+CFLAGS-s_modf-ppc32.c += $(config-cflags-signaling-nans)
+CFLAGS-s_modff-ppc32.c += $(config-cflags-signaling-nans)
 endif
diff --git a/sysdeps/powerpc/powerpc32/power4/memset.S b/sysdeps/powerpc/powerpc32/power4/memset.S
index 40b140c8..98811c1a 100644
--- a/sysdeps/powerpc/powerpc32/power4/memset.S
+++ b/sysdeps/powerpc/powerpc32/power4/memset.S
@@ -224,3 +224,4 @@ L(medium_28t):
 	blr
 END (memset)
 libc_hidden_builtin_def (memset)
+strong_alias (memset, __memset_generic)
diff --git a/sysdeps/powerpc/powerpc32/power4/multiarch/memset-ppc32.S b/sysdeps/powerpc/powerpc32/power4/multiarch/memset-ppc32.S
index 0937ba22..4c5724bc 100644
--- a/sysdeps/powerpc/powerpc32/power4/multiarch/memset-ppc32.S
+++ b/sysdeps/powerpc/powerpc32/power4/multiarch/memset-ppc32.S
@@ -39,3 +39,4 @@
 #endif
 
 #include <sysdeps/powerpc/powerpc32/power4/memset.S>
+strong_alias (memset, __memset_generic)
diff --git a/sysdeps/powerpc/powerpc32/power6/memset.S b/sysdeps/powerpc/powerpc32/power6/memset.S
index d86701ff..5f4c8518 100644
--- a/sysdeps/powerpc/powerpc32/power6/memset.S
+++ b/sysdeps/powerpc/powerpc32/power6/memset.S
@@ -537,3 +537,4 @@ L(medium_28t):
 	blr
 END (memset)
 libc_hidden_builtin_def (memset)
+strong_alias (memset, __memset_generic)
diff --git a/sysdeps/powerpc/powerpc32/power7/memset.S b/sysdeps/powerpc/powerpc32/power7/memset.S
index 368e8b39..68a6ec18 100644
--- a/sysdeps/powerpc/powerpc32/power7/memset.S
+++ b/sysdeps/powerpc/powerpc32/power7/memset.S
@@ -428,3 +428,4 @@ L(small):
 
 END (memset)
 libc_hidden_builtin_def (memset)
+strong_alias (memset, __memset_generic)
diff --git a/sysdeps/powerpc/powerpc64/be/fpu/multiarch/Makefile b/sysdeps/powerpc/powerpc64/be/fpu/multiarch/Makefile
index b27bad3b..36f40060 100644
--- a/sysdeps/powerpc/powerpc64/be/fpu/multiarch/Makefile
+++ b/sysdeps/powerpc/powerpc64/be/fpu/multiarch/Makefile
@@ -62,6 +62,6 @@ CFLAGS-s_logb-power7.c = -mcpu=power7
 
 # These files quiet sNaNs in a way that is optimized away without
 # -fsignaling-nans.
-CFLAGS-s_modf-ppc64.c += -fsignaling-nans
-CFLAGS-s_modff-ppc64.c += -fsignaling-nans
+CFLAGS-s_modf-ppc64.c += $(config-cflags-signaling-nans)
+CFLAGS-s_modff-ppc64.c += $(config-cflags-signaling-nans)
 endif
diff --git a/sysdeps/powerpc/powerpc64/le/fpu/multiarch/Makefile b/sysdeps/powerpc/powerpc64/le/fpu/multiarch/Makefile
index cc073b53..249850f4 100644
--- a/sysdeps/powerpc/powerpc64/le/fpu/multiarch/Makefile
+++ b/sysdeps/powerpc/powerpc64/le/fpu/multiarch/Makefile
@@ -130,8 +130,8 @@ generated += $(f128-march-routines)
 CFLAGS-float128-ifunc.c += $(type-float128-CFLAGS) $(no-gnu-attribute-CFLAGS)
 
 # Copy special CFLAGS for some functions
-CFLAGS-s_modff128-power9.c += -fsignaling-nans
-CFLAGS-m_modff128-power9.c += -fsignaling-nans
+CFLAGS-s_modff128-power9.c += $(config-cflags-signaling-nans)
+CFLAGS-m_modff128-power9.c += $(config-cflags-signaling-nans)
 
 # Generate ifunc wrapper files and target specific wrappers around
 # each routine above.  Note, m_%.c files are fixed up to include
diff --git a/sysdeps/powerpc/powerpc64/multiarch/memset-ppc64.S b/sysdeps/powerpc/powerpc64/multiarch/memset-ppc64.S
index 876954d3..ad82da99 100644
--- a/sysdeps/powerpc/powerpc64/multiarch/memset-ppc64.S
+++ b/sysdeps/powerpc/powerpc64/multiarch/memset-ppc64.S
@@ -40,3 +40,4 @@ END_GEN_TB (__bzero_ppc,TB_TOCLESS)
 #define NO_BZERO_IMPL
 
 #include <sysdeps/powerpc/powerpc64/memset.S>
+strong_alias (memset, __memset_generic)
diff --git a/sysdeps/powerpc/powerpc64/power4/memset.S b/sysdeps/powerpc/powerpc64/power4/memset.S
index dfc13626..0216a514 100644
--- a/sysdeps/powerpc/powerpc64/power4/memset.S
+++ b/sysdeps/powerpc/powerpc64/power4/memset.S
@@ -237,6 +237,7 @@ L(medium_28t):
 	blr
 END_GEN_TB (MEMSET,TB_TOCLESS)
 libc_hidden_builtin_def (memset)
+strong_alias (memset, __memset_generic)
 
 /* Copied from bzero.S to prevent the linker from inserting a stub
    between bzero and memset.  */
diff --git a/sysdeps/powerpc/powerpc64/power6/memset.S b/sysdeps/powerpc/powerpc64/power6/memset.S
index 7ad82c38..0ff3b673 100644
--- a/sysdeps/powerpc/powerpc64/power6/memset.S
+++ b/sysdeps/powerpc/powerpc64/power6/memset.S
@@ -381,6 +381,7 @@ L(medium_28t):
 	blr
 END_GEN_TB (MEMSET,TB_TOCLESS)
 libc_hidden_builtin_def (memset)
+strong_alias (memset, __memset_generic)
 
 /* Copied from bzero.S to prevent the linker from inserting a stub
    between bzero and memset.  */
diff --git a/sysdeps/powerpc/powerpc64/power7/memset.S b/sysdeps/powerpc/powerpc64/power7/memset.S
index 31aa0f91..b74e5395 100644
--- a/sysdeps/powerpc/powerpc64/power7/memset.S
+++ b/sysdeps/powerpc/powerpc64/power7/memset.S
@@ -384,6 +384,7 @@ L(small):
 
 END_GEN_TB (MEMSET,TB_TOCLESS)
 libc_hidden_builtin_def (memset)
+strong_alias (memset, __memset_generic)
 
 /* Copied from bzero.S to prevent the linker from inserting a stub
    between bzero and memset.  */
diff --git a/sysdeps/powerpc/powerpc64/power8/memset.S b/sysdeps/powerpc/powerpc64/power8/memset.S
index 9ecb6f30..e60f19ec 100644
--- a/sysdeps/powerpc/powerpc64/power8/memset.S
+++ b/sysdeps/powerpc/powerpc64/power8/memset.S
@@ -504,6 +504,7 @@ L(LE7_tail5):
 
 END_GEN_TB (MEMSET,TB_TOCLESS)
 libc_hidden_builtin_def (memset)
+strong_alias (memset, __memset_generic)
 
 /* Copied from bzero.S to prevent the linker from inserting a stub
    between bzero and memset.  */
diff --git a/sysdeps/riscv/dl-tls.h b/sysdeps/riscv/dl-tls.h
index e5768347..f430b20b 100644
--- a/sysdeps/riscv/dl-tls.h
+++ b/sysdeps/riscv/dl-tls.h
@@ -45,4 +45,4 @@ extern void *__tls_get_addr (tls_index *ti);
 #define __TLS_GET_ADDR(__ti)	(__tls_get_addr (__ti) - TLS_DTV_OFFSET)
 
 /* Value used for dtv entries for which the allocation is delayed.  */
-#define TLS_DTV_UNALLOCATED	((void *) -1l)
+#define TLS_DTV_UNALLOCATED_VALUE -1l
diff --git a/sysdeps/riscv/nptl/tls.h b/sysdeps/riscv/nptl/tls.h
index 4e586f34..ab0df368 100644
--- a/sysdeps/riscv/nptl/tls.h
+++ b/sysdeps/riscv/nptl/tls.h
@@ -79,7 +79,7 @@ typedef struct
 
 /* Code to initially initialize the thread pointer.  */
 # define TLS_INIT_TP(tcbp) \
-  ({ __thread_self = (char*)tcbp + TLS_TCB_OFFSET; NULL; })
+  ({ __thread_self = (char*)tcbp + TLS_TCB_OFFSET; true; })
 
 /* Return the address of the dtv for the current thread.  */
 # define THREAD_DTV() \
diff --git a/sysdeps/riscv/start.S b/sysdeps/riscv/start.S
index 87d4d637..e3f2fc9a 100644
--- a/sysdeps/riscv/start.S
+++ b/sysdeps/riscv/start.S
@@ -47,6 +47,7 @@ ENTRY (ENTRY_POINT)
 	   .cfi_label to force starting the FDE.  */
 	.cfi_label .Ldummy
 	cfi_undefined (ra)
+
 	call  load_gp
 	mv    a5, a0  /* rtld_fini.  */
 	/* main may be in a shared library.  */
diff --git a/sysdeps/s390/nptl/tls.h b/sysdeps/s390/nptl/tls.h
index ff210ffe..5d300789 100644
--- a/sysdeps/s390/nptl/tls.h
+++ b/sysdeps/s390/nptl/tls.h
@@ -112,7 +112,7 @@ typedef struct
      INIT_SYSINFO;							      \
 									      \
     __builtin_set_thread_pointer (_thrdescr);				      \
-    NULL;								      \
+    true;								      \
   })
 
 /* Value passed to 'clone' for initialization of the thread register.  */
diff --git a/sysdeps/sh/memset.S b/sysdeps/sh/memset.S
index 7852b472..fc36bc83 100644
--- a/sysdeps/sh/memset.S
+++ b/sysdeps/sh/memset.S
@@ -84,3 +84,4 @@ L_byte_exit:
 	mov	r7,r0
 END(memset)
 libc_hidden_builtin_def (memset)
+strong_alias (memset, __memset_generic)
diff --git a/sysdeps/sh/nptl/tls.h b/sysdeps/sh/nptl/tls.h
index 76591ab6..7fe56637 100644
--- a/sysdeps/sh/nptl/tls.h
+++ b/sysdeps/sh/nptl/tls.h
@@ -83,7 +83,7 @@ typedef struct
    special attention since 'errno' is not yet available and if the
    operation can cause a failure 'errno' must not be touched.  */
 # define TLS_INIT_TP(tcbp) \
-  ({ __asm __volatile ("ldc %0,gbr" : : "r" (tcbp)); NULL; })
+  ({ __asm __volatile ("ldc %0,gbr" : : "r" (tcbp)); true; })
 
 # define TLS_DEFINE_INIT_TP(tp, pd) void *tp = (pd) + 1
 
diff --git a/sysdeps/sparc/nptl/tls.h b/sysdeps/sparc/nptl/tls.h
index d1e2bb4a..73302637 100644
--- a/sysdeps/sparc/nptl/tls.h
+++ b/sysdeps/sparc/nptl/tls.h
@@ -89,7 +89,7 @@ register struct pthread *__thread_self __asm__("%g7");
 
 /* Code to initially initialize the thread pointer.  */
 # define TLS_INIT_TP(descr) \
-  (__thread_self = (__typeof (__thread_self)) (descr), NULL)
+  ({ __thread_self = (__typeof (__thread_self)) (descr), true; })
 
 /* Value passed to 'clone' for initialization of the thread register.  */
 # define TLS_DEFINE_INIT_TP(tp, pd) void *tp = (pd)
diff --git a/sysdeps/sparc/sparc32/memset.S b/sysdeps/sparc/sparc32/memset.S
index d222fa75..4d0e2669 100644
--- a/sysdeps/sparc/sparc32/memset.S
+++ b/sysdeps/sparc/sparc32/memset.S
@@ -147,6 +147,7 @@ ENTRY(memset)
 0:	retl
 	 nop
 END(memset)
+strong_alias (memset, __memset_generic)
 libc_hidden_builtin_def (memset)
 
 weak_alias (__bzero, bzero)
diff --git a/sysdeps/sparc/sparc32/sparcv9/multiarch/memset-ultra1.S b/sysdeps/sparc/sparc32/sparcv9/multiarch/memset-ultra1.S
index 60386111..7d1ffe6b 100644
--- a/sysdeps/sparc/sparc32/sparcv9/multiarch/memset-ultra1.S
+++ b/sysdeps/sparc/sparc32/sparcv9/multiarch/memset-ultra1.S
@@ -28,3 +28,4 @@
 # define __bzero __bzero_ultra1
 # include <sysdeps/sparc/sparc32/sparcv9/memset.S>
 #endif
+strong_alias (__memset_ultra1, __memset_generic)
diff --git a/sysdeps/sparc/sparc64/memset.S b/sysdeps/sparc/sparc64/memset.S
index a7f8361f..ae39979b 100644
--- a/sysdeps/sparc/sparc64/memset.S
+++ b/sysdeps/sparc/sparc64/memset.S
@@ -175,6 +175,7 @@ ENTRY(memset)
 	ba,pt		%xcc, 18b
 	 ldd		[%o0], %f0
 END(memset)
+strong_alias (memset, __memset_generic)
 libc_hidden_builtin_def (memset)
 
 #define ZERO_BLOCKS(base, offset, source)		\
diff --git a/sysdeps/sparc/sparc64/multiarch/memset-ultra1.S b/sysdeps/sparc/sparc64/multiarch/memset-ultra1.S
index e0d34243..92793216 100644
--- a/sysdeps/sparc/sparc64/multiarch/memset-ultra1.S
+++ b/sysdeps/sparc/sparc64/multiarch/memset-ultra1.S
@@ -28,3 +28,4 @@
 # define __bzero __bzero_ultra1
 # include <sysdeps/sparc/sparc64/memset.S>
 #endif
+strong_alias (__memset_ultra1, __memset_generic)
diff --git a/sysdeps/unix/sysv/linux/aarch64/cpu-features.c b/sysdeps/unix/sysv/linux/aarch64/cpu-features.c
index 41dda8d0..9242b2c6 100644
--- a/sysdeps/unix/sysv/linux/aarch64/cpu-features.c
+++ b/sysdeps/unix/sysv/linux/aarch64/cpu-features.c
@@ -86,7 +86,7 @@ init_cpu_features (struct cpu_features *cpu_features)
   cpu_features->midr_el1 = midr;
 
   /* Check if ZVA is enabled.  */
-  unsigned dczid;
+  uint64_t dczid;
   asm volatile ("mrs %0, dczid_el0" : "=r"(dczid));
 
   if ((dczid & DCZID_DZP_MASK) == 0)
diff --git a/sysdeps/unix/sysv/linux/aarch64/sysconf.c b/sysdeps/unix/sysv/linux/aarch64/sysconf.c
index 665a2bd6..3b4badc6 100644
--- a/sysdeps/unix/sysv/linux/aarch64/sysconf.c
+++ b/sysdeps/unix/sysv/linux/aarch64/sysconf.c
@@ -27,7 +27,7 @@ static long int linux_sysconf (int name);
 long int
 __sysconf (int name)
 {
-  unsigned ctr;
+  unsigned long int ctr;
 
   /* Unfortunately, the registers that contain the actual cache info
      (CCSIDR_EL1, CLIDR_EL1, and CSSELR_EL1) are protected by the Linux
diff --git a/sysdeps/unix/sysv/linux/arc/mmap_internal.h b/sysdeps/unix/sysv/linux/arc/mmap_internal.h
index d8bbcab0..59e8260b 100644
--- a/sysdeps/unix/sysv/linux/arc/mmap_internal.h
+++ b/sysdeps/unix/sysv/linux/arc/mmap_internal.h
@@ -20,7 +20,7 @@
 #define MMAP_ARC_INTERNAL_H
 
 /* 8K is default but determine the shift dynamically with getpagesize.  */
-#define MMAP2_PAGE_UNIT -1
+#define MMAP2_PAGE_UNIT -1ULL
 
 #include_next <mmap_internal.h>
 
diff --git a/sysdeps/unix/sysv/linux/arm/tls.h b/sysdeps/unix/sysv/linux/arm/tls.h
index 9d1601af..3ffbb96f 100644
--- a/sysdeps/unix/sysv/linux/arm/tls.h
+++ b/sysdeps/unix/sysv/linux/arm/tls.h
@@ -33,8 +33,7 @@
 # define TLS_INIT_TP(tcbp) \
   ({ long int result_var;						\
      result_var = INTERNAL_SYSCALL_CALL (set_tls, (tcbp));		\
-     INTERNAL_SYSCALL_ERROR_P (result_var)				\
-       ? "unknown error" : NULL; })
+     INTERNAL_SYSCALL_ERROR_P (result_var); })
 
 #endif /* __ASSEMBLER__ */
 
diff --git a/sysdeps/unix/sysv/linux/clock_getcpuclockid.c b/sysdeps/unix/sysv/linux/clock_getcpuclockid.c
index 5534127e..355d3c86 100644
--- a/sysdeps/unix/sysv/linux/clock_getcpuclockid.c
+++ b/sysdeps/unix/sysv/linux/clock_getcpuclockid.c
@@ -29,7 +29,7 @@ __clock_getcpuclockid (pid_t pid, clockid_t *clock_id)
   /* The clockid_t value is a simple computation from the PID.
      But we do a clock_getres call to validate it.  */
 
-  const clockid_t pidclock = MAKE_PROCESS_CPUCLOCK (pid, CPUCLOCK_SCHED);
+  const clockid_t pidclock = make_process_cpuclock (pid, CPUCLOCK_SCHED);
 
 #ifndef __NR_clock_getres_time64
 # define __NR_clock_getres_time64 __NR_clock_getres
diff --git a/sysdeps/unix/sysv/linux/clock_nanosleep.c b/sysdeps/unix/sysv/linux/clock_nanosleep.c
index befe6ecb..e610fd4e 100644
--- a/sysdeps/unix/sysv/linux/clock_nanosleep.c
+++ b/sysdeps/unix/sysv/linux/clock_nanosleep.c
@@ -34,7 +34,7 @@ __clock_nanosleep_time64 (clockid_t clock_id, int flags,
   if (clock_id == CLOCK_THREAD_CPUTIME_ID)
     return EINVAL;
   if (clock_id == CLOCK_PROCESS_CPUTIME_ID)
-    clock_id = MAKE_PROCESS_CPUCLOCK (0, CPUCLOCK_SCHED);
+    clock_id = PROCESS_CLOCK;
 
   /* If the call is interrupted by a signal handler or encounters an error,
      it returns a positive value similar to errno.  */
diff --git a/sysdeps/unix/sysv/linux/cmsg_nxthdr.c b/sysdeps/unix/sysv/linux/cmsg_nxthdr.c
index 15b7a3a9..5d21ca72 100644
--- a/sysdeps/unix/sysv/linux/cmsg_nxthdr.c
+++ b/sysdeps/unix/sysv/linux/cmsg_nxthdr.c
@@ -21,7 +21,7 @@
 
 
 struct cmsghdr *
-__cmsg_nxthdr (struct msghdr *mhdr, struct cmsghdr *cmsg)
+__libc_cmsg_nxthdr (struct msghdr *mhdr, struct cmsghdr *cmsg)
 {
   if ((size_t) cmsg->cmsg_len < sizeof (struct cmsghdr))
     /* The kernel header does this so there may be a reason.  */
@@ -37,4 +37,5 @@ __cmsg_nxthdr (struct msghdr *mhdr, struct cmsghdr *cmsg)
     return NULL;
   return cmsg;
 }
-libc_hidden_def (__cmsg_nxthdr)
+libc_hidden_def (__libc_cmsg_nxthdr)
+strong_alias (__libc_cmsg_nxthdr, __cmsg_nxthdr);
diff --git a/sysdeps/unix/sysv/linux/fstatat64.c b/sysdeps/unix/sysv/linux/fstatat64.c
index a82d3dd4..2ab91438 100644
--- a/sysdeps/unix/sysv/linux/fstatat64.c
+++ b/sysdeps/unix/sysv/linux/fstatat64.c
@@ -40,6 +40,11 @@ _Static_assert (sizeof (__blkcnt_t) == sizeof (__blkcnt64_t),
                 "__blkcnt_t and __blkcnt64_t must match");
 #endif
 
+#if (__WORDSIZE == 32 \
+     && (!defined __SYSCALL_WORDSIZE || __SYSCALL_WORDSIZE == 32)) \
+     || defined STAT_HAS_TIME32
+# define FSTATAT_USE_STATX 1
+
 static inline int
 fstatat64_time64_statx (int fd, const char *file, struct __stat64_t64 *buf,
 			int flag)
@@ -73,11 +78,6 @@ fstatat64_time64_statx (int fd, const char *file, struct __stat64_t64 *buf,
 
   return r;
 }
-
-#if (__WORDSIZE == 32 \
-     && (!defined __SYSCALL_WORDSIZE || __SYSCALL_WORDSIZE == 32)) \
-     || defined STAT_HAS_TIME32
-# define FSTATAT_USE_STATX 1
 #else
 # define FSTATAT_USE_STATX 0
 #endif
diff --git a/sysdeps/unix/sysv/linux/getlogin_r.c b/sysdeps/unix/sysv/linux/getlogin_r.c
index 46171660..290628f5 100644
--- a/sysdeps/unix/sysv/linux/getlogin_r.c
+++ b/sysdeps/unix/sysv/linux/getlogin_r.c
@@ -51,7 +51,7 @@ __getlogin_r_loginuid (char *name, size_t namesize)
   if (n <= 0
       || n == sizeof (uidbuf)
       || (uidbuf[n] = '\0',
-	  uid = strtoul (uidbuf, &endp, 10),
+	  uid = __strtoul (uidbuf, &endp, 10),
 	  endp == uidbuf || *endp != '\0'))
     return -1;
 
diff --git a/sysdeps/unix/sysv/linux/getsysstats.c b/sysdeps/unix/sysv/linux/getsysstats.c
index 4798cc33..dc2c1336 100644
--- a/sysdeps/unix/sysv/linux/getsysstats.c
+++ b/sysdeps/unix/sysv/linux/getsysstats.c
@@ -160,7 +160,7 @@ __get_nprocs (void)
 	do
 	  {
 	    char *endp;
-	    unsigned long int n = strtoul (l, &endp, 10);
+	    unsigned long int n = __strtoul (l, &endp, 10);
 	    if (l == endp)
 	      {
 		result = 0;
@@ -171,7 +171,7 @@ __get_nprocs (void)
 	    if (*endp == '-')
 	      {
 		l = endp + 1;
-		m = strtoul (l, &endp, 10);
+		m = __strtoul (l, &endp, 10);
 		if (l == endp)
 		  {
 		    result = 0;
diff --git a/sysdeps/unix/sysv/linux/ia64/makecontext.c b/sysdeps/unix/sysv/linux/ia64/makecontext.c
index 0bc4211d..0cf05d59 100644
--- a/sysdeps/unix/sysv/linux/ia64/makecontext.c
+++ b/sysdeps/unix/sysv/linux/ia64/makecontext.c
@@ -54,7 +54,7 @@ __makecontext (ucontext_t *ucp, void (*func) (void), int argc, ...)
 
   if (argc > 8)
     {
-      fprintf (stderr, _("\
+      __fprintf (stderr, _("\
 makecontext: does not know how to handle more than 8 arguments\n"));
       exit (-1);
     }
diff --git a/sysdeps/unix/sysv/linux/ia64/mmap_internal.h b/sysdeps/unix/sysv/linux/ia64/mmap_internal.h
index 0c0a0ced..465d5892 100644
--- a/sysdeps/unix/sysv/linux/ia64/mmap_internal.h
+++ b/sysdeps/unix/sysv/linux/ia64/mmap_internal.h
@@ -22,7 +22,7 @@
 /* Linux allows PAGE_SHIFT in range of [12-16] and expect
    mmap2 offset to be provided in based on the configured pagesize.
    Determine the shift dynamically with getpagesize.  */
-#define MMAP2_PAGE_UNIT -1
+#define MMAP2_PAGE_UNIT -1ULL
 
 #include_next <mmap_internal.h>
 
diff --git a/sysdeps/unix/sysv/linux/kernel-posix-cpu-timers.h b/sysdeps/unix/sysv/linux/kernel-posix-cpu-timers.h
index 164a90dd..9c74bb1c 100644
--- a/sysdeps/unix/sysv/linux/kernel-posix-cpu-timers.h
+++ b/sysdeps/unix/sysv/linux/kernel-posix-cpu-timers.h
@@ -1,4 +1,12 @@
-/* Parameters for the Linux kernel ABI for CPU clocks.  */
+/*
+  Parameters for the Linux kernel ABI for CPU clocks, the bit fields within
+  a clockid:
+
+  - The most significant 29 bits hold either a pid or a file descriptor.
+  - Bit 2 indicates whether a cpu clock refers to a thread or a process.
+  - Bits 1 and 0 give the type: PROF=0, VIRT=1, SCHED=2, or FD=3.
+  - A clockid is invalid if bits 2, 1, and 0 are all set.
+ */
 
 #define CPUCLOCK_PID(clock)		((pid_t) ~((clock) >> 3))
 #define CPUCLOCK_PERTHREAD(clock) \
@@ -6,13 +14,23 @@
 #define CPUCLOCK_PID_MASK	7
 #define CPUCLOCK_PERTHREAD_MASK	4
 #define CPUCLOCK_WHICH(clock)	((clock) & (clockid_t) CPUCLOCK_CLOCK_MASK)
-#define CPUCLOCK_CLOCK_MASK	3
+#define CPUCLOCK_CLOCK_MASK	3KE_PROCESS_CPUCLOCK
 #define CPUCLOCK_PROF		0
 #define CPUCLOCK_VIRT		1
 #define CPUCLOCK_SCHED		2
 #define CPUCLOCK_MAX		3
 
-#define MAKE_PROCESS_CPUCLOCK(pid, clock) \
-	((~(clockid_t) (pid) << 3) | (clockid_t) (clock))
-#define MAKE_THREAD_CPUCLOCK(tid, clock) \
-	MAKE_PROCESS_CPUCLOCK((tid), (clock) | CPUCLOCK_PERTHREAD_MASK)
+static inline clockid_t
+make_process_cpuclock (unsigned int pid, clockid_t clock)
+{
+  return ((~pid) << 3) | clock;
+}
+
+static inline clockid_t
+make_thread_cpuclock (unsigned int tid, clockid_t clock)
+{
+  return make_process_cpuclock (tid, clock | CPUCLOCK_PERTHREAD_MASK);
+}
+
+#define PROCESS_CLOCK  make_process_cpuclock (0, CPUCLOCK_SCHED)
+#define THREAD_CLOCK   make_thread_cpuclock (0, CPUCLOCK_SCHED)
diff --git a/sysdeps/unix/sysv/linux/m68k/mmap_internal.h b/sysdeps/unix/sysv/linux/m68k/mmap_internal.h
index 8e6f1ed8..9330edfc 100644
--- a/sysdeps/unix/sysv/linux/m68k/mmap_internal.h
+++ b/sysdeps/unix/sysv/linux/m68k/mmap_internal.h
@@ -22,7 +22,7 @@
 /* ColdFire and Sun 3 kernels have PAGE_SHIFT set to 13 and expect
    mmap2 offset to be provided in 8K pages.  Determine the shift
    dynamically with getpagesize.  */
-#define MMAP2_PAGE_UNIT -1
+#define MMAP2_PAGE_UNIT -1ULL
 
 #include_next <mmap_internal.h>
 
diff --git a/sysdeps/unix/sysv/linux/mmap_internal.h b/sysdeps/unix/sysv/linux/mmap_internal.h
index 841b7313..083ec920 100644
--- a/sysdeps/unix/sysv/linux/mmap_internal.h
+++ b/sysdeps/unix/sysv/linux/mmap_internal.h
@@ -28,7 +28,7 @@
 # define MMAP2_PAGE_UNIT 4096ULL
 #endif
 
-#if MMAP2_PAGE_UNIT == -1
+#if MMAP2_PAGE_UNIT == -1ULL
 static uint64_t page_unit;
 # define MMAP_CHECK_PAGE_UNIT()			\
   if (page_unit == 0)				\
diff --git a/sysdeps/unix/sysv/linux/not-cancel.h b/sysdeps/unix/sysv/linux/not-cancel.h
index 75b9e0ee..da2f2463 100644
--- a/sysdeps/unix/sysv/linux/not-cancel.h
+++ b/sysdeps/unix/sysv/linux/not-cancel.h
@@ -27,29 +27,35 @@
 #include <sys/wait.h>
 #include <time.h>
 
-/* Non cancellable open syscall.  */
-__typeof (open) __open_nocancel;
-
-/* Non cancellable open syscall (LFS version).  */
-__typeof (open64) __open64_nocancel;
-
-/* Non cancellable openat syscall.  */
-__typeof (openat) __openat_nocancel;
-
+#if IS_IN (libc) || IS_IN (rtld)
+/* Non cacellable open syscall (LFS version).  */
+hidden_proto2 (open, __open_nocancel)
+/* Non cacellable open syscall (LFS version).  */
+hidden_proto2 (open64, __open64_nocancel)
 /* Non cacellable openat syscall (LFS version).  */
-__typeof (openat64) __openat64_nocancel;
-
+hidden_proto2 (openat, __openat_nocancel)
+/* Non cacellable openat syscall (LFS version).  */
+hidden_proto2 (openat64, __openat64_nocancel)
 /* Non cancellable read syscall.  */
-__typeof (__read) __read_nocancel;
-
+hidden_proto2 (read, __read_nocancel)
 /* Non cancellable pread syscall (LFS version).  */
-__typeof (__pread64) __pread64_nocancel;
-
+hidden_proto2 (pread64, __pread64_nocancel)
 /* Uncancelable write.  */
-__typeof (__write) __write_nocancel;
-
+hidden_proto2 (write, __write_nocancel)
 /* Uncancelable close.  */
-__typeof (__close) __close_nocancel;
+hidden_proto2 (close, __close_nocancel)
+/* Uncancelable fcntl.  */
+hidden_proto2 (fcntl64, __fcntl64_nocancel)
+#else
+__typeof (open) __open_nocancel;
+__typeof (open64) __open64_nocancel;
+__typeof (openat) __openat_nocancel;
+__typeof (openat64) __openat64_nocancel;
+__typeof (read) __read_nocancel;
+__typeof (pread64) __pread64_nocancel;
+__typeof (write) __write_nocancel;
+__typeof (close) __close_nocancel;
+#endif
 
 /* Non cancellable close syscall that does not also set errno in case of
    failure.  */
@@ -67,19 +73,4 @@ __writev_nocancel_nostatus (int fd, const struct iovec *iov, int iovcnt)
   INTERNAL_SYSCALL_CALL (writev, fd, iov, iovcnt);
 }
 
-/* Uncancelable fcntl.  */
-__typeof (__fcntl) __fcntl64_nocancel;
-
-#if IS_IN (libc) || IS_IN (rtld)
-hidden_proto (__open_nocancel)
-hidden_proto (__open64_nocancel)
-hidden_proto (__openat_nocancel)
-hidden_proto (__openat64_nocancel)
-hidden_proto (__read_nocancel)
-hidden_proto (__pread64_nocancel)
-hidden_proto (__write_nocancel)
-hidden_proto (__close_nocancel)
-hidden_proto (__fcntl64_nocancel)
-#endif
-
 #endif /* NOT_CANCEL_H  */
diff --git a/sysdeps/unix/sysv/linux/powerpc/configure b/sysdeps/unix/sysv/linux/powerpc/configure
index 7183573b..9000c0c9 100644
--- a/sysdeps/unix/sysv/linux/powerpc/configure
+++ b/sysdeps/unix/sysv/linux/powerpc/configure
@@ -1,36 +1,29 @@
 # This file is generated from configure.ac by Autoconf.  DO NOT EDIT!
  # Local configure fragment for sysdeps/unix/sysv/linux/powerpc/.
 
-
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking whether $CC $CFLAGS -mlong-double-128 uses IBM extended format" >&5
 $as_echo_n "checking whether $CC $CFLAGS -mlong-double-128 uses IBM extended format... " >&6; }
 if ${libc_cv_mlong_double_128ibm+:} false; then :
   $as_echo_n "(cached) " >&6
 else
-  save_CFLAGS="$CFLAGS"
-CFLAGS="$CFLAGS -mlong-double-128"
-cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
+  cat > conftest.c <<EOF
 #include <float.h>
-int
-main ()
-{
-
 #if LDBL_MANT_DIG != 106
 # error "compiler doesn't implement IBM extended format of long double"
 #endif
 long double foobar (long double x) { return x; }
-  ;
-  return 0;
-}
-_ACEOF
-if ac_fn_c_try_compile "$LINENO"; then :
+EOF
+libc_cv_mlong_double_128ibm=no
+if { ac_try='${CC-cc} $CFLAGS -mlong-double-128 $CPPFLAGS $LDFLAGS -nostdlib $no_ssp -c conftest.c 1>&5'
+  { { eval echo "\"\$as_me\":${as_lineno-$LINENO}: \"$ac_try\""; } >&5
+  (eval $ac_try) 2>&5
+  ac_status=$?
+  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
+  test $ac_status = 0; }; }
+then
   libc_cv_mlong_double_128ibm=yes
-else
-  libc_cv_mlong_double_128ibm=no
 fi
-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
-CFLAGS="$save_CFLAGS"
+rm -f conftest*
 fi
 { $as_echo "$as_me:${as_lineno-$LINENO}: result: $libc_cv_mlong_double_128ibm" >&5
 $as_echo "$libc_cv_mlong_double_128ibm" >&6; }
@@ -41,30 +34,24 @@ $as_echo_n "checking whether $CC $CFLAGS supports -mabi=ibmlongdouble... " >&6;
 if ${libc_cv_mabi_ibmlongdouble+:} false; then :
   $as_echo_n "(cached) " >&6
 else
-    save_CFLAGS="$CFLAGS"
-  CFLAGS="$CFLAGS -mlong-double-128 -mabi=ibmlongdouble"
-  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
+  cat > conftest.c <<EOF
 #include <float.h>
-int
-main ()
-{
-
 #if LDBL_MANT_DIG != 106
 # error "compiler doesn't implement IBM extended format of long double"
 #endif
 long double foobar (long double x) { return x; }
-  ;
-  return 0;
-}
-_ACEOF
-if ac_fn_c_try_compile "$LINENO"; then :
-  libc_cv_mabi_ibmlongdouble=yes
-else
+EOF
   libc_cv_mabi_ibmlongdouble=no
-fi
-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
-  CFLAGS="$save_CFLAGS"
+  if { ac_try='${CC-cc} $CFLAGS -mlong-double-128 -mabi=ibmlongdouble $CPPFLAGS $LDFLAGS $no_ssp -c conftest.c 1>&5'
+  { { eval echo "\"\$as_me\":${as_lineno-$LINENO}: \"$ac_try\""; } >&5
+  (eval $ac_try) 2>&5
+  ac_status=$?
+  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
+  test $ac_status = 0; }; }
+  then
+    libc_cv_mabi_ibmlongdouble=yes
+  fi
+  rm -f conftest*
 fi
 { $as_echo "$as_me:${as_lineno-$LINENO}: result: $libc_cv_mabi_ibmlongdouble" >&5
 $as_echo "$libc_cv_mabi_ibmlongdouble" >&6; }
diff --git a/sysdeps/unix/sysv/linux/powerpc/configure.ac b/sysdeps/unix/sysv/linux/powerpc/configure.ac
index 8d2ec60f..215e07ca 100644
--- a/sysdeps/unix/sysv/linux/powerpc/configure.ac
+++ b/sysdeps/unix/sysv/linux/powerpc/configure.ac
@@ -2,32 +2,38 @@ sinclude(./aclocal.m4)dnl Autoconf lossage
 GLIBC_PROVIDES dnl See aclocal.m4 in the top level source directory.
 # Local configure fragment for sysdeps/unix/sysv/linux/powerpc/.
 
-AC_CACHE_CHECK(whether $CC $CFLAGS -mlong-double-128 uses IBM extended format,
-	       libc_cv_mlong_double_128ibm, [dnl
-save_CFLAGS="$CFLAGS"
-CFLAGS="$CFLAGS -mlong-double-128"
-AC_COMPILE_IFELSE([AC_LANG_PROGRAM([[#include <float.h>]], [[
+AC_CACHE_CHECK([whether $CC $CFLAGS -mlong-double-128 uses IBM extended format],
+	       [libc_cv_mlong_double_128ibm], [dnl
+cat > conftest.c <<EOF
+#include <float.h>
 #if LDBL_MANT_DIG != 106
 # error "compiler doesn't implement IBM extended format of long double"
 #endif
-long double foobar (long double x) { return x; }]])],
-	       libc_cv_mlong_double_128ibm=yes,
-	       libc_cv_mlong_double_128ibm=no)
-CFLAGS="$save_CFLAGS"])
+long double foobar (long double x) { return x; }
+EOF
+libc_cv_mlong_double_128ibm=no
+if AC_TRY_COMMAND([${CC-cc} $CFLAGS -mlong-double-128 $CPPFLAGS $LDFLAGS -nostdlib $no_ssp -c conftest.c 1>&AS_MESSAGE_LOG_FD])
+then
+  libc_cv_mlong_double_128ibm=yes
+fi
+rm -f conftest*])
 
 if test "$libc_cv_mlong_double_128ibm" = no; then
-  AC_CACHE_CHECK(whether $CC $CFLAGS supports -mabi=ibmlongdouble,
-		 libc_cv_mabi_ibmlongdouble, [dnl
-  save_CFLAGS="$CFLAGS"
-  CFLAGS="$CFLAGS -mlong-double-128 -mabi=ibmlongdouble"
-  AC_COMPILE_IFELSE([AC_LANG_PROGRAM([[#include <float.h>]], [[
+  AC_CACHE_CHECK([whether $CC $CFLAGS supports -mabi=ibmlongdouble],
+		 [libc_cv_mabi_ibmlongdouble], [dnl
+cat > conftest.c <<EOF
+#include <float.h>
 #if LDBL_MANT_DIG != 106
 # error "compiler doesn't implement IBM extended format of long double"
 #endif
-long double foobar (long double x) { return x; }]])],
-		 libc_cv_mabi_ibmlongdouble=yes,
-		 libc_cv_mabi_ibmlongdouble=no)
-  CFLAGS="$save_CFLAGS"])
+long double foobar (long double x) { return x; }
+EOF
+  libc_cv_mabi_ibmlongdouble=no
+  if AC_TRY_COMMAND([${CC-cc} $CFLAGS -mlong-double-128 -mabi=ibmlongdouble $CPPFLAGS $LDFLAGS $no_ssp -c conftest.c 1>&AS_MESSAGE_LOG_FD])
+  then
+    libc_cv_mabi_ibmlongdouble=yes
+  fi
+  rm -f conftest*])
 
   if test "$libc_cv_mabi_ibmlongdouble" = yes; then
     CFLAGS="$CFLAGS -mabi=ibmlongdouble"
diff --git a/sysdeps/unix/sysv/linux/readonly-area.c b/sysdeps/unix/sysv/linux/readonly-area.c
index e8fde06f..b3f7a2fe 100644
--- a/sysdeps/unix/sysv/linux/readonly-area.c
+++ b/sysdeps/unix/sysv/linux/readonly-area.c
@@ -55,17 +55,17 @@ __readonly_area (const char *ptr, size_t size)
 
   while (! __feof_unlocked (fp))
     {
-      if (__getdelim (&line, &linelen, '\n', fp) <= 0)
+      if (__libc_getdelim (&line, &linelen, '\n', fp) <= 0)
 	break;
 
       char *p;
-      uintptr_t from = strtoul (line, &p, 16);
+      uintptr_t from = __strtoul (line, &p, 16);
 
       if (p == line || *p++ != '-')
 	break;
 
       char *q;
-      uintptr_t to = strtoul (p, &q, 16);
+      uintptr_t to = __strtoul (p, &q, 16);
 
       if (q == p || *q++ != ' ')
 	break;
diff --git a/sysdeps/unix/sysv/linux/riscv/Makefile b/sysdeps/unix/sysv/linux/riscv/Makefile
index 4b6eacb3..a4af892a 100644
--- a/sysdeps/unix/sysv/linux/riscv/Makefile
+++ b/sysdeps/unix/sysv/linux/riscv/Makefile
@@ -13,6 +13,8 @@ ifeq (,$(filter $(default-abi),$(abi-variants)))
 $(error Unknown ABI $(default-abi), must be one of $(abi-variants))
 endif
 
+CFLAGS-flush-icache.c += -Wno-unused-function
+
 abi-ilp32-condition   := __WORDSIZE == 32 && defined __riscv_float_abi_soft
 abi-ilp32d-condition  := __WORDSIZE == 32 && defined __riscv_float_abi_double
 abi-lp64-condition    := __WORDSIZE == 64 && defined __riscv_float_abi_soft
diff --git a/sysdeps/unix/sysv/linux/sparc/sparc32/localplt.data b/sysdeps/unix/sysv/linux/sparc/sparc32/localplt.data
index 38309a13..330a2b6b 100644
--- a/sysdeps/unix/sysv/linux/sparc/sparc32/localplt.data
+++ b/sysdeps/unix/sysv/linux/sparc/sparc32/localplt.data
@@ -17,6 +17,9 @@ libc.so: calloc
 libc.so: free
 libc.so: malloc
 libc.so: realloc
+# Unreferenced PLT created by the symbols aliases used to redirect
+# the compiler generated mempcpy/stpcyp calls done by builtin usage.
+libc.so: __mempcpy
 libm.so: matherr
 # The TLS-enabled version of these functions is interposed from libc.so.
 ld.so: _dl_signal_error
diff --git a/sysdeps/unix/sysv/linux/sparc/sparc64/localplt.data b/sysdeps/unix/sysv/linux/sparc/sparc64/localplt.data
index 6a216f3a..21a5fe65 100644
--- a/sysdeps/unix/sysv/linux/sparc/sparc64/localplt.data
+++ b/sysdeps/unix/sysv/linux/sparc/sparc64/localplt.data
@@ -16,6 +16,9 @@ libc.so: calloc
 libc.so: free
 libc.so: malloc
 libc.so: realloc
+# Unreferenced PLT created by the symbols aliases used to redirect
+# the compiler generated mempcpy/stpcyp calls done by builtin usage.
+libc.so: __mempcpy
 libm.so: matherr
 # The TLS-enabled version of these functions is interposed from libc.so.
 ld.so: _dl_signal_error
diff --git a/sysdeps/unix/sysv/linux/sysconf.c b/sysdeps/unix/sysv/linux/sysconf.c
index 7706819c..4afc00c8 100644
--- a/sysdeps/unix/sysv/linux/sysconf.c
+++ b/sysdeps/unix/sysv/linux/sysconf.c
@@ -111,7 +111,7 @@ __sysconf (int name)
 	      buf[n] = '\0';
 
 	      char *endp;
-	      long int res = strtol (buf, &endp, 10);
+	      long int res = __strtol (buf, &endp, 10);
 	      if (endp != buf && (*endp == '\0' || *endp == '\n'))
 		return res;
 	    }
diff --git a/sysdeps/unix/sysv/linux/timer_create.c b/sysdeps/unix/sysv/linux/timer_create.c
index a8b2a41d..290324a7 100644
--- a/sysdeps/unix/sysv/linux/timer_create.c
+++ b/sysdeps/unix/sysv/linux/timer_create.c
@@ -33,9 +33,9 @@ ___timer_create (clockid_t clock_id, struct sigevent *evp, timer_t *timerid)
 {
   {
     clockid_t syscall_clockid = (clock_id == CLOCK_PROCESS_CPUTIME_ID
-				 ? MAKE_PROCESS_CPUCLOCK (0, CPUCLOCK_SCHED)
+				 ? PROCESS_CLOCK
 				 : clock_id == CLOCK_THREAD_CPUTIME_ID
-				 ? MAKE_THREAD_CPUCLOCK (0, CPUCLOCK_SCHED)
+				 ? THREAD_CLOCK
 				 : clock_id);
 
     /* If the user wants notification via a thread we need to handle
diff --git a/sysdeps/unix/sysv/linux/tst-clone3-internal.c b/sysdeps/unix/sysv/linux/tst-clone3-internal.c
index a5002a8f..d0100110 100644
--- a/sysdeps/unix/sysv/linux/tst-clone3-internal.c
+++ b/sysdeps/unix/sysv/linux/tst-clone3-internal.c
@@ -45,16 +45,14 @@ f (void *a)
    implementation.  */
 #define wait_tid(ctid_ptr, ctid_val)					\
   do {									\
-    __typeof (*(ctid_ptr)) __tid;					\
     /* We need acquire MO here so that we synchronize with the		\
        kernel's store to 0 when the clone terminates.  */		\
-    while ((__tid = atomic_load_explicit (ctid_ptr,			\
-					  memory_order_acquire)) != 0)	\
+    while (atomic_load_explicit (ctid_ptr, memory_order_acquire) != 0)	\
       futex_wait (ctid_ptr, ctid_val);					\
   } while (0)
 
 static inline int
-futex_wait (int *futexp, int val)
+futex_wait (_Atomic pid_t *futexp, int val)
 {
 #ifdef __NR_futex
   return syscall (__NR_futex, futexp, FUTEX_WAIT, val);
@@ -75,7 +73,7 @@ do_test (void)
   /* Initialize with a known value.  ctid is set to zero by the kernel after the
      cloned thread has exited.  */
 #define CTID_INIT_VAL 1
-  pid_t ctid = CTID_INIT_VAL;
+  _Atomic pid_t ctid = CTID_INIT_VAL;
   pid_t tid;
 
   struct clone_args clone_args =
diff --git a/sysdeps/unix/sysv/linux/tst-clone3.c b/sysdeps/unix/sysv/linux/tst-clone3.c
index 6390fe26..392fd197 100644
--- a/sysdeps/unix/sysv/linux/tst-clone3.c
+++ b/sysdeps/unix/sysv/linux/tst-clone3.c
@@ -45,16 +45,14 @@ f (void *a)
    implementation.  */
 #define wait_tid(ctid_ptr, ctid_val)					\
   do {									\
-    __typeof (*(ctid_ptr)) __tid;					\
     /* We need acquire MO here so that we synchronize with the		\
        kernel's store to 0 when the clone terminates.  */		\
-    while ((__tid = atomic_load_explicit (ctid_ptr,			\
-					  memory_order_acquire)) != 0)	\
+    while (atomic_load_explicit (ctid_ptr, memory_order_acquire) != 0)	\
       futex_wait (ctid_ptr, ctid_val);					\
   } while (0)
 
 static inline int
-futex_wait (int *futexp, int val)
+futex_wait (_Atomic pid_t *futexp, int val)
 {
 #ifdef __NR_futex
   return syscall (__NR_futex, futexp, FUTEX_WAIT, val);
@@ -75,7 +73,7 @@ do_test (void)
   /* Initialize with a known value.  ctid is set to zero by the kernel after the
      cloned thread has exited.  */
 #define CTID_INIT_VAL 1
-  pid_t ctid = CTID_INIT_VAL;
+  _Atomic pid_t ctid = CTID_INIT_VAL;
   pid_t tid;
 
 #ifdef __ia64__
diff --git a/sysdeps/unix/sysv/linux/tst-getdents64.c b/sysdeps/unix/sysv/linux/tst-getdents64.c
index 62cfa97d..9546a039 100644
--- a/sysdeps/unix/sysv/linux/tst-getdents64.c
+++ b/sysdeps/unix/sysv/linux/tst-getdents64.c
@@ -96,6 +96,8 @@ do_test_by_size (size_t buffer_size)
   int fd = xopen (".", O_RDONLY | O_DIRECTORY, 0);
   TEST_VERIFY (fd >= 0);
 
+  char *data = xposix_memalign (_Alignof (struct dirent64), buffer_size);
+
   /* Perform two passes, with a rewind operating between passes.  */
   for (int pass = 0; pass < 2; ++pass)
     {
@@ -104,23 +106,15 @@ do_test_by_size (size_t buffer_size)
 
       while (true)
         {
-          /* Simple way to make sure that the memcpy below does not read
-             non-existing data.  */
-          struct
-          {
-            char buffer[buffer_size];
-            struct dirent64 pad;
-          } data;
-
-          ssize_t ret = getdents64 (fd, &data.buffer, sizeof (data.buffer));
+          ssize_t ret = getdents64 (fd, data, buffer_size);
           if (ret < 0)
             FAIL_EXIT1 ("getdents64: %m");
           if (ret == 0)
             break;
           ++read_count;
 
-          char *current = data.buffer;
-          char *end = data.buffer + ret;
+          char *current = data;
+          char *end = data + ret;
           while (current != end)
             {
               struct dirent64 entry;
diff --git a/sysdeps/wordsize-64/Makefile b/sysdeps/wordsize-64/Makefile
index 2fa93475..db7764f6 100644
--- a/sysdeps/wordsize-64/Makefile
+++ b/sysdeps/wordsize-64/Makefile
@@ -1,3 +1,8 @@
 ifeq ($(subdir),misc)
 tests += tst-writev
 endif
+
+# strtol is aliased to stroll
+CFLAGS-strtol.c += -fno-builtin-strtoll $(config-cflags-wno-ignored-attributes)
+# strtoul is aliased to strtoull
+CFLAGS-strtoul.c += -fno-builtin-strtoull $(config-cflags-wno-ignored-attributes)
diff --git a/sysdeps/wordsize-64/strtol.c b/sysdeps/wordsize-64/strtol.c
index a1b23741..9ce616c8 100644
--- a/sysdeps/wordsize-64/strtol.c
+++ b/sysdeps/wordsize-64/strtol.c
@@ -11,7 +11,6 @@
 strong_alias (__strtol_internal, __strtoll_internal)
 libc_hidden_ver (__strtol_internal, __strtoll_internal)
 weak_alias (strtol, strtoll)
-libc_hidden_ver (strtol, strtoll)
+libc_hidden_ver (__strtol, __strtoll)
 weak_alias (strtol, strtoq)
-libc_hidden_ver (strtol, strtoq)
 weak_alias (strtol, strtoimax)
diff --git a/sysdeps/x86/bits/floatn.h b/sysdeps/x86/bits/floatn.h
index 34a6fdc8..91ac3784 100644
--- a/sysdeps/x86/bits/floatn.h
+++ b/sysdeps/x86/bits/floatn.h
@@ -28,7 +28,8 @@
    support, for x86_64 and x86.  */
 #if (defined __x86_64__							\
      ? __GNUC_PREREQ (4, 3)						\
-     : (defined __GNU__ ? __GNUC_PREREQ (4, 5) : __GNUC_PREREQ (4, 4)))
+     : (defined __GNU__ ? __GNUC_PREREQ (4, 5) : __GNUC_PREREQ (4, 4))) \
+    || defined __clang__
 # define __HAVE_FLOAT128 1
 #else
 # define __HAVE_FLOAT128 0
@@ -58,7 +59,7 @@
 /* Defined to concatenate the literal suffix to be used with _Float128
    types, if __HAVE_FLOAT128 is 1. */
 # if __HAVE_FLOAT128
-#  if !__GNUC_PREREQ (7, 0) || defined __cplusplus
+#  if !__GNUC_PREREQ (7, 0) || defined __clang__ || defined __cplusplus
 /* The literal suffix f128 exists only since GCC 7.0.  */
 #   define __f128(x) x##q
 #  else
@@ -68,7 +69,7 @@
 
 /* Defined to a complex binary128 type if __HAVE_FLOAT128 is 1.  */
 # if __HAVE_FLOAT128
-#  if !__GNUC_PREREQ (7, 0) || defined __cplusplus
+#  if !__GNUC_PREREQ (7, 0) || defined __clang__ || defined __cplusplus
 /* Add a typedef for older GCC compilers which don't natively support
    _Complex _Float128.  */
 typedef _Complex float __cfloat128 __attribute__ ((__mode__ (__TC__)));
@@ -82,12 +83,12 @@ typedef _Complex float __cfloat128 __attribute__ ((__mode__ (__TC__)));
 # if __HAVE_FLOAT128
 
 /* The type _Float128 exists only since GCC 7.0.  */
-#  if !__GNUC_PREREQ (7, 0) || defined __cplusplus
+#  if !__GNUC_PREREQ (7, 0) || defined __clang__ || defined __cplusplus
 typedef __float128 _Float128;
 #  endif
 
 /* __builtin_huge_valf128 doesn't exist before GCC 7.0.  */
-#  if !__GNUC_PREREQ (7, 0)
+#  if !__GNUC_PREREQ (7, 0) && !defined __clang__
 #   define __builtin_huge_valf128() ((_Float128) __builtin_huge_val ())
 #  endif
 
@@ -96,7 +97,7 @@ typedef __float128 _Float128;
    Converting a narrower sNaN to _Float128 produces a quiet NaN, so
    attempts to use _Float128 sNaNs will not work properly with older
    compilers.  */
-#  if !__GNUC_PREREQ (7, 0)
+#  if !__GNUC_PREREQ (7, 0) && !defined __clang__
 #   define __builtin_copysignf128 __builtin_copysignq
 #   define __builtin_fabsf128 __builtin_fabsq
 #   define __builtin_inff128() ((_Float128) __builtin_inf ())
@@ -108,7 +109,7 @@ typedef __float128 _Float128;
    e.g.: __builtin_signbitf128, before GCC 6.  However, there has never
    been a __builtin_signbitf128 in GCC and the type-generic builtin is
    only available since GCC 6.  */
-#  if !__GNUC_PREREQ (6, 0)
+#  if !__GNUC_PREREQ (6, 0) && !defined __clang__
 #   define __builtin_signbitf128 __signbitf128
 #  endif
 
diff --git a/sysdeps/x86/configure b/sysdeps/x86/configure
index 7bdbfdc6..7850147f 100644
--- a/sysdeps/x86/configure
+++ b/sysdeps/x86/configure
@@ -33,12 +33,12 @@ $as_echo "$libc_cv_x86_cet_available" >&6; }
 fi
 if test $enable_cet != no; then
   # Check if assembler supports CET.
-  { $as_echo "$as_me:${as_lineno-$LINENO}: checking whether $AS supports CET" >&5
-$as_echo_n "checking whether $AS supports CET... " >&6; }
-if ${libc_cv_x86_cet_as+:} false; then :
+  { $as_echo "$as_me:${as_lineno-$LINENO}: checking whether $CC supports CET" >&5
+$as_echo_n "checking whether $CC supports CET... " >&6; }
+if ${libc_cv_x86_cet_cc+:} false; then :
   $as_echo_n "(cached) " >&6
 else
-  cat > conftest.s <<EOF
+  cat > conftest.S <<EOF
 	incsspd %ecx
 EOF
 		 if { ac_try='${CC-cc} -c $CFLAGS conftest.s -o conftest.o 1>&5'
@@ -47,15 +47,15 @@ EOF
   ac_status=$?
   $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
   test $ac_status = 0; }; }; then
-		   libc_cv_x86_cet_as=yes
+		   libc_cv_x86_cet_cc=yes
 		 else
-		   libc_cv_x86_cet_as=no
+		   libc_cv_x86_cet_cc=no
 		 fi
 		 rm -rf conftest*
 fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $libc_cv_x86_cet_as" >&5
-$as_echo "$libc_cv_x86_cet_as" >&6; }
-  if test $libc_cv_x86_cet_as = no; then
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $libc_cv_x86_cet_cc" >&5
+$as_echo "$libc_cv_x86_cet_cc" >&6; }
+  if test $libc_cv_x86_cet_cc = no; then
     as_fn_error $? "$AS doesn't support CET" "$LINENO" 5
   fi
 fi
@@ -189,3 +189,216 @@ $as_echo "$libc_cv_have_x86_movbe" >&6; }
 fi
 config_vars="$config_vars
 enable-x86-isa-level = $libc_cv_include_x86_isa_level"
+# This file is generated from configure.ac by Autoconf.  DO NOT EDIT!
+ # Local configure fragment for sysdeps/x86.
+
+if test $enable_cet != no; then
+  # Check if CET can be enabled.
+  { $as_echo "$as_me:${as_lineno-$LINENO}: checking whether CET can be enabled" >&5
+$as_echo_n "checking whether CET can be enabled... " >&6; }
+if ${libc_cv_x86_cet_available+:} false; then :
+  $as_echo_n "(cached) " >&6
+else
+  cat > conftest.c <<EOF
+#if !defined __CET__ || __CET__ != 3
+# error CET isn't available.
+#endif
+EOF
+		 if { ac_try='${CC-cc} -c $CFLAGS -fcf-protection -include cet.h conftest.c 1>&5'
+  { { eval echo "\"\$as_me\":${as_lineno-$LINENO}: \"$ac_try\""; } >&5
+  (eval $ac_try) 2>&5
+  ac_status=$?
+  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
+  test $ac_status = 0; }; }; then
+		   libc_cv_x86_cet_available=yes
+		 else
+		   libc_cv_x86_cet_available=no
+		 fi
+		 rm -rf conftest*
+fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $libc_cv_x86_cet_available" >&5
+$as_echo "$libc_cv_x86_cet_available" >&6; }
+  if test $libc_cv_x86_cet_available != yes; then
+    as_fn_error $? "$CC doesn't support CET" "$LINENO" 5
+  fi
+fi
+if test $enable_cet != no; then
+  # Check if assembler supports CET.
+  { $as_echo "$as_me:${as_lineno-$LINENO}: checking whether $CC supports CET" >&5
+$as_echo_n "checking whether $CC supports CET... " >&6; }
+if ${libc_cv_x86_cet_cc+:} false; then :
+  $as_echo_n "(cached) " >&6
+else
+  cat > conftest.S <<EOF
+	incsspd %ecx
+EOF
+		 if { ac_try='${CC-cc} -c $CFLAGS conftest.s -o conftest.o 1>&5'
+  { { eval echo "\"\$as_me\":${as_lineno-$LINENO}: \"$ac_try\""; } >&5
+  (eval $ac_try) 2>&5
+  ac_status=$?
+  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
+  test $ac_status = 0; }; }; then
+		   libc_cv_x86_cet_cc=yes
+		 else
+		   libc_cv_x86_cet_cc=no
+		 fi
+		 rm -rf conftest*
+fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $libc_cv_x86_cet_cc" >&5
+$as_echo "$libc_cv_x86_cet_cc" >&6; }
+  if test $libc_cv_x86_cet_cc = no; then
+    as_fn_error $? "$AS doesn't support CET" "$LINENO" 5
+  fi
+fi
+if test $enable_cet = yes; then
+  $as_echo "#define DEFAULT_DL_X86_CET_CONTROL cet_elf_property" >>confdefs.h
+
+elif test $enable_cet = permissive; then
+  $as_echo "#define DEFAULT_DL_X86_CET_CONTROL cet_permissive" >>confdefs.h
+
+fi
+config_vars="$config_vars
+enable-cet = $enable_cet"
+
+# Check if linker supports x86 ISA level.
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for linker x86 ISA level support" >&5
+$as_echo_n "checking for linker x86 ISA level support... " >&6; }
+if ${libc_cv_include_x86_isa_level+:} false; then :
+  $as_echo_n "(cached) " >&6
+else
+  cat > conftest1.S <<EOF
+#ifdef __LP64__
+# define P2ALIGN 3
+#else
+# define P2ALIGN 2
+#endif
+	.section ".note.gnu.property", "a"
+	.p2align P2ALIGN
+	.long 1f - 0f		/* name length.  */
+	.long 4f - 1f		/* data length.  */
+	/* NT_GNU_PROPERTY_TYPE_0 */
+	.long 5			/* note type.  */
+0:
+	.asciz "GNU"		/* vendor name.  */
+1:
+	.p2align P2ALIGN
+	/* GNU_PROPERTY_X86_ISA_1_NEEDED */
+	.long 0xc0008002	/* pr_type.  */
+	.long 3f - 2f		/* pr_datasz.  */
+2:
+	.long 0x1
+3:
+	.p2align P2ALIGN
+4:
+EOF
+cat > conftest2.S <<EOF
+#ifdef __LP64__
+# define P2ALIGN 3
+#else
+# define P2ALIGN 2
+#endif
+	.section ".note.gnu.property", "a"
+	.p2align P2ALIGN
+	.long 1f - 0f		/* name length.  */
+	.long 4f - 1f		/* data length.  */
+	/* NT_GNU_PROPERTY_TYPE_0 */
+	.long 5			/* note type.  */
+0:
+	.asciz "GNU"		/* vendor name.  */
+1:
+	.p2align P2ALIGN
+	/* GNU_PROPERTY_X86_ISA_1_NEEDED */
+	.long 0xc0008002	/* pr_type.  */
+	.long 3f - 2f		/* pr_datasz.  */
+2:
+	.long 0x2
+3:
+	.p2align P2ALIGN
+4:
+EOF
+libc_cv_include_x86_isa_level=no
+if { ac_try='${CC-cc} $CFLAGS $CPPFLAGS -nostartfiles -nostdlib -r -o conftest conftest1.S conftest2.S'
+  { { eval echo "\"\$as_me\":${as_lineno-$LINENO}: \"$ac_try\""; } >&5
+  (eval $ac_try) 2>&5
+  ac_status=$?
+  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
+  test $ac_status = 0; }; }; then
+  count=`LC_ALL=C $READELF -n conftest | grep NT_GNU_PROPERTY_TYPE_0 | wc -l`
+  if test "$count" = 1; then
+    libc_cv_include_x86_isa_level=yes
+  fi
+fi
+rm -f conftest*
+fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $libc_cv_include_x86_isa_level" >&5
+$as_echo "$libc_cv_include_x86_isa_level" >&6; }
+if test $libc_cv_include_x86_isa_level = yes; then
+  $as_echo "#define INCLUDE_X86_ISA_LEVEL 1" >>confdefs.h
+
+  { $as_echo "$as_me:${as_lineno-$LINENO}: checking for LAHF/SAHF instruction support" >&5
+$as_echo_n "checking for LAHF/SAHF instruction support... " >&6; }
+if ${libc_cv_have_x86_lahf_sahf+:} false; then :
+  $as_echo_n "(cached) " >&6
+else
+      libc_cv_have_x86_lahf_sahf=no
+    if { ac_try='${CC-cc} $CFLAGS $CPPFLAGS -fverbose-asm -S -o - -x c /dev/null'
+  { { eval echo "\"\$as_me\":${as_lineno-$LINENO}: \"$ac_try\""; } >&5
+  (eval $ac_try) 2>&5
+  ac_status=$?
+  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
+  test $ac_status = 0; }; } | grep -qE '(-msahf\b|-march=x86-64-v)'; then
+      libc_cv_have_x86_lahf_sahf=yes
+    fi
+fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $libc_cv_have_x86_lahf_sahf" >&5
+$as_echo "$libc_cv_have_x86_lahf_sahf" >&6; }
+  if test $libc_cv_have_x86_lahf_sahf = yes; then
+    $as_echo "#define HAVE_X86_LAHF_SAHF 1" >>confdefs.h
+
+  fi
+  { $as_echo "$as_me:${as_lineno-$LINENO}: checking for MOVBE instruction support" >&5
+$as_echo_n "checking for MOVBE instruction support... " >&6; }
+if ${libc_cv_have_x86_movbe+:} false; then :
+  $as_echo_n "(cached) " >&6
+else
+      libc_cv_have_x86_movbe=no
+    if { ac_try='${CC-cc} $CFLAGS $CPPFLAGS -fverbose-asm -S -o - -x c /dev/null'
+  { { eval echo "\"\$as_me\":${as_lineno-$LINENO}: \"$ac_try\""; } >&5
+  (eval $ac_try) 2>&5
+  ac_status=$?
+  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
+  test $ac_status = 0; }; } | grep -qE '(-mmovbe\b|-march=x86-64-v([3-9]|[1-9][0-9]))'; then
+      libc_cv_have_x86_movbe=yes
+    fi
+fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $libc_cv_have_x86_movbe" >&5
+$as_echo "$libc_cv_have_x86_movbe" >&6; }
+  if test $libc_cv_have_x86_movbe = yes; then
+    $as_echo "#define HAVE_X86_MOVBE 1" >>confdefs.h
+
+  fi
+fi
+config_vars="$config_vars
+enable-x86-isa-level = $libc_cv_include_x86_isa_level"
+
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking if compiler supports -mpfmath=387" >&5
+$as_echo_n "checking if compiler supports -mpfmath=387... " >&6; }
+if ${libc_cv_cc_mfpmath_387+:} false; then :
+  $as_echo_n "(cached) " >&6
+else
+  if { ac_try='${CC-cc} -Werror -mfpmath=387 -xc /dev/null -S -o /dev/null'
+  { { eval echo "\"\$as_me\":${as_lineno-$LINENO}: \"$ac_try\""; } >&5
+  (eval $ac_try) 2>&5
+  ac_status=$?
+  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
+  test $ac_status = 0; }; }; then :
+  libc_cv_cc_mfpmath_387="-mfpmath=387"
+else
+  libc_cv_cc_mfpmath_387=
+fi
+
+fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $libc_cv_cc_mfpmath_387" >&5
+$as_echo "$libc_cv_cc_mfpmath_387" >&6; }
+config_vars="$config_vars
+config-cflags-mfpath-387 = $libc_cv_cc_mfpmath_387"
diff --git a/sysdeps/x86/configure.ac b/sysdeps/x86/configure.ac
index 10d5c2e0..d2986cd0 100644
--- a/sysdeps/x86/configure.ac
+++ b/sysdeps/x86/configure.ac
@@ -22,18 +22,18 @@ EOF
 fi
 if test $enable_cet != no; then
   # Check if assembler supports CET.
-  AC_CACHE_CHECK(whether $AS supports CET,
-		 libc_cv_x86_cet_as, [dnl
-cat > conftest.s <<EOF
+  AC_CACHE_CHECK(whether $CC supports CET,
+		 libc_cv_x86_cet_cc, [dnl
+cat > conftest.S <<EOF
 	incsspd %ecx
 EOF
 		 if AC_TRY_COMMAND(${CC-cc} -c $CFLAGS conftest.s -o conftest.o 1>&AS_MESSAGE_LOG_FD); then
-		   libc_cv_x86_cet_as=yes
+		   libc_cv_x86_cet_cc=yes
 		 else
-		   libc_cv_x86_cet_as=no
+		   libc_cv_x86_cet_cc=no
 		 fi
 		 rm -rf conftest*])
-  if test $libc_cv_x86_cet_as = no; then
+  if test $libc_cv_x86_cet_cc = no; then
     AC_MSG_ERROR([$AS doesn't support CET])
   fi
 fi
@@ -127,3 +127,13 @@ if test $libc_cv_include_x86_isa_level = yes; then
   fi
 fi
 LIBC_CONFIG_VAR([enable-x86-isa-level], [$libc_cv_include_x86_isa_level])
+ 
+dnl Determine if compiler supports -mfpmath=387
+AC_CACHE_CHECK([if compiler supports -mpfmath=387],
+	       libc_cv_cc_mfpmath_387, [dnl
+LIBC_TRY_CC_OPTION([-Werror -mfpmath=387],
+		   [libc_cv_cc_mfpmath_387="-mfpmath=387"],
+		   [libc_cv_cc_mfpmath_387=])
+])
+LIBC_CONFIG_VAR([config-cflags-mfpath-387],
+		[$libc_cv_cc_mfpmath_387])
diff --git a/sysdeps/x86/fpu/Makefile b/sysdeps/x86/fpu/Makefile
index 600e42c3..2d584dbf 100644
--- a/sysdeps/x86/fpu/Makefile
+++ b/sysdeps/x86/fpu/Makefile
@@ -4,11 +4,14 @@ CPPFLAGS += -I../soft-fp
 
 libm-support += powl_helper
 tests += test-fenv-sse test-fenv-clear-sse test-fenv-x87 test-fenv-sse-2 \
-	 test-flt-eval-method-387 test-flt-eval-method-sse
+	 test-flt-eval-method-sse
+ifneq ($(config-cflags-mfpath-387),)
+tests += test-flt-eval-method-387
+endif
 CFLAGS-test-fenv-sse.c += -msse2 -mfpmath=sse
 CFLAGS-test-fenv-clear-sse.c += -msse2 -mfpmath=sse
 CFLAGS-test-fenv-sse-2.c += -msse2 -mfpmath=sse
-CFLAGS-test-flt-eval-method-387.c += -fexcess-precision=standard -mfpmath=387
-CFLAGS-test-flt-eval-method-sse.c += -fexcess-precision=standard -msse2 \
+CFLAGS-test-flt-eval-method-387.c += $(config-cflags-fexcess-precision-standard) -mfpmath=387
+CFLAGS-test-flt-eval-method-sse.c += $(config-cflags-fexcess-precision-standard) -msse2 \
 				     -mfpmath=sse
 endif
diff --git a/sysdeps/x86/fpu/sfp-machine.h b/sysdeps/x86/fpu/sfp-machine.h
index 5892f4f5..60c4b9fc 100644
--- a/sysdeps/x86/fpu/sfp-machine.h
+++ b/sysdeps/x86/fpu/sfp-machine.h
@@ -1,10 +1,19 @@
 /* Configure soft-fp for building sqrtf128.  Based on sfp-machine.h in
    libgcc, with soft-float and other irrelevant parts removed.  */
 
+#if defined __x86_64__ && defined __ILP32__
+typedef long long int __gcc_CMPtype;
+#else
+typedef long int __gcc_CMPtype;
+#endif
+#if !defined(__clang__) && defined(__GNUC__)
 /* The type of the result of a floating point comparison.  This must
    match `__libgcc_cmp_return__' in GCC for the target.  */
-typedef int __gcc_CMPtype __attribute__ ((mode (__libgcc_cmp_return__)));
-#define CMPtype __gcc_CMPtype
+typedef int __gcc_CMPtype_GCC __attribute__ ((mode (__libgcc_cmp_return__)));
+# define CMPtype __gcc_CMPtype
+_Static_assert(sizeof(__gcc_CMPtype) == sizeof(__gcc_CMPtype_GCC),
+	       "sizeof(__gcc_CMPtype) != sizeof(__gcc_CMPtype_GCC)");
+#endif
 
 #ifdef __x86_64__
 # define _FP_W_TYPE_SIZE	64
@@ -41,7 +50,7 @@ typedef unsigned int UTItype __attribute__ ((mode (TI)));
 
 # define FP_INIT_ROUNDMODE					\
   do {								\
-    __asm__ __volatile__ ("%vstmxcsr\t%0" : "=m" (_fcw));	\
+    __asm__ __volatile__ ("vstmxcsr\t%0" : "=m" (_fcw));	\
   } while (0)
 #else
 # define _FP_W_TYPE_SIZE	32
diff --git a/sysdeps/x86/nptl/pthreaddef.h b/sysdeps/x86/nptl/pthreaddef.h
index 63fdbcb2..9de2ea93 100644
--- a/sysdeps/x86/nptl/pthreaddef.h
+++ b/sysdeps/x86/nptl/pthreaddef.h
@@ -39,10 +39,4 @@
 
 
 /* Location of current stack frame.  */
-#ifdef __x86_64__
-/* The frame pointer is not usable.  */
-# define CURRENT_STACK_FRAME \
-  ({ register char *frame __asm__("rsp"); frame; })
-#else
-# define CURRENT_STACK_FRAME	__builtin_frame_address (0)
-#endif
+#define CURRENT_STACK_FRAME __builtin_frame_address (0)
diff --git a/sysdeps/x86/sys/platform/x86.h b/sysdeps/x86/sys/platform/x86.h
index 17f6a144..e504c6b4 100644
--- a/sysdeps/x86/sys/platform/x86.h
+++ b/sysdeps/x86/sys/platform/x86.h
@@ -29,7 +29,7 @@ __BEGIN_DECLS
 extern const struct cpuid_feature *__x86_get_cpuid_feature_leaf (unsigned int)
      __attribute__ ((pure));
 
-static __inline__ _Bool
+static __inline__ __BOOLEAN
 x86_cpu_present (unsigned int __index)
 {
   const struct cpuid_feature *__ptr = __x86_get_cpuid_feature_leaf
@@ -42,7 +42,7 @@ x86_cpu_present (unsigned int __index)
   return __ptr->cpuid_array[__reg] & (1 << __bit);
 }
 
-static __inline__ _Bool
+static __inline__ __BOOLEAN
 x86_cpu_active (unsigned int __index)
 {
   const struct cpuid_feature *__ptr = __x86_get_cpuid_feature_leaf
diff --git a/sysdeps/x86/tst-ldbl-nonnormal-printf.c b/sysdeps/x86/tst-ldbl-nonnormal-printf.c
index 9dae2e4c..63dd1be4 100644
--- a/sysdeps/x86/tst-ldbl-nonnormal-printf.c
+++ b/sysdeps/x86/tst-ldbl-nonnormal-printf.c
@@ -23,7 +23,7 @@
 
 /* Fill the stack with non-zero values.  This makes a crash in
    snprintf more likely.  */
-static void __attribute__ ((noinline, noclone))
+static void __attribute__ ((noinline)) __attribute_noclone__
 fill_stack (void)
 {
   char buffer[65536];
diff --git a/sysdeps/x86/tst-memchr-rtm.c b/sysdeps/x86/tst-memchr-rtm.c
index 117757e4..5b7bf7bc 100644
--- a/sysdeps/x86/tst-memchr-rtm.c
+++ b/sysdeps/x86/tst-memchr-rtm.c
@@ -22,7 +22,7 @@
 #define STRING_SIZE 1024
 char string1[STRING_SIZE];
 
-__attribute__ ((noinline, noclone))
+__attribute__ ((noinline)) __attribute_noclone__
 static int
 prepare (void)
 {
@@ -36,7 +36,7 @@ prepare (void)
     return EXIT_FAILURE;
 }
 
-__attribute__ ((noinline, noclone))
+__attribute__ ((noinline)) __attribute_noclone__
 static int
 function (void)
 {
diff --git a/sysdeps/x86/tst-memcmp-rtm.c b/sysdeps/x86/tst-memcmp-rtm.c
index 98a86f12..294d55be 100644
--- a/sysdeps/x86/tst-memcmp-rtm.c
+++ b/sysdeps/x86/tst-memcmp-rtm.c
@@ -23,7 +23,7 @@
 char string1[STRING_SIZE];
 char string2[STRING_SIZE];
 
-__attribute__ ((noinline, noclone))
+__attribute__ ((noinline)) __attribute_noclone__
 static int
 prepare (void)
 {
@@ -35,7 +35,7 @@ prepare (void)
     return EXIT_FAILURE;
 }
 
-__attribute__ ((noinline, noclone))
+__attribute__ ((noinline)) __attribute_noclone__
 static int
 function (void)
 {
diff --git a/sysdeps/x86/tst-memmove-rtm.c b/sysdeps/x86/tst-memmove-rtm.c
index 0f5341f0..639b1b9f 100644
--- a/sysdeps/x86/tst-memmove-rtm.c
+++ b/sysdeps/x86/tst-memmove-rtm.c
@@ -23,7 +23,7 @@
 char string1[STRING_SIZE];
 char string2[STRING_SIZE];
 
-__attribute__ ((noinline, noclone))
+__attribute__ ((noinline)) __attribute_noclone__
 static int
 prepare (void)
 {
@@ -35,7 +35,7 @@ prepare (void)
     return EXIT_FAILURE;
 }
 
-__attribute__ ((noinline, noclone))
+__attribute__ ((noinline)) __attribute_noclone__
 static int
 function (void)
 {
diff --git a/sysdeps/x86/tst-memrchr-rtm.c b/sysdeps/x86/tst-memrchr-rtm.c
index 34d54a51..07ffd1ac 100644
--- a/sysdeps/x86/tst-memrchr-rtm.c
+++ b/sysdeps/x86/tst-memrchr-rtm.c
@@ -22,7 +22,7 @@
 #define STRING_SIZE 1024
 char string1[STRING_SIZE];
 
-__attribute__ ((noinline, noclone))
+__attribute__ ((noinline)) __attribute_noclone__
 static int
 prepare (void)
 {
@@ -36,7 +36,7 @@ prepare (void)
     return EXIT_FAILURE;
 }
 
-__attribute__ ((noinline, noclone))
+__attribute__ ((noinline)) __attribute_noclone__
 static int
 function (void)
 {
diff --git a/sysdeps/x86/tst-memset-rtm.c b/sysdeps/x86/tst-memset-rtm.c
index 89e0a211..06bc7963 100644
--- a/sysdeps/x86/tst-memset-rtm.c
+++ b/sysdeps/x86/tst-memset-rtm.c
@@ -22,7 +22,7 @@
 #define STRING_SIZE 1024
 char string1[STRING_SIZE];
 
-__attribute__ ((noinline, noclone))
+__attribute__ ((noinline)) __attribute_noclone__
 static int
 prepare (void)
 {
@@ -30,7 +30,7 @@ prepare (void)
   return EXIT_SUCCESS;
 }
 
-__attribute__ ((noinline, noclone))
+__attribute__ ((noinline)) __attribute_noclone__
 static int
 function (void)
 {
diff --git a/sysdeps/x86/tst-strchr-rtm.c b/sysdeps/x86/tst-strchr-rtm.c
index 22f0ba9a..24e159e6 100644
--- a/sysdeps/x86/tst-strchr-rtm.c
+++ b/sysdeps/x86/tst-strchr-rtm.c
@@ -22,7 +22,7 @@
 #define STRING_SIZE 1024
 char string1[STRING_SIZE];
 
-__attribute__ ((noinline, noclone))
+__attribute__ ((noinline)) __attribute_noclone__
 static int
 prepare (void)
 {
@@ -36,7 +36,7 @@ prepare (void)
     return EXIT_FAILURE;
 }
 
-__attribute__ ((noinline, noclone))
+__attribute__ ((noinline)) __attribute_noclone__
 static int
 function (void)
 {
diff --git a/sysdeps/x86/tst-strcpy-rtm.c b/sysdeps/x86/tst-strcpy-rtm.c
index 051555cf..beaf5c5a 100644
--- a/sysdeps/x86/tst-strcpy-rtm.c
+++ b/sysdeps/x86/tst-strcpy-rtm.c
@@ -23,7 +23,7 @@
 char string1[STRING_SIZE];
 char string2[STRING_SIZE];
 
-__attribute__ ((noinline, noclone))
+__attribute__ ((noinline)) __attribute_noclone__
 static int
 prepare (void)
 {
@@ -35,7 +35,7 @@ prepare (void)
     return EXIT_FAILURE;
 }
 
-__attribute__ ((noinline, noclone))
+__attribute__ ((noinline)) __attribute_noclone__
 static int
 function (void)
 {
diff --git a/sysdeps/x86/tst-strlen-rtm.c b/sysdeps/x86/tst-strlen-rtm.c
index 51a5c569..7b840b2d 100644
--- a/sysdeps/x86/tst-strlen-rtm.c
+++ b/sysdeps/x86/tst-strlen-rtm.c
@@ -22,7 +22,7 @@
 #define STRING_SIZE 1024
 char string1[STRING_SIZE];
 
-__attribute__ ((noinline, noclone))
+__attribute__ ((noinline)) __attribute_noclone__
 static int
 prepare (void)
 {
@@ -35,7 +35,7 @@ prepare (void)
     return EXIT_FAILURE;
 }
 
-__attribute__ ((noinline, noclone))
+__attribute__ ((noinline)) __attribute_noclone__
 static int
 function (void)
 {
diff --git a/sysdeps/x86/tst-strncmp-rtm.c b/sysdeps/x86/tst-strncmp-rtm.c
index 09ed6fa0..fc1006d8 100644
--- a/sysdeps/x86/tst-strncmp-rtm.c
+++ b/sysdeps/x86/tst-strncmp-rtm.c
@@ -23,7 +23,7 @@
 char string1[STRING_SIZE];
 char string2[STRING_SIZE];
 
-__attribute__ ((noinline, noclone))
+__attribute__ ((noinline)) __attribute_noclone__
 static int
 prepare (void)
 {
@@ -35,7 +35,7 @@ prepare (void)
     return EXIT_FAILURE;
 }
 
-__attribute__ ((noinline, noclone))
+__attribute__ ((noinline)) __attribute_noclone__
 static int
 function (void)
 {
diff --git a/sysdeps/x86/tst-strrchr-rtm.c b/sysdeps/x86/tst-strrchr-rtm.c
index fd5c944e..c2aeb206 100644
--- a/sysdeps/x86/tst-strrchr-rtm.c
+++ b/sysdeps/x86/tst-strrchr-rtm.c
@@ -22,7 +22,7 @@
 #define STRING_SIZE 1024
 char string1[STRING_SIZE];
 
-__attribute__ ((noinline, noclone))
+__attribute__ ((noinline)) __attribute_noclone__
 static int
 prepare (void)
 {
@@ -35,7 +35,7 @@ prepare (void)
     return EXIT_FAILURE;
 }
 
-__attribute__ ((noinline, noclone))
+__attribute__ ((noinline)) __attribute_noclone__
 static int
 function (void)
 {
diff --git a/sysdeps/x86_64/configure b/sysdeps/x86_64/configure
index d4dd0aa7..058857f2 100755
--- a/sysdeps/x86_64/configure
+++ b/sysdeps/x86_64/configure
@@ -33,5 +33,27 @@ $as_echo "#define PI_STATIC_AND_HIDDEN 1" >>confdefs.h
 $as_echo "#define SUPPORT_STATIC_PIE 1" >>confdefs.h
 
 
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking -msse2avx" >&5
+$as_echo_n "checking -msse2avx... " >&6; }
+if ${libc_cv_cc_msse2avx+:} false; then :
+  $as_echo_n "(cached) " >&6
+else
+  if { ac_try='${CC-cc} -msse2avx -xc /dev/null -S -o /dev/null'
+  { { eval echo "\"\$as_me\":${as_lineno-$LINENO}: \"$ac_try\""; } >&5
+  (eval $ac_try) 2>&5
+  ac_status=$?
+  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
+  test $ac_status = 0; }; }; then :
+  libc_cv_cc_msse2avx=-msse2avx
+else
+  libc_cv_cc_msse2avx=
+fi
+
+fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $libc_cv_cc_msse2avx" >&5
+$as_echo "$libc_cv_cc_msse2avx" >&6; }
+config_vars="$config_vars
+config-cflags-msse2avx = $libc_cv_cc_msse2avx"
+
 test -n "$critic_missing" && as_fn_error $? "
 *** $critic_missing" "$LINENO" 5
diff --git a/sysdeps/x86_64/configure.ac b/sysdeps/x86_64/configure.ac
index c4c748c1..78f7b655 100644
--- a/sysdeps/x86_64/configure.ac
+++ b/sysdeps/x86_64/configure.ac
@@ -21,5 +21,14 @@ AC_DEFINE(PI_STATIC_AND_HIDDEN)
 dnl Static PIE is supported.
 AC_DEFINE(SUPPORT_STATIC_PIE)
 
+dnl Check if compiler supports -msse2avx
+AC_CACHE_CHECK(-msse2avx, libc_cv_cc_msse2avx, [dnl
+LIBC_TRY_CC_OPTION([-msse2avx],
+		   [libc_cv_cc_msse2avx=-msse2avx],
+		   [libc_cv_cc_msse2avx=])
+])
+LIBC_CONFIG_VAR([config-cflags-msse2avx],
+		[$libc_cv_cc_msse2avx])
+
 test -n "$critic_missing" && AC_MSG_ERROR([
 *** $critic_missing])
diff --git a/sysdeps/x86_64/fpu/Makeconfig b/sysdeps/x86_64/fpu/Makeconfig
index 9d7ae05c..45d2c25f 100644
--- a/sysdeps/x86_64/fpu/Makeconfig
+++ b/sysdeps/x86_64/fpu/Makeconfig
@@ -72,6 +72,7 @@ bench-libmvec-float = \
   $(addsuffix f, $(addprefix float-vlen8-avx2-, $(libmvec-bench-funcs))) \
   $(addsuffix f, $(addprefix float-vlen16-, $(libmvec-bench-funcs))) \
 
+ifeq ($(build-mathvec-pragma-simd-omp),yes)
 # The base libmvec ABI tests.
 libmvec-abi-func-tests = \
   $(addprefix test-double-libmvec-,$(libmvec-funcs)) \
@@ -88,6 +89,7 @@ libmvec-abi-func-avx2-tests = \
 # The AVX512F libmvec ABI tests.
 libmvec-abi-func-avx512f-tests = \
   $(addsuffix -avx512f,$(libmvec-abi-func-tests))
+endif
 
 $(common-objpfx)libmvec.mk: $(common-objpfx)config.make
 	(echo "ifeq (\$$(subdir)\$$(build-mathvec),mathyes)"; \
diff --git a/sysdeps/x86_64/fpu/configure b/sysdeps/x86_64/fpu/configure
new file mode 100644
index 00000000..b7ba29c4
--- /dev/null
+++ b/sysdeps/x86_64/fpu/configure
@@ -0,0 +1,61 @@
+# This file is generated from configure.ac by Autoconf.  DO NOT EDIT!
+
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether compiler supports libmvec calls through fopenmp" >&5
+$as_echo_n "checking whether compiler supports libmvec calls through fopenmp... " >&6; }
+if ${libc_cv_libmvec_pragma_omp_simd_support+:} false; then :
+  $as_echo_n "(cached) " >&6
+else
+
+cat > conftest.c <<EOF
+__attribute__ ((__simd__)) float sinf (float);
+void
+foo (float *x)
+{
+  #pragma omp simd
+  for (int i = 0; i < 256; i++)
+    x[i] = sinf (x[i]);
+}
+EOF
+libc_cv_libmvec_pragma_omp_simd_support=no
+# Check regardless of the ABI used
+if { ac_try='${CC-cc} $CFLAGS -fno-inline -fopenmp -Wno-unknown-pragmas -S conftest.c -o conftest.s 1>&5'
+  { { eval echo "\"\$as_me\":${as_lineno-$LINENO}: \"$ac_try\""; } >&5
+  (eval $ac_try) 2>&5
+  ac_status=$?
+  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
+  test $ac_status = 0; }; }
+  then
+  if { ac_try='grep '_ZGVbN4v_sinf' conftest.s >/dev/null'
+  { { eval echo "\"\$as_me\":${as_lineno-$LINENO}: \"$ac_try\""; } >&5
+  (eval $ac_try) 2>&5
+  ac_status=$?
+  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
+  test $ac_status = 0; }; } \
+     || { ac_try='grep '_ZGVcN8v_sinf' conftest.s >/dev/null'
+  { { eval echo "\"\$as_me\":${as_lineno-$LINENO}: \"$ac_try\""; } >&5
+  (eval $ac_try) 2>&5
+  ac_status=$?
+  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
+  test $ac_status = 0; }; } \
+     || { ac_try='grep '_ZGVdN8v_sinf' conftest.s >/dev/null'
+  { { eval echo "\"\$as_me\":${as_lineno-$LINENO}: \"$ac_try\""; } >&5
+  (eval $ac_try) 2>&5
+  ac_status=$?
+  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
+  test $ac_status = 0; }; } \
+     || { ac_try='grep '_ZGVeN16v_sinf' conftest.s >/dev/null'
+  { { eval echo "\"\$as_me\":${as_lineno-$LINENO}: \"$ac_try\""; } >&5
+  (eval $ac_try) 2>&5
+  ac_status=$?
+  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
+  test $ac_status = 0; }; }
+  then
+    libc_cv_libmvec_pragma_omp_simd_support=yes
+  fi
+fi
+rm -f conftest*
+fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $libc_cv_libmvec_pragma_omp_simd_support" >&5
+$as_echo "$libc_cv_libmvec_pragma_omp_simd_support" >&6; }
+config_vars="$config_vars
+build-mathvec-pragma-simd-omp = $libc_cv_libmvec_pragma_omp_simd_support"
diff --git a/sysdeps/x86_64/fpu/configure.ac b/sysdeps/x86_64/fpu/configure.ac
new file mode 100644
index 00000000..d731d00d
--- /dev/null
+++ b/sysdeps/x86_64/fpu/configure.ac
@@ -0,0 +1,30 @@
+GLIBC_PROVIDES dnl See aclocal.m4 in the top level source directory.
+
+AC_CACHE_CHECK([whether compiler supports libmvec calls through fopenmp],
+	       libc_cv_libmvec_pragma_omp_simd_support, [
+dnl
+cat > conftest.c <<EOF
+__attribute__ ((__simd__)) float sinf (float);
+void
+foo (float *x)
+{ 
+  #pragma omp simd
+  for (int i = 0; i < 256; i++)
+    x[[i]] = sinf (x[[i]]);
+}
+EOF
+libc_cv_libmvec_pragma_omp_simd_support=no
+# Check regardless of the ABI used
+if AC_TRY_COMMAND([${CC-cc} $CFLAGS -fno-inline -fopenmp -Wno-unknown-pragmas -S conftest.c -o conftest.s 1>&AS_MESSAGE_LOG_FD])
+  then
+  if AC_TRY_COMMAND([grep '_ZGVbN4v_sinf' conftest.s >/dev/null]) \
+     || AC_TRY_COMMAND([grep '_ZGVcN8v_sinf' conftest.s >/dev/null]) \
+     || AC_TRY_COMMAND([grep '_ZGVdN8v_sinf' conftest.s >/dev/null]) \
+     || AC_TRY_COMMAND([grep '_ZGVeN16v_sinf' conftest.s >/dev/null])
+  then
+    libc_cv_libmvec_pragma_omp_simd_support=yes
+  fi
+fi
+rm -f conftest*])
+LIBC_CONFIG_VAR([build-mathvec-pragma-simd-omp],
+		[$libc_cv_libmvec_pragma_omp_simd_support])
diff --git a/sysdeps/x86_64/fpu/multiarch/Makefile b/sysdeps/x86_64/fpu/multiarch/Makefile
index ec796277..53f98a60 100644
--- a/sysdeps/x86_64/fpu/multiarch/Makefile
+++ b/sysdeps/x86_64/fpu/multiarch/Makefile
@@ -1,4 +1,7 @@
 ifeq ($(subdir),math)
+
+CFLAGS-s_sincos.c += $(config-cflags-wno-ignored-attributes)
+
 libm-sysdep_routines += s_floor-c s_ceil-c s_floorf-c s_ceilf-c \
 			s_rint-c s_rintf-c s_nearbyint-c s_nearbyintf-c \
 			s_roundeven-c s_roundevenf-c s_trunc-c s_truncf-c
@@ -50,12 +53,12 @@ CFLAGS-s_tan-fma4.c = -mfma4
 libm-sysdep_routines += e_exp-avx e_log-avx s_atan-avx \
 			e_atan2-avx s_sin-avx s_tan-avx
 
-CFLAGS-e_atan2-avx.c = -msse2avx -DSSE2AVX
-CFLAGS-e_exp-avx.c = -msse2avx -DSSE2AVX
-CFLAGS-e_log-avx.c = -msse2avx -DSSE2AVX
-CFLAGS-s_atan-avx.c = -msse2avx -DSSE2AVX
-CFLAGS-s_sin-avx.c = -msse2avx -DSSE2AVX
-CFLAGS-s_tan-avx.c = -msse2avx -DSSE2AVX
+CFLAGS-e_atan2-avx.c =  $(config-cflags-msse2avx) -DSSE2AVX
+CFLAGS-e_exp-avx.c =  $(config-cflags-msse2avx) -DSSE2AVX
+CFLAGS-e_log-avx.c =  $(config-cflags-msse2avx) -DSSE2AVX
+CFLAGS-s_atan-avx.c =  $(config-cflags-msse2avx) -DSSE2AVX
+CFLAGS-s_sin-avx.c =  $(config-cflags-msse2avx) -DSSE2AVX
+CFLAGS-s_tan-avx.c =  $(config-cflags-msse2avx) -DSSE2AVX
 endif
 
 ifeq ($(subdir),mathvec)
diff --git a/sysdeps/x86_64/fpu/s_log1pl.S b/sysdeps/x86_64/fpu/s_log1pl.S
index 8219f6fb..b053579d 100644
--- a/sysdeps/x86_64/fpu/s_log1pl.S
+++ b/sysdeps/x86_64/fpu/s_log1pl.S
@@ -14,7 +14,8 @@ RCSID("$NetBSD: s_log1p.S,v 1.7 1995/05/09 00:10:58 jtc Exp $")
 		-1 + sqrt(2) / 2 <= x <= 1 - sqrt(2) / 2
 	   0.29 is a safe value.
 	*/
-limit:	.tfloat 0.29
+limit:	.quad   0x947ae147ae147ae1	/* 0.29L  */
+	.short	0x3ffd
 	/* Please note:	 we use a double value here.  Since 1.0 has
 	   an exact representation this does not effect the accuracy
 	   but it helps to optimize the code.  */
diff --git a/sysdeps/x86_64/fpu/test-double-vlen4.h b/sysdeps/x86_64/fpu/test-double-vlen4.h
index 89ee25d8..3c812359 100644
--- a/sysdeps/x86_64/fpu/test-double-vlen4.h
+++ b/sysdeps/x86_64/fpu/test-double-vlen4.h
@@ -16,6 +16,6 @@
    License along with the GNU C Library; if not, see
    <https://www.gnu.org/licenses/>.  */
 
-#include_next <test-double-vlen4.h>
+#include <math/test-double-vlen4.h>
 
 #define REQUIRE_AVX
diff --git a/sysdeps/x86_64/fpu/test-double-vlen8.h b/sysdeps/x86_64/fpu/test-double-vlen8.h
index 08438d1b..100cf8cb 100644
--- a/sysdeps/x86_64/fpu/test-double-vlen8.h
+++ b/sysdeps/x86_64/fpu/test-double-vlen8.h
@@ -16,6 +16,6 @@
    License along with the GNU C Library; if not, see
    <https://www.gnu.org/licenses/>.  */
 
-#include_next <test-double-vlen8.h>
+#include <math/test-double-vlen8.h>
 
 #define REQUIRE_AVX512F
diff --git a/sysdeps/x86_64/fpu/test-float-vlen16.h b/sysdeps/x86_64/fpu/test-float-vlen16.h
index 0519cc76..ff79c58f 100644
--- a/sysdeps/x86_64/fpu/test-float-vlen16.h
+++ b/sysdeps/x86_64/fpu/test-float-vlen16.h
@@ -16,6 +16,6 @@
    License along with the GNU C Library; if not, see
    <https://www.gnu.org/licenses/>.  */
 
-#include_next <test-float-vlen16.h>
+#include <math/test-float-vlen16.h>
 
 #define REQUIRE_AVX512F
diff --git a/sysdeps/x86_64/fpu/test-float-vlen8.h b/sysdeps/x86_64/fpu/test-float-vlen8.h
index 55805c21..71deec3c 100644
--- a/sysdeps/x86_64/fpu/test-float-vlen8.h
+++ b/sysdeps/x86_64/fpu/test-float-vlen8.h
@@ -16,6 +16,6 @@
    License along with the GNU C Library; if not, see
    <https://www.gnu.org/licenses/>.  */
 
-#include_next <test-float-vlen8.h>
+#include <math/test-float-vlen8.h>
 
 #define REQUIRE_AVX
diff --git a/sysdeps/x86_64/multiarch/memmove-sse2-unaligned-erms.S b/sysdeps/x86_64/multiarch/memmove-sse2-unaligned-erms.S
index 09e7c1d6..b7b7e01a 100644
--- a/sysdeps/x86_64/multiarch/memmove-sse2-unaligned-erms.S
+++ b/sysdeps/x86_64/multiarch/memmove-sse2-unaligned-erms.S
@@ -31,3 +31,8 @@ weak_alias (__mempcpy, mempcpy)
 compat_symbol (libc, __memmove_sse2_unaligned, memcpy, GLIBC_2_2_5);
 # endif
 #endif
+
+#ifndef SHARED
+strong_alias (__mempcpy_sse2_unaligned, __memcpy_generic)
+strong_alias (__memmove_sse2_unaligned, __memmove_generic)
+#endif
diff --git a/sysdeps/x86_64/multiarch/memset-sse2-unaligned-erms.S b/sysdeps/x86_64/multiarch/memset-sse2-unaligned-erms.S
index 8a6f0c56..48a77331 100644
--- a/sysdeps/x86_64/multiarch/memset-sse2-unaligned-erms.S
+++ b/sysdeps/x86_64/multiarch/memset-sse2-unaligned-erms.S
@@ -28,6 +28,7 @@
 #  undef libc_hidden_builtin_def
 #  define libc_hidden_builtin_def(name)
 # endif
+strong_alias (__memset_sse2_unaligned, __memset_generic)
 
 # undef weak_alias
 # define weak_alias(original, alias) \
diff --git a/sysdeps/x86_64/multiarch/strstr.c b/sysdeps/x86_64/multiarch/strstr.c
index 95600a9d..a1e2c2a5 100644
--- a/sysdeps/x86_64/multiarch/strstr.c
+++ b/sysdeps/x86_64/multiarch/strstr.c
@@ -34,7 +34,6 @@
 #include "string/strstr.c"
 
 extern __typeof (__redirect_strstr) __strstr_sse2_unaligned attribute_hidden;
-extern __typeof (__redirect_strstr) __strstr_sse2 attribute_hidden;
 
 #include "init-arch.h"
 
diff --git a/sysdeps/x86_64/nptl/tls.h b/sysdeps/x86_64/nptl/tls.h
index 75f80209..7a36c9b6 100644
--- a/sysdeps/x86_64/nptl/tls.h
+++ b/sysdeps/x86_64/nptl/tls.h
@@ -132,6 +132,8 @@ _Static_assert (offsetof (tcbhead_t, __glibc_unused2) == 0x80,
 # define GET_DTV(descr) \
   (((tcbhead_t *) (descr))->dtv)
 
+# define TLS_INIT_TP_ERR_MSG \
+  "cannot set %fs base address for thread-local storage"
 
 /* Code to initially initialize the thread pointer.  This might need
    special attention since 'errno' is not yet available and if the
@@ -156,7 +158,7 @@ _Static_assert (offsetof (tcbhead_t, __glibc_unused2) == 0x80,
 		     "S" (_thrdescr)					      \
 		   : "memory", "cc", "r11", "cx");			      \
 									      \
-    _result ? "cannot set %fs base address for thread-local storage" : 0;     \
+     _result ? false : true;						      \
   })
 
 # define TLS_DEFINE_INIT_TP(tp, pd) void *tp = (pd)
diff --git a/sysdeps/x86_64/tst-rsi-strlen.c b/sysdeps/x86_64/tst-rsi-strlen.c
index 0bd82c2a..682172f6 100644
--- a/sysdeps/x86_64/tst-rsi-strlen.c
+++ b/sysdeps/x86_64/tst-rsi-strlen.c
@@ -44,7 +44,7 @@ typedef struct
 } parameter_t;
 
 size_t
-__attribute__ ((weak, noinline, noclone))
+__attribute__ ((weak, noinline)) __attribute_noclone__
 do_strlen (parameter_t *a, int zero, const CHAR *str)
 {
   return CALL (a, str);
diff --git a/termios/Makefile b/termios/Makefile
index 54ed9fe5..1490dd17 100644
--- a/termios/Makefile
+++ b/termios/Makefile
@@ -31,3 +31,4 @@ routines	:= speed cfsetspeed tcsetattr tcgetattr tcgetpgrp tcsetpgrp \
 include ../Rules
 
 CFLAGS-tcdrain.c += -fexceptions -fasynchronous-unwind-tables
+CFLAGS-tcsetattr.c += $(config-cflags-wno-ignored-attributes)
diff --git a/time/Makefile b/time/Makefile
index 470275b9..dc6e2c93 100644
--- a/time/Makefile
+++ b/time/Makefile
@@ -98,6 +98,7 @@ CFLAGS-tzset.c += $(tz-cflags)
 CFLAGS-getdate.c += -fexceptions
 CFLAGS-clock_nanosleep.c += -fexceptions -fasynchronous-unwind-tables
 CFLAGS-nanosleep.c += -fexceptions -fasynchronous-unwind-tables
+CFLAGS-mktime.c += $(config-cflags-wno-ignored-attributes)
 
 # Don't warn about Y2k problem in strftime format string.
 CFLAGS-test_time.c += -Wno-format
diff --git a/time/tst-strftime.c b/time/tst-strftime.c
index af3ff72f..482cd16c 100644
--- a/time/tst-strftime.c
+++ b/time/tst-strftime.c
@@ -102,18 +102,18 @@ do_test (void)
 
       if (res == 0)
 	{
-	  printf ("%Zu: %s: res == 0 despite size == %Zu\n",
+	  printf ("%zu: %s: res == 0 despite size == %zu\n",
 		  cnt, tests[cnt].fmt, size);
 	  result = 1;
 	}
       else if (size < tests[cnt].min)
 	{
-	  printf ("%Zu: %s: size == %Zu was enough\n",
+	  printf ("%zu: %s: size == %zu was enough\n",
 		  cnt, tests[cnt].fmt, size);
 	  result = 1;
 	}
       else
-	printf ("%Zu: %s: size == %Zu: OK\n", cnt, tests[cnt].fmt, size);
+	printf ("%zu: %s: size == %zu: OK\n", cnt, tests[cnt].fmt, size);
 
       free (buf);
     }
diff --git a/time/tzset.c b/time/tzset.c
index a06142bb..ac20e1a5 100644
--- a/time/tzset.c
+++ b/time/tzset.c
@@ -242,7 +242,7 @@ parse_rule (const char **tzp, int whichrule)
       tzr->type = *tz == 'J' ? J1 : J0;
       if (tzr->type == J1 && !isdigit (*++tz))
 	return false;
-      unsigned long int d = strtoul (tz, &end, 10);
+      unsigned long int d = __strtoul (tz, &end, 10);
       if (end == tz || d > 365)
 	return false;
       if (tzr->type == J1 && d == 0)
diff --git a/timezone/Makefile b/timezone/Makefile
index a789c22d..809c9098 100644
--- a/timezone/Makefile
+++ b/timezone/Makefile
@@ -61,7 +61,7 @@ tz-cflags = -DTZDIR='"$(zonedir)"' \
 	    -DTZDEFRULES='"$(posixrules-file)"' \
 	    -DTM_GMTOFF=tm_gmtoff -DTM_ZONE=tm_zone \
 	    -DHAVE_GETTEXT -DUSE_LTZ=0 -D_ISOMAC -DTZ_DOMAIN='"libc"' \
-	    -include $(common-objpfx)config.h -Wno-maybe-uninitialized
+	    -include $(common-objpfx)config.h $(config-cflags-wno-maybe-uninitialized)
 
 # The -Wno-unused-variable flag is used to prevent GCC 6
 # from warning about time_t_min and time_t_max which are
diff --git a/timezone/zdump.c b/timezone/zdump.c
index b532fe3e..bfc01faf 100644
--- a/timezone/zdump.c
+++ b/timezone/zdump.c
@@ -665,7 +665,7 @@ hunt(timezone_t tz, char *name, time_t lot, time_t hit)
 		else if (t >= hit)
 			--t;
 		tm_ok = my_localtime_rz(tz, &t, &tm) != NULL;
-		if (lotm_ok & tm_ok
+		if ((lotm_ok & tm_ok)
 		    ? (delta(&tm, &lotm) == t - lot
 		       && tm.tm_isdst == lotm.tm_isdst
 		       && strcmp(abbr(&tm), ab) == 0)
diff --git a/wcsmbs/Makefile b/wcsmbs/Makefile
index df9a85f4..fdd5965b 100644
--- a/wcsmbs/Makefile
+++ b/wcsmbs/Makefile
@@ -22,7 +22,7 @@ subdir	:= wcsmbs
 
 include ../Makeconfig
 
-headers	:= wchar.h bits/wchar.h bits/wchar2.h bits/wchar-ldbl.h uchar.h \
+headers	:= wchar.h bits/wchar.h bits/wchar2.h uchar.h \
 	   bits/types/__mbstate_t.h bits/types/mbstate_t.h bits/types/wint_t.h
 
 routines := wcscat wcschr wcscmp wcscpy wcscspn wcsdup wcslen wcsncat \
@@ -80,24 +80,30 @@ CFLAGS-wcwidth.c += -I../wctype
 CFLAGS-wcswidth.c += -I../wctype
 
 strtox-CFLAGS = -I../include
-CFLAGS-wcstol.c += $(strtox-CFLAGS)
-CFLAGS-wcstoul.c += $(strtox-CFLAGS)
+CFLAGS-wcstol.c += $(strtox-CFLAGS) $(config-cflags-wno-ignored-attributes)
+CFLAGS-wcstoul.c += $(strtox-CFLAGS) $(config-cflags-wno-ignored-attributes)
 CFLAGS-wcstoll.c += $(strtox-CFLAGS)
 CFLAGS-wcstoull.c += $(strtox-CFLAGS)
-CFLAGS-wcstod.c += $(strtox-CFLAGS)
-CFLAGS-wcstold.c += $(strtox-CFLAGS)
+CFLAGS-wcstod.c += $(strtox-CFLAGS) $(config-cflags-wno-ignored-attributes)
+CFLAGS-wcstold.c += $(strtox-CFLAGS) $(config-cflags-wno-ignored-attributes)
 CFLAGS-wcstof128.c += $(strtox-CFLAGS)
-CFLAGS-wcstof.c += $(strtox-CFLAGS)
+CFLAGS-wcstof.c += $(strtox-CFLAGS) $(config-cflags-wno-ignored-attributes)
 CFLAGS-wcstol_l.c += $(strtox-CFLAGS)
 CFLAGS-wcstoul_l.c += $(strtox-CFLAGS)
 CFLAGS-wcstoll_l.c += $(strtox-CFLAGS)
 CFLAGS-wcstoull_l.c += $(strtox-CFLAGS)
-CFLAGS-wcstod_l.c += $(strtox-CFLAGS)
-CFLAGS-wcstold_l.c += $(strtox-CFLAGS)
+CFLAGS-wcstod_l.c += $(strtox-CFLAGS) $(config-cflags-wno-ignored-attributes)
+CFLAGS-wcstold_l.c += $(strtox-CFLAGS) $(config-cflags-wno-ignored-attributes)
 CFLAGS-wcstof128_l.c += $(strtox-CFLAGS)
-CFLAGS-wcstof_l.c += $(strtox-CFLAGS)
+CFLAGS-wcstof_l.c += $(strtox-CFLAGS) $(config-cflags-wno-ignored-attributes)
 CPPFLAGS-tst-wchar-h.c += -D_FORTIFY_SOURCE=2
 
+CFLAGS-wcschr.c += $(config-cflags-wno-ignored-attributes)
+CFLAGS-wmemchr.c += $(config-cflags-wno-ignored-attributes)
+CFLAGS-wmemset.c += $(config-cflags-wno-ignored-attributes)
+CFLAGS-mbrtowc.c += $(config-cflags-wno-ignored-attributes)
+CFLAGS-wcrtomb.c += $(config-cflags-wno-ignored-attributes)
+
 CFLAGS-isoc99_wscanf.c += -fexceptions
 CFLAGS-isoc99_fwscanf.c += -fexceptions
 CFLAGS-isoc99_vwscanf.c += -fexceptions
diff --git a/wcsmbs/bits/wchar-ldbl.h b/wcsmbs/bits/wchar-ldbl.h
deleted file mode 100644
index f0d8506f..00000000
--- a/wcsmbs/bits/wchar-ldbl.h
+++ /dev/null
@@ -1,91 +0,0 @@
-/* -mlong-double-64 compatibility mode for <wchar.h> functions.
-   Copyright (C) 2006-2022 Free Software Foundation, Inc.
-   This file is part of the GNU C Library.
-
-   The GNU C Library is free software; you can redistribute it and/or
-   modify it under the terms of the GNU Lesser General Public
-   License as published by the Free Software Foundation; either
-   version 2.1 of the License, or (at your option) any later version.
-
-   The GNU C Library is distributed in the hope that it will be useful,
-   but WITHOUT ANY WARRANTY; without even the implied warranty of
-   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
-   Lesser General Public License for more details.
-
-   You should have received a copy of the GNU Lesser General Public
-   License along with the GNU C Library; if not, see
-   <https://www.gnu.org/licenses/>.  */
-
-#ifndef _WCHAR_H
-# error "Never include <bits/wchar-ldbl.h> directly; use <wchar.h> instead."
-#endif
-
-#if defined __USE_ISOC95 || defined __USE_UNIX98
-__LDBL_REDIR_DECL (fwprintf);
-__LDBL_REDIR_DECL (wprintf);
-__LDBL_REDIR_DECL (swprintf);
-__LDBL_REDIR_DECL (vfwprintf);
-__LDBL_REDIR_DECL (vwprintf);
-__LDBL_REDIR_DECL (vswprintf);
-# if !__GLIBC_USE (DEPRECATED_SCANF)
-#  if defined __LDBL_COMPAT
-__LDBL_REDIR1_DECL (fwscanf, __nldbl___isoc99_fwscanf)
-__LDBL_REDIR1_DECL (wscanf, __nldbl___isoc99_wscanf)
-__LDBL_REDIR1_DECL (swscanf, __nldbl___isoc99_swscanf)
-#  elif __LDOUBLE_REDIRECTS_TO_FLOAT128_ABI == 1
-__LDBL_REDIR1_DECL (fwscanf, __isoc99_fwscanfieee128)
-__LDBL_REDIR1_DECL (wscanf, __isoc99_wscanfieee128)
-__LDBL_REDIR1_DECL (swscanf, __isoc99_swscanfieee128)
-#  else
-#   error bits/stdlib-ldbl.h included when no ldbl redirections are required.
-#  endif
-# else
-__LDBL_REDIR_DECL (fwscanf);
-__LDBL_REDIR_DECL (wscanf);
-__LDBL_REDIR_DECL (swscanf);
-# endif
-#endif
-
-#ifdef __USE_ISOC99
-# ifdef __LDBL_COMPAT
-__LDBL_REDIR1_DECL (wcstold, wcstod);
-# else
-__LDBL_REDIR1_DECL (wcstold, __wcstoieee128)
-# endif
-# if !__GLIBC_USE (DEPRECATED_SCANF)
-#  if defined __LDBL_COMPAT
-__LDBL_REDIR1_DECL (vfwscanf, __nldbl___isoc99_vfwscanf)
-__LDBL_REDIR1_DECL (vwscanf, __nldbl___isoc99_vwscanf)
-__LDBL_REDIR1_DECL (vswscanf, __nldbl___isoc99_vswscanf)
-#  elif __LDOUBLE_REDIRECTS_TO_FLOAT128_ABI == 1
-__LDBL_REDIR1_DECL (vfwscanf, __isoc99_vfwscanfieee128)
-__LDBL_REDIR1_DECL (vwscanf, __isoc99_vwscanfieee128)
-__LDBL_REDIR1_DECL (vswscanf, __isoc99_vswscanfieee128)
-#  else
-#   error bits/stdlib-ldbl.h included when no ldbl redirections are required.
-#  endif
-# else
-__LDBL_REDIR_DECL (vfwscanf);
-__LDBL_REDIR_DECL (vwscanf);
-__LDBL_REDIR_DECL (vswscanf);
-# endif
-#endif
-
-#ifdef __USE_GNU
-# ifdef __LDBL_COMPAT
-__LDBL_REDIR1_DECL (wcstold_l, wcstod_l);
-# else
-__LDBL_REDIR1_DECL (wcstold_l, __wcstoieee128_l)
-# endif
-#endif
-
-#if __USE_FORTIFY_LEVEL > 0 && defined __fortify_function
-__LDBL_REDIR2_DECL (swprintf_chk)
-__LDBL_REDIR2_DECL (vswprintf_chk)
-# if __USE_FORTIFY_LEVEL > 1
-__LDBL_REDIR2_DECL (fwprintf_chk)
-__LDBL_REDIR2_DECL (wprintf_chk)
-__LDBL_REDIR2_DECL (vfwprintf_chk)
-__LDBL_REDIR2_DECL (vwprintf_chk)
-# endif
-#endif
diff --git a/wcsmbs/bits/wchar2.h b/wcsmbs/bits/wchar2.h
index 0e017f45..548deeed 100644
--- a/wcsmbs/bits/wchar2.h
+++ b/wcsmbs/bits/wchar2.h
@@ -227,16 +227,18 @@ __NTH (wcsncat (wchar_t *__restrict __dest, const wchar_t *__restrict __src,
   return __wcsncat_alias (__dest, __src, __n);
 }
 
-
-extern int __swprintf_chk (wchar_t *__restrict __s, size_t __n,
-			   int __flag, size_t __s_len,
-			   const wchar_t *__restrict __format, ...)
-     __THROW /* __attribute__ ((__format__ (__wprintf__, 5, 6))) */;
-
-extern int __REDIRECT_NTH_LDBL (__swprintf_alias,
-				(wchar_t *__restrict __s, size_t __n,
-				 const wchar_t *__restrict __fmt, ...),
-				swprintf);
+extern int __REDIRECT_LDBL_NTH (__swprintf_chk, (wchar_t *__restrict __s,
+						 size_t __n,
+						 int __flag, size_t __s_len,
+						 const wchar_t *__restrict __format,
+						 ...),
+				__swprintf_chkieee128, __nldbl___swprintf_chk);
+extern int __REDIRECT_LDBL_NTH (__vswprintf_chk, (wchar_t *__restrict __s,
+						  size_t __n,
+						  int __flag, size_t __s_len,
+						  const wchar_t *__restrict __format,
+						  __gnuc_va_list __arg),
+				__vswprintf_chkieee128, __nldbl___vswprintf_chk);
 
 #ifdef __va_arg_pack
 __fortify_function int
@@ -247,7 +249,7 @@ __NTH (swprintf (wchar_t *__restrict __s, size_t __n,
   if (sz != (size_t) -1 || __USE_FORTIFY_LEVEL > 1)
     return __swprintf_chk (__s, __n, __USE_FORTIFY_LEVEL - 1,
 			   sz / sizeof (wchar_t), __fmt, __va_arg_pack ());
-  return __swprintf_alias (__s, __n, __fmt, __va_arg_pack ());
+  return swprintf (__s, __n, __fmt, __va_arg_pack ());
 }
 #elif !defined __cplusplus
 /* XXX We might want to have support in gcc for swprintf.  */
@@ -258,17 +260,6 @@ __NTH (swprintf (wchar_t *__restrict __s, size_t __n,
    : swprintf (s, n, __VA_ARGS__))
 #endif
 
-extern int __vswprintf_chk (wchar_t *__restrict __s, size_t __n,
-			    int __flag, size_t __s_len,
-			    const wchar_t *__restrict __format,
-			    __gnuc_va_list __arg)
-     __THROW /* __attribute__ ((__format__ (__wprintf__, 5, 0))) */;
-
-extern int __REDIRECT_NTH_LDBL (__vswprintf_alias,
-				(wchar_t *__restrict __s, size_t __n,
-				 const wchar_t *__restrict __fmt,
-				 __gnuc_va_list __ap), vswprintf);
-
 __fortify_function int
 __NTH (vswprintf (wchar_t *__restrict __s, size_t __n,
 		  const wchar_t *__restrict __fmt, __gnuc_va_list __ap))
@@ -277,21 +268,30 @@ __NTH (vswprintf (wchar_t *__restrict __s, size_t __n,
   if (sz != (size_t) -1 || __USE_FORTIFY_LEVEL > 1)
     return __vswprintf_chk (__s, __n,  __USE_FORTIFY_LEVEL - 1,
 			    sz / sizeof (wchar_t), __fmt, __ap);
-  return __vswprintf_alias (__s, __n, __fmt, __ap);
+  return vswprintf (__s, __n, __fmt, __ap);
 }
 
 
 #if __USE_FORTIFY_LEVEL > 1
 
-extern int __fwprintf_chk (__FILE *__restrict __stream, int __flag,
-			   const wchar_t *__restrict __format, ...);
-extern int __wprintf_chk (int __flag, const wchar_t *__restrict __format,
-			  ...);
-extern int __vfwprintf_chk (__FILE *__restrict __stream, int __flag,
-			    const wchar_t *__restrict __format,
-			    __gnuc_va_list __ap);
-extern int __vwprintf_chk (int __flag, const wchar_t *__restrict __format,
-			   __gnuc_va_list __ap);
+extern int __REDIRECT_LDBL (__fwprintf_chk, (__FILE *__restrict __stream,
+					     int __flag,
+					     const wchar_t *__restrict __format,
+					     ...),
+			    __fwprintf_chkieee128, __nldbl___fwprintf_chk);
+extern int __REDIRECT_LDBL (__wprintf_chk, (int __flag,
+					    const wchar_t *__restrict __format,
+					    ...),
+			    __wprintf_chkieee128, __nldbl___wprintf_chk);
+extern int __REDIRECT_LDBL (__vfwprintf_chk, (__FILE *__restrict __stream,
+					      int __flag,
+					      const wchar_t *__restrict __format,
+					      __gnuc_va_list __ap),
+			   __vfwprintf_chkieee128, __nldbl___vfwprintf_chk);
+extern int __REDIRECT_LDBL (__vwprintf_chk, (int __flag,
+					     const wchar_t *__restrict __format,
+					     __gnuc_va_list __ap),
+			    __vwprintf_chkieee128, __nldbl___vwprintf_chk);
 
 # ifdef __va_arg_pack
 __fortify_function int
diff --git a/wcsmbs/wchar.h b/wcsmbs/wchar.h
index 5d6a4085..27406d0e 100644
--- a/wcsmbs/wchar.h
+++ b/wcsmbs/wchar.h
@@ -382,8 +382,10 @@ extern double wcstod (const wchar_t *__restrict __nptr,
 /* Likewise for `float' and `long double' sizes of floating-point numbers.  */
 extern float wcstof (const wchar_t *__restrict __nptr,
 		     wchar_t **__restrict __endptr) __THROW;
-extern long double wcstold (const wchar_t *__restrict __nptr,
-			    wchar_t **__restrict __endptr) __THROW;
+extern long double __REDIRECT_LDBL_NTH (wcstold,
+					(const wchar_t *__restrict __nptr,
+					 wchar_t **__restrict __endptr),
+					__wcstoieee128, wcstod);
 #endif /* C99 */
 
 /* Likewise for `_FloatN' and `_FloatNx' when support is enabled.  */
@@ -498,9 +500,12 @@ extern float wcstof_l (const wchar_t *__restrict __nptr,
 		       wchar_t **__restrict __endptr, locale_t __loc)
      __THROW;
 
-extern long double wcstold_l (const wchar_t *__restrict __nptr,
-			      wchar_t **__restrict __endptr,
-			      locale_t __loc) __THROW;
+
+extern long double __REDIRECT_LDBL_NTH (wcstold_l,
+					(const wchar_t *__restrict __nptr,
+					 wchar_t **__restrict __endptr,
+					 locale_t __loc),
+					__wcstoieee128_l, wcstod_l);
 
 # if __HAVE_FLOAT16
 extern _Float16 wcstof16_l (const wchar_t *__restrict __nptr,
@@ -587,73 +592,61 @@ extern __FILE *open_wmemstream (wchar_t **__bufloc, size_t *__sizeloc) __THROW
 /* Select orientation for stream.  */
 extern int fwide (__FILE *__fp, int __mode) __THROW;
 
-
 /* Write formatted output to STREAM.
 
    This function is a possible cancellation point and therefore not
    marked with __THROW.  */
-extern int fwprintf (__FILE *__restrict __stream,
-		     const wchar_t *__restrict __format, ...)
+extern int __REDIRECT_LDBL128 (fwprintf, (__FILE *__restrict __stream,
+					  const wchar_t *__restrict __format,
+					  ...))
      /* __attribute__ ((__format__ (__wprintf__, 2, 3))) */;
 /* Write formatted output to stdout.
 
    This function is a possible cancellation point and therefore not
    marked with __THROW.  */
-extern int wprintf (const wchar_t *__restrict __format, ...)
+extern int __REDIRECT_LDBL128 (wprintf, (const wchar_t *__restrict __format, ...))
      /* __attribute__ ((__format__ (__wprintf__, 1, 2))) */;
 /* Write formatted output of at most N characters to S.  */
-extern int swprintf (wchar_t *__restrict __s, size_t __n,
-		     const wchar_t *__restrict __format, ...)
-     __THROW /* __attribute__ ((__format__ (__wprintf__, 3, 4))) */;
+extern int __REDIRECT_LDBL128_NTH (swprintf, (wchar_t *__restrict __s, size_t __n,
+					      const wchar_t *__restrict __format,
+					      ...))
+     /* __attribute__ ((__format__ (__wprintf__, 3, 4))) */;
 
 /* Write formatted output to S from argument list ARG.
 
    This function is a possible cancellation point and therefore not
    marked with __THROW.  */
-extern int vfwprintf (__FILE *__restrict __s,
-		      const wchar_t *__restrict __format,
-		      __gnuc_va_list __arg)
+extern int __REDIRECT_LDBL128 (vfwprintf, (__FILE *__restrict __s,
+					const wchar_t *__restrict __format,
+					__gnuc_va_list __arg))
      /* __attribute__ ((__format__ (__wprintf__, 2, 0))) */;
 /* Write formatted output to stdout from argument list ARG.
 
    This function is a possible cancellation point and therefore not
    marked with __THROW.  */
-extern int vwprintf (const wchar_t *__restrict __format,
-		     __gnuc_va_list __arg)
+extern int __REDIRECT_LDBL128 (vwprintf, (const wchar_t *__restrict __format,
+				       __gnuc_va_list __arg))
      /* __attribute__ ((__format__ (__wprintf__, 1, 0))) */;
 /* Write formatted output of at most N character to S from argument
    list ARG.  */
-extern int vswprintf (wchar_t *__restrict __s, size_t __n,
-		      const wchar_t *__restrict __format,
-		      __gnuc_va_list __arg)
-     __THROW /* __attribute__ ((__format__ (__wprintf__, 3, 0))) */;
-
-
-/* Read formatted input from STREAM.
-
-   This function is a possible cancellation point and therefore not
-   marked with __THROW.  */
-extern int fwscanf (__FILE *__restrict __stream,
-		    const wchar_t *__restrict __format, ...)
-     /* __attribute__ ((__format__ (__wscanf__, 2, 3))) */;
-/* Read formatted input from stdin.
-
-   This function is a possible cancellation point and therefore not
-   marked with __THROW.  */
-extern int wscanf (const wchar_t *__restrict __format, ...)
-     /* __attribute__ ((__format__ (__wscanf__, 1, 2))) */;
-/* Read formatted input from S.  */
-extern int swscanf (const wchar_t *__restrict __s,
-		    const wchar_t *__restrict __format, ...)
-     __THROW /* __attribute__ ((__format__ (__wscanf__, 2, 3))) */;
-
-/* For historical reasons, the C99-compliant versions of the scanf
-   functions are at alternative names.  When __LDBL_COMPAT or
-   __LDOUBLE_REDIRECTS_TO_FLOAT128_ABI are in effect, this is handled in
-   bits/wchar-ldbl.h.  */
-#if !__GLIBC_USE (DEPRECATED_SCANF) && !defined __LDBL_COMPAT \
-     && __LDOUBLE_REDIRECTS_TO_FLOAT128_ABI == 0
-#  ifdef __REDIRECT
+extern int __REDIRECT_LDBL128_NTH (vswprintf, (wchar_t *__restrict __s, size_t __n,
+				      const wchar_t *__restrict __format,
+					      __gnuc_va_list __arg))
+     /* __attribute__ ((__format__ (__wprintf__, 3, 0))) */;
+
+# if !__GLIBC_USE (DEPRECATED_SCANF)
+#  if __LDOUBLE_REDIRECTS_TO_FLOAT128_ABI == 1 || defined __LDBL_COMPAT
+extern int __REDIRECT_LDBL (fwscanf, (__FILE *__restrict __stream,
+				      const wchar_t *__restrict __format, ...),
+			    __isoc99_fwscanfieee128, __nldbl___isoc99_fwscanf);
+extern int __REDIRECT_LDBL (wscanf, (const wchar_t *__restrict __format, ...),
+			    __isoc99_wscanfieee128,__nldbl___isoc99_wscanf);
+extern int __REDIRECT_LDBL_NTH (swscanf, (const wchar_t *__restrict __s,
+					  const wchar_t *__restrict __format,
+					  ...),
+				__isoc99_swscanfieee128, __nldbl___isoc99_swscanf);
+#  else
+#   ifdef __REDIRECT
 extern int __REDIRECT (fwscanf, (__FILE *__restrict __stream,
 				 const wchar_t *__restrict __format, ...),
 		       __isoc99_fwscanf)
@@ -665,72 +658,129 @@ extern int __REDIRECT_NTH (swscanf, (const wchar_t *__restrict __s,
 				     const wchar_t *__restrict __format,
 				     ...), __isoc99_swscanf)
      /* __attribute__ ((__format__ (__wscanf__, 2, 3))) */;
-#  else
+#   else
 extern int __isoc99_fwscanf (__FILE *__restrict __stream,
 			     const wchar_t *__restrict __format, ...);
 extern int __isoc99_wscanf (const wchar_t *__restrict __format, ...);
 extern int __isoc99_swscanf (const wchar_t *__restrict __s,
 			     const wchar_t *__restrict __format, ...)
      __THROW;
-#   define fwscanf __isoc99_fwscanf
-#   define wscanf __isoc99_wscanf
-#   define swscanf __isoc99_swscanf
+#    define fwscanf __isoc99_fwscanf
+#    define wscanf __isoc99_wscanf
+#    define swscanf __isoc99_swscanf
+#   endif /* __REDIRECT */
+#  endif
+# else
+#  if __LDOUBLE_REDIRECTS_TO_FLOAT128_ABI == 1 || defined __LDBL_COMPAT
+extern int __REDIRECT_LDBL (fwscanf, (__FILE *__restrict __stream,
+				      const wchar_t *__restrict __format, ...),
+			    __fwscanfieee128, __nldbl_fwscanf);
+extern int __REDIRECT_LDBL (wscanf, (const wchar_t *__restrict __format, ...),
+			    __wscanfieee128,__nldbl_wscanf);
+extern int __REDIRECT_LDBL_NTH (swscanf, (const wchar_t *__restrict __s,
+					  const wchar_t *__restrict __format,
+					  ...),
+				__swscanfieee128, __nldbl_swscanf);
+#  else
+/* Read formatted input from STREAM.
+
+   This function is a possible cancellation point and therefore not
+   marked with __THROW.  */
+extern int fwscanf (__FILE *__restrict __stream,
+                    const wchar_t *__restrict __format, ...)
+     /* __attribute__ ((__format__ (__wscanf__, 2, 3))) */;
+/* Read formatted input from stdin.
+
+   This function is a possible cancellation point and therefore not
+   marked with __THROW.  */
+extern int wscanf (const wchar_t *__restrict __format, ...)
+     /* __attribute__ ((__format__ (__wscanf__, 1, 2))) */;
+/* Read formatted input from S.  */
+extern int swscanf (const wchar_t *__restrict __s,
+                    const wchar_t *__restrict __format, ...)
+     __THROW /* __attribute__ ((__format__ (__wscanf__, 2, 3))) */;
 #  endif
 # endif
 
 #endif /* Use ISO C95, C99 and Unix98. */
 
 #ifdef __USE_ISOC99
+# if !__GLIBC_USE (DEPRECATED_SCANF)
+#  if __LDOUBLE_REDIRECTS_TO_FLOAT128_ABI == 1 || defined __LDBL_COMPAT
+extern int __REDIRECT_LDBL (vfwscanf, (__FILE *__restrict __stream,
+				       const wchar_t *__restrict __format,
+				       __gnuc_va_list __arg),
+			    __isoc99_vfwscanfieee128, __nldbl___isoc99_vfwscanf);
+extern int __REDIRECT_LDBL (vwscanf, (const wchar_t *__restrict __format,
+				      __gnuc_va_list __arg),
+			    __isoc99_vwscanfieee128, __nldbl___isoc99_vwscanf);
+extern int __REDIRECT_LDBL_NTH (vswscanf, (const wchar_t *__restrict __s,
+					   const wchar_t *__restrict __format,
+					   __gnuc_va_list __arg),
+				__isoc99_vswscanfieee128,
+				__nldbl___isoc99_vswscanf);
+#  else
+#   ifdef __REDIRECT
+extern int __REDIRECT (vfwscanf, (__FILE *__restrict __s,
+                                  const wchar_t *__restrict __format,
+                                  __gnuc_va_list __arg), __isoc99_vfwscanf)
+     /* __attribute__ ((__format__ (__wscanf__, 2, 0))) */;
+extern int __REDIRECT (vwscanf, (const wchar_t *__restrict __format,
+                                 __gnuc_va_list __arg), __isoc99_vwscanf)
+     /* __attribute__ ((__format__ (__wscanf__, 1, 0))) */;
+extern int __REDIRECT_NTH (vswscanf, (const wchar_t *__restrict __s,
+                                      const wchar_t *__restrict __format,
+                                      __gnuc_va_list __arg), __isoc99_vswscanf)
+     /* __attribute__ ((__format__ (__wscanf__, 2, 0))) */;
+#   else
+extern int __isoc99_vfwscanf (__FILE *__restrict __s,
+                              const wchar_t *__restrict __format,
+                              __gnuc_va_list __arg);
+extern int __isoc99_vwscanf (const wchar_t *__restrict __format,
+                             __gnuc_va_list __arg);
+extern int __isoc99_vswscanf (const wchar_t *__restrict __s,
+                              const wchar_t *__restrict __format,
+                              __gnuc_va_list __arg) __THROW;
+#    define vfwscanf __isoc99_vfwscanf
+#    define vwscanf __isoc99_vwscanf
+#    define vswscanf __isoc99_vswscanf
+#   endif /* __REDIRECT */
+#  endif
+# else
+#  if __LDOUBLE_REDIRECTS_TO_FLOAT128_ABI == 1 || defined __LDBL_COMPAT
+extern int __REDIRECT_LDBL (vfwscanf, (__FILE *__restrict __stream,
+				       const wchar_t *__restrict __format,
+				       __gnuc_va_list __arg),
+			    __vfwscanfieee128, __nldbl_vfwscanf);
+extern int __REDIRECT_LDBL (vwscanf, (const wchar_t *__restrict __format,
+				      __gnuc_va_list __arg),
+			    __vwscanfieee128, __nldbl_vwscanf);
+extern int __REDIRECT_LDBL_NTH (vswscanf, (const wchar_t *__restrict __s,
+					   const wchar_t *__restrict __format,
+					   __gnuc_va_list __arg),
+				__vswscanfieee128,
+				__nldbl_vswscanf);
+#  else
 /* Read formatted input from S into argument list ARG.
 
    This function is a possible cancellation point and therefore not
    marked with __THROW.  */
 extern int vfwscanf (__FILE *__restrict __s,
-		     const wchar_t *__restrict __format,
-		     __gnuc_va_list __arg)
+                     const wchar_t *__restrict __format,
+                     __gnuc_va_list __arg)
      /* __attribute__ ((__format__ (__wscanf__, 2, 0))) */;
 /* Read formatted input from stdin into argument list ARG.
 
    This function is a possible cancellation point and therefore not
    marked with __THROW.  */
 extern int vwscanf (const wchar_t *__restrict __format,
-		    __gnuc_va_list __arg)
+                    __gnuc_va_list __arg)
      /* __attribute__ ((__format__ (__wscanf__, 1, 0))) */;
 /* Read formatted input from S into argument list ARG.  */
 extern int vswscanf (const wchar_t *__restrict __s,
-		     const wchar_t *__restrict __format,
-		     __gnuc_va_list __arg)
+                     const wchar_t *__restrict __format,
+                     __gnuc_va_list __arg)
      __THROW /* __attribute__ ((__format__ (__wscanf__, 2, 0))) */;
-
-/* Same redirection as above for the v*wscanf family.  */
-# if !__GLIBC_USE (DEPRECATED_SCANF) \
-     && (!defined __LDBL_COMPAT || !defined __REDIRECT) \
-     && (defined __STRICT_ANSI__ || defined __USE_XOPEN2K) \
-     && __LDOUBLE_REDIRECTS_TO_FLOAT128_ABI == 0
-#  ifdef __REDIRECT
-extern int __REDIRECT (vfwscanf, (__FILE *__restrict __s,
-				  const wchar_t *__restrict __format,
-				  __gnuc_va_list __arg), __isoc99_vfwscanf)
-     /* __attribute__ ((__format__ (__wscanf__, 2, 0))) */;
-extern int __REDIRECT (vwscanf, (const wchar_t *__restrict __format,
-				 __gnuc_va_list __arg), __isoc99_vwscanf)
-     /* __attribute__ ((__format__ (__wscanf__, 1, 0))) */;
-extern int __REDIRECT_NTH (vswscanf, (const wchar_t *__restrict __s,
-				      const wchar_t *__restrict __format,
-				      __gnuc_va_list __arg), __isoc99_vswscanf)
-     /* __attribute__ ((__format__ (__wscanf__, 2, 0))) */;
-#  else
-extern int __isoc99_vfwscanf (__FILE *__restrict __s,
-			      const wchar_t *__restrict __format,
-			      __gnuc_va_list __arg);
-extern int __isoc99_vwscanf (const wchar_t *__restrict __format,
-			     __gnuc_va_list __arg);
-extern int __isoc99_vswscanf (const wchar_t *__restrict __s,
-			      const wchar_t *__restrict __format,
-			      __gnuc_va_list __arg) __THROW;
-#   define vfwscanf __isoc99_vfwscanf
-#   define vwscanf __isoc99_vwscanf
-#   define vswscanf __isoc99_vswscanf
 #  endif
 # endif
 
@@ -867,11 +917,6 @@ extern size_t wcsftime_l (wchar_t *__restrict __s, size_t __maxsize,
 # include <bits/wchar2.h>
 #endif
 
-#include <bits/floatn.h>
-#if defined __LDBL_COMPAT || __LDOUBLE_REDIRECTS_TO_FLOAT128_ABI == 1
-# include <bits/wchar-ldbl.h>
-#endif
-
 __END_DECLS
 
 #endif /* wchar.h  */
diff --git a/wcsmbs/wcsmbs-tst1.c b/wcsmbs/wcsmbs-tst1.c
index 0d0e18f6..75b745af 100644
--- a/wcsmbs/wcsmbs-tst1.c
+++ b/wcsmbs/wcsmbs-tst1.c
@@ -20,7 +20,7 @@ main (void)
 
   pchar = setlocale (LC_ALL, "de_DE.UTF-8");
   printf ("locale : %s\n",pchar);
-  printf ("MB_CUR_MAX %Zd\n", MB_CUR_MAX);
+  printf ("MB_CUR_MAX %zd\n", MB_CUR_MAX);
 
   puts ("---- test 1 ------");
   test = mbstowcs (tmp, str, (strlen (str) + 1) * sizeof (char));
diff --git a/wctype/Makefile b/wctype/Makefile
index a3540203..79d9608c 100644
--- a/wctype/Makefile
+++ b/wctype/Makefile
@@ -29,3 +29,5 @@ routines	:= wcfuncs wctype iswctype wctrans towctrans \
 tests	:= test_wctype test_wcfuncs bug-wctypeh
 
 include ../Rules
+
+CFLAGS-wcfuncs.c += $(config-cflags-wno-ignored-attributes)
-- 
2.34.1

